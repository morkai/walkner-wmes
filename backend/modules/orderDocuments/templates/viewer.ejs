<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title><%- meta.title || nc15 %></title>
  <link rel="stylesheet" href="/assets/wmes-docs-viewer.css">
  <style>
    * {
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    body {
      margin: 0;
      padding-top: 33px;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1;
      color: #fff;
      background: #525659;
      cursor: default;
    }
    #images {
      opacity: 0;
    }
    #images li {
      flex: 0 0 auto;
      width: 75px;
      height: 75px;
    }
    #images img {
      width: 100%;
      height: 100%;
    }
    .viewer-footer {
      left: auto;
      right: 15px;
      bottom: 15px;
      overflow: visible;
    }
    .viewer-toolbar {
      width: auto;
      margin: 0;
      padding: 0;
      overflow: visible;
    }
    .viewer-play {
      display: none;
    }
    .viewer-toolbar > li {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #FFF;
      color: #333;
      font-size: 24px;
      line-height: 48px;
      box-shadow: 0 4px 12px #666;
      text-align: center;
    }
    .viewer-toolbar > li + li {
      margin-left: 10px;
    }
    .viewer-toolbar > li:hover {
      background: #ffffd6;
    }
    .viewer-toolbar > li:before {
      display: none;
    }
    .fa-chevron-left {
      margin-left: -4px;
    }
    .fa-chevron-right {
      margin-left: 4px;
    }
    #pages {
      position: absolute;
      bottom: 63px;
      right: 15px;
      z-index: 2015;
    }
    #pages li {
      margin: 0 0 10px 0;
      float: none;
    }
    #pages .is-active {
      background-color: #ec971f;
      color: #fff;
      text-shadow: 1px 1px 1px #333;
      box-shadow: 0 4px 12px #666, inset 0 3px 9px rgba(0, 0, 0, 0.25);
    }
    #jumpForm {
      position: absolute;
      bottom: 78px;
      right: 78px;
      z-index: 3000;
      width: 210px;
      box-shadow: 0 4px 12px #666;
    }
    #pageNo {
      font-size: 48px;
      height: auto;
      line-height: 1;
      text-align: center;
    }
    #numpad {
      display: flex;
      flex-wrap: wrap;
    }
    #numpad > .btn {
      font-size: 24px;
      flex: 1 1 auto;
      width: 70px;
      height: 60px;
    }
    #numpad > .btn[data-key="0"] {
      flex: 0 1 auto;
    }
    #jumpForm .btn-primary {
      width: 100%;
      height: 60px;
    }
  </style>
</head>
<body>
<div>
  <ul id="images">
    <% for (var p = 1; p <= meta.pageCount; ++p) { %>
    <li><img id="image" src="/orderDocuments/<%- nc15 %>/<%- p %>" alt="<%- meta.title %>"></li>
    <% } %>
  </ul>
</div>
<ol id="pages" class="viewer-toolbar"></ol>
<form id="jumpForm" autocomplete="off" class="hidden">
  <input id="pageNo" class="form-control" type="text" readonly>
  <div id="numpad">
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="1">1</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="2">2</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="3">3</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="4">4</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="5">5</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="6">6</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="7">7</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="8">8</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="9">9</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="0">0</button>
    <button type="button" class="btn btn-default btn-lg" tabindex="-1" data-key="BACKSPACE">x</button>
  </div>
  <div class="form-actions">
    <button class="btn btn-primary btn-lg" type="submit">Skocz do strony</button>
  </div>
</form>
<script src="/vendor/viewerjs/viewer.js"></script>
<script>

var PAGE_COUNT = +'<%- meta.pageCount %>';
var PAGE_NUMBERS = 4;
var PAGE_DOTS_VISIBLE = false;
var PAGE_FIRST_LAST_VISIBLE = false;
var PAGE_NEXT_PREV_VISIBLE = false;

Viewer.TEMPLATE =
  '<div class="viewer-container">' +
  '<div class="viewer-canvas"></div>' +
  '<div class="viewer-footer">' +
  '<div class="viewer-title"></div>' +
  '<ul class="viewer-toolbar">' +
  '<li id="pdf" title="Pokaż oryginalny plik PDF"><span class="fa fa-file-pdf-o"></span></li>' +
  '<li class="viewer-zoom-in" data-action="zoom-in" title="Powiększ"><span class="fa fa-plus" data-action="zoom-in"></span></li>' +
  '<li class="viewer-zoom-out" data-action="zoom-out" title="Pomniejsz"><span class="fa fa-minus" data-action="zoom-out"></span></li>' +
  '<li class="viewer-one-to-one" data-action="one-to-one" title="Dopasuj do strony">1:1</li>' +
  '<li class="viewer-reset" data-action="reset" title="Resetuj widok">0</li>' +
  '<li class="viewer-rotate-right" data-action="rotate-right" title="Obróć w prawo"><span class="fa fa-rotate-right" data-action="rotate-right"></span></li>' +
  '<li class="viewer-flip-horizontal" data-action="flip-horizontal" title="Odwróć poziomo"><span class="fa fa-arrows-h" data-action="flip-horizontal"></span></li>' +
  '<li class="viewer-flip-vertical" data-action="flip-vertical" title="Odwróć pionowo"><span class="fa fa-arrows-v" data-action="flip-vertical"></span></li>' +
  <% if (meta.pageCount > 1) { %>
  <% if (meta.pageCount > 9) { %>
  '<li id="first" title="Pierwsza strona">1</li>' +
  <% } %>
  '<li class="viewer-prev" data-action="prev" title="Poprzednia strona"><span class="fa fa-chevron-left" data-action="prev"></span></li>' +
  '<li class="viewer-next" data-action="next" title="Następna strona"><span class="fa fa-chevron-right" data-action="next"></span></li>' +
  <% if (meta.pageCount > 9) { %>
  '<li id="jump" title="Skocz do strony">...</li>' +
  <% } %>
  <% } %>
  '</ul>' +
  '<div class="viewer-navbar">' +
  '<ul class="viewer-list"></ul>' +
  '</div>' +
  '</div>' +
  '<div class="viewer-tooltip"></div>' +
  '<div class="viewer-button" data-action="mix"></div>' +
  '<div class="viewer-player"></div>' +
  '</div>';

var viewer = new Viewer(document.getElementById('images'), {
  button: false,
  keyboard: false,
  navbar: false,
  title: false,
  tooltip: false,
  view: function(e)
  {
    document.getElementById('jumpForm').classList.add('hidden');

    renderPages(e.detail.index);
  }
});

window.onload = function()
{
  viewer.show();

  document.getElementById('pdf').addEventListener('click', function()
  {
    window.location.href = window.location.href + '&pdf=1';
  });

  document.getElementById('first').addEventListener('click', function()
  {
    viewer.view(0);
  });

  document.getElementById('jump').addEventListener('click', function()
  {
    document.getElementById('pageNo').value = (viewer.index + 1) + ' / ' + PAGE_COUNT;
    document.getElementById('pageNo').dataset.value = '';
    document.getElementById('jumpForm').classList.toggle('hidden');
  });

  document.getElementById('pages').addEventListener('click', function(e)
  {
    if (e.target.dataset.page)
    {
      viewer.view(+e.target.dataset.page - 1);
    }
  });

  document.getElementById('jumpForm').addEventListener('click', function(e)
  {
    var key = e.target.dataset.key;

    if (!key)
    {
      return;
    }

    var pageNoEl = document.getElementById('pageNo');

    if (key === 'BACKSPACE')
    {
      pageNoEl.value = '? / ' + PAGE_COUNT;
      pageNoEl.dataset.value = '';
    }
    else
    {
      pageNoEl.dataset.value += key;
      pageNoEl.value = pageNoEl.dataset.value + ' / ' + PAGE_COUNT;
    }
  });

  document.getElementById('jumpForm').addEventListener('submit', function(e)
  {
    e.preventDefault();

    e.target.classList.add('hidden');

    var pageNoEl = document.getElementById('pageNo');
    var pageNo = parseInt(pageNoEl.value, 10);

    if (isNaN(pageNo))
    {
      return;
    }

    if (pageNo < 1)
    {
      pageNo = 1;
    }
    else if (pageNo > PAGE_COUNT)
    {
      pageNo = PAGE_COUNT;
    }

    viewer.view(pageNo - 1);
  });
};

function renderPages(currentPage)
{
  if (PAGE_COUNT === 1)
  {
    return;
  }

  var pageData = serializePages(currentPage + 1);
  var pagesEl = document.getElementById('pages');
  var html = '';

  pageData.pages.forEach(function(page)
  {
    html += '<li data-page="' + page.no + '" class="' + (page.active ? 'is-active' : '') + '">' + page.no + '</li>';
  });

  pagesEl.innerHTML = html;
}

function serializePages(currentPage)
{
  var pageCount = PAGE_COUNT;
  var pageNrs = PAGE_NUMBERS;

  if (PAGE_DOTS_VISIBLE)
  {
    pageNrs += 1;
  }

  var firstPageNr = currentPage;
  var lastPageNr = firstPageNr + pageNrs;
  var cut = true;
  var leftDotsVisible = false;

  if ((firstPageNr - pageNrs) < 1)
  {
    firstPageNr = 1;
  }
  else
  {
    firstPageNr -= pageNrs;
    leftDotsVisible = PAGE_DOTS_VISIBLE && firstPageNr !== 1;
  }

  if (leftDotsVisible)
  {
    firstPageNr += 1;
  }

  if (lastPageNr > pageCount)
  {
    lastPageNr = pageCount;
    cut = false;
  }

  if (currentPage < (pageNrs + 1))
  {
    lastPageNr += (pageNrs + 1) - currentPage;

    if (lastPageNr > pageCount)
    {
      lastPageNr = pageCount;
    }
  }
  else if (currentPage > (pageCount - pageNrs))
  {
    firstPageNr -= pageNrs - (pageCount - currentPage);

    if (firstPageNr < 1)
    {
      firstPageNr = 1;
    }
  }

  var rightDotsVisible = PAGE_DOTS_VISIBLE
    && cut
    && lastPageNr !== pageCount;

  if (rightDotsVisible)
  {
    lastPageNr -= 1;
  }

  if (firstPageNr === 1)
  {
    leftDotsVisible = false;
  }

  return {
    pageCount: pageCount,
    page: currentPage,
    visible: pageCount > 1,
    firstLastLinksVisible: PAGE_FIRST_LAST_VISIBLE,
    prevNextLinksVisible: PAGE_NEXT_PREV_VISIBLE,
    leftDotsVisible: leftDotsVisible,
    rightDotsVisible: rightDotsVisible,
    firstPageLinkAvailable: currentPage > 1,
    lastPageLinkAvailable: currentPage < pageCount,
    prevPageLinkAvailable: currentPage > 1,
    nextPageLinkAvailable: currentPage < pageCount,
    pages: generatePages(firstPageNr, lastPageNr, currentPage)
  };
}

function generatePages(firstPageNr, lastPageNr, currentPage)
{
  var pages = [];

  for (var page = firstPageNr; page <= lastPageNr; ++page)
  {
    pages.push({
      no: page,
      active: page === currentPage
    });
  }

  return pages;
}


</script>
</body>
</html>
