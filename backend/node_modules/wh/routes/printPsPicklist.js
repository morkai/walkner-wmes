// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');

module.exports = async (app, module, req, res, next) =>
{
  const {
    OldWhOrder: WhOrder
  } = module;

  try
  {
    const whOrders = await WhOrder
      .find({
        set: +req.query.set,
        date: moment.utc(req.query.date, 'YYYY-MM-DD').toDate()
      })
      .lean()
      .exec();

    if (!whOrders.length)
    {
      return next(app.createError('Set not found.', 'INPUT', 400));
    }

    const pdfFile = await module.state.printPsPicklist(whOrders, {print: false});

    res.sendFile(req.query.html === '1' ? pdfFile.replace('.pdf', '.html') : pdfFile);
  }
  catch (err)
  {
    return next(err);
  }
};
