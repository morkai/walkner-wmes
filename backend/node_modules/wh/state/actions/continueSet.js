// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = async (app, module, {data, user, session}) =>
{
  const {
    OldWhEvent: WhEvent,
    OldWhOrder: WhOrder
  } = module;

  const {
    whUser,
    assignedOrder
  } = data;

  const whOrders = await WhOrder
    .find({
      date: assignedOrder.date,
      set: assignedOrder.set
    })
    .select({_id: 1})
    .lean()
    .session(session)
    .exec();

  const event = {
    type: 'setContinued',
    user,
    time: new Date(),
    data: {
      whUser: WhEvent.whUser(whUser),
      orders: WhEvent.orders(whOrders),
      lines: WhEvent.lines(whOrders[0])
    }
  };

  const eventsResult = await WhEvent.record(event, session);

  await session.commitTransaction();

  return {
    response: {
      result: 'continueSet',
      date: assignedOrder.date,
      set: assignedOrder.set,
      user: whUser
    },
    results: [eventsResult]
  };
};
