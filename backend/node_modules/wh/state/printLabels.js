// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

exports.detached = true;

exports.session = false;

exports.execute = async (app, module, {data, user}) =>
{
  const {
    OldWhEvent: WhEvent,
    OldWhOrder: WhOrder
  } = module;

  if (typeof data.qty !== 'number' || data.qty < 1 || data.qty > 10)
  {
    throw app.createError(`Invalid label quantity.`, 'INPUT', 400);
  }

  const whOrder = await WhOrder.findById(data.order).lean().exec();

  if (!whOrder)
  {
    throw app.createError(`Order not found.`, 'PRINT_ORDER_NOT_FOUND', 400);
  }

  await module.state.printLabels([whOrder], data.qty, data.funcId);

  const {messages} = await WhEvent.record([{
    type: 'labelsPrinted',
    user,
    time: new Date(),
    order: data.order,
    data: {
      qty: data.qty,
      func: data.funcId
    }
  }]);

  return {messages};
};
