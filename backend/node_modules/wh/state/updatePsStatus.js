// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

exports.detached = true;

exports.session = true;

exports.execute = async (app, module, {data, session}) =>
{
  const {
    OldWhOrder: WhOrder
  } = module;

  const whOrders = await WhOrder
    .find({
      order: data.orderNo,
      psStatus: {$ne: data.psStatus}
    })
    .select({_id: 1})
    .session(session)
    .exec();

  if (!whOrders.length)
  {
    return;
  }

  const ids = [];

  whOrders.forEach(whOrder =>
  {
    ids.push(whOrder._id);

    whOrder.psStatus = data.psStatus;
  });

  await WhOrder.collection.updateMany({_id: {$in: ids}}, {$set: {psStatus: data.psStatus}}, {session});

  await session.commitTransaction();

  return {
    messages: [{
      topic: `${WhOrder.TOPIC_PREFIX}.updated`,
      message: {updated: whOrders}
    }]
  };
};
