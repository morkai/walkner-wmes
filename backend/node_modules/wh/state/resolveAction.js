// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const resolvePickupAction = require('./resolvePickupAction');
const resolveDeliveryAction = require('./resolveDeliveryAction');

exports.session = true;

exports.execute = async (app, module, {data, user, session}) =>
{
  const {
    User,
    OldWhUser: WhUser
  } = module;

  let whUserId = data.whUserId;

  if (!whUserId)
  {
    const personnelUser = await User
      .findOne({
        $or: [
          {personellId: data.personnelId},
          {card: data.personnelId},
          {cardUid: data.personnelId}
        ]
      })
      .select({_id: 1})
      .lean()
      .session(session)
      .exec();

    if (!personnelUser)
    {
      throw app.createError('User not found.', 'USER_NOT_FOUND', 400);
    }

    whUserId = personnelUser._id.toString();
  }

  const whUser = await WhUser
    .findById(whUserId)
    .lean()
    .session(session)
    .exec();

  if (!whUser)
  {
    throw app.createError('WH user not found.', 'USER_NOT_FOUND', 400);
  }

  switch (data.source)
  {
    case 'pickup':
      return await resolvePickupAction(app, module, {
        data,
        user,
        session,
        whUser
      });

    case 'delivery':
      return await resolveDeliveryAction(app, module, {
        data,
        user,
        session,
        whUser
      });

    default:
      throw app.createError('Invalid type.', 'INVALID_TYPE', 400);
  }
};
