// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const {join} = require('path');

module.exports = (app, module) =>
{
  const {express} = module;

  express.get('/html2pdf/:id.(:format)', readFileRoute);

  express.post('/html2pdf', generatePdfRoute);

  express.post('/html2pdf;print', printPdfRoute);

  function readFileRoute(req, res, next)
  {
    if (!/^[a-z0-9]{32}$/.test(req.params.id) || (req.params.format !== 'pdf' && req.params.format !== 'html'))
    {
      return next(app.createError('INPUT', 400));
    }

    res.sendFile(join(module.config.storagePath, `${req.params.id}.${req.params.format}`));
  }

  function generatePdfRoute(req, res, next)
  {
    let html = req.body;
    let options = req.query;

    if (typeof html === 'object' && html.html)
    {
      options = html;
      html = html.html;
    }

    module.generatePdf(html, options, (err, result) =>
    {
      if (err)
      {
        return next(err);
      }

      if (options.sendFile)
      {
        res.sendFile(join(module.config.storagePath, `${result.hash}.pdf`));
      }
      else
      {
        res.json(result);
      }
    });
  }

  function printPdfRoute(req, res, next)
  {
    const {hash, printer, settings} = req.body;

    module.printPdf(hash, printer, settings, (err) =>
    {
      if (err)
      {
        return next(err);
      }

      res.sendStatus(204);
    });
  }
};
