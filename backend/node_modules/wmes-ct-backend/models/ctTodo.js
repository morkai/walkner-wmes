// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

exports.name = 'CtTodo';

exports.setUp = (app, mongoose) =>
{
  const todoSchema = new mongoose.Schema({
    time: {
      type: Date,
      default: () => new Date()
    },
    line: String,
    station: {
      type: Number,
      default: 0
    },
    action: String,
    data: {
      type: mongoose.Schema.Types.Mixed,
      default: () => ({})
    }
  }, {
    id: false,
    minimize: false,
    versionKey: false
  });

  todoSchema.statics.TOPIC_PREFIX = 'ct.todos';
  todoSchema.statics.BROWSE_LIMIT = 100;

  todoSchema.index({line: 1, time: 1});

  todoSchema.post('save', function()
  {
    app.broker.publish(`${todoSchema.statics.TOPIC_PREFIX}.saved`, this.toJSON());
  });

  mongoose.model(exports.name, todoSchema);
};
