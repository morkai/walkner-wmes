// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const path = require('path');
const contentDisposition = require('content-disposition');

module.exports = (app, module, req, res, next) =>
{
  const {modelId, attachmentProp} = req.params;
  const Model = module.ToolCalTool;

  const fileProp = `${attachmentProp}File`;
  const fields = {};

  if (req.query.change >= 0)
  {
    fields.changes = 1;
  }
  else
  {
    fields[fileProp] = 1;
  }

  Model.findById(modelId).select(fields).lean().exec((err, doc) =>
  {
    if (err)
    {
      return next(err);
    }

    let attachment = doc[fileProp];

    if (doc.changes)
    {
      const change = doc.changes[req.query.change];

      if (change && change.data[fileProp])
      {
        attachment = change.data[fileProp][req.query.old === '1' ? 0 : 1];
      }
    }

    if (!attachment)
    {
      return next(app.createError(`Attachment not found.`, 'NOT_FOUND', 404));
    }

    res.type(attachment.type);
    res.append('Content-Disposition', contentDisposition(attachment.name, {
      type: req.query.download === '1' ? 'attachment' : 'inline'
    }));
    res.sendFile(path.join(module.config.uploadsDest, attachment.hash));
  });
};
