// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, {ToolCalTool}, req, res, next) =>
{
  if (/^[0-9]+$/.test(req.params.filter))
  {
    req.params.rid = req.params.filter;

    redirectToDetailsRoute(req, res, next);
  }
  else
  {
    redirectToListRoute(req, res, next);
  }

  function redirectToListRoute(req, res)
  {
    let url = '/#toolcal/tools';

    if (req.params.filter === 'mine')
    {
      url += '?users.id=mine&sort(nextDate)&limit(20)';
    }

    res.redirect(url);
  }

  function redirectToDetailsRoute(req, res, next)
  {
    ToolCalTool.findOne({rid: parseInt(req.params.rid, 10)}, {_id: 1}).lean().exec((err, tool) =>
    {
      if (err)
      {
        return next(err);
      }

      if (tool)
      {
        return res.redirect(`/#toolcal/tools/${tool._id}`);
      }

      res.sendStatus(404);
    });
  }
};
