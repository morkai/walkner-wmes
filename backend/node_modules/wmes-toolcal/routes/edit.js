// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, {user, ToolCalTool}, req, res, next) =>
{
  const userData = req.session.user;
  const userInfo = user.createUserInfo(userData, req);

  userInfo.id = userInfo.id.toString();

  step(
    function()
    {
      ToolCalTool.findById(req.params.id).exec(this.next());
    },
    function(err, tool)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!tool)
      {
        return this.skip(app.createError('NOT_FOUND', 404));
      }

      const manager = user.isAllowedTo(userData, 'TOOLCAL:MANAGE');
      const owner = tool.users.some(u => u.id === userInfo.id);

      let body = {
        comment: req.body.comment
      };

      if (manager || owner)
      {
        body = req.body;
      }

      if (!manager)
      {
        delete body.users;
      }

      if (tool.applyChanges(body, userInfo))
      {
        tool.save(this.next());
      }
    },
    function(err, tool)
    {
      if (err)
      {
        return next(err);
      }

      if (tool)
      {
        res.json(tool);

        app.broker.publish('toolcal.tools.edited', {
          model: tool,
          user: userInfo
        });
      }
      else
      {
        res.json({_id: req.params.id});
      }
    }
  );
};
