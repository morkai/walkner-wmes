// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const path = require('path');
const contentDisposition = require('content-disposition');

module.exports = async (app, module, req, res) =>
{
  const {
    Suggestion
  } = module;

  const suggestion = await Suggestion
    .findById(req.params.order)
    .select({attachments: 1, changes: 1})
    .lean()
    .exec();

  if (!suggestion)
  {
    return res.sendStatus(404);
  }

  const changeIndex = parseInt(req.query.change, 10);
  let attachment;

  if (!isNaN(changeIndex))
  {
    const change = suggestion.changes[Math.abs(changeIndex)];

    if (change && change.data.attachments)
    {
      attachment = change.data.attachments[changeIndex < 0 ? 0 : 1].find(a => a._id === req.params.attachment);
    }
  }
  else
  {
    attachment = suggestion.attachments.find(a => attachment._id === req.params.attachment);
  }

  if (!attachment)
  {
    return res.sendStatus(404);
  }

  const disposition = req.query.download ? 'attachment' : 'inline';

  res.type(attachment.type);
  res.append('Content-Disposition', contentDisposition(attachment.name, {type: disposition}));
  res.sendFile(path.join(module.config.attachmentsDest, attachment.path));
};
