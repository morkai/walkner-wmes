// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const parseSapTextTable = require('sap/util/parseSapTextTable');
const parseSapString = require('sap/util/parseSapString');

module.exports = function parseStatuses(input, orders, importTs)
{
  if (!input.trim().endsWith('----------'))
  {
    return;
  }

  return parseSapTextTable(input, {
    columnMatchers: {
      no: /^Order$/,
      statuses: /^System Status/,
      changedBy: /^Cha.*?by/i
    },
    valueParsers: {
      statuses: input => input
        .replace(/\s+/g, ' ')
        .split(' ')
        .map(status => status.replace(/\*/g, ''))
        .filter(status => status.length > 0),
      changedBy: parseSapString
    },
    itemDecorator: obj =>
    {
      orders[obj.no] = {
        _id: obj.no,
        statuses: obj.statuses,
        changedBy: obj.changedBy.includes('SYSBTC') ? 'System' : obj.changedBy,
        importTs
      };

      return null;
    }
  });
};
