// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const path = require('path');
const Layer = require('express/lib/router/layer');

module.exports = (app, module, options) =>
{
  if (options.View)
  {
    const originalLookup = options.View.prototype.lookup;

    options.View.prototype.lookup = function(name)
    {
      const colonIndex = name.indexOf(':');

      if (colonIndex === -1)
      {
        return originalLookup.call(this, name);
      }

      const moduleName = name.substring(0, colonIndex);
      const file = name.substring(colonIndex + 1);
      const loc = app.pathTo('node_modules', moduleName, 'templates', file);

      return this.resolve(path.dirname(loc), path.basename(loc));
    };
  }

  Layer.prototype.handle_request = function(req, res, next) // eslint-disable-line camelcase
  {
    const fn = this.handle;

    if (fn.length > 3)
    {
      return next();
    }

    try
    {
      const promise = fn(req, res, next);

      if (promise && promise.catch)
      {
        promise.catch(next);
      }
    }
    catch (err)
    {
      next(err);
    }
  };
};
