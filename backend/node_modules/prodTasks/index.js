// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');
const setUpModel = require('./models/prodTask');
const setUpRoutes = require('./routes');

module.exports = require('util/createDictionaryModule')(setUpModel, setUpRoutes, (app, module) =>
{
  app.broker.subscribe('prodTasks.edited', onEdited);

  function onEdited(message)
  {
    const prodTask = message.model;
    const prodTaskId = prodTask._id.toString();

    _.forEach(module.models, (childProdTask) =>
    {
      if (childProdTask.parent === null || childProdTask.parent.toString() !== prodTaskId)
      {
        return;
      }

      childProdTask.tags = prodTask.tags;

      childProdTask.save((err) =>
      {
        if (err)
        {
          return module.error(
            'Failed to update child task [%s] of [%s]: %s',
            childProdTask._id,
            prodTaskId,
            err.message
          );
        }

        app.broker.publish('prodTasks.edited', {
          model: childProdTask,
          user: message.user
        });
      });
    });
  }
});
