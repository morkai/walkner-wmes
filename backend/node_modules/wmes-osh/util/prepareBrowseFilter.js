// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module) => // eslint-disable-line no-unused-vars
{
  return (req, res, next) =>
  {
    const currentUser = req.session.user;
    const filterUser = req.query['users.user.id'];

    if (filterUser !== 'mine' && filterUser !== 'unseen')
    {
      return next();
    }

    req.rql.selector.args = req.rql.selector.args.filter(function(term)
    {
      return term.args[0] !== 'users.user.id';
    });

    if (filterUser === 'mine')
    {
      req.rql.selector.args.push({
        name: 'eq',
        args: ['users.user.id', currentUser._id]
      });
    }
    else
    {
      req.rql.selector.args.push({
        name: 'elemMatch',
        args: [
          'users',
          {name: 'eq', args: ['user.id', currentUser._id]},
          {name: 'eq', args: ['notify', true]}
        ]
      });
    }

    next();
  };
};
