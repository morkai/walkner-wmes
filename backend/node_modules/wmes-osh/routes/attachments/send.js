// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const path = require('path');
const contentDisposition = require('content-disposition');
const {transliterate} = require('transliteration');

module.exports = async (app, module, req, res, next) =>
{
  const {
    OshNearMiss
  } = module;

  const typeToModel = {
    nearMisses: OshNearMiss
  };

  const Model = typeToModel[req.params.modelType];

  if (!Model)
  {
    return next(app.createError('Unknown model type.', 'INPUT', 400));
  }

  try
  {
    const model = await Model
      .findById(req.params.modelId)
      .select({attachments: 1})
      .exec();

    if (!model)
    {
      return next(app.createError('Model not found.', 'NOT_FOUND', 404));
    }

    const attachment = model.attachments.find(a => a._id === req.params.attachmentId);

    if (!attachment)
    {
      return next(app.createError('Attachment not found.', 'NOT_FOUND', 404));
    }

    if (attachment.type.startsWith('image/')
      && !attachment.meta.width
      && !attachment.meta.height)
    {
      await module.attachments.optimizeImage(attachment, model);
    }

    const filePath = path.join(module.config.uploadsPath, attachment._id)
      + (req.query.min === '1' ? '_min' : '');
    const disposition = req.query.download === '1' ? 'attachment' : 'inline';
    const name = transliterate(attachment.name, {unknown: ''}).replace(/\s+/g, '_');

    if (attachment.type.includes('image/'))
    {
      res.set('Cache-Control', 'max-age=604800, public');
    }

    res.type(attachment.type);
    res.append('Content-Disposition', contentDisposition(name, {type: disposition}));
    res.sendFile(filePath);
  }
  catch (err)
  {
    next(err);
  }
};
