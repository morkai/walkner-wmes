// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const exportRoute = require('./export');
const addRoute = require('./add');

module.exports = (app, module) =>
{
  const {
    user,
    express,
    OshPayout
  } = module;

  const canView = user.auth('OSH:REWARDS:MANAGE');

  express.get(`/osh/payouts`, canView, express.crud.browseRoute.bind(null, app, OshPayout));
  express.get(
    '/osh/payouts;export.:format?',
    canView,
    exportRoute.bind(null, app, module)
  );
  express.post(`/osh/payouts`, canView, addRoute.bind(null, app, module));
  express.get(`/osh/payouts/:id`, canView, express.crud.readRoute.bind(null, app, OshPayout));

  express.get(`/osh/payouts;companies`, canView, readPayoutCompaniesRoute);

  async function readPayoutCompaniesRoute(req, res, next)
  {
    try
    {
      const companies = await OshPayout.aggregate([
        {$sort: {createdAt: -1}},
        {$unwind: '$companies'},
        {$group: {
          _id: '$companies.id',
          label: {$first: '$companies.label'}
        }}
      ]).exec();

      res.json({
        totalCount: companies.length,
        collection: companies
      });
    }
    catch (err)
    {
      next(err);
    }
  }
};
