// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');

module.exports = async (app, module, req, res, next) =>
{
  const {
    user,
    OshObservation
  } = module;

  const input = _.pick(req.body, [
    'observationKind',
    'subject',
    'userWorkplace',
    'userDivision',
    'company',
    'companyName',
    'workplace',
    'division',
    'building',
    'location',
    'station',
    'date',
    'behaviors',
    'workConditions',
    'attachments'
  ]);

  if (input.attachments && Array.isArray(input.attachments.added))
  {
    input.attachments = module.attachments.claimPendingUploads(input.attachments.added);
  }
  else
  {
    input.attachments = [];
  }

  try
  {
    const observation = new OshObservation({
      ...input,
      status: 'open',
      createdAt: new Date(),
      creator: user.createUserInfo(req.session.user, req)
    });

    const [coordinators] = await Promise.all([
      OshObservation.resolveCoordinators(observation),
      OshObservation.assignNextRid(observation)
    ]);

    observation.coordinators = coordinators;

    observation.updateUsers([], observation.creator);

    await observation.save();

    app.broker.publish(`${OshObservation.TOPIC_PREFIX}.added`, {
      user: observation.creator,
      model: observation
    });

    res.json(observation);
  }
  catch (err)
  {
    next(err);
  }
};
