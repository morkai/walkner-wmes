// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');
const report = require('wmes-osh/reports/metrics');

module.exports = (app, {reports}, req, res, next) =>
{
  const options = {
    interval: 'month',
    fromTime: 0,
    toTime: 0,
    orgUnitType: null,
    orgUnitId: null
  };

  let month = req.query.month ? moment(req.query.month, 'YYYY-MM') : null;

  if (!month || !month.isValid())
  {
    month = moment().startOf('month');
  }

  options.toTime = month.add(1, 'months').valueOf();
  options.fromTime = month.subtract(1 + 12 * 2, 'months').valueOf();

  ['division', 'workplace', 'department'].forEach(orgUnitType =>
  {
    if (req.query[orgUnitType] > 0)
    {
      options.orgUnitType = orgUnitType;
      options.orgUnitId = parseInt(req.query[orgUnitType], 10);
    }
  });

  reports.helpers.generateReport(
    app,
    reports,
    report,
    'wmes-osh/metrics',
    req.reportHash,
    options,
    (err, reportJson) =>
    {
      if (err)
      {
        return next(err);
      }

      res.type('json');
      res.send(reportJson);
    }
  );
};
