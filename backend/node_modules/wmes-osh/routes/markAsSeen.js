// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = async (app, module, req, res, next) =>
{
  const {
    OshNearMiss,
    OshKaizen,
    OshAction,
    OshObservation
  } = module;

  const typeToModel = {
    nearMisses: OshNearMiss,
    kaizens: OshKaizen,
    actions: OshAction,
    observations: OshObservation
  };

  const Model = typeToModel[req.params.modelType];

  if (!Model)
  {
    return next(app.createError('Invalid model type.', 'INPUT', 400));
  }

  const userId = req.session.user._id;

  Model.markAsSeen(req.body.filter, userId, (err, ids) =>
  {
    if (err)
    {
      return next(err);
    }

    if (ids.length)
    {
      app.broker.publish(`${Model.TOPIC_PREFIX}.seen.${userId}`, {ids});
    }

    res.json(ids);
  });
};
