// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module) =>
{
  const {
    user,
    express,
    OshNearMiss
  } = module;

  const canView = user.auth('USER');
  const canAdd = canView;
  const canEdit = canView;
  const canDelete = user.auth('OSH:NEAR_MISSES:MANAGE');

  express.get(`/osh/nearMisses`, canView, express.crud.browseRoute.bind(null, app, OshNearMiss));
  express.post(`/osh/nearMisses`, canAdd, prepareAdd, express.crud.addRoute.bind(null, app, OshNearMiss));
  express.get(`/osh/nearMisses/:id`, canView, express.crud.readRoute.bind(null, app, OshNearMiss));
  express.put(`/osh/nearMisses/:id`, canEdit, express.crud.editRoute.bind(null, app, OshNearMiss));
  express.delete(`/osh/nearMisses/:id`, canDelete, express.crud.deleteRoute.bind(null, app, OshNearMiss));

  function prepareAdd(req, res, next)
  {
    req.body.createdAt = new Date();
    req.body.creator = !req.body.anonymous ? user.createUserInfo(req.session.user, req) : {
      id: '5f7a32c969226110e835d75b',
      label: 'Anonim Gall'
    };

    next();
  }
};
