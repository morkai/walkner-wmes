// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = async (app, module, req, res, next) =>
{
  const {
    user,
    OshNearMiss
  } = module;

  const sessionUser = req.session.user;

  try
  {
    const nearMiss = await OshNearMiss.findById(req.params.id).exec();

    if (!nearMiss)
    {
      return next(app.createError('Entry not found.', 'NOT_FOUND', 404));
    }

    if (!user.isAllowedTo(sessionUser, [[`${OshNearMiss.PRIVILEGE_PREFIX}:MANAGE`]])
      && !nearMiss.canDelete(sessionUser._id))
    {
      return next(app.createError('Forbidden.', 'AUTH', 403));
    }

    await nearMiss.collection.deleteOne({_id: nearMiss._id});

    app.broker.publish(`${OshNearMiss.TOPIC_PREFIX}.deleted`, {
      user: user.createUserInfo(sessionUser, req),
      model: nearMiss
    });

    res.sendStatus(204);
  }
  catch (err)
  {
    next(err);
  }
};
