// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, sapGui, job, done) =>
{
  const nc12s = !Array.isArray(job.nc12s) ? [] : job.nc12s.filter(v => /^[0-9]{12}$/.test(v));

  if (nc12s.length === 0)
  {
    return done(app.createError('No valid 12NCs.', 'INPUT', 400));
  }

  const logger = sapGui.logger.create({jobId: job.id});

  step(
    function()
    {
      logger.info('Looking for paint components...');

      sapGui.runScript(job, 'T_DP_CLR.exe', nc12s, this.next());
    },
    function(err, exitCode, output)
    {
      if (err)
      {
        return this.skip(err, exitCode, output);
      }

      const data = {};

      let nc12 = null;

      (output || '').split(/\r\n/).forEach(line =>
      {
        if (line.startsWith('NC12='))
        {
          nc12 = line.split('=')[1];

          data[nc12] = {
            family: '',
            category: '',
            code: ''
          };

          return;
        }

        if (line.startsWith('COMPONENT='))
        {
          const parts = line.split('=')[1].split(';');

          data[nc12].family = parts[0];
          data[nc12].category = parts[1];
          data[nc12].code = parts[2];

          return;
        }
      });

      Object.keys(data).forEach(nc12 =>
      {
        if (!data[nc12].family)
        {
          delete data[nc12];
        }
      });

      logger.info('Components found.', {
        orderCount: Object.keys(data).length
      });

      setImmediate(this.next(), null, 0, JSON.stringify(data));
    },
    done
  );
};
