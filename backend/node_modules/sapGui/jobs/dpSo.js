// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, sapGui, job, done) =>
{
  const orders = !Array.isArray(job.orders) ? [] : job.orders.filter(v => /^[0-9]{9}$/.test(v));

  if (orders.length === 0)
  {
    return done(app.createError('No valid orders.', 'INPUT', 400));
  }

  const logger = sapGui.logger.create({jobId: job.id});

  step(
    function()
    {
      logger.info('Looking for sales orders...');

      sapGui.runScript(job, 'T_DP_SO.exe', orders, this.next());
    },
    function(err, exitCode, output)
    {
      if (err)
      {
        return this.skip(err, exitCode, output);
      }

      const data = {};

      let orderNo = null;

      (output || '').split(/\r\n/).forEach(line =>
      {
        if (line.startsWith('ORDER='))
        {
          orderNo = line.split('=')[1];

          data[orderNo] = {
            nc12: '',
            name: '',
            salesOrder: {no: '', item: ''}
          };

          return;
        }

        if (line.startsWith('ORDER_NC12='))
        {
          data[orderNo].nc12 = line.split('=')[1].replace(/^0+/, '');

          return;
        }

        if (line.startsWith('ORDER_NAME='))
        {
          data[orderNo].name = line.split('=')[1];

          return;
        }

        if (line.startsWith('SALES_ORDER_NO='))
        {
          data[orderNo].salesOrder.no = line.split('=')[1];

          return;
        }

        if (line.startsWith('SALES_ORDER_ITEM='))
        {
          data[orderNo].salesOrder.item = line.split('=')[1];

          return;
        }
      });

      logger.info('Orders found.', {
        orderCount: Object.keys(data).length
      });

      setImmediate(this.next(), null, 0, JSON.stringify(data));
    },
    done
  );
};
