// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, module, {orderNo, operationNo, line}, done) =>
{
  const {
    ComponentLabel,
    Order
  } = module;

  step(
    function()
    {
      if (!orderNo || !operationNo)
      {
        return this.skip(null, []);
      }

      Order
        .findById(orderNo)
        .select({operations: 1, bom: 1})
        .lean()
        .exec(this.next());
    },
    function(err, sapOrder)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!sapOrder)
      {
        return this.skip(null, []);
      }

      const operation = (sapOrder.operations || []).find(op => op.no === operationNo);

      if (!operation)
      {
        return this.skip(null, []);
      }

      const componentCodes = ['000000000000'];

      (sapOrder.bom || []).forEach(component =>
      {
        if (component.nc12)
        {
          componentCodes.push(component.nc12);
        }
      });

      const conditions = {
        operationNo: {$in: ['0000', operation.no]},
        componentCode: {$in: componentCodes}
      };

      if (line)
      {
        conditions.$or = [
          {lines: []},
          {lines: line}
        ];
      }

      ComponentLabel
        .find(conditions)
        .lean()
        .exec(this.next());
    },
    done
  );
};
