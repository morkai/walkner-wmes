// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module) =>
{
  const {
    messengerServer
  } = module;

  messengerServer.handle('gft.getOrderData', handleGetOrderData);

  messengerServer.handle('gft.getStationData', handleGetStationData);

  messengerServer.handle('gft.setStationOrder', handleSetStationOrder);

  async function handleGetOrderData(req, done)
  {
    try
    {
      const result = await module.getOrderData(req.orderNo);

      done(null, result);
    }
    catch (err)
    {
      done(err);
    }
  }

  function handleGetStationData(req, done)
  {
    done(null, module.getStationData(req.line, req.station));
  }

  function handleSetStationOrder(req, done)
  {
    const station = module.stations.get(`${req.line}:${req.station}`);

    if (!station)
    {
      return done(app.createError('Station not found.', 'NOT_FOUND', 400));
    }

    station.setOrder(req.orderNo);

    done();
  }
};
