// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const {readFileSync} = require('fs');
const {transliterate} = require('transliteration');

let wordMap = {};

try
{
  wordMap = JSON.parse(readFileSync(process.env.WMES_STEMMER_DICTIONARY, 'utf8'));
}
catch (err) {} // eslint-disable-line no-empty

if (global.gc)
{
  global.gc();
}

process.on('message', message =>
{
  process.send(message.input.map(text =>
  {
    const result = [];

    transliterate(text || '', {unknown: ''})
      .toLowerCase()
      .replace(message.phrase ? /[^a-z0-9\-+"]+/g : /[^a-z0-9]+/g, ' ')
      .split(/\s+/)
      .forEach(word =>
      {
        if (!word.length)
        {
          return;
        }

        if (!message.phrase)
        {
          result.push(wordMap[word] || word);

          return;
        }

        result.push(word.replace(/([^a-z0-9]*)([a-z0-9]+)([^a-z0-9]*)/g, (_, prefix, word, suffix) =>
        {
          return prefix + (wordMap[word] || word) + suffix;
        }));
      });

    return result.join(' ');
  }));
});

process.send('hello');
