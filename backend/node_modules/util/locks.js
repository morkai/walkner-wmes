// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const locks = new Map();

exports.createAsync = async (key) =>
{
  return new Promise((resolve) =>
  {
    const release = exports.create(key, () =>
    {
      resolve(release);
    });
  });
};

exports.create = (key, callback) =>
{
  if (!locks.has(key))
  {
    locks.set(key, []);

    setImmediate(callback);
  }
  else
  {
    locks.get(key).push(callback);
  }

  let released = false;

  return () =>
  {
    if (released)
    {
      return;
    }

    released = true;

    const callbacks = locks.get(key);

    if (!callbacks)
    {
      return;
    }

    const callback = callbacks.shift();

    if (!callbacks.length)
    {
      locks.delete(key);
    }

    if (callback)
    {
      setImmediate(callback);
    }
  };
};
