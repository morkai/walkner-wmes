// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const LAST_MODIFIED_PATHS = new WeakMap();

module.exports = (schema) =>
{
  schema.pre('save', function(next)
  {
    LAST_MODIFIED_PATHS.set(this, this.isNew ? ['_id'] : this.modifiedPaths());

    next();
  });

  schema.methods.lastModifiedPaths = function()
  {
    if (this.isNew)
    {
      return ['_id'];
    }

    if (this.isModified())
    {
      return this.modifiedPaths();
    }

    if (LAST_MODIFIED_PATHS.has(this))
    {
      return LAST_MODIFIED_PATHS.get(this);
    }

    return [];
  };
};
