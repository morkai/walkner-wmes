// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const LAST_MODIFIED_PATHS = new WeakMap();

module.exports = (schema) =>
{
  schema.pre('save', function(next)
  {
    LAST_MODIFIED_PATHS.set(this, this.isNew ? ['_id'] : this.modifiedPaths());

    next();
  });

  schema.methods.lastModifiedPaths = function()
  {
    if (this.isNew)
    {
      return ['_id'];
    }

    if (this.isModified())
    {
      return this.modifiedPaths();
    }

    if (LAST_MODIFIED_PATHS.has(this))
    {
      return LAST_MODIFIED_PATHS.get(this);
    }

    return [];
  };

  schema.methods.lastModifiedValues = function(options)
  {
    const omit = options && options.omit || [];
    const paths = this.lastModifiedPaths();
    const values = {};

    paths.forEach(path =>
    {
      if (path.includes('.'))
      {
        path = path.split('.')[0];
      }

      if (omit.includes(path))
      {
        return;
      }

      values[path] = this[path];
    });

    return values;
  };
};
