// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, module, req, res, next) =>
{
  const {
    user,
    WmesClient
  } = module;

  step(
    function()
    {
      WmesClient.findById(req.params.id).exec(this.next());
    },
    function(err, client)
    {
      if (err)
      {
        return this.skip(err);
      }

      this.isNew = !client;

      if (this.isNew)
      {
        client = new WmesClient(req.body);
      }

      client.lastSeenAt = new Date();
      client.ipAddress = user.getRealIp({}, req);

      client.save(this.next());
    },
    function(err, client)
    {
      if (err)
      {
        return next(err);
      }

      if (this.isNew)
      {
        res.sendStatus(204);
      }
      else
      {
        res.json(client);
      }
    }
  );
};
