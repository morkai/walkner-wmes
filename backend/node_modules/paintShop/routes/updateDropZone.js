// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');
const moment = require('moment');

module.exports = (app, module, req, res, next) =>
{
  const {PaintShopDropZone} = module;

  const {date, mrp} = req.params;

  if (!_.isString(date)
    || !moment(date, 'YYYY-MM-DD').isValid()
    || !_.isString(mrp)
    || _.isEmpty(mrp))
  {
    return next(app.createError('INPUT', 400));
  }

  const state = !!req.body.state;

  PaintShopDropZone.collection.updateOne({_id: {date, mrp}}, {$set: {state}}, {upsert: true}, err =>
  {
    if (err)
    {
      return next(err);
    }

    const dropZone = {
      _id: {date, mrp},
      state
    };

    res.json(dropZone);

    app.broker.publish(`paintShop.dropZones.updated.${date}`, dropZone);
  });
};
