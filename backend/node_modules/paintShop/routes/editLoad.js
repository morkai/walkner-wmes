// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = async (app, module, req, res, next) =>
{
  const {
    user,
    PaintShopLoad
  } = module;

  if (!req.body.time || !req.body.counter)
  {
    return next(app.createError('No ID.', 'INPUT', 400));
  }

  if (req.body.reason === undefined)
  {
    return next(app.createError('No reason.', 'INPUT', 400));
  }

  const load = await PaintShopLoad
    .findOne({
      _id: {
        ts: new Date(req.body.time),
        c: req.body.counter
      }
    })
    .exec();

  if (!load)
  {
    return next(app.createError('Not found.', 'NOT_FOUND', 400));
  }

  load.r = req.body.reason;

  await load.save();

  res.sendStatus(204);

  app.broker.publish('paintShop.load.edited', {
    user: user.createUserInfo(req.session.user, req),
    model: load
  });
};
