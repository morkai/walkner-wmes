// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const os = require('os');
const multer = require('multer');
const importPcbsRoute = require('./importPcbs');
const getOrderDataRoute = require('./getOrderData');
const addOrEditPcbRoute = require('./addOrEditPcb');

module.exports = (app, module) =>
{
  const {
    user,
    express,
    GftPcb
  } = module;

  const canView = user.auth('GFT:VIEW');
  const canManage = user.auth('GFT:MANAGE');

  express.get('/gft/orders/:id', canView, getOrderDataRoute.bind(null, app, module));

  express.get(`/gft/pcbs`, canView, express.crud.browseRoute.bind(null, app, GftPcb));
  express.post(`/gft/pcbs`, canManage, addOrEditPcbRoute.bind(null, app, module));
  express.post(
    '/gft/pcbs;import',
    canManage,
    multer({
      dest: os.tmpdir(),
      limits: {
        files: 1,
        fileSize: 3 * 1024 * 1024
      }
    }).single('file'),
    importPcbsRoute.bind(null, app, module)
  );
  express.get(`/gft/pcbs/:id`, canView, express.crud.readRoute.bind(null, app, GftPcb));
  express.put(`/gft/pcbs/:id`, canManage, express.crud.editRoute.bind(null, app, GftPcb));
  express.delete(`/gft/pcbs/:id`, canManage, express.crud.deleteRoute.bind(null, app, GftPcb));
};
