// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const os = require('os');
const multer = require('multer');
const importPcbsRoute = require('./importPcbs');
const addOrEditPcbRoute = require('./addOrEditPcb');
const getRecentOrdersRoute = require('./getRecentOrders');
const getOrderDataRoute = require('./getOrderData');
const getStationDataRoute = require('./getStationData');
const setStationOrderRoute = require('./setStationOrder');

module.exports = (app, module) =>
{
  const {
    updater,
    user,
    express,
    GftPcb,
    GftTester
  } = module;

  const canView = user.auth('GFT:VIEW', 'EMBEDDED');
  const canManage = user.auth('GFT:MANAGE', 'EMBEDDED');

  express.get('/gft', canView, (req, res) =>
  {
    res.format({
      'text/html': () =>
      {
        res.render('index', updater.getAppTemplateData('gft', req));
      }
    });
  });

  express.get('/gft/recentOrders/:line', canView, getRecentOrdersRoute.bind(null, app, module));
  express.get('/gft/orders/:id', canView, getOrderDataRoute.bind(null, app, module));
  express.get('/gft/stations/:line/:station', canView, getStationDataRoute.bind(null, app, module));
  express.post('/gft/stations/:line/:station', canManage, setStationOrderRoute.bind(null, app, module));

  express.get(`/gft/pcbs`, canView, express.crud.browseRoute.bind(null, app, GftPcb));
  express.post(`/gft/pcbs`, canManage, addOrEditPcbRoute.bind(null, app, module));
  express.post(
    '/gft/pcbs;import',
    canManage,
    multer({
      dest: os.tmpdir(),
      limits: {
        files: 1,
        fileSize: 3 * 1024 * 1024
      }
    }).single('file'),
    importPcbsRoute.bind(null, app, module)
  );
  express.get(`/gft/pcbs/:id`, canView, express.crud.readRoute.bind(null, app, GftPcb));
  express.put(`/gft/pcbs/:id`, canManage, express.crud.editRoute.bind(null, app, GftPcb));
  express.delete(`/gft/pcbs/:id`, canManage, express.crud.deleteRoute.bind(null, app, GftPcb));

  express.get(`/gft/testers`, canView, express.crud.browseRoute.bind(null, app, GftTester));
  express.post(`/gft/testers`, canManage, express.crud.addRoute.bind(null, app, GftTester));
  express.get(`/gft/testers/:id`, canView, express.crud.readRoute.bind(null, app, GftTester));
  express.put(`/gft/testers/:id`, canManage, express.crud.editRoute.bind(null, app, GftTester));
  express.delete(`/gft/testers/:id`, canManage, express.crud.deleteRoute.bind(null, app, GftTester));
};
