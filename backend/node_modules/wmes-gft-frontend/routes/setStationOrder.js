// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = async (app, module, req, res, next) =>
{
  const {
    Order,
    messengerClient
  } = module;

  const params = {
    line: req.params.line,
    station: +req.params.station,
    orderNo: req.body.orderNo
  };

  if (!/^[0-9]{9}$/.test(params.orderNo))
  {
    return next(app.createError('Invalid order number.', 'INPUT', 400));
  }

  const sapOrder = await Order.findById(params.orderNo).select({_id: 1}).lean().exec();

  if (!sapOrder)
  {
    return next(app.createError('Order not found.', 'NOT_FOUND', 400));
  }

  messengerClient.request('gft.setStationOrder', params, err =>
  {
    if (err)
    {
      return next(err);
    }

    res.sendStatus(204);
  });
};
