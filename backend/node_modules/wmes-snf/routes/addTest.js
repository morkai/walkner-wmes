// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');
const printHidLabel = require('../printHidLabel');

module.exports = (app, module, req, res, next) =>
{
  const {SnfTest} = module;

  step(
    function()
    {
      this.test = new SnfTest(req.body);
      this.test.save(this.next());
    },
    function(err)
    {
      if (err)
      {
        if (err.code === 11000)
        {
          return SnfTest.findById(this.test._id).exec(this.next());
        }

        return this.skip(err);
      }

      setImmediate(this.next(), null, this.test);
    },
    function(err, test)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!test)
      {
        return this.skip(app.createError('Duplicate test not found?!', 'DUP_NOT_FOUND', 500));
      }

      if (!this.test.result || this.test.serialNo)
      {
        return this.skip();
      }

      this.test = test;

      const printOptions = {
        requestId: test._id.toString(),
        prodLine: test.prodLine,
        orderNo: test.orderNo,
        serialNo: ''
      };

      printHidLabel(app, module, printOptions, this.next());
    },
    function(err, result)
    {
      if (err)
      {
        return this.skip(err);
      }

      this.test.serialNo = result.serialNo;
      this.test.save(this.next());
    },
    function(err)
    {
      if (err)
      {
        return next(err);
      }

      const result = {
        _id: this.test._id,
        prodLine: this.test.prodLine,
        orderNo: this.test.orderNo,
        serialNo: this.test.serialNo
      };

      res.json(result);

      app.broker.publish(`snf.tests.saved`, result);
    }
  );
};
