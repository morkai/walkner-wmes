// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const os = require('os');
const _ = require('lodash');
const multer = require('multer');

const dictionariesRoute = require('./dictionaries');
const uploadImagesRoute = require('./uploadImages');
const sendImageRoute = require('./sendImage');
const editImageRoute = require('./editImage');
const deleteImageRoute = require('./deleteImage');
const addTestRoute = require('./addTest');
const printHidLabelRoute = require('./printHidLabel');
const getOrderQtyRoute = require('./getOrderQty');

module.exports = (app, module) =>
{
  const {
    express,
    mongoose,
    user,
    SnfProgram,
    SnfTest
  } = module;

  const canView = user.auth('SNF:VIEW');
  const canViewLocal = user.auth('LOCAL', 'SNF:VIEW');
  const canManage = user.auth('SNF:MANAGE');

  express.get('/snf/dictionaries', canView, dictionariesRoute.bind(null, app, module));

  express.get('/snf/programs', canView, express.crud.browseRoute.bind(null, app, SnfProgram));
  express.post('/snf/programs', canManage, express.crud.addRoute.bind(null, app, SnfProgram));
  express.get('/snf/programs/:id', canView, express.crud.readRoute.bind(null, app, SnfProgram));
  express.put('/snf/programs/:id', canManage, express.crud.editRoute.bind(null, app, SnfProgram));
  express.delete('/snf/programs/:id', canManage, express.crud.deleteRoute.bind(null, app, SnfProgram));

  express.post(
    '/snf/programs/:program/images',
    canManage,
    multer({
      dest: os.tmpdir(),
      limits: {
        files: 10,
        fileSize: 5 * 1024 * 1024
      }
    }).any(),
    uploadImagesRoute.bind(null, app, module)
  );
  express.get('/snf/programs/:program/images/:image', canViewLocal, sendImageRoute.bind(null, app, module));
  express.put('/snf/programs/:program/images/:image', canManage, editImageRoute.bind(null, app, module));
  express.delete('/snf/programs/:program/images/:image', canManage, deleteImageRoute.bind(null, app, module));

  express.get('/snf/tests', canView, express.crud.browseRoute.bind(null, app, SnfTest));
  express.post('/snf/tests', canManage, addTestRoute.bind(null, app, module));
  express.get('/snf/tests;getOrderQty', canView, getOrderQtyRoute.bind(null, app, module));
  express.post('/snf/tests;printHidLabel', canManage, printHidLabelRoute.bind(null, app, module));
  express.get('/snf/tests/:id', canView, express.crud.readRoute.bind(null, app, SnfTest));

  _.forEach(module.DICTIONARIES, setUpDictionaryRoutes);

  function setUpDictionaryRoutes(modelName, dictionaryName)
  {
    const Model = mongoose.model(modelName);
    const urlPrefix = `/snf/${dictionaryName}`;

    express.get(urlPrefix, canViewLocal, express.crud.browseRoute.bind(null, app, Model));
    express.post(urlPrefix, canManage, express.crud.addRoute.bind(null, app, Model));
    express.get(`${urlPrefix}/:id`, canViewLocal, express.crud.readRoute.bind(null, app, Model));
    express.put(`${urlPrefix}/:id`, canManage, express.crud.editRoute.bind(null, app, Model));
    express.delete(`${urlPrefix}/:id`, canManage, express.crud.deleteRoute.bind(null, app, Model));
  }
};
