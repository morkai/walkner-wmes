// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const os = require('os');
const multer = require('multer');

const uploadImagesRoute = require('./uploadImages');
const sendImageRoute = require('./sendImage');
const editImageRoute = require('./editImage');
const deleteImageRoute = require('./deleteImage');

module.exports = (app, module) =>
{
  const {
    express,
    user,
    SnfProgram
  } = module;

  const canView = user.auth('SNF:VIEW');
  const canViewLocal = user.auth('LOCAL', 'SNF:VIEW');
  const canManage = user.auth('SNF:MANAGE');

  express.get('/snf/programs', canView, express.crud.browseRoute.bind(null, app, SnfProgram));
  express.post('/snf/programs', canManage, express.crud.addRoute.bind(null, app, SnfProgram));
  express.get('/snf/programs/:id', canView, express.crud.readRoute.bind(null, app, SnfProgram));
  express.put('/snf/programs/:id', canManage, express.crud.editRoute.bind(null, app, SnfProgram));
  express.delete('/snf/programs/:id', canManage, express.crud.deleteRoute.bind(null, app, SnfProgram));

  express.post(
    '/snf/programs/:program/images',
    canManage,
    multer({
      dest: os.tmpdir(),
      limits: {
        files: 10,
        fileSize: 5 * 1024 * 1024
      }
    }).any(),
    uploadImagesRoute.bind(null, app, module)
  );
  express.get('/snf/programs/:program/images/:image', canViewLocal, sendImageRoute.bind(null, app, module));
  express.put('/snf/programs/:program/images/:image', canManage, editImageRoute.bind(null, app, module));
  express.delete('/snf/programs/:program/images/:image', canManage, deleteImageRoute.bind(null, app, module));
};
