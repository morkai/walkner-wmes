// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, {Order, Counter}, req, res, next) =>
{
  step(
    function()
    {
      Order
        .findById(req.query.orderNo)
        .select({qty: 1})
        .lean()
        .exec(this.next());
    },
    function(err, order)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!order)
      {
        return this.skip(app.createError('Order not found.', 'ORDER_NOT_FOUND', 400));
      }

      setImmediate(this.parallel(), null, {
        orderNo: order._id,
        qtyDone: 0,
        qtyTodo: order.qty
      });

      Counter
        .findById({type: 'hidLamps', orderNo: req.query.orderNo})
        .select({c: 1})
        .lean()
        .exec(this.parallel());
    },
    function(err, order, counter)
    {
      if (err)
      {
        return next(err);
      }

      order.qtyDone = counter ? counter.c : 0;

      res.json(order);
    }
  );
};
