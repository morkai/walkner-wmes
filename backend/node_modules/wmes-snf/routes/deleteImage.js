// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const path = require('path');
const fs = require('fs-extra');
const _ = require('lodash');
const step = require('h5.step');

module.exports = (app, {config, SnfProgram}, req, res, next) =>
{
  step(
    function findProgramStep()
    {
      SnfProgram.findById(req.params.program).exec(this.next());
    },
    function removeImageStep(err, program)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!program)
      {
        return this.skip(app.createError('Program not found.', 'INPUT', 400));
      }

      const imageId = req.params.image.split('.')[0];
      const imageIndex = _.findIndex(program.images, (image) => image._id === imageId);

      if (imageIndex === -1)
      {
        return this.skip(app.createError('Image not found.', 'INPUT', 400));
      }

      this.image = program.images[imageIndex];

      program.images.splice(imageIndex, 1);
      program.markModified('images');
      program.save(this.next());
    },
    function sendResponseStep(err)
    {
      if (err)
      {
        return next(err);
      }

      res.sendStatus(204);

      if (!this.image)
      {
        return;
      }

      fs.unlink(path.join(config.snfImagesPath, `${this.image._id}.${this.image.type}`), () => {});

      app.broker.publish(`snf.programs.${req.params.program}.images.deleted`, {
        program: req.params.program,
        image: this.image
      });
    }
  );
};
