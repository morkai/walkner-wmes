// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, {user, CompRelEntry}, req, res, next) =>
{
  step(
    function()
    {
      CompRelEntry
        .findById(req.params.id)
        .select({changes: 0})
        .lean()
        .exec(this.next());
    },
    function(err, entry)
    {
      if (err)
      {
        return next(err);
      }

      if (!entry)
      {
        return next(app.createError('Not found.', 'NOT_FOUND', 400));
      }

      app.broker.publish(`${CompRelEntry.TOPIC_PREFIX}.notifyRequested`, {
        model: entry,
        requester: user.createUserInfo(req.session.user, req)
      });

      res.sendStatus(204);
    }
  );
};
