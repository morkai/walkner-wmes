// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, {FapEntry}, req, res, next) =>
{
  if (/^[0-9]+$/.test(req.params.filter))
  {
    redirectToDetails(req, res, next);
  }
  else
  {
    redirectToList(req, res, next);
  }

  function redirectToDetails(req, res, next)
  {
    FapEntry.findOne({rid: parseInt(req.params.filter, 10)}, {_id: 1}).lean().exec((err, entry) =>
    {
      if (err)
      {
        return next(err);
      }

      if (entry)
      {
        return res.redirect(`/#fap/entries/${entry._id}`);
      }

      res.sendStatus(404);
    });
  }

  function redirectToList(req, res)
  {
    let url = '/#fap/entries';

    if (req.params.filter === 'mine')
    {
      url += '?exclude(changes)&limit(-1337)&sort(-createdAt)&observers.user.id=mine';
    }

    res.redirect(url);
  }
};
