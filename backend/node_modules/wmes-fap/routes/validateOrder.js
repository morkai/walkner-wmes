// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, {Order, ProdShiftOrder}, req, res, next) =>
{
  step(
    function()
    {
      Order
        .findById(req.query.order)
        .select({_id: 1})
        .lean()
        .exec(this.parallel());

      ProdShiftOrder
        .find({orderId: req.query.order})
        .select({prodLine: 1})
        .lean()
        .exec(this.parallel());
    },
    function(err, sapOrder, prodShiftOrders)
    {
      if (err)
      {
        return next(err);
      }

      if (!sapOrder)
      {
        return next(app.createError(`Order not found: ${req.query.order}`, 'NOT_FOUND', 404));
      }

      const lines = new Set();

      prodShiftOrders.forEach(pso => lines.add(pso.prodLine));

      res.json({
        lines: [...lines].sort((a, b) => a.localeCompare(b, undefined, {numeric: true, ignorePunctuation: true}))
      });
    }
  );
};
