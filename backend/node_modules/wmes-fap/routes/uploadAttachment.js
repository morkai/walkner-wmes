// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const fs = require('fs');

module.exports = (app, module, req, res, next) =>
{
  const file = req.file;

  if (!file)
  {
    return next(app.createError('NO_FILE', 400));
  }

  const id = file.filename.replace(/\..*?$/, '');

  if (!module.tmpAttachments)
  {
    module.tmpAttachments = {};
  }

  module.tmpAttachments[id] = {
    data: {
      _id: id,
      type: file.mimetype,
      size: file.size
    },
    timer: setTimeout(removeAttachmentFile, 10 * 60 * 1000, id, file.path)
  };

  res.json(id);

  function removeAttachmentFile(id, filePath)
  {
    delete module.tmpAttachments[id];

    fs.unlink(filePath, (err) =>
    {
      if (err)
      {
        module.error(err, `Failed to remove an unused attachment.`, {filePath});
      }
      else
      {
        module.info(`Removed an unused attachment.`, {filePath});
      }
    });
  }
};
