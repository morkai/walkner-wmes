// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, {FapEntry}, req, res, next) =>
{
  const pipeline = [
    {$match: {
      observers: {
        $elemMatch: {
          'user.id': req.session.user._id,
          notify: true
        }
      }
    }},
    {$group: {_id: null, ids: {$addToSet: '$_id'}}}
  ];

  FapEntry.aggregate(pipeline, (err, results) =>
  {
    if (err)
    {
      return next(err);
    }

    res.json(results.length ? results[0].ids : []);
  });
};
