// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, {resolveParticipants}, req, res, next) =>
{
  resolveParticipants(req.method === 'POST' ? req.body : req.query, (err, result) =>
  {
    if (err)
    {
      return next(err);
    }

    res.format({
      text: function()
      {
        res.type('text/plain');

        const lines = [result.users.length];
        let maxName = 0;
        let maxFunc = 0;

        result.users.forEach(u =>
        {
          maxName = Math.max(maxName, `${u.lastName} ${u.firstName}`.length);
          maxFunc = Math.max(maxFunc, (u.prodFunction || '').length);
        });

        result.users.forEach(u =>
        {
          const name = `${u.lastName} ${u.firstName}`.padEnd(maxName, ' ');
          const func = (u.prodFunction || '').padEnd(maxFunc, ' ');

          lines.push(`* ${name}  sms=${u.sms ? 1 : 0}  ${func}  ${u.kdPosition}`);
        });

        res.end(lines.join('\n'));
      },
      json: function()
      {
        res.json(result);
      }
    });
  });
};
