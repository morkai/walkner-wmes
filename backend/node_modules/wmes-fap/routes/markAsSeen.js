// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');
const _ = require('lodash');

module.exports = (app, {user, FapEntry}, req, res, next) =>
{
  let userId = req.session.user._id;

  if (req.body.userId)
  {
    if (!user.isAllowedTo('FAP:MANAGE'))
    {
      return next(app.createError(`Cannot mark entries of others.`, 'AUTH', 400));
    }

    userId = req.body.userId;
  }

  step(
    function()
    {
      FapEntry.markAsSeen(req.body.filter, userId, this.next());
    },
    function(err, seen)
    {
      if (err)
      {
        return next(err);
      }

      if (seen.length)
      {
        app.broker.publish(`fap.entries.notifications.${userId}`, {seen});
      }

      res.json(seen);
    }
  );
};
