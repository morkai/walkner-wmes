// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');

module.exports = (app, module) =>
{
  const {user, sio, KaizenOrder} = module;

  sio.sockets.on('connection', (socket) =>
  {
    socket.on('kaizen.markAsSeen', markAsSeen.bind(null, socket));
    socket.on('kaizen.observe', observe.bind(null, socket));
  });

  function markAsSeen(socket, req, reply)
  {
    if (!_.isFunction(reply))
    {
      return;
    }

    if (!_.isObject(req) || !_.isString(req._id))
    {
      return reply(new Error('INPUT'));
    }

    KaizenOrder.markAsSeen(req._id, socket.handshake.user._id, reply);
  }

  function observe(socket, req, reply)
  {
    if (!_.isFunction(reply))
    {
      return;
    }

    const sessionUser = socket.handshake.user;

    if (!_.isObject(req)
      || !_.isString(req._id)
      || !_.isBoolean(req.state)
      || !sessionUser
      || !sessionUser.loggedIn)
    {
      return reply(new Error('INPUT'));
    }

    KaizenOrder.observe(req._id, req.state, user.createUserInfo(sessionUser, socket), reply);
  }
};
