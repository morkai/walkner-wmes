// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');
const _ = require('lodash');

module.exports = (app, module, req, res, next) =>
{
  const {
    settings,
    DICTIONARIES,
    DpPaint
  } = module;

  step(
    function()
    {
      settings.find({_id: /^dummyPaint\./}, this.group());

      DpPaint.distinct('code', this.group());

      DpPaint.distinct('family', this.group());

      _.forEach(DICTIONARIES, ({model, load}) =>
      {
        if (load !== false)
        {
          model.find().lean().exec(this.group());
        }
      });
    },
    function(err, dictionaries)
    {
      if (err)
      {
        return next(err);
      }

      const result = {
        settings: dictionaries.shift(),
        paintCodes: dictionaries.shift(),
        paintFamilies: dictionaries.shift()
      };

      _.forEach(DICTIONARIES, ({load}, dictionaryName) =>
      {
        if (load !== false)
        {
          result[dictionaryName] = dictionaries.shift();
        }
      });

      res.json(result);
    }
  );
};
