// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = async (app, module, req, res, next) =>
{
  const {
    user,
    DpPaint
  } = module;

  const {code, old12, new12, newName} = req.body;

  if (typeof new12 !== 'string' || !/^[0-9]{12}$/.test(new12))
  {
    return next(app.createError('Invalid new 12NC.', 'INPUT', 400));
  }

  if (!code && !old12)
  {
    return next(app.createError('Code or old 12NC is required.', 'INPUT', 400));
  }

  const userInfo = user.createUserInfo(req.session.user, req);

  try
  {
    const conditions = {};

    if (code)
    {
      conditions.code = code;
    }

    if (old12)
    {
      conditions.nc12 = old12;
    }

    const paints = await DpPaint.find(conditions).lean().exec();

    if (!paints.length)
    {
      return res.json({count: 0});
    }

    const $set = {nc12: new12};

    if (typeof newName === 'string' && newName.length)
    {
      $set.name = newName;
    }

    await DpPaint.collection.updateMany(conditions, {$set});

    res.json({count: paints.length});

    paints.forEach(paint =>
    {
      paint.nc12 = new12;

      if (newName)
      {
        paint.name = newName;
      }

      app.broker.publish(`${DpPaint.TOPIC_PREFIX}.edited`, {
        model: paint,
        user: userInfo
      });
    });
  }
  catch (err)
  {
    next(err);
  }
};
