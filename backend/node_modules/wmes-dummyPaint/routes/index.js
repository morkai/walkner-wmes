// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const dictionariesRoute = require('./dictionaries');
const pingWorkerRoute = require('./pingWorker');
const startJobRoute = require('./startJob');
const updateJobRoute = require('./updateJob');
const cancelJobRoute = require('./cancelJob');

module.exports = (app, module) =>
{
  const {
    settings,
    user,
    express,
    DICTIONARIES,
    DpOrder,
    DpJob,
    DpWorker
  } = module;

  const canView = user.auth('DUMMY_PAINT:VIEW');
  const canManage = user.auth('DUMMY_PAINT:MANAGE');
  const canWorker = user.auth('DUMMY_PAINT:WORKER');

  express.get('/dummyPaint/settings', canView, settings.browseRoute('dummyPaint'));
  express.put('/dummyPaint/settings/:id', canManage, settings.updateRoute);

  express.get('/dummyPaint/orders', canView, express.crud.browseRoute.bind(null, app, DpOrder));
  express.get('/dummyPaint/orders/:id', canView, express.crud.readRoute.bind(null, app, DpOrder));

  express.get('/dummyPaint/jobs', canView, express.crud.browseRoute.bind(null, app, DpJob));
  express.post('/dummyPaint/jobs', canWorker, startJobRoute.bind(null, app, module));
  express.get('/dummyPaint/jobs/:id', canView, express.crud.readRoute.bind(null, app, DpJob));
  express.post('/dummyPaint/jobs/:id;update', canWorker, updateJobRoute.bind(null, app, module));
  express.post('/dummyPaint/jobs/:id;cancel', canWorker, cancelJobRoute.bind(null, app, module));

  express.get('/dummyPaint/workers', canView, express.crud.browseRoute.bind(null, app, DpWorker));
  express.get('/dummyPaint/workers/:id', canView, express.crud.readRoute.bind(null, app, DpWorker));
  express.post('/dummyPaint/workers;ping', canWorker, pingWorkerRoute.bind(null, app, module));

  express.get('/dummyPaint/dictionaries', canView, dictionariesRoute.bind(null, app, module));

  Object.keys(DICTIONARIES).forEach(k =>
  {
    const options = DICTIONARIES[k];
    const canViewDictionary = options.canView || canView;
    const canManageDictionary = options.canManage || canManage;

    express.get(`/dummyPaint/${k}`, canViewDictionary, express.crud.browseRoute.bind(null, app, options));
    express.post(`/dummyPaint/${k}`, canManageDictionary, express.crud.addRoute.bind(null, app, options));
    express.get(`/dummyPaint/${k}/:id`, canViewDictionary, express.crud.readRoute.bind(null, app, options));
    express.put(`/dummyPaint/${k}/:id`, canManageDictionary, express.crud.editRoute.bind(null, app, options));
    express.delete(`/dummyPaint/${k}/:id`, canManageDictionary, express.crud.deleteRoute.bind(null, app, options));
  });
};
