// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const pceReportRoute = require('./pceReport');
const groupsReportRoute = require('./groupsReport');
const inveoRoute = require('./inveo');

module.exports = (app, module) =>
{
  const {
    express,
    user,
    CtCart,
    CtLine,
    CtTodo,
    CtPce,
    CtOrderGroup,
    messengerClient
  } = module;

  const canView = user.auth('PROD_DATA:VIEW');
  const canManage = user.auth('PROD_DATA:MANAGE');
  const canTodo = user.auth('LOCAL');

  express.get('/ct/state', canView, getStateRoute);

  express.get('/inveo/:line/:station', canTodo, inveoRoute.bind(null, app, module));

  express.get('/ct/carts', canView, express.crud.browseRoute.bind(null, app, CtCart));
  express.post('/ct/carts', canManage, express.crud.addRoute.bind(null, app, CtCart));
  express.get('/ct/carts/:id', canView, express.crud.readRoute.bind(null, app, CtCart));
  express.put('/ct/carts/:id', canManage, express.crud.editRoute.bind(null, app, CtCart));
  express.delete('/ct/carts/:id', canManage, express.crud.deleteRoute.bind(null, app, CtCart));

  express.get('/ct/lines', canView, express.crud.browseRoute.bind(null, app, CtLine));
  express.post('/ct/lines', canManage, express.crud.addRoute.bind(null, app, CtLine));
  express.get('/ct/lines/:id', canView, express.crud.readRoute.bind(null, app, CtLine));
  express.put('/ct/lines/:id', canManage, express.crud.editRoute.bind(null, app, CtLine));
  express.delete('/ct/lines/:id', canManage, express.crud.deleteRoute.bind(null, app, CtLine));

  express.get('/ct/orderGroups', canView, express.crud.browseRoute.bind(null, app, CtOrderGroup));
  express.post('/ct/orderGroups', canManage, express.crud.addRoute.bind(null, app, CtOrderGroup));
  express.get('/ct/orderGroups/:id', canView, express.crud.readRoute.bind(null, app, CtOrderGroup));
  express.put('/ct/orderGroups/:id', canManage, express.crud.editRoute.bind(null, app, CtOrderGroup));
  express.delete('/ct/orderGroups/:id', canManage, express.crud.deleteRoute.bind(null, app, CtOrderGroup));

  express.get('/ct/todos', canView, express.crud.browseRoute.bind(null, app, CtTodo));

  express.get('/ct/pces', canView, express.crud.browseRoute.bind(null, app, CtPce));

  express.get('/ct/reports/pce', canView, pceReportRoute.bind(null, app, module));
  express.get('/ct/reports/groups', canView, groupsReportRoute.bind(null, app, module));

  function getStateRoute(req, res, next)
  {
    messengerClient.request('ct.getAllLineState', {}, (err, lineStates) =>
    {
      if (err)
      {
        return next(err);
      }

      res.json(lineStates);
    });
  }
};
