// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = function(personnelProperty)
{
  return function(app, productionModule, prodLine, logEntry, done)
  {
    const subdivisionsModule = app[productionModule.config.subdivisionsId];
    const User = app[productionModule.config.mongooseId].model('User');

    productionModule.getProdData('shift', logEntry.prodShift, function(err, prodShift)
    {
      if (err)
      {
        productionModule.error(err, `Failed to get prod shift to change the ${personnelProperty}`, {
          prodShiftId: logEntry.prodShift,
          prodLogEntryId: logEntry._id
        });

        return done(err);
      }

      if (!prodShift)
      {
        productionModule.warn(`Couldn't find prod shift to change the ${personnelProperty}.`, {
          prodShiftId: logEntry.prodShift,
          prodLogEntryId: logEntry._id
        });

        return done();
      }

      if (logEntry.data && logEntry.data.id === null)
      {
        fillUserData(prodShift);
      }
      else
      {
        updatePersonnel(prodShift);
      }
    });

    function fillUserData(prodShift)
    {
      const personellId = logEntry.data.label;

      if (typeof personellId !== 'string' || personellId.length === 0)
      {
        logEntry.data = null;

        return updatePersonnel(prodShift);
      }

      User
        .findOne({personellId}, {_id: 1, firstName: 1, lastName: 1})
        .lean()
        .exec(function(err, user)
        {
          if (err)
          {
            productionModule.error(err, `Failed to find user to fill the ${personnelProperty} info.`, {
              personellId,
              prodShiftId: logEntry.prodShift,
              prodLogEntryId: logEntry._id
            });

            return done(err);
          }

          if (!user)
          {
            productionModule.warn(`Couldn't find a ${personnelProperty} by personnell ID.`, {
              personellId,
              prodShiftId: logEntry.prodShift,
              prodLogEntryId: logEntry._id
            });

            return updatePersonnel(prodShift);
          }

          logEntry.data.id = user._id.toString();

          if (user.firstName && user.lastName)
          {
            logEntry.data.label = user.firstName + ' ' + user.lastName;
          }

          return updatePersonnel(prodShift);
        });
    }

    function updatePersonnel(prodShift)
    {
      step(
        function()
        {
          if (prodLine.prodShiftOrder)
          {
            productionModule.getProdData('order', prodLine.prodShiftOrder, this.parallel());
          }
          else
          {
            this.parallel()(null, null);
          }

          if (prodLine.prodDowntime)
          {
            productionModule.getProdData('downtime', prodLine.prodDowntime, this.parallel());
          }
          else
          {
            this.parallel()(null, null);
          }
        },
        function(err, prodShiftOrder, prodDowntime)
        {
          if (err)
          {
            productionModule.error(err, `Failed to get prod data while changing the ${personnelProperty}.`, {
              prodLogEntryId: logEntry._id
            });
          }

          const subdivision = subdivisionsModule.modelsById[prodShift.subdivision];
          const assembly = subdivision && subdivision.type === 'assembly';

          if (prodShiftOrder)
          {
            updateProdDataModel(
              assembly, prodShiftOrder, personnelProperty, logEntry.data, this.parallel()
            );
          }

          if (prodDowntime)
          {
            updateProdDataModel(
              assembly, prodDowntime, personnelProperty, logEntry.data, this.parallel()
            );
          }

          updateProdDataModel(
            assembly, prodShift, personnelProperty, logEntry.data, this.parallel()
          );
        },
        function(err)
        {
          if (err)
          {
            productionModule.error(err, `Failed to save prod data after changing the ${personnelProperty}.`, {
              prodLogEntryId: logEntry._id
            });
          }

          return done(err);
        }
      );
    }
  };

  function updateProdDataModel(assembly, prodDataModel, personnelProperty, personnelInfo, done)
  {
    if (personnelProperty === 'operator' && assembly)
    {
      prodDataModel.operators = personnelInfo ? [personnelInfo] : null;
    }

    prodDataModel[personnelProperty] = personnelInfo;

    prodDataModel.save(done);
  }
};
