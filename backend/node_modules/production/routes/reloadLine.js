// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, module, req, res, next) =>
{
  const {
    orgUnits,
    fte,
    ProdShift
  } = module;

  const lineState = module.getProdLineState(orgUnits.fix.prodLine(req.params.line));

  if (!lineState)
  {
    return next(app.createError('LINE_NOT_FOUND', 400));
  }

  step(
    function()
    {
      const date = fte.currentShift.date;
      const prodLine = lineState.prodLine._id;

      ProdShift
        .findOne({prodLine, date}, {_id: 1})
        .lean()
        .exec(this.parallel());

      ProdShift
        .findOne({_id: req.query.prodShift}, {_id: 1})
        .lean()
        .exec(this.parallel());
    },
    function(err, currentProdShift, newProdShift)
    {
      if (err)
      {
        return next(err);
      }

      if (!currentProdShift)
      {
        return next(app.createError('SHIFT_NOT_FOUND', 400));
      }

      const changes = {
        prodShift: {_id: newProdShift ? newProdShift._id : currentProdShift._id},
        prodShiftOrder: null,
        prodDowntime: null
      };
      const options = {
        reloadOrders: true,
        reloadDowntimes: true
      };

      lineState.update(changes, options);

      res.json(changes.prodShift._id);
    }
  );
};
