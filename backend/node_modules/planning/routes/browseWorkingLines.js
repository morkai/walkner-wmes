// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');

module.exports = async function browseWorkingLinesRoute(app, {Plan}, req, res, next)
{
  try
  {
    const plans = await Plan
      .find({
        _id: {
          $gt: moment.utc(req.params.id, 'YYYY-MM-DD').toDate()
        },
        'stats.quantity': {$gt: 0}
      })
      .select({
        'lines._id': 1,
        'lines.shiftData.startAt': 1
      })
      .sort({
        _id: 1
      })
      .limit(5)
      .lean()
      .exec();

    const workingLines = new Map();

    for (const plan of plans)
    {
      for (const line of plan.lines)
      {
        if (workingLines.has(line._id))
        {
          continue;
        }

        if (line.shiftData[0].startAt)
        {
          workingLines.set(line._id, {
            _id: line._id,
            startAt: line.shiftData[0].startAt.getTime()
          });
        }
      }
    }

    res.json({
      totalCount: workingLines.size,
      collection: Array.from(workingLines.values())
    });
  }
  catch (err)
  {
    next(err);
  }
};
