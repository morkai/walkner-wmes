// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');

module.exports = function browsePlanOrdersRoute(app, {Plan}, req, res, next)
{
  const orderIds = [];

  req.rql.selector.args.forEach(term =>
  {
    if (term.name === 'eq' && term.args[0] === 'orders')
    {
      if (/^[0-9]+$/.test(term.args[1]))
      {
        orderIds.push(String(term.args[1]));
      }
    }
    else if (term.name === 'in' && term.args[0] === 'orders' && Array.isArray(term.args[1]))
    {
      term.args[1].forEach(orderNo =>
      {
        if (/^[0-9]+$/.test(orderNo))
        {
          orderIds.push(String(orderNo));
        }
      });
    }
  });

  if (orderIds.length === 0)
  {
    return res.json({totalCount: 0, collection: []});
  }

  const pipeline = [
    {$match: {_id: moment.utc(req.params.id, 'YYYY-MM-DD').toDate()}},
    {$unwind: '$orders'},
    {$match: {'orders._id': {$in: orderIds}}},
    {$project: {_id: 0, order: '$orders'}}
  ];

  Plan.aggregate(pipeline, (err, planOrders) =>
  {
    if (err)
    {
      return next(err);
    }

    res.json({
      totalCount: planOrders.length,
      collection: planOrders.map(o => o.order)
    });
  });
};
