// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');
const moment = require('moment');
const executionReport = require('../reports/execution');

module.exports = (app, {reports}, req, res, next) =>
{
  const query = req.query;
  const fromMoment = moment.utc(query.from, 'YYYY-MM-DD');
  const toMoment = moment.utc(query.to, 'YYYY-MM-DD');

  if (!fromMoment.isValid() || !toMoment.isValid())
  {
    return next(app.createError('Invalid from/to.', 'INPUT', 400));
  }

  const options = {
    fromTime: fromMoment.valueOf(),
    toTime: toMoment.valueOf(),
    mrps: _.isEmpty(query.mrps) ? [] : query.mrps.split(','),
    lines: _.isEmpty(query.lines) ? [] : query.lines.split(',')
  };

  reports.helpers.generateReport(
    app,
    reports,
    executionReport,
    'planning/execution',
    req.reportHash,
    options,
    (err, reportJson) =>
    {
      if (err)
      {
        return next(err);
      }

      res.type('json');
      res.send(reportJson);
    }
  );
};
