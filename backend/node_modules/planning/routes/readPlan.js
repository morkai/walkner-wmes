// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');
const step = require('h5.step');

module.exports = (app, module, req, res, next) =>
{
  const {activeMrps, Plan} = module;

  step(
    function()
    {
      const fields = req.rql.fields;

      if (!Object.keys(req.rql.fields).length && req.query.pceTimes === '0')
      {
        fields['lines.orders.pceTimes'] = 0;
      }

      Plan.findById(req.params.id, fields).lean().exec(this.parallel());

      if (req.query.minMaxDates === '1')
      {
        Plan.findOne({}, {_id: 1}).sort({_id: 1}).lean().exec(this.parallel());
        Plan.findOne({}, {_id: 1}).sort({_id: -1}).lean().exec(this.parallel());
      }
      else
      {
        setImmediate(this.parallel(), null, null);
        setImmediate(this.parallel(), null, null);
      }

      if (req.query.activeMrps === '1')
      {
        activeMrps.load(this.parallel());
      }
      else
      {
        setImmediate(this.parallel(), null, null);
      }
    },
    function(err, plan, minDate, maxDate, activeMrps)
    {
      if (err)
      {
        return next(err);
      }

      if (!plan)
      {
        return next(app.createError('NOT_FOUND', 404));
      }

      if (minDate)
      {
        plan.minDate = moment.utc(minDate._id).format('YYYY-MM-DD');
      }

      if (maxDate)
      {
        plan.maxDate = moment.utc(maxDate._id).format('YYYY-MM-DD');
      }

      if (activeMrps)
      {
        plan.activeMrps = activeMrps;
      }

      res.json(plan);
    }
  );
};
