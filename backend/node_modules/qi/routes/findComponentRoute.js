// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, {Order}, req, res, next) =>
{
  const pipeline = [
    {$match: {'bom.nc12': req.query.nc12}},
    {$limit: 1},
    {$unwind: '$bom'},
    {$match: {'bom.nc12': req.query.nc12}},
    {$group: {_id: '$bom.nc12', name: {$min: '$bom.name'}}}
  ];

  Order.aggregate(pipeline, (err, result) =>
  {
    if (err)
    {
      return next(err);
    }

    if (!result.length)
    {
      return res.sendStatus(404);
    }

    res.json({
      nc12: result[0]._id,
      productName: result[0].name
    });
  });
};
