// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');
const step = require('h5.step');

module.exports = (app, {user, QiOqlWeek}, req, res, next) =>
{
  const id = new Date(+req.params.id);

  step(
    function()
    {
      QiOqlWeek
        .findById(id)
        .exec(this.parallel());

      QiOqlWeek
        .findOne({_id: {$lt: id}})
        .sort({_id: -1})
        .lean()
        .exec(this.parallel());
    },
    function(err, oqlWeek, prevWeek)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!oqlWeek)
      {
        oqlWeek = new QiOqlWeek({...prevWeek, _id: id});
      }

      oqlWeek.set({
        updatedAt: new Date(),
        updater: user.createUserInfo(req.session.user, req),
        ..._.pick(req.body, ['target', 'where', 'when', 'results'])
      });
      oqlWeek.save(this.next());
    },
    function(err, oqlWeek)
    {
      if (err)
      {
        return next(err);
      }

      oqlWeek = oqlWeek.toJSON();
      oqlWeek._id = oqlWeek._id.getTime();

      res.json(oqlWeek);

      app.broker.publish('qi.oqlWeeks.updated', oqlWeek);
    }
  );
};
