// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const TIMER = Symbol();

module.exports = () =>
{
  const map = new Map();

  function del(key)
  {
    const dl = map.get(key);

    if (dl)
    {
      if (dl[TIMER])
      {
        clearTimeout(dl[TIMER]);
      }

      if (typeof dl.cleanup === 'function')
      {
        dl.cleanup();
      }

      map.delete(key);
    }
  }

  return {
    has: key => map.has(key),
    set: (key, options) =>
    {
      if (!key)
      {
        key = `${Date.now()}${Math.random()}`;
      }

      if (map.has(key))
      {
        del(key);
      }

      map.set(key, {
        ...options,
        [TIMER]: setTimeout(() => del(key), options.cleanupDelay || 30000)
      });

      return key;
    },
    get: key => map.get(key),
    delete: del
  };
};
