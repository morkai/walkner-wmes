// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const multer = require('multer');
const helpers = require('./helpers');
const exportRoute = require('./export');

module.exports = (app, module) =>
{
  const {express, user, settings} = module;

  const downloads = {};

  const canView = user.auth('REPORTS:*');
  const canManage = user.auth('REPORTS:MANAGE');

  if (module.config.reports['1'])
  {
    const canViewReport1 = user.auth('REPORTS:VIEW', 'REPORTS:1:VIEW');

    express.get(
      '/reports/1',
      canViewReport1,
      helpers.sendCachedReport.bind(null, '1'),
      require('./report1').bind(null, app, module)
    );

    express.get(
      '/reports/1;export.:format?',
      canViewReport1,
      require('./report1Export').bind(null, app, module)
    );
  }

  if (module.config.reports['2'])
  {
    const canViewReport2 = user.auth('REPORTS:VIEW', 'REPORTS:2:VIEW');

    express.get(
      '/reports/2',
      canViewReport2,
      helpers.sendCachedReport.bind(null, '2'),
      require('./report2').bind(null, app, module)
    );

    express.get(
      '/reports/2/orders',
      canViewReport2,
      require('./report2Orders').bind(null, app, module)
    );

    express.get(
      '/reports/2/orders;export.:format?',
      canViewReport2,
      require('./report2Export').bind(null, app, module)
    );
  }

  if (module.config.reports.clip)
  {
    const canViewReport2 = user.auth('REPORTS:VIEW', 'REPORTS:2:VIEW');

    express.get(
      '/reports/clip',
      canViewReport2,
      helpers.sendCachedReport.bind(null, 'clip'),
      require('./clip').bind(null, app, module)
    );

    express.get(
      '/reports/clip/orders',
      canViewReport2,
      require('./clipOrders').bind(null, app, module)
    );

    express.get(
      '/reports/clip/orders;export.:format?',
      canViewReport2,
      require('./clipExport').bind(null, app, module)
    );

    express.get(
      '/reports/clip/planners',
      canViewReport2,
      require('./clipPlanners').bind(null, app, module)
    );
  }

  if (module.config.reports['3'])
  {
    express.get(
      '/reports/3',
      user.auth('REPORTS:VIEW', 'REPORTS:3:VIEW'),
      helpers.sendCachedReport.bind(null, '3'),
      require('./report3').bind(null, app, module)
    );
  }

  if (module.config.reports['4'])
  {
    const canViewReport4 = user.auth('REPORTS:VIEW', 'REPORTS:4:VIEW');

    express.get(
      '/reports/4',
      canViewReport4,
      helpers.sendCachedReport.bind(null, '4'),
      require('./report4').bind(null, app, module)
    );

    express.get('/reports/4;notes', canViewReport4, require('./report4Notes').bind(null, app, module));

    express.post('/reports/4;notes', canViewReport4, require('./report4Notes').bind(null, app, module));
  }

  if (module.config.reports['5'])
  {
    express.get(
      '/reports/5',
      user.auth('REPORTS:VIEW', 'REPORTS:5:VIEW'),
      helpers.sendCachedReport.bind(null, '5'),
      require('./report5').bind(null, app, module)
    );
  }

  if (module.config.reports['6'])
  {
    express.get(
      '/reports/6',
      user.auth('REPORTS:VIEW', 'REPORTS:6:VIEW'),
      helpers.sendCachedReport.bind(null, '6'),
      require('./report6').bind(null, app, module)
    );
  }

  if (module.config.reports['7'])
  {
    express.get(
      '/reports/7',
      user.auth('REPORTS:VIEW', 'REPORTS:7:VIEW'),
      helpers.sendCachedReport.bind(null, '7'),
      require('./report7').bind(null, app, module)
    );
  }

  if (module.config.reports['8'])
  {
    express.get(
      '/reports/8',
      user.auth('REPORTS:VIEW', 'REPORTS:8:VIEW'),
      helpers.sendCachedReport.bind(null, '8'),
      require('./report8').bind(null, app, module)
    );
  }

  if (module.config.reports['9'])
  {
    express.get(
      '/reports/9',
      user.auth('REPORTS:VIEW', 'REPORTS:9:VIEW'),
      helpers.sendCachedReport.bind(null, '9'),
      require('./report9').bind(null, app, module)
    );
  }

  express.get(
    '/reports/settings',
    canView,
    (req, res, next) =>
    {
      req.rql.selector = {
        name: 'regex',
        args: ['_id', '^reports\\.']
      };

      return next();
    },
    express.crud.browseRoute.bind(null, app, settings.Setting)
  );

  express.put('/reports/settings/:id', canManage, settings.updateRoute);

  if (module.config.javaBatik)
  {
    express.post(
      '/reports;export',
      multer({
        limits: {
          files: 0
        }
      }).any(),
      exportRoute.bind(null, module)
    );
  }

  express.post('/reports;download', (req, res) =>
  {
    if (!req.query.filename || !req.is('text/csv'))
    {
      return res.sendStatus(400);
    }

    const key = (Date.now() + Math.random()).toString();

    downloads[key] = {
      filename: `${req.query.filename}.csv`,
      body: Buffer.concat([Buffer.from([0xEF, 0xBB, 0xBF]), Buffer.from(req.body, 'utf8')]),
      timer: setTimeout(() => { delete downloads[key]; }, 30000)
    };

    res.send(key);
  });

  express.get('/reports;download', (req, res) =>
  {
    const key = req.query.key;

    if (!key)
    {
      return res.sendStatus(400);
    }

    const download = downloads[key];

    if (!download)
    {
      return res.sendStatus(404);
    }

    clearTimeout(download.timer);

    delete downloads[key];

    res.attachment(download.filename);
    res.end(download.body);
  });
};
