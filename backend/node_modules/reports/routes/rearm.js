// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const helpers = require('./helpers');
const rearmReport = require('../rearm');

module.exports = (app, reportsModule, req, res, next) =>
{
  const options = {
    hash: req.reportHash,
    fromTime: helpers.getTime(req.query.from),
    toTime: helpers.getTime(req.query.to),
    mrps: (req.query.mrps || '').split(',').filter(v => !!v.length)
  };

  if (isNaN(options.fromTime) || isNaN(options.toTime))
  {
    return next(app.createError('Invalid time range.', 'INPUT', 400));
  }

  helpers.generateReport(app, reportsModule, rearmReport, 'rearm', req.reportHash, options, (err, reportJson) =>
  {
    if (err)
    {
      return next(err);
    }

    res.type('json');
    res.send(reportJson);
  });
};
