// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');
const step = require('h5.step');

module.exports = (app, module, req, res, next) =>
{
  const {user, WiringOrder, WiringEvent} = module;

  const input = req.body;

  step(
    function()
    {
      WiringOrder.findById(req.params.id).exec(this.next());
    },
    function(err, wiringOrder)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!wiringOrder)
      {
        return this.skip(app.createError('Order not found.', 'NOT_FOUND', 404));
      }

      wiringOrder.act(input, this.next());
    },
    function(err, changes)
    {
      if (err)
      {
        return next(err);
      }

      if (!changes)
      {
        return res.sendStatus(204);
      }

      res.json(changes);

      app.broker.publish(`${WiringOrder.TOPIC_PREFIX}.updated.${req.params.id}`, changes);

      const userInfo = user.createUserInfo(req.session.user, req);

      if (!req.session.user.loggedIn && input.user)
      {
        userInfo.id = input.user.id;
        userInfo.label = input.user.label;
      }

      WiringEvent.record({
        type: input.action,
        time: new Date(),
        user: userInfo,
        order: req.params.id,
        data: _.omit(input, ['action'])
      });
    }
  );
};
