// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, {SnfProgram}, req, res, next) =>
{
  step(
    function findProgramStep()
    {
      SnfProgram.findById(req.params.program).exec(this.next());
    },
    function editImageStep(err, program)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!program)
      {
        return this.skip(app.createError('Program not found.', 'INPUT', 400));
      }

      const imageId = req.params.image.split('.')[0];

      this.image = program.images.find((image) => image._id === imageId);

      if (!this.image)
      {
        return this.skip(app.createError('Image not found', 'INPUT', 400));
      }

      this.image.label = req.body.label;

      program.markModified('images');
      program.save(this.next());
    },
    function sendResponseStep(err)
    {
      if (err)
      {
        return next(err);
      }

      res.sendStatus(204);

      app.broker.publish(`snf.programs.${req.params.program}.images.edited`, {
        program: req.params.program,
        image: this.image
      });
    }
  );
};
