// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');
const moment = require('moment');
const findDocumentFilePath = require('./findDocumentFilePath');
const findOrderData = require('./findOrderData');

exports.DEFAULT_CONFIG = {
  mongooseId: 'mongoose',
  expressId: 'express',
  sioId: 'sio',
  userId: 'user',
  updaterId: 'updater',
  orgUnitsId: 'orgUnits',
  settingsId: 'settings',
  productionId: 'production',
  mailSenderId: 'mail/sender',
  uploadsDest: './data/uploads/documents',
  exiftoolExe: 'exiftool',
  pdfboxAppJar: 'pdfbox-app-2.0.3.jar',
  cwebpExe: 'cwebp',
  maxJavaHeapSpace: '512m'
};

exports.models = [
  require('./models/orderDocumentChange'),
  require('./models/orderDocumentClient'),
  require('./models/orderDocumentConfirmation'),
  require('./models/orderDocumentFile'),
  require('./models/orderDocumentFolder'),
  require('./models/orderDocumentName'),
  require('./models/orderDocumentStatus'),
  require('./models/orderDocumentUpload'),
  require('./models/missingOrderDocument'),
  require('subscriptions/models/subscription'),
  require('user/models/user'),
  require('licenses/models/license'),
  require('orders/models/order'),
  require('orders/models/orderEto')
];

exports.recordTopics = {
  warning: [
    'orderDocuments.tree.filePurged',
    'orderDocuments.tree.folderPurged'
  ]
};

exports.republishTopics = [
  'orderDocuments.tree.**',
  'orderDocuments.clients.**',
  'orderDocuments.remoteChecked.**',
  'orderDocuments.confirmed.**',
  'orderDocuments.eto.synced',
  'orderDocuments.missing.updated'
];

exports.userPrivileges = ['DOCUMENTS:VIEW', 'DOCUMENTS:MANAGE'];

exports.optionalModules = {
  'mongoose': [
    require('./converter'),
    require('./changes')
  ],
  'mongoose mailSender': require('./subscriptions'),
  'mongoose sio user production orgUnits': require('./commands'),
  'mongoose user updater orgUnits express': require('./routes'),
  'settings': [
    require('./settings'),
    require('./tree')
  ]
};

exports.start = (app, module) =>
{
  module.cachedSettings = {};
  module.freshHeaders = {};
  module.orderDataCache = new Map();
  module.documentContentsCache = new Map();

  module.findDocumentFilePath = findDocumentFilePath.bind(null, app, module);
  module.findOrderData = findOrderData.bind(null, app, module);

  app.broker.subscribe('app.started', removeOldClients).setLimit(1);

  app.broker.subscribe('orderDocuments.tree.fileAdded', onFileAdded);
  app.broker.subscribe('orderDocuments.tree.fileEdited', onFileEdited);

  app.broker.subscribe('orders.bom.synced', onComponentsSynced);
  app.broker.subscribe('orders.updated.*', onOrderUpdated);
  app.broker.subscribe('orderDocuments.synced', onDocumentsSynced);
  app.broker.subscribe('orderDocuments.eto.synced', onEtoSynced);
  app.broker.subscribe('orderDocuments.tree.converted', onUploadConverted);

  function clearDocumentContentsCache()
  {
    module.documentContentsCache.clear();
  }

  function clearOrderDataCache()
  {
    module.orderDataCache.clear();
  }

  function onComponentsSynced()
  {
    clearOrderDataCache();
    clearDocumentContentsCache();
  }

  function onOrderUpdated({_id, change})
  {
    if (change.newValues.compRels)
    {
      module.orderDataCache.delete(_id);
    }
  }

  function onDocumentsSynced()
  {
    clearOrderDataCache();
    clearDocumentContentsCache();
  }

  function onEtoSynced({nc12})
  {
    module.orderDataCache.forEach(order =>
    {
      if (order.nc12 === nc12)
      {
        module.orderDataCache.delete(order.no);
      }
    });
  }

  function onUploadConverted({nc15})
  {
    module.documentContentsCache.forEach(({documents}, orderNo) =>
    {
      if (documents[nc15])
      {
        module.documentContentsCache.delete(orderNo);
      }
    });
  }

  function onFileAdded(message)
  {
    onFileEdited(message);
  }

  function onFileEdited({file})
  {
    clearFreshHeaders(file);
    clearOrderDataCache();
  }

  function clearFreshHeaders(file)
  {
    if (file && module.freshHeaders[file._id])
    {
      delete module.freshHeaders[file._id];
    }
  }

  function removeOldClients()
  {
    step(
      function()
      {
        const conditions = {
          disconnectedAt: {$lt: moment().subtract(7, 'days').toDate()}
        };

        module.OrderDocumentClient.deleteMany(conditions, this.next());
      },
      function(err)
      {
        if (err)
        {
          return this.skip(err);
        }

        const conditions = {
          connectedAt: {$lt: moment().subtract(21, 'days').toDate()}
        };

        module.OrderDocumentClient.deleteMany(conditions, this.next());
      },
      function(err)
      {
        if (err)
        {
          module.error(err, 'Failed to remove old clients.');
        }

        setTimeout(removeOldClients, 24 * 3600 * 1000);
      }
    );
  }
};
