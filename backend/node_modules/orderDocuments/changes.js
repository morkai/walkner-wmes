// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module) =>
{
  let pendingChanges = [];
  let saveTimer = null;

  ['fileAdded', 'fileEdited', 'fileRemoved', 'fileRecovered', 'filePurged'].forEach((type) =>
  {
    app.broker.subscribe(`orderDocuments.tree.${type}`, ({file, user}) =>
    {
      recordChange(type, file, user);
    });
  });

  function recordChange(type, file, user)
  {
    pendingChanges.push({
      user,
      time: new Date(),
      nc15: file._id,
      type,
      data: file
    });

    if (saveTimer)
    {
      return;
    }

    saveTimer = setTimeout(savePendingChanges, 1000);
  }

  function savePendingChanges()
  {
    saveTimer = null;

    const changes = pendingChanges;

    pendingChanges = [];

    module.OrderDocumentChange.insertMany(changes, (err) =>
    {
      if (err)
      {
        module.error(err, `Failed to save pending changes.`, {pendingChanges: changes});
      }
    });
  }
};
