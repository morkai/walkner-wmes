// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');
const {transliterate} = require('transliteration');
const specialDocuments = require('./specialDocuments');

module.exports = (app, module, req, res, next) =>
{
  const nc15 = req.params.nc15;

  if (specialDocuments[nc15])
  {
    return specialDocuments[nc15](app, module, req, res, next);
  }

  module.checkRemoteServer(nc15);

  const orderNo = /^[0-9]{9}$/.test(req.query.order) ? req.query.order : null;
  const hash = /^[a-f0-9]{32}$/.test(req.query.hash) ? req.query.hash : null;
  const options = {
    orderNo,
    hash,
    forceOriginal: true,
    includeName: !!req.query.name
  };

  module.findDocumentFilePath(nc15, options, (err, results) =>
  {
    if (err)
    {
      if (err.code)
      {
        res.set('X-Error-Code', err.code);
      }

      if (err.required)
      {
        res.set('X-Error-Required', String(err.required));
      }

      if (Array.isArray(err.actual))
      {
        res.set('X-Error-Actual', err.actual.join(', '));
      }

      return next(err);
    }

    if (!results)
    {
      return res.sendStatus(404);
    }

    res.set('X-Document-Source', results.source);

    if (!_.isEmpty(results.name))
    {
      res.set('X-Document-Name', transliterate(results.name, {unknown: '?'}));
    }

    if (results.type)
    {
      res.set('X-Document-Type', results.type);
    }

    return res.sendStatus(204);
  });
};
