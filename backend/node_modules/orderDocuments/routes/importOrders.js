// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');

module.exports = (app, {Order, cachedSettings}, req, res, next) =>
{
  const date = moment(req.query.date, 'YYYY-MM-DD').toDate();
  const pipeline = [
    {$match: {
      scheduledStartDate: moment(req.query.date, 'YYYY-MM-DD').toDate(),
      statuses: 'REL'
    }},
    {$group: {_id: null, orders: {$addToSet: '$_id'}}}
  ];

  if (Array.isArray(cachedSettings.excludedMrps) && cachedSettings.excludedMrps.length)
  {
    pipeline[0].$match.mrp = {$nin: cachedSettings.excludedMrps};
  }

  Order.aggregate(pipeline, (err, results) =>
  {
    if (err)
    {
      return next(err);
    }

    res.json({
      date,
      orders: results.length ? results[0].orders : []
    });
  });
};
