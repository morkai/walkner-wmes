// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');
const shifts = require('util/shifts');
const businessDays = require('reports/businessDays');

module.exports = (app, {Order, cachedSettings}, req, res, next) =>
{
  const date = moment(req.query.date, 'YYYY-MM-DD').toDate();
  const pipeline = [
    {$match: {
      scheduledStartDate: moment(req.query.date, 'YYYY-MM-DD').toDate(),
      statuses: {
        $in: ['REL'],
        $nin: ['TECO', 'DLT', 'DLFL', 'CNF', 'DLV']
      }
    }},
    {$group: {_id: null, orders: {$addToSet: '$_id'}}}
  ];

  if (Array.isArray(cachedSettings.excludedMrps) && cachedSettings.excludedMrps.length)
  {
    pipeline[0].$match.mrp = {$nin: cachedSettings.excludedMrps};
  }

  const to = shifts.getCurrentDate(false).add(1, 'days');

  while (!businessDays.countInDay(to.toDate()))
  {
    to.add(1, 'days');
  }

  if (date > to.toDate())
  {
    pipeline[0].$match['documents.1'] = {$exists: false};
  }

  Order.aggregate(pipeline, (err, results) =>
  {
    if (err)
    {
      return next(err);
    }

    res.json({
      date,
      orders: results.length ? results[0].orders : []
    });
  });
};
