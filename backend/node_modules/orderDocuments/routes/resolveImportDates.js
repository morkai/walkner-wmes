// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const moment = require('moment');
const {formatDate} = require('util/dateFormatter');

module.exports = (app, {Order, cachedSettings}, req, res, next) =>
{
  const date = moment();

  if (date.hours() < 6)
  {
    date.subtract(1, 'days');
  }

  date.startOf('day');

  const pipeline = [
    {$match: {
      scheduledStartDate: {$gte: date.toDate()},
      statuses: 'REL'
    }},
    {$group: {_id: '$scheduledStartDate'}},
    {$sort: {_id: 1}}
  ];

  if (Array.isArray(cachedSettings.excludedMrps) && cachedSettings.excludedMrps.length)
  {
    pipeline[0].$match.mrp = {$nin: cachedSettings.excludedMrps};
  }

  Order.aggregate(pipeline, (err, results) =>
  {
    if (err)
    {
      return next(err);
    }

    res.json({
      dates: results.map(result => formatDate(result._id))
    });
  });
};
