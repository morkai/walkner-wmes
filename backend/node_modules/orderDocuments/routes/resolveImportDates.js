// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const shifts = require('util/shifts');
const {formatDate} = require('util/dateFormatter');

module.exports = (app, {Order, cachedSettings}, req, res, next) =>
{
  const pipeline = [
    {$match: {
      scheduledStartDate: {$gte: shifts.getCurrentDate(false).toDate()},
      statuses: {
        $in: ['REL'],
        $nin: ['TECO', 'DLT', 'DLFL', 'CNF', 'DLV']
      }
    }},
    {$group: {_id: '$scheduledStartDate'}},
    {$sort: {_id: 1}}
  ];

  if (Array.isArray(cachedSettings.excludedMrps) && cachedSettings.excludedMrps.length)
  {
    pipeline[0].$match.mrp = {$nin: cachedSettings.excludedMrps};
  }

  Order.aggregate(pipeline, (err, results) =>
  {
    if (err)
    {
      return next(err);
    }

    res.json({
      dates: results.map(result => formatDate(result._id))
    });
  });
};
