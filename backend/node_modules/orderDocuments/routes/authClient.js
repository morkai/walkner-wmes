// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');
const step = require('h5.step');

module.exports = (app, {user, orgUnits}, req, res, next) =>
{
  step(
    function authenticateStep()
    {
      user.authenticate(_.pick(req.body, ['login', 'password', 'apiKey']), this.next());
    },
    function authorizeStep(err, authUser)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!authUser.super && !_.includes(authUser.privileges, 'OPERATOR:ACTIVATE'))
      {
        return this.skip(app.createError('NO_PRIVILEGES', 403));
      }
    },
    function checkProdLineStep(err)
    {
      if (err)
      {
        return this.skip(err);
      }

      const prodLine = orgUnits.getByTypeAndId('prodLine', req.body.prodLineId);

      if (!prodLine)
      {
        return this.skip(app.createError('INVALID_PROD_LINE', 400));
      }
    },
    function sendResponseStep(err)
    {
      if (err)
      {
        return next(err);
      }

      res.sendStatus(204);
    }
  );
};
