// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, module, req, res, next) =>
{
  const {orderNo} = req.params;

  if (typeof orderNo !== 'string' || !/^[0-9]+$/.test(orderNo))
  {
    return next(app.createError('INPUT', 400));
  }

  step(
    function()
    {
      module.findOrderData(orderNo, this.next());
    },
    function(err, orderData)
    {
      if (err)
      {
        return this.skip(err);
      }

      this.results = {};

      Object.keys(orderData.documents).forEach(nc15 =>
      {
        const done = this.group();
        const opts = {
          orderNo,
          hash: null,
          forcePdf: false,
          includeName: true
        };

        module.findDocumentFilePath(nc15, opts, (err, results) => // eslint-disable-line handle-callback-err
        {
          (results && results.meta && results.meta.pages ? results.meta.pages : []).forEach(page =>
          {
            page.content.forEach(text =>
            {
              const item = text.s.padStart(4, '0');

              text.p = page.info.num;

              if (!this.results[item])
              {
                this.results[item] = {};
              }

              if (!this.results[item][nc15])
              {
                this.results[item][nc15] = [];
              }

              this.results[item][nc15].push(text);
            });
          });

          done(null);
        });
      });
    },
    function(err)
    {
      if (err)
      {
        return next(err);
      }

      res.json(this.results);
    }
  );
};
