// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');

module.exports = (app, {tree, user}, req, res, next) =>
{
  const action = req.body.action;

  if (!_.isString(action) || !/^[a-zA-Z0-9]{1,30}$/.test(action))
  {
    return next(app.createError('INVALID_ACTION', 400));
  }

  if (!_.isFunction(tree[action]))
  {
    return next(app.createError('UNKNOWN_ACTION', 400));
  }

  const userInfo = user.createUserInfo(req.session.user, req);

  tree[action](req.body.params, userInfo, (err) =>
  {
    if (err)
    {
      return next(err);
    }

    res.sendStatus(204);
  });
};
