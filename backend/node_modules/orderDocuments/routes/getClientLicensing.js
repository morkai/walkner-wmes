// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, {License, OrderDocumentClient}, req, res, next) =>
{
  step(
    function findModelsStep()
    {
      License
        .find({appId: 'wmes-docs'}, {features: 1})
        .lean()
        .exec(this.parallel());

      OrderDocumentClient
        .countDocuments({})
        .exec(this.parallel());
    },
    function sendResponseStep(err, licenses, clientCount)
    {
      if (err)
      {
        return next(err);
      }

      return res.send({
        licenseCount: licenses.reduce((total, license) => total + license.features, 0),
        clientCount
      });
    }
  );
};
