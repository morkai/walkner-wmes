// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, {OrderDocumentFile, OrderDocumentUpload}, req, res, next) =>
{
  step(
    function()
    {
      OrderDocumentFile.findOne({_id: req.body.nc15}).lean().exec(this.parallel());

      OrderDocumentUpload.deleteOne({_id: req.body.hash}).exec(this.parallel());
    },
    function(err, doc)
    {
      if (err)
      {
        return this.skip(err);
      }

      if (!doc)
      {
        return this.skip(app.createError('Document not found.', 'NOT_FOUND', 400));
      }

      if (!doc.files.some(f => f.hash === req.body.hash))
      {
        return this.skip(app.createError('File not found.', 'NOT_FOUND', 400));
      }

      const upload = new OrderDocumentUpload({
        _id: req.body.hash,
        nc15: req.body.nc15,
        count: -1
      });

      upload.save(this.next());
    },
    function(err)
    {
      if (err)
      {
        return next(err);
      }

      res.sendStatus(204);

      app.broker.publish('orderDocuments.tree.filesUploaded');
    }
  );
};
