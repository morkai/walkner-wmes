// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const specialDocuments = require('./specialDocuments');

module.exports = (app, module, req, res, next) =>
{
  const nc15 = req.params.nc15;

  if (specialDocuments[nc15])
  {
    return next(app.createError('NO_SPECIAL_NC15', 400));
  }

  const orderNo = /^[0-9]{9}$/.test(req.query.order) ? req.query.order : null;
  const hash = /^[a-f0-9]{32}$/.test(req.query.hash) ? req.query.hash : null;
  const options = {
    orderNo,
    hash,
    forceOriginal: false,
    includeName: true
  };

  module.findDocumentFilePath(nc15, options, (err, results) =>
  {
    if (err)
    {
      if (err.code === 'ENOENT')
      {
        return res.sendStatus(404);
      }

      return next(err);
    }

    if (!results)
    {
      return res.sendStatus(404);
    }

    if (!results.meta)
    {
      return next(app.createError('NO_META', 400));
    }

    res.json(results.meta);
  });
};
