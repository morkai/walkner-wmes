// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');

module.exports = (app, module) =>
{
  const sio = app[module.config.sioId];

  sio.sockets.on('connection', socket =>
  {
    socket.on('users.sync', handleUsersSyncRequest.bind(null, socket));
  });

  function handleUsersSyncRequest(socket, reply)
  {
    if (!_.isFunction(reply))
    {
      reply = () => {};
    }

    if (module.syncing)
    {
      return reply();
    }

    const user = socket.handshake.user || {privileges: []};

    if (!user.super && !user.privileges.includes('USERS:MANAGE'))
    {
      return reply(new Error('AUTH'));
    }

    reply();

    module.syncUsers(user);
  }
};
