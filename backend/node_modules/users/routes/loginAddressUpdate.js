// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module, req, res) =>
{
  try
  {
    const key = Object.keys(req.query)[0];
    const data = module.addressUpdateState.get(key);

    module.addressUpdateState.delete(key);

    if (!data)
    {
      throw new Error(`Missing data for key: ${key}`);
    }

    req.sessionID = null;

    res.cookie('wmes.sid', data.sid, {
      expires: data.expires ? new Date(data.expires) : new Date(Date.now() + 30 * 24 * 3600 * 1000),
      httpOnly: true,
      secure: false,
      signed: true
    });

    res.redirect(`https://ket.wmes.pl/${data.hash || '#'}`);
  }
  catch (err)
  {
    module.error(`[addressUpdate] Failed address update login: ${err.message}`);

    res.redirect('https://ket.wmes.pl/');
  }
};
