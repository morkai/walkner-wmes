// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module, req, res, next) =>
{
  const {user} = module;

  const sessionUser = req.session.user || null;
  const oldSessionId = req.sessionID;

  req.session.regenerate((err) =>
  {
    if (err)
    {
      return next(err);
    }

    req.session.user = user.prepareSessionUser(Object.assign({}, user.guest), false, req);

    res.format({
      json: () =>
      {
        res.sendStatus(204);
      },
      default: () =>
      {
        res.redirect('/');
      }
    });

    if (sessionUser !== null)
    {
      sessionUser.ipAddress = req.session.user.ipAddress;

      app.broker.publish('users.logout', {
        user: sessionUser,
        oldSessionId,
        newSessionId: req.sessionID
      });
    }
  });
};
