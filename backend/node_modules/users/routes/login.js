// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const step = require('h5.step');

module.exports = (app, module, req, res, next) =>
{
  const {user, login} = module;

  step(
    function()
    {
      if (req.user === undefined)
      {
        user.authenticate(req.body, this.next());
      }
      else
      {
        setImmediate(this.next(), null, req.user);
      }
    },
    function(err, userModel)
    {
      if (err)
      {
        if (err.status < 500)
        {
          app.broker.publish('users.loginFailure', {
            severity: 'warning',
            user: req.session.user,
            login: String(req.body.login)
          });
        }

        return next(err);
      }

      if (req.query.login === '0')
      {
        return res.json(user.prepareSessionUser(userModel, false, req));
      }

      req.user = userModel;

      login(req, res, next);
    }
  );
};
