// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

module.exports = (app, module, req, res) =>
{
  const hash = req.query.hash || '#';
  const sid = req.signedCookies ? req.signedCookies['wmes.sid'] : null;

  if (!sid)
  {
    return res.redirect(`https://ket.wmes.pl/${hash}`);
  }

  if (!module.addressUpdateState)
  {
    module.addressUpdateState = new Map();
  }

  const key = Buffer.from(Math.random() + '!' + Date.now() + '!' + Math.random(), 'utf8').toString('base64');
  const data = {
    sid,
    hash,
    expires: req.session && req.session.cookie && req.session.cookie._expires || null
  };

  module.addressUpdateState.set(key, data);

  setTimeout(() => module.addressUpdateState.delete(key), 30000);

  res.redirect(`https://ket.wmes.pl/addressUpdate/login?${encodeURIComponent(key)}`);
};
