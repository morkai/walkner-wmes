// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const _ = require('lodash');

module.exports = (app, {user}, req, res, next) =>
{
  const oldSessionId = req.sessionID;
  const userData = _.defaults({}, req.user, user.guest);

  req.session.regenerate(err =>
  {
    if (err)
    {
      return next(err);
    }

    req.session.user = user.prepareSessionUser(userData, true, req);

    const returnUrl = req.cookies['users.returnUrl'];

    res.clearCookie('users.returnUrl');

    if (returnUrl)
    {
      res.redirect(returnUrl);
    }
    else
    {
      res.format({
        html: () => res.redirect('/'),
        json: () => res.json(userData),
        default: () => res.redirect('/')
      });
    }

    app.broker.publish('users.login', {
      user: userData,
      oldSessionId,
      newSessionId: req.sessionID,
      socketId: req.body.socketId
    });
  });
};
