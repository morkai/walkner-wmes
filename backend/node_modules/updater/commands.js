// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

'use strict';

const {exec} = require('child_process');

module.exports = (app, module) =>
{
  const sio = app[module.config.sioId];

  sio.sockets.on('connection', (socket) =>
  {
    socket.emit('updater.versions', module.getVersions());

    socket.on('updater.pull', (reply) =>
    {
      if (typeof reply !== 'function')
      {
        reply = function() {};
      }

      const user = socket.handshake.user;

      if (!user || !user.super)
      {
        module.warn(`Unauthorized pull attempt.`, {socket: socket.handshake});

        return reply(new Error('AUTH'));
      }

      const cmd = '"' + module.config.pull.exe + '" pull';

      module.info('Attempting a pull...');

      exec(cmd, module.config.pull, function(err, stdout, stderr)
      {
        if (err)
        {
          module.error(err, 'Failed the pull.');
        }
        else if (stderr && stderr.length)
        {
          module.info('Failed the pull.');
        }
        else
        {
          module.info('Pull succeeded.');
        }

        reply(err, {stdout: stdout, stderr: stderr});
      });
    });
  });
};
