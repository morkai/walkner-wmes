/*!
 * backbone.layoutmanager.js v0.9.4
 * Copyright 2013, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */

!function(e,t){"use strict";var n=e.Backbone;return"function"==typeof define&&define.amd?define(["backbone","underscore","jquery"],function(){return t.apply(e,arguments)}):void(n.Layout=t.call(e,n,e._,n.$))}("object"==typeof global?global:this,function(e,t,n){"use strict";var r=this,i=e.View,a=Array.prototype.push,s=Array.prototype.concat,o=Array.prototype.splice,c=String.prototype.trim?t.bind(String.prototype.trim.call,String.prototype.trim):n.trim,l=e.View.extend({_render:function(){var e=this,t=e.__manager__,n=e.beforeRender,r=e.deferred();return e.hasRendered&&e._removeViews(),t.callback=function(){delete t.isAsync,delete t.callback,e.trigger("beforeRender",e),e._viewRender(t).render().then(function(){r.resolve()})},n&&n.call(e,e),t.isAsync||t.callback(),r.promise()},_applyTemplate:function(e,r,i){t.isString(e)&&(r.noel?(e=n.parseHTML(e,!0),this.$el.slice(1).remove(),this.$el.replaceWith(e),this.setElement(e,!1)):this.html(this.$el,e)),i.resolveWith(this,[this])},_viewRender:function(e){function n(t,n){var i;e.callback=function(t){delete e.isAsync,delete e.callback,s._applyTemplate(t,e,a)},l.cache(r,n),n&&(i=s.renderTemplate.call(s,n,t)),e.isAsync||s._applyTemplate(i,e,a)}var r,i,a,s=this;return{render:function(){var o=s.serialize,c=s.template;return a=s.deferred(),t.isFunction(o)&&(o=o.call(s)),e.callback=function(t){delete e.isAsync,delete e.callback,n(o,t)},"string"==typeof c&&(r=s.prefix+c),(i=l.cache(r))?(n(o,i,r),a):("string"==typeof c?i=s.fetchTemplate.call(s,s.prefix+c):"function"==typeof c?i=c:null!=c&&(i=s.fetchTemplate.call(s,c)),e.isAsync||n(o,i),a)}}},constructor:function(n){this.manage=!0,t.extend(this,n),e.View.apply(this,arguments)},async:function(){var e=this.__manager__;return e.isAsync=!0,e.callback},promise:function(){return this.__manager__.renderDeferred.promise()},renderViews:function(){var e=this,t=e.__manager__,n=e.deferred(),r=e.getViews().map(function(e){return e.render().__manager__.renderDeferred}).value();return t.renderDeferred=n.promise(),e.when(r).then(function(){n.resolveWith(e,[e])}),e},insertView:function(t,n,r){return n instanceof e.View?this.setView(t,n,!0,r):this.setView(t,!0,n)},insertViews:function(e){return t.isArray(e)?this.setViews({"":e}):(t.each(e,function(n,r){e[r]=t.isArray(n)?n:[n]}),this.setViews(e))},getView:function(e){return null==e&&(e=arguments[1]),this.getViews(e).first().value()},getViews:function(e){var n;return"string"==typeof e?(e=this.sections[e]||e,n=this.views[e]||[],t.chain([].concat(n))):(n=t.chain(this.views).map(function(e){return t.isArray(e)?e:[e]},this).flatten(),"object"==typeof e?n.where(e):"function"==typeof e?n.filter(e):n)},removeView:function(e){return this.getViews(e).each(function(e){e.remove()})},setView:function(e,n,r,i){var a,o,c,l=this;if("string"!=typeof e&&(i=r,r=n,n=e,e=""),a=n.__manager__,!a)throw new Error("The argument associated with selector '"+e+"' is defined and a View.  Set `manage` property to true for Backbone.View instances.");return a.parent=l,o=a.selector=l.sections[e]||e,c=l.views[o],r?(l.views[o]=s.call([],l.views[e]||[],n),i&&t.isNumber(i.insertAt)&&c?(c.splice(i.insertAt,0,n),l.views[o]=c,a.insertAt=i.insertAt):l.views[o]=s.call([],c||[],n),l.__manager__.insert=!0,n):(n.hasRendered&&n.partial(l.$el,n.$el,l.__manager__,a),l.removeView(e),l.views[o]=n)},setViews:function(e){return t.each(e,function(e,n){return t.isArray(e)?t.each(e,function(e){this.insertView(n,e)},this):void this.setView(n,e)},this),this},render:function(){function e(){function e(){var e=r.console,n=i.afterRender;n&&n.call(i,i),i.trigger("afterRender",i),s.noel&&i.$el.length>1&&t.isFunction(e.warn)&&!i.suppressWarnings&&(e.warn("`el: false` with multiple top level elements is not supported."),t.isFunction(e.trace)&&e.trace())}var n;return t.each(i.views,function(e,n){t.isArray(e)&&i.htmlBatch(i,e,n)}),o&&!s.insertedViaFragment&&(i.contains(o.el,i.el)||o.partial(o.$el,i.$el,c,s)),i.delegateEvents(),i.hasRendered=!0,(n=s.queue.shift())?n():delete s.queue,c&&c.queue?o.once("afterRender",e):e(),l.resolveWith(i,[i])}function n(){i._render().done(function(){if(!t.keys(i.views).length)return e();var n=t.map(i.views,function(e){var n=t.isArray(e);return n&&e.length?i.when(t.map(e,function(e){return e.__manager__.insertedViaFragment=!0,e.render().__manager__.renderDeferred})):n?e:e.render().__manager__.renderDeferred});i.when(n).done(e)})}var i=this,s=i.__manager__,o=s.parent,c=o&&o.__manager__,l=i.deferred();return s.queue?a.call(s.queue,n):(s.queue=[],n(i,l)),i.__manager__.renderDeferred=l,i},remove:function(){return l._removeView(this,!0),this._remove.apply(this,arguments)}},{_cache:{},_removeViews:function(e,t){"boolean"==typeof e&&(t=e,e=this),e=e||this,e.getViews().each(function(e){(e.hasRendered||t)&&l._removeView(e,t)})},_removeView:function(e,n){var r,i=e.__manager__,a=i.parent&&i.parent.__manager__,s="boolean"==typeof e.keep?e.keep:e.options.keep;if(!s&&a&&a.insert===!0||n){if(l.cleanViews(e),e._removeViews(!0),e.$el.remove(),!i.parent)return;if(r=i.parent.views[i.selector],t.isArray(r))return t.each(t.clone(r),function(e,t){e&&e.__manager__===i&&o.call(r,t,1)});delete i.parent.views[i.selector]}},cache:function(e,t){return e in this._cache&&null==t?this._cache[e]:null!=e&&null!=t?this._cache[e]=t:void 0},cleanViews:function(n){t.each(s.call([],n),function(n){n.unbind(),n.model instanceof e.Model&&n.model.off(null,null,n),n.collection instanceof e.Collection&&n.collection.off(null,null,n),n.stopListening(),t.isFunction(n.cleanup)&&n.cleanup()})},configure:function(n){t.extend(l.prototype,n),n.manage&&(e.View.prototype.manage=!0),n.el===!1&&(e.View.prototype.el=!1),n.suppressWarnings===!0&&(e.View.prototype.suppressWarnings=!0)},setupView:function(n,r){r=r||{},t.each(s.call([],n),function(n){if(!n.__manager__){var i,a,s=l.prototype;t.defaults(n,{views:{},sections:{},__manager__:{},_removeViews:l._removeViews,_removeView:l._removeView},l.prototype),n.options=r,t.extend(n,r),n._remove=e.View.prototype.remove,n.render=l.prototype.render,n.remove!==s.remove&&(n._remove=n.remove,n.remove=s.remove),i=r.views||n.views,t.keys(i).length&&(a=i,n.views={},t.each(a,function(e,t){"function"==typeof e&&(a[t]=e.call(n,n))}),n.setViews(a))}})}});l.VERSION="0.9.4",e.Layout=l,e.View=function(e){var t;e=e||{},("el"in e?e.el===!1:this.el===!1)&&(t=!0),(e.manage||this.manage)&&l.setupView(this,e),this.__manager__&&(this.__manager__.noel=t,this.__manager__.suppressWarnings=e.suppressWarnings),i.apply(this,arguments)},e.View.extend=i.extend,e.View.prototype=i.prototype;var u={prefix:"",deferred:function(){return n.Deferred()},fetchTemplate:function(e){return t.template(n(e).html())},renderTemplate:function(e,t){return c(e(t))},serialize:function(){return this.model?t.clone(this.model.attributes):{}},partial:function(e,t,n,r){var i;r.selector&&(n.noel?(i=e.filter(r.selector),e=i.length?i:e.find(r.selector)):e=e.find(r.selector)),n.insert?this.insert(e,t,r.insertAt,r.selector):this.html(e,t)},html:function(e,t){e.html(t)},htmlBatch:function(e,r,i){var a=e.__manager__,s={selector:i},o=t.reduce(r,function(t,r){var i="boolean"==typeof r.keep?r.keep:r.options.keep,a=i&&n.contains(e.el,r.el);return r.el&&!a&&t.push(r.el),t},[]);return this.partial(e.$el,n(o),a,s)},insert:function(e,n,r,i){t.isNumber(r)?this.insertAtIndex(e,n,r,i):e.append(n)},insertAtIndex:function(e,t,n,r){var i,a=e.children();i=a.eq(0>n?Math.max(0,a.length+n):n);var s=this.views[r];0>n?n=Math.max(0,s.length-1+n):n+=1;var o=s[n];o?o.el.parentNode?t.insertBefore(o.$el):i.length?i.before(t):e.append(t):e.append(t)},when:function(e){return n.when.apply(null,e)},contains:function(e,t){return n.contains(e,t)}};return t.extend(l.prototype,u),l});