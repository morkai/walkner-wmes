/*!
 * backbone.layoutmanager.js v0.9.3
 * Copyright 2013, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */

!function(e,t){var n=e.Backbone;return"function"==typeof define&&define.amd?define(["backbone","underscore","jquery"],function(){return t.apply(e,arguments)}):(n.Layout=t.call(e,n,e._,n.$),void 0)}("object"==typeof global?global:this,function(e,t,n){var r,i=this,o=e.View.prototype._configure,a=Array.prototype.push,s=Array.prototype.concat,l=Array.prototype.splice,u=e.View.extend({_render:function(e){var t=this,n=t.__manager__,r=e.beforeRender,i=e.deferred();return t.hasRendered&&t._removeViews(),n.callback=function(){delete n.isAsync,delete n.callback,t.trigger("beforeRender",t),t._viewRender(e,n).render().then(function(){i.resolve()})},r&&r.call(t,t),n.isAsync||n.callback(),i.promise()},_applyTemplate:function(e,r,i,o){t.isString(e)&&(i.noel?(e=n.parseHTML(n.trim(e),!0),this.$el.slice(1).remove(),this.$el.replaceWith(e),this.setElement(e,!1)):r.html(this.$el,e)),o.resolveWith(this,[this])},_viewRender:function(e,n){function r(t,r){var o;n.callback=function(t){delete n.isAsync,delete n.callback,s._applyTemplate(t,e,n,a)},u.cache(i,r),r&&(o=e.renderTemplate.call(s,r,t)),n.isAsync||s._applyTemplate(o,e,n,a)}var i,o,a,s=this;return{render:function(){var l=s.serialize||e.serialize,c=s.template||e.template;return a=e.deferred(),t.isFunction(l)&&(l=l.call(s)),n.callback=function(e){delete n.isAsync,delete n.callback,r(l,e)},"string"==typeof c&&(i=e.prefix+c),(o=u.cache(i))?(r(l,o,i),a):("string"==typeof c?o=e.fetchTemplate.call(s,e.prefix+c):"function"==typeof c?o=c:null!=c&&(o=e.fetchTemplate.call(s,c)),n.isAsync||r(l,o),a)}}},constructor:function(t){this.manage=!0,e.View.call(this,t)},async:function(){var e=this.__manager__;return e.isAsync=!0,e.callback},promise:function(){return this.__manager__.renderDeferred.promise()},renderViews:function(){var e=this,t=e.__manager__,n=e.getAllOptions(),r=n.deferred(),i=e.getViews().map(function(e){return e.render().__manager__.renderDeferred}).value();return t.renderDeferred=r.promise(),n.when(i).then(function(){r.resolveWith(e,[e])}),e},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return t.isArray(e)?this.setViews({"":e}):(t.each(e,function(n,r){e[r]=t.isArray(n)?n:[n]}),this.setViews(e))},getView:function(e){return null==e&&(e=arguments[1]),this.getViews(e).first().value()},getViews:function(e){var n;return"string"==typeof e?(e=this.sections[e]||e,n=this.views[e]||[],t.chain([].concat(n))):(n=t.chain(this.views).map(function(e){return t.isArray(e)?e:[e]},this).flatten(),"object"==typeof e?n.where(e):"function"==typeof e?n.filter(e):n)},removeView:function(e){return this.getViews(e).each(function(e){e.remove()})},setView:function(e,t,n){var r,i,o,a=this;if("string"!=typeof e&&(n=t,t=e,e=""),r=t.__manager__,!r)throw new Error("The argument associated with selector '"+e+"' is defined and a View.  Set `manage` property to true for "+"Backbone.View instances.");return i=t.getAllOptions(),r.parent=a,o=r.selector=a.sections[e]||e,n?(a.views[o]=s.call([],a.views[e]||[],t),a.__manager__.insert=!0,t):(t.hasRendered&&i.partial(a.$el,t.$el,a.__manager__,r),a.removeView(e),a.views[o]=t)},setViews:function(e){return t.each(e,function(e,n){return t.isArray(e)?t.each(e,function(e){this.insertView(n,e)},this):(this.setView(n,e),void 0)},this),this},render:function(){function e(){function e(){var e=i.console,n=o.afterRender;n&&n.call(r,r),r.trigger("afterRender",r),s.noel&&r.$el.length>1&&t.isFunction(e.warn)&&!o.suppressWarnings&&(e.warn("`el: false` with multiple top level elements is not supported."),t.isFunction(e.trace)&&e.trace())}var n;return t.each(r.views,function(e,n){t.isArray(e)&&o.htmlBatch(r,e,n)}),l&&!s.insertedViaFragment&&(o.contains(l.el,r.el)||l.getAllOptions().partial(l.$el,r.$el,u,s)),r.delegateEvents(),r.hasRendered=!0,(n=s.queue.shift())?n():delete s.queue,u&&u.queue?l.once("afterRender",e):e(),c.resolveWith(r,[r])}function n(){var n=r.getAllOptions();r._render(n).done(function(){if(!t.keys(r.views).length)return e();var i=t.map(r.views,function(e){var r=t.isArray(e);return r&&e.length?n.when(t.map(e,function(e){return e.__manager__.insertedViaFragment=!0,e.render().__manager__.renderDeferred})):r?e:e.render().__manager__.renderDeferred});n.when(i).done(e)})}var r=this,o=r.getAllOptions(),s=r.__manager__,l=s.parent,u=l&&l.__manager__,c=o.deferred();return s.queue?a.call(s.queue,n):(s.queue=[],n(r,c)),r.__manager__.renderDeferred=c,r},remove:function(){return u._removeView(this,!0),this._remove.apply(this,arguments)},getAllOptions:function(){return t.extend({},this,u.prototype.options,this.options)}},{_cache:{},_removeViews:function(e,t){"boolean"==typeof e&&(t=e,e=this),e=e||this,e.getViews().each(function(e){(e.hasRendered||t)&&u._removeView(e,t)})},_removeView:function(e,n){var r,i=e.__manager__,o=i.parent&&i.parent.__manager__,a="boolean"==typeof e.keep?e.keep:e.options.keep;if(!a&&o&&o.insert===!0||n){if(u.cleanViews(e),e._removeViews(!0),e.$el.remove(),!i.parent)return;if(r=i.parent.views[i.selector],t.isArray(r))return t.each(t.clone(r),function(e,t){e&&e.__manager__===i&&l.call(r,t,1)});delete i.parent.views[i.selector]}},cache:function(e,t){return e in this._cache&&null==t?this._cache[e]:null!=e&&null!=t?this._cache[e]=t:void 0},cleanViews:function(n){t.each(s.call([],n),function(n){var r;n.unbind(),n.model instanceof e.Model&&n.model.off(null,null,n),n.collection instanceof e.Collection&&n.collection.off(null,null,n),n.stopListening(),r=n.getAllOptions().cleanup,t.isFunction(r)&&r.call(n)})},configure:function(n){t.extend(u.prototype.options,n),n.manage&&(e.View.prototype.manage=!0),n.el===!1&&(e.View.prototype.el=!1),n.suppressWarnings===!0&&(e.View.prototype.suppressWarnings=!0)},setupView:function(n,i){t.each(s.call([],n),function(n){if(!n.__manager__){var o,a,l,c=u.prototype,d=t.pick(n,r);t.defaults(n,{views:{},sections:{},__manager__:{},_removeViews:u._removeViews,_removeView:u._removeView},u.prototype),i=n.options=t.defaults(i||{},n.options,c.options),l=t.pick(i,s.call(["events","sections"],t.values(i.events||{}))),t.extend(n,l),t.extend(i,d),n._remove=e.View.prototype.remove,n.render=u.prototype.render,n.remove!==c.remove&&(n._remove=n.remove,n.remove=c.remove),o=i.views||n.views,t.keys(o).length&&(a=o,n.views={},t.each(a,function(e,t){"function"==typeof e&&(a[t]=e.call(n,n))}),n.setViews(a)),n.options.template?n.options.template=i.template:n.template&&(i.template=n.template)}})}});return u.VERSION="0.9.3",e.Layout=u,e.View.prototype._configure=function(e){var t,n;return("el"in e?e.el===!1:this.el===!1)&&(t=!0),n=o.apply(this,arguments),(e.manage||this.manage)&&u.setupView(this),this.__manager__&&(this.__manager__.noel=t,this.__manager__.suppressWarnings=e.suppressWarnings),n},u.prototype.options={prefix:"",deferred:function(){return n.Deferred()},fetchTemplate:function(e){return t.template(n(e).html())},renderTemplate:function(e,t){return e(t)},serialize:function(){return this.model?t.clone(this.model.attributes):{}},partial:function(e,t,n,r){var i;r.selector&&(n.noel?(i=e.filter(r.selector),e=i.length?i:e.find(r.selector)):e=e.find(r.selector)),n.insert?this.insert(e,t):this.html(e,t)},html:function(e,t){e.html(t)},htmlBatch:function(e,r,i){var o=e.__manager__,a={selector:i},s=t.reduce(r,function(t,r){var i="boolean"==typeof r.keep?r.keep:r.options.keep,o=i&&n.contains(e.el,r.el);return r.el&&!o&&t.push(r.el),t},[]);return this.partial(e.$el,n(s),o,a)},insert:function(e,t){e.append(t)},when:function(e){return n.when.apply(null,e)},contains:function(e,t){return n.contains(e,t)}},r=t.keys(u.prototype.options),u});