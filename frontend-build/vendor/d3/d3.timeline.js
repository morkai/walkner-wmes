define(["d3"],function(t){return t.timeline=function(){var n=["circle","rect"],e=function(){},i=function(){},r=function(){},o=function(){},a=function(){},c=function(){},l=function(){},u=function(){},h="bottom",f=null,s=null,g={format:t.time.format("%I %p"),tickTime:t.time.hours,tickNumber:1,tickSize:6},m=t.scale.category20(),d=null,p="rect",w=0,v=0,x={left:30,right:30,top:30,bottom:30},k=!1,y=!1,b=20,B=5,T=!1,_={marginTop:25,marginBottom:0,width:1,color:m},z="timeline-item";function M(n){var M=n.append("g"),F=n[0][0].getBoundingClientRect(),A=t.select(n[0][0]),C={},E=1,N=0,O=0;!function(){if(!f&&!F.width)throw"width of the timeline is not set. As of Firefox 27, timeline().with(x) needs to be explicitly set in order to render";f&&F.width||(f?A.attr("width",f):f=A.attr("width"))}(),(k||0==v&&0==w)&&(M.each(function(t,n){t.forEach(function(t,n){k&&-1==Object.keys(C).indexOf(n)&&(C[n]=E,E++),0==v&&0==w&&t.times.forEach(function(t,n){(t.starting_time<N||0==N)&&(N=t.starting_time),t.ending_time>O&&(O=t.ending_time)})})}),0==v&&0==w&&(w=N,v=O));var R=1/(v-w)*(f-x.left-x.right),S=t.time.scale().domain([w,v]).range([x.left,f-x.right]),j=t.svg.axis().scale(S).orient(h).tickFormat(g.format).ticks(g.tickTime,g.tickNumber).tickSize(g.tickSize);if(M.append("g").attr("class","axis").attr("transform","translate(0,"+(x.top+(b+B)*E)+")").call(j),M.each(function(t,l){t.forEach(function(t,l){var h=t.times,f=void 0!==t.label;function s(t,n){return k?x.top+(b+B)*C[l]:x.top}M.selectAll("svg").data(h).enter().append(p).attr("x",P).attr("y",s).attr("width",function(t,n){return(t.ending_time-t.starting_time)*R}).attr("cy",s).attr("cx",P).attr("r",b/2).attr("height",b).attr("class",z).style("fill",function(n,e){return d?m(t[d]):m?m(l):null}).on("mousemove",function(n,i){e.call(this,n,l,t)}).on("mouseover",function(n,e){i.call(this,n,e,t)}).on("mouseout",function(n,e){r.call(this,n,e,t)}).on("mousedown",function(n,e){o.call(this,n,e,t)}).on("mouseup",function(n,e){a.call(this,n,e,t)}).on("click",function(n,e){c.call(this,n,l,t)}).each(u),f&&n.append("text").attr("class","timeline-label").attr("transform","translate(0,"+(b/2+x.top+(b+B)*C[l])+")").text(f?t.label:t.id),void 0!==t.icon&&n.append("image").attr("class","timeline-label").attr("transform","translate(0,"+(x.top+(b+B)*C[l])+")").attr("xlink:href",t.icon).attr("width",x.left).attr("height",b)})}),Math.ceil(f)>Math.ceil(F.width)){var D=t.behavior.zoom().x(S);D.on("zoom",function(){var n=Math.min(0,Math.max(F.width-f,t.event.translate[0]));D.translate([n,0]),M.attr("transform","translate("+n+",0)"),l(n*R,S)}),n.attr("class","scrollable").call(D)}y&&M.selectAll("text").attr("transform",function(t){return"rotate("+y+")translate("+(this.getBBox().width/2+10)+","+this.getBBox().height/2+")"});var H=M[0][0].getBoundingClientRect();if(function(){if(s||A.attr("height"))s?A.attr("height",s):s=A.attr("height");else{if(!b)throw"height of the timeline is not set";s=H.height+H.top-F.top,t.select(n[0][0]).attr("height",s)}}(),T){var I=S(new Date);n.append("svg:line").attr("x1",I).attr("y1",_.marginTop).attr("x2",I).attr("y2",s-_.marginBottom).style("stroke",_.color).style("stroke-width",_.width)}function P(t,n){return x.left+(t.starting_time-w)*R}}return M.margin=function(t){return arguments.length?(x=t,M):x},M.orient=function(t){return arguments.length?(h=t,M):h},M.itemHeight=function(t){return arguments.length?(b=t,M):b},M.itemMargin=function(t){return arguments.length?(B=t,M):B},M.height=function(t){return arguments.length?(s=t,M):s},M.width=function(t){return arguments.length?(f=t,M):f},M.display=function(t){return arguments.length&&-1!=n.indexOf(t)?(p=t,M):p},M.tickFormat=function(t){return arguments.length?(g=t,M):g},M.hover=function(t){return arguments.length?(e=t,M):e},M.mouseover=function(t){return arguments.length?(i=t,M):t},M.mouseout=function(t){return arguments.length?(r=t,M):t},M.mousedown=function(t){return arguments.length?(o=t,M):t},M.mouseup=function(t){return arguments.length?(a=t,M):t},M.click=function(t){return arguments.length?(c=t,M):c},M.scroll=function(t){return arguments.length?(l=t,M):l},M.afterRender=function(t){return arguments.length?(u=t,M):u},M.colors=function(t){return arguments.length?(m=t,M):m},M.beginning=function(t){return arguments.length?(w=t,M):w},M.ending=function(t){return arguments.length?(v=t,M):v},M.rotateTicks=function(t){return y=t,M},M.stack=function(){return k=!k,M},M.showToday=function(){return T=!T,M},M.showTodayFormat=function(t){return arguments.length?(_=t,M):_},M.colorProperty=function(t){return arguments.length?(d=t,M):d},M.itemClassName=function(t){return arguments.length?(z=t,M):z},M}});