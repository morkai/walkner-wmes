define(["require","exports","module"],function(e,t,n){function r(e){this.messageBroker=e,this.children=null,this.subscriptions=null,this.subscriptionsPendingRemoval=null,this.sendingMessagesCount=0,this.removeSubscription=this.removeSubscription.bind(this)}n.exports=r;var i=[];r.TOKEN={SEPARATOR:".",ANY:"*",ALL:"**"},r.prototype.destroy=function(){var e=this.children;if(null!==e){for(var t=Object.keys(e),n=0,r=t.length;r>n;++n)e[t[n]].destroy();this.children=null}this.removeSubscriptions(),this.subscriptionsPendingRemoval=null,this.messageBroker=null},r.prototype.count=function(e,t){if(null!==this.subscriptions&&(t[e]=this.subscriptions.length||1),null!==this.children){0!==e.length&&(e+=r.TOKEN.SEPARATOR);for(var n=Object.keys(this.children),i=0,o=n.length;o>i;++i){var a=n[i];this.children[a].count(e+a,t)}}},r.prototype.add=function(e){var t=this.splitTopic(e.getTopic());this.addSubscription(t,e)},r.prototype.remove=function(e){this.removeSubscriptions(this.splitTopic(e))},r.prototype.send=function(e,t,n){var r=this.splitTopic(e);this.sendMessage(r,e,t,n)},r.prototype.addSubscription=function(e,t){var n=this.subscriptions;if(0===e.length)return null===n?this.subscriptions=t:"undefined"==typeof n.length?this.subscriptions=[n,t]:n.push(t),t.on("cancel",this.removeSubscription),this.subscriptions===t&&this.messageBroker.emit("new topic",t.getTopic()),void 0;null===this.children&&(this.children={});var i=this.children,o=e.shift();o in i||(i[o]=new r(this.messageBroker)),i[o].addSubscription(e,t)},r.prototype.removeSubscriptions=function(e){if("undefined"==typeof e||0===e.length){var t=this.subscriptions;if(null===t)return;this.subscriptions=null;var n;if("undefined"==typeof t.length)t.cancel(),n=t.getTopic();else{n=t[0].getTopic();for(var r=0,i=t.length;i>r;++r)t[r].cancel()}return this.messageBroker.emit("empty topic",n),void 0}if(null!==this.children){var o=e.shift();o in this.children&&this.children[o].removeSubscriptions(e)}},r.prototype.sendMessage=function(e,t,n,o){++this.sendingMessagesCount;var a=null!==this.children;if(a&&r.TOKEN.ALL in this.children&&this.children[r.TOKEN.ALL].sendMessage(i,t,n,o),0===e.length){if(null!==this.subscriptions)if("undefined"==typeof this.subscriptions.length)this.subscriptions.send(t,n,o);else for(var s=0,l=this.subscriptions.length;l>s;++s)this.subscriptions[s].send(t,n,o)}else if(a){var u=e.shift();r.TOKEN.ANY in this.children&&this.children[r.TOKEN.ANY].sendMessage([].concat(e),t,n,o),u in this.children&&this.children[u].sendMessage(e,t,n,o)}--this.sendingMessagesCount,this.removePendingSubscriptions()},r.prototype.splitTopic=function(e){var t=e.split(r.TOKEN.SEPARATOR).filter(function(e){return 0!==e.length});if(0===t.length)throw new Error("Invalid subscription topic: "+e);return t},r.prototype.removeSubscription=function(e){this.messageBroker.emit("cancel",e);var t=this.subscriptions;if(null!==t){if(t===e)return this.subscriptions=null,this.messageBroker.emit("empty topic",e.getTopic()),void 0;var n=t.length;if("number"==typeof n){for(var r=-1,i=0;n>i;++i)if(t[i]===e){r=i;break}if(-1!==r){if(this.sendingMessagesCount>0)return null===this.subscriptionsPendingRemoval?this.subscriptionsPendingRemoval=[r]:this.subscriptionsPendingRemoval.push(r),void 0;t.splice(r,1),2===n&&(this.subscriptions=t[0])}}}},r.prototype.removePendingSubscriptions=function(){var e=this.subscriptionsPendingRemoval;if(!(null===e||this.sendingMessagesCount>0)){for(var t=this.subscriptions,n=0,r=e.length;r>n;++n)t.splice(e[n],1);var i=t.length;1===i&&(this.subscriptions=t[0]),this.subscriptionsPendingRemoval=null}}});