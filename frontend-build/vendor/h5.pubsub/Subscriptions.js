define(function(i,s,t){"use strict";t.exports=n;var e=[];function n(i){this.messageBroker=i,this.children={},this.subscriptions=[],this.subscriptionsPendingRemoval=[],this.sendingMessagesCount=0,this.removeSubscription=this.removeSubscription.bind(this)}n.TOKEN={SEPARATOR:".",ANY:"*",ALL:"**"},n.prototype.destroy=function(){for(var i=this.children,s=Object.keys(i),t=0,e=s.length;t<e;++t)i[s[t]].destroy();this.children=null,this.removeSubscriptions(),this.subscriptionsPendingRemoval=null,this.messageBroker=null},n.prototype.count=function(i,s){this.subscriptions.length&&(s[i]=this.subscriptions.length);var t=Object.keys(this.children),e=t.length;if(e){0!==i.length&&(i+=n.TOKEN.SEPARATOR);for(var o=0;o<e;++o){var r=t[o];this.children[r].count(i+r,s)}}},n.prototype.add=function(i){var s=this.splitTopic(i.getTopic());this.addSubscription(s,i)},n.prototype.remove=function(i){this.removeSubscriptions(this.splitTopic(i))},n.prototype.send=function(i,s,t){var e=this.splitTopic(i);this.sendMessage(e,i,s,t)},n.prototype.addSubscription=function(i,s){if(0===i.length)return this.subscriptions.push(s),s.on("cancel",this.removeSubscription),void(1===this.subscriptions.length&&this.messageBroker.emit("new topic",s.getTopic()));var t=this.children,e=i.shift();void 0===t[e]&&(t[e]=new n(this.messageBroker)),t[e].addSubscription(i,s)},n.prototype.removeSubscriptions=function(i){var s,t;if(void 0!==i&&0!==i.length){var e=i.shift();void 0!==this.children[e]&&this.children[e].removeSubscriptions(i)}else{var n=this.subscriptions;if(!n.length)return;this.subscriptions=[];var o=n[0].getTopic();for(s=0,t=n.length;s<t;++s)n[s].cancel();this.messageBroker.emit("empty topic",o)}},n.prototype.sendMessage=function(i,s,t,o){if(++this.sendingMessagesCount,void 0!==this.children[n.TOKEN.ALL]&&this.children[n.TOKEN.ALL].sendMessage(e,s,t,o),0===i.length)for(var r=0,h=this.subscriptions.length;r<h;++r)this.subscriptions[r].send(s,t,o);else{var c=i.shift();void 0!==this.children[n.TOKEN.ANY]&&this.children[n.TOKEN.ANY].sendMessage([].concat(i),s,t,o),void 0!==this.children[c]&&this.children[c].sendMessage(i,s,t,o)}--this.sendingMessagesCount,this.removePendingSubscriptions()},n.prototype.splitTopic=function(i){var s=i.split(n.TOKEN.SEPARATOR).filter(function(i){return 0!==i.length});if(0===s.length)throw new Error("Invalid subscription topic: "+i);return s},n.prototype.removeSubscription=function(i){if(this.messageBroker.emit("cancel",i),0!==this.subscriptions.length)return 1===this.subscriptions.length&&this.subscriptions[0]===i?(this.subscriptions.length=0,void this.messageBroker.emit("empty topic",i.getTopic())):void this.removeOrQueueRemoval(i)},n.prototype.removeOrQueueRemoval=function(i){0===this.sendingMessagesCount?this.subscriptions.splice(this.subscriptions.indexOf(i),1):this.subscriptionsPendingRemoval.push(i)},n.prototype.removePendingSubscriptions=function(){var i=this.subscriptionsPendingRemoval,s=i.length;if(s&&!this.sendingMessagesCount){var t=this.subscriptions;if(s===t.length)return i.length=0,void(t.length=0);var e,n,o=[];for(e=0;e<s;++e)o.push(t.indexOf(i[e]));for(o.sort(function(i,s){return s-i}),e=0,n=o.length;e<n;++e)t.splice(o[e],1);i.length=0}}});