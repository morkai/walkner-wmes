define(function(t,n,e){"use strict";var i=t("./Subscriptions"),s=t("./Subscription"),r=t("./Sandbox");function o(){this.subscriptions=new i(this),this.nextSubscriptionId=0,this.listeners={subscribe:[],cancel:[],"new topic":[],"empty topic":[],message:[]}}e.exports=o,o.prototype.destroy=function(){this.subscriptions.destroy(),this.listeners={}},o.prototype.sandbox=function(){return new r(this)},o.prototype.publish=function(t,n,e){return void 0===e&&(e={}),this.emit("message",t,n,e),this.subscriptions.send(t,n,e),this},o.prototype.subscribe=function(t,n){var e=new s(this.getNextSubscriptionId(),t);return"function"==typeof n&&e.on("message",n),this.subscriptions.add(e),this.emit("subscribe",e),e},o.prototype.unsubscribe=function(t){return this.subscriptions.remove(t),this},o.prototype.count=function(){var t={};if(null===this.subscriptions)return t;return this.subscriptions.count("",t),t},o.prototype.on=function(t,n){var e=this.listeners[t];if("undefined"===typeof e)throw new Error("Unknown event: "+t);return e.push(n),this},o.prototype.off=function(t,n){var e=this.listeners[t];if("undefined"===typeof e)throw new Error("Unknown event: "+t);var i=e.indexOf(n);return-1!==i&&e.splice(i,1),this},o.prototype.emit=function(t,n){var e=this.listeners[t];if("undefined"===typeof e)throw new Error("Unknown event: "+t);if(!e.length)return this;var i=arguments.length;i>4&&(n=Array.prototype.slice.call(arguments)).shift();for(var s=0,r=e.length;s<r;++s){var o=e[s];switch(i){case 4:o(arguments[1],arguments[2],arguments[3]);break;case 3:o(arguments[1],arguments[2]);break;case 2:o(arguments[1]);break;default:o.apply(null,n)}}return this},o.prototype.getNextSubscriptionId=function(){return(this.nextSubscriptionId++).toString(36)}});