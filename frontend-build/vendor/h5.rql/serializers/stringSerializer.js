define(function(e,n,s){var r=e("../specialTerms"),t=e("../specialOperators"),u=e("../autoConvertedMap");function a(e,n,s,r,o){if(Array.isArray(s))!function(e,n,s){e.push("(");for(var r=0,t=s.length;r<t;++r)a(e,n,s[r],t),r<t-1&&e.push(",");e.push(")")}(e,n,s);else if(null!==s&&"object"==typeof s&&"string"==typeof s.name&&Array.isArray(s.args)){if(t.hasOwnProperty(s.name)&&s.args.length>1)return a(e,n,s.args[0],0),e.push(t[s.name]),void a(e,n,s.args[1],0);var i=",";"and"===s.name?i="&":"or"===s.name&&!0!==o&&(i="|"),function(e,n,s,r,t){var u=r.args.length;","===s?e.push(r.name,"("):1!==t&&e.push("(");for(var o=0;o<u;++o)a(e,n,r.args[o],u),o<u-1&&e.push(s);","!==s&&1===t||e.push(")")}(e,n,i,s,r)}else!function(e,n,s){switch(typeof s){case"undefined":e.push("undefined");break;case"boolean":e.push(s?"true":"false");break;case"number":e.push(s.toString(10));break;case"object":!function(e,n,s){if(null===s)e.push("null");else if(s instanceof Date)e.push("epoch:",s.getTime().toString());else if(s instanceof RegExp){var r=s.toString(),t=r.lastIndexOf("/");""===r.substr(t+1)&&(r=r.substr(1,t-1)),e.push("re:",n.encode(r))}else"function"==typeof s.convertToRqlValue?e.push(s.convertToRqlValue(n.encode)):e.push(n.encode(s.toString()))}(e,n,s);break;default:0===s.length?e.push("string:"):isNaN(+s)?u.hasOwnProperty(s)?e.push("string:",s):e.push(n.encode(s)):e.push("string:",s.toString())}}(e,n,s)}function o(e){return e=encodeURIComponent(e),/[\(\)]/.test(e)&&(e=e.replace(/\(/g,"%28").replace(/\)/g,"%29")),e}function i(e){return o(o(e))}n.fromQuery=function(e,n){var s=[],t={encode:n&&n.doubleEncode?i:o};return function(e,n){var s=Object.keys(n);0!==s.length&&e.push(n[s[0]]?"&select(":"&exclude(",s.join(","),")")}(s,e.fields),function(e,n){var s=Object.keys(n),r=s.length;if(0!==r){e.push("&sort(");for(var t=0;t<r;++t){var u=s[t];-1===n[u]&&e.push("-"),e.push(u),t<r-1&&e.push(",")}e.push(")")}}(s,e.sort),function(e,n,s){-1!==n&&(e.push("&limit(",n),0!==s&&e.push(",",s),e.push(")"))}(s,e.limit,e.skip),function(e,n,s){var t=s.args.length;if(0!==t)if("and"===s.name)for(var u=0;u<t;++u){var o=s.args[u];r.hasOwnProperty(o.name)||(e.push("&"),a(e,n,o,t,!0))}else e.push("&"),a(e,n,s,t,!0)}(s,t,e.selector),s.join("").substr(1)}});