define(["require","exports","module","../specialTerms","../specialOperators","../autoConvertedMap"],function(e,n,r){function s(e,n){var r=[],s={encode:n&&n.doubleEncode?g:l};return t(r,e.fields),u(r,e.sort),a(r,e.limit,e.skip),o(r,s,e.selector),r.join("").substr(1)}function t(e,n){var r=Object.keys(n);0!==r.length&&e.push(n[r[0]]?"&select(":"&exclude(",r.join(","),")")}function u(e,n){var r=Object.keys(n),s=r.length;if(0!==s){e.push("&sort(");for(var t=0;t<s;++t){var u=r[t];n[u]===-1&&e.push("-"),e.push(u),t<s-1&&e.push(",")}e.push(")")}}function a(e,n,r){n!==-1&&(e.push("&limit(",n),0!==r&&e.push(",",r),e.push(")"))}function o(e,n,r){var s=r.args.length;if(0!==s)if("and"===r.name)for(var t=0;t<s;++t){var u=r.args[t];d.hasOwnProperty(u.name)||(e.push("&"),i(e,n,u,s))}else e.push("&"),i(e,n,r,s,!0)}function i(e,n,r,s,t){if(Array.isArray(r))return void c(e,n,r);if(null===r||"object"!=typeof r||"string"!=typeof r.name||!Array.isArray(r.args))return void h(e,n,r);if(v.hasOwnProperty(r.name)&&r.args.length>1)return i(e,n,r.args[0],0),e.push(v[r.name]),void i(e,n,r.args[1],0);var u=",";"and"===r.name?u="&":"or"===r.name&&t!==!0&&(u="|"),p(e,n,u,r,s)}function p(e,n,r,s,t){var u=s.args.length;","===r?e.push(s.name,"("):1!==t&&e.push("(");for(var a=0;a<u;++a)i(e,n,s.args[a],u),a<u-1&&e.push(r);","!==r&&t===-1||e.push(")")}function c(e,n,r){e.push("(");for(var s=0,t=r.length;s<t;++s)i(e,n,r[s],t),s<t-1&&e.push(",");e.push(")")}function h(e,n,r){switch(typeof r){case"undefined":e.push("undefined");break;case"boolean":e.push(r?"true":"false");break;case"number":e.push(r.toString(10));break;case"object":f(e,n,r);break;default:0===r.length?e.push("string:"):isNaN(+r)?m.hasOwnProperty(r)?e.push("string:",r):e.push(n.encode(r)):e.push("string:",r.toString())}}function f(e,n,r){if(null===r)e.push("null");else if(r instanceof Date)e.push("epoch:",r.getTime().toString());else if(r instanceof RegExp){var s=r.toString(),t=s.lastIndexOf("/");""===s.substr(t+1)&&(s=s.substr(1,t-1)),e.push("re:",n.encode(s))}else"function"==typeof r.convertToRqlValue?e.push(r.convertToRqlValue(n.encode)):e.push(n.encode(r.toString()))}function l(e){return e=encodeURIComponent(e),/[\(\)]/.test(e)&&(e=e.replace(/\(/g,"%28").replace(/\)/g,"%29")),e}function g(e){return l(l(e))}var d=e("../specialTerms"),v=e("../specialOperators"),m=e("../autoConvertedMap");n.fromQuery=s});