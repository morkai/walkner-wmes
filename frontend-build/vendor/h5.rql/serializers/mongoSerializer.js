define(["require","exports","module"],function(e,t){function n(e,t){t instanceof n.Options||(t=new n.Options(t));var i={selector:r(t,e.selector)||{},fields:e.fields,sort:e.sort,limit:e.limit<1?0:e.limit,skip:e.skip};return t.compactAnd&&Array.isArray(i.selector.$and)&&1===Object.keys(i.selector).length&&(i.selector=d(i.selector.$and)),i}function r(e,t){if("object"!=typeof t||null===t||"string"!=typeof t.name||!Array.isArray(t.args))return null;switch(t.name){case"and":case"or":case"nor":return l(e,t.name,t.args);case"not":return u(e,t.args);case"eq":case"ne":case"gt":case"ge":case"lt":case"le":return c(e,t.name,t.args);case"in":case"nin":case"all":if(Array.isArray(t.args[1])&&t.args[1].length>0)return c(e,t.name,t.args);break;case"exists":if("boolean"==typeof t.args[1])return i(e,"exists",t.args[0],t.args[1]);break;case"type":if("number"==typeof t.args[1])return i(e,"type",t.args[0],t.args[1]);break;case"mod":return o(e,t.args);case"where":if(e.allowWhere&&"string"==typeof t.args[0])return{$where:t.args[0]};break;case"regex":return a(e,t.args);case"size":if("number"==typeof t.args[1])return i(e,"size",t.args[0],t.args[1]);break;case"elemMatch":return s(e,t.args)}return null}function i(e,t,n,r){if(Array.isArray(n)&&(n=n.join(".")),!e.isPropertyAllowed(n))return null;var i={};return i[n]={},i[n]["$"+t]=r,i}function o(e,t){return Array.isArray(t[1])&&2===t[1].length&&"number"==typeof t[1][0]&&"number"==typeof t[1][1]?i(e,"mod",t[0],t[1]):t.length>=3&&"number"==typeof t[1]&&"number"==typeof t[2]?i(e,"mod",t[0],[t[1],t[2]]):null}function a(e,t){if(t.length>=2&&("string"==typeof t[1]||t[1]instanceof RegExp)){var n=Array.isArray(t[0])?t[0].join("."):t[0];if(!e.isPropertyAllowed(n))return null;var r=i(e,"regex",n,t[1]);return t.length>=3&&"string"==typeof t[2]&&(r[n].$options=t[2]),r}return null}function s(e,t){if(t.length<2)return null;var n=Array.isArray(t[0])?t[0].join("."):t[0];if(!e.isPropertyAllowed(n))return null;t=[].concat(t),t.shift();var r=l(e,"and",t);if(null===r)return null;var o=d(r.$and);return i(e,"elemMatch",n,o)}function l(e,t,n){for(var i=[],o=0,a=n.length;a>o;++o){var s=r(e,n[o]);null!==s&&i.push(s)}if(0===i.length)return null;var l={};return l["$"+t]=i,l}function u(e,t){for(var n={},i=0,o=0,a=t.length;a>o;++o){var s=r(e,t[o]);null!==s&&Object.keys(s).forEach(function(e){if("$"!==e[0]){i+=1,n.hasOwnProperty(e)||(n[e]={});var t=s[e];if(!h(t,!1))return n[e].$ne=t,void 0;n[e].hasOwnProperty("$not")||(n[e].$not={}),Object.keys(t).forEach(function(r){"$"===r[0]&&(n[e].$not[r]=t[r])})}})}return 0===i?null:n}function c(e,t,n){if(n.length<2)return null;var r=Array.isArray(n[0])?n[0].join("."):n[0];if(!e.isPropertyAllowed(r))return null;var i=n[1],o={};return"eq"===t?(o[r]=i,o):("le"===t?t="lte":"ge"===t&&(t="gte"),o[r]={},o[r]["$"+t]=i,o)}function d(e){for(var t={},n=0,r=e.length;r>n;++n)p(t,e[n]);return t}function p(e,t){Object.keys(t).forEach(function(n){"undefined"==typeof e[n]&&(e[n]={}),f(e,n,t[n])})}function f(e,t,n){if(h(e[t],!0))if(h(n,!1))for(var r in n)n.hasOwnProperty(r)&&(e[t][r]=n[r]);else e[t]=n}function h(e,t){if("object"!=typeof e||null===e)return!1;var n=Object.keys(e);if(0===n.length)return t;for(var r=0,i=n.length;i>r;++r)if("$"===n[r][0])return!0;return!1}t.fromQuery=n,n.Options=function(e){("object"!=typeof e||null===e)&&(e={}),this.compactAnd=!e.hasOwnProperty("compactAnd")||e.compactAnd===!0,this.allowWhere=e.allowWhere===!0,this.isPropertyAllowed="function"==typeof e.isPropertyAllowed?e.isPropertyAllowed:this.createPropertyFilter(e)},n.Options.prototype.createPropertyFilter=function(e){if(Array.isArray(e.whitelist)){var t=e.whitelist;return function(e){return-1!==t.indexOf(e)}}if(Array.isArray(e.blacklist)){var n=e.blacklist;return function(e){return-1===n.indexOf(e)}}return function(){return!0}}});