define(["require","exports","module"],function(r,e){function n(r,e){e instanceof n.Options||(e=new n.Options(e));var a={selector:t(e,r.selector)||{},fields:r.fields,sort:r.sort,limit:r.limit<1?0:r.limit,skip:r.skip};return e.compactAnd&&Array.isArray(a.selector.$and)&&1===Object.keys(a.selector).length&&(a.selector=c(a.selector.$and)),a}function t(r,e){if("object"!=typeof e||null===e||"string"!=typeof e.name||!Array.isArray(e.args))return null;switch(e.name){case"and":case"or":case"nor":return l(r,e.name,e.args);case"not":return u(r,e.args);case"eq":case"ne":case"gt":case"ge":case"lt":case"le":return f(r,e.name,e.args);case"in":case"nin":case"all":if(Array.isArray(e.args[1])&&e.args[1].length>0)return f(r,e.name,e.args);break;case"exists":if("boolean"==typeof e.args[1])return a(r,"exists",e.args[0],e.args[1]);break;case"type":if("number"==typeof e.args[1])return a(r,"type",e.args[0],e.args[1]);break;case"mod":return i(r,e.args);case"where":if(r.allowWhere&&"string"==typeof e.args[0])return{$where:e.args[0]};break;case"regex":return o(r,e.args);case"size":if("number"==typeof e.args[1])return a(r,"size",e.args[0],e.args[1]);break;case"elemMatch":return s(r,e.args)}return null}function a(r,e,n,t){if(Array.isArray(n)&&(n=n.join(".")),!r.isPropertyAllowed(n))return null;var a={};return a[n]={},a[n]["$"+e]=t,a}function i(r,e){return Array.isArray(e[1])&&2===e[1].length&&"number"==typeof e[1][0]&&"number"==typeof e[1][1]?a(r,"mod",e[0],e[1]):e.length>=3&&"number"==typeof e[1]&&"number"==typeof e[2]?a(r,"mod",e[0],[e[1],e[2]]):null}function o(r,e){if(e.length>=2&&("string"==typeof e[1]||e[1]instanceof RegExp)){var n=Array.isArray(e[0])?e[0].join("."):e[0];if(!r.isPropertyAllowed(n))return null;var t=a(r,"regex",n,e[1]);return e.length>=3&&"string"==typeof e[2]&&(t[n].$options=e[2]),t}return null}function s(r,e){if(e.length<2)return null;var n=Array.isArray(e[0])?e[0].join("."):e[0];if(!r.isPropertyAllowed(n))return null;e=[].concat(e),e.shift();var t=l(r,"and",e);if(null===t)return null;var i=c(t.$and);return a(r,"elemMatch",n,i)}function l(r,e,n){for(var a=[],i=0,o=n.length;o>i;++i){var s=t(r,n[i]);null!==s&&a.push(s)}if(0===a.length)return null;var l={};return l["$"+e]=a,l}function u(r,e){for(var n={},a=0,i=0,o=e.length;o>i;++i){var s=t(r,e[i]);null!==s&&Object.keys(s).forEach(function(r){if("$"!==r[0]){a+=1,n.hasOwnProperty(r)||(n[r]={});var e=s[r];if(!g(e,!1))return void(n[r].$ne=e);n[r].hasOwnProperty("$not")||(n[r].$not={}),Object.keys(e).forEach(function(t){"$"===t[0]&&(n[r].$not[t]=e[t])})}})}return 0===a?null:n}function f(r,e,n){if(n.length<2)return null;var t=Array.isArray(n[0])?n[0].join("."):n[0];if(!r.isPropertyAllowed(t))return null;var a=n[1],i={};return"eq"===e?(i[t]=a,i):("le"===e?e="lte":"ge"===e&&(e="gte"),i[t]={},i[t]["$"+e]=a,i)}function c(r){for(var e={},n=0,t=r.length;t>n;++n)y(e,r[n]);return e}function y(r,e){Object.keys(e).forEach(function(n){"undefined"==typeof r[n]&&(r[n]={}),p(r,n,e[n])})}function p(r,e,n){if(g(r[e],!0))if(g(n,!1))for(var t in n)n.hasOwnProperty(t)&&(r[e][t]=n[t]);else r[e]=n}function g(r,e){if("object"!=typeof r||null===r)return!1;var n=Object.keys(r);if(0===n.length)return e;for(var t=0,a=n.length;a>t;++t)if("$"===n[t][0])return!0;return!1}e.fromQuery=n,n.Options=function(r){("object"!=typeof r||null===r)&&(r={}),this.compactAnd=!r.hasOwnProperty("compactAnd")||r.compactAnd===!0,this.allowWhere=r.allowWhere===!0,this.isPropertyAllowed="function"==typeof r.isPropertyAllowed?r.isPropertyAllowed:this.createPropertyFilter(r)},n.Options.prototype.createPropertyFilter=function(r){if(Array.isArray(r.whitelist)){var e=r.whitelist;return function(r){return-1!==e.indexOf(r)}}if(Array.isArray(r.blacklist)){var n=r.blacklist;return function(r){return-1===n.indexOf(r)}}return function(){return!0}}});