define(function(e,t,n){"use strict";var r=e("./Term"),a=e("./valueConverters");n.exports=u;var o=/^[\+\*\$\-:\w%\._!'~]$/,s=/[\+\*\$\-:\w%\._!'~]*\/[\+\*\$\-:\w%\._!'~\/]*/g,l=new RegExp("(\\([\\+\\*\\$\\-:\\w%\\._,]+\\)|[\\+\\*\\$\\-:\\w%\\._]*|)([<>!]?=(?:[\\w]*=)?|>|<)(\\([\\+\\*\\$\\-:\\w%\\._,!'~]*\\)|[\\+\\*\\$\\-:\\w%\\._!'~]*|)","g"),i={"=":"eq","==":"eq",">":"gt",">=":"ge","<":"lt","<=":"le","!=":"ne"};function u(e){this.options=e instanceof u.Options?e:new u.Options(e)}u.Options=function(e){"object"==typeof e&&null!==e||(e={}),this.jsonQueryCompatible=!0===e.jsonQueryCompatible,this.fiqlCompatible=!e.hasOwnProperty("fiqlCompatible")||!0===e.fiqlCompatible,this.allowSlashedArrays=!0===e.allowSlashedArrays,this.allowEmptyValues=!0===e.allowEmptyValues,this.defaultValueConverter="function"==typeof e.defaultValueConverter?e.defaultValueConverter:a.default,this.specialTerms=Array.isArray(e.specialTerms)?e.specialTerms:[],this.emptyValue=e.hasOwnProperty("emptyValue")?e.emptyValue:""},u.prototype.parse=function(e,t){var n="object"==typeof t&&null!==t,a=this.options.specialTerms,s=null,l=new r,i=[],u=!0;this.options.jsonQueryCompatible&&(e=this.makeJsonQueryCompatible(e)),this.options.allowSlashedArrays&&(e=this.convertSlashedArrays(e)),this.options.fiqlCompatible&&(e=this.convertFiql(e));for(var p=0,h=e.length;p<h;++p){var c=e[p];switch(c){case"(":i.push(l),l=new r(s),n&&null!==s&&-1!==a.indexOf(s)&&(delete t[s],t[s]=l.args),s=null,u=!0;break;case",":if(!1===u){if(!this.options.allowEmptyValues)throw new Error("Empty value at position "+p+" is not allowed.");s=this.options.emptyValue}null!==s&&(l.args.push(this.convertStringToValue(s)),s=null),u=!1;break;case")":null!==s&&(l.args.push(this.convertStringToValue(s)),s=null);var f=null===l.name?l.args:l;(l=i.pop()).args.push(f),u=!0;break;case"&":case"|":var m="&"===c?"and":"or";if(null!==l.name&&l.name!==m)throw new Error("Can not mix conjunctions within a group at position "+p+", use parenthesises around each set of the same conjunctions (& and |)");l.name="&"===c?"and":"or",null!==s&&(l.args.push(this.convertStringToValue(s)),s=null);break;default:if(!o.test(c))throw new Error("Invalid character at position "+p+": '"+c+"' ("+c.charCodeAt(0)+")");null===s?s=c:s+=c,u=!0}}return null!==s&&l.args.push(this.convertStringToValue(s)),null===l.name&&(l.name="and"),"and"===l.name&&1===l.args.length&&l.args[0]instanceof r&&"and"===l.args[0].name&&(l=l.args[0]),l},u.prototype.makeJsonQueryCompatible=function(e){return this.options.jsonQueryCompatible&&(e=e.replace(/%3C=/g,"=le=").replace(/%3E=/g,"=ge=").replace(/%3C/g,"=lt=").replace(/%3E/g,"=gt=")),e},u.prototype.convertSlashedArrays=function(e){return-1!==e.indexOf("/")?e.replace(s,function(e){return"("+e.replace(/\//g,",")+")"}):e},u.prototype.convertFiql=function(e){return e.replace(l,function(e,t,n,r){return(n=n.length<3?i[n]:n.substring(1,n.length-1))+"("+t+","+r+")"})},u.prototype.convertStringToValue=function(e){var t,n=e.indexOf(":");if(-1!==n){var r=e.substr(0,n);if(void 0===(t=a[r]))throw new Error("Unknown value converter: "+r);e=e.substr(n+1)}else t=this.options.defaultValueConverter;return t(e,this)}});