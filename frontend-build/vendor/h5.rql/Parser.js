define(["require","exports","module","./Term","./valueConverters"],function(e,t,n){"use strict";function r(e){this.options=e instanceof r.Options?e:new r.Options(e)}var a=e("./Term"),o=e("./valueConverters");n.exports=r;var s=/^[\+\*\$\-:\w%\._!'~]$/,l=/[\+\*\$\-:\w%\._!'~]*\/[\+\*\$\-:\w%\._!'~\/]*/g,i=new RegExp("(\\([\\+\\*\\$\\-:\\w%\\._,]+\\)|[\\+\\*\\$\\-:\\w%\\._]*|)([<>!]?=(?:[\\w]*=)?|>|<)(\\([\\+\\*\\$\\-:\\w%\\._,!'~]*\\)|[\\+\\*\\$\\-:\\w%\\._!'~]*|)","g"),u={"=":"eq","==":"eq",">":"gt",">=":"ge","<":"lt","<=":"le","!=":"ne"};r.Options=function(e){("object"!=typeof e||null===e)&&(e={}),this.jsonQueryCompatible=e.jsonQueryCompatible===!0,this.fiqlCompatible=!e.hasOwnProperty("fiqlCompatible")||e.fiqlCompatible===!0,this.allowSlashedArrays=e.allowSlashedArrays===!0,this.allowEmptyValues=e.allowEmptyValues===!0,this.defaultValueConverter="function"==typeof e.defaultValueConverter?e.defaultValueConverter:o["default"],this.specialTerms=Array.isArray(e.specialTerms)?e.specialTerms:[],this.emptyValue=e.hasOwnProperty("emptyValue")?e.emptyValue:""},r.prototype.parse=function(e,t){var n="object"==typeof t&&null!==t,r=this.options.specialTerms,o=null,l=new a,i=[],u=!0;this.options.jsonQueryCompatible&&(e=this.makeJsonQueryCompatible(e)),this.options.allowSlashedArrays&&(e=this.convertSlashedArrays(e)),this.options.fiqlCompatible&&(e=this.convertFiql(e));for(var p=0,h=e.length;h>p;++p){var c=e[p];switch(c){case"(":i.push(l),l=new a(o),n&&null!==o&&-1!==r.indexOf(o)&&(delete t[o],t[o]=l.args),o=null,u=!0;break;case",":if(u===!1){if(!this.options.allowEmptyValues)throw new Error("Empty value at position "+p+" is not allowed.");o=this.options.emptyValue}null!==o&&(l.args.push(this.convertStringToValue(o)),o=null),u=!1;break;case")":null!==o&&(l.args.push(this.convertStringToValue(o)),o=null);var f=null===l.name?l.args:l;l=i.pop(),l.args.push(f),u=!0;break;case"&":case"|":var m="&"===c?"and":"or";if(null!==l.name&&l.name!==m)throw new Error("Can not mix conjunctions within a group at position "+p+", use parenthesises around each set of the same conjunctions (& and |)");l.name="&"===c?"and":"or",null!==o&&(l.args.push(this.convertStringToValue(o)),o=null);break;default:if(!s.test(c))throw new Error("Invalid character at position "+p+": '"+c+"' ("+c.charCodeAt(0)+")");null===o?o=c:o+=c,u=!0}}return null!==o&&l.args.push(this.convertStringToValue(o)),null===l.name&&(l.name="and"),"and"===l.name&&1===l.args.length&&l.args[0]instanceof a&&"and"===l.args[0].name&&(l=l.args[0]),l},r.prototype.makeJsonQueryCompatible=function(e){return this.options.jsonQueryCompatible&&(e=e.replace(/%3C=/g,"=le=").replace(/%3E=/g,"=ge=").replace(/%3C/g,"=lt=").replace(/%3E/g,"=gt=")),e},r.prototype.convertSlashedArrays=function(e){return-1!==e.indexOf("/")?e.replace(l,function(e){return"("+e.replace(/\//g,",")+")"}):e},r.prototype.convertFiql=function(e){return e.replace(i,function(e,t,n,r){return n=n.length<3?u[n]:n.substring(1,n.length-1),n+"("+t+","+r+")"})},r.prototype.convertStringToValue=function(e){var t,n=e.indexOf(":");if(-1!==n){var r=e.substr(0,n);if(t=o[r],"undefined"==typeof t)throw new Error("Unknown value converter: "+r);e=e.substr(n+1)}else t=this.options.defaultValueConverter;return t(e,this)}});