define(["underscore","jquery","getCaretCoordinates","app/user","app/socket","app/core/View","app/planning/util/contextMenu","app/wmes-compRel-entries/templates/details/chat","app/wmes-compRel-entries/templates/details/chatMessage"],function(t,e,i,s,n,a,l,o,h){"use strict";return a.extend({template:o,events:{"keydown #-send":function(t){var e=t.originalEvent.key,i="Enter"===e,s=i||" "===e,n=""===t.target.value.trim();return s&&n?(this.toggleMultiLine(),!1):this.multiLine||!i||!t.shiftKey||n?this.multiLine&&i&&t.shiftKey?(this.send(),!1):this.multiLine||!i||t.shiftKey?void 0:(this.send(),!1):void this.toggleMultiLine(!0)},"input #-send":function(){this.resizeSend()},"click #-new":function(){var t=this.$id("messages");this.$id("new").addClass("hidden"),t.animate({scrollTop:t[0].scrollHeight},"fast")},"click .compRel-chat-attachment":function(t){this.model.trigger("focusAttachment",t.currentTarget.dataset.attachmentId)},"click #-submit":function(){this.send()}},initialize:function(){this.chatScrollTop=-1,this.multiLine=!1,this.listenTo(this.model,"change:changes",this.onChange)},getTemplateData:function(){return{chat:this.model.serializeChat(),renderMessage:this.renderPartialHtml.bind(this,h)}},afterRender:function(){var t=this.$id("messages");t.length&&(t[0].scrollTop=-1===this.chatScrollTop?9999999:this.chatScrollTop,t.on("scroll",this.onScroll.bind(this))),this.toggleMultiLine(this.multiLine)},toggleMultiLine:function(t){this.multiLine="boolean"==typeof t?t:!this.multiLine,this.$el.toggleClass("compRel-chat-multiLine",this.multiLine),this.multiLine&&(this.$id("submit")[0].style.marginLeft=this.$id("submit").outerWidth()/2*-1+"px")},send:function(){var t=this.$id("send"),e=t.val().trim();t.val(""),this.toggleMultiLine(!1),this.resizeSend(),this.model.handleChange({date:new Date,user:s.getInfo(),data:{},comment:e}),this.model.update({comment:e})},onChange:function(){if(this.isRendered()){var e=t.last(this.model.get("changes"));e&&e.user&&this.handleChange(e)}},handleChange:function(t){t.data.attachments&&!t.data.attachments[1]&&this.removeAttachments(t.data.attachments[0]);var i=this.model.serializeChatMessage(t);if(i.lines.length){var n=this.$id("messages"),a=this.$(n[0].lastElementChild),l=this.isScrolledToBottom();if(a[0].dataset.userId===t.user.id){var o=a.find(".compRel-chat-lines");i.lines.forEach(function(t){e('<div class="compRel-chat-line"></div>').attr("title",t.time).html(t.text).appendTo(o)})}else this.renderPartial(h,{message:i}).appendTo(n);l?n[0].scrollTop=n[0].scrollHeight:s.data._id!==t.user.id&&this.$id("new").removeClass("hidden")}},removeAttachments:function(t){var e=this;t.forEach(function(t){e.$('.compRel-chat-attachment[data-attachment-id="'+t._id+'"]').css("text-decoration","line-through")})},isScrolledToBottom:function(){var t=this.$id("messages")[0];return Math.abs(t.scrollHeight-t.scrollTop-t.clientHeight)<5},resizeSend:function(){var t=this.$id("messages"),e=this.$id("send"),i=e[0].offsetHeight,s=parseInt(e.css("minHeight"),10);e.outerHeight(s);var n=!1,a=Math.max(s,e[0].scrollHeight);a>215&&(n=!0,a=215);var l=a-i;t.css("height",563-a),e.outerHeight(a).toggleClass("compRel-chat-send-scroll",n),l<0&&this.isScrolledToBottom()||(t[0].scrollTop+=a-i)},onScroll:function(t){this.chatScrollTop=t.target.scrollTop,this.isScrolledToBottom()&&this.$id("new").addClass("hidden")}})});