define(["underscore","jquery","getCaretCoordinates","app/user","app/socket","app/core/View","app/planning/util/contextMenu","app/wmes-fap-entries/views/NavbarView","app/wmes-compRel-entries/templates/details/chat","app/wmes-compRel-entries/templates/details/chatMessage"],function(e,t,i,s,a,n,o,r,h,l){"use strict";return n.extend({template:h,events:{"keydown #-send":function(e){var t=e.originalEvent.key,i="Enter"===t,s=i||" "===t,a=""===e.target.value.trim();return s&&a?(this.toggleMultiLine(),!1):this.multiLine||!i||!e.shiftKey||a?this.multiLine&&i&&e.shiftKey?(this.send(),!1):this.multiLine||!i||e.shiftKey?void 0:(this.send(),!1):void this.toggleMultiLine(!0)},"input #-send":function(){this.resizeSend()},"click #-new":function(){var e=this.$id("messages");this.$id("new").addClass("hidden"),e.animate({scrollTop:e[0].scrollHeight},"fast")},"click .compRel-chat-attachment":function(e){this.model.trigger("focusAttachment",e.currentTarget.dataset.attachmentId)},"click #-submit":function(){this.send()},"mouseup .autolink":function(e){var i=e.currentTarget.dataset.id;if(1===e.button)switch(e.currentTarget.dataset.type){case"order":window.open("/#orders/"+i);break;case"product":window.open("/r/nc12/"+i);break;case"document":s.isAllowedTo("DOCUMENTS:VIEW")?window.open("/#orderDocuments/tree?file="+i):window.open("/orderDocuments/"+i)}else r.appNavbarView?this.showAutolinkMenu(e):t(".navbar-search-phrase").first().val(i).focus();return!1}},initialize:function(){this.chatScrollTop=-1,this.multiLine=!1,this.listenTo(this.model,"change:changes",this.onChange)},getTemplateData:function(){return{chat:this.model.serializeChat(),renderMessage:this.renderPartialHtml.bind(this,l)}},afterRender:function(){var e=this.$id("messages");e.length&&(e[0].scrollTop=-1===this.chatScrollTop?9999999:this.chatScrollTop,e.on("scroll",this.onScroll.bind(this))),this.toggleMultiLine(this.multiLine)},toggleMultiLine:function(e){this.multiLine="boolean"==typeof e?e:!this.multiLine,this.$el.toggleClass("compRel-chat-multiLine",this.multiLine),this.multiLine&&(this.$id("submit")[0].style.marginLeft=this.$id("submit").outerWidth()/2*-1+"px")},send:function(){var e=this.$id("send"),t=e.val().trim();e.val(""),this.toggleMultiLine(!1),this.resizeSend(),this.model.handleChange({date:new Date,user:s.getInfo(),data:{},comment:t}),this.model.update({comment:t})},onChange:function(){if(this.isRendered()){var t=e.last(this.model.get("changes"));t&&t.user&&this.handleChange(t)}},handleChange:function(e){e.data.attachments&&!e.data.attachments[1]&&this.removeAttachments(e.data.attachments[0]);var i=this.model.serializeChatMessage(e);if(i.lines.length){var a=this.$id("messages"),n=this.$(a[0].lastElementChild),o=this.isScrolledToBottom();if(n[0].dataset.userId===e.user.id){var r=n.find(".compRel-chat-lines");i.lines.forEach(function(e){t('<div class="compRel-chat-line"></div>').attr("title",e.time).html(e.text).appendTo(r)})}else this.renderPartial(l,{message:i}).appendTo(a);o?a[0].scrollTop=a[0].scrollHeight:s.data._id!==e.user.id&&this.$id("new").removeClass("hidden")}},removeAttachments:function(e){var t=this;e.forEach(function(e){t.$('.compRel-chat-attachment[data-attachment-id="'+e._id+'"]').css("text-decoration","line-through")})},isScrolledToBottom:function(){var e=this.$id("messages")[0];return Math.abs(e.scrollHeight-e.scrollTop-e.clientHeight)<5},resizeSend:function(){var e=this.$id("messages"),t=this.$id("send"),i=t[0].offsetHeight,s=parseInt(t.css("minHeight"),10);t.outerHeight(s);var a=!1,n=Math.max(s,t[0].scrollHeight);n>215&&(a=!0,n=215);var o=n-i;e.css("height",563-n),t.outerHeight(n).toggleClass("compRel-chat-send-scroll",a),o<0&&this.isScrolledToBottom()||(e[0].scrollTop+=n-i)},onScroll:function(e){this.chatScrollTop=e.target.scrollTop,this.isScrolledToBottom()&&this.$id("new").addClass("hidden")},showAutolinkMenu:function(e){if(r.appNavbarView){for(var t=r.appNavbarView.renderSearchResults(r.appNavbarView.parseSearchPhrase(e.currentTarget.dataset.id));t.length;){var i=t.children().last();if(!i.hasClass("dropdown-header")&&!i.hasClass("divider"))break;i.remove()}var s=[],a=0;t.children().each(function(){a>1||(this.classList.contains("navbar-search-result")?s.push({label:this.textContent,href:this.querySelector("a").href,handler:function(){window.open(this.href)}}):(a+=1)>1||(this.classList.contains("dropdown-header")?s.push(this.textContent):this.classList.contains("divider")&&s.push("-")))}),o.show(this,e.pageY,e.pageX,s)}}})});