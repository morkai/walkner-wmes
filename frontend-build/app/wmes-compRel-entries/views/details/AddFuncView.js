define(["app/viewport","app/core/View","app/users/util/setUpUserSelect2","app/wmes-compRel-entries/dictionaries","app/wmes-compRel-entries/templates/details/addFunc"],function(e,t,n,i,s){"use strict";return t.extend({template:s,events:{submit:function(){return this.submit(),!1},"change #-func":function(){var e=this.$id("func").val();this.$id("users").select2("data",[]),e.length&&this.loadFuncUsers()}},initialize:function(){this.listenTo(this.model,"change:funcs",this.setUpFuncSelect2)},afterRender:function(){this.setUpFuncSelect2(),n(this.$id("users"),{multiple:!0,allowClear:!0,noPersonnelId:!0})},setUpFuncSelect2:function(){var e=this,t=e.$id("func").val(),n={};i.funcs.forEach(function(t){e.model.getFunc(t.id)||(n[t.id]={id:t.id,text:t.getLabel()})}),n[t]||e.$id("func").val(""),e.$id("func").select2({width:"100%",data:Object.values(n)})},onDialogShown:function(){this.$id("func").focus()},submit:function(){var t=this;e.msg.saving(),t.$(".btn-primary").prop("disabled",!0);var i=t.ajax({method:"POST",url:"/compRel/entries/"+t.model.id+";add-func",data:JSON.stringify({func:t.$id("func").val(),users:n.getUserInfo(t.$id("users"))})});i.fail(function(){e.msg.savingFailed(),t.$(".btn-primary").prop("disabled",!1)}),i.done(function(){e.msg.saved(),e.closeDialog()})},loadFuncUsers:function(){var t=this;e.msg.loading();var n=t.ajax({url:"/compRel/entries;resolve-users",data:{funcs:t.$id("func").val(),mrps:t.$id("mrps").val()}});n.done(function(e){Object.keys(e).forEach(function(n){t.updateFuncUsers(e[n])})}),n.always(function(){e.msg.loaded()})},updateFuncUsers:function(e){e.sort(function(e,t){return e.label.localeCompare(t.label,void 0,{ignorePunctuation:!0})}),this.$id("users").select2("data",e.map(function(e){return{id:e.id,text:e.label}}))}})});