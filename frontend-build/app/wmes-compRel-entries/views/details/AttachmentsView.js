define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/uuid","app/planning/util/contextMenu","app/wmes-compRel-entries/Entry","app/wmes-compRel-entries/templates/details/attachments","app/wmes-compRel-entries/templates/details/attachment"],function(e,t,a,n,i,o,d,l,s,r){"use strict";return i.extend({template:s,events:{'mouseenter .compRel-attachment[data-preview="1"]':function(e){this.showPreview(e.currentTarget.dataset.attachmentId)},"mouseleave .compRel-attachment":function(){this.hidePreview()},mouseleave:function(){this.hidePreview()},'click [data-action="removeUpload"]':function(e){var t=this.$(e.target).closest(".compRel-attachment")[0].dataset.attachmentId,a=this.model;return a.uploading&&a.uploading.upload._id===t?(a.uploading.abort(),a.uploading=null):(a.uploadQueue=a.uploadQueue.filter(function(e){return e._id!==t}),a.uploadedFiles=a.uploadedFiles.filter(function(e){return e._id!==t})),this.removeAttachment(t),!1},'click [data-action="showMenu"]':function(e){var t=this.$(e.target).closest(".compRel-attachment"),n=this.findAttachment(t[0].dataset.attachmentId),i=[{icon:"fa-edit",label:this.t("attachments:menu:rename"),handler:this.handleRenameAttachment.bind(this,n._id)}];return(a.isAllowedTo("FAP:MANAGE")||n.user&&n.user.id===a.data._id)&&i.push({icon:"fa-times",label:this.t("attachments:menu:remove"),handler:this.handleRemoveAttachment.bind(this,n._id)}),d.show(this,e.pageY,e.pageX,i),!1},"click #-upload":function(){this.$id("files").click()},"change #-files":function(e){e.target.files.length&&this.upload(e.target.files)},"submit #-editor":function(){var e=this.$id("editor"),t=e[0].dataset.id,a=this.model.get("attachments").find(function(e){return e._id===t}),n=JSON.parse(JSON.stringify(a));n.name=e.find("input").val().trim();var i=a.name.split(".").pop();return new RegExp("\\."+i+"$","i").test(n.name)||(n.name+="."+i),n.name!==a.name&&this.model.change("attachments",[n],[a]),this.hideEditor(),!1}},initialize:function(){var a=this,n=a.model;n.uploadQueue||(n.uploadQueue=[],n.uploading=null,n.uploadedFiles=[]),a.once("afterRender",function(){a.listenTo(n,"focusAttachment",a.focusAttachment),a.listenTo(n,"change:attachments",e.debounce(a.renderAttachments.bind(a),1))}),t(window).on("keydown."+a.idPrefix,a.onKeyDown.bind(a)).on("paste."+a.idPrefix,a.onPaste.bind(a))},destroy:function(){t(document.body).off("."+this.idPrefix),t(window).off("."+this.idPrefix)},afterRender:function(){this.$(".panel-body").on("scroll",this.hideEditor.bind(this)),this.$id("upload").toggleClass("hidden",!1),this.setUpDnd(),this.renderAttachments()},setUpDnd:function(){var e=this,a="drag dragstart dragend dragover dragenter dragleave drop".split(" ").map(function(t){return t+"."+e.idPrefix}).join(" ");t(document.body).on(a,e.onDrag.bind(e)).on("drop."+e.idPrefix,e.onDrop.bind(e))},renderAttachments:function(){var e=this,t=e.$id("attachments");t.find(".compRel-attachment").remove(),(e.model.get("attachments")||[]).forEach(function(a){e.renderAttachment(e.model.serializeAttachment(a),!0).appendTo(t)}),e.model.uploadedFiles.forEach(function(a){e.renderAttachment(a,!0).insertBefore(t)}),e.model.uploading&&e.renderAttachment(e.model.uploading.upload,!1).insertBefore(t),e.model.uploadQueue.forEach(function(a){e.renderAttachment(a,!1).insertBefore(t)}),e.attachmentToRename&&(e.handleRenameAttachment(e.attachmentToRename),e.attachmentToRename=null)},renderAttachment:function(e,t){return this.renderPartial(r,{entryId:this.model.id,uploaded:t,attachment:e})},findAttachment:function(t){var a=this.model,n=e.findWhere(a.get("attachments"),{_id:t});if(n)return n;if(a.uploading&&a.uploading.upload._id===t)return a.uploading.upload;for(var i=0;i<a.uploadedFiles.length;++i)if(a.uploadedFiles[i]._id===t)return a.uploadedFiles[i];for(var o=0;o<a.uploadQueue.length;++o)if(a.uploadQueue[o]._id===t)return a.uploadQueue[o];return null},showPreview:function(e){var t=this.findAttachment(e);if(t){var a=this.$id("preview").removeClass("hidden").attr("data-attachment-id",e);a.find("span").text(t.name),a.find("img").prop("src",t.src||"/compRel/entries/"+this.model.id+"/attachments/"+e)}},hidePreview:function(e){e&&this.$id("preview").attr("data-attachment-id")!==e||this.$id("preview").addClass("hidden")},focusAttachment:function(e){var t=this.$('.compRel-attachment[data-attachment-id="'+e+'"]');t.length&&(t[0].scrollIntoViewIfNeeded?t[0].scrollIntoViewIfNeeded():t[0].scrollIntoView(),this.$(".highlight").removeClass("highlight"),clearTimeout(this.timers.highlight),t.addClass("highlight"),this.timers.highlight=setTimeout(function(){t.removeClass("highlight")},1100),"1"===t[0].dataset.preview&&this.showPreview(e))},onKeyDown:function(e){"Escape"===e.originalEvent.key&&(this.hidePreview(),this.hideEditor())},onPaste:function(e){if(!n.currentDialog){var t=e.originalEvent.clipboardData;t&&t.files&&t.files.length&&t.items.length===t.files.length&&this.upload(t.files,!0)}},onDrag:function(e){e.preventDefault(),e.stopPropagation()},onDrop:function(e){var t=e.originalEvent.dataTransfer;return t&&t.files&&t.files.length&&this.upload(t.files,!1),!1},upload:function(t,a){var i=this;if(l.can.uploadAttachments(i.model)){var d=i.model,s={};(d.get("attachments")||[]).forEach(function(e){s[e.name+e.size]=!0}),d.uploading&&(s[d.uploading.upload.name+d.uploading.upload.file.size]=!0),d.uploadQueue.forEach(function(e){s[e.name+e.file.size]=!0}),d.uploadedFiles.forEach(function(e){s[e.name+e.file.size]=!0});var r=Array.prototype.slice.call(t).filter(function(e){return!s[e.name+e.size]&&(s[e.name+e.size]=!0,!0)});if(r.length){if((d.uploading?1:0)+d.uploadQueue.length+d.uploadedFiles.length+r.length>5)return n.msg.show({type:"warning",time:2500,text:i.t("upload:tooMany",{max:5})}),!1;var h=i.$id("attachments");r.forEach(function(t){d.uploadQueue.push({_id:o(),type:t.type,name:t.name,file:t,src:0===t.type.indexOf("image/")?URL.createObjectURL(t):null,rename:a&&1===r.length&&0===t.type.indexOf("image/")}),i.renderAttachment(i.model.serializeAttachment(e.last(d.uploadQueue)),!1).appendTo(h)}),d.uploading||i.uploadNext()}}else n.msg.show({type:"warning",time:2500,text:i.t("upload:auth")})},uploadNext:function(){var e=this,t=e.model,a=t.uploadQueue.shift();if(!a)return e.saveUploads();e.$id("submit").prop("disabled",!0);var i=e.$id("attachments"),o=new FormData;o.append("file",a.file),t.uploading=e.ajax({type:"POST",url:"/compRel/entries;upload",data:o,processData:!1,contentType:!1}),t.uploading.upload=a,t.uploading.fail(function(){e.removeAttachment(a._id),"abort"!==t.uploading.statusText&&n.msg.show({type:"error",time:2500,text:e.t("upload:failure",{file:a.file.name})})}),t.uploading.done(function(e){i.find('[data-attachment-id="'+a._id+'"]').find(".fa-spin").removeClass("fa-spin"),a.hash=e,t.uploadedFiles.push(a)}),t.uploading.always(function(){t.uploading=null,e.uploadNext()})},removeAttachment:function(e){this.hidePreview(e),this.$id("attachments").find('[data-attachment-id="'+e+'"]').remove()},saveUploads:function(){var e=this;if(e.model.uploadedFiles.length){var t=(new Date).toISOString(),n=a.getInfo(),i=e.model.uploadedFiles.map(function(a){return a.rename&&(e.attachmentToRename=a.hash),{_id:a.hash,date:t,user:n,type:a.file.type,size:a.file.size,name:a.name}});e.model.uploadedFiles=[],e.model.change("attachments",i,null)}},showEditor:function(e){var t=this.model.get("attachments").find(function(t){return t._id===e});if(t){var a=this.$('[data-attachment-id="'+e+'"]');a[0].scrollIntoView(),this.$(".compRel-attachments-editor").attr("data-id",e).css({top:a.position().top+"px"}).removeClass("hidden").find("input").val(t.name).focus()}},hideEditor:function(){this.$(".compRel-attachments-editor").addClass("hidden")},handleRenameAttachment:function(e){this.showEditor(e)},handleRemoveAttachment:function(e){var t=[this.findAttachment(e)];this.model.handleChange({date:new Date,user:a.getInfo(),data:{attachments:[t,null]},comment:""}),this.model.update({attachments:t})}})});