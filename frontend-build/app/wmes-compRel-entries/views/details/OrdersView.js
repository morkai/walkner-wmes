define(["underscore","app/viewport","app/core/View","app/core/views/DialogView","app/core/util/pageActions","app/data/localStorage","app/wmes-compRel-entries/Entry","./ReleaseOrderView","./RemoveOrdersView","app/wmes-compRel-entries/templates/details/orders","app/wmes-compRel-entries/templates/details/removeOrder"],function(e,t,i,n,a,o,r,l,s,d,c){"use strict";return i.extend({template:d,events:{'click .btn[data-action="invalidOnly"]':function(e){e.currentTarget.classList.toggle("active"),this.invalidOnly=!this.invalidOnly,this.invalidOnly?o.setItem("WMES_COMP_REL_INVALID_ONLY","1"):o.removeItem("WMES_COMP_REL_INVALID_ONLY"),this.toggleInvalidOnly()},'click .btn[data-action="add"]':function(){this.showReleaseOrderDialog()},'click .btn[data-action="removeOne"]':function(e){this.showRemoveOrderDialog(e.currentTarget.dataset.id)},'click .btn[data-action="removeMany"]':function(){this.showRemoveOrdersDialog()},'click .btn[data-action="export"]':function(e){e.currentTarget.disabled=!0,a.exportXlsx("/compRel/entries;export.xlsx?_id="+this.model.id+"&mode=orders"),this.timers.enableExport=setTimeout(function(){e.currentTarget.disabled=!1},3e3)},'click a[target="_blank"]':function(e){e.target.style.cursor="wait";var t=this.ajax({type:"HEAD",url:e.target.href.replace("#","/")});return t.fail(function(){e.target.parentNode.textContent=e.target.textContent}),t.done(function(){window.open(e.target.href,"_blank")}),!1}},initialize:function(){var e=this,t=e.model;e.invalidOnly="1"===o.getItem("WMES_COMP_REL_INVALID_ONLY"),e.once("afterRender",function(){e.listenTo(t,"change:orders",e.render),e.listenTo(t,"change:status",e.toggleButtons),e.listenTo(t,"change:valid",e.toggleValid)})},getTemplateData:function(){return{invalidOnly:this.invalidOnly,valid:this.model.get("valid"),orders:this.model.serializeOrders(),canRelease:r.can.releaseOrder(this.model),canRemove:r.can.removeOrder(this.model)}},toggleButtons:function(){this.$(".can-release").toggleClass("hidden",!r.can.releaseOrder(this.model)),this.$(".can-remove").toggleClass("hidden",!r.can.removeOrder(this.model))},toggleValid:function(){this.$el.removeClass("panel-default panel-danger").addClass("panel-"+(this.model.get("valid")?"default":"danger"))},toggleInvalidOnly:function(){this.$("tbody").find(".default").toggleClass("hidden",this.invalidOnly)},showReleaseOrderDialog:function(){var e=new l({model:this.model});t.showDialog(e,this.t("orders:title"))},showRemoveOrdersDialog:function(){var e=new s({model:this.model});t.showDialog(e,this.t("orders:removeMany:title"))},showRemoveOrderDialog:function(e){var i=this.model.get("orders").find(function(t){return t._id===e}),a=new n({nlsDomain:this.model.getNlsDomain(),template:c,model:{orderNo:i.orderNo}});t.showDialog(a,this.t("orders:removeOne:title")),this.listenTo(a,"answered",function(t){"yes"===t&&this.removeOrder(e)})},removeOrder:function(e){t.msg.saving();var i=this.ajax({method:"POST",url:"/compRel/entries/"+this.model.id+";release-order",data:JSON.stringify({remove:{_id:e}})});i.fail(function(){t.msg.savingFailed()}),i.done(function(){t.msg.saved(),t.closeDialog()})}})});