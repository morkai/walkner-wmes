define(["underscore","jquery","app/time","app/user","app/core/views/FilterView","app/core/util/forms/dateTimeRange","app/core/util/idAndLabel","app/data/orgUnits","app/users/util/setUpUserSelect2","app/mrpControllers/util/setUpMrpSelect2","../dictionaries","../Entry","app/wmes-compRel-entries/templates/filter","app/core/util/ExpandableSelect"],function(e,t,r,i,s,a,n,o,l,p,u,d,c){"use strict";return s.extend({filterList:["createdAt","mrps","oldComponent","newComponent","limit"],filterMap:{family:"mrps"},template:c,events:e.assign({"click a[data-date-time-range]":a.handleRangeEvent,'change input[name="userType"]':"toggleUserSelect2","focus #-orderNo":function(e){var r=this.$(e.currentTarget),i=r.closest(".form-group"),s=t('<textarea class="form-control text-mono" rows="4"></textarea>').css({position:"absolute",marginTop:"-34px",width:"410px",zIndex:"3"}).val(r.val()).appendTo(i).focus();s.on("blur",function(){r.val(s.val().split("\n").join(" ")).prop("disabled",!1),s.remove()}),r[0].disabled=!0}},s.prototype.events),defaultFormData:function(){return{userType:"others",invalid:!1}},termToForm:{createdAt:a.rqlToForm,"orders.orderNo":function(e,t,r){r.orderNo="in"===t.name?t.args[1].join(" "):t.args[1]},"oldComponents._id":function(e,t,r){r.oldComponent=t.args[1]},"newComponents._id":function(e,t,r){r.newComponent=t.args[1]},"creator.id":function(e,t,r){r.userType="creator",r.user=t.args[1]},"funcs.acceptedBy.id":function(e,t,r){r.userType="acceptor",r.user=t.args[1]},users:function(e,t,r){"mine"===t.args[1]?(r.userType="mine",r.user=i.data._id):(r.userType=t.args[1]===i.data._id?"mine":"others",r.user=t.args[1])},status:function(e,t,r){r[e]="in"===t.name?t.args[1]:[t.args[1]]},mrps:function(e,t,r){r.mrp=Array.isArray(t.args[1])?t.args[1].join(","):""},valid:function(e,t,r){r.invalid=!1===t.args[1]}},getTemplateData:function(){return{statuses:u.statuses}},serializeFormToQuery:function(t){var r=this.$('input[name="userType"]:checked').val(),s=(this.$id("status").val()||[]).filter(function(t){return!e.isEmpty(t)}),n=this.$id("user").val(),o=e.uniq(this.$id("orderNo").val().trim().split(/[^0-9]+/).filter(e=>/^[0-9]{9}$/.test(e))),l=this.$id("oldComponent").val().trim(),p=this.$id("newComponent").val().trim(),u=this.$id("mrps").val(),d=this.$('input[name="invalid"]:checked').val();if(a.formToRql(this,t),"mine"===r&&(r="others",n=i.data._id),n){var c="users";"creator"===r?c="creator.id":"acceptor"===r&&(c="funcs.acceptedBy.id"),t.push({name:"eq",args:[c,n]})}s.length&&t.push({name:"in",args:["status",s]}),u&&u.length&&t.push({name:"in",args:["mrps",u.split(",")]}),o.length&&t.push({name:"in",args:["orders.orderNo",o]}),l.length&&t.push({name:"eq",args:["oldComponents._id",l]}),p.length&&t.push({name:"eq",args:["newComponents._id",p]}),d&&t.push({name:"eq",args:["valid",!1]})},afterRender:function(){s.prototype.afterRender.call(this),this.$id("limit").parent().attr("data-filter","limit"),this.$(".is-expandable").expandableSelect(),l(this.$id("user"),{view:this,width:"100%"}),p(this.$id("mrps"),{own:!0,view:this,width:"250px"}),this.toggleButtonGroup("invalid"),this.toggleUserSelect2()},destroy:function(){s.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},toggleUserSelect2:function(){this.$id("user").select2("enable","mine"!==this.$('input[name="userType"]:checked').val())},filterHasValue:function(e){if("createdAt"===e){var t=this.$id("from-date"),r=this.$id("to-date");return t.val().length>0||r.val().length>0}return s.prototype.filterHasValue.apply(this,arguments)},showFilter:function(e){return"creator"===e?(this.$('input[value="creator"]').parent().click(),void this.$id("user").select2("focus")):s.prototype.showFilter.apply(this,arguments)}})});