define(["underscore","jquery","app/time","app/user","app/core/views/FilterView","app/core/util/forms/dateTimeRange","app/core/util/idAndLabel","app/data/orgUnits","app/users/util/setUpUserSelect2","app/mrpControllers/util/setUpMrpSelect2","../dictionaries","../Entry","app/wmes-compRel-entries/templates/filter","app/core/util/ExpandableSelect"],function(e,t,r,s,i,a,n,o,p,l,u,d,c){"use strict";return i.extend({filterList:["createdAt","mrps","oldComponent","newComponent","limit"],filterMap:{family:"mrps"},template:c,events:e.assign({"click a[data-date-time-range]":a.handleRangeEvent,'change input[name="userType"]':"toggleUserSelect2","focus #-orderNo":function(e){var r=this.$(e.currentTarget),s=r.closest(".form-group"),i=t('<textarea class="form-control text-mono" rows="4"></textarea>').css({position:"absolute",marginTop:"-34px",width:"410px",zIndex:"3"}).val(r.val()).appendTo(s).focus();i.on("blur",function(){r.val(i.val().split("\n").join(" ")).prop("disabled",!1),i.remove()}),r[0].disabled=!0}},i.prototype.events),defaultFormData:function(){return{userType:"others"}},termToForm:{createdAt:a.rqlToForm,"orders.orderNo":function(e,t,r){r.orderNo="in"===t.name?t.args[1].join(" "):t.args[1]},"oldComponents._id":function(e,t,r){r.oldComponent=t.args[1]},"newComponents._id":function(e,t,r){r.newComponent=t.args[1]},"creator.id":function(e,t,r){r.userType="creator",r.user=t.args[1]},"funcs.acceptedBy.id":function(e,t,r){r.userType="acceptor",r.user=t.args[1]},users:function(e,t,r){"mine"===t.args[1]?(r.userType="mine",r.user=s.data._id):(r.userType=t.args[1]===s.data._id?"mine":"others",r.user=t.args[1])},status:function(e,t,r){r[e]="in"===t.name?t.args[1]:[t.args[1]]},mrps:function(e,t,r){r.mrp=Array.isArray(t.args[1])?t.args[1].join(","):""}},getTemplateData:function(){return{statuses:u.statuses}},serializeFormToQuery:function(t){var r=this.$('input[name="userType"]:checked').val(),i=(this.$id("status").val()||[]).filter(function(t){return!e.isEmpty(t)}),n=this.$id("user").val(),o=e.uniq(this.$id("orderNo").val().trim().split(/[^0-9]+/).filter(e=>/^[0-9]{9}$/.test(e))),p=this.$id("oldComponent").val().trim(),l=this.$id("newComponent").val().trim(),u=this.$id("mrps").val();if(a.formToRql(this,t),"mine"===r&&(r="others",n=s.data._id),n){var d="users";"creator"===r?d="creator.id":"acceptor"===r&&(d="funcs.acceptedBy.id"),t.push({name:"eq",args:[d,n]})}i.length&&t.push({name:"in",args:["status",i]}),u&&u.length&&t.push({name:"in",args:["mrps",u.split(",")]}),o.length&&t.push({name:"in",args:["orders.orderNo",o]}),p.length&&t.push({name:"eq",args:["oldComponents._id",p]}),l.length&&t.push({name:"eq",args:["newComponents._id",l]})},afterRender:function(){i.prototype.afterRender.call(this),this.$id("limit").parent().attr("data-filter","limit"),this.$(".is-expandable").expandableSelect(),p(this.$id("user"),{view:this,width:"100%"}),l(this.$id("mrps"),{own:!0,view:this,width:"250px"}),this.toggleUserSelect2()},destroy:function(){i.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},toggleUserSelect2:function(){this.$id("user").select2("enable","mine"!==this.$('input[name="userType"]:checked').val())},filterHasValue:function(e){if("createdAt"===e){var t=this.$id("from-date"),r=this.$id("to-date");return t.val().length>0||r.val().length>0}return i.prototype.filterHasValue.apply(this,arguments)},showFilter:function(e){return"creator"===e?(this.$('input[value="creator"]').parent().click(),void this.$id("user").select2("focus")):i.prototype.showFilter.apply(this,arguments)}})});