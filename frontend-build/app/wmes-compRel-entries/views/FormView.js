define(["underscore","jquery","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/idAndLabel","app/core/util/html","app/core/templates/userInfo","app/data/orgUnits","app/users/util/setUpUserSelect2","app/mrpControllers/util/setUpMrpSelect2","../dictionaries","../Entry","app/wmes-compRel-entries/templates/form","app/wmes-compRel-entries/templates/formFunc"],function(e,t,n,s,i,a,c,u,o,r,l,p,d,f,m,h){"use strict";return a.extend({template:m,events:e.assign({"input #-oldCode":"resolveComponent","input #-newCode":"resolveComponent","click #-addFunc":function(){var e=this.$id("availableFuncs").val();e&&(this.addFunc(e,!this.model.getFunc(e)),this.setUpAvailableFuncs())},"change #-availableFuncs":function(){var e=this.$id("availableFuncs").val();this.addFunc(e,!this.model.getFunc(e)),this.setUpAvailableFuncs()},"click .compRel-form-removeFunc":function(e){this.removeFunc(this.$(e.target).closest(".compRel-form-func")[0].dataset.id)},"change #-mrps":function(){var e=[];this.$(".compRel-form-func").each(function(){e.push(this.dataset.id)}),this.loadFuncUsers(e)},'change input[name$=".users"]':function(e){this.saveFuncUsers(this.$(e.target).closest(".compRel-form-func")[0].dataset.id)}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),this.funcI=0},destroy:function(){a.prototype.destroy.apply(this,arguments)},afterRender:function(){var e=this;a.prototype.afterRender.apply(e,arguments),e.setUpMrpSelect2(),(e.model.get("funcs")||[]).forEach(function(t){e.addFunc(t._id,!1)}),e.setUpUsersSelect2(),e.setUpAvailableFuncs()},checkFuncsValidity:function(){this.$id("availableFuncs")[0].setCustomValidity(this.$(".compRel-form-func").length?"":this.t("FORM:ERROR:noFuncs"))},serializeToForm:function(){var e=this.model.toJSON();return e.mrps=e.mrps?e.mrps.join(","):"",e},serializeForm:function(e){var t=this;return e.mrps=e.mrps.split(","),e.funcs=[],this.$(".compRel-form-func").each(function(){e.funcs.push(t.model.getFunc(this.dataset.id))}),e},setUpMrpSelect2:function(){p(this.$id("mrps"),{view:this,own:!1,width:"100%"})},setUpUsersSelect2:function(){var e=this,t=e.model.get("funcs");e.$('input[name$=".users"]').each(function(n){l(e.$(this),{width:"100%",multiple:!0,allowClear:!0,noPersonnelId:!0}).select2("data",t[n].users.map(function(e){return{id:e.id,text:e.label}}))})},setUpAvailableFuncs:function(){var e={};d.funcs.forEach(function(t){e[t.id]=t}),this.$(".compRel-form-func").each(function(){delete e[this.dataset.id]});var t="";Object.values(e).forEach(function(e,n){t+=u.tag("option",{value:e.id,selected:0===n},e.getLabel())}),this.$id("availableFuncs").html(t).prop("disabled",!t),this.$id("addFunc").prop("disabled",!t),this.checkFuncsValidity()},resolveComponent:function(e){var t=e.currentTarget,n=this.$(t).closest(".form-group").next().find("input")[0];if(n.value="",/^[0-9]{12}$/.test(t.value.trim())){var s="validate"+t.name;this[s]&&this[s].abort(),i.msg.loading(),this[s]=this.ajax({url:"/compRel/entries;resolve-component",data:{nc12:t.value}}),this[s].done(function(e){n.value=e.name}),this[s].always(function(){i.msg.loaded()})}},addFunc:function(e,t){if(!this.$func(e).length){var n=this.model.getFunc(e);n||(n={_id:e,acceptedAt:null,acceptedBy:null,status:"pending",comment:"",users:[]},this.model.attributes.funcs=(this.model.get("funcs")||[]).concat(n));var i=this.renderPartial(h,{i:++this.funcI,status:n.status,func:{_id:e,label:d.funcs.getLabel(e),acceptedAt:n.acceptedAt?s.format(n.acceptedAt,"LL, HH:mm"):"-",acceptedBy:n.acceptedBy?o({userInfo:n.acceptedBy,noIp:!0}):"-",status:this.t("status:"+n.status)}});this.$id("funcs").append(i),l(i.find('input[name$=".users"]'),{view:this,multiple:!0,noPersonnelId:!0}).select2("data",n.users.map(function(e){return{id:e.id,text:e.label}})),t&&this.loadFuncUsers([e])}},removeFunc:function(e){this.$func(e).remove(),this.setUpAvailableFuncs()},loadFuncUsers:function(e){if(e.length){var t=this;i.msg.loading();var n=t.ajax({url:"/compRel/entries;resolve-users",data:{funcs:e.join(","),mrps:t.$id("mrps").val()}});n.done(function(e){Object.keys(e).forEach(function(n){t.updateFuncUsers(n,e[n])})}),n.always(function(){i.msg.loaded()})}},updateFuncUsers:function(e,t){var n=this.$func(e);n.length&&(t.sort(function(e,t){return e.label.localeCompare(t.label,void 0,{ignorePunctuation:!0})}),n.find('input[name$=".users"]').select2("data",t.map(function(e){return{id:e.id,text:e.label}})),this.saveFuncUsers(e))},saveFuncUsers:function(e){var t=this.model.getFunc(e),n=this.$func(e).find('input[name$=".users"]').select2("data").map(function(e){return{id:e.id,label:e.text}});t&&(t.users=n)},$func:function(e){return this.$('.compRel-form-func[data-id="'+e+'"]')}})});