define(["underscore","jquery","../i18n","../time","../user","../socket","../core/Model","../core/util/autolinker","../core/util/html","../data/colorFactory","../data/mrpControllers","./dictionaries","app/core/templates/userInfo"],function(e,t,a,n,i,o,s,r,c,u,d,l,f){"use strict";var p={pending:"default",rejected:"danger",accepted:"success"},m={image:"fa-file-image-o",text:"fa-file-text-o",audio:"fa-audio-o",video:"fa-video-o","application/octet-stream":"fa-file-archive-o","application/x-zip-compressed":"fa-file-archive-o","application/x-7z-compressed":"fa-file-archive-o","application/x-rar-compressed":"fa-file-archive-o","application/pdf":"fa-file-pdf-o","application/json":"fa-file-code-o","application/msword":"fa-file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/vnd.ms-excel":"fa-file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"fa-file-excel-o","application/vnd.ms-powerpoint":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o"};return u.setColors("compRel/users",["#0af","#5cb85c","#fa0","#a0f","#f0a","#f00","#ff0","#9ff"]),s.extend({urlRoot:"/compRel/entries",clientUrlRoot:"#compRel/entries",topicPrefix:"compRel.entries",privilegePrefix:"COMP_REL",nlsDomain:"wmes-compRel-entries",labelAttribute:"rid",getFunc:function(e){return(this.get("funcs")||[]).find(function(t){return t._id===e})},serialize:function(){var e=this.toJSON();return e.className=p[this.get("status")],e.createdAt=n.format(e.createdAt,"L HH:mm"),e.updatedAt=n.format(e.updatedAt,"L HH:mm"),e.creator=f({userInfo:e.creator,noIp:!0}),e.updater=f({userInfo:e.updater,noIp:!0}),e.status=a(this.nlsDomain,"status:"+e.status),e.reason=l.reasons.getLabel(e.reason),e},serializeRow:function(){var t=this.serialize();return t.newComponent=t.newCode+": "+e.escape(t.newName),t.oldComponent=t.oldComponents[0]._id+": "+e.escape(t.oldComponents[0].name),t.oldComponents.length>1&&(t.oldComponent+=" +"+(t.oldComponents.length-1)),t.mrps=t.mrps.map(function(t){var a=d.get(t),n=a?a.get("description"):t;return'<span title="'+e.escape(n)+'">'+e.escape(t)+"</span>"}).join(", "),t},serializeDetails:function(){var t=this.serialize(),a=t.oldComponents,n=t.mrps;if(1===n.length){t.mrps=n[0];var i=d.get(t.mrps);i&&(t.mrps+=": "+e.escape(i.get("description")))}else t.mrps="<ul>",n.forEach(function(a){var n=d.get(a);t.mrps+="<li>"+a,n&&(t.mrps+=": "+e.escape(n.get("description")))}),t.mrps+="</ul>";return 1===a.length?t.oldComponent=a[0]._id+": "+e.escape(a[0].name):(t.oldComponent="<ul>",a.forEach(function(a){t.oldComponent+="<li>"+a._id+": "+e.escape(a.name)}),t.oldComponent+="</ul>"),t.newComponent=t.newCode+": "+e.escape(t.newName),t},serializeFuncs:function(){var e=this;return(e.get("funcs")||[]).map(function(t){return{_id:t._id,label:l.funcs.getLabel(t._id),acceptedAt:t.acceptedAt?n.format(t.acceptedAt,"L HH:mm"):"-",acceptedBy:t.acceptedBy?f({userInfo:t.acceptedBy,noIp:!0}):"-",status:t.status,statusText:a(e.nlsDomain,"funcStatus:"+t.status),comment:t.comment||"-",users:t.users.map(function(e){return f({userInfo:e})}),canAccept:e.constructor.can.acceptFunc(e,t._id)}})},serializeChat:function(){var e=this,t={};(e.get("attachments")||[]).forEach(function(e){t[e._id]=!0});var o=e.get("createdAt"),s=n.getMoment(o),r=e.get("creator"),c=r.id===i.data._id,d=[{user:{id:r.id,label:f({userInfo:r,noIp:!0}),self:c},color:c?"transparent":u.getColor("compRel/users",r.id),lines:[{time:s.format("LLLL"),text:a(e.nlsDomain,"history:added",{day:s.day(),ddd:s.format("ddd"),date:s.format("D MMMM YYYY"),time:s.format("HH:mm:ss")})}]}];return(e.get("changes")||[]).forEach(function(a){if(a.user){var n=!!a.comment,i=!!a.data.attachments&&!a.data.attachments[0]&&!!a.data.attachments[1],o=!!a.data.reason,s=a.data.funcs,r=!!s&&Object.keys(s[0]).some(function(e){return s[0][e]&&s[1][e]&&s[0][e].status&&s[1][e].status&&s[0][e].status!==s[1][e].status});(n||i||o||r)&&e.serializeChatMessage(a,d,t)}}),d},serializeChatMessage:function(t,o,s){var r=this,c=o&&o[o.length-1],d="<time>"+n.format(t.date,"HH:mm:ss")+"</time>",p=n.format(t.date,"dddd, LL LTS"),m=[];if(t.comment){var h=this.serializeText(t.comment);m.push({time:p,text:d+'<span class="compRel-chat-line-text">'+h+"</span>"})}var g=t.data.attachments;if(g&&!g[0]&&g[1]){var v=a(r.nlsDomain,"autolink:attachment");t.data.attachments[1].forEach(function(t){if(!s||s[t._id]){var a=r.serializeAttachment(t);m.push({time:p,text:'<span class="compRel-chat-attachment" title="'+v+'" data-attachment-id="'+t._id+'"><i class="fa '+a.icon+'"></i><a>'+e.escape(a.label)+"</a></span>"})}})}var A=t.data.reason;A&&m.push({time:p,text:a(r.nlsDomain,"chat:reason",{oldReason:l.reasons.getLabel(A[0]),newReason:l.reasons.getLabel(A[1])})});var _=t.data.funcs;if(_&&Object.keys(_[0]).forEach(function(e){var t=_[0][e],n=_[1][e];t&&n&&t.status&&n.status&&t.status!==n.status&&m.push({time:p,text:a(r.nlsDomain,"chat:opinion:"+n.status,{func:l.funcs.getLabel(n._id)})})}),c&&c.user.id===t.user.id)return c.lines.push.apply(c.lines,m),c;var C=t.user.id===i.data._id,L={user:{id:t.user.id,label:f({userInfo:t.user,noIp:!0}),self:C},color:C?"transparent":u.getColor("compRel/users",t.user.id),lines:m};return o&&L.lines.length&&o.push(L),L},serializeText:function(e){return r.autolinkMessage(e,{nlsDomain:this.nlsDomain})},serializeAttachment:function(e){var t=e.type.split("/")[0];return{_id:e._id,icon:m[e.type]||m[t]||"fa-file-o",preview:"image"===t,label:e.name,menu:this.constructor.can.manage()||e.user&&e.user.id===i.data._id}},serializeOrders:function(){return(this.get("orders")||[]).map(function(e){var t=Date.parse(e.releasedAt);return{_id:e._id,orderNo:e.orderNo,releasedAt:t,releasedAtText:n.format(t,"L HH:mm"),releasedBy:f({userInfo:e.releasedBy,noIp:!0}),validFrom:n.format(e.validFrom,"L"),validTo:n.format(e.validTo,"L")}}).sort(function(e,t){return"000000000"===e.orderNo&&"000000000"!==t.orderNo?-1:"000000000"!==e.orderNo&&"000000000"===t.orderNo?1:e.releasedAt-t.releasedAt})},change:function(e,t,a){void 0===a&&(a=this.get(e));var n={};n[e]=[a,t],this.multiChange(n,!0)},multiChange:function(e,t){var a=this,n={date:new Date,user:i.getInfo(),data:{},comment:""},o={};Object.keys(e).forEach(function(i){var s,r;t?(s=e[i][0],r=e[i][1]):(s=a.get(i),r=e[i]),JSON.stringify(r)!==JSON.stringify(s)&&(n.data[i]=[s,r],o[i]=r)}),Object.keys(e).length&&!Object.keys(o).length||(a.handleChange(n),a.update(o))},handleChange:function(t){var a=this,n={};!t.comment.length&&e.isEmpty(t.data)||(n.changes=a.get("changes").concat(t)),Object.keys(t.data).forEach(function(e){var i=e.split("$")[0];if(i){var o=t.data[e],s=a.propChangeHandlers[i];"function"==typeof s?s.call(a.propChangeHandlers,n,a,o,t):n[i]=o[1]}}),a.set(n)},update:function(e){var a=this,n=t.ajax({method:"PUT",url:"/compRel/entries/"+a.id,data:JSON.stringify({socketId:o.getId(),data:e})});return n.fail(function(){a.fetch()}),n},propChangeHandlers:{funcs:function(e,t,a){var n={},i=[];(t.get("funcs")||[]).forEach(function(e){n[e._id]=e}),Object.keys(a[0]).forEach(function(e){var t=a[0][e],o=a[1][e];t?(delete n[e],o&&(o=Object.assign({},t,o),i.push(o))):o&&i.push(o)}),Object.values(n).forEach(function(e){i.push(e)}),i.sort(function(e,t){return e._id.localeCompare(t._id)}),e.funcs=i},attachments:function(e,t,a){this.list("attachments",e,t,a)},orders:function(e,t,a){this.list("orders",e,t,a)},list:function(e,t,a,n){var i=a.get(e);null===n[0]?this.addList(e,t,a,i,n[1]):null===n[1]?this.removeList(e,t,a,i,n[0]):this.editList(e,t,a,i,n[1])},addList:function(e,t,a,n,i){var o={};n.forEach(function(e){o[e._id]=!0});var s=[].concat(n);i.forEach(function(e){o[e._id]||(s.push(e),o[e.id]=!0)}),t[e]=s},removeList:function(e,t,a,n,i){var o={};i.forEach(function(e){o[e._id]=!0}),t[e]=n.filter(function(e){return!o[e._id]})},editList:function(e,t,a,n,i){var o={};i.forEach(function(e){o[e._id]=e}),t[e]=n.map(function(e){return o[e._id]||e})}}},{can:{view:function(){return i.isAllowedTo("PROD_DATA:VIEW","COMP_REL:VIEW")},add:function(){return i.isAllowedTo("PROD_DATA:MANAGE","COMP_REL:MANAGE","COMP_REL:ADD","FN:logistic-buyer")},manage:function(){return i.isAllowedTo("PROD_DATA:MANAGE","COMP_REL:MANAGE")},edit:function(e){if((this.can||this).manage())return!0;var t=e.get("creator");return!(!t||"accepted"===e.get("status"))&&t.id===i.data._id},delete:function(e){return(this.can||this).edit(e)},accept:function(e){var t=this.can||this;return(e.get("funcs")||[]).some(function(a){return t.acceptFunc(e,a._id)})},acceptFunc:function(e,t){if((this.can||this).manage())return!0;if("accepted"===e.get("status"))return!1;var a=e.getFunc(t);return!!a&&a.users.some(function(e){return e.id===i.data._id})},addUser:function(e){return i.isAllowedTo("FN:logistic-buyer")||(this.can||this).accept(e)},releaseOrder:function(e){return"accepted"===e.get("status")&&((this.can||this).manage()||i.isAllowedTo("FN:production-planner"))},uploadAttachments:function(){return!0},changeReason:function(){return(this.can||this).manage()||i.isAllowedTo("FN:logistic-buyer")}}})});