define(["underscore","jquery","../i18n","../time","../user","../socket","../core/Model","../core/util/autolinker","../core/util/html","../data/colorFactory","../data/mrpControllers","./dictionaries","app/core/templates/userInfo"],function(e,t,a,n,i,r,s,o,c,u,d,f,l){"use strict";var p={pending:"default",rejected:"danger",accepted:"success"},m={image:"fa-file-image-o",text:"fa-file-text-o",audio:"fa-audio-o",video:"fa-video-o","application/octet-stream":"fa-file-archive-o","application/x-zip-compressed":"fa-file-archive-o","application/x-7z-compressed":"fa-file-archive-o","application/x-rar-compressed":"fa-file-archive-o","application/pdf":"fa-file-pdf-o","application/json":"fa-file-code-o","application/msword":"fa-file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/vnd.ms-excel":"fa-file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"fa-file-excel-o","application/vnd.ms-powerpoint":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o"};return u.setColors("compRel/users",["#0af","#5cb85c","#fa0","#a0f","#f0a","#f00","#ff0","#9ff"]),s.extend({urlRoot:"/compRel/entries",clientUrlRoot:"#compRel/entries",topicPrefix:"compRel.entries",privilegePrefix:"COMP_REL",nlsDomain:"wmes-compRel-entries",labelAttribute:"rid",getFunc:function(e){return(this.get("funcs")||[]).find(function(t){return t._id===e})},serialize:function(){var e=this.toJSON();return e.className=p[this.get("status")],e.createdAt=n.format(e.createdAt,"L HH:mm"),e.updatedAt=n.format(e.updatedAt,"L HH:mm"),e.creator=l({userInfo:e.creator,noIp:!0}),e.updater=l({userInfo:e.updater,noIp:!0}),e.status=a(this.nlsDomain,"status:"+e.status),e},serializeRow:function(){var t=this.serialize();return t.mrps=t.mrps.map(function(t){var a=d.get(t),n=a?a.get("description"):t;return'<span title="'+e.escape(n)+'">'+e.escape(t)+"</span>"}).join(", "),t},serializeDetails:function(){var t=this.serialize(),a=t.mrps;if(1===a.length){t.mrps=a[0];var n=d.get(t.mrps);n&&(t.mrps+=": "+e.escape(n.get("description")))}else t.mrps="<ul>",a.forEach(function(a){var n=d.get(a);t.mrps+="<li>"+a,n&&(t.mrps+=": "+e.escape(n.get("description")))}),t.mrps+="</ul>";return t.oldComponent=t.oldCode+": "+e.escape(t.oldName),t.newComponent=t.newCode+": "+e.escape(t.newName),t},serializeFuncs:function(){var e=this;return(e.get("funcs")||[]).map(function(t){return{_id:t._id,label:f.funcs.getLabel(t._id),acceptedAt:t.acceptedAt?n.format(t.acceptedAt,"L HH:mm"):"-",acceptedBy:t.acceptedBy?l({userInfo:t.acceptedBy,noIp:!0}):"-",status:t.status,statusText:a(e.nlsDomain,"funcStatus:"+t.status),comment:t.comment||"-",users:t.users.map(function(e){return l({userInfo:e})}),canAccept:e.constructor.can.acceptFunc(e,t._id)}})},serializeChat:function(){var e=this,t={};(e.get("attachments")||[]).forEach(function(e){t[e._id]=!0});var r=e.get("createdAt"),s=n.getMoment(r),o=e.get("creator"),c=o.id===i.data._id,d=[{user:{id:o.id,label:l({userInfo:o,noIp:!0}),self:c},color:c?"transparent":u.getColor("compRel/users",o.id),lines:[{time:s.format("LLLL"),text:a(e.nlsDomain,"history:added",{day:s.day(),ddd:s.format("ddd"),date:s.format("D MMMM YYYY"),time:s.format("HH:mm:ss")})}]}];return(e.get("changes")||[]).forEach(function(a){if(a.user){var n=!!a.comment,i=!!a.data.attachments&&!a.data.attachments[0]&&!!a.data.attachments[1];(n||i)&&e.serializeChatMessage(a,d,t)}}),d},serializeChatMessage:function(t,r,s){var o=this,c=r&&r[r.length-1],d="<time>"+n.format(t.date,"HH:mm:ss")+"</time>",f=n.format(t.date,"dddd, LL LTS"),p=[];if(t.comment){var m=this.serializeText(t.comment);p.push({time:f,text:d+'<span class="compRel-chat-line-text">'+m+"</span>"})}var h=t.data.attachments;if(h&&!h[0]&&h[1]){var g=a(o.nlsDomain,"autolink:attachment");t.data.attachments[1].forEach(function(t){if(!s||s[t._id]){var a=o.serializeAttachment(t);p.push({time:f,text:'<span class="compRel-chat-attachment" title="'+g+'" data-attachment-id="'+t._id+'"><i class="fa '+a.icon+'"></i><a>'+e.escape(a.label)+"</a></span>"})}})}if(c&&c.user.id===t.user.id)return c.lines.push.apply(c.lines,p),c;var v=t.user.id===i.data._id,_={user:{id:t.user.id,label:l({userInfo:t.user,noIp:!0}),self:v},color:v?"transparent":u.getColor("compRel/users",t.user.id),lines:p};return r&&_.lines.length&&r.push(_),_},serializeText:function(e){return o.autolinkMessage(e,{nlsDomain:this.nlsDomain})},serializeAttachment:function(e){var t=e.type.split("/")[0];return{_id:e._id,icon:m[e.type]||m[t]||"fa-file-o",preview:"image"===t,label:e.name,menu:this.constructor.can.manage()||e.user&&e.user.id===i.data._id}},serializeOrders:function(){return(this.get("orders")||[]).map(function(e){return{_id:e._id,releasedAt:n.format(e.releasedAt,"L HH:mm"),releasedBy:l({userInfo:e.releasedBy,noIp:!0})}})},change:function(e,t,a){void 0===a&&(a=this.get(e));var n={};n[e]=[a,t],this.multiChange(n,!0)},multiChange:function(e,t){var a=this,n={date:new Date,user:i.getInfo(),data:{},comment:""},r={};Object.keys(e).forEach(function(i){var s,o;t?(s=e[i][0],o=e[i][1]):(s=a.get(i),o=e[i]),JSON.stringify(o)!==JSON.stringify(s)&&(n.data[i]=[s,o],r[i]=o)}),Object.keys(e).length&&!Object.keys(r).length||(a.handleChange(n),a.update(r))},handleChange:function(t){var a=this,n={};!t.comment.length&&e.isEmpty(t.data)||(n.changes=a.get("changes").concat(t)),Object.keys(t.data).forEach(function(e){var i=e.split("$")[0];if(i){var r=t.data[e],s=a.propChangeHandlers[i];"function"==typeof s?s.call(a.propChangeHandlers,n,a,r,t):n[i]=r[1]}}),a.set(n)},update:function(e){var a=this,n=t.ajax({method:"PUT",url:"/compRel/entries/"+a.id,data:JSON.stringify({socketId:r.getId(),data:e})});return n.fail(function(){a.fetch()}),n},propChangeHandlers:{funcs:function(e,t,a){var n={},i=[];(t.get("funcs")||[]).forEach(function(e){n[e._id]=e}),Object.keys(a[0]).forEach(function(e){var t=a[0][e],r=a[1][e];t?(delete n[e],r&&(Object.assign(t,r),i.push(t))):r&&i.push(r)}),Object.values(n).forEach(function(e){i.push(e)}),i.sort(function(e,t){return e._id.localeCompare(t._id)}),e.funcs=i},attachments:function(e,t,a){this.list("attachments",e,t,a)},orders:function(e,t,a){this.list("orders",e,t,a)},list:function(e,t,a,n){var i=a.get(e);null===n[0]?this.addList(e,t,a,i,n[1]):null===n[1]?this.removeList(e,t,a,i,n[0]):this.editList(e,t,a,i,n[1])},addList:function(e,t,a,n,i){var r={};n.forEach(function(e){r[e._id]=!0});var s=[].concat(n);i.forEach(function(e){r[e._id]||(s.push(e),r[e.id]=!0)}),t[e]=s},removeList:function(e,t,a,n,i){var r={};i.forEach(function(e){r[e._id]=!0}),t[e]=n.filter(function(e){return!r[e._id]})},editList:function(e,t,a,n,i){var r={};i.forEach(function(e){r[e._id]=e}),t[e]=n.map(function(e){return r[e._id]||e})}}},{can:{add:function(){return i.isAllowedTo("PROD_DATA:MANAGE","COMP_REL:ADD","FN:production-planner")},manage:function(){return i.isAllowedTo("PROD_DATA:MANAGE","COMP_REL:MANAGE")},edit:function(e){if((this.can||this).manage())return!0;var t=e.get("creator");return!(!t||"accepted"===e.get("status"))&&t.id===i.data._id},delete:function(e){return(this.can||this).edit(e)},accept:function(e){var t=this.can||this;return(e.get("funcs")||[]).some(function(a){return t.acceptFunc(e,a._id)})},acceptFunc:function(e,t){if((this.can||this).manage())return!0;if("accepted"===e.get("status"))return!1;var a=e.getFunc(t);return!!a&&a.users.some(function(e){return e.id===i.data._id})},releaseOrder:function(e){return"accepted"===e.get("status")&&((this.can||this).manage()||i.isAllowedTo("FN:production-planner"))},uploadAttachments:function(){return!0}}})});