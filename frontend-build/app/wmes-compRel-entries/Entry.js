define(["underscore","jquery","../i18n","../time","../user","../socket","../core/Model","../core/util/autolinker","../core/util/html","../data/colorFactory","../data/mrpControllers","./dictionaries","app/core/templates/userInfo"],function(e,t,n,a,o,i,s,r,c,u,d,l,f){"use strict";var p={pending:"default",rejected:"danger",accepted:"success"},m={image:"fa-file-image-o",text:"fa-file-text-o",audio:"fa-audio-o",video:"fa-video-o","application/octet-stream":"fa-file-archive-o","application/x-zip-compressed":"fa-file-archive-o","application/x-7z-compressed":"fa-file-archive-o","application/x-rar-compressed":"fa-file-archive-o","application/pdf":"fa-file-pdf-o","application/json":"fa-file-code-o","application/msword":"fa-file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/vnd.ms-excel":"fa-file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"fa-file-excel-o","application/vnd.ms-powerpoint":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o"};return u.setColors("compRel/users",["#0af","#5cb85c","#fa0","#a0f","#f0a","#f00","#ff0","#9ff"]),s.extend({urlRoot:"/compRel/entries",clientUrlRoot:"#compRel/entries",topicPrefix:"compRel.entries",privilegePrefix:"COMP_REL",nlsDomain:"wmes-compRel-entries",labelAttribute:"rid",getFunc:function(e){return(this.get("funcs")||[]).find(function(t){return t._id===e})},serialize:function(){var e=this.toJSON();return e.className=p[this.get("status")],e.createdAt=a.format(e.createdAt,"L HH:mm"),e.updatedAt=a.format(e.updatedAt,"L HH:mm"),e.creator=f({userInfo:e.creator,noIp:!0}),e.updater=f({userInfo:e.updater,noIp:!0}),e.status=n(this.nlsDomain,"status:"+e.status),e.reason=l.reasons.getLabel(e.reason),e},serializeRow:function(){var t=this.serialize();return t.newComponent=t.newComponents[0]._id+": "+e.escape(t.newComponents[0].name),t.oldComponent=t.oldComponents[0]._id+": "+e.escape(t.oldComponents[0].name),t.oldComponents.length>1&&(t.oldComponent+=" +"+(t.oldComponents.length-1)),t.newComponents.length>1&&(t.newComponent+=" +"+(t.newComponents.length-1)),t.mrps=t.mrps.map(function(t){var n=d.get(t),a=n?n.get("description"):t;return'<span title="'+e.escape(a)+'">'+e.escape(t)+"</span>"}).join(", "),t},serializeDetails:function(){var t=this.serialize(),n=t.oldComponents,a=t.newComponents,o=t.mrps;if(1===o.length){t.mrps=o[0];var i=d.get(t.mrps);i&&(t.mrps+=": "+e.escape(i.get("description")))}else t.mrps="<ul>",o.forEach(function(n){var a=d.get(n);t.mrps+="<li>"+n,a&&(t.mrps+=": "+e.escape(a.get("description")))}),t.mrps+="</ul>";return 1===n.length?t.oldComponent=n[0]._id+": "+e.escape(n[0].name):(t.oldComponent="<ul>",n.forEach(function(n){t.oldComponent+="<li>"+n._id+": "+e.escape(n.name)}),t.oldComponent+="</ul>"),1===a.length?t.newComponent=a[0]._id+": "+e.escape(a[0].name):(t.newComponent="<ul>",a.forEach(function(n){t.newComponent+="<li>"+n._id+": "+e.escape(n.name)}),t.newComponent+="</ul>"),t},serializeFuncs:function(){var e=this;return(e.get("funcs")||[]).map(function(t){return{_id:t._id,label:l.funcs.getLabel(t._id),acceptedAt:t.acceptedAt?a.format(t.acceptedAt,"L HH:mm"):"-",acceptedBy:t.acceptedBy?f({userInfo:t.acceptedBy,noIp:!0}):"-",status:t.status,statusText:n(e.nlsDomain,"funcStatus:"+t.status),comment:t.comment||"-",users:t.users.map(function(e){return f({userInfo:e})}),canAccept:e.constructor.can.acceptFunc(e,t._id)}})},serializeChat:function(){var e=this,t={};(e.get("attachments")||[]).forEach(function(e){t[e._id]=!0});var i=e.get("createdAt"),s=a.getMoment(i),r=e.get("creator"),c=r.id===o.data._id,d=[{user:{id:r.id,label:f({userInfo:r,noIp:!0}),self:c},color:c?"transparent":u.getColor("compRel/users",r.id),lines:[{time:s.format("LLLL"),text:n(e.nlsDomain,"history:added",{day:s.day(),ddd:s.format("ddd"),date:s.format("D MMMM YYYY"),time:s.format("HH:mm:ss")})}]}];return(e.get("changes")||[]).forEach(function(n){if(n.user){var a=!!n.comment,o=!!n.data.attachments&&!n.data.attachments[0]&&!!n.data.attachments[1],i=!!n.data.reason,s=n.data.funcs,r=!!s&&Object.keys(s[0]).some(function(e){return s[0][e]&&s[1][e]&&s[0][e].status&&s[1][e].status&&s[0][e].status!==s[1][e].status});(a||o||i||r)&&e.serializeChatMessage(n,d,t)}}),d},serializeChatMessage:function(t,i,s){var r=this,c=i&&i[i.length-1],d="<time>"+a.format(t.date,"HH:mm:ss")+"</time>",p=a.format(t.date,"dddd, LL LTS"),m=[];if(t.comment){var h=this.serializeText(t.comment);m.push({time:p,text:d+'<span class="compRel-chat-line-text">'+h+"</span>"})}var g=t.data.attachments;if(g&&!g[0]&&g[1]){var v=n(r.nlsDomain,"autolink:attachment");t.data.attachments[1].forEach(function(t){if(!s||s[t._id]){var n=r.serializeAttachment(t);m.push({time:p,text:'<span class="compRel-chat-attachment" title="'+v+'" data-attachment-id="'+t._id+'"><i class="fa '+n.icon+'"></i><a>'+e.escape(n.label)+"</a></span>"})}})}var C=t.data.reason;C&&m.push({time:p,text:n(r.nlsDomain,"chat:reason",{oldReason:l.reasons.getLabel(C[0]),newReason:l.reasons.getLabel(C[1])})});var _=t.data.funcs;if(_&&Object.keys(_[0]).forEach(function(e){var t=_[0][e],a=_[1][e];t&&a&&t.status&&a.status&&t.status!==a.status&&m.push({time:p,text:n(r.nlsDomain,"chat:opinion:"+a.status,{func:l.funcs.getLabel(a._id)})})}),c&&c.user.id===t.user.id)return c.lines.push.apply(c.lines,m),c;var A=t.user.id===o.data._id,w={user:{id:t.user.id,label:f({userInfo:t.user,noIp:!0}),self:A},color:A?"transparent":u.getColor("compRel/users",t.user.id),lines:m};return i&&w.lines.length&&i.push(w),w},serializeText:function(e){return r.autolinkMessage(e,{nlsDomain:this.nlsDomain})},serializeAttachment:function(e){var t=e.type.split("/")[0];return{_id:e._id,icon:m[e.type]||m[t]||"fa-file-o",preview:"image"===t,label:e.name,menu:this.constructor.can.manage()||e.user&&e.user.id===o.data._id}},serializeOrders:function(){return(this.get("orders")||[]).map(function(e){var t=Date.parse(e.releasedAt);return{_id:e._id,orderNo:e.orderNo,releasedAt:t,releasedAtText:a.format(t,"L HH:mm"),releasedBy:f({userInfo:e.releasedBy,noIp:!0}),validFrom:a.format(e.validFrom,"L"),validTo:a.format(e.validTo,"L")}}).sort(function(e,t){return"000000000"===e.orderNo&&"000000000"!==t.orderNo?-1:"000000000"!==e.orderNo&&"000000000"===t.orderNo?1:e.releasedAt-t.releasedAt})},change:function(e,t,n){void 0===n&&(n=this.get(e));var a={};a[e]=[n,t],this.multiChange(a,!0)},multiChange:function(e,t){var n=this,a={date:new Date,user:o.getInfo(),data:{},comment:""},i={};Object.keys(e).forEach(function(o){var s,r;t?(s=e[o][0],r=e[o][1]):(s=n.get(o),r=e[o]),JSON.stringify(r)!==JSON.stringify(s)&&(a.data[o]=[s,r],i[o]=r)}),Object.keys(e).length&&!Object.keys(i).length||(n.handleChange(a),n.update(i))},handleChange:function(t){var n=this,a={};!t.comment.length&&e.isEmpty(t.data)||(a.changes=n.get("changes").concat(t)),Object.keys(t.data).forEach(function(e){var o=e.split("$")[0];if(o){var i=t.data[e],s=n.propChangeHandlers[o];"function"==typeof s?s.call(n.propChangeHandlers,a,n,i,t):a[o]=i[1]}}),n.set(a)},update:function(e){var n=this,a=t.ajax({method:"PUT",url:"/compRel/entries/"+n.id,data:JSON.stringify({socketId:i.getId(),data:e})});return a.fail(function(){n.fetch()}),a},propChangeHandlers:{funcs:function(e,t,n){var a={},o=[];(t.get("funcs")||[]).forEach(function(e){a[e._id]=e}),Object.keys(n[0]).forEach(function(e){var t=n[0][e],i=n[1][e];t?(delete a[e],i&&(i=Object.assign({},t,i),o.push(i))):i&&o.push(i)}),Object.values(a).forEach(function(e){o.push(e)}),o.sort(function(e,t){return e._id.localeCompare(t._id)}),e.funcs=o},attachments:function(e,t,n){this.list("attachments",e,t,n)},orders:function(e,t,n){this.list("orders",e,t,n)},list:function(e,t,n,a){var o=n.get(e);null===a[0]?this.addList(e,t,n,o,a[1]):null===a[1]?this.removeList(e,t,n,o,a[0]):this.editList(e,t,n,o,a[1])},addList:function(e,t,n,a,o){var i={};a.forEach(function(e){i[e._id]=!0});var s=[].concat(a);o.forEach(function(e){i[e._id]||(s.push(e),i[e.id]=!0)}),t[e]=s},removeList:function(e,t,n,a,o){var i={};o.forEach(function(e){i[e._id]=!0}),t[e]=a.filter(function(e){return!i[e._id]})},editList:function(e,t,n,a,o){var i={};o.forEach(function(e){i[e._id]=e}),t[e]=a.map(function(e){return i[e._id]||e})}}},{can:{view:function(){return o.isAllowedTo("PROD_DATA:VIEW","COMP_REL:VIEW")},add:function(){return o.isAllowedTo("PROD_DATA:MANAGE","COMP_REL:MANAGE","COMP_REL:ADD","FN:logistic-buyer")},manage:function(){return o.isAllowedTo("PROD_DATA:MANAGE","COMP_REL:MANAGE")},edit:function(e){if((this.can||this).manage())return!0;var t=e.get("creator");return!(!t||"accepted"===e.get("status"))&&t.id===o.data._id},delete:function(e){return(this.can||this).edit(e)},accept:function(e){var t=this.can||this;return(e.get("funcs")||[]).some(function(n){return t.acceptFunc(e,n._id)})},acceptFunc:function(e,t){if((this.can||this).manage())return!0;if("accepted"===e.get("status"))return!1;var n=e.getFunc(t);return!!n&&n.users.some(function(e){return e.id===o.data._id})},addUser:function(e){return o.isAllowedTo("FN:logistic-buyer")||(this.can||this).accept(e)},releaseOrder:function(e){return"accepted"===e.get("status")&&((this.can||this).manage()||o.isAllowedTo("FN:production-planner"))},uploadAttachments:function(){return!0},changeReason:function(){return(this.can||this).manage()||o.isAllowedTo("FN:logistic-buyer")}}})});