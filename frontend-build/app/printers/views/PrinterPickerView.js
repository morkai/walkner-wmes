// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/broker","app/pubsub","app/viewport","app/core/View","app/planning/util/contextMenu","app/printers/templates/pageAction"],function(n,e,t,i,r,a,l,o,u){"use strict";function c(n){null===p?s(n):setTimeout(n,1,p)}function s(t){var i=e.ajax({url:"/printing/printers"});r.subscribe("printing.printers.**",function(e,t){if(null!==p)switch(t){case"printing.printers.added":p.push(e.model),d();break;case"printing.printers.deleted":p=p.filter(function(n){return n._id!==e.model._id});break;case"printing.printers.edited":var i=n.find(p,function(n){return n._id===e.model._id});i?n.assign(i,e.model):p.push(e.model),d()}}),i.fail(function(){t([])}),i.done(function(n){p=n.collection||[],t(p)})}function d(){p.sort(function(n,e){return n.label.localeCompare(e.label)})}var p=null;return l.extend({},{contextMenu:function(n,e){n.contextMenu.hide=!1;var r=i.sandbox();r.subscribe("planning.contextMenu.hidden",function(){r.destroy(),r=null,n.contextMenu.onCancel&&n.contextMenu.onCancel()}),c(function(i){if(r){if(!i.length)return e(null);var a=[t("printers","menu:header"),{label:t("printers","menu:browser"),handler:e.bind(null,null)}].concat(i.map(function(n){return{label:n.label,handler:e.bind(null,n._id)}}));o.show(n.contextMenu.view,n.pageY-40,n.pageX-15,a)}})},listAction:function(n,t){var i=e(n.currentTarget).addClass("disabled").prop("disabled",!0);n.contextMenu=n.listAction,n.contextMenu.onCancel=function(){i.removeClass("disabled").prop("disabled",!1)},this.contextMenu(n,function(e){n.contextMenu.onCancel(),t(e)})},pageAction:function(n,i){var r=n.view.model||n.view.collection,l=r.getNlsDomain?r.getNlsDomain():r.nlsDomain||"core",o="PAGE_ACTION:print",s=n.label||(t.has(l,o)?t(l,o):t("core",o));return null===p||0===p.length?{label:s,icon:"print",callback:function(t){function r(){u.destroy(),u=null,o.removeClass("fa-spinner fa-spin").addClass("fa-print"),l.prop("disabled",!1).removeClass("disabled")}if(p&&0===p.length)return i(null);var l=e(t.currentTarget).find(".btn").addClass("disabled").prop("disabled",!0),o=l.find(".fa").removeClass("fa-print").addClass("fa-spinner fa-spin"),u=n.view.broker.sandbox();u.subscribe("router.dispatching",r),c(function(e){if(u){if(!e.length)return i(null);a.currentLayout.setActions(n.view.actions,n.view),a.currentLayout.$(".page-actions-printers").find(".btn").click()}})}}:{template:function(){return u({label:s,printers:p})},callback:function(n){var t=e(n.currentTarget);t.data("printers-bound")||(t.data("printers-bound",!0),t.find(".dropdown-menu").on("click","a",function(n){i(n.currentTarget.dataset.printerId||null)}))}}}})});