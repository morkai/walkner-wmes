define(["underscore","app/core/views/DetailsView","app/data/downtimeReasons","app/prodShiftOrders/ProdShiftOrder","app/prodShifts/templates/details"],function(e,t,i,a,r){"use strict";return t.extend({template:r,remoteTopics:{},initialize:function(){t.prototype.initialize.apply(this,arguments),this.panelType=this.options.panelType||"primary",this.prodShiftOrders&&this.prodDowntimes&&this.once("afterRender",function(){var t=e.debounce(this.updateDetails.bind(this),1);this.listenTo(this.prodShiftOrders,"reset add remove change",t),this.listenTo(this.prodDowntimes,"reset add remove change",t)})},getTemplateData:function(){return{panelType:this.panelType,efficiency:this.calcEfficiency()}},updateDetails:function(){this.updateEfficiency()},updatePanelType:function(e){this.$el.removeClass("panel-"+this.panelType).addClass("panel-"+e),this.panelType=e},updateEfficiency:function(){var e=this.calcEfficiency();this.$('div[data-prop="efficiency"] > .prop-value').text(e>=0?e+"%":""),clearTimeout(this.timers.updateEfficiency),this.timers.updateEfficiency=setTimeout(this.updateEfficiency.bind(this),3e4)},calcEfficiency:function(){if(!this.prodShiftOrders||!this.prodDowntimes)return-1;var e=0,t=0,r={},n=Date.now();return this.prodDowntimes.forEach(function(e){var t=i.get(e.get("reason"));if(t&&"break"===t.get("type")){var a=e.get("prodShiftOrder");if(a){r[a._id]||(r[a._id]=0);var s=Date.parse(e.get("startedAt")),p=Date.parse(e.get("finishedAt"))||n;r[a._id]+=p-s}}}),this.prodShiftOrders.forEach(function(i){var s=i.get("workDuration"),p=a.getTaktTimeCoeff(i.attributes);s||i.get("finishedAt")||(s=(n-Date.parse(i.get("startedAt"))-(r[i.id]||0))/36e5),e+=i.get("laborTime")*p/100*i.get("quantityDone"),t+=s*i.get("workerCount")}),Math.min(999,Math.round(e/t*100))}})});