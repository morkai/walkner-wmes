define(["require","underscore","jquery","d3","d3.timeline","app/time","app/i18n","app/user","app/viewport","app/core/View","app/core/util/getShiftStartInfo","app/data/downtimeReasons","app/data/aors","app/prodChangeRequests/util/createDeletePageAction","app/prodShifts/templates/timelineIdlePopover","app/prodShifts/templates/timelineWorkingPopover","app/prodShifts/templates/timelineDowntimePopover","app/prodShifts/templates/timelineWhPopover"],function(t,e,i,o,r,n,s,a,d,h,m,p,l,u,g,f,c,v){"use strict";return h.extend({className:"prodShifts-timeline",events:{"click .prodShifts-timeline-addOrder":"showAddOrderDialog","click .prodShifts-timeline-editOrder":function(){this.showEditDialog(this.prodShiftOrders,"app/prodShiftOrders/views/ProdShiftOrderFormView")},"click .prodShifts-timeline-deleteOrder":function(){this.showDeleteDialog(this.prodShiftOrders)},"click .prodShifts-timeline-addDowntime":"showAddDowntimeDialog","click .prodShifts-timeline-editDowntime":function(){this.showEditDialog(this.prodDowntimes,"app/prodDowntimes/views/ProdDowntimeFormView")},"click .prodShifts-timeline-deleteDowntime":function(){this.showDeleteDialog(this.prodDowntimes)},"mouseover .popover":function(){this.timers.hidePopover&&(clearTimeout(this.timers.hidePopover),this.timers.hidePopover=null)}},model:{nlsDomain:"prodShifts"},initialize:function(){this.chart=null,this.datum=null,this.beginning=-1,this.ending=-1,this.lastWidth=-1,this.popover=null,this.highlightedItem=null,!1!==this.options.resizable&&(this.onWindowResize=e.debounce(this.onWindowResize.bind(this),16),i(window).on("resize."+this.idPrefix,this.onWindowResize)),!1!==this.options.editable&&(this.onDocumentClick=this.onDocumentClick.bind(this),i(document.body).on("click."+this.idPrefix,this.onDocumentClick));var t=e.debounce(this.render.bind(this),1),o=e.debounce(this.reset.bind(this),1);this.listenTo(this.prodShiftOrders,"add remove change",t),this.listenTo(this.prodShiftOrders,"reset",o),this.listenTo(this.prodDowntimes,"add remove change",t),this.listenTo(this.prodDowntimes,"reset",o),this.whOrderStatuses&&(this.listenTo(this.whOrderStatuses,"add remove change",t),this.listenTo(this.whOrderStatuses,"reset",o))},destroy:function(){i(window).off("."+this.idPrefix),i(document.body).off("."+this.idPrefix),this.hidePopover(),this.removeChart(),this.chart=null,this.datum=null,i(document.body).removeClass("prodShifts-extendedDowntime"),o.select(this.el).select("svg").remove()},getLastState:function(){var t="idle";if(!this.datum)return t;for(var e=0,i=0,o=this.datum.length;i<o;++i){var r=this.datum[i];if("wh"!==r.type){var n=r.times[r.times.length-1];n&&n.ending_time>=e&&(e=n.ending_time,t=r.type)}}return t},calcWidth:function(){return Math.max(this.el.getBoundingClientRect().width-28,300)},onWindowResize:function(){var t=this.calcWidth();t!==this.lastWidth&&(this.lastWidth=t,this.renderChart())},onDocumentClick:function(t){t.target!==document.body&&i(t.target).closest(".prodShifts-timeline-popover").length||this.hidePopover()},afterRender:function(){this.timers&&(this.serializeDatum(),this.beginning&&(null===this.chart&&this.createChart(),this.renderChart(),this.toggleExtendedDowntime(),this.setUpDatumExtension()))},setUpDatumExtension:function(){this.timers.extendDatum&&clearTimeout(this.timers.extendDatum),this.ending>=this.beginning+288e5||(this.timers.extendDatum=setInterval(function(t){t.extendDatum(),null===t.popover?(t.renderChart(),t.toggleExtendedDowntime()):t.updatePopover()},15e3,this))},toggleExtendedDowntime:function(){var t=this.prodShift?this.prodShift.get("extendedDowntimeDelay"):null;if("number"==typeof t){var e=this.prodDowntimes.last(),o=!1;if(e&&!e.get("finishedAt")){var r=Date.parse(e.get("startedAt"));o=Date.now()-r>=60*t*1e3}i("body").toggleClass("prodShifts-extendedDowntime",o)}},reset:function(){this.chart=null,this.removeChart(),this.render()},removeChart:function(){var t=o.select(this.el).select("svg");t.empty()||t.remove()},renderChart:function(){this.removeChart();var t=this.calcWidth();this.hidePopover(),this.chart&&(this.chart.width(t),o.select(this.el).append("svg").attr("width",t).datum(this.datum).call(this.chart),this.highlightedItem&&this.highlightItem(this.highlightedItem))},canManage:function(){return!1!==this.options.editable&&a.isAllowedTo("PROD_DATA:MANAGE","PROD_DATA:CHANGES:REQUEST")},showPopover:function(t,e){if(null===this.popover||this.popover.el!==e){this.hidePopover();var o=this.canManage()&&t.ended,r=i(e);r.popover({trigger:"manual",container:this.el,placement:"top",html:!0,title:s("prodShifts","timeline:popover:"+t.type),content:this.renderPopover(t,o)}),r.popover("show"),r.data("bs.popover").tip().addClass("popover-"+t.type),this.popover={el:e,item:t}}},hidePopover:function(t){this.timers&&this.timers.hidePopover&&(clearTimeout(this.timers.hidePopover),this.timers.hidePopover=null),null!==this.popover&&(t?this.timers.hidePopover=setTimeout(this.hidePopover.bind(this),200,!1):(i(this.popover.el).popover("destroy"),this.popover=null))},updatePopover:function(){if(this.popover){var t=this.renderPopover(this.popover.item,this.canManage()&&this.popover.item.ended);i(this.popover.el).data("bs.popover").$tip.find(".popover-content").html(t)}},serializeDatum:function(){var t=[],e=[],i=[],o=[],r=Date.now();this.beginning=this.prodShift?Date.parse(this.prodShift.get("date")):m(r).moment.valueOf();var n=this.beginning+288e5,s=r>=n,a=Math.min(r,n);this.ending=a,this.prodShiftOrders.forEach(function(t){var i=Date.parse(t.get("startedAt")),r=Date.parse(t.get("finishedAt"));o.push({from:i,to:r}),e.push({type:"working",starting_time:i,ending_time:r||-1,ended:!isNaN(r),taktTimeOk:t.isTaktTimeOk(),data:t.toJSON(),model:t,text:t.get("orderId")})}),this.prodDowntimes.forEach(function(t){var e=Date.parse(t.get("startedAt")),r=Date.parse(t.get("finishedAt"));t.get("prodShiftOrder")||o.push({from:e,to:r}),i.push({type:"downtime",starting_time:e,ending_time:r||-1,ended:!isNaN(r),data:t.toJSON(),model:t,text:t.get("reason")})}),o.sort(function(t,e){return t.from-e.from});var d=0===o.length?s?a:-1:o[0].from;t.push({type:"idle",starting_time:this.beginning,ending_time:d,ended:-1!==d});for(var h=0,p=o.length;h<p;++h){var l=o[h+1];if(!l)break;var u=o[h];l.from-u.to>1e3&&t.push({type:"idle",starting_time:u.to,ending_time:l.from,ended:!0})}function g(t){return t.length&&-1===t[t.length-1].ending_time&&(t[t.length-1].ending_time=a,t[t.length-1].ended=!1),t}o.length&&o[o.length-1].to<n&&t.push({type:"idle",starting_time:o[o.length-1].to,ending_time:s?n:-1,ended:s}),this.datum=[{type:"idle",times:g(t)},{type:"working",times:g(e)},{type:"downtime",times:g(i)}],this.whOrderStatuses&&this.datum.push(this.createWhDatum())},createWhDatum:function(){for(var t=this.beginning,i=0;i<3;++i){var o=this.datum[i];o.times.length&&(t=Math.max(t,e.last(o.times).ending_time))}var r=e.last(this.datum[1].times);if(!r)return{type:"wh",times:[]};var s=this.whOrderStatuses.getTimelineData(this.prodLineId,r.model),a=r.model.get("quantityDone"),d=s.qtySent-a;return{type:"wh",times:[{type:"wh",text:d>=1?"~"+n.toString(d*s.pceTime/1e3):"",data:{qtyDone:a,qtySent:s.qtySent,pceTime:s.pceTime},model:{},starting_time:t,ending_time:this.beginning+288e5}]}},extendDatum:function(){var t=Date.now(),e=this.beginning+288e5;t>=e&&(clearTimeout(this.timers.extendDatum),this.timers.extendDatum=null,t=e);var i=null;this.datum.forEach(function(e){var o=e.times.length-1;o>-1&&!1===e.times[o].ended&&(e.times[o].ending_time=i=t)}),i&&this.datum[3]&&this.datum[3].times.length&&(this.datum[3].times[0].starting_time=i)},createChart:function(){var t=this,e=this.options.itemHeight||60,i=Math.round(.5*e);this.chart=r().beginning(this.beginning).ending(this.beginning+288e5).itemHeight(e).margin({left:20,right:20,top:1,bottom:0}).tickFormat({format:o.time.format("%H:%M"),tickTime:o.time.hours,tickNumber:1,tickSize:5}).colors(!1).itemClassName(function(t){var e="timeline-item timeline-item-"+t.type;return"working"!==t.type||t.taktTimeOk||(e+=" is-tt-nok"),"downtime"===t.type&&t.model.isBreak()&&(e+=" is-break"),e}).afterRender(function(t){t.data&&t.data._id&&this.setAttribute("data-model-id",t.data._id),"downtime"===t.type&&t.data.prodShiftOrder&&this.setAttribute("height",i),t.text&&o.select(this.parentNode).append("foreignObject").attr({width:Math.max(0,parseInt(this.getAttribute("width"),10)-5),x:parseInt(this.getAttribute("x"),10)+3,y:parseInt(this.getAttribute("y"),10)+parseInt(this.getAttribute("height"),10)-19,class:"prodShifts-timeline-text","data-type":t.type}).html("<span>"+t.text+"</span>")}).mouseover(function(e){t.showPopover(e,o.event.target)}).mouseout(function(){!1===t.options.editable?t.hidePopover():o.event.ctrlKey||t.hidePopover(!0)}).mousedown(function(){o.event.preventDefault()}).click(function(e){var i=null;"downtime"===e.type&&a.isAllowedTo("LOCAL","PROD_DATA:VIEW","PROD_DOWNTIMES:VIEW")?i="prodDowntimes/"+e.data._id:"working"===e.type&&(i="prodShiftOrders/"+e.data._id),i&&(o.event.ctrlKey||1===o.event.button?window.open("/#"+i):t.broker.publish("router.navigate",{url:"/"+i,trigger:!0}))})},renderPopover:function(t,e){var i=n.toString((t.ending_time-t.starting_time)/1e3),o={startedAt:n.format(t.starting_time,"LTS"),finishedAt:t.ended?n.format(t.ending_time,"LTS"):"-",duration:i,managing:e},r=t.type,s=t.data,a=t.model;if("idle"===r)return this.renderPartialHtml(g,o);if("working"===r){var d=a.getEfficiency({prodDowntimes:this.prodDowntimes});return d?d*=100:d=a.getTaktTimeEfficiency(),o.order=s.orderId,o.operation=s.operationNo,o.workerCount=s.workerCount,o.quantityDone=s.quantityDone,o.efficiency=d?Math.round(d)+"%":"?",o.sapTaktTime=a.get("sapTaktTime"),o.lastTaktTime=a.getLastTaktTime(),o.avgTaktTime=a.getAvgTaktTime(),this.renderPartialHtml(f,o)}if("downtime"===r){var h=p.get(s.reason),m=l.get(s.aor);return o.reason=h?h.getLabel():s.reason,o.aor=m?m.getLabel():s.aor,o.hasOrder=!!s.prodShiftOrder,this.renderPartialHtml(c,o)}return"wh"===r?(o.currentQty=s.qtySent-s.qtyDone,o.currentTime=n.toString(o.currentQty>0?o.currentQty*s.pceTime/1e3:0),o.nextQty="0",o.nextTime="0s",this.renderPartialHtml(v,o)):void 0},showAddOrderDialog:function(){var e=this;if(e.popover){var i=e.popover.item;t(["app/prodShiftOrders/views/ProdShiftOrderFormView","app/prodShiftOrders/ProdShiftOrder"],function(t,o){var r=e.prodShift,n=new o({prodShift:r.id,division:r.get("division"),subdivision:r.get("subdivision"),mrpControllers:r.get("mrpControllers"),prodFlow:r.get("prodFlow"),workCenter:r.get("workCenter"),prodLine:r.get("prodLine"),master:r.get("master"),leader:r.get("leader"),operator:r.get("operator"),operators:r.get("operators"),workerCount:1,quantityDone:0,startedAt:new Date(i.starting_time),finishedAt:new Date(i.ending_time)}),a=n.getNlsDomain();d.showDialog(new t({dialogClassName:"has-panel",model:n,editMode:!1,formMethod:"POST",formAction:n.url(),formActionText:s(a,"FORM:ACTION:add"),failureText:s(a,"FORM:ERROR:addFailure"),panelTitleText:s(a,"PANEL:TITLE:addForm"),done:function(){d.closeDialog()}}))})}},showAddDowntimeDialog:function(){var e=this;if(e.popover){var i=e.popover.item;t(["app/prodDowntimes/views/ProdDowntimeFormView","app/prodDowntimes/ProdDowntime"],function(t,o){var r=new o({prodShift:e.prodShift.id,prodShiftOrder:"working"===i.type?i.data._id:null,master:e.prodShift.get("master"),leader:e.prodShift.get("leader"),operator:e.prodShift.get("operator"),operators:e.prodShift.get("operators"),startedAt:new Date(i.starting_time),finishedAt:new Date(i.ending_time),status:"undecided"}),n=r.getNlsDomain();d.showDialog(new t({dialogClassName:"has-panel",model:r,editMode:!1,formMethod:"POST",formAction:r.url(),formActionText:s(n,"FORM:ACTION:add"),failureText:s(n,"FORM:ERROR:addFailure"),panelTitleText:s(n,"PANEL:TITLE:addForm"),done:function(){d.closeDialog()}}))})}},showEditDialog:function(e,i){if(this.popover){var o=e.get(this.popover.item.data._id);o&&this.promised(o.fetch()).then(function(){t([i],function(t){var e=o.getNlsDomain();d.showDialog(new t({dialogClassName:"has-panel",model:o,editMode:!0,formMethod:"PUT",formAction:o.url(),formActionText:s(e,"FORM:ACTION:edit"),failureText:s(e,"FORM:ERROR:editFailure"),panelTitleText:s(e,"PANEL:TITLE:editForm"),done:function(){d.closeDialog()}}))})})}},showDeleteDialog:function(t){if(this.popover){var e=t.get(this.popover.item.data._id);if(e){var i=this;this.promised(e.fetch()).then(function(){u(i,e).callback()})}}},highlightItem:function(t,e){var i=this,o=i.$('.timeline-item[data-model-id="'+t+'"]');if(o.length&&o[0].classList.add("is-highlighted"),i.highlightedItem=t,e){var r=null;[1,2].forEach(function(e){i.datum[e].times.forEach(function(e){e.data&&e.data._id===t&&(r=e)})}),r&&i.showPopover(r,o[0])}}})});