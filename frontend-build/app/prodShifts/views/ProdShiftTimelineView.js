define(["underscore","jquery","d3","d3.timeline","app/time","app/i18n","app/user","app/core/View","app/data/downtimeReasons","app/data/aors","app/prodShifts/templates/timelineIdlePopover","app/prodShifts/templates/timelineWorkingPopover","app/prodShifts/templates/timelineDowntimePopover"],function(e,t,i,n,r,a,o,s,d,h,g,m,p){return s.extend({className:"prodShifts-timeline",initialize:function(){this.chart=null,this.datum=null,this.beginning=-1,this.ending=-1,this.lastWidth=-1,this.onResize=e.debounce(this.onResize.bind(this),100),t(window).resize(this.onResize)},destroy:function(){this.chart=null,this.datum=null,t(window).off("resize",this.onResize),i.select(this.el).select("svg").remove()},onResize:function(){var e=this.el.getBoundingClientRect().width;e!==this.lastWidth&&(this.lastWidth=e,this.renderChart())},beforeRender:function(){this.stopListening(this.collection,"reset",this.render)},afterRender:function(){this.listenToOnce(this.collection,"reset",this.render),this.serializeDatum(),null===this.chart&&this.createChart(),this.renderChart(),this.setUpDatumExtension()},setUpDatumExtension:function(){function e(e){e.extendDatum(),e.renderChart()}this.timers.extendDatum&&clearTimeout(this.timers.extendDatum),this.ending>=this.beginning+288e5||(this.timers.extendDatum=setInterval(e,1e4,this))},renderChart:function(){var e=i.select(this.el),t=e.select("svg");t.empty()||t.remove(),this.chart.width(null),e.append("svg").attr("width",this.el.getBoundingClientRect().width).datum(this.datum).call(this.chart)},serializeDatum:function(){function t(e,t,i,n){var r={type:e,prodLogEntry:i,starting_time:n,ending_time:-1,ended:!0};t.push(r),"working"===e?(r.quantityDone=0,r.workerCount=0,a[i.get("prodShiftOrder")._id]=r):"downtime"===e&&(o[i.get("data")._id]=r)}function i(e){return e.length&&-1===e[e.length-1].ending_time&&(e[e.length-1].ending_time=w,e[e.length-1].ended=!1),e}this.beginning=-1;for(var n=0,r=this.collection.length,a={},o={},s=[],d=[],h=[];r>n;++n){var g,m=this.collection.at(n),p=m.get("prodShiftOrder"),l=p?p._id:null,u=m.get("type"),c=m.get("data");if(-1!==this.beginning)switch(u){case"changeOrder":var f=Date.parse(c.startedAt);-1===s[s.length-1].ending_time&&(s[s.length-1].ending_time=f),t("working",d,m,f);break;case"correctOrder":if(g=a[l]){var v=g.prodLogEntry.get("data");v.orderId=c.orderId,v.operationNo=c.operationNo}break;case"finishOrder":g=a[l],g&&-1===g.ending_time&&(g.ending_time=Date.parse(c.finishedAt));break;case"startDowntime":t("downtime",h,m,Date.parse(c.startedAt));break;case"finishDowntime":g=o[c._id],g&&-1===g.ending_time&&(g.ending_time=Date.parse(c.finishedAt));break;case"endWork":t("idle",s,m,Date.parse(m.get("createdAt")));break;case"changeQuantityDone":g=a[l],g&&(g.quantityDone=c.newValue);break;case"changeWorkerCount":g=a[l],g&&(g.workerCount=c.newValue);break;case"editOrder":if(g=a[l],!g)break;void 0!==c.quantityDone&&(g.quantityDone=c.quantityDone),void 0!==c.workerCount&&(g.workerCount=c.workerCount),void 0!==c.startedAt&&(g.starting_time=Date.parse(c.startedAt)),void 0!==c.finishedAt&&(g.ending_time=Date.parse(c.finishedAt)),g.prodLogEntry.set("data",e.extend(g.prodLogEntry.get("data"),c));break;case"editDowntime":if(g=o[c._id],!g)break;void 0!==c.startedAt&&(g.starting_time=Date.parse(c.startedAt)),void 0!==c.finishedAt&&(g.ending_time=Date.parse(c.finishedAt)),g.prodLogEntry.set("data",e.extend(g.prodLogEntry.get("data"),c));break;case"deleteDowntime":if(g=o[c._id],!g)break;delete o[c._id],h.splice(h.indexOf(g),1)}else"changeShift"===u&&(this.beginning=Date.parse(c.startedProdShift.date),t("idle",s,m,this.beginning))}var w=this.ending=Math.min(Date.now(),this.beginning+288e5);this.datum=[{type:"idle",times:i(s)},{type:"working",times:i(d)},{type:"downtime",times:i(h)}]},extendDatum:function(){var e=Date.now(),t=this.beginning+288e5;e>=t&&(clearTimeout(this.timers.extendDatum),this.timers.extendDatum=null,e=t),this.datum.forEach(function(t){var i=t.times.length-1;i>-1&&t.times[i].ended===!1&&(t.times[i].ending_time=e)})},createChart:function(){var e=this;this.chart=n().beginning(this.beginning).ending(this.beginning+288e5).itemHeight(60).margin({left:20,right:20,top:1,bottom:0}).tickFormat({format:i.time.format("%H:%M"),tickTime:i.time.hours,tickNumber:1,tickSize:5}).colors(!1).itemClassName(function(e){return"timeline-item timeline-item-"+e.type}).mouseover(function(n){var r=t(i.event.target);r.popover({trigger:"manual",container:e.el,placement:"auto top",html:!0,title:a("prodShifts","timeline:popover:"+n.type),content:e.renderPopover(n)}),r.popover("show"),r.data("bs.popover").$tip.addClass("popover-"+n.type)}).mouseout(function(){t(this).popover("destroy")}).click(function(t){"downtime"===t.type&&o.isAllowedTo("PROD_DOWNTIMES:VIEW")?e.broker.publish("router.navigate",{url:"/prodDowntimes/"+t.prodLogEntry.get("data")._id,trigger:!0}):"working"===t.type&&e.broker.publish("router.navigate",{url:"/prodShiftOrders/"+t.prodLogEntry.get("data")._id,trigger:!0})})},renderPopover:function(e){var t=r.toString((e.ending_time-e.starting_time)/1e3),i={startedAt:r.format(e.starting_time,"HH:mm:ss"),finishedAt:e.ended?r.format(e.ending_time,"HH:mm:ss"):"-",duration:t};if("idle"===e.type)return g(i);var n=e.prodLogEntry.get("data");if("working"===e.type)return i.order=n.orderId,i.operation=n.operationNo,i.workerCount=e.workerCount,i.quantityDone=e.quantityDone,m(i);if("downtime"===e.type){var a=d.get(n.reason),o=h.get(n.aor);return i.reason=a?a.getLabel():n.reason,i.aor=o?o.getLabel():n.aor,p(i)}}})});