define(["underscore","jquery","d3","d3.timeline","app/time","app/i18n","app/user","app/core/View","app/data/downtimeReasons","app/data/aors","app/prodShifts/templates/timelineIdlePopover","app/prodShifts/templates/timelineWorkingPopover","app/prodShifts/templates/timelineDowntimePopover"],function(e,t,i,n,r,a,o,s,d,h,g,m,l){return s.extend({className:"prodShifts-timeline",initialize:function(){this.chart=null,this.datum=null,this.beginning=-1,this.ending=-1,this.lastWidth=-1,this.onResize=e.debounce(this.onResize.bind(this),100),t(window).resize(this.onResize)},destroy:function(){this.chart=null,this.datum=null,t(window).off("resize",this.onResize),i.select(this.el).select("svg").remove()},onResize:function(){var e=this.el.getBoundingClientRect().width;e!==this.lastWidth&&(this.lastWidth=e,this.renderChart())},beforeRender:function(){this.stopListening(this.collection,"reset",this.render)},afterRender:function(){this.listenToOnce(this.collection,"reset",this.render),this.serializeDatum(),null===this.chart&&this.createChart(),this.renderChart(),this.setUpDatumExtension()},setUpDatumExtension:function(){function e(e){e.extendDatum(),e.renderChart()}this.timers.extendDatum&&clearTimeout(this.timers.extendDatum),this.ending>=this.beginning+288e5||(this.timers.extendDatum=setInterval(e,1e4,this))},renderChart:function(){var e=i.select(this.el),t=e.select("svg");t.empty()||t.remove(),this.chart.width(null),e.append("svg").attr("width",this.el.getBoundingClientRect().width).datum(this.datum).call(this.chart)},serializeDatum:function(){function e(e,t,i,n){var a={type:e,prodLogEntry:i,starting_time:n,ending_time:-1,ended:!0};t.push(a),"working"===e&&(a.quantityDone=0,a.workerCount=0,r[i.get("prodShiftOrder")]=a)}function t(e){return e.length&&-1===e[e.length-1].ending_time&&(e[e.length-1].ending_time=p,e[e.length-1].ended=!1),e}this.beginning=-1;for(var i=0,n=this.collection.length,r={},a=[],o=[],s=[];n>i;++i){var d,h=this.collection.at(i),g=h.get("type"),m=h.get("data");if(-1!==this.beginning)switch(g){case"changeOrder":var l=Date.parse(m.startedAt);-1===a[a.length-1].ending_time&&(a[a.length-1].ending_time=l),e("working",o,h,l);break;case"finishOrder":o[o.length-1].ending_time=Date.parse(m.finishedAt);break;case"startDowntime":e("downtime",s,h,Date.parse(m.startedAt));break;case"finishDowntime":s[s.length-1].ending_time=Date.parse(m.finishedAt);break;case"endWork":e("idle",a,h,Date.parse(h.get("createdAt")));break;case"changeQuantityDone":d=r[h.get("prodShiftOrder")],d&&(d.quantityDone=h.get("data").newValue);break;case"changeWorkerCount":d=r[h.get("prodShiftOrder")],d&&(d.workerCount=h.get("data").newValue)}else"changeShift"===g&&(this.beginning=Date.parse(m.startedProdShift.date),e("idle",a,h,this.beginning))}var p=this.ending=Math.min(Date.now(),this.beginning+288e5);this.datum=[{type:"idle",times:t(a)},{type:"working",times:t(o)},{type:"downtime",times:t(s)}]},extendDatum:function(){var e=Date.now(),t=this.beginning+288e5;e>=t&&(clearTimeout(this.timers.extendDatum),this.timers.extendDatum=null,e=t),this.datum.forEach(function(t){var i=t.times.length-1;i>-1&&t.times[i].ended===!1&&(t.times[i].ending_time=e)})},createChart:function(){var e=this;this.chart=n().beginning(this.beginning).ending(this.beginning+288e5).itemHeight(60).margin({left:20,right:20,top:1,bottom:0}).tickFormat({format:i.time.format("%H:%M"),tickTime:i.time.hours,tickNumber:1,tickSize:5}).colors(!1).itemClassName(function(e){return"timeline-item timeline-item-"+e.type}).mouseover(function(n){var r=t(i.event.target);r.popover({trigger:"manual",container:e.el,placement:"auto top",html:!0,title:a("prodShifts","timeline:popover:"+n.type),content:e.renderPopover(n)}),r.popover("show"),r.data("bs.popover").$tip.addClass("popover-"+n.type)}).mouseout(function(){t(this).popover("destroy")}).click(function(t){"downtime"===t.type&&o.isAllowedTo("PROD_DOWNTIMES:VIEW")?e.broker.publish("router.navigate",{url:"/prodDowntimes/"+t.prodLogEntry.get("data")._id,trigger:!0}):"working"===t.type&&e.broker.publish("router.navigate",{url:"/prodShiftOrders/"+t.prodLogEntry.get("data")._id,trigger:!0})})},renderPopover:function(e){var t=r.toString((e.ending_time-e.starting_time)/1e3),i={startedAt:r.format(e.starting_time,"HH:mm:ss"),finishedAt:e.ended?r.format(e.ending_time,"HH:mm:ss"):"-",duration:t};if("idle"===e.type)return g(i);var n=e.prodLogEntry.get("data");if("working"===e.type)return i.order=n.orderId,i.operation=n.operationNo,i.workerCount=e.workerCount,i.quantityDone=e.quantityDone,m(i);if("downtime"===e.type){var a=d.get(n.reason),o=h.get(n.aor);return i.reason=a?a.getLabel():n.reason,i.aor=o?o.getLabel():n.aor,l(i)}}})});