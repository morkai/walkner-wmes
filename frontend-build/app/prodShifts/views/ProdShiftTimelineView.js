// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["require","underscore","jquery","d3","d3.timeline","app/time","app/i18n","app/user","app/viewport","app/core/View","app/core/util/getShiftStartInfo","app/data/downtimeReasons","app/data/aors","app/prodShifts/templates/timelineIdlePopover","app/prodShifts/templates/timelineWorkingPopover","app/prodShifts/templates/timelineDowntimePopover"],function(t,e,i,o,n,r,d,s,a,h,p,l,m,u,f,c){return h.extend({className:"prodShifts-timeline",events:{"click .prodShifts-timeline-addOrder":"showAddOrderDialog","click .prodShifts-timeline-editOrder":function(){this.showEditDialog(this.prodShiftOrders,"app/prodShiftOrders/views/ProdShiftOrderFormView")},"click .prodShifts-timeline-deleteOrder":function(){this.showDeleteDialog(this.prodShiftOrders)},"click .prodShifts-timeline-addDowntime":"showAddDowntimeDialog","click .prodShifts-timeline-editDowntime":function(){this.showEditDialog(this.prodDowntimes,"app/prodDowntimes/views/ProdDowntimeFormView")},"click .prodShifts-timeline-deleteDowntime":function(){this.showDeleteDialog(this.prodDowntimes)}},initialize:function(){this.chart=null,this.datum=null,this.beginning=-1,this.ending=-1,this.lastWidth=-1,this.popover=null,this.options.resizable!==!1&&(this.onWindowResize=e.debounce(this.onWindowResize.bind(this),16),i(window).on("resize",this.onWindowResize)),this.options.editable!==!1&&(this.onDocumentClick=this.onDocumentClick.bind(this),i(document.body).on("click",this.onDocumentClick)),this.listenTo(this.prodShiftOrders,"add",this.render),this.listenTo(this.prodShiftOrders,"remove",this.render),this.listenTo(this.prodShiftOrders,"change",this.render),this.listenTo(this.prodDowntimes,"add",this.render),this.listenTo(this.prodDowntimes,"remove",this.render),this.listenTo(this.prodDowntimes,"change",this.render)},destroy:function(){this.chart=null,this.datum=null,this.options.resizable!==!1&&i(window).off("resize",this.onWindowResize),this.options.editable!==!1&&i(document.body).off("click",this.onDocumentClick),o.select(this.el).select("svg").remove()},calcWidth:function(){return this.el.getBoundingClientRect().width-28},onWindowResize:function(){var t=this.calcWidth();t!==this.lastWidth&&(this.lastWidth=t,this.renderChart())},onDocumentClick:function(t){t.target!==document.body&&i(t.target).closest(".prodShifts-timeline-popover").length||this.hidePopover()},afterRender:function(){this.serializeDatum(),null===this.chart&&this.createChart(),this.renderChart(),this.setUpDatumExtension()},setUpDatumExtension:function(){function t(t){null===t.popover&&(t.extendDatum(),t.renderChart())}this.timers.extendDatum&&clearTimeout(this.timers.extendDatum),this.ending>=this.beginning+288e5||(this.timers.extendDatum=setInterval(t,15e3,this))},renderChart:function(){var t=o.select(this.el),e=t.select("svg");e.empty()||e.remove();var i=this.calcWidth();this.hidePopover(),this.chart.width(i),t.append("svg").attr("width",i).datum(this.datum).call(this.chart)},hidePopover:function(){null!==this.popover&&(i(this.popover.el).popover("destroy"),this.popover=null)},serializeDatum:function(){function t(t){return t.length&&-1===t[t.length-1].ending_time&&(t[t.length-1].ending_time=a,t[t.length-1].ended=!1),t}var e=[],i=[],o=[],n=[],r=Date.now();this.beginning=this.prodShift?Date.parse(this.prodShift.get("date")):p(r).moment.valueOf();var d=this.beginning+288e5,s=r>=d,a=Math.min(r,d);this.ending=a,this.prodShiftOrders.forEach(function(t){var e=Date.parse(t.get("startedAt")),o=Date.parse(t.get("finishedAt"));n.push({from:e,to:o}),i.push({type:"working",starting_time:e,ending_time:o||-1,ended:!isNaN(o),data:t.toJSON()})}),this.prodDowntimes.forEach(function(t){var e=Date.parse(t.get("startedAt")),i=Date.parse(t.get("finishedAt"));t.get("prodShiftOrder")||n.push({from:e,to:i}),o.push({type:"downtime",starting_time:e,ending_time:i||-1,ended:!isNaN(i),data:t.toJSON()})}),n.sort(function(t,e){return t.from-e.from});var h=0===n.length?s?a:-1:n[0].from;e.push({type:"idle",starting_time:this.beginning,ending_time:h,ended:-1!==h});for(var l=0,m=n.length;m>l;++l){var u=n[l+1];if(!u)break;var f=n[l];u.from-f.to>1e3&&e.push({type:"idle",starting_time:f.to,ending_time:u.from,ended:!0})}n.length&&n[n.length-1].to<d&&e.push({type:"idle",starting_time:n[n.length-1].to,ending_time:s?d:-1,ended:s}),this.datum=[{type:"idle",times:t(e)},{type:"working",times:t(i)},{type:"downtime",times:t(o)}]},extendDatum:function(){var t=Date.now(),e=this.beginning+288e5;t>=e&&(clearTimeout(this.timers.extendDatum),this.timers.extendDatum=null,t=e),this.datum.forEach(function(e){var i=e.times.length-1;i>-1&&e.times[i].ended===!1&&(e.times[i].ending_time=t)})},createChart:function(){var t=this,e=this.options.editable!==!1&&s.isAllowedTo("PROD_DATA:MANAGE"),r=this.options.itemHeight||60,a=Math.round(.833*r);this.chart=n().beginning(this.beginning).ending(this.beginning+288e5).itemHeight(r).margin({left:20,right:20,top:1,bottom:0}).tickFormat({format:o.time.format("%H:%M"),tickTime:o.time.hours,tickNumber:1,tickSize:5}).colors(!1).itemClassName(function(t){return"timeline-item timeline-item-"+t.type}).afterRender(function(t){"downtime"===t.type&&t.data.prodShiftOrder&&this.setAttribute("height",a)}).mouseover(function(n){var r=o.event.target;if(null===t.popover||t.popover.el!==r){t.hidePopover();var s=e&&o.event.ctrlKey&&n.ended,a=i(r);a.popover({trigger:"manual",container:t.el,placement:"top",html:!0,title:d("prodShifts","timeline:popover:"+n.type),content:t.renderPopover(n,s)}),a.popover("show"),a.data("bs.popover").$tip.addClass("popover-"+n.type),t.popover={el:r,item:n}}}).mouseout(function(){t.options.editable!==!1&&o.event.ctrlKey||t.hidePopover()}).click(function(i){e&&o.event.ctrlKey||("downtime"===i.type&&s.isAllowedTo("PROD_DOWNTIMES:VIEW")?t.broker.publish("router.navigate",{url:"/prodDowntimes/"+i.data._id,trigger:!0}):"working"===i.type&&t.broker.publish("router.navigate",{url:"/prodShiftOrders/"+i.data._id,trigger:!0}))})},renderPopover:function(t,e){var i=r.toString((t.ending_time-t.starting_time)/1e3),o={startedAt:r.format(t.starting_time,"HH:mm:ss"),finishedAt:t.ended?r.format(t.ending_time,"HH:mm:ss"):"-",duration:i,managing:e};if("idle"===t.type)return u(o);if("working"===t.type)return o.order=t.data.orderId,o.operation=t.data.operationNo,o.workerCount=t.data.workerCount,o.quantityDone=t.data.quantityDone,f(o);if("downtime"===t.type){var n=l.get(t.data.reason),d=m.get(t.data.aor);return o.reason=n?n.getLabel():t.data.reason,o.aor=d?d.getLabel():t.data.aor,o.hasOrder=!!t.data.prodShiftOrder,c(o)}},showAddOrderDialog:function(){var e=this,i=this.popover.item;t(["app/prodShiftOrders/views/ProdShiftOrderFormView","app/prodShiftOrders/ProdShiftOrder"],function(t,o){var n=new o({prodShift:e.prodShift.id,master:e.prodShift.get("master"),leader:e.prodShift.get("leader"),operator:e.prodShift.get("operator"),operators:e.prodShift.get("operators"),workerCount:1,quantityDone:0,startedAt:new Date(i.starting_time),finishedAt:new Date(i.ending_time)}),r=n.getNlsDomain();a.showDialog(new t({dialogClassName:"has-panel",model:n,editMode:!1,formMethod:"POST",formAction:n.url(),formActionText:d(r,"FORM:ACTION:add"),failureText:d(r,"FORM:ERROR:addFailure"),panelTitleText:d(r,"PANEL:TITLE:addForm"),done:function(){a.closeDialog()}}))})},showAddDowntimeDialog:function(){var e=this,i=this.popover.item;t(["app/prodDowntimes/views/ProdDowntimeFormView","app/prodDowntimes/ProdDowntime"],function(t,o){var n=new o({prodShift:e.prodShift.id,prodShiftOrder:"working"===i.type?i.data._id:null,master:e.prodShift.get("master"),leader:e.prodShift.get("leader"),operator:e.prodShift.get("operator"),operators:e.prodShift.get("operators"),startedAt:new Date(i.starting_time),finishedAt:new Date(i.ending_time),status:"undecided"}),r=n.getNlsDomain();a.showDialog(new t({dialogClassName:"has-panel",model:n,editMode:!1,formMethod:"POST",formAction:n.url(),formActionText:d(r,"FORM:ACTION:add"),failureText:d(r,"FORM:ERROR:addFailure"),panelTitleText:d(r,"PANEL:TITLE:addForm"),done:function(){a.closeDialog()}}))})},showEditDialog:function(e,i){var o=e.get(this.popover.item.data._id);o&&this.promised(o.fetch()).then(function(){t([i],function(t){var e=o.getNlsDomain();a.showDialog(new t({dialogClassName:"has-panel",model:o,editMode:!0,formMethod:"PUT",formAction:o.url(),formActionText:d(e,"FORM:ACTION:edit"),failureText:d(e,"FORM:ERROR:editFailure"),panelTitleText:d(e,"PANEL:TITLE:editForm"),done:function(){a.closeDialog()}}))})})},showDeleteDialog:function(e){var i=e.get(this.popover.item.data._id);i&&this.promised(i.fetch()).then(function(){t(["app/core/views/ActionFormView"],function(t){t.showDeleteDialog({model:i})})})}})});