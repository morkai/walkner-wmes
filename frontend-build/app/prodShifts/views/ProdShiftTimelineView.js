// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["require","underscore","jquery","d3","d3.timeline","app/time","app/i18n","app/user","app/viewport","app/core/View","app/data/downtimeReasons","app/data/aors","app/prodShifts/templates/timelineIdlePopover","app/prodShifts/templates/timelineWorkingPopover","app/prodShifts/templates/timelineDowntimePopover"],function(e,t,i,o,r,n,d,s,a,h,p,l,m,u,f){return h.extend({className:"prodShifts-timeline",events:{"click .prodShifts-timeline-addOrder":"showAddOrderDialog","click .prodShifts-timeline-editOrder":function(){this.showEditDialog(this.prodShiftOrders,"app/prodShiftOrders/views/ProdShiftOrderFormView")},"click .prodShifts-timeline-deleteOrder":function(){this.showDeleteDialog(this.prodShiftOrders)},"click .prodShifts-timeline-addDowntime":"showAddDowntimeDialog","click .prodShifts-timeline-editDowntime":function(){this.showEditDialog(this.prodDowntimes,"app/prodDowntimes/views/ProdDowntimeFormView")},"click .prodShifts-timeline-deleteDowntime":function(){this.showDeleteDialog(this.prodDowntimes)}},initialize:function(){this.chart=null,this.datum=null,this.beginning=-1,this.ending=-1,this.lastWidth=-1,this.popover=null,this.onWindowResize=t.debounce(this.onWindowResize.bind(this),250),this.onDocumentClick=this.onDocumentClick.bind(this),i(window).on("resize",this.onWindowResize),i(document.body).on("click",this.onDocumentClick),this.listenTo(this.prodShiftOrders,"add",this.render),this.listenTo(this.prodShiftOrders,"remove",this.render),this.listenTo(this.prodShiftOrders,"change",this.render),this.listenTo(this.prodDowntimes,"add",this.render),this.listenTo(this.prodDowntimes,"remove",this.render),this.listenTo(this.prodDowntimes,"change",this.render)},destroy:function(){this.chart=null,this.datum=null,i(window).off("resize",this.onWindowResize),i(document.body).off("click",this.onDocumentClick),o.select(this.el).select("svg").remove()},onWindowResize:function(){var e=this.el.getBoundingClientRect().width-28;e!==this.lastWidth&&(this.lastWidth=e,this.renderChart())},onDocumentClick:function(e){e.target!==document.body&&i(e.target).closest(".prodShifts-timeline-popover").length||this.hidePopover()},afterRender:function(){this.serializeDatum(),null===this.chart&&this.createChart(),this.renderChart(),this.setUpDatumExtension()},setUpDatumExtension:function(){function e(e){null===e.popover&&(e.extendDatum(),e.renderChart())}this.timers.extendDatum&&clearTimeout(this.timers.extendDatum),this.ending>=this.beginning+288e5||(this.timers.extendDatum=setInterval(e,1e4,this))},renderChart:function(){var e=o.select(this.el),t=e.select("svg");t.empty()||t.remove();var i=this.el.getBoundingClientRect().width-28;this.hidePopover(),this.chart.width(i),e.append("svg").attr("width",i).datum(this.datum).call(this.chart)},hidePopover:function(){null!==this.popover&&(i(this.popover.el).popover("destroy"),this.popover=null)},serializeDatum:function(){function e(e){return e.length&&-1===e[e.length-1].ending_time&&(e[e.length-1].ending_time=a,e[e.length-1].ended=!1),e}var t=[],i=[],o=[],r=[];this.beginning=Date.parse(this.prodShift.get("date"));var n=this.beginning+288e5,d=Date.now(),s=d>=n,a=Math.min(d,n);this.ending=a,this.prodShiftOrders.forEach(function(e){var t=Date.parse(e.get("startedAt")),o=Date.parse(e.get("finishedAt"));r.push({from:t,to:o}),i.push({type:"working",starting_time:t,ending_time:o||-1,ended:!isNaN(o),data:e.toJSON()})}),this.prodDowntimes.forEach(function(e){var t=Date.parse(e.get("startedAt")),i=Date.parse(e.get("finishedAt"));e.get("prodShiftOrder")||r.push({from:t,to:i}),o.push({type:"downtime",starting_time:t,ending_time:i||-1,ended:!isNaN(i),data:e.toJSON()})}),r.sort(function(e,t){return e.from-t.from});var h=0===r.length?s?a:-1:r[0].from;t.push({type:"idle",starting_time:this.beginning,ending_time:h,ended:-1!==h});for(var p=0,l=r.length;l>p;++p){var m=r[p+1];if(!m)break;var u=r[p];m.from-u.to>1e3&&t.push({type:"idle",starting_time:u.to,ending_time:m.from,ended:!0})}r.length&&r[r.length-1].to<n&&t.push({type:"idle",starting_time:r[r.length-1].to,ending_time:s?n:-1,ended:s}),this.datum=[{type:"idle",times:e(t)},{type:"working",times:e(i)},{type:"downtime",times:e(o)}]},extendDatum:function(){var e=Date.now(),t=this.beginning+288e5;e>=t&&(clearTimeout(this.timers.extendDatum),this.timers.extendDatum=null,e=t),this.datum.forEach(function(t){var i=t.times.length-1;i>-1&&t.times[i].ended===!1&&(t.times[i].ending_time=e)})},createChart:function(){var e=this,t=s.isAllowedTo("PROD_DATA:MANAGE");this.chart=r().beginning(this.beginning).ending(this.beginning+288e5).itemHeight(60).margin({left:20,right:20,top:1,bottom:0}).tickFormat({format:o.time.format("%H:%M"),tickTime:o.time.hours,tickNumber:1,tickSize:5}).colors(!1).itemClassName(function(e){return"timeline-item timeline-item-"+e.type}).afterRender(function(e){"downtime"===e.type&&e.data.prodShiftOrder&&this.setAttribute("height","50")}).mouseover(function(r){var n=o.event.target;if(null===e.popover||e.popover.el!==n){e.hidePopover();var s=t&&o.event.ctrlKey&&r.ended,a=i(n);a.popover({trigger:"manual",container:e.el,placement:"top",html:!0,title:d("prodShifts","timeline:popover:"+r.type),content:e.renderPopover(r,s)}),a.popover("show"),a.data("bs.popover").$tip.addClass("popover-"+r.type),e.popover={el:n,item:r}}}).mouseout(function(){o.event.ctrlKey||e.hidePopover()}).click(function(i){t&&o.event.ctrlKey||("downtime"===i.type&&s.isAllowedTo("PROD_DOWNTIMES:VIEW")?e.broker.publish("router.navigate",{url:"/prodDowntimes/"+i.data._id,trigger:!0}):"working"===i.type&&e.broker.publish("router.navigate",{url:"/prodShiftOrders/"+i.data._id,trigger:!0}))})},renderPopover:function(e,t){var i=n.toString((e.ending_time-e.starting_time)/1e3),o={startedAt:n.format(e.starting_time,"HH:mm:ss"),finishedAt:e.ended?n.format(e.ending_time,"HH:mm:ss"):"-",duration:i,managing:t};if("idle"===e.type)return m(o);if("working"===e.type)return o.order=e.data.orderId,o.operation=e.data.operationNo,o.workerCount=e.data.workerCount,o.quantityDone=e.data.quantityDone,u(o);if("downtime"===e.type){var r=p.get(e.data.reason),d=l.get(e.data.aor);return o.reason=r?r.getLabel():e.data.reason,o.aor=d?d.getLabel():e.data.aor,o.hasOrder=!!e.data.prodShiftOrder,f(o)}},showAddOrderDialog:function(){var t=this,i=this.popover.item;e(["app/prodShiftOrders/views/ProdShiftOrderFormView","app/prodShiftOrders/ProdShiftOrder"],function(e,o){var r=new o({prodShift:t.prodShift.id,master:t.prodShift.get("master"),leader:t.prodShift.get("leader"),operator:t.prodShift.get("operator"),operators:t.prodShift.get("operators"),workerCount:1,quantityDone:0,startedAt:new Date(i.starting_time),finishedAt:new Date(i.ending_time)}),n=r.getNlsDomain();a.showDialog(new e({dialogClassName:"has-panel",model:r,editMode:!1,formMethod:"POST",formAction:r.url(),formActionText:d(n,"FORM:ACTION:add"),failureText:d(n,"FORM:ERROR:addFailure"),panelTitleText:d(n,"PANEL:TITLE:addForm"),done:function(){a.closeDialog()}}))})},showAddDowntimeDialog:function(){var t=this,i=this.popover.item;e(["app/prodDowntimes/views/ProdDowntimeFormView","app/prodDowntimes/ProdDowntime"],function(e,o){var r=new o({prodShift:t.prodShift.id,prodShiftOrder:"working"===i.type?i.data._id:null,master:t.prodShift.get("master"),leader:t.prodShift.get("leader"),operator:t.prodShift.get("operator"),operators:t.prodShift.get("operators"),startedAt:new Date(i.starting_time),finishedAt:new Date(i.ending_time),status:"undecided"}),n=r.getNlsDomain();a.showDialog(new e({dialogClassName:"has-panel",model:r,editMode:!1,formMethod:"POST",formAction:r.url(),formActionText:d(n,"FORM:ACTION:add"),failureText:d(n,"FORM:ERROR:addFailure"),panelTitleText:d(n,"PANEL:TITLE:addForm"),done:function(){a.closeDialog()}}))})},showEditDialog:function(t,i){var o=t.get(this.popover.item.data._id);o&&this.promised(o.fetch()).then(function(){e([i],function(e){var t=o.getNlsDomain();a.showDialog(new e({dialogClassName:"has-panel",model:o,editMode:!0,formMethod:"PUT",formAction:o.url(),formActionText:d(t,"FORM:ACTION:edit"),failureText:d(t,"FORM:ERROR:editFailure"),panelTitleText:d(t,"PANEL:TITLE:editForm"),done:function(){a.closeDialog()}}))})})},showDeleteDialog:function(t){var i=t.get(this.popover.item.data._id);i&&this.promised(i.fetch()).then(function(){e(["app/core/views/ActionFormView"],function(e){e.showDeleteDialog({model:i})})})}})});