// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","select2","app/user","app/data/mrpControllers","app/core/views/FilterView","app/core/util/fixTimeRange","app/orgUnits/views/OrgUnitPickerView","app/users/ownMrps","app/prodShifts/templates/filter"],function(t,e,r,i,a,n,s,o,p,u){"use strict";return n.extend({template:u,events:t.assign({},p.events,n.prototype.events),defaultFormData:{date:"",shift:0,orderMrp:""},termToForm:{date:function(t,e,r){s.toFormData(r,e,"date")},shift:function(t,e,r){r[t]=e.args[1]},orderMrp:function(t,e,r){r[t]=Array.isArray(e.args[1])?e.args[1].join(","):""}},initialize:function(){n.prototype.initialize.apply(this,arguments),this.setView("#"+this.idPrefix+"-orgUnit",new o({filterView:this}))},serialize:function(){return t.assign(n.prototype.serialize.apply(this,arguments),{showOwnMrps:p.hasAny()})},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.toggleButtonGroup("shift"),this.$id("orderMrp").select2({width:"300px",multiple:!0,allowClear:!0,data:this.getApplicableMrps(),matcher:function(t,r,i){return e().select2.defaults.matcher(t,i.id)||e().select2.defaults.matcher(t,r)},formatResult:function(t,e,i,a){if(!t.id)return a(t.text);var n=[];return r.util.markMatch(t.id,i.term,n,a),n.push(": "),r.util.markMatch(t.text,i.term,n,a),n.join("")},formatSelection:function(t){return t.id}})},getApplicableMrps:function(){return a.filter(function(t){return!t.get("deactivatedAt")}).map(function(t){return{id:t.id,text:t.get("description")}})},serializeFormToQuery:function(t){var e=s.fromView(this),r=parseInt(this.$('input[name="shift"]:checked').val(),10),i=this.$id("orderMrp").val();r&&t.push({name:"eq",args:["shift",r]}),e.from&&t.push({name:"ge",args:["date",e.from]}),e.to&&t.push({name:"le",args:["date",e.to]}),i&&i.length&&t.push({name:"in",args:["orderMrp",i.split(",")]})}})});