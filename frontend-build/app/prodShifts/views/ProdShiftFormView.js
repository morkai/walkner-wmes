// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/idAndLabel","app/data/prodLines","app/users/util/setUpUserSelect2","app/prodChangeRequests/util/isChangeRequest","app/prodShifts/templates/form"],function(e,t,s,r,i,a,o,n,d,p,l){"use strict";return a.extend({template:l,serialize:function(){return e.extend(a.prototype.serialize.call(this),{isChangeRequest:p()})},afterRender:function(){a.prototype.afterRender.call(this),this.setUpProdLineField(),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),this.options.editMode&&(this.$id("date").attr("disabled",!0),this.$('input[name="shift"]').attr("disabled",!0))},setUpProdLineField:function(){this.options.editMode?this.$id("prodLine").addClass("form-control").attr("disabled",!0):this.$id("prodLine").select2({data:n.map(o)})},setUpUserSelect2:function(e){var t=d(this.$id(e)),s=this.model.get(e);s&&s.id&&s.label&&t.select2("data",{id:s.id,text:s.label})},serializeToForm:function(){var e=this.model.toJSON();return e.date=r.format(e.date,"YYYY-MM-DD"),e.requestComment="",e},serializeForm:function(e){return this.options.editMode||(e.shift=parseInt(e.shift,10)),e.master=this.serializeUserInfo("master"),e.leader=this.serializeUserInfo("leader"),e.operator=this.serializeUserInfo("operator"),e.operators=e.operator?[e.operator]:[],e.quantitiesDone=e.quantitiesDone.map(function(e){return{planned:parseInt(e.planned,10),actual:parseInt(e.actual,10)}}),e},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleSuccess:function(){return p()?this.options.editMode?(this.broker.subscribe("router.executing").setLimit(1).on("message",function(){i.msg.show({type:"success",time:5e3,text:t("prodShifts","changeRequest:msg:success:edit")})}),a.prototype.handleSuccess.apply(this,arguments)):(window.scrollTo(0,0),this.model.set(e.result(this.model,"defaults")),this.render(),this.hideErrorMessage(),void(this.$errorMessage=i.msg.show({type:"success",time:2500,text:t("prodShifts","changeRequest:msg:success:add")}))):a.prototype.handleSuccess.apply(this,arguments)},handleFailure:function(e){var s=e.responseJSON;s&&s.error&&t.has("prodShifts","FORM:ERROR:"+s.error.message)?this.showErrorMessage(t("prodShifts","FORM:ERROR:"+s.error.message)):p()?this.showErrorMessage(t("prodShifts","changeRequest:msg:failure:"+(this.options.editMode?"edit":"add"))):a.prototype.handleFailure.apply(this,arguments)}})});