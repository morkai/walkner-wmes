define(["underscore","app/i18n","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/idAndLabel","app/data/prodLines","app/users/util/setUpUserSelect2","app/prodChangeRequests/util/isChangeRequest","app/prodShifts/templates/form"],function(e,t,s,i,r,a,o,n,d,p,l){"use strict";return a.extend({template:l,serialize:function(){return e.assign(a.prototype.serialize.call(this),{isChangeRequest:p()})},afterRender:function(){a.prototype.afterRender.call(this),this.setUpProdLineField(),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operators",!0),this.options.editMode&&(this.$id("date").attr("disabled",!0),this.$('input[name="shift"]').attr("disabled",!0))},setUpProdLineField:function(){this.options.editMode?this.$id("prodLine").addClass("form-control").attr("disabled",!0):this.$id("prodLine").select2({data:n.map(o)})},setUpUserSelect2:function(e,t){var s=d(this.$id(e),{multiple:!!t}),i=this.model.get(e);Array.isArray(i)?s.select2("data",i.map(function(e){return{id:e.id,text:e.label}})):i&&i.id&&i.label&&s.select2("data",{id:i.id,text:i.label})},serializeToForm:function(){var e=this.model.toJSON();return e.date=i.format(e.date,"YYYY-MM-DD"),e.requestComment="",e},serializeForm:function(e){return this.options.editMode||(e.shift=parseInt(e.shift,10)),e.master=this.serializeUserInfo("master"),e.leader=this.serializeUserInfo("leader"),e.operators=this.serializeUserInfo("operators"),e.operator=e.operators.length?e.operators[0]:null,e.quantitiesDone=e.quantitiesDone.map(function(e){return{planned:parseInt(e.planned,10),actual:parseInt(e.actual,10)}}),e},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return Array.isArray(t)?t.map(function(e){return{id:e.id,label:e.text}}):null===t?null:{id:t.id,label:t.text}},handleSuccess:function(){return p()?this.options.editMode?(this.broker.subscribe("router.executing").setLimit(1).on("message",function(){r.msg.show({type:"success",time:5e3,text:t("prodShifts","changeRequest:msg:success:edit")})}),a.prototype.handleSuccess.apply(this,arguments)):(window.scrollTo(0,0),this.model.set(e.result(this.model,"defaults")),this.render(),this.hideErrorMessage(),void(this.$errorMessage=r.msg.show({type:"success",time:2500,text:t("prodShifts","changeRequest:msg:success:add")}))):a.prototype.handleSuccess.apply(this,arguments)},handleFailure:function(e){var s=e.responseJSON;s&&s.error&&t.has("prodShifts","FORM:ERROR:"+s.error.message)?this.showErrorMessage(t("prodShifts","FORM:ERROR:"+s.error.message)):p()?this.showErrorMessage(t("prodShifts","changeRequest:msg:failure:"+(this.options.editMode?"edit":"add"))):a.prototype.handleFailure.apply(this,arguments)}})});