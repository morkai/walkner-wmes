define(["underscore","jquery","../i18n","../user","../time","../socket","../viewport","../core/Model","../core/util/getShiftStartInfo","../data/downtimeReasons","../data/subdivisions","../data/workCenters","../data/prodFlows","../data/prodLines","../data/prodLog","../data/localStorage","../prodLines/ProdLine","../prodDowntimes/ProdDowntime","../prodDowntimes/ProdDowntimeCollection","../prodShiftOrders/ProdShiftOrder","../prodShiftOrders/ProdShiftOrderCollection","../isa/IsaRequestCollection","../production/settings","../production/snManager","../production/Execution","app/core/templates/userInfo"],function(t,e,r,i,n,o,s,a,d,h,u,l,f,c,p,g,m,S,D,w,O,y,v,T,C,L){"use strict";return a.extend({urlRoot:"/prodShifts",clientUrlRoot:"#prodShifts",topicPrefix:"prodShifts",privilegePrefix:"PROD_DATA",nlsDomain:"prodShifts",defaults:function(){return{division:null,subdivision:null,mrpControllers:null,prodFlow:null,workCenter:null,prodLine:null,date:null,shift:null,state:null,quantitiesDone:[{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0}],creator:null,createdAt:null,master:null,leader:null,operator:null,operators:null}},initialize:function(t,e){e&&e.production&&(this.nlsDomain="production",window.WMES_LINE_ID=this.get("prodLine"),window.WMES_STATION=this.get("station")||0,this.prodLine=c.get(window.WMES_LINE_ID),this.prodLine||(this.prodLine=new m({_id:null})),this.prodLine.station=window.WMES_STATION,this.shiftChangeTimer=null,this.settings=v.acquire({localStorage:!0}),this.prodShiftOrder=new w(null,{settings:this.settings}),this.prodDowntimes=new D(null,{paginate:!1,rqlQuery:"sort(-startedAt)&limit(8)&prodLine="+encodeURIComponent(this.prodLine.id)}),this.isaRequests=y.activeForLine(this.prodLine.id),this.execution=new C(null,{prodLineId:this.prodLine.id}))},serialize:function(e){var i=this.toJSON();if(i.createdAt=n.format(i.createdAt,"LL, LTS"),i.creator=L({userInfo:i.creator}),i.date=n.format(i.date,"L"),i.shift=i.shift?r("core","SHIFT:"+i.shift):"?",e.orgUnits){var o=u.get(i.subdivision),s=f.get(i.prodFlow),a={};t.forEach(i.orderMrp,function(t){a[t]=1}),t.forEach(i.mrpControllers,function(t){a[t]=1}),i.subdivision=o?o.getLabel():"?",i.prodFlow=s?s.getLabel():"?",i.mrpControllers=t.map(a,function(e,r){return i.orderMrp&&i.orderMrp.length&&!t.includes(i.orderMrp,r)?'<span style="text-decoration: line-through">'+r+"</span>":r}).join("; ")}if(e.personnel&&(i.master=L({userInfo:i.master}),i.leader=L({userInfo:i.leader}),Array.isArray(i.operators)&&i.operators.length?i.operator=i.operators.map(function(t){return L({userInfo:t})}).join("; "):i.operator=L({userInfo:i.operator})),e.totalQuantityDone){var d={planned:0,actual:0};t.forEach(i.quantitiesDone,function(t){d.planned+=t.planned,d.actual+=t.actual}),i.totalQuantityDone=r("prodShifts","totalQuantityDone",d)}return i.efficiency=Math.round(100*i.efficiency)+"%",i.orderMrp=Array.isArray(i.orderMrp)?i.orderMrp.join("; "):"",i},serializeDetails:function(){return this.serialize({orgUnits:!0,personnel:!0,totalQuantityDone:!0})},serializeRow:function(){var t=this.serialize({orgUnits:!0,totalQuantityDone:!0}),e=this.get("efficiency");return this.get("working")&&(t.className=e>=1?"success":e<.9?"danger":"warning"),t},startShiftChangeMonitor:function(){this.stopShiftChangeMonitor(),this.shiftChangeTimer=setTimeout(function(t){t.shiftChangeTimer=null,t.changeShift(),t.trigger("second")},1e3,this)},stopShiftChangeMonitor:function(){null!==this.shiftChangeTimer&&(clearTimeout(this.shiftChangeTimer),this.shiftChangeTimer=null)},readLocalData:function(e){if(!this.isLocked()){var r=null;try{r=this.constructor.parse(e||JSON.parse(g.getItem(this.getDataStorageKey()))),this.prodShiftOrder.clear(),r.prodShiftOrder&&this.prodShiftOrder.set(w.parse(r.prodShiftOrder)),this.prodDowntimes.reset((r.prodDowntimes||[]).map(S.parse),{silent:!0}),delete r.prodShiftOrder,delete r.prodDowntimes}catch(t){}t.isEmpty(r)||(this.prodDowntimes.findFirstUnfinished()?r.state="downtime":this.prodShiftOrder.id?r.state="working":r.state="idle",this.set(r)),e&&this.saveLocalData(),this.prodDowntimes.length&&this.prodDowntimes.trigger("reset"),this.changeShift()}},saveLocalData:function(){if(!this.isLocked()){var t=this.toJSON();delete t.division,delete t.subdivision,delete t.mrpControllers,delete t.prodFlow,delete t.workCenter,delete t.prodLine,t.prodShiftOrder=this.prodShiftOrder.toJSON(),t.prodDowntimes=this.prodDowntimes.toJSON(),g.setItem(this.getDataStorageKey(),JSON.stringify(t))}},changeShift:function(){var t=this.getCurrentShiftMoment().toDate(),e=this.get("date");return e&&t.getTime()<=e.getTime()?this.startShiftChangeMonitor():o.isConnected()?this.startNewShiftIfNecessary(t):void this.startNewShift(t)},startNewShiftIfNecessary:function(t){var e=this;this.findExistingShift(t,function(r){r?e.readLocalData(r):e.startNewShift(t)})},findExistingShift:function(t,r){var i=e.ajax({url:"/prodShifts?prodLine="+this.get("prodLine")+"&date="+t.getTime()});i.fail(function(){r(null)}),i.done(function(t){if(!t||!t.totalCount||!Array.isArray(t.collection))return r(null);var n=t.collection[0];n.nextOrder=null;var o=e.ajax({url:"/prodShiftOrders?prodShift="+n._id+"&finishedAt=null&sort(-startedAt)"}),s=e.ajax({url:"/prodDowntimes?prodLine="+n.prodLine+"&sort(-startedAt)&limit(8)"});(i=e.when(o,s)).fail(function(){r(null)}),i.done(function(t,e){var i=t[0].collection,o=e[0].collection;n.prodShiftOrder=i&&i[0]?i[0]:null,n.prodDowntimes=Array.isArray(o)?o:[],r(n)})})},startNewShift:function(t){T.clear();var e=this.id||null;this.finishDowntime(!1),this.finishOrder(),this.prodShiftOrder.onShiftChanged(),this.set({date:t,shift:this.getCurrentShift(),state:"idle",quantitiesDone:[{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0}],creator:i.getInfo(),createdAt:new Date,master:null,leader:null,operator:null,operators:null,nextOrder:null}),this.set("_id",p.generateId(this.get("createdAt"),this.prodLine.id)),p.record(this,"changeShift",{finishedProdShiftId:e,startedProdShift:this.toJSON()}),this.startShiftChangeMonitor()},changeMaster:function(t){this.changePersonnel("changeMaster","master",t)},changeLeader:function(t){this.changePersonnel("changeLeader","leader",t)},changeOperators:function(e){var r=this.get("operators");t.isEqual(e,r)||(this.set({operator:e.length?e[0]:null,operators:e}),this.onPersonnelChanged("operator"),p.record(this,"changeOperators",{personnel:e}))},changePersonnel:function(t,e,r){var i=this.get(e);i===r||i&&r&&i.id===r.id||(this.set(e,r),this.onPersonnelChanged(e),p.record(this,t,r))},onPersonnelChanged:function(t){var e={};e[t]=this.get(t),"operator"===t&&(e.operators=this.get("operators")),this.prodShiftOrder.id&&this.prodShiftOrder.set(e);var r=this.prodDowntimes.findFirstUnfinished();r&&r.set(e)},changeCurrentQuantitiesDone:function(t){this.changeQuantitiesDone(this.getCurrentQuantityDoneHourIndex(),t)},changeQuantitiesDone:function(t,e,r){("number"!=typeof e||isNaN(e))&&(e=0);var i=this.get("quantitiesDone");if(!i[t])throw new Error("Invalid hour: "+t);i[t].actual!==e&&(i[t].actual=e,this.trigger("change:quantitiesDone",this,i,r||{}),r&&!1===r.record||p.record(this,"changeQuantitiesDone",{hour:t,newValue:e}))},changeOrder:function(t,e,r){var i=Date.now();this.finishOrder(new Date(i-1)),this.set({state:"working",nextOrder:this.getNextOrders().filter(function(e){return e.order.no!==t.no})});var n=this.prodShiftOrder.get("orderId");this.prodShiftOrder.onOrderChanged(this,t,e,r>0?r:0),p.record(this,"changeOrder",this.prodShiftOrder.toJSON(),new Date(i)),this.execution.startOrder(this.prodShiftOrder),n!==this.prodShiftOrder.get("orderId")&&this.autoStartDowntime()},correctOrder:function(t,e){if(!this.hasOrder())throw new Error("Cannot correct the order: no order is started!");var r=this.prodShiftOrder.onOrderCorrected(this,t,e);r&&(p.record(this,"correctOrder",r),this.execution.updateOrder(this.prodShiftOrder),this.trigger("orderCorrected"))},setNextOrder:function(e){var r=this.get("nextOrder"),i=t.isEmpty(e);if(!i||!t.isEmpty(r)){var n=r?r.map(s).filter(a):[],o=e?e.map(s).filter(a):[];t.isEqual(o,n)||(i&&(e=[],o=[]),this.set("nextOrder",e),p.record(this,"setNextOrder",{orders:o}))}function s(t){return{orderNo:t.order&&t.order.no||t.orderNo,operationNo:t.operationNo,workerCount:t.workerCount||0}}function a(t){return"string"==typeof t.orderNo}},continueOrder:function(){if(this.hasOrder())throw new Error("Cannot continue the order: an order is already started!");if(!this.prodShiftOrder.hasOrderData())throw new Error("Cannot continue the order: no order data!");this.set("state","working"),this.prodShiftOrder.onOrderContinued(this),p.record(this,"changeOrder",this.prodShiftOrder.toJSON()),this.execution.startOrder(this.prodShiftOrder)},changeQuantityDone:function(t){if(!this.hasOrder())throw new Error("Cannot change the quantity done: no prod shift order!");("number"!=typeof t||isNaN(t))&&(t=0),t!==this.prodShiftOrder.get("quantityDone")&&(this.prodShiftOrder.set("quantityDone",t),p.record(this,"changeQuantityDone",{newValue:t}),this.execution.updateOrder(this.prodShiftOrder))},changeWorkerCount:function(t){if(!this.hasOrder())throw new Error("Cannot change the worker count: no prod shift order!");("number"!=typeof t||isNaN(t))&&(t=0),t!==this.prodShiftOrder.get("workerCount")&&(this.prodShiftOrder.set("workerCount",t),this.prodShiftOrder.set("sapTaktTime",this.prodShiftOrder.getSapTaktTime()),p.record(this,"changeWorkerCount",{newValue:t,sapTaktTime:this.prodShiftOrder.get("sapTaktTime")}),this.execution.updateOrder(this.prodShiftOrder))},endDowntime:function(){this.hasOrder()?this.set("state","working"):this.set("state","idle");var t=this.prodDowntimes.findFirstUnfinished();this.finishDowntime()?this.startNextAutoDowntime(t):this.saveLocalData()},endWork:function(){this.finishDowntime(),this.finishOrder(),this.set("state","idle"),this.prodShiftOrder.onWorkEnded(),p.record(this,"endWork",{})},startDowntime:function(t){if("working"===this.get("state")){var e=this.prodDowntimes.addFromInfo(this,t);this.set("state","downtime"),p.record(this,"startDowntime",e.toJSON()),this.execution.startDowntime(e)}},finishOrder:function(t){var e=this.prodShiftOrder.finish();return!!e&&(p.record(this,"finishOrder",e,t),this.execution.updateOrder(this.prodShiftOrder),!0)},finishDowntime:function(){var t=this.prodDowntimes.finish();return t&&(p.record(this,"finishDowntime",t),this.execution.updateDowntime(this.prodDowntimes.first())),!!t},editDowntime:function(t,e){t.set(e),(e=t.changedAttributes())&&(e._id=t.id,p.record(this,"editDowntime",e),this.execution.updateDowntime(t))},isTaktTimeEnabled:function(){return!this.isLocked()&&this.settings.isTaktTimeEnabled(this.prodLine.id)},updateTaktTimeLocally:function(t){this.updateTaktTime(T.getLocalTaktTime(t.data,this.prodShiftOrder,this.getCurrentQuantityDoneHourIndex())),p.record(this,t)},updateTaktTime:function(t){T.add(t.serialNumber);var e=this.get("quantitiesDone");e||(e=this.attributes.quantitiesDone=[{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0},{planned:0,actual:0}]),e[t.hourlyQuantityDone.index].actual=t.hourlyQuantityDone.value,this.trigger("change:quantitiesDone",this,e,{}),t.serialNumber.prodShiftOrder&&t.serialNumber.prodShiftOrder!==this.prodShiftOrder.id||(this.prodShiftOrder.set({quantityDone:t.quantityDone,lastTaktTime:t.lastTaktTime,avgTaktTime:t.avgTaktTime}),this.execution.updateOrder(this.prodShiftOrder)),this.saveLocalData()},checkSpigot:function(t,e){var r,i=this.prodShiftOrder.get("spigot"),n=!1;if(t)i?r=i.prodDowntime:(r=this.prodDowntimes.findFirstUnfinished()||this.prodDowntimes.first()||null)&&(r=r.id);else{if(!i)return!0;r=i.prodDowntime,t=i.component,n=!0}var o=this.checkSpigotValidity(e,t.nc12);return o&&this.prodShiftOrder.set("spigot",{prodDowntime:r,component:t,initial:!0,final:n}),p.record(this,"checkSpigot",{final:n,valid:o,nc12:e,component:t,prodDowntime:r}),o},checkSpigotValidity:function(t,e){if(t===e)return!0;var r={};return(this.settings.getValue("spigotGroups")||"").split("\n").forEach(function(t){var e=t.split(":"),i=e[0].trim();e[1].split(", ").forEach(function(t){r[t.trim()]=i})}),t===r[e]},hasOrder:function(){return!!this.prodShiftOrder.id},getLabel:function(){var t=this.get("prodLine")||"?",e=this.get("date"),i=this.get("shift");return e&&i&&(t+=": "+n.format(this.get("date"),"L"),t+=", "+r("core","SHIFT:"+this.get("shift"))),t},getCurrentTime:function(){return n.getMoment().format("L, LTS")},getCurrentShift:function(){var t=n.getMoment().hour();return t>=6&&t<14?1:t>=14&&t<22?2:3},getCurrentShiftMoment:function(){return d(Date.now()).moment},getTimeToNextShift:function(){return this.getCurrentShiftMoment().add(8,"hours").diff(n.getMoment())},getCurrentQuantityDoneHourIndex:function(){var t=n.getMoment().hours();return t>=6&&t<14?t-6:t>=14&&t<22?t-14:22===t?0:23===t?1:t+2},getCurrentQuantityDoneHourRange:function(){var t=n.getMoment().minutes(0).seconds(0);return t.format("LTS")+"-"+t.minutes(59).seconds(59).format("LTS")},getQuantityDoneInCurrentHour:function(){var t=this.get("quantitiesDone");if(!Array.isArray(t))return 0;var e=this.getCurrentQuantityDoneHourIndex();return e>=t.length?0:t[e].actual},getOrderIdType:function(){return"press"===this.getSubdivisionType()?"nc12":"no"},isIdle:function(){return"idle"===this.get("state")},isDowntime:function(){return"downtime"===this.get("state")},isWorking:function(){return"working"===this.get("state")},getMaxQuantitiesDone:function(){return 150},getSubdivisionType:function(){var t=u.get(this.get("subdivision"));return t?t.get("type"):null},getDowntimeReasons:function(){return h.findBySubdivisionType(this.getSubdivisionType())},getBreakReason:function(){return h.findFirstBreakIdBySubdivisionType(this.getSubdivisionType())},getDefaultAor:function(){var t=this.prodLine.getSubdivision();return t?t.get("aor"):null},isSpigotLine:function(){return-1!==(this.settings.getValue("spigotLines")||"").split(",").indexOf(this.prodLine.id)},getSpigotComponent:function(){return this.prodShiftOrder.getSpigotComponent(this.settings.getValue("spigotPatterns"),this.settings.getValue("spigotNotPatterns"))},getSpigotInsertComponent:function(){return this.prodShiftOrder.getSpigotInsertComponent(this.settings.getValue("spigotInsertGroups"))},getNextOrders:function(){var e=this.get("nextOrder")||[];return Array.isArray(e)||t.isEmpty(e)||(e=[{order:e.orderInfo,operationNo:e.operationNo}]),e},hasOrderQueue:function(){return!t.isEmpty(this.get("nextOrder"))},hasEnded:function(){return n.getMoment(this.get("date")).valueOf()<d(new Date).moment.valueOf()},updateQuantities:function(t,e){var r=this.attributes.quantitiesDone;if(Array.isArray(t)&&8===t.length&&Array.isArray(r)){for(var i=0;i<8;++i)r[i].planned=t[i],r[i].actual=e[i];this.saveLocalData(),this.trigger("change:quantitiesDone",this,this.attributes.quantitiesDone,{})}},updatePlannedQuantities:function(t){if(Array.isArray(t)&&8===t.length&&Array.isArray(this.attributes.quantitiesDone)){for(var e=0;e<8;++e)this.attributes.quantitiesDone[e].planned=t[e];this.saveLocalData(),this.trigger("change:quantitiesDone",this,this.attributes.quantitiesDone,{})}},isLocked:function(){return!p.isEnabled()||!this.prodLine||null===this.getSecretKey()},getSecretKey:function(){var t=g.getItem(this.getSecretKeyStorageKey());return"string"==typeof t?t:null},setSecretKey:function(t,e,r){null===t?(g.removeItem(this.getSecretKeyStorageKey()),g.removeItem(this.getDataStorageKey()),g.removeItem("PRODUCTION:LINE"),this.prodShiftOrder.clear(),this.prodDowntimes.reset(),this.stopShiftChangeMonitor(),this.set({prodLine:null,station:null,date:null,shift:null,state:null,quantitiesDone:null,creator:null,createdAt:null,master:null,leader:null,operator:null,operators:null}),this.trigger("locked")):(g.setItem(this.getSecretKeyStorageKey(e.prodLine),t),e.prodLine&&g.setItem("PRODUCTION:LINE",e.prodLine),g.setItem("PRODUCTION:STATION",e.station||0),r||this.trigger("unlocked"),this.readLocalData(e),r&&window.location.reload())},getSecretKeyStorageKey:function(t){return"PRODUCTION:SECRET_KEY:"+(t||this.prodLine.id)},getDataStorageKey:function(t){return"PRODUCTION:DATA:"+(t||this.prodLine.id)},autoStartDowntime:function(){var e=this.getDefaultAor(),r=u.get(this.get("subdivision"));if(e&&r){var i,n=this.settings.getAutoDowntimes(this.prodLine.id);if(t.isEmpty(n)&&(n=r.get("autoDowntimes")),!t.isEmpty(n))if(this.isBetweenInitialDowntimeWindow(Date.now())&&(i=t.find(n,function(t){return"initial"===t.when})),i||(i=t.find(n,function(t){return"always"===t.when})),i){var o=h.get(i.reason);o&&this.startDowntime({aor:e,reason:o.id,reasonComment:"",auto:{}})}}},startNextAutoDowntime:function(e){if(e){var r=this.getDefaultAor(),i=u.get(this.get("subdivision"));if(r&&i){var n=this.settings.getAutoDowntimes(this.prodLine.id);if(t.isEmpty(n)&&(n=i.get("autoDowntimes")),!t.isEmpty(n)){for(var o,s=e.get("auto"),a=e.get("reason"),d=0;d<n.length;++d){var l=n[d];if(!s||l.reason===a){for(var f=d+1;f<n.length;++f){var c=n[f];if(s&&"always"===c.when||"after"===c.when&&c.after===a){o=c;break}}if(o)break}}if(o){var p=h.get(o.reason);if(p){if("after"===o.when){var g=p.get("aors");Array.isArray(g)&&1===g.length&&(r=g[0])}this.startDowntime({aor:r,reason:p.id,reasonComment:"",auto:{}})}}}}}},isBetweenInitialDowntimeWindow:function(t){var e=parseInt(this.settings.getValue("initialDowntimeWindow"),10),r=this.get("date");if(isNaN(e)||e<1||!r)return!1;var i=r.getTime();return t>=i&&t<=i+60*e*1e3},shouldStartTimedAutoDowntime:function(t){return"working"===this.get("state")&&!this.prodDowntimes.some(function(e){return e.get("reason")===t&&Date.now()-Date.parse(e.get("finishedAt"))<6e5})},startTimedAutoDowntime:function(t,e){if(this.shouldStartTimedAutoDowntime(t)){var r=this.getDefaultAor();r&&(s.closeAllDialogs(),this.startDowntime({aor:r,reason:t,reasonComment:"",auto:{d:e}}))}}},{STATE:{IDLE:"idle",WORKING:"working",DOWNTIME:"downtime"},LINE_STORAGE_KEY:"PRODUCTION:LINE",STATION_STORAGE_KEY:"PRODUCTION:STATION",parse:function(t){return"string"==typeof t.date&&(t.date=new Date(t.date)),"string"==typeof t.createdAt&&(t.createdAt=new Date(t.createdAt)),t},calcEfficiency:function(t,e){if(!t||!e)return-1;var r=0,i=0,n={},o=Date.now();e.forEach(function(t){var e=h.get(t.get("reason"));if(e&&"break"===e.get("type")){var r=t.get("prodShiftOrder");if(r){n[r._id]||(n[r._id]=0);var i=Date.parse(t.get("startedAt")),s=Date.parse(t.get("finishedAt"))||o;n[r._id]+=s-i}}}),t.forEach(function(t){var e=t.get("workDuration"),s=w.getTaktTimeCoeff(t.attributes);e||t.get("finishedAt")||(e=(o-Date.parse(t.get("startedAt"))-(n[t.id]||0))/36e5),r+=t.get("laborTime")*s/100*t.get("quantityDone"),i+=e*t.get("workerCount")});var s=Math.min(999,Math.round(r/i*100));return s>0?s:0}})});