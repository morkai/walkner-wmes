// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/util/bindLoadingMessage","app/core/util/getShiftStartInfo","app/core/util/pageActions","app/core/util/onModelDeleted","app/core/View","app/prodShiftOrders/ProdShiftOrderCollection","app/prodDowntimes/ProdDowntimeCollection","../ProdShift","../views/ProdShiftDetailsView","../views/ProdShiftTimelineView","../views/QuantitiesDoneChartView","app/prodShifts/templates/detailsPage"],function(t,i,e,r,d,o,s,n,h,p,a,f,u,S,l,c,b){return p.extend({template:b,layoutName:"page",pageId:"details",breadcrumbs:function(){return[{label:e.bound("prodShifts","BREADCRUMBS:browse"),href:this.prodShift.genClientUrl("base")},this.prodShift.getLabel()]},actions:function(){var t=[{label:e.bound("prodShifts","PAGE_ACTION:prodLogEntries"),icon:"list-ol",href:"#prodLogEntries?sort(createdAt)&limit(20)&prodShift="+encodeURIComponent(this.prodShift.id)}];return this.prodShift.hasEnded()&&t.push(n.edit(this.prodShift,"PROD_DATA:MANAGE"),n.delete(this.prodShift,"PROD_DATA:MANAGE")),t},initialize:function(){this.defineModels(),this.defineViews(),this.listenToOnce(this.prodShift,"sync",this.setUpRemoteTopics),this.setView(".prodShifts-details-container",this.detailsView),this.setView(".prodShifts-timeline-container",this.timelineView),this.setView(".prodShifts-quantitiesDone-container",this.quantitiesDoneChartView)},defineModels:function(){function t(t,i){return Date.parse(t.get("startedAt"))-Date.parse(i.get("startedAt"))}this.prodShift=o(new u({_id:this.options.modelId}),this),this.prodShiftOrders=o(new a(null,{rqlQuery:{fields:{startedAt:1,finishedAt:1,quantityDone:1,workerCount:1,orderId:1,operationNo:1},sort:{startedAt:1},limit:9999,selector:{name:"and",args:[{name:"eq",args:["prodShift",this.prodShift.id]}]}},comparator:t}),this),this.prodDowntimes=o(new f(null,{rqlQuery:{fields:{prodShiftOrder:1,startedAt:1,finishedAt:1,status:1,reason:1,aor:1},sort:{startedAt:1},limit:9999,selector:{name:"and",args:[{name:"eq",args:["prodShift",this.prodShift.id]}]}},comparator:t}),this)},defineViews:function(){this.detailsView=new S({model:this.prodShift}),this.timelineView=new l({prodShift:this.prodShift,prodShiftOrders:this.prodShiftOrders,prodDowntimes:this.prodDowntimes}),this.quantitiesDoneChartView=new c({model:this.prodShift})},load:function(t){return t(this.prodShift.fetch(),this.prodShiftOrders.fetch({reset:!0}),this.prodDowntimes.fetch({reset:!0}))},setUpRemoteTopics:function(){this.pubsub.subscribe("prodShifts.updated."+this.prodShift.id,this.onProdShiftUpdated.bind(this)),this.pubsub.subscribe("prodShifts.deleted."+this.prodShift.id,this.onProdShiftDeleted.bind(this)),this.pubsub.subscribe("prodShiftOrders.created."+this.prodShift.get("prodLine"),this.onProdShiftOrderCreated.bind(this)),this.pubsub.subscribe("prodShiftOrders.updated.*",this.onProdShiftOrderUpdated.bind(this)),this.pubsub.subscribe("prodShiftOrders.deleted.*",this.onProdShiftOrderDeleted.bind(this)),this.pubsub.subscribe("prodDowntimes.created."+this.prodShift.get("prodLine"),this.onProdDowntimeCreated.bind(this)),this.pubsub.subscribe("prodDowntimes.updated.*",this.onProdDowntimeUpdated.bind(this)),this.pubsub.subscribe("prodDowntimes.deleted.*",this.onProdDowntimeDeleted.bind(this))},onProdShiftUpdated:function(t){this.prodShift.set(t)},onProdShiftDeleted:function(){h(this.broker,this.prodShift,null,!0)},onProdShiftOrderCreated:function(t){t.prodShift===this.prodShift.id&&this.prodShiftOrders.add(t)},onProdShiftOrderUpdated:function(t){var i=this.prodShiftOrders.get(t._id);i&&i.set(t)},onProdShiftOrderDeleted:function(t){var i=this.prodShiftOrders.get(t._id);i&&this.prodShiftOrders.remove(i)},onProdDowntimeCreated:function(t){t.prodShift===this.prodShift.id&&this.prodDowntimes.add(t)},onProdDowntimeUpdated:function(t){var i=this.prodDowntimes.get(t._id);i&&i.set(t)},onProdDowntimeDeleted:function(t){var i=this.prodDowntimes.get(t._id);i&&this.prodDowntimes.remove(i)}})});