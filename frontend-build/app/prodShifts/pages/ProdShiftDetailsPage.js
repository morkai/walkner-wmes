define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/util/bindLoadingMessage","app/core/util/getShiftStartInfo","app/core/View","app/prodLogEntries/ProdLogEntryCollection","../ProdShift","../views/ProdShiftDetailsView","../views/ProdShiftTimelineView","../views/QuantitiesDoneChartView","app/prodShifts/templates/detailsPage"],function(i,t,e,s,o,n,r,d,h,p,a,f,l,c){var u=["changeOrder","finishOrder","startDowntime","finishDowntime","endWork"];return d.extend({template:c,layoutName:"page",pageId:"details",breadcrumbs:function(){return[{label:e.bound("prodShifts","BREADCRUMBS:browse"),href:this.prodShift.genClientUrl("base")},this.prodShift.get("prodLine"),e.bound("prodShifts","BREADCRUMBS:details",{date:s.format(this.prodShift.get("date"),"YYYY-MM-DD"),shift:e("core","SHIFT:"+this.prodShift.get("shift"))})]},actions:function(){var i=[{label:e.bound("prodShifts","PAGE_ACTION:prodLogEntries"),icon:"list-ol",href:"#prodLogEntries?sort(createdAt)&limit(20)&prodShift="+encodeURIComponent(this.prodShift.id)}];return this.prodShift.hasEnded()&&i.push({label:e.bound("prodShifts","PAGE_ACTION:edit"),icon:"edit",href:this.prodShift.genClientUrl("edit"),privilege:"PROD_DATA:MANAGE"}),i},initialize:function(){this.defineModels(),this.defineViews(),this.listenToOnce(this.prodShift,"sync",this.setUpRemoteTopics),this.setView(".prodShifts-details-container",this.detailsView),this.setView(".prodShifts-timeline-container",this.timelineView),this.setView(".prodShifts-quantitiesDone-container",this.quantitiesDoneChartView)},defineModels:function(){this.prodShift=n(new p({_id:this.options.modelId}),this),this.prodLogEntries=n(new h(null,{rqlQuery:{sort:{createdAt:1,type:-1},limit:9999,selector:{name:"and",args:[{name:"eq",args:["prodShift",this.options.modelId]}]}}}),this)},defineViews:function(){this.detailsView=new a({model:this.prodShift}),this.timelineView=new f({collection:this.prodLogEntries}),this.quantitiesDoneChartView=new l({model:this.prodShift})},load:function(i){return i(this.prodShift.fetch(),this.prodLogEntries.fetch({reset:!0}))},setUpRemoteTopics:function(){var i=this.prodShift;this.pubsub.subscribe("production.edited.shift."+i.id,function(t){i.set(t)}),i.hasEnded()||this.pubsub.subscribe("production.synced."+i.get("prodLine"),this.handleProdChanges.bind(this))},handleProdChanges:function(t){i.intersection(t.types,u).length&&this.prodLogEntries.fetch({reset:!0}),t.prodShift&&this.prodShift.set(t.prodShift)}})});