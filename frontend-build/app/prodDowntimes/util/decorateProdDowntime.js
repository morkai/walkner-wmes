// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/user","app/data/aors","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/prodLines","app/data/downtimeReasons","app/data/views/renderOrgUnitPath","app/core/templates/userInfo","./decorateProdDowntimeChange"],function(r,a,o,e,t,s,n,i,d,p,l,m,f){"use strict";return function(n,h){var u=h&&h.longDate?"LLLL":"YYYY-MM-DD, HH:mm:ss",c=n.toJSON();c.statusClassName=n.getCssClassName(),c.statusText=o("prodDowntimes","PROPERTY:status:"+c.status),c.className=c.statusClassName,c.reasonComment&&c.reasonComment.trim().length&&(c.className+=" is-withReasonComment");var g=t.get(c.aor);c.aor=g?g.getLabel():c.aor;var A=d.get(c.prodLine);A&&(c.prodLine=A.getLabel(),c.prodLinePath=l(A,!1,!1));var D=p.get(c.reason);c.reason=D?D.getLabel():c.reason,c.duration=n.getDurationString(h&&h.currentTime),c.startedAt=a.format(c.startedAt,u),c.finishedAt=c.finishedAt?a.format(c.finishedAt,u):o("prodDowntimes","NO_DATA:finishedAt"),c.corroboratedAt=a.format(c.corroboratedAt,u)||"-",c.order=c.prodShiftOrder?c.orderId+"; "+c.operationNo:o("prodDowntimes","NO_DATA:order"),e.isAllowedTo("PROD_DATA:VIEW")&&c.prodShiftOrder&&(c.order='<a href="#prodShiftOrders/'+(c.prodShiftOrder._id||c.prodShiftOrder)+'">'+c.order+"</a>");var b=c.prodShiftOrder;if(b&&b.orderData){var C=b.orderData;c.productName=C.description||C.name,c.productFamily=c.productName.substring(0,6),C.operations&&C.operations[c.operationNo]&&(c.operationName=C.operations[c.operationNo].name)}c.date=c.date?a.format(c.date,"YYYY-MM-DD"):"?",c.shift=c.shift?o("core","SHIFT:"+c.shift):"?",c.prodShiftText=c.date+", "+c.shift,e.isAllowedTo("PROD_DATA:VIEW")&&c.prodShift&&(c.prodShiftText='<a href="#prodShifts/'+c.prodShift+'">'+c.prodShiftText+"</a>"),c.masterInfo=m({userInfo:c.master}),c.leaderInfo=m({userInfo:c.leader}),c.operatorInfo=m({userInfo:c.operator}),c.creatorInfo=m({userInfo:c.creator}),c.corroboratorInfo=m({userInfo:c.corroborator});var w=s.get(c.subdivision),I=i.get(c.prodFlow);c.subdivision=w?w.getLabel():"?",c.prodFlow=I?I.getLabel():"?",c.mrpControllers=Array.isArray(c.mrpControllers)&&c.mrpControllers.length?c.mrpControllers.join("; "):"?",c.history=!Array.isArray(c.changes)||h&&h.noHistory===!0?[]:c.changes.map(f);var N=c.changesCount;return N&&h&&h.changesCount&&(N.reason&&(c.reason+=' <span title="'+o("prodDowntimes","changesCount:reason")+'" class="label label-'+(N.reason>=h.maxReasonChanges?"danger":"warning")+'">'+N.reason+"</span>"),N.aor&&(c.aor+=' <span title="'+o("prodDowntimes","changesCount:aor")+'" class="label label-'+(N.aor>=h.maxAorChanges?"danger":"warning")+'">'+N.aor+"</span>")),h&&h.productFamily&&c.productFamily&&(c.prodFlow='<span class="label label-default" title="'+r.escape(c.productName)+'">'+r.escape(c.productFamily)+"</span> "+c.prodFlow),c}});