// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/user","app/data/aors","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/prodLines","app/data/downtimeReasons","app/data/views/renderOrgUnitPath","app/core/templates/userInfo","app/orders/util/resolveProductName","./decorateProdDowntimeChange"],function(r,a,o,e,t,s,n,d,p,i,l,m,f,u){"use strict";return function(n,c){var h=c&&c.longDate?"LLLL":"L, LTS",g=n.toJSON();g.statusClassName=n.getCssClassName(),g.statusText=o("prodDowntimes","PROPERTY:status:"+g.status),g.className=g.statusClassName,g.reasonComment&&g.reasonComment.trim().length&&(g.className+=" is-withReasonComment");var A=t.get(g.aor);g.aor=A?A.getLabel():g.aor;var C=p.get(g.prodLine);C&&(g.prodLine=C.getLabel(),g.prodLinePath=l(C,!1,!1));var D=i.get(g.reason);g.reason=D?D.getLabel():g.reason,g.duration=n.getDurationString(c&&c.currentTime),g.startedAt=a.format(g.startedAt,h),g.finishedAt=g.finishedAt?a.format(g.finishedAt,h):o("prodDowntimes","NO_DATA:finishedAt"),g.corroboratedAt=a.format(g.corroboratedAt,h)||"-",g.order=g.prodShiftOrder?g.orderId+"; "+g.operationNo:o("prodDowntimes","NO_DATA:order"),e.isAllowedTo("PROD_DATA:VIEW")&&g.prodShiftOrder&&(g.order='<a href="#prodShiftOrders/'+(g.prodShiftOrder._id||g.prodShiftOrder)+'">'+g.order+"</a>");var b=s.get(g.subdivision),w=d.get(g.prodFlow);g.subdivision=b?b.getLabel():"?",g.prodFlow=w?w.getLabel():"?",g.mrpControllers=Array.isArray(g.mrpControllers)&&g.mrpControllers.length?g.mrpControllers.join("; "):"?";var N=g.prodShiftOrder;if(g.orderData?(g.productName=g.orderData.name,g.productFamily=g.orderData.family,g.orderMrp='<span title="'+g.mrpControllers+'">'+(g.orderData.mrp||"")+"</span>"):g.orderMrp="<em>"+g.mrpControllers+"</em>",N&&N.orderData){var L=N.orderData;g.orderData||(g.productName=f(L),g.productFamily=g.productName.substring(0,6)),L.operations&&L.operations[g.operationNo]&&(g.operationName=L.operations[g.operationNo].name)}g.date=g.date?a.format(g.date,"L"):"?",g.shift=g.shift?o("core","SHIFT:"+g.shift):"?",g.prodShiftText=g.date+", "+g.shift,e.isAllowedTo("PROD_DATA:VIEW")&&g.prodShift&&(g.prodShiftText='<a href="#prodShifts/'+g.prodShift+'">'+g.prodShiftText+"</a>"),g.masterInfo=m({userInfo:g.master}),g.leaderInfo=m({userInfo:g.leader}),g.operatorInfo=m({userInfo:g.operator}),g.creatorInfo=m({userInfo:g.creator}),g.corroboratorInfo=m({userInfo:g.corroborator}),g.history=!Array.isArray(g.changes)||c&&c.noHistory===!0?[]:g.changes.map(u);var S=g.changesCount;return S&&c&&c.changesCount&&(S.reason&&(g.reason+=' <span title="'+o("prodDowntimes","changesCount:reason")+'" class="label label-'+(S.reason>=c.maxReasonChanges?"danger":"warning")+'">'+S.reason+"</span>"),S.aor&&(g.aor+=' <span title="'+o("prodDowntimes","changesCount:aor")+'" class="label label-'+(S.aor>=c.maxAorChanges?"danger":"warning")+'">'+S.aor+"</span>")),c&&c.productFamily&&g.productFamily&&(g.prodFlow='<span class="label label-default" title="'+r.escape(g.productName)+'">'+r.escape(g.productFamily)+"</span> "+g.prodFlow),g}});