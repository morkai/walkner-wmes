// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/time","app/i18n","app/user","app/data/aors","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/prodLines","app/data/downtimeReasons","app/data/views/renderOrgUnitPath","app/core/templates/userInfo","./decorateProdDowntimeChange"],function(r,e,a,o,t,s,n,i,d,p,l,f){"use strict";return function(s,m){var h=m&&m.longDate?"LLLL":"YYYY-MM-DD, HH:mm:ss",g=s.toJSON();g.statusClassName=s.getCssClassName(),g.statusText=e("prodDowntimes","PROPERTY:status:"+g.status),g.className=g.statusClassName,g.reasonComment&&g.reasonComment.trim().length&&(g.className+=" is-withReasonComment");var u=o.get(g.aor);g.aor=u?u.getLabel():g.aor;var c=i.get(g.prodLine);c&&(g.prodLine=c.getLabel(),g.prodLinePath=p(c,!1,!1));var A=d.get(g.reason);g.reason=A?A.getLabel():g.reason,g.duration=s.getDurationString(m&&m.currentTime),g.startedAt=r.format(g.startedAt,h),g.finishedAt=g.finishedAt?r.format(g.finishedAt,h):e("prodDowntimes","NO_DATA:finishedAt"),g.corroboratedAt=r.format(g.corroboratedAt,h)||"-",g.order=g.prodShiftOrder?g.orderId+"; "+g.operationNo:e("prodDowntimes","NO_DATA:order"),a.isAllowedTo("PROD_DATA:VIEW")&&g.prodShiftOrder&&(g.order='<a href="#prodShiftOrders/'+g.prodShiftOrder+'">'+g.order+"</a>"),g.date=g.date?r.format(g.date,"YYYY-MM-DD"):"?",g.shift=g.shift?e("core","SHIFT:"+g.shift):"?",g.prodShiftText=g.date+", "+g.shift,a.isAllowedTo("PROD_DATA:VIEW")&&g.prodShift&&(g.prodShiftText='<a href="#prodShifts/'+g.prodShift+'">'+g.prodShiftText+"</a>"),g.masterInfo=l({userInfo:g.master}),g.leaderInfo=l({userInfo:g.leader}),g.operatorInfo=l({userInfo:g.operator}),g.creatorInfo=l({userInfo:g.creator}),g.corroboratorInfo=l({userInfo:g.corroborator});var C=t.get(g.subdivision),D=n.get(g.prodFlow);g.subdivision=C?C.getLabel():"?",g.prodFlow=D?D.getLabel():"?",g.mrpControllers=Array.isArray(g.mrpControllers)&&g.mrpControllers.length?g.mrpControllers.join("; "):"?",g.history=!Array.isArray(g.changes)||m&&m.noHistory===!0?[]:g.changes.map(f);var b=g.changesCount;return b&&m&&m.changesCount&&(b.reason&&(g.reason+=' <span title="'+e("prodDowntimes","changesCount:reason")+'" class="label label-'+(b.reason>=m.maxReasonChanges?"danger":"warning")+'">'+b.reason+"</span>"),b.aor&&(g.aor+=' <span title="'+e("prodDowntimes","changesCount:aor")+'" class="label label-'+(b.aor>=m.maxAorChanges?"danger":"warning")+'">'+b.aor+"</span>")),g}});