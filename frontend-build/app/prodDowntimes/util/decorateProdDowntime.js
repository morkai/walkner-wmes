// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/time","app/i18n","app/user","app/data/aors","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/prodLines","app/data/downtimeReasons","app/data/views/renderOrgUnitPath","app/core/templates/userInfo","./decorateProdDowntimeChange"],function(r,t,e,o,a,s,d,i,n,p,f,l){"use strict";return function(s,m){var h=m&&m.longDate?"LLLL":"YYYY-MM-DD, HH:mm:ss",A=s.toJSON();A.statusClassName=s.getCssClassName(),A.statusText=t("prodDowntimes","PROPERTY:status:"+A.status),A.className=A.statusClassName,A.reasonComment&&A.reasonComment.trim().length&&(A.className+=" is-withReasonComment");var u=o.get(A.aor);A.aor=u?u.getLabel():A.aor;var g=i.get(A.prodLine);g&&(A.prodLine=g.getLabel(),A.prodLinePath=p(g,!1,!1));var D=n.get(A.reason);if(A.reason=D?D.getLabel():A.reason,A.startedAt&&A.finishedAt){var c=Date.parse(A.startedAt),I=Date.parse(A.finishedAt),C=Math.round((I-c)/1e3);A.duration=r.toString(C)}else A.duration="-";A.startedAt=r.format(A.startedAt,h),A.finishedAt=A.finishedAt?r.format(A.finishedAt,h):t("prodDowntimes","NO_DATA:finishedAt"),A.corroboratedAt=r.format(A.corroboratedAt,h)||"-",A.order=A.prodShiftOrder?A.orderId+"; "+A.operationNo:t("prodDowntimes","NO_DATA:order"),e.isAllowedTo("PROD_DATA:VIEW")&&A.prodShiftOrder&&(A.order='<a href="#prodShiftOrders/'+A.prodShiftOrder+'">'+A.order+"</a>"),A.date=A.date?r.format(A.date,"YYYY-MM-DD"):"?",A.shift=A.shift?t("core","SHIFT:"+A.shift):"?",A.prodShiftText=A.date+", "+A.shift,e.isAllowedTo("PROD_DATA:VIEW")&&A.prodShift&&(A.prodShiftText='<a href="#prodShifts/'+A.prodShift+'">'+A.prodShiftText+"</a>"),A.masterInfo=f({userInfo:A.master}),A.leaderInfo=f({userInfo:A.leader}),A.operatorInfo=f({userInfo:A.operator}),A.creatorInfo=f({userInfo:A.creator}),A.corroboratorInfo=f({userInfo:A.corroborator});var L=a.get(A.subdivision),S=d.get(A.prodFlow);return A.subdivision=L?L.getLabel():"?",A.prodFlow=S?S.getLabel():"?",A.mrpControllers=Array.isArray(A.mrpControllers)&&A.mrpControllers.length?A.mrpControllers.join("; "):"?",A.history=!Array.isArray(A.changes)||m&&m.noHistory===!0?[]:A.changes.map(l),A}});