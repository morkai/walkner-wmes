// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/user","app/data/aors","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/prodLines","app/data/downtimeReasons","app/data/views/renderOrgUnitPath","app/core/templates/userInfo","./decorateProdDowntimeChange"],function(r,a,o,e,t,s,n,d,i,p,l,m,f){"use strict";return function(n,u){var c=u&&u.longDate?"LLLL":"L, LTS",h=n.toJSON();h.statusClassName=n.getCssClassName(),h.statusText=o("prodDowntimes","PROPERTY:status:"+h.status),h.className=h.statusClassName,h.reasonComment&&h.reasonComment.trim().length&&(h.className+=" is-withReasonComment");var g=t.get(h.aor);h.aor=g?g.getLabel():h.aor;var A=i.get(h.prodLine);A&&(h.prodLine=A.getLabel(),h.prodLinePath=l(A,!1,!1));var C=p.get(h.reason);h.reason=C?C.getLabel():h.reason,h.duration=n.getDurationString(u&&u.currentTime),h.startedAt=a.format(h.startedAt,c),h.finishedAt=h.finishedAt?a.format(h.finishedAt,c):o("prodDowntimes","NO_DATA:finishedAt"),h.corroboratedAt=a.format(h.corroboratedAt,c)||"-",h.order=h.prodShiftOrder?h.orderId+"; "+h.operationNo:o("prodDowntimes","NO_DATA:order"),e.isAllowedTo("PROD_DATA:VIEW")&&h.prodShiftOrder&&(h.order='<a href="#prodShiftOrders/'+(h.prodShiftOrder._id||h.prodShiftOrder)+'">'+h.order+"</a>");var D=s.get(h.subdivision),b=d.get(h.prodFlow);h.subdivision=D?D.getLabel():"?",h.prodFlow=b?b.getLabel():"?",h.mrpControllers=Array.isArray(h.mrpControllers)&&h.mrpControllers.length?h.mrpControllers.join("; "):"?";var w=h.prodShiftOrder;if(h.orderData?(h.productName=h.orderData.name,h.productFamily=h.orderData.family,h.orderMrp='<span title="'+h.mrpControllers+'">'+(h.orderData.mrp||"")+"</span>"):h.orderMrp="<em>"+h.mrpControllers+"</em>",w&&w.orderData){var L=w.orderData;h.orderData||(h.productName=L.description||L.name,h.productFamily=h.productName.substring(0,6)),L.operations&&L.operations[h.operationNo]&&(h.operationName=L.operations[h.operationNo].name)}h.date=h.date?a.format(h.date,"L"):"?",h.shift=h.shift?o("core","SHIFT:"+h.shift):"?",h.prodShiftText=h.date+", "+h.shift,e.isAllowedTo("PROD_DATA:VIEW")&&h.prodShift&&(h.prodShiftText='<a href="#prodShifts/'+h.prodShift+'">'+h.prodShiftText+"</a>"),h.masterInfo=m({userInfo:h.master}),h.leaderInfo=m({userInfo:h.leader}),h.operatorInfo=m({userInfo:h.operator}),h.creatorInfo=m({userInfo:h.creator}),h.corroboratorInfo=m({userInfo:h.corroborator}),h.history=!Array.isArray(h.changes)||u&&u.noHistory===!0?[]:h.changes.map(f);var N=h.changesCount;return N&&u&&u.changesCount&&(N.reason&&(h.reason+=' <span title="'+o("prodDowntimes","changesCount:reason")+'" class="label label-'+(N.reason>=u.maxReasonChanges?"danger":"warning")+'">'+N.reason+"</span>"),N.aor&&(h.aor+=' <span title="'+o("prodDowntimes","changesCount:aor")+'" class="label label-'+(N.aor>=u.maxAorChanges?"danger":"warning")+'">'+N.aor+"</span>")),u&&u.productFamily&&h.productFamily&&(h.prodFlow='<span class="label label-default" title="'+r.escape(h.productName)+'">'+r.escape(h.productFamily)+"</span> "+h.prodFlow),h}});