// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/time","app/viewport","app/data/downtimeReasons","app/data/aors","app/core/views/FormView","app/users/util/setUpUserSelect2","app/prodDowntimes/templates/form"],function(e,t,s,r,i,a,o,n){return a.extend({template:n,destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},afterRender:function(){a.prototype.afterRender.call(this),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),this.setUpReasonSelect2(),this.setUpAorSelect2(),"undecided"===this.model.get("status")&&(this.$("input[name=status]").attr("disabled",!0),this.$id("decisionComment").attr("disabled",!0)),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=o(this.$id(e)),s=this.model.get(e);s&&s.id&&s.label&&t.select2("data",{id:s.id,text:s.label})},setUpReasonSelect2:function(){this.$id("reason").select2({data:r.map(function(e){return{id:e.id,text:e.id+" - "+e.getLabel()}})})},setUpAorSelect2:function(){this.$id("aor").select2({data:i.map(function(e){return{id:e.id,text:e.getLabel()}})})},showErrorMessage:function(t){return this.$errorMessage=s.msg.show({type:"error",text:e("prodShiftOrders","FORM:ERROR:"+t)}),!1},checkValidity:function(e){return e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt")},checkTimeValidity:function(e,t){var s=e[t].getTime(),r=Date.parse(this.model.get("date")),i=r+288e5;return s===i&&(s-=1),r>s||s>=i?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=t.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=t.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=t.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=t.format(e.finishedAt,"HH:mm:ss"),e},serializeForm:function(e){return e.master=this.serializeUserInfo("master"),e.leader=this.serializeUserInfo("leader"),e.operator=this.serializeUserInfo("operator"),e.operators=e.operator?[e.operator]:[],e.startedAt=t.getMoment(e.startedAtDate+" "+e.startedAtTime).toDate(),e.finishedAt=t.getMoment(e.finishedAtDate+" "+e.finishedAtTime).toDate(),delete e.startedAtDate,delete e.startedAtTime,delete e.finishedAtDate,delete e.finishedAtTime,e},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleFailure:function(t){t.responseJSON&&t.responseJSON.error&&e.has("prodDowntimes","FORM:ERROR:"+t.responseJSON.error.message)?this.showErrorMessage(t.responseJSON.error.message):a.prototype.handleFailure.apply(this,arguments)}})});