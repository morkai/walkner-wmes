// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/viewport","app/data/downtimeReasons","app/data/aors","app/core/views/FormView","app/users/util/setUpUserSelect2","../util/reasonAndAor","app/prodDowntimes/templates/form"],function(e,t,s,i,r,o,a,n,d,l){"use strict";return a.extend({template:l,events:e.extend({"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.timers.clearSelect2=setTimeout(function(e){e.setUpReasonSelect2(),e.setUpAorSelect2(),e.$id("reason").select2("focus")},1,this)},"change #-reason":function(){this.setUpAorSelect2()},"change #-aor":function(){this.setUpReasonSelect2()}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),d.initialize(this)},destroy:function(){a.prototype.destroy.call(this),d.destroy(this)},afterRender:function(){a.prototype.afterRender.call(this),this.options.editMode||(d.setUpReasons(this),d.setUpAors(this),this.setUpReasonSelect2(),this.setUpAorSelect2()),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),this.options.editMode||"undecided"!==this.model.get("status")||(this.$("input[name=status]").attr("disabled",!0),this.$id("decisionComment").attr("disabled",!0)),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=n(this.$id(e)),s=this.model.get(e);s&&s.id&&s.label&&t.select2("data",{id:s.id,text:s.label})},setUpReasonSelect2:function(){d.setUpReasonSelect2(this,this.$id("aor").val(),{allowClear:!0,placeholder:" "})},setUpAorSelect2:function(){d.setUpAorSelect2(this,this.$id("reason").val(),{allowClear:!0,placeholder:" "})},showErrorMessage:function(e){return this.$errorMessage=i.msg.show({type:"error",text:t.has("prodDowntimes","FORM:ERROR:"+e)?t("prodDowntimes","FORM:ERROR:"+e):e}),!1},checkValidity:function(e){return e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt")},checkTimeValidity:function(e,t){var s=e[t].getTime(),i=Date.parse(this.model.get("date")),r=i+288e5;return s===r&&(s-=1),i>s||s>=r?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=s.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=s.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=s.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=s.format(e.finishedAt,"HH:mm:ss"),e},serializeForm:function(t){return t.master=this.serializeUserInfo("master"),t.leader=this.serializeUserInfo("leader"),t.operator=this.serializeUserInfo("operator"),t.operators=t.operator?[t.operator]:[],t.startedAt=s.getMoment(t.startedAtDate+" "+t.startedAtTime).toDate(),t.finishedAt=s.getMoment(t.finishedAtDate+" "+t.finishedAtTime).toDate(),t.reasonComment=e.isEmpty(t.reasonComment)?"":t.reasonComment,t.decisionComment=e.isEmpty(t.decisionComment)?"":t.decisionComment,delete t.startedAtDate,delete t.startedAtTime,delete t.finishedAtDate,delete t.finishedAtTime,t},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleFailure:function(e){e.responseJSON&&e.responseJSON.error&&t.has("prodDowntimes","FORM:ERROR:"+e.responseJSON.error.message)?this.showErrorMessage(e.responseJSON.error.message):a.prototype.handleFailure.apply(this,arguments)}})});