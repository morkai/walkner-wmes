// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/viewport","app/data/downtimeReasons","app/data/aors","app/core/views/FormView","app/users/util/setUpUserSelect2","app/prodDowntimes/templates/form"],function(e,t,s,r,i,a,o,n,l){"use strict";return o.extend({template:l,events:e.extend({},o.prototype.events,{"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.timers.clearSelect2=setTimeout(function(e){e.setUpReasonSelect2(),e.setUpAorSelect2(),e.$id("reason").select2("focus")},1,this)},"change #-reason":function(){this.setUpAorSelect2()},"change #-aor":function(){this.setUpReasonSelect2()}}),initialize:function(){o.prototype.initialize.apply(this,arguments),this.reasonsToAorsMap={},this.reasonsList=[],this.aorsList={}},destroy:function(){o.prototype.destroy.call(this),this.reasonsToAorsMap=null,this.reasonsList=null,this.aorsList=null},afterRender:function(){o.prototype.afterRender.call(this),this.setUpReasons(),this.setUpAors(),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),this.setUpReasonSelect2(),this.setUpAorSelect2(),"undecided"===this.model.get("status")&&(this.$("input[name=status]").attr("disabled",!0),this.$id("decisionComment").attr("disabled",!0)),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=n(this.$id(e)),s=this.model.get(e);s&&s.id&&s.label&&t.select2("data",{id:s.id,text:s.label})},setUpReasonSelect2:function(){var e=this.$id("reason"),t=this.getReasonsForAor(this.$id("aor").val());e.select2({allowClear:!0,placeholder:" ",data:t}),null===e.select2("data")&&e.select2("val",1===t.length?t[0].id:"")},setUpAorSelect2:function(){var e=this.$id("aor"),t=this.getAorsForReason(this.$id("reason").val());e.select2({allowClear:!0,placeholder:" ",data:t}),null===e.select2("data")&&e.select2("val",1===t.length?t[0].id:"")},showErrorMessage:function(e){return this.$errorMessage=r.msg.show({type:"error",text:t("prodShiftOrders","FORM:ERROR:"+e)}),!1},checkValidity:function(e){return e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt")},checkTimeValidity:function(e,t){var s=e[t].getTime(),r=Date.parse(this.model.get("date")),i=r+288e5;return s===i&&(s-=1),r>s||s>=i?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=s.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=s.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=s.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=s.format(e.finishedAt,"HH:mm:ss"),e},serializeForm:function(t){return t.master=this.serializeUserInfo("master"),t.leader=this.serializeUserInfo("leader"),t.operator=this.serializeUserInfo("operator"),t.operators=t.operator?[t.operator]:[],t.startedAt=s.getMoment(t.startedAtDate+" "+t.startedAtTime).toDate(),t.finishedAt=s.getMoment(t.finishedAtDate+" "+t.finishedAtTime).toDate(),t.reasonComment=e.isEmpty(t.reasonComment)?"":t.reasonComment,t.decisionComment=e.isEmpty(t.decisionComment)?"":t.decisionComment,delete t.startedAtDate,delete t.startedAtTime,delete t.finishedAtDate,delete t.finishedAtTime,t},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleFailure:function(e){e.responseJSON&&e.responseJSON.error&&t.has("prodDowntimes","FORM:ERROR:"+e.responseJSON.error.message)?this.showErrorMessage(e.responseJSON.error.message):o.prototype.handleFailure.apply(this,arguments)},getReasonsForAor:function(e){if(!e)return this.reasonsList;for(var t=[],s=0;s<this.reasonsList.length;++s){var r=this.reasonsList[s];(!r.aors||r.aors[e])&&t.push(r)}return t},getAorsForReason:function(t){if(!t)return this.aorsList;var s=this.reasonsToAorsMap[t];if(void 0===s)return[];if(null===s)return this.aorsList;var r=[];return e.forEach(Object.keys(s),function(e){r.push({id:e,text:a.get(e).get("name")})}),r},setUpReasons:function(){var t={},s=[];i.forEach(function(r){var i={},a=!1;e.forEach(r.get("aors"),function(e){i[e]=!0,a=!0}),a||(i=null),t[r.id]=i,s.push({id:r.id,text:r.id+" - "+r.get("label"),aors:i})}),this.reasonsToAorsMap=t,this.reasonsList=s},setUpAors:function(){var e=[];a.forEach(function(t){e.push({id:t.id,text:t.get("name")})}),this.aorsList=e}})});