// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user","app/time","app/viewport","app/data/downtimeReasons","app/data/aors","app/core/views/FormView","app/users/util/setUpUserSelect2","app/prodChangeRequests/util/isChangeRequest","../util/reasonAndAor","app/prodDowntimes/templates/form"],function(e,t,s,i,r,o,a,n,d,l,h,c){"use strict";return n.extend({template:c,events:e.extend({"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.timers.clearSelect2=setTimeout(function(e){e.setUpReasonSelect2(),e.setUpAorSelect2(),e.$id("reason").select2("focus")},1,this)},"change #-reason":function(){this.setUpAorSelect2()},"change #-aor":function(){this.setUpReasonSelect2()}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),h.initialize(this)},destroy:function(){n.prototype.destroy.call(this),h.destroy(this)},serialize:function(){return e.extend(n.prototype.serialize.call(this),{isChangeRequest:l()})},afterRender:function(){n.prototype.afterRender.call(this),this.options.editMode||(h.setUpReasons(this),h.setUpAors(this),this.setUpReasonSelect2(),this.setUpAorSelect2()),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),this.options.editMode||"undecided"!==this.model.get("status")||(this.$("input[name=status]").attr("disabled",!0),this.$id("decisionComment").attr("disabled",!0)),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=d(this.$id(e)),s=this.model.get(e);s&&s.id&&s.label&&t.select2("data",{id:s.id,text:s.label})},setUpReasonSelect2:function(){h.setUpReasonSelect2(this,this.$id("aor").val(),{allowClear:!0,placeholder:" "})},setUpAorSelect2:function(){h.setUpAorSelect2(this,this.$id("reason").val(),{allowClear:!0,placeholder:" "})},showErrorMessage:function(e){return t.has("prodDowntimes","FORM:ERROR:"+e)&&(e=t("prodDowntimes","FORM:ERROR:"+e)),n.prototype.showErrorMessage.call(this,e)},checkValidity:function(e){return e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt")},checkTimeValidity:function(e,t){var s=e[t].getTime(),i=Date.parse(this.model.get("date")),r=i+288e5;return s===r&&(s-=1),i>s||s>=r?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=i.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=i.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=i.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=i.format(e.finishedAt,"HH:mm:ss"),e.requestComment="",e},serializeForm:function(t){return t.master=this.serializeUserInfo("master"),t.leader=this.serializeUserInfo("leader"),t.operator=this.serializeUserInfo("operator"),t.operators=t.operator?[t.operator]:[],t.startedAt=i.getMoment(t.startedAtDate+" "+t.startedAtTime).toDate(),t.finishedAt=i.getMoment(t.finishedAtDate+" "+t.finishedAtTime).toDate(),t.reasonComment=e.isEmpty(t.reasonComment)?"":t.reasonComment,t.decisionComment=e.isEmpty(t.decisionComment)?"":t.decisionComment,delete t.startedAtDate,delete t.startedAtTime,delete t.finishedAtDate,delete t.finishedAtTime,t},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleSuccess:function(){if(l()){if(this.options.editMode)return this.handleEditSuccess();r.msg.show({type:"success",time:2500,text:t("prodDowntimes","changeRequest:msg:success:add")})}n.prototype.handleSuccess.apply(this,arguments)},handleEditSuccess:function(){function e(){r.msg.show({type:"success",time:5e3,text:t("prodDowntimes","changeRequest:msg:success:edit")})}return this.model.set(this.model.previousAttributes()),r.currentDialog===this?e():this.broker.subscribe("router.executing").setLimit(1).on("message",e),n.prototype.handleSuccess.apply(this,arguments)},handleFailure:function(e){var s=e.responseJSON;s&&s.error&&t.has("prodDowntimes","FORM:ERROR:"+s.error.message)?this.showErrorMessage(s.error.message):l()?this.showErrorMessage(t("prodShiftOrders","changeRequest:msg:failure:"+(this.options.editMode?"edit":"add"))):n.prototype.handleFailure.apply(this,arguments)}})});