// Copyright (c) 2014, Łukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","underscore","app/time","app/i18n","app/viewport","app/core/views/DetailsView","app/core/util/buttonGroup","../util/decorateProdDowntime","../util/decorateProdDowntimeChange","../util/reasonAndAor","app/prodDowntimes/templates/details","app/prodDowntimes/templates/detailsProps","app/prodDowntimes/templates/historyItem","app/prodDowntimes/templates/corroborateExtra"],function(t,e,i,o,s,r,a,n,d,h,l,c,u,p){"use strict";return r.extend({template:l,events:e.extend({"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.timers.clearSelect2=setTimeout(function(t){t.setUpReasonSelect2(),t.setUpAorSelect2(),t.$id("reason").select2("focus")},1,this)},"change #-reason":function(){this.setUpAorSelect2()},"change #-aor":function(){this.setUpReasonSelect2()},"change #-status":function(t){this.updateCorroborateSubmit(t)},"change #-corroborate":function(){this.clearCorroborateValidity()},"submit #-corroborate":function(){return this.corroborate(),!1}},r.prototype.events),remoteTopics:function(){return{}},initialize:function(){r.prototype.initialize.apply(this,arguments),h.initialize(this),this.historyItemCount=0},destroy:function(){r.prototype.destroy.call(this),h.destroy(this)},beforeRender:function(){this.stopListening(this.model,"change",this.onModelChange),this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.historyItemCount=this.model.get("changes").length,this.listenTo(this.model,"change",this.onModelChange),this.listenTo(this.model,"change:changes",this.updateHistory),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4)),h.setUpReasons(this),h.setUpAors(this),this.updateCorroborateExtra()},focusComment:function(){this.$id("comment").focus()},updateProps:function(){this.$id("props").replaceWith(c({idPrefix:this.idPrefix,model:n(this.model,{longDate:!0,noHistory:!0})}))},updateHistory:function(){var t=this.$id("history");t.find(".prodDowntimes-history-item").remove();var e=t.find(".panel-heading"),i=this.model.get("changes").map(function(t,e){return u({item:d(t),itemIndex:e})});if(e.after(i.join("")),i.length>this.historyItemCount){for(var o=this.$(".prodDowntimes-history-item"),s=this.historyItemCount;s<o.length;++s)o[s].classList.add("highlight");this.historyItemCount=i.length}},updateCorroborateExtra:function(){var t=this.$id("corroborateExtra");if(!t.length){if(!this.model.canChangeStatus())return this.$id("reason").select2("destroy"),this.$id("aor").select2("destroy"),t.remove(),void this.updateCorroborateSubmit();this.$id("corroborate").prepend(p({idPrefix:this.idPrefix,showRejectedStatus:!0,showConfirmedStatus:!0})),this.$id("reason").val(this.model.get("reason")),this.$id("aor").val(this.model.get("aor")),this.setUpReasonSelect2(),this.setUpAorSelect2(),this.updateCorroborateSubmit()}},updateCorroborateSubmit:function(t){var e=this.$id("status"),i=a.getValue(e);i&&0!==i.length?1===i.length?i=i[0]:t&&(e.find("input").filter(function(){return this!==t.target}).prop("checked",!1).parent().removeClass("active"),i=t.target.value):i="undecided";var s="undecided"===i,r=s?"comment":"gavel",n=s?"primary":"rejected"===i?"danger":"success",d='<i class="fa fa-'+r+'"></i><span>'+o("prodDowntimes","corroborate:submit:"+i)+"</span>";this.$('button[type="submit"]').removeClass("btn-primary btn-success btn-danger").addClass("btn-"+n).html(d),this.$id("reason").closest(".form-group").toggleClass("hidden",s),this.$id("aor").closest(".form-group").toggleClass("hidden",s),this.$id("comment").prop("required",s).closest(".form-group").find("label").toggleClass("is-required",s)},setUpReasonSelect2:function(){h.setUpReasonSelect2(this,this.$id("aor").val(),{allowClear:!0,placeholder:" "})},setUpAorSelect2:function(){h.setUpAorSelect2(this,this.$id("reason").val(),{allowClear:!0,placeholder:" "})},updateTimes:function(){this.$(".prodDowntimes-history-time").each(function(){var t=i.toTagData(this.getAttribute("datetime"));this.innerText=t.daysAgo>5?t["long"]:t.human})},clearCorroborateValidity:function(){var t=this.$id("comment")[0];t&&t.setCustomValidity("")},corroborate:function(){var t=this.$id("comment"),i=a.getValue(this.$id("status")),r=this.$id("reason").val(),n=this.$id("aor").val(),d=t.val().trim(),h={};Array.isArray(i)&&i.length&&(i=i[0],i!==this.model.get("status")&&(h.status=i),r!==this.model.get("reason")&&(h.reason=r),n!==this.model.get("aor")&&(h.aor=n)),e.isEmpty(d)||(h.decisionComment=d);var l=this.$('.btn[type="submit"]');if(e.isEmpty(h)){if(!t[0].validity.valid)return;return t[0].setCustomValidity("Nie wykryto żadnych zmian :("),void(this.timers.submit=setTimeout(function(){l.click()},1))}h._id=this.model.id,e.isEmpty(h.decisionComment)&&(h.decisionComment=""),l.prop("disabled",!0);var c=this;this.socket.emit("prodDowntimes.corroborate",h,function(e){e?s.msg.show({type:"error",time:2500,text:o("prodDowntimes","corroborate:failure")}):(c.$id("status").find(".active").click(),t.val("").focus()),l.prop("disabled",!1)})},onModelChange:function(){this.updateProps(),this.updateCorroborateExtra()}})});