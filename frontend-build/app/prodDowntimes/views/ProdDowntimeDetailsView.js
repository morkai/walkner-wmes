// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","underscore","app/time","app/i18n","app/viewport","app/core/views/DetailsView","app/core/util/buttonGroup","app/data/orgUnits","app/data/aors","../util/decorateProdDowntime","../util/decorateProdDowntimeChange","../util/reasonAndAor","app/prodDowntimes/templates/details","app/prodDowntimes/templates/detailsProps","app/prodDowntimes/templates/historyItem","app/prodDowntimes/templates/corroborateExtra"],function(t,e,i,s,o,r,a,n,d,h,l,u,c,m,p,g){"use strict";return r.extend({template:c,events:e.extend({"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.timers.clearSelect2=setTimeout(function(t){t.setUpReasonSelect2(),t.setUpAorSelect2(),t.$id("reason").select2("focus")},1,this)},"change #-reason":function(){this.setUpAorSelect2()},"change #-aor":function(){this.setUpReasonSelect2()},"change #-status":function(t){this.updateCorroborateSubmit(t)},"change #-corroborate":function(){this.clearCorroborateValidity()},"submit #-corroborate":function(){return this.corroborate(),!1}},r.prototype.events),remoteTopics:function(){return{}},initialize:function(){r.prototype.initialize.apply(this,arguments),u.initialize(this),this.historyItemCount=0},destroy:function(){r.prototype.destroy.call(this),u.destroy(this)},beforeRender:function(){this.stopListening(this.model,"change",this.onModelChange),this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.historyItemCount=this.model.get("changes").length,this.listenTo(this.model,"change",this.onModelChange),this.listenTo(this.model,"change:changes",this.updateHistory),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4)),u.setUpReasons(this),u.setUpAors(this),this.updateCorroborateExtra()},focusComment:function(){this.$id("comment").focus()},updateProps:function(){this.$id("props").replaceWith(m({idPrefix:this.idPrefix,model:h(this.model,{longDate:!0,noHistory:!0})}))},updateHistory:function(){var t=this.$id("history");t.find(".prodDowntimes-history-item").remove();var e=t.find(".panel-heading"),i=this.model.get("changes").map(function(t,e){return p({item:l(t),itemIndex:e})});if(e.after(i.join("")),i.length>this.historyItemCount){for(var s=this.$(".prodDowntimes-history-item"),o=this.historyItemCount;o<s.length;++o)s[o].classList.add("highlight");this.historyItemCount=i.length}},updateCorroborateExtra:function(){var t=this.$id("corroborateExtra"),e=this.model.canChangeStatus(this.settings.getCanChangeStatusOptions());if(this.$id("reason").select2("destroy"),this.$id("aor").select2("destroy"),t.remove(),this.updateCorroborateSubmit(),e){var i=this.getDefaultAor(),s=this.model.get("status");this.$id("corroborate").prepend(g({idPrefix:this.idPrefix,defaultAor:i?i.getLabel():null,showUndecidedStatus:2===e||"rejected"===s&&1===e,showRejectedStatus:2===e||"undecided"===s&&1===e,showConfirmedStatus:2===e||"undecided"===s&&1===e})),this.$id("reason").val(this.model.get("reason")),this.$id("aor").val(this.model.get("aor")),this.setUpReasonSelect2(),this.setUpAorSelect2(),this.updateCorroborateSubmit(null,e)}},updateCorroborateSubmit:function(t,e){void 0===e&&(e=this.model.canChangeStatus(this.settings.getCanChangeStatusOptions()));var i=this.$id("status"),o=a.getValue(i);o&&0!==o.length?1===o.length?o=o[0]:t&&(i.find("input").filter(function(){return this!==t.target}).prop("checked",!1).parent().removeClass("active"),o=t.target.value):o=null;var r=null===o,n=o?"gavel":"comment",d='<i class="fa fa-'+n+'"></i><span>'+s("prodDowntimes","corroborate:submit:"+o)+"</span>";this.$('button[type="submit"]').removeClass("btn-primary btn-success btn-danger btn-warning").addClass("btn-"+this.model.getCssClassName(o)).html(d);var h=!1,l=!1,u=!1;2===e?(h=null!==o,l=null!==o):1===e&&(h="undecided"===o,l="undecided"===o,u="rejected"===o),this.$id("reason").closest(".form-group").toggleClass("hidden",!h),this.$id("aor").closest(".form-group").toggleClass("hidden",!l),this.$id("defaultAor").toggleClass("hidden",!u),this.$id("comment").prop("required",r).closest(".form-group").find("label").toggleClass("is-required",r),t&&(h?this.$id("reason").select2("focus"):this.$id("comment").focus())},setUpReasonSelect2:function(){u.setUpReasonSelect2(this,this.$id("aor").val(),{allowClear:!0,placeholder:" "})},setUpAorSelect2:function(){u.setUpAorSelect2(this,this.$id("reason").val(),{allowClear:!0,placeholder:" "})},updateTimes:function(){this.model.get("finishedAt")||this.$id("duration").text(this.model.getDurationString()),this.$(".prodDowntimes-history-time").each(function(){var t=i.toTagData(this.getAttribute("datetime"));this.textContent=t.daysAgo>5?t["long"]:t.human})},clearCorroborateValidity:function(){var t=this.$id("comment")[0];t&&t.setCustomValidity("")},corroborate:function(){var t=this.$id("reason"),i=this.$id("aor"),r=this.$id("comment"),n=a.getValue(this.$id("status")),d=!t.length||t.closest(".form-group").hasClass("hidden")?null:t.val(),h=!i.length||i.closest(".form-group").hasClass("hidden")?null:i.val(),l=r.val().trim(),u={};Array.isArray(n)&&n.length&&(n=n[0]),e.isString(n)&&(n!==this.model.get("status")&&(u.status=n),d&&h?(d!==this.model.get("reason")&&(u.reason=d),h!==this.model.get("aor")&&(u.aor=h)):"rejected"===n&&(h=this.getDefaultAor(),h&&h.id!==this.model.get("aor")&&(u.aor=h.id))),e.isEmpty(l)||(u.decisionComment=l);var c=this.$('.btn[type="submit"]');if(e.isEmpty(u)){if(!r[0].validity.valid)return;return r[0].setCustomValidity(s("prodDowntimes","corroborate:noChanges")),void(this.timers.submit=setTimeout(function(){c.click()},1))}u._id=this.model.id,e.isEmpty(u.decisionComment)&&(u.decisionComment=""),c.prop("disabled",!0);var m=this;this.socket.emit("prodDowntimes.corroborate",u,function(t){t?o.msg.show({type:"error",time:2500,text:s("prodDowntimes","corroborate:failure")}):(m.$id("status").find(".active").click(),r.val("").focus()),c.prop("disabled",!1)})},getDefaultAor:function(){var t=n.getByTypeAndId("subdivision",this.model.get("subdivision"));return t?d.get(t.get("aor"))||null:null},onModelChange:function(){this.updateProps(),this.updateCorroborateExtra()}})});