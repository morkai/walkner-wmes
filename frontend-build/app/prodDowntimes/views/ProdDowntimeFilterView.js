// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/user","app/data/aors","app/data/orgUnits","app/data/downtimeReasons","app/core/views/FilterView","app/core/util/fixTimeRange","app/prodDowntimes/templates/filter"],function(e,t,i,n,o,a,s){"use strict";return o.extend({template:s,defaultFormData:function(){return{startedAt:"",aor:null,aorIn:!0,reason:null,reasonIn:!0,status:["undecided","confirmed","rejected"],orgUnit:null}},termToForm:{startedAt:function(e,t,i){a.toFormData(i,t,"date+time")},aor:function(e,t,i){"eq"===t.name||"ne"===t.name?(i[e+"In"]="eq"===t.name,i[e]=t.args[1]):("in"===t.name||"nin"===t.name)&&(i[e+"In"]="in"===t.name,i[e]=t.args[1].join(","))},status:function(e,t,i){i.status=[].concat(t.args[1])},division:function(e,t,i){i.orgUnit=t.args[1]},reason:"aor",subdivision:"division",prodFlow:"division"},afterRender:function(){o.prototype.afterRender.call(this),this.$id("orgUnit").select2({width:"256px",allowClear:!e.getDivision()||e.isAllowedTo("PROD_DOWNTIMES:ALL"),data:this.getApplicableOrgUnits(),formatSelection:function(e){return"subdivision"===e.type?e.model.get("division")+" \\ "+e.text:e.text}}),this.$id("aor").select2({width:"256px",allowClear:!0,multiple:!0,data:t.map(function(e){return{id:e.id,text:e.getLabel()}}).sort(function(e,t){return e.text.localeCompare(t.text)})}),this.$id("reason").select2({width:"256px",allowClear:!0,multiple:!0,data:n.map(function(e){return{id:e.id,text:e.id+" - "+(e.get("label")||"?")}}).sort(function(e,t){return e.id.localeCompare(t.id)})})},getApplicableOrgUnits:function(){var t=[],n=e.getDivision(),o=e.getSubdivision(),a=e.isAllowedTo("PROD_DOWNTIMES:ALL");!a&&n&&t.push({disabled:!!o,id:n.id,text:n.getLabel(),type:"division",model:n,css:"prodDowntime-filter-division"});var s=this;return!a&&o?this.pushApplicableOrgUnitsForSubdivision(t,o):!a&&n?i.getChildren(n).forEach(function(e){s.pushApplicableOrgUnitsForSubdivision(t,e)}):i.getAllDivisions().forEach(function(e){t.push({id:e.id,text:e.getLabel(),type:"division",model:e,css:"prodDowntime-filter-division"}),i.getChildren(e).forEach(function(e){s.pushApplicableOrgUnitsForSubdivision(t,e)})}),t},pushApplicableOrgUnitsForSubdivision:function(e,t){e.push({id:t.id,text:t.getLabel(),type:"subdivision",model:t,css:"prodDowntime-filter-subdivision"}),i.getProdFlowsForSubdivision(t).forEach(function(t){e.push({id:t.id,text:t.getLabel(),type:"prodFlow",model:t,css:"prodDowntime-filter-prodFlow"})})},serializeFormToQuery:function(e){var t=a.fromView(this,{defaultTime:"06:00"}),i=this.$id("orgUnit").select2("data"),n=this.$id("aor").select2("val"),o=this.$id("aorIn").prop("checked"),s=this.$id("reason").select2("val"),r=this.$id("reasonIn").prop("checked"),l=this.fixStatus();1===l.length?e.push({name:"eq",args:["status",l[0]]}):l.length>1&&e.push({name:"in",args:["status",l]}),t.from&&e.push({name:"ge",args:["startedAt",t.from]}),t.to&&e.push({name:"le",args:["startedAt",t.to]}),1===n.length?e.push({name:o?"eq":"ne",args:["aor",n[0]]}):n.length>1&&e.push({name:o?"in":"nin",args:["aor",n]}),1===s.length?e.push({name:r?"eq":"ne",args:["reason",s[0]]}):s.length>1&&e.push({name:r?"in":"nin",args:["reason",s]}),i&&e.push({name:"eq",args:[i.type,i.id]})},fixStatus:function(){var e=this.$('input[name="status[]"]'),t=e.filter(":checked");0===t.length&&(t=e.prop("checked",!0));var i=t.map(function(){return this.value}).get();return i.length===e.length?[]:i}})});