define(["underscore","moment","js2form","reltime","app/i18n","app/user","app/data/aors","app/data/orgUnits","app/core/View","app/core/util/fixTimeRange","app/data/downtimeReasons","app/prodDowntimes/templates/filter","i18n!app/nls/prodDowntimes","select2"],function(t,i,e,s,a,r,n,o,l,d,u,p){return l.extend({template:p,events:{"submit .filter-form":function(t){t.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=t.uniqueId("prodDowntimeFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var t=this.serializeRqlQuery();e(this.el.querySelector(".filter-form"),t),this.toggleStatus(t.status),this.$id("orgUnit").select2({width:"275px",allowClear:!r.getDivision(),data:this.getApplicableOrgUnits(),formatSelection:function(t){return"subdivision"===t.type?t.model.get("division")+" \\ "+t.text:t.text}}),this.$id("aor").select2({width:"275px",allowClear:!0,data:this.getApplicableAors()}),this.$id("reason").select2({width:"275px",allowClear:!0,data:u.map(function(t){return{id:t.id,text:t.id+" - "+(t.get("label")||"?")}}).sort(function(t,i){return t.id.localeCompare(i.id)})})},getApplicableOrgUnits:function(){var t=[],i=r.getDivision(),e=r.getSubdivision();i&&t.push({disabled:!!e,id:i.id,text:i.getLabel(),type:"division",model:i,css:"prodDowntime-filter-division"});var s=this;return e?this.pushApplicableOrgUnitsForSubdivision(t,e):i?o.getChildren(i).forEach(function(i){s.pushApplicableOrgUnitsForSubdivision(t,i)}):o.getAllDivisions().forEach(function(i){t.push({id:i.id,text:i.getLabel(),type:"division",model:i,css:"prodDowntime-filter-division"}),o.getChildren(i).forEach(function(i){s.pushApplicableOrgUnitsForSubdivision(t,i)})}),t},pushApplicableOrgUnitsForSubdivision:function(t,i){t.push({id:i.id,text:i.getLabel(),type:"subdivision",model:i,css:"prodDowntime-filter-subdivision"}),o.getProdFlowsForSubdivision(i).forEach(function(i){t.push({id:i.id,text:i.getLabel(),type:"prodFlow",model:i,css:"prodDowntime-filter-prodFlow"})})},getApplicableAors:function(){var t=r.data.aors||[],i=[];return t.length?t.forEach(function(t){var e=n.get(t);e&&i.push({id:t,text:e.getLabel()})}):n.each(function(t){i.push({id:t.id,text:t.getLabel()})}),i},serializeRqlQuery:function(){var t=this.model.rqlQuery,e={startedAt:"",aor:null,reason:null,status:[],orgUnit:null,limit:t.limit<5?5:t.limit>100?100:t.limit};return t.selector.args.forEach(function(t){var s=t.args[0];switch(s){case"startedAt":("ge"===t.name||"le"===t.name)&&(e["ge"===t.name?"from":"to"]=i(t.args[1]).format("YYYY-MM-DD HH:mm:ss"));break;case"aor":case"reason":"eq"===t.name&&(e[s]=t.args[1]);break;case"status":e.status=[].concat(t.args[1]);break;case"division":case"subdivision":case"prodFlow":e.orgUnit=t.args[1]}}),e},changeFilter:function(){var t=this.model.rqlQuery,i=d(this.$id("from"),this.$id("to"),"YYYY-MM-DD HH:mm:ss"),e=[],s=this.$id("orgUnit").select2("data"),a=this.$id("aor").val(),r=this.$id("reason").val(),n=this.fixStatus();a&&a.length&&e.push({name:"eq",args:["aor",a]}),r&&r.length&&e.push({name:"eq",args:["reason",r]}),1===n.length?e.push({name:"eq",args:["status",n[0]]}):n.length>1&&e.push({name:"in",args:["status",n]}),s&&e.push({name:"eq",args:[s.type,s.id]}),-1!==i.from&&e.push({name:"ge",args:["startedAt",i.from]}),-1!==i.to&&e.push({name:"le",args:["startedAt",i.to]}),t.selector={name:"and",args:e},t.limit=parseInt(this.$id("limit").val(),10)||15,t.skip=0,this.trigger("filterChanged",t)},fixStatus:function(){var t=this.$(".filter-btn-group > .btn"),i=t.filter(".active");0===i.length&&t.addClass("active");var e=i.map(function(){return this.value}).get();return e.length===t.length?[]:e},toggleStatus:function(t){var i=this.$(".filter-btn-group > .btn");0===t.length?i.addClass("active"):t.forEach(function(t){i.filter('[value="'+t+'"]').addClass("active")})}})});