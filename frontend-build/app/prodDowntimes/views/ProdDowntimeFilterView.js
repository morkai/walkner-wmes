define(["underscore","moment","js2form","app/i18n","app/user","app/data/aors","app/data/orgUnits","app/core/View","app/core/util/fixTimeRange","app/data/downtimeReasons","app/prodDowntimes/templates/filter","select2"],function(e,t,n,r,i,o,a,s,l,u,d){return s.extend({template:d,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("prodDowntimeFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();n(this.el.querySelector(".filter-form"),e),this.$id("orgUnit").select2({width:"256px",allowClear:!i.getDivision(),data:this.getApplicableOrgUnits(),formatSelection:function(e){return"subdivision"===e.type?e.model.get("division")+" \\ "+e.text:e.text}}),this.$id("aor").select2({width:"256px",allowClear:!0,multiple:!0,data:o.map(function(e){return{id:e.id,text:e.getLabel()}}).sort(function(e,t){return e.text.localeCompare(t.text)})}),this.$id("reason").select2({width:"256px",allowClear:!0,multiple:!0,data:u.map(function(e){return{id:e.id,text:e.id+" - "+(e.get("label")||"?")}}).sort(function(e,t){return e.id.localeCompare(t.id)})})},getApplicableOrgUnits:function(){var e=[],t=i.getDivision(),n=i.getSubdivision();t&&e.push({disabled:!!n,id:t.id,text:t.getLabel(),type:"division",model:t,css:"prodDowntime-filter-division"});var r=this;return n?this.pushApplicableOrgUnitsForSubdivision(e,n):t?a.getChildren(t).forEach(function(t){r.pushApplicableOrgUnitsForSubdivision(e,t)}):a.getAllDivisions().forEach(function(t){e.push({id:t.id,text:t.getLabel(),type:"division",model:t,css:"prodDowntime-filter-division"}),a.getChildren(t).forEach(function(t){r.pushApplicableOrgUnitsForSubdivision(e,t)})}),e},pushApplicableOrgUnitsForSubdivision:function(e,t){e.push({id:t.id,text:t.getLabel(),type:"subdivision",model:t,css:"prodDowntime-filter-subdivision"}),a.getProdFlowsForSubdivision(t).forEach(function(t){e.push({id:t.id,text:t.getLabel(),type:"prodFlow",model:t,css:"prodDowntime-filter-prodFlow"})})},serializeRqlQuery:function(){var e=this.model.rqlQuery,t={startedAt:"",aor:null,aorIn:!0,reason:null,reasonIn:!0,status:["undecided","confirmed","rejected"],orgUnit:null,limit:e.limit<5?5:e.limit>100?100:e.limit};return e.selector.args.forEach(function(e){var n=e.args[0];switch(n){case"startedAt":l.toFormData(t,e,"date+time");break;case"aor":case"reason":"eq"===e.name||"ne"===e.name?(t[n+"In"]="eq"===e.name,t[n]=e.args[1]):("in"===e.name||"nin"===e.name)&&(t[n+"In"]="in"===e.name,t[n]=e.args[1].join(","));break;case"status":t.status=[].concat(e.args[1]);break;case"division":case"subdivision":case"prodFlow":t.orgUnit=e.args[1]}}),t},changeFilter:function(){var e=this.model.rqlQuery,t=l.fromView(this),n=[],r=this.$id("orgUnit").select2("data"),i=this.$id("aor").select2("val"),o=this.$id("aorIn").prop("checked"),a=this.$id("reason").select2("val"),s=this.$id("reasonIn").prop("checked"),u=this.fixStatus();1===u.length?n.push({name:"eq",args:["status",u[0]]}):u.length>1&&n.push({name:"in",args:["status",u]}),t.from&&n.push({name:"ge",args:["startedAt",t.from]}),t.to&&n.push({name:"le",args:["startedAt",t.to]}),1===i.length?n.push({name:o?"eq":"ne",args:["aor",i[0]]}):i.length>1&&n.push({name:o?"in":"nin",args:["aor",i]}),1===a.length?n.push({name:s?"eq":"ne",args:["reason",a[0]]}):a.length>1&&n.push({name:s?"in":"nin",args:["reason",a]}),r&&n.push({name:"eq",args:[r.type,r.id]}),e.selector={name:"and",args:n},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},fixStatus:function(){var e=this.$('input[name="status[]"]'),t=e.filter(":checked");0===t.length&&(t=e.prop("checked",!0));var n=t.map(function(){return this.value}).get();return n.length===e.length?[]:n}})});