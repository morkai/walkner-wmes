define(["underscore","moment","js2form","app/i18n","app/user","app/data/aors","app/data/orgUnits","app/core/View","app/core/util/fixTimeRange","app/data/downtimeReasons","app/prodDowntimes/templates/filter","select2"],function(e,t,i,r,s,a,n,o,l,d,u){return o.extend({template:u,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("prodDowntimeFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();i(this.el.querySelector(".filter-form"),e),this.$id("orgUnit").select2({width:"256px",allowClear:!s.getDivision(),data:this.getApplicableOrgUnits(),formatSelection:function(e){return"subdivision"===e.type?e.model.get("division")+" \\ "+e.text:e.text}}),this.$id("aor").select2({width:"256px",allowClear:!0,data:this.getApplicableAors()}),this.$id("reason").select2({width:"256px",allowClear:!0,data:d.map(function(e){return{id:e.id,text:e.id+" - "+(e.get("label")||"?")}}).sort(function(e,t){return e.id.localeCompare(t.id)})})},getApplicableOrgUnits:function(){var e=[],t=s.getDivision(),i=s.getSubdivision();t&&e.push({disabled:!!i,id:t.id,text:t.getLabel(),type:"division",model:t,css:"prodDowntime-filter-division"});var r=this;return i?this.pushApplicableOrgUnitsForSubdivision(e,i):t?n.getChildren(t).forEach(function(t){r.pushApplicableOrgUnitsForSubdivision(e,t)}):n.getAllDivisions().forEach(function(t){e.push({id:t.id,text:t.getLabel(),type:"division",model:t,css:"prodDowntime-filter-division"}),n.getChildren(t).forEach(function(t){r.pushApplicableOrgUnitsForSubdivision(e,t)})}),e},pushApplicableOrgUnitsForSubdivision:function(e,t){e.push({id:t.id,text:t.getLabel(),type:"subdivision",model:t,css:"prodDowntime-filter-subdivision"}),n.getProdFlowsForSubdivision(t).forEach(function(t){e.push({id:t.id,text:t.getLabel(),type:"prodFlow",model:t,css:"prodDowntime-filter-prodFlow"})})},getApplicableAors:function(){var e=s.data.aors||[],t=[];return e.length?e.forEach(function(e){var i=a.get(e);i&&t.push({id:e,text:i.getLabel()})}):a.each(function(e){t.push({id:e.id,text:e.getLabel()})}),t},serializeRqlQuery:function(){var e=this.model.rqlQuery,t={startedAt:"",aor:null,reason:null,status:["undecided","confirmed","rejected"],orgUnit:null,limit:e.limit<5?5:e.limit>100?100:e.limit};return e.selector.args.forEach(function(e){var i=e.args[0];switch(i){case"startedAt":l.toFormData(t,e,"date+time");break;case"aor":case"reason":"eq"===e.name&&(t[i]=e.args[1]);break;case"status":t.status=[].concat(e.args[1]);break;case"division":case"subdivision":case"prodFlow":t.orgUnit=e.args[1]}}),t},changeFilter:function(){var e=this.model.rqlQuery,t=l.fromView(this),i=[],r=this.$id("orgUnit").select2("data"),s=this.$id("aor").val(),a=this.$id("reason").val(),n=this.fixStatus();s&&s.length&&i.push({name:"eq",args:["aor",s]}),a&&a.length&&i.push({name:"eq",args:["reason",a]}),1===n.length?i.push({name:"eq",args:["status",n[0]]}):n.length>1&&i.push({name:"in",args:["status",n]}),r&&i.push({name:"eq",args:[r.type,r.id]}),t.from&&i.push({name:"ge",args:["startedAt",t.from]}),t.to&&i.push({name:"le",args:["startedAt",t.to]}),e.selector={name:"and",args:i},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},fixStatus:function(){var e=this.$('input[name="status[]"]'),t=e.filter(":checked");0===t.length&&(t=e.prop("checked",!0));var i=t.map(function(){return this.value}).get();return i.length===e.length?[]:i}})});