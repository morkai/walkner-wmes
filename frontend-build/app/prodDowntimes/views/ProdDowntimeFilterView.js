define(["underscore","moment","js2form","app/i18n","app/user","app/data/aors","app/data/orgUnits","app/core/View","app/core/util/fixTimeRange","app/data/downtimeReasons","app/prodDowntimes/templates/filter","select2"],function(e,i,t,n,r,s,a,o,l,d,u){return o.extend({template:u,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("prodDowntimeFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();t(this.el.querySelector(".filter-form"),e),this.$id("orgUnit").select2({width:"256px",allowClear:!r.getDivision(),data:this.getApplicableOrgUnits(),formatSelection:function(e){return"subdivision"===e.type?e.model.get("division")+" \\ "+e.text:e.text}}),this.$id("aor").select2({width:"256px",allowClear:!0,multiple:!0,data:s.map(function(e){return{id:e.id,text:e.getLabel()}}).sort(function(e,i){return e.text.localeCompare(i.text)})}),this.$id("reason").select2({width:"256px",allowClear:!0,multiple:!0,data:d.map(function(e){return{id:e.id,text:e.id+" - "+(e.get("label")||"?")}}).sort(function(e,i){return e.id.localeCompare(i.id)})})},getApplicableOrgUnits:function(){var e=[],i=r.getDivision(),t=r.getSubdivision();i&&e.push({disabled:!!t,id:i.id,text:i.getLabel(),type:"division",model:i,css:"prodDowntime-filter-division"});var n=this;return t?this.pushApplicableOrgUnitsForSubdivision(e,t):i?a.getChildren(i).forEach(function(i){n.pushApplicableOrgUnitsForSubdivision(e,i)}):a.getAllDivisions().forEach(function(i){e.push({id:i.id,text:i.getLabel(),type:"division",model:i,css:"prodDowntime-filter-division"}),a.getChildren(i).forEach(function(i){n.pushApplicableOrgUnitsForSubdivision(e,i)})}),e},pushApplicableOrgUnitsForSubdivision:function(e,i){e.push({id:i.id,text:i.getLabel(),type:"subdivision",model:i,css:"prodDowntime-filter-subdivision"}),a.getProdFlowsForSubdivision(i).forEach(function(i){e.push({id:i.id,text:i.getLabel(),type:"prodFlow",model:i,css:"prodDowntime-filter-prodFlow"})})},serializeRqlQuery:function(){var e=this.model.rqlQuery,i={startedAt:"",aor:null,aorIn:!0,reason:null,reasonIn:!0,status:["undecided","confirmed","rejected"],orgUnit:null,limit:e.limit<5?5:e.limit>100?100:e.limit};return e.selector.args.forEach(function(e){var t=e.args[0];switch(t){case"startedAt":l.toFormData(i,e,"date+time");break;case"aor":case"reason":"eq"===e.name||"ne"===e.name?(i[t+"In"]="eq"===e.name,i[t]=e.args[1]):("in"===e.name||"nin"===e.name)&&(i[t+"In"]="in"===e.name,i[t]=e.args[1].join(","));break;case"status":i.status=[].concat(e.args[1]);break;case"division":case"subdivision":case"prodFlow":i.orgUnit=e.args[1]}}),i},changeFilter:function(){var e=this.model.rqlQuery,i=l.fromView(this),t=[],n=this.$id("orgUnit").select2("data"),r=this.$id("aor").select2("val"),s=this.$id("aorIn").prop("checked"),a=this.$id("reason").select2("val"),o=this.$id("reasonIn").prop("checked"),d=this.fixStatus();1===d.length?t.push({name:"eq",args:["status",d[0]]}):d.length>1&&t.push({name:"in",args:["status",d]}),i.from&&t.push({name:"ge",args:["startedAt",i.from]}),i.to&&t.push({name:"le",args:["startedAt",i.to]}),1===r.length?t.push({name:s?"eq":"ne",args:["aor",r[0]]}):r.length>1&&t.push({name:s?"in":"nin",args:["aor",r]}),1===a.length?t.push({name:o?"eq":"ne",args:["reason",a[0]]}):a.length>1&&t.push({name:o?"in":"nin",args:["reason",a]}),n&&t.push({name:"eq",args:[n.type,n.id]}),e.selector={name:"and",args:t},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},fixStatus:function(){var e=this.$('input[name="status[]"]'),i=e.filter(":checked");0===i.length&&(i=e.prop("checked",!0));var t=i.map(function(){return this.value}).get();return t.length===e.length?[]:t}})});