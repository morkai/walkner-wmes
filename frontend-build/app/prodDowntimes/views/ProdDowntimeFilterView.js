// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/user","app/data/aors","app/data/orgUnits","app/data/downtimeReasons","app/core/views/FilterView","app/core/util/fixTimeRange","app/prodDowntimes/templates/filter"],function(t,e,i,n,s,a,o,r){"use strict";return a.extend({template:r,events:t.extend({},a.prototype.events,{"change #-alerts":"toggleStatus"}),defaultFormData:function(){return{startedAt:"",aor:null,aorIn:!0,reason:null,reasonIn:!0,status:null,orgUnit:null}},termToForm:{startedAt:function(t,e,i){o.toFormData(i,e,"date+time")},aor:function(t,e,i){"eq"===e.name||"ne"===e.name?(i[t+"In"]="eq"===e.name,i[t]=e.args[1]):"in"!==e.name&&"nin"!==e.name||(i[t+"In"]="in"===e.name,i[t]=e.args[1].join(","))},status:function(t,e,i){i.status=[].concat(e.args[1])},division:function(t,e,i){i.orgUnit=e.args[1]},"alerts.active":function(t,e,i){i.alerts=1},reason:"aor",subdivision:"division",prodFlow:"division"},afterRender:function(){a.prototype.afterRender.call(this),this.$id("orgUnit").select2({width:"256px",allowClear:!e.getDivision()||e.isAllowedTo("PROD_DOWNTIMES:ALL"),data:this.getApplicableOrgUnits(),formatSelection:function(t){return"subdivision"===t.type?t.model.get("division")+" \\ "+t.text:t.text}}),this.$id("aor").select2({width:"256px",allowClear:!0,multiple:!0,data:i.map(function(t){return{id:t.id,text:t.getLabel()}}).sort(function(t,e){return t.text.localeCompare(e.text)})}),this.$id("reason").select2({width:"256px",allowClear:!0,multiple:!0,data:s.map(function(t){return{id:t.id,text:t.id+" - "+(t.get("label")||"?")}}).sort(function(t,e){return t.id.localeCompare(e.id)})}),this.toggleStatus()},getApplicableOrgUnits:function(){var t=[],i=e.getDivision(),s=e.getSubdivision(),a=e.isAllowedTo("PROD_DOWNTIMES:ALL");!a&&i&&t.push({disabled:!!s,id:i.id,text:i.getLabel(),type:"division",model:i,css:"prodDowntime-filter-division"});var o=this;return!a&&s?this.pushApplicableOrgUnitsForSubdivision(t,s):!a&&i?n.getChildren(i).forEach(function(e){o.pushApplicableOrgUnitsForSubdivision(t,e)}):n.getAllDivisions().forEach(function(e){t.push({id:e.id,text:e.getLabel(),type:"division",model:e,css:"prodDowntime-filter-division"}),n.getChildren(e).forEach(function(e){o.pushApplicableOrgUnitsForSubdivision(t,e)})}),t},pushApplicableOrgUnitsForSubdivision:function(t,e){t.push({id:e.id,text:e.getLabel(),type:"subdivision",model:e,css:"prodDowntime-filter-subdivision"}),n.getProdFlowsForSubdivision(e).forEach(function(e){t.push({id:e.id,text:e.getLabel(),type:"prodFlow",model:e,css:"prodDowntime-filter-prodFlow"})})},serializeFormToQuery:function(t){var e=o.fromView(this,{defaultTime:"06:00"}),i=this.$id("orgUnit").select2("data"),n=this.$id("aor").select2("val"),s=this.$id("aorIn").prop("checked"),a=this.$id("reason").select2("val"),r=this.$id("reasonIn").prop("checked"),l=this.$id("alerts").prop("checked"),d=this.fixStatus();l?t.push({name:"eq",args:["alerts.active",!0]}):1===d.length?t.push({name:"eq",args:["status",d[0]]}):d.length>1&&t.push({name:"in",args:["status",d]}),e.from&&t.push({name:"ge",args:["startedAt",e.from]}),e.to&&t.push({name:"le",args:["startedAt",e.to]}),1===n.length?t.push({name:s?"eq":"ne",args:["aor",n[0]]}):n.length>1&&t.push({name:s?"in":"nin",args:["aor",n]}),1===a.length?t.push({name:r?"eq":"ne",args:["reason",a[0]]}):a.length>1&&t.push({name:r?"in":"nin",args:["reason",a]}),i&&t.push({name:"eq",args:[i.type,i.id]})},fixStatus:function(){var t=this.$('input[name="status[]"]'),e=t.filter(":checked");0===e.length&&(e=t.prop("checked",!0));var i=e.map(function(){return this.value}).get();return i.length===t.length?[]:i},toggleStatus:function(){this.$('[name="status[]"]').prop("disabled",this.$id("alerts").prop("checked"))}})});