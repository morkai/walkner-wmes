define(["underscore","app/i18n","app/time","app/viewport","app/data/downtimeReasons","app/data/aors","app/core/views/FormView","app/users/util/setUpUserSelect2","app/prodDowntimes/templates/editForm"],function(e,t,s,i,r,a,o,d,n){return o.extend({template:n,idPrefix:"prodDowntimeEditForm",destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},afterRender:function(){o.prototype.afterRender.call(this),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),this.setUpReasonSelect2(),this.setUpAorSelect2(),"undecided"===this.model.get("status")&&(this.$("input[name=status]").attr("disabled",!0),this.$id("decisionComment").attr("disabled",!0)),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=d(this.$id(e)),s=this.model.get(e);s&&s.id&&s.label&&t.select2("data",{id:s.id,text:s.label})},setUpReasonSelect2:function(){this.$id("reason").select2({data:r.map(function(e){return{id:e.id,text:e.id+" - "+e.getLabel()}})})},setUpAorSelect2:function(){this.$id("aor").select2({data:a.map(function(e){return{id:e.id,text:e.getLabel()}})})},showErrorMessage:function(e){return this.$errorMessage=i.msg.show({type:"error",text:t("prodShiftOrders","FORM:ERROR:"+e)}),!1},checkValidity:function(e){return e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt")},checkTimeValidity:function(e,t){var s=e[t].getTime(),i=Date.parse(this.model.get("date")),r=i+288e5;return s===r&&(s-=1),i>s||s>=r?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=s.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=s.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=s.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=s.format(e.finishedAt,"HH:mm:ss"),e},serializeForm:function(e){return e.master=this.serializeUserInfo("master"),e.leader=this.serializeUserInfo("leader"),e.operator=this.serializeUserInfo("operator"),e.operators=e.operator?[e.operator]:[],e.startedAt=new Date(e.startedAtDate+" "+e.startedAtTime),e.finishedAt=new Date(e.finishedAtDate+" "+e.finishedAtTime),delete e.startedAtDate,delete e.startedAtTime,delete e.finishedAtDate,delete e.finishedAtTime,e},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleFailure:function(e){e.responseJSON&&e.responseJSON.error&&"INVALID_CHANGES"===e.responseJSON.error.message?this.$errorMessage=i.msg.show({type:"warning",time:5e3,text:t("prodDowntimes","FORM:ERROR:INVALID_CHANGES")}):o.prototype.handleFailure.apply(this,arguments)}})});