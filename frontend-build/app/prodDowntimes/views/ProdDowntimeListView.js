// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/user","app/viewport","app/core/views/ListView","./CorroborateProdDowntimeView"],function(t,o,e,r,i){return r.extend({remoteTopics:{"prodDowntimes.created.*":"refreshIfMatches","prodDowntimes.updated.*":"refreshIfMatches","prodDowntimes.deleted.*":"refreshIfMatches","prodDowntimes.corroborated.*":function(t){t._id===this.corroboratingId&&e.closeDialog()}},events:{"click .action-corroborate":function(o){o.preventDefault();var r=this;this.broker.subscribe("viewport.dialog.hidden",function(){r.corroboratingId=null}),this.corroboratingId=this.$(o.target).closest("tr").attr("data-id"),e.showDialog(new i({model:this.collection.get(this.corroboratingId)}),t("prodDowntimes","corroborate:title"))}},columns:["rid","mrpControllers","prodFlow","aor","prodLine","reason","startedAt","finishedAt","duration"],initialize:function(){r.prototype.initialize.apply(this,arguments),this.corroboratingId=null,this.listenTo(this.collection,"change",this.render)},serializeActions:function(){var e=this.collection;return function(i){var n=e.get(i._id),s=[r.actions.viewDetails(n)];return"undecided"===i.status&&o.isAllowedTo("PROD_DOWNTIMES:MANAGE")&&o.hasAccessToAor(n.get("aor"))&&s.push({id:"corroborate",icon:"gavel",label:t("prodDowntimes","LIST:ACTION:corroborate"),href:n.genClientUrl("corroborate")}),s}},afterRender:function(){r.prototype.afterRender.call(this);var t=this;this.$('.is-withReasonComment > td[data-id="reason"]').popover({container:this.el,trigger:"hover",placement:"auto right",content:function(){var o=t.$(this).closest("tr").attr("data-id");return t.collection.get(o).get("reasonComment")}}).append('<i class="fa fa-info-circle"></i>').on("shown.bs.popover",function(){t.$(this).data("bs.popover").$tip.addClass("prodDowntimes-comment")})},refreshIfMatches:function(t){this.collection.hasOrMatches(t)&&this.refreshCollection()}})});