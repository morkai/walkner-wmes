define(["underscore","app/i18n","app/user","app/time","app/core/views/ListView","../util/decorateProdDowntime"],function(e,t,i,s,r,o){"use strict";return r.extend({className:"is-colored is-clickable prodDowntimes-list",remoteTopics:{"prodDowntimes.created.*":"refreshIfMatches","prodDowntimes.updated.*":"refreshIfMatches","prodDowntimes.deleted.*":"refreshIfMatches"},columns:function(){return[{id:"rid",className:"is-min"},{id:"orderMrp",tdClassName:"is-min",label:t.bound("prodDowntimes","PROPERTY:mrpControllers")},{id:"prodFlow",className:"is-overflow w275",titleProperty:"prodFlowText"},{id:"aor",className:"is-overflow w275"},{id:"prodLine",className:"is-overflow w125"},"reason",this.options.shiftColumn?{id:"shift",tdClassName:"is-min",valueProperty:"prodShiftText"}:null,{id:"startedAt",tdClassName:"is-min"},{id:"duration",tdClassName:"is-min"}]},serializeRows:function(){var e=this,t=e.options.simple?{}:{changesCount:!0,maxReasonChanges:this.settings.getValue("maxReasonChanges")||Number.MAX_VALUE,maxAorChanges:this.settings.getValue("maxAorChanges")||Number.MAX_VALUE,productFamily:!0},s=i.isAllowedTo("PROD_DATA:VIEW");return this.collection.map(function(i){var r=o(i,t);return s&&e.options.shiftColumn&&r.prodShiftOrder&&(r.startedAt='<a href="#prodShiftOrders/'+(r.prodShiftOrder._id||r.prodShiftOrder)+'">'+r.startedAt+"</a>"),r})},serializeActions:function(){if(this.options.simple)return null;var e=this.collection,i=this.settings.getCanChangeStatusOptions(),s=t("prodDowntimes","changesCount:rejected");return function(o){var a=e.get(o._id),n=[r.actions.viewDetails(a)];if(a.canCorroborate()){var d=a.canChangeStatus(i),l=t("prodDowntimes","LIST:ACTION:"+(d?"corroborate":"comment")),c=null,u=o.changesCount;u.rejected&&(c='<span title="'+s+'" class="label label-'+(u.rejected>=i.maxRejectedChanges?"danger":"warning")+'">'+u.rejected+"</span>"),n.unshift({id:"corroborate",icon:d?"gavel":"comment",label:l,href:a.genClientUrl()+"?corroborate=1",text:c})}return a.isEditable()&&i.canManageProdData&&n.push(r.actions.edit(a),r.actions.delete(a)),n}},refreshIfMatches:function(e){this.collection.hasOrMatches(e)&&this.refreshCollection(e)},afterRender:function(){r.prototype.afterRender.call(this),this.scheduleDurationsUpdate()},scheduleDurationsUpdate:function(){clearTimeout(this.timers.updateDurations),this.timers.updateDurations=setTimeout(this.updateDurations.bind(this),15e3)},updateDurations:function(){var e=this,t=Date.now();this.$('td[data-id="duration"]').each(function(){var i=e.collection.get(this.parentNode.dataset.id);i.get("finishedAt")||(this.textContent=i.getDurationString(t))}),this.scheduleDurationsUpdate()}})});