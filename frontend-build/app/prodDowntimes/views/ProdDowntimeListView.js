// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user","app/viewport","app/core/views/ListView","./CorroborateProdDowntimeView"],function(e,t,o,i,r,s){"use strict";return r.extend({className:"is-colored is-clickable",remoteTopics:{"prodDowntimes.created.*":"refreshIfMatches","prodDowntimes.updated.*":"refreshIfMatches","prodDowntimes.deleted.*":"refreshIfMatches","prodDowntimes.corroborated.*":function(e){e._id===this.corroboratingId&&i.closeDialog()}},events:e.extend(r.prototype.events,{"click .action-corroborate":function(e){e.preventDefault();var o=this;this.broker.subscribe("viewport.dialog.hidden",function(){o.corroboratingId=null}),this.corroboratingId=this.$(e.target).closest("tr").attr("data-id"),i.showDialog(new s({model:this.collection.get(this.corroboratingId)}),t("prodDowntimes","corroborate:title"))}}),columns:[{id:"rid",className:"is-min"},{id:"mrpControllers",tdClassName:"is-min"},"prodFlow","aor",{id:"prodLine",tdClassName:"is-min"},"reason","startedAt","finishedAt",{id:"duration",tdClassName:"is-min"}],initialize:function(){r.prototype.initialize.apply(this,arguments),this.corroboratingId=null,this.listenTo(this.collection,"change",this.render)},serializeActions:function(){var e=this.collection;return function(i){var s=e.get(i._id),n=[r.actions.viewDetails(s)];return"undecided"===i.status&&o.isAllowedTo("PROD_DOWNTIMES:MANAGE")&&o.hasAccessToAor(s.get("aor"))&&n.push({id:"corroborate",icon:"gavel",label:t("prodDowntimes","LIST:ACTION:corroborate"),href:s.genClientUrl("corroborate")}),n}},afterRender:function(){r.prototype.afterRender.call(this);var e=this;this.$('.is-withReasonComment > td[data-id="reason"]').popover({container:this.el,trigger:"hover",placement:"auto right",content:function(){var t=e.$(this).closest("tr").attr("data-id");return e.collection.get(t).get("reasonComment")}}).append('<i class="fa fa-info-circle"></i>').on("shown.bs.popover",function(){e.$(this).data("bs.popover").$tip.addClass("prodDowntimes-comment")})},refreshIfMatches:function(e){this.collection.hasOrMatches(e)&&this.refreshCollection()}})});