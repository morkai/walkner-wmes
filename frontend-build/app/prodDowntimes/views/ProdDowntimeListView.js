// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user","app/core/views/ListView","../util/decorateProdDowntime"],function(e,t,s,n,i){"use strict";return n.extend({className:"is-colored is-clickable prodDowntimes-list",remoteTopics:{"prodDowntimes.created.*":"refreshIfMatches","prodDowntimes.updated.*":"refreshIfMatches","prodDowntimes.deleted.*":"refreshIfMatches"},columns:[{id:"rid",className:"is-min"},{id:"mrpControllers",tdClassName:"is-min"},"prodFlow","aor",{id:"prodLine",tdClassName:"is-min"},"reason","startedAt","finishedAt",{id:"duration",tdClassName:"is-min"}],serializeRows:function(){var e={changesCount:!0,maxReasonChanges:this.settings.getValue("maxReasonChanges")||Number.MAX_VALUE,maxAorChanges:this.settings.getValue("maxAorChanges")||Number.MAX_VALUE};return this.collection.map(function(t){return i(t,e)})},serializeActions:function(){if(this.options.simple)return null;var e=this.collection,s=this.settings.getCanChangeStatusOptions(),i=t("prodDowntimes","changesCount:rejected");return function(a){var r=e.get(a._id),o=[n.actions.viewDetails(r)];if(r.canCorroborate()){var c=r.canChangeStatus(s),l=t("prodDowntimes","LIST:ACTION:"+(c?"corroborate":"comment")),d=null,h=a.changesCount;h.rejected&&(d='<span title="'+i+'" class="label label-'+(h.rejected>=s.maxRejectedChanges?"danger":"warning")+'">'+h.rejected+"</span>"),o.unshift({id:"corroborate",icon:c?"gavel":"comment",label:l,href:r.genClientUrl()+"?corroborate=1",text:d})}return r.isEditable()&&s.canManageProdData&&o.push(n.actions.edit(r),n.actions["delete"](r)),o}},refreshIfMatches:function(e){this.collection.hasOrMatches(e)&&this.refreshCollection(e)}})});