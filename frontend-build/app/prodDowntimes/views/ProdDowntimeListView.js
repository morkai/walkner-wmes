define(["underscore","app/i18n","app/user","app/time","app/core/views/ListView","../util/decorateProdDowntime"],function(e,t,i,s,a,n){"use strict";return a.extend({className:"is-colored is-clickable prodDowntimes-list",remoteTopics:{"prodDowntimes.created.*":"refreshIfMatches","prodDowntimes.updated.*":"refreshIfMatches","prodDowntimes.deleted.*":"refreshIfMatches"},columns:function(){return[{id:"rid",className:"is-min"},{id:"orderMrp",tdClassName:"is-min",label:t.bound("prodDowntimes","PROPERTY:mrpControllers")},{id:"prodFlow",className:"is-overflow w275",titleProperty:"prodFlowText"},{id:"aor",className:"is-overflow w275"},{id:"prodLine",className:"is-overflow w125"},"reason",{id:"startedAt",tdClassName:"is-min"},{id:"duration",tdClassName:"is-min"}]},serializeRows:function(){var e=this.options.simple?null:{changesCount:!0,maxReasonChanges:this.settings.getValue("maxReasonChanges")||Number.MAX_VALUE,maxAorChanges:this.settings.getValue("maxAorChanges")||Number.MAX_VALUE,productFamily:!0};return this.collection.map(function(t){return n(t,e)})},serializeActions:function(){if(this.options.simple)return null;var e=this.collection,i=this.settings.getCanChangeStatusOptions(),s=t("prodDowntimes","changesCount:rejected");return function(n){var o=e.get(n._id),r=[a.actions.viewDetails(o)];if(o.canCorroborate()){var d=o.canChangeStatus(i),c=t("prodDowntimes","LIST:ACTION:"+(d?"corroborate":"comment")),l=null,u=n.changesCount;u.rejected&&(l='<span title="'+s+'" class="label label-'+(u.rejected>=i.maxRejectedChanges?"danger":"warning")+'">'+u.rejected+"</span>"),r.unshift({id:"corroborate",icon:d?"gavel":"comment",label:c,href:o.genClientUrl()+"?corroborate=1",text:l})}return o.isEditable()&&i.canManageProdData&&r.push(a.actions.edit(o),a.actions.delete(o)),r}},refreshIfMatches:function(e){this.collection.hasOrMatches(e)&&this.refreshCollection(e)},afterRender:function(){a.prototype.afterRender.call(this),this.scheduleDurationsUpdate()},scheduleDurationsUpdate:function(){clearTimeout(this.timers.updateDurations),this.timers.updateDurations=setTimeout(this.updateDurations.bind(this),15e3)},updateDurations:function(){var e=this,t=Date.now();this.$('td[data-id="duration"]').each(function(){var i=e.collection.get(this.parentNode.dataset.id);i.get("finishedAt")||(this.textContent=i.getDurationString(t))}),this.scheduleDurationsUpdate()}})});