// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user","app/viewport","app/core/views/ListView","./CorroborateProdDowntimeView","./decorateProdDowntime"],function(t,e,o,r,i,n,s){return i.extend({remoteTopics:{"prodDowntimes.created.*":"refreshIfMatches","prodDowntimes.updated.*":"refreshIfMatches","prodDowntimes.deleted.*":"refreshIfMatches","prodDowntimes.corroborated.*":function(t){t._id===this.corroboratingId&&r.closeDialog()}},events:{"click .action-corroborate":function(t){t.preventDefault();var o=this;this.broker.subscribe("viewport.dialog.hidden",function(){o.corroboratingId=null}),this.corroboratingId=this.$(t.target).closest("tr").attr("data-id"),r.showDialog(new n({model:this.collection.get(this.corroboratingId)}),e("prodDowntimes","corroborate:title"))}},columns:["rid","mrpControllers","prodFlow","aor","prodLine","reason","startedAt","finishedAt","duration"],initialize:function(){i.prototype.initialize.apply(this,arguments),this.corroboratingId=null,this.listenTo(this.collection,"change",this.render)},serializeRows:function(){return this.collection.map(s)},serializeActions:function(){var t=this.collection;return function(r){var n=t.get(r._id),s=[i.actions.viewDetails(n)];return"undecided"===r.status&&o.isAllowedTo("PROD_DOWNTIMES:MANAGE")&&o.hasAccessToAor(n.get("aor"))&&s.push({id:"corroborate",icon:"gavel",label:e("prodDowntimes","LIST:ACTION:corroborate"),href:n.genClientUrl("corroborate")}),s}},afterRender:function(){i.prototype.afterRender.call(this);var t=this;this.$('.is-withReasonComment > td[data-id="reason"]').popover({container:this.el,trigger:"hover",placement:"auto right",content:function(){var e=t.$(this).closest("tr").attr("data-id");return t.collection.get(e).get("reasonComment")}}).append('<i class="fa fa-info-circle"></i>').on("shown.bs.popover",function(){t.$(this).data("bs.popover").$tip.addClass("prodDowntimes-comment")})},refreshIfMatches:function(t){this.collection.hasOrMatches(t)&&this.refreshCollection()}})});