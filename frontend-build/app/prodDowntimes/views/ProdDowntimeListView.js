define(["underscore","app/i18n","app/user","app/time","app/core/views/ListView","../util/decorateProdDowntime"],function(e,t,i,o,r,s){"use strict";return r.extend({className:"is-colored is-clickable prodDowntimes-list",remoteTopics:function(){var e={};return!1!==this.options.autoRefresh&&(this.options.orderId?(e["prodDowntimes.created.*"]="onCreated",e["prodDowntimes.updated.*"]="onUpdated",e["prodDowntimes.deleted.*"]="onDeleted"):(e["prodDowntimes.created.*"]="refreshIfMatches",e["prodDowntimes.updated.*"]="refreshIfMatches",e["prodDowntimes.deleted.*"]="refreshIfMatches")),e},initialize:function(){r.prototype.initialize.apply(this,arguments),this.options.orderId&&this.once("afterRender",function(){this.listenTo(this.collection,"change",this.render)})},columns:function(){return[{id:"rid",className:"is-min"},{id:"orderMrp",tdClassName:"is-min"},{id:"prodFlow",className:"is-overflow w275",titleProperty:"prodFlowText"},{id:"aor",className:"is-overflow w225"},{id:"prodLine",className:"is-overflow w125"},this.options.orderColumn?{id:"orderId",tdClassName:"is-min"}:null,"reason",{id:"shift",tdClassName:"is-min",valueProperty:"prodShiftText"},{id:"startedAt",tdClassName:"is-min",valueProperty:"startedAtTime"},{id:"duration",tdClassName:"is-min"}]},serializeRows:function(){var e=this,t=e.options.simple?{}:{changesCount:!0,maxReasonChanges:this.settings.getValue("maxReasonChanges")||Number.MAX_VALUE,maxAorChanges:this.settings.getValue("maxAorChanges")||Number.MAX_VALUE,productFamily:!0},o=i.isAllowedTo("ORDERS:VIEW"),r=i.isAllowedTo("PROD_DATA:VIEW");return this.collection.map(function(i){var n=s(i,t);return o&&e.options.orderColumn&&!n.mechOrder&&(n.orderId='<a href="#orders/'+n.orderId+'">'+n.orderId+"</a>"),r&&n.prodShiftOrder&&(n.startedAtTime='<a href="#prodShiftOrders/'+(n.prodShiftOrder._id||n.prodShiftOrder)+'">'+n.startedAtTime+"</a>"),n.autoIcon&&(n.startedAtTime+=" "+n.autoIcon),n})},serializeActions:function(){if(this.options.simple)return null;var e=this.collection,i=this.settings.getCanChangeStatusOptions(),o=t("prodDowntimes","changesCount:rejected");return function(s){var n=e.get(s._id),a=[r.actions.viewDetails(n)];if(n.canCorroborate()){var d=n.canChangeStatus(i),l=t("prodDowntimes","LIST:ACTION:"+(d?"corroborate":"comment")),c=null,h=s.changesCount;h.rejected&&(c='<span title="'+o+'" class="label label-'+(h.rejected>=i.maxRejectedChanges?"danger":"warning")+'">'+h.rejected+"</span>"),a.unshift({id:"corroborate",icon:d?"gavel":"comment",label:l,href:n.genClientUrl()+"?corroborate=1",text:c})}return n.isEditable()&&i.canManageProdData&&a.push(r.actions.edit(n),r.actions.delete(n)),a}},refreshIfMatches:function(e){this.collection.hasOrMatches(e)&&this.refreshCollection(e)},afterRender:function(){r.prototype.afterRender.call(this),this.scheduleDurationsUpdate()},scheduleDurationsUpdate:function(){clearTimeout(this.timers.updateDurations),this.timers.updateDurations=setTimeout(this.updateDurations.bind(this),15e3)},updateDurations:function(){var e=this,t=Date.now();this.$('td[data-id="duration"]').each(function(){var i=e.collection.get(this.parentNode.dataset.id);i.get("finishedAt")||(this.textContent=i.getDurationString(t))}),this.scheduleDurationsUpdate()},onCreated:function(e){e.orderId===this.options.orderId&&this.refreshCollection()},onUpdated:function(e){var t=this.collection.get(e._id);t&&t.set(e)},onDeleted:function(e){this.collection.get(e._id)&&this.refreshCollection()}})});