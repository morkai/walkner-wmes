// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["../time","../user","../core/Model","../core/util/getShiftEndDate","./util/decorateProdDowntime"],function(t,e,n,r,i){"use strict";var l={undecided:"warning",confirmed:"success",rejected:"danger"};return n.extend({urlRoot:"/prodDowntimes",clientUrlRoot:"#prodDowntimes",topicPrefix:"prodDowntimes",privilegePrefix:"PROD_DOWNTIMES",nlsDomain:"prodDowntimes",labelAttribute:"rid",defaults:{division:null,subdivision:null,mrpControllers:null,prodFlow:null,workCenter:null,prodLine:null,prodShift:null,prodShiftOrder:null,date:null,shift:null,aor:null,reason:null,reasonComment:null,decisionComment:null,status:null,startedAt:null,finishedAt:null,corroborator:null,corroboratedAt:null,creator:null,master:null,leader:null,operator:null,operators:null,mechOrder:null,orderId:null,operationNo:null},serializeRow:function(){return i(this)},serializeDetails:function(){return i(this,{longDate:!0})},getCssClassName:function(){return l[this.get("status")]},finish:function(){if(null!=this.get("finishedAt"))return null;var e=t.getMoment().toDate(),n=r(this.get("date"),this.get("shift"));return e>n&&(e=n),this.set("finishedAt",e),{_id:this.id,finishedAt:e}},isEditable:function(){return null!=this.get("finishedAt")&&null===this.get("pressWorksheet")},canCorroborate:function(){return null===this.get("pressWorksheet")},canChangeStatus:function(){return this.get("finishedAt")?e.isAllowedTo("PROD_DATA:MANAGE")?!0:e.isAllowedTo("PROD_DOWNTIMES:MANAGE")?"confirmed"!==this.get("status"):!1:!1}},{STATUS:{UNDECIDED:"undecided",CONFIRMED:"confirmed",REJECTED:"rejected"},parse:function(t){return["date","startedAt","finishedAt","createdAt","corroboratedAt"].forEach(function(e){"string"==typeof t[e]&&(t[e]=new Date(t[e]))}),t}})});