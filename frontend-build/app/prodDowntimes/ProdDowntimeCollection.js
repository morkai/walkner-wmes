define(["underscore","../time","../user","../data/prodLog","../core/Collection","./ProdDowntime"],function(r,t,e,n,i,o){return i.extend({model:o,rqlQuery:function(r){var t=[{name:"eq",args:["status","undecided"]}],n=e.getSubdivision();if(n)t.push({name:"eq",args:["subdivision",n.id]});else{var i=e.getDivision();i&&t.push({name:"eq",args:["division",i.id]})}return r.Query.fromObject({fields:{aor:1,reason:1,reasonComment:1,mrpControllers:1,prodFlow:1,prodLine:1,status:1,startedAt:1,finishedAt:1,date:1,shift:1},sort:{startedAt:-1},limit:15,selector:{name:"and",args:t}})},findFirstUnfinished:function(){return this.find(function(r){return null==r.get("finishedAt")})},finish:function(){var r=this.findFirstUnfinished();return r?r.finish():null},addFromInfo:function(r,i){var s=new o({division:r.get("division"),subdivision:r.get("subdivision"),mrpControllers:r.get("mrpControllers"),prodFlow:r.get("prodFlow"),workCenter:r.get("workCenter"),prodLine:r.prodLine.id,prodShift:r.id,prodShiftOrder:r.prodShiftOrder.id||null,date:r.get("date"),shift:r.get("shift"),aor:i.aor,reason:i.reason,reasonComment:i.reasonComment,status:o.STATUS.UNDECIDED,startedAt:t.getMoment().toDate(),creator:e.getInfo(),master:r.get("master"),leader:r.get("leader"),operator:r.get("operator"),mechOrder:r.prodShiftOrder.get("mechOrder"),orderId:r.prodShiftOrder.get("orderId"),operationNo:r.prodShiftOrder.get("operationNo")});s.set("_id",n.generateId(s.get("startedAt"),r.id+i.aor));for(var a=this.rqlQuery.limit<1?1/0:this.rqlQuery.limit;this.length>=a;)this.pop({silent:!0});return this.unshift(s),s},hasOrMatches:function(r){if(r._id){var t=this.get(r._id);if(t)return!0}return this.matchStatus(r)&&this.matchAor(r)&&this.matchReason(r)&&this.matchOrgUnit(r)},matchStatus:function(t){var e=r.find(this.rqlQuery.selector.args,function(r){return("eq"===r.name||"in"===r.name)&&"status"===r.args[0]});return e?"eq"===e.name?t.status===e.args[1]:-1!==e.args[1].indexOf(t.status):!0},matchAor:function(t){var n=r.find(this.rqlQuery.selector.args,function(r){return"eq"===r.name&&"aor"===r.args[0]});return n?t.aor===n.args[1]:Array.isArray(e.data.aors)&&0!==e.data.aors.length?-1!==e.data.aors.indexOf(t.aor):!0},matchReason:function(t){var e=r.find(this.rqlQuery.selector.args,function(r){return"eq"===r.name&&"reason"===r.args[0]});return e?t.reason===e.args[1]:!0},matchOrgUnit:function(){return!0}})});