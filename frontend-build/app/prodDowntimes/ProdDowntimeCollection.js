define(["underscore","../time","../user","../data/prodLog","../core/Collection","../core/util/matchesEquals","../data/orgUnits","../orgUnits/util/limitOrgUnits","./ProdDowntime"],function(r,t,e,i,n,o,s,a,d){"use strict";var u={eq:!0,ne:!0,in:!0,nin:!0};return n.extend({model:d,rqlQuery:function(r){var i=[{name:"in",args:["status",["undecided","rejected"]]},{name:"ge",args:["startedAt",t.getMoment().subtract(2,"weeks").startOf("day").hours(6).valueOf()]}];e.isAllowedTo("PROD_DOWNTIMES:ALL")||a(i,{divisionType:"prod"});var n=e.data.aors;return Array.isArray(n)&&(1===n.length?i.push({name:"eq",args:["aor",n[0]]}):n.length>1&&i.push({name:"in",args:["aor",n]})),r.Query.fromObject({fields:{changes:0},sort:{startedAt:-1},limit:-1337,selector:{name:"and",args:i}})},findFirstUnfinished:function(){return this.find(function(r){return null==r.get("finishedAt")})},finish:function(){var r=this.findFirstUnfinished();return r?r.finish():null},addFromInfo:function(r,n){var o=r.get("date"),s=n.startedAt||t.getMoment().toDate();s<o&&(s=new Date(o.getTime()));var a=new d({division:r.get("division"),subdivision:r.get("subdivision"),subdivisionType:r.prodShiftOrder.get("subdivisionType"),mrpControllers:r.get("mrpControllers"),prodFlow:r.get("prodFlow"),workCenter:r.get("workCenter"),prodLine:r.prodLine.id,prodShift:r.id,prodShiftOrder:r.prodShiftOrder.id||null,date:o,shift:r.get("shift"),aor:n.aor,reason:n.reason,reasonComment:n.reasonComment,status:d.STATUS.UNDECIDED,startedAt:s,creator:e.getInfo(),master:r.get("master"),leader:r.get("leader"),operator:r.get("operator"),operators:r.get("operators"),mechOrder:r.prodShiftOrder.get("mechOrder"),orderId:r.prodShiftOrder.get("orderId"),operationNo:r.prodShiftOrder.get("operationNo"),auto:n.auto||null});a.set("_id",i.generateId(a.get("startedAt"),r.id+n.aor));for(var u=this.rqlQuery.limit<1?1/0:this.rqlQuery.limit;this.length>=u;)this.pop({silent:!0});return this.unshift(a),a},hasOrMatches:function(r){if(r._id&&this.get(r._id))return!0;return o(this.rqlQuery,"status",r.status)&&this.matchProp("aor",r)&&this.matchProp("reason",r)&&this.matchProp(s.TYPES,r)&&o(this.rqlQuery,"prodShift",r.prodShift)&&o(this.rqlQuery,"prodShiftOrder",r.prodShiftOrder)&&o(this.rqlQuery,"orderId",r.orderId)},matchProp:function(t,e){if("string"==typeof t){var i=t;(t={})[i]=!0}var n=r.find(this.rqlQuery.selector.args,function(r){return u[r.name]&&t[r.args[0]]});if(!n)return!0;var o=n.args[0],s=n.args[1],a=e[o];return"eq"===n.name?a===s:"ne"===n.name?a!==s:"in"===n.name?-1!==s.indexOf(a):"nin"!==n.name||-1===s.indexOf(a)},refresh:function(r){for(var t=this.toJSON(),e=(r=r.map(function(r){return d.parse(r)})).length?r[0].startedAt:Number.MAX_VALUE,i=t.length-1;i>=0;--i){var n=t[i];n.startedAt>e&&r.unshift(n)}for(;r.length>8;)r.pop();this.reset(r)}})});