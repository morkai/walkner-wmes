define(["underscore","../time","../user","../data/prodLog","../core/Collection","./ProdDowntime"],function(e,t,n,r,i,o){var a={eq:!0,ne:!0,"in":!0,nin:!0};return i.extend({model:o,rqlQuery:function(e){var t=[{name:"eq",args:["status","undecided"]}];if(!n.isAllowedTo("PROD_DOWNTIMES:ALL")){var r=n.getSubdivision();if(r)t.push({name:"eq",args:["subdivision",r.id]});else{var i=n.getDivision();i&&t.push({name:"eq",args:["division",i.id]})}}return e.Query.fromObject({fields:{aor:1,reason:1,reasonComment:1,mrpControllers:1,prodFlow:1,prodLine:1,status:1,startedAt:1,finishedAt:1,date:1,shift:1},sort:{startedAt:-1},limit:15,selector:{name:"and",args:t}})},findFirstUnfinished:function(){return this.find(function(e){return null==e.get("finishedAt")})},finish:function(){var e=this.findFirstUnfinished();return e?e.finish():null},addFromInfo:function(e,i){var a=new o({division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null,date:e.get("date"),shift:e.get("shift"),aor:i.aor,reason:i.reason,reasonComment:i.reasonComment,status:o.STATUS.UNDECIDED,startedAt:t.getMoment().toDate(),creator:n.getInfo(),master:e.get("master"),leader:e.get("leader"),operator:e.get("operator"),mechOrder:e.prodShiftOrder.get("mechOrder"),orderId:e.prodShiftOrder.get("orderId"),operationNo:e.prodShiftOrder.get("operationNo")});a.set("_id",r.generateId(a.get("startedAt"),e.id+i.aor));for(var s=this.rqlQuery.limit<1?1/0:this.rqlQuery.limit;this.length>=s;)this.pop({silent:!0});return this.unshift(a),a},hasOrMatches:function(e){if(e._id){var t=this.get(e._id);if(t)return!0}return this.matchStatus(e)&&this.matchAor(e)&&this.matchReason(e)&&this.matchOrgUnit(e)},matchStatus:function(t){var n=e.find(this.rqlQuery.selector.args,function(e){return("eq"===e.name||"in"===e.name)&&"status"===e.args[0]});return n?"eq"===n.name?t.status===n.args[1]:-1!==n.args[1].indexOf(t.status):!0},matchAor:function(t){var n=e.find(this.rqlQuery.selector.args,function(e){return"aor"===e.args[0]&&a[e.name]});return n?"eq"===n.name?t.aor===n.args[1]:"ne"===n.name?t.aor!==n.args[1]:"in"===n.name?-1!==n.args[1].indexOf(t.aor):"nin"===n.name?-1===n.args[1].indexOf(t.aor):!0:!0},matchReason:function(t){var n=e.find(this.rqlQuery.selector.args,function(e){return"reason"===e.args[0]&&a[e.name]});return n?"eq"===n.name?t.reason===n.args[1]:"ne"===n.name?t.reason!==n.args[1]:"in"===n.name?-1!==n.args[1].indexOf(t.reason):"nin"===n.name?-1===n.args[1].indexOf(t.reason):!0:!0},matchOrgUnit:function(){return!0}})});