// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["moment-timezone","app/socket"],function(t,e){"use strict";function n(t,e){for(t=String(t);t.length<e;)t="0"+t;return t}var o="TIME:OFFSET",r="TIME:ZONE",a={synced:!1,offset:parseFloat(localStorage.getItem(o))||0,zone:localStorage.getItem(r)||"Europe/Warsaw",appData:window.TIME||0};return delete window.TIME,a.sync=function(){var t=Date.now();e.emit("time",function(e,n){a.offset=(e-t+(e-Date.now()))/2,a.zone=n,a.synced=!0,localStorage.setItem(o,a.offset.toString()),localStorage.setItem(r,a.zone)})},a.getServerMoment=function(){return t(Date.now()+a.offset).tz(a.zone)},a.getMoment=function(e,n){return t(e,n).tz(a.zone)},a.format=function(t,e){var n=a.getMoment(t);return n.isValid()?n.format(e):null},a.toTagData=function(t){var e=a.getMoment(t);return{iso:e.toISOString(),"long":e.format("LLLL"),human:e.fromNow(),daysAgo:-e.diff(Date.now(),"days")}},a.toSeconds=function(t){if("number"==typeof t)return t;if("string"!=typeof t)return 0;var e={g:3600,h:3600,m:60,s:1,ms:.001},n=t.trim(),o=parseInt(n,10);if(/^[0-9]+\.?[0-9]*$/.test(n)===!1){var r,a=/([0-9\.]+) *(h|ms|m|s)[a-z]*/gi;for(o=0;r=a.exec(n);)o+=r[1]*e[r[2].toLowerCase()]}return o},a.toString=function(t,e,o){if("number"!=typeof t||0>=t)return e?"00:00:00":"0s";var r="",a=Math.floor(t/3600);a>0?(r+=e?n(a,2)+":":" "+a+"h",t%=3600):e&&(r+="00:");var f=Math.floor(t/60);f>0?(r+=e?n(f,2)+":":" "+f+"min",t%=60):e&&(r+="00:");var i=t;return i>=1?(r+=e?n(Math.round(i),2):" "+Math.round(i)+"s",o&&i%1!==0&&(r+=e?"."+n(Math.round(i%1*1e3),3):" "+(Math.round(i%1*1e3)+"ms"))):i>0&&""===r?r+=" "+1e3*i+"ms":e&&(r+="00"),e?r:r.substr(1)},e.on("connect",function(){a.sync()}),e.isConnected()&&a.sync(),window.time=a,a});