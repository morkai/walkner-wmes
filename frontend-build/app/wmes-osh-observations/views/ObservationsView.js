define(["underscore","app/viewport","app/core/View","app/wmes-osh-common/dictionaries","app/wmes-osh-nearMisses/NearMiss","app/wmes-osh-nearMisses/views/FormView","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../Observation","app/wmes-osh-observations/templates/details/observations","app/wmes-osh-observations/templates/details/resolutionPopover"],function(e,t,o,i,s,n,l,r,a,d,h){"use strict";return o.extend({template:d,events:{'click a[data-action="addResolution"]':function(e){this.showAddResolutionDialog(this.$(e.target).closest("tr")[0].dataset.id)}},initialize:function(){o.prototype.initialize.apply(this,arguments),this.once("afterRender",()=>{const t=e.debounce(this.render,1);this.listenTo(this.resolutions,"reset change:status",t),this.listenTo(this.model,`change:${this.options.property}`,t),this.listenTo(this.model,"seen",this.onSeen)})},getTemplateData:function(){const e=this.model.getObserver();return{property:this.options.property,observations:this.serializeObservations(),unseen:e.notify&&(e.changes.all||e.changes[this.options.property])}},afterRender:function(){const e=this;e.$el.popover({container:document.body,selector:".osh-observations-details-resolution[data-rid]",placement:"left",trigger:"hover",html:!0,content:function(){const t=e.resolutions.get(this.dataset.rid);if(t)return e.renderPartialHtml(h,{resolution:t.serializePopover()})}})},serializeObservations:function(){return this.model.get(this.options.property).map(t=>{if((t=e.clone(t)).resolution=e.clone(t.resolution),t.resolution.resolvable=a.isResolvableObservation(this.options.property,t),t.resolution._id){const e=this.resolutions.get(t.resolution.rid);t.resolution.url=this.genResolutionUrl(t.resolution),t.resolution.icon=e&&"finished"===e.get("status")?"fa-thumbs-o-up":null}return t})},genResolutionUrl:function(e){return new(0,i.TYPE_TO_MODEL[e.type])({_id:e._id,rid:e.rid}).genClientUrl()},onSeen:function(){this.$(".osh-unseen").removeClass("osh-unseen")},showAddResolutionDialog:function(o){const i=this.model.get(this.options.property).find(e=>e._id===o);if(!i)return;this.model.getRelation();const a=i.easy?"kaizen":"nearMiss";let d=null;if("kaizen"===a)d=new r({relation:this.model,model:new l({subject:this.model.get("subject"),workplace:this.model.get("workplace"),division:this.model.get("division"),building:this.model.get("building"),location:this.model.get("location"),station:this.model.get("station"),problem:i.what,reason:i.why})});else{if("nearMiss"!==a)return;d=new n({relation:this.model,model:new s({subject:this.model.get("subject"),workplace:this.model.get("workplace"),division:this.model.get("division"),building:this.model.get("building"),location:this.model.get("location"),station:this.model.get("station"),problem:i.what,reason:i.why,eventDate:this.model.get("date")})})}t.showDialog(d,this.t(`FORM:resolution:title:${a}`)),d.handleSuccess=(()=>{const i=e.clone(this.model.get(this.options.property)),s=i.findIndex(e=>e._id===o);if(-1===s)return void t.closeDialog();const n=e.clone(i[s]);n.resolution=d.model.getRelation(),n.implementer=d.model.get("creator"),i[s]=n,t.closeDialog(),t.msg.saving();const l=this.promised(this.model.save({[this.options.property]:i}),{wait:!0});l.fail(()=>t.msg.savingFailed()),l.done(()=>t.msg.saved())})}})});