define(["underscore","jquery","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/uuid","app/wmes-osh-common/dictionaries","app/wmes-osh-nearMisses/NearMiss","app/wmes-osh-nearMisses/views/FormView","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../Observation","app/wmes-osh-observations/templates/form/form","app/wmes-osh-observations/templates/form/observationRow","app/wmes-osh-observations/templates/form/resolutionPopover"],function(e,t,i,o,s,n,a,l,r,d,c,h,u,p,g,m){"use strict";return n.extend({template:p,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDivision").val(""),this.setUpUserDivisionSelect2()},"change #-workplace":function(){this.$id("division").val(""),this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-division":function(){this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-building":function(){this.$id("location").val(""),this.$id("station").val(""),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()},"change #-company":function(){this.$id("companyName").val(""),this.toggleCompanyName()},'change input[name="observationKind"]':function(){this.setUpCategories()},'change input[type="file"][data-max]':function(e){const t=e.currentTarget,i=+t.dataset.max;t.setCustomValidity(t.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click .osh-observations-form-radio":function(e){const t=this.$(e.currentTarget).find("input");t.prop("checked",!t.prop("checked")).trigger("change")},'change .osh-observations-categories input[type="radio"]':function(e){this.toggleObservation(this.$(e.target).closest("tr")),this.toggleEasyConfirmed(!0),this.checkDuplicateRid()},'click .btn[data-action="duplicate"]':function(e){const t=this.$(e.currentTarget).closest("tr"),i=+t.find('input[name*="category"]').val(),o=this.renderPartial(g,{i:this.observationI++,duplicate:!0,property:e.currentTarget.dataset.property,observation:{_id:a(),category:i,text:l.getLabel("observationCategory",i,{long:!0}),description:l.getDescription("observationCategory",i),safe:null,easy:null,what:"",why:"",resolution:{_id:0,rid:"",type:"unspecified"}}});o.insertAfter(t),this.toggleObservation(o)},'click .btn[data-action="remove"]':function(e){const t=this.$(e.target).closest("tr"),i=!!t.find('input[name*="easy"][value="true"]:checked').length;t.remove(),this.toggleEasyConfirmed(i),this.toggleRequiredWorkCondition()},'click .btn[data-action="addResolution"]':function(e){this.showAddResolutionDialog(this.$(e.target).closest("tr"))},'click .btn[data-action="showResolution"]':function(e){this.showResolutionPopover(this.$(e.target).closest("tr"))},'input input[name$="resolution.rid"]':function(e){this.resetResolution(this.$(e.target).closest("tr"))},'change input[name$="resolution.rid"]':function(e){this.loadResolution(this.$(e.target).closest("tr"),!1)}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),this.observationI=0,this.addedResolutions={},this.loadedResolutions={},this.resolutionReq=null,this.$resolutionPopover=null,t(document).on(`click.${this.idPrefix}`,this.onDocumentClick.bind(this)).on(`keydown.${this.idPrefix}`,this.onDocumentKeyDown.bind(this))},destroy:function(){n.prototype.destroy.apply(this,arguments),t(document).off(`.${this.idPrefix}`),this.hideResolutionPopover()},getTemplateData:function(){return{today:o.getMoment().format("YYYY-MM-DD"),kinds:this.serializeKinds()}},serializeKinds:function(){const e={};l.observationKinds.forEach(t=>{t.get("active")&&(e[t.id]={value:t.id,label:t.getLabel({long:!0}),title:t.get("description")})});const t=l.kinds.get(this.model.get("kind"));return t&&!e[t]&&(e[t.id]={value:t.id,label:t.getLabel({long:!0}),title:t.get("description")}),Object.values(e).sort((e,t)=>e.label.localeCompare(t.label))},serializeToForm:function(){const e=this.model.toJSON();if(this.options.editMode){const t=o.utc.getMoment(e.date);e.date=t.format("YYYY-MM-DD"),e.time=t.format("H"),e.easyConfirmed=(e.behaviors||[]).some(e=>!0===e.easy)}else{const t=o.getMoment();e.date=t.format("YYYY-MM-DD"),e.time=t.format("H"),e.easyConfirmed=!1}return delete e.coordinators,delete e.attachments,delete e.users,delete e.changes,e},serializeForm:function(e){const t=this.$id("company").select2("data");e.company=t.id,0!==t.id&&(e.companyName=t.text),e.userWorkplace=this.$id("userWorkplace").select2("data").id,e.userDivision=this.$id("userDivision").select2("data").id,e.workplace=this.$id("workplace").select2("data").id,e.division=this.$id("division").select2("data").id,e.building=this.$id("building").select2("data").id,e.location=this.$id("location").select2("data").id,e.station=parseInt(this.$id("station").val(),10)||null,e.date=o.utc.getMoment(`${e.date} ${(e.time||"00").padStart(2,"0")}:00:00`,"YYYY-MM-DD HH:mm:ss").toISOString(),e.observationKind&&(e.observationKind=+e.observationKind);const i=this.$id("behaviors").children();return e.behaviors=(e.behaviors||[]).filter((e,t)=>{return!!i[t].querySelector('input[name*="safe"]:checked')&&(e.category=+e.category,e.safe=!0===e.safe,e.easy=e.safe?null:e.easy,e.what=(e.what||"").trim(),e.why=(e.why||"").trim(),e.resolution._id=parseInt(e.resolution._id,10)||0,e.resolution.rid=e.resolution.rid||"",e.implementer=null,0===e.resolution._id&&(e.resolution.rid="",e.resolution.type="unspecified"),!0)}),e.workConditions=(e.workConditions||[]).filter(e=>"boolean"==typeof e.safe&&(e.category=+e.category,e.safe=!1,e.easy=!0===e.easy,e.what=(e.what||"").trim(),e.why=(e.why||"").trim(),e.resolution._id=parseInt(e.resolution._id,10)||0,e.resolution.rid=e.resolution.rid||"",e.implementer=null,0===e.resolution._id&&(e.resolution.rid="",e.resolution.type="unspecified"),!0)),e},checkValidity:function(e){return console.log(e),!0},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpCompanySelect2(),this.options.editMode?this.setUpCategories():this.toggleKind()},setUpUserWorkplaceSelect2:function(){const e=this.$id("userWorkplace");if(this.options.editMode){const t=l.workplaces.get(this.model.get("userWorkplace"));return e.val(t?t.id:"").select2({width:"100%",placeholder:" ",data:t?[{id:t.id,text:t.getLabel({long:!0}),model:t}]:[]}),void e.select2("enable",!1)}e.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let t=l.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o={};l.workplaces.forEach(e=>{e.get("active")&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!o[t.id]&&(o[t.id]=t),e.select2({width:"100%",data:Object.values(o).sort((e,t)=>e.text.localeCompare(t.text))});const s=l.workplaces.get(i.data.oshWorkplace);this.options.editMode&&t?e.select2("enable",!1).select2("data",t):s?e.select2("enable",!1).select2("data",{id:s.id,text:s.getLabel({long:!0}),model:s}):e.select2("enable",!0)},setUpUserDivisionSelect2:function(){const e=this.$id("userDivision");if(this.options.editMode){const t=l.divisions.get(this.model.get("userDivision"));return e.val(t?t.id:"").select2({width:"100%",placeholder:" ",data:t?[{id:t.id,text:t.getLabel({long:!0}),model:t}]:[]}),void e.select2("enable",!1)}const t=+this.$id("userWorkplace").val();let o=l.divisions.get(+e.val());o&&(o={id:o.id,text:o.getLabel({long:!0}),model:o});const s={};l.divisions.forEach(e=>{e.get("active")&&e.get("workplace")===t&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),o&&!s[o.id]&&o.model.get("workplace")===t&&(s[o.id]=o);const n=Object.values(s).sort((e,t)=>e.text.localeCompare(t.text));let a=" ",r=!0;t||0!==n.length||(a=this.t("FORM:placeholder:noUserWorkplace"),r=!1),e.select2({width:"100%",placeholder:a,data:n});const d=l.divisions.get(i.data.oshDivision);this.options.editMode&&o?e.select2("enable",!1).select2("data",o):d?e.select2("enable",!1).select2("data",{id:d.id,text:d.getLabel({long:!0}),model:d}):(e.select2("enable",r),1===n.length?e.select2("data",n[0]):s[e.val()]||e.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");let t=l.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const i={};l.workplaces.forEach(e=>{e.get("active")&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!i[t.id]&&(i[t.id]=t),e.select2({width:"100%",data:Object.values(i).sort((e,t)=>e.text.localeCompare(t.text))}),e.select2("enable",!this.options.editMode||u.can.manage()||this.model.isCoordinator())},setUpDivisionSelect2:function(){const e=this.$id("division"),t=+this.$id("workplace").val();let i=l.divisions.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const o={};l.divisions.forEach(e=>{e.get("active")&&e.hasWorkplace(t)&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!o[i.id]&&(o[i.id]=i);const s=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noWorkplace"),data:s}),1===s.length?e.select2("data",s[0]):o[e.val()]||e.val("").select2("data",null),e.select2("enable",!!t&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(){const e=this.$id("building"),t=+this.$id("division").val(),i={};l.buildings.forEach(e=>{e.get("active")&&e.hasDivision(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noDivision"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const e=this.$id("location"),t=+this.$id("building").val(),i={};l.locations.forEach(e=>{e.get("active")&&e.hasBuilding(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noBuilding"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const e=this.$id("station"),t=+this.$id("location").val(),i={};l.stations.forEach(e=>{e.get("active")&&e.hasLocation(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noLocation"),allowClear:!0,data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",o.length>0&&!!t&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpCompanySelect2:function(){const e=this.$id("company"),t={};l.companies.forEach(e=>{e.get("active")&&(t[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const i=Object.values(t).sort((e,t)=>e.text.localeCompare(t.text));i.push({id:0,text:this.t("FORM:company:other")}),e.select2({width:"100%",placeholder:" ",data:i}),this.toggleCompanyName()},toggleCompanyName:function(){const e="0"===this.$id("company").val();this.$id("companyName").prop("disabled",!e).prop("required",e).closest(".form-group").find(".control-label").toggleClass("is-required",e)},setUpCategories:function(){const e=l.observationKinds.get(this.options.editMode?this.model.get("observationKind"):+this.$('input[name="observationKind"]:checked').val());this.setUpObservations("behaviors",e),this.setUpObservations("workConditions",e),this.toggleEasyConfirmed(!1)},setUpObservations:function(e,i){const o=new Map;i&&i.get(e).forEach(e=>{const t=l.observationCategories.get(e);t&&t.get("active")&&o.set(e,t)});const s=[];(this.model.get(e)||[]).forEach(e=>{o.delete(e.category),s.push({_id:e._id,category:e.category,text:e.text,description:l.getDescription("observationCategory",e.category),safe:e.safe,easy:e.easy,what:e.what,why:e.why,resolution:e.resolution})}),o.forEach(e=>{s.push({_id:a(),category:e.id,text:e.get("longName"),description:e.get("description"),safe:null,easy:null,what:"",why:"",resolution:{_id:0,rid:"",type:"unspecified"}})}),this.$id(e).html(s.map(t=>this.renderPartialHtml(g,{i:this.observationI++,duplicate:!1,property:e,observation:t}))),this.$id(e).children().each((e,i)=>{this.toggleObservation(t(i))})},toggleKind:function(){const e=this.$('input[name="observationKind"]');e.length&&!e.filter(":checked").length&&e.first().click()},toggleObservation:function(e){e.removeClass("success warning danger");const t=e.find('textarea[name*="what"]'),i=e.find('textarea[name*="why"]'),o=a(e.find('input[name*="safe"]:checked').val());let s=a(e.find('input[name*="easy"]:checked').val());const n=!1===o;function a(e){return"true"===e||"false"!==e&&null}t.prop("disabled",!n),i.prop("disabled",!n),n||(e.find('input[name*="easy"]').prop("checked",!1).prop("disabled",!0).closest("td").addClass("disabled"),e.find("textarea").prop("required",!1)),o?e.addClass("success"):n&&(e.find('input[name*="easy"]').prop("disabled",!1).closest("td").removeClass("disabled"),e.find("textarea").prop("required",!0),s?e.addClass("warning"):!1===s?e.addClass("danger"):(s=!0,e.find('input[name*="easy"][value="true"]').prop("checked",!0),e.addClass("warning"))),this.toggleResolution(e,n,s)},toggleResolution:function(e,t,i){const o=e.find(".osh-observations-form-resolution"),s=o.find(".form-control, .btn"),n=o.find('input[name$="resolution._id"]'),a=o.find('input[name$="resolution.rid"]'),l=o.find('input[name$="resolution.type"]'),r=s[0].name.startsWith("behavior"),d=r?t&&!i:t,c=d?r?"nearMiss":i?"kaizen":"nearMiss":"unspecified",h=l.val();let u={_id:+n.val(),rid:a.val(),type:c};if(c!==h){const t=e.find('input[name$="_id"]').first().val(),i=(this.addedResolutions[t]||{})[c];if(i)u=i.getRelation();else{const e=r?"behaviors":"workConditions",i=d?(this.model.get(e)||[]).find(e=>e._id===t):null;i&&i.resolution._id?Object.assign(u,i.resolution):u={_id:0,rid:"",type:c}}}r||this.scheduleRequiredWorkConditionToggle(),s.prop("disabled",!d),l.val(u.type),n.val(u._id),a.val(u.rid).prop("required","nearMiss"===c).prop("placeholder",this.t(`FORM:resolution:placeholder:${u.type}`))},scheduleRequiredWorkConditionToggle:function(){clearTimeout(this.timers.toggleRequiredWorkCondition),this.timers.toggleRequiredWorkCondition=setTimeout(this.toggleRequiredWorkCondition.bind(this),1)},toggleRequiredWorkCondition:function(){if(this.options.editMode&&!this.model.isCreator())return;const e=this.$id("workConditions").find('input[name$=".rid"]:not([disabled])').filter((e,t)=>"kaizen"===t.previousElementSibling.value);if(0===e.length)return;const t=0===e.filter((e,t)=>""!==t.value).length;e.each((e,i)=>{i.required=0===e&&t})},toggleEasyConfirmed:function(e){const t=this.$id("behaviors").find('input[name*="easy"][value="true"]:checked'),i=this.$('input[name="easyConfirmed"]');e&&i.prop("checked",!1),i.prop("required",t.length>0).closest("div").toggleClass("hidden",0===t.length)},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var e=n.prototype.request.apply(this,arguments);return e.always(function(){s.msg.saved()}),e},submitRequest:function(e,t){const i=this,o=new FormData;let a=0;if(i.$('input[type="file"]').each(function(){const e=this.name.replace("attachments.","");for(let t=0;t<this.files.length;++t)o.append(e,this.files[t]),a+=1}),0===a)return n.prototype.submitRequest.call(i,e,t);s.msg.saving();const l=i.ajax({type:"POST",url:"/osh/attachments",data:o,processData:!1,contentType:!1});l.done(o=>{t.attachments={added:o},n.prototype.submitRequest.call(i,e,t),s.msg.saved()}),l.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),e.attr("disabled",!1)})},showAddResolutionDialog:function(e){const t=this.$('input[name$="resolution.rid"][required]');t.each((e,t)=>{t.required=!1});const i=this.el.checkValidity();if(i||this.$id("save").click(),t.each((e,t)=>{t.required=!0}),!i)return;const o=this.getResolutionInfo(e),n=Object.assign(this.model.toJSON(),this.getFormData()),a=e.find('input[name$="_id"]').first().val(),u=n[e.closest("tbody")[0].dataset.observationsProp].find(e=>e._id===a);if(!u)return;const p=l.getLabel("observationCategory",u.category,{long:!0}),g=o.relation.type;let m=null;if("kaizen"===g)m=new h({relation:this.model,model:new c({subject:p,workplace:n.workplace,division:n.division,building:n.building,location:n.location,station:n.station,problem:u.what,reason:u.why})});else{if("nearMiss"!==g)return;m=new d({relation:this.model,model:new r({subject:p,workplace:n.workplace,division:n.division,building:n.building,location:n.location,station:n.station,problem:u.what,reason:u.why,eventDate:n.date})})}s.showDialog(m,this.t(`FORM:resolution:title:${g}`)),m.handleSuccess=(()=>{const e=m.model.get("rid");this.loadedResolutions[e]=m.model,this.addedResolutions[a]||(this.addedResolutions[a]={}),this.addedResolutions[a][g]=m.model,o.$id.val(m.model.id),o.$rid.val(e),s.closeDialog()})},showResolutionPopover:function(e){const t=this.getResolutionInfo(e);if(!t.relation.rid)return void t.$rid.focus();if(!t.$rid[0].checkValidity())return void t.$rid[0].reportValidity();if(!t.model)return this.loadResolution(e,!0);const i=e.find('.btn[data-action="showResolution"]');i.data("bs.popover")||(i.popover({container:i.closest("td"),trigger:"click",placement:"top",html:!0,title:function(){return""},content:this.renderPartialHtml(m,{relation:t.relation,data:t.model.toJSON(),url:t.model.genClientUrl()})}),i.popover("show"),this.$resolutionPopover=i)},hideResolutionPopover:function(){this.$resolutionPopover&&(this.$resolutionPopover.popover("destroy"),this.$resolutionPopover=null)},resetResolution:function(e){const t=this.getResolutionInfo(e);"0"!==t.$id.val()&&this.checkDuplicateRid(),t.$id.val("0"),t.$rid[0].setCustomValidity(""),this.hideResolutionPopover(),"kaizen"===t.relation.type&&this.scheduleRequiredWorkConditionToggle()},loadResolution:function(t,i){const o=this.getResolutionInfo(t),n=this.prepareRid(o.$rid.val(),o.relation.type);if(this.resetResolution(t),o.$rid.val(n),!n)return;const a=this.checkDuplicateRid(n);if(a.length>1)return void e.last(a).reportValidity();if(this.isDuplicateRid(o.$rid[0]))return o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:duplicate")),void o.$rid[0].reportValidity();if(this.loadedResolutions[n])return o.$id.val(this.loadedResolutions[n].id),void("kaizen"===o.relation.type&&this.toggleRequiredWorkCondition());s.msg.loading(),o.$rid.prop("disabled",!0),o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:loading")),o.$buttons.prop("disabled",!0),o.$actions.prop("disabled",!0);const r=this.resolutionReq=this.ajax({url:`/osh/${l.TYPE_TO_MODULE[o.relation.type]}?rid=${n}&exclude(changes)&limit(1)`});r.fail(()=>{s.msg.loadingFailed(),o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:failure"))}),r.done(e=>{if(s.msg.loaded(),!e.collection||!e.collection.length)return void o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:notFound"));const a=e.collection[0];if("finished"===a.status&&!u.can.assignFinished(this.model))return void o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:finished"));const r=new(0,l.TYPE_TO_MODEL[o.relation.type])(a);this.loadedResolutions[n]=r,o.$id.val(r.id),o.$rid[0].setCustomValidity(""),i&&this.showResolutionPopover(t)}),r.always(()=>{r===this.resolutionReq&&(o.$actions.prop("disabled",!1),this.resolutionReq=null),o.$rid.prop("disabled",!1),o.$buttons.prop("disabled",!1),o.$rid[0].checkValidity()||o.$rid[0].reportValidity(),"kaizen"===o.relation.type&&this.toggleRequiredWorkCondition()})},checkDuplicateRid:function(t){const i=new Map;this.$('input[name$="resolution.rid"]').each((e,t)=>{const o=t.value;o.length&&(i.has(o)||i.set(o,[]),i.get(o).push(t))});const o=this.t("FORM:resolution:error:duplicate");return i.forEach(t=>{if(t.forEach(e=>{e.validationMessage===o&&e.setCustomValidity("")}),1===t.length)return;const i=e.last(t);i.checkValidity()&&i.setCustomValidity(o)}),i.get(t)||[]},isDuplicateRid:function(e){let t=!1;return this.$('input[name$="resolution.rid"]').each((i,o)=>{t||o===e||(t=o.value===e.value)}),t},prepareRid:function(e,t){const i=e.trim().match(/([zkZK]-)?([0-9]{4}-)?([0-9]{1,6})/);return e="",i&&(e+=(i[1]||l.TYPE_TO_PREFIX[t]).charAt(0).toUpperCase(),e+="-"+(i[2]||o.format(Date.now(),"YYYY")).substring(0,4),e+="-"+i[3].padStart(6,"0")),e},getResolutionInfo:function(e){const t=e.find(".osh-observations-form-resolution"),i=t.find('input[name$="_id"]'),o=t.find('input[name$="rid"]'),s=t.find('input[name$="type"]'),n=o.val();return{$observation:e,$resolution:t,$id:i,$rid:o,$type:s,$buttons:t.find(".btn"),$actions:this.$(".form-actions").find(".btn"),model:this.loadedResolutions[n]||null,relation:{_id:+i.val(),rid:n,type:s.val()}}},onDocumentClick:function(e){if(!this.$resolutionPopover)return;const t=this.$(e.target).closest(".osh-observations-form-resolution");t.length&&t[0]===this.$resolutionPopover.closest(".osh-observations-form-resolution")[0]||this.hideResolutionPopover()},onDocumentKeyDown:function(e){if("Escape"===e.key&&this.$resolutionPopover)return this.hideResolutionPopover(),!1}})});