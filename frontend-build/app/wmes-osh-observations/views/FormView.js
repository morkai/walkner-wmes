define(["underscore","jquery","app/user","app/time","app/viewport","app/core/util/uuid","app/wmes-osh-common/dictionaries","app/wmes-osh-common/views/FormView","app/wmes-osh-nearMisses/NearMiss","app/wmes-osh-nearMisses/views/FormView","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../Observation","app/wmes-osh-observations/templates/form/form","app/wmes-osh-observations/templates/form/observationRow","app/wmes-osh-observations/templates/form/resolutionPopover"],function(t,e,i,o,s,n,a,l,r,d,c,h,p,u,m,g){"use strict";return l.extend({template:u,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDepartment").val(""),this.setUpUserDepartmentSelect2()},"change #-workplace":function(){this.$id("department").val(""),this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-department":function(){this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-building":function(){this.$id("location").val(""),this.$id("station").val(""),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()},"change #-company":function(){this.$id("companyName").val(""),this.toggleCompanyName()},'change input[name="observationKind"]':function(){this.setUpCategories()},'change input[type="file"][data-max]':function(t){const e=t.currentTarget,i=+e.dataset.max;e.setCustomValidity(e.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click .osh-observations-form-radio":function(t){const e=this.$(t.currentTarget).find("input");e.prop("checked",!e.prop("checked")).trigger("change")},'change .osh-observations-categories input[type="radio"]':function(t){this.toggleObservation(this.$(t.target).closest("tr")),this.toggleEasyConfirmed(!0),this.checkDuplicateRid()},'click .btn[data-action="duplicate"]':function(t){const e=this.$(t.currentTarget).closest("tr"),i=+e.find('input[name*="category"]').val(),o=this.renderPartial(m,{i:this.observationI++,duplicate:!0,property:t.currentTarget.dataset.property,observation:{_id:n(),category:i,text:a.getLabel("observationCategory",i,{long:!0}),description:a.getDescription("observationCategory",i),safe:null,easy:null,what:"",why:"",resolution:{_id:0,rid:"",type:"unspecified"}}});o.insertAfter(e),this.toggleObservation(o)},'click .btn[data-action="remove"]':function(t){const e=this.$(t.target).closest("tr"),i=!!e.find('input[name*="easy"][value="true"]:checked').length;e.remove(),this.toggleEasyConfirmed(i),this.toggleRequiredWorkCondition()},'click .btn[data-action="addResolution"]':function(t){this.showAddResolutionDialog(this.$(t.target).closest("tr"))},'click .btn[data-action="showResolution"]':function(t){this.showResolutionPopover(this.$(t.target).closest("tr"))},'input input[name$="resolution.rid"]':function(t){this.resetResolution(this.$(t.target).closest("tr"))},'change input[name$="resolution.rid"]':function(t){this.loadResolution(this.$(t.target).closest("tr"),!1)},'change input[name="time"]':function(){const t=this.$id("time"),e=t.val().match(/([0-9]{1,2})(?::([0-9]{1,2}))/)||[null,"00","00"],i=parseInt(e[1],10),o=parseInt(e[2],10),s=i>=0&&i<24?i.toString().padStart(2,"0"):"00",n=o>=0&&o<60?o.toString().padStart(2,"0"):"00";t.val(`${s}:${n}`)}},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.observationI=0,this.addedResolutions={},this.loadedResolutions={},this.resolutionReq=null,this.$resolutionPopover=null,e(document).on(`click.${this.idPrefix}`,this.onDocumentClick.bind(this)).on(`keydown.${this.idPrefix}`,this.onDocumentKeyDown.bind(this))},destroy:function(){l.prototype.destroy.apply(this,arguments),e(document).off(`.${this.idPrefix}`),this.hideResolutionPopover()},getTemplateData:function(){return{today:o.getMoment().format("YYYY-MM-DD"),kinds:this.serializeKinds()}},serializeKinds:function(){const t={};a.observationKinds.forEach(e=>{e.get("active")&&(t[e.id]={value:e.id,label:e.getLabel({long:!0}),title:e.get("description"),model:e})});const e=a.kinds.get(this.model.get("kind"));return e&&!t[e]&&(t[e.id]={value:e.id,label:e.getLabel({long:!0}),title:e.get("description"),model:e}),Object.values(t).sort((t,e)=>t.model.get("position")-e.model.get("position"))},serializeToForm:function(){const t=this.model.toJSON();if(this.options.editMode){const e=o.utc.getMoment(t.date);t.date=e.format("YYYY-MM-DD"),t.time=e.format("HH:mm"),t.easyConfirmed=(t.behaviors||[]).some(t=>!0===t.easy)}else{const e=o.getMoment();t.date=e.format("YYYY-MM-DD"),t.time=e.format("HH:mm"),t.easyConfirmed=!1}return delete t.coordinators,delete t.attachments,delete t.users,delete t.changes,t},serializeForm:function(t){const e=this.$id("company").select2("data");t.company=e.id,0!==e.id&&(t.companyName=e.text);const i=this.$id("userWorkplace").select2("data");t.userDivision=i.model.get("division"),t.userWorkplace=i.id,t.userDepartment=this.$id("userDepartment").select2("data").id;const s=this.$id("workplace").select2("data");t.division=s.model.get("division"),t.workplace=s.id,t.department=this.$id("department").select2("data").id,t.building=this.$id("building").select2("data").id,t.location=this.$id("location").select2("data").id,t.station=parseInt(this.$id("station").val(),10)||0,t.date=o.utc.getMoment(`${t.date} ${t.time||"00:00"}:00`,"YYYY-MM-DD HH:mm:ss").toISOString(),delete t.time,t.observationKind&&(t.observationKind=+t.observationKind);const n=this.$id("behaviors").children();return t.behaviors=(t.behaviors||[]).filter((t,e)=>{return!!n[e].querySelector('input[name*="safe"]:checked')&&(t.category=+t.category,t.safe=!0===t.safe,t.easy=t.safe?null:t.easy,t.what=(t.what||"").trim(),t.why=(t.why||"").trim(),t.resolution._id=parseInt(t.resolution._id,10)||0,t.resolution.rid=t.resolution.rid||"",t.implementer=null,0===t.resolution._id&&(t.resolution.rid="",t.resolution.type="unspecified"),!0)}),t.workConditions=(t.workConditions||[]).filter(t=>"boolean"==typeof t.safe&&(t.category=+t.category,t.safe=!1,t.easy=!0===t.easy,t.what=(t.what||"").trim(),t.why=(t.why||"").trim(),t.resolution._id=parseInt(t.resolution._id,10)||0,t.resolution.rid=t.resolution.rid||"",t.implementer=null,0===t.resolution._id&&(t.resolution.rid="",t.resolution.type="unspecified"),!0)),delete t.easyConfirmed,t},checkValidity:function(t){if(!t.behaviors.length&&!t.workConditions.length){const t=this.$('input[name$=".safe"]').first();return t[0].setCustomValidity(this.t("FORM:ERROR:empty")),t.one("blur",()=>{t[0].setCustomValidity("")}),t.focus()[0].reportValidity(),!1}return!0},afterRender:function(){l.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpCompanySelect2(),this.options.editMode?this.setUpCategories():this.toggleKind()},setUpUserWorkplaceSelect2:function(){const t=this.$id("userWorkplace");if(this.options.editMode){const e=this.model.get("creator").oshWorkplace,i=a.workplaces.get(e);return t.val(e).select2({width:"100%",placeholder:" ",data:i?[{id:e,text:i?i.getLabel({long:!0}):`?${e}?`,model:i}]:[]}),void t.select2("enable",!1)}t.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let e=a.workplaces.get(+t.val());e&&(e={id:e.id,text:e.getLabel({long:!0}),model:e});const o={};a.workplaces.forEach(t=>{t.get("active")&&(o[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),e&&!o[e.id]&&(o[e.id]=e),t.select2({width:"100%",data:Object.values(o).sort((t,e)=>t.text.localeCompare(e.text))});const s=a.workplaces.get(i.data.oshWorkplace);this.options.editMode&&e?t.select2("enable",!1).select2("data",e):s?t.select2("enable",!1).select2("data",{id:s.id,text:s.getLabel({long:!0}),model:s}):t.select2("enable",!0)},setUpUserDepartmentSelect2:function(){const t=this.$id("userDepartment");if(this.options.editMode){const e=this.model.get("creator").oshDepartment,i=a.departments.get(e);return t.val(e).select2({width:"100%",placeholder:" ",data:i?[{id:e,text:i?i.getLabel({long:!0}):`?${e}?`,model:i}]:[]}),void t.select2("enable",!1)}const e=+this.$id("userWorkplace").val();let o=a.departments.get(+t.val());o&&(o={id:o.id,text:o.getLabel({long:!0}),model:o});const s={};a.departments.forEach(t=>{t.get("active")&&t.get("workplace")===e&&(s[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),o&&!s[o.id]&&o.model.get("workplace")===e&&(s[o.id]=o);const n=Object.values(s).sort((t,e)=>t.text.localeCompare(e.text));let l=" ",r=!0;e||0!==n.length||(l=this.t("FORM:placeholder:noUserWorkplace"),r=!1),t.select2({width:"100%",placeholder:l,data:n});const d=a.departments.get(i.data.oshDepartment);this.options.editMode&&o?t.select2("enable",!1).select2("data",o):d?t.select2("enable",!1).select2("data",{id:d.id,text:d.getLabel({long:!0}),model:d}):(t.select2("enable",r),1===n.length?t.select2("data",n[0]):s[t.val()]||t.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const t=this.$id("workplace");let e=a.workplaces.get(+t.val());e&&(e={id:e.id,text:e.getLabel({long:!0}),model:e});const i={};a.workplaces.forEach(t=>{t.get("active")&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),e&&!i[e.id]&&(i[e.id]=e),t.select2({width:"100%",data:Object.values(i).sort((t,e)=>t.text.localeCompare(e.text))}),t.select2("enable",!this.options.editMode||p.can.manage()||this.model.isCoordinator())},setUpDepartmentSelect2:function(){const t=this.$id("department"),e=+this.$id("workplace").val();let i=a.departments.get(+t.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const o={};a.departments.forEach(t=>{t.get("active")&&t.hasWorkplace(e)&&(o[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!o[i.id]&&(o[i.id]=i);const s=Object.values(o).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noWorkplace"),data:s}),1===s.length?t.select2("data",s[0]):o[t.val()]||t.val("").select2("data",null),t.select2("enable",!!e&&(!this.options.editMode||p.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(){const t=this.$id("building"),e=+this.$id("department").val(),i={};a.buildings.forEach(t=>{t.get("active")&&t.hasDepartment(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const o=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noDepartment"),data:o}),1===o.length&&t.select2("data",o[0]),t.select2("enable",!!e&&(!this.options.editMode||p.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const t=this.$id("location"),e=+this.$id("building").val(),i={};a.locations.forEach(t=>{t.get("active")&&t.hasBuilding(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const o=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noBuilding"),data:o}),1===o.length&&t.select2("data",o[0]),t.select2("enable",!!e&&(!this.options.editMode||p.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const t=this.$id("station"),e=+this.$id("location").val(),i={};a.stations.forEach(t=>{t.get("active")&&t.hasLocation(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const o=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noLocation"),allowClear:!0,data:o}),this.options.editMode||1!==o.length||t.select2("data",o[0]),t.select2("enable",o.length>0&&!!e&&(!this.options.editMode||p.can.manage()||this.model.isCoordinator()))},setUpCompanySelect2:function(){const t=this.$id("company"),e={};a.companies.forEach(t=>{t.get("active")&&(e[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const i=Object.values(e).sort((t,e)=>t.text.localeCompare(e.text));i.push({id:0,text:this.t("FORM:company:other")}),t.select2({width:"100%",placeholder:" ",data:i}),this.toggleCompanyName()},toggleCompanyName:function(){const t="0"===this.$id("company").val();this.$id("companyName").prop("disabled",!t).prop("required",t).closest(".form-group").find(".control-label").toggleClass("is-required",t)},setUpCategories:function(){const t=a.observationKinds.get(this.options.editMode?this.model.get("observationKind"):+this.$('input[name="observationKind"]:checked').val());this.setUpObservations("behaviors",t),this.setUpObservations("workConditions",t),this.toggleEasyConfirmed(!1)},setUpObservations:function(t,i){const o=new Map;i&&i.get(t).forEach(t=>{const e=a.observationCategories.get(t);e&&e.get("active")&&o.set(t,e)});const s=[];(this.model.get(t)||[]).forEach(t=>{o.delete(t.category),s.push({_id:t._id,category:t.category,text:t.text,description:a.getDescription("observationCategory",t.category),safe:t.safe,easy:t.easy,what:t.what,why:t.why,resolution:t.resolution})}),o.forEach(t=>{s.push({_id:n(),category:t.id,text:t.get("longName"),description:t.get("description"),safe:null,easy:null,what:"",why:"",resolution:{_id:0,rid:"",type:"unspecified"}})}),this.$id(t).html(s.map(e=>this.renderPartialHtml(m,{i:this.observationI++,duplicate:!1,property:t,observation:e}))),this.$id(t).children().each((t,i)=>{this.toggleObservation(e(i))})},toggleKind:function(){const t=this.$('input[name="observationKind"]');t.length&&!t.filter(":checked").length&&t.first().click()},toggleObservation:function(t){t.removeClass("success warning danger");const e=t.find('textarea[name*="what"]'),i=t.find('textarea[name*="why"]'),o=a(t.find('input[name*="safe"]:checked').val());let s=a(t.find('input[name*="easy"]:checked').val());const n=!1===o;function a(t){return"true"===t||"false"!==t&&null}e.prop("disabled",!n),i.prop("disabled",!n),n||(t.find('input[name*="easy"]').prop("checked",!1).prop("disabled",!0).closest("td").addClass("disabled"),t.find("textarea").prop("required",!1)),o?t.addClass("success"):n&&(t.find('input[name*="easy"]').prop("disabled",!1).closest("td").removeClass("disabled"),t.find("textarea").prop("required",!0),s?t.addClass("warning"):!1===s?t.addClass("danger"):(s=!0,t.find('input[name*="easy"][value="true"]').prop("checked",!0),t.addClass("warning"))),this.toggleResolution(t,n,s)},toggleResolution:function(t,e,i){const o=t.find(".osh-observations-form-resolution"),s=o.find(".form-control, .btn"),n=o.find('input[name$="resolution._id"]'),a=o.find('input[name$="resolution.rid"]'),l=o.find('input[name$="resolution.type"]'),r=s[0].name.startsWith("behavior"),d=r?e&&!i:e,c=d?r?"nearMiss":i?"kaizen":"nearMiss":"unspecified",h=l.val();let p={_id:+n.val(),rid:a.val(),type:c};if(c!==h){const e=t.find('input[name$="_id"]').first().val(),i=(this.addedResolutions[e]||{})[c];if(i)p=i.getRelation();else{const t=r?"behaviors":"workConditions",i=d?(this.model.get(t)||[]).find(t=>t._id===e):null;i&&i.resolution._id?Object.assign(p,i.resolution):p={_id:0,rid:"",type:c}}}r||this.scheduleRequiredWorkConditionToggle(),s.prop("disabled",!d),l.val(p.type),n.val(p._id),a.val(p.rid).prop("required","nearMiss"===c).prop("placeholder",this.t(`FORM:resolution:placeholder:${p.type}`))},scheduleRequiredWorkConditionToggle:function(){clearTimeout(this.timers.toggleRequiredWorkCondition),this.timers.toggleRequiredWorkCondition=setTimeout(this.toggleRequiredWorkCondition.bind(this),1)},toggleRequiredWorkCondition:function(){if(this.options.editMode&&!this.model.isCreator())return;const t=this.$id("workConditions").find('input[name$=".rid"]:not([disabled])').filter((t,e)=>"kaizen"===e.previousElementSibling.value);if(0===t.length)return;const e=0===t.filter((t,e)=>""!==e.value).length;t.each((t,i)=>{i.required=0===t&&e})},toggleEasyConfirmed:function(t){const e=this.$id("behaviors").find('input[name*="easy"][value="true"]:checked'),i=this.$('input[name="easyConfirmed"]');t&&i.prop("checked",!1),i.prop("required",e.length>0).closest("div").toggleClass("hidden",0===e.length)},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var t=l.prototype.request.apply(this,arguments);return t.always(function(){s.msg.saved()}),t},submitRequest:function(t,e){const i=this,o=new FormData;let n=0;if(i.$('input[type="file"]').each(function(){const t=this.name.replace("attachments.","");for(let e=0;e<this.files.length;++e)o.append(t,this.files[e]),n+=1}),0===n)return l.prototype.submitRequest.call(i,t,e);s.msg.saving();const a=i.ajax({type:"POST",url:"/osh/attachments",data:o,processData:!1,contentType:!1});a.done(o=>{e.attachments={added:o},l.prototype.submitRequest.call(i,t,e),s.msg.saved()}),a.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),t.attr("disabled",!1)})},showAddResolutionDialog:function(t){const e=this.$('input[name$="resolution.rid"][required]');e.each((t,e)=>{e.required=!1});const i=this.el.checkValidity();if(i||this.$id("save").click(),e.each((t,e)=>{e.required=!0}),!i)return;const o=this.getResolutionInfo(t),n=Object.assign(this.model.toJSON(),this.getFormData()),l=t.find('input[name$="_id"]').first().val(),p=n[t.closest("tbody")[0].dataset.observationsProp].find(t=>t._id===l);if(!p)return;const u=a.getLabel("observationCategory",p.category,{long:!0}),m=o.relation.type;let g=null;if("kaizen"===m)g=new h({relation:this.model,model:new c({subject:u,division:n.division,workplace:n.workplace,department:n.department,building:n.building,location:n.location,station:n.station,problem:p.what,reason:p.why})});else{if("nearMiss"!==m)return;g=new d({relation:this.model,model:new r({subject:u,division:n.division,workplace:n.workplace,department:n.department,building:n.building,location:n.location,station:n.station,problem:p.what,reason:p.why,eventDate:n.date})})}s.showDialog(g,this.t(`FORM:resolution:title:${m}`)),g.handleSuccess=(()=>{const t=g.model.get("rid");this.loadedResolutions[t]=g.model,this.addedResolutions[l]||(this.addedResolutions[l]={}),this.addedResolutions[l][m]=g.model,o.$id.val(g.model.id),o.$rid.val(t),s.closeDialog()})},showResolutionPopover:function(t){const e=this.getResolutionInfo(t);if(!e.relation.rid)return void e.$rid.focus();if(!e.$rid[0].checkValidity())return void e.$rid[0].reportValidity();if(!e.model)return this.loadResolution(t,!0);const i=t.find('.btn[data-action="showResolution"]');i.data("bs.popover")||(i.popover({container:i.closest("td"),trigger:"click",placement:"top",html:!0,title:function(){return""},content:this.renderPartialHtml(g,{relation:e.relation,data:e.model.toJSON(),url:e.model.genClientUrl()})}),i.popover("show"),this.$resolutionPopover=i)},hideResolutionPopover:function(){this.$resolutionPopover&&(this.$resolutionPopover.popover("destroy"),this.$resolutionPopover=null)},resetResolution:function(t){const e=this.getResolutionInfo(t);"0"!==e.$id.val()&&this.checkDuplicateRid(),e.$id.val("0"),e.$rid[0].setCustomValidity(""),this.hideResolutionPopover(),"kaizen"===e.relation.type&&this.scheduleRequiredWorkConditionToggle()},loadResolution:function(e,i){const o=this.getResolutionInfo(e),n=this.prepareRid(o.$rid.val(),o.relation.type);if(this.resetResolution(e),o.$rid.val(n),!n)return;const l=this.checkDuplicateRid(n);if(l.length>1)return void t.last(l).reportValidity();if(this.isDuplicateRid(o.$rid[0]))return o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:duplicate")),void o.$rid[0].reportValidity();if(this.loadedResolutions[n])return o.$id.val(this.loadedResolutions[n].id),void("kaizen"===o.relation.type&&this.toggleRequiredWorkCondition());s.msg.loading(),o.$rid.prop("disabled",!0),o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:loading")),o.$buttons.prop("disabled",!0),o.$actions.prop("disabled",!0);const r=this.resolutionReq=this.ajax({url:`/osh/${a.TYPE_TO_MODULE[o.relation.type]}?rid=${n}&exclude(changes)&limit(1)`});r.fail(()=>{s.msg.loadingFailed(),o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:failure"))}),r.done(t=>{if(s.msg.loaded(),!t.collection||!t.collection.length)return void o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:notFound"));const l=t.collection[0];if("finished"===l.status&&!p.can.assignFinished(this.model))return void o.$rid[0].setCustomValidity(this.t("FORM:resolution:error:finished"));const r=new(0,a.TYPE_TO_MODEL[o.relation.type])(l);this.loadedResolutions[n]=r,o.$id.val(r.id),o.$rid[0].setCustomValidity(""),i&&this.showResolutionPopover(e)}),r.always(()=>{r===this.resolutionReq&&(o.$actions.prop("disabled",!1),this.resolutionReq=null),o.$rid.prop("disabled",!1),o.$buttons.prop("disabled",!1),o.$rid[0].checkValidity()||o.$rid[0].reportValidity(),"kaizen"===o.relation.type&&this.toggleRequiredWorkCondition()})},checkDuplicateRid:function(e){const i=new Map;this.$('input[name$="resolution.rid"]').each((t,e)=>{const o=e.value;o.length&&(i.has(o)||i.set(o,[]),i.get(o).push(e))});const o=this.t("FORM:resolution:error:duplicate");return i.forEach(e=>{if(e.forEach(t=>{t.validationMessage===o&&t.setCustomValidity("")}),1===e.length)return;const i=t.last(e);i.checkValidity()&&i.setCustomValidity(o)}),i.get(e)||[]},isDuplicateRid:function(t){let e=!1;return this.$('input[name$="resolution.rid"]').each((i,o)=>{e||o===t||(e=o.value===t.value)}),e},prepareRid:function(t,e){const i=t.trim().match(/([zkZK]-)?([0-9]{4}-)?([0-9]{1,6})/);return t="",i&&(t+=(i[1]||a.TYPE_TO_PREFIX[e]).charAt(0).toUpperCase(),t+="-"+(i[2]||o.format(Date.now(),"YYYY")).substring(0,4),t+="-"+i[3].padStart(6,"0")),t},getResolutionInfo:function(t){const e=t.find(".osh-observations-form-resolution"),i=e.find('input[name$="_id"]'),o=e.find('input[name$="rid"]'),s=e.find('input[name$="type"]'),n=o.val();return{$observation:t,$resolution:e,$id:i,$rid:o,$type:s,$buttons:e.find(".btn"),$actions:this.$(".form-actions").find(".btn"),model:this.loadedResolutions[n]||null,relation:{_id:+i.val(),rid:n,type:s.val()}}},onDocumentClick:function(t){if(!this.$resolutionPopover)return;const e=this.$(t.target).closest(".osh-observations-form-resolution");e.length&&e[0]===this.$resolutionPopover.closest(".osh-observations-form-resolution")[0]||this.hideResolutionPopover()},onDocumentKeyDown:function(t){if("Escape"===t.key&&this.$resolutionPopover)return this.hideResolutionPopover(),!1}})});