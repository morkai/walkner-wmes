define(["underscore","jquery","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/uuid","app/wmes-osh-common/dictionaries","../Observation","app/wmes-osh-observations/templates/form/form","app/wmes-osh-observations/templates/form/observationRow"],function(e,t,i,o,a,s,n,l,d,c,r){"use strict";return s.extend({template:c,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDivision").val(""),this.setUpUserDivisionSelect2()},"change #-workplace":function(){this.$id("division").val(""),this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-division":function(){this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-building":function(){this.$id("location").val(""),this.$id("station").val(""),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()},"change #-company":function(){this.$id("companyName").val(""),this.toggleCompanyName()},'change input[name="observationKind"]':function(){this.setUpCategories()},'change input[type="file"][data-max]':function(e){const t=e.currentTarget,i=+t.dataset.max;t.setCustomValidity(t.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click .osh-observations-form-radio":function(e){const t=this.$(e.currentTarget).find("input");t.prop("checked",!t.prop("checked")).trigger("change")},'change input[type="radio"]':function(e){this.toggleCategory(this.$(e.target).closest("tr")),this.toggleEasyConfirmed(!0)},'click .btn[data-action="duplicate"]':function(e){const t=this.$(e.currentTarget).closest("tr"),i=+t.find('input[name*="category"]').val(),o=this.renderPartial(r,{i:this.observationI++,duplicate:!0,property:e.currentTarget.dataset.property,observation:{_id:n(),category:i,text:l.getLabel("observationCategory",i,{long:!0}),description:l.getDescription("observationCategory",i),safe:null,easy:null,what:"",why:""}});o.insertAfter(t),this.toggleCategory(o)},'click .btn[data-action="remove"]':function(e){const t=this.$(e.target).closest("tr"),i=!!t.find('input[name*="easy"][value="true"]:checked').length;t.remove(),this.toggleEasyConfirmed(i)}},s.prototype.events),initialize:function(){s.prototype.initialize.apply(this,arguments),this.observationI=0},getTemplateData:function(){return{today:o.getMoment().format("YYYY-MM-DD"),kinds:this.serializeKinds()}},serializeKinds:function(){const e={};l.observationKinds.forEach(t=>{t.get("active")&&(e[t.id]={value:t.id,label:t.getLabel({long:!0}),title:t.get("description")})});const t=l.kinds.get(this.model.get("kind"));return t&&!e[t]&&(e[t.id]={value:t.id,label:t.getLabel({long:!0}),title:t.get("description")}),Object.values(e).sort((e,t)=>e.label.localeCompare(t.label))},serializeToForm:function(){const e=this.model.toJSON();if(this.options.editMode){const t=o.utc.getMoment(e.date);e.date=t.format("YYYY-MM-DD"),e.time=t.format("H"),e.easyConfirmed=(e.behaviors||[]).some(e=>!0===e.easy)}else{const t=o.getMoment();e.date=t.format("YYYY-MM-DD"),e.time=t.format("H"),e.easyConfirmed=!1}return delete e.coordinators,delete e.attachments,delete e.users,delete e.changes,e},serializeForm:function(e){const t=this.$id("company").select2("data");e.company=t.id,0!==t.id&&(e.companyName=t.text),e.userWorkplace=this.$id("userWorkplace").select2("data").id,e.userDivision=this.$id("userDivision").select2("data").id,e.workplace=this.$id("workplace").select2("data").id,e.division=this.$id("division").select2("data").id,e.building=this.$id("building").select2("data").id,e.location=this.$id("location").select2("data").id,e.station=parseInt(this.$id("station").val(),10)||null,e.date=o.utc.getMoment(`${e.date} ${(e.time||"00").padStart(2,"0")}:00:00`,"YYYY-MM-DD HH:mm:ss").toISOString(),e.observationKind&&(e.observationKind=+e.observationKind);const i=this.$id("behaviors").children();return e.behaviors=(e.behaviors||[]).filter((e,t)=>{return!!i[t].querySelector('input[name*="safe"]:checked')&&(e.category=+e.category,e.safe=!0===e.safe,e.easy=e.safe?null:e.easy,e.what=(e.what||"").trim(),e.why=(e.why||"").trim(),e.resolution={_id:0,rid:"",type:"unspecified"},e.implementer=null,!0)}),e.workConditions=(e.workConditions||[]).filter(e=>"boolean"==typeof e.safe&&(e.category=+e.category,e.safe=!1,e.easy=!0===e.easy,e.what=(e.what||"").trim(),e.why=(e.why||"").trim(),e.resolution={_id:0,rid:"",type:"unspecified"},e.implementer=null,!0)),e},checkValidity:function(e){return console.log(e),!0},afterRender:function(){s.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpCompanySelect2(),this.options.editMode?this.setUpCategories():this.toggleKind()},setUpUserWorkplaceSelect2:function(){const e=this.$id("userWorkplace");if(this.options.editMode){const t=l.workplaces.get(this.model.get("userWorkplace"));return e.val(t?t.id:"").select2({width:"100%",placeholder:" ",data:t?[{id:t.id,text:t.getLabel({long:!0}),model:t}]:[]}),void e.select2("enable",!1)}e.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let t=l.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o={};l.workplaces.forEach(e=>{e.get("active")&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!o[t.id]&&(o[t.id]=t),e.select2({width:"100%",data:Object.values(o).sort((e,t)=>e.text.localeCompare(t.text))});const a=l.workplaces.get(i.data.oshWorkplace);this.options.editMode&&t?e.select2("enable",!1).select2("data",t):a?e.select2("enable",!1).select2("data",{id:a.id,text:a.getLabel({long:!0}),model:a}):e.select2("enable",!0)},setUpUserDivisionSelect2:function(){const e=this.$id("userDivision");if(this.options.editMode){const t=l.divisions.get(this.model.get("userDivision"));return e.val(t?t.id:"").select2({width:"100%",placeholder:" ",data:t?[{id:t.id,text:t.getLabel({long:!0}),model:t}]:[]}),void e.select2("enable",!1)}const t=+this.$id("userWorkplace").val();let o=l.divisions.get(+e.val());o&&(o={id:o.id,text:o.getLabel({long:!0}),model:o});const a={};l.divisions.forEach(e=>{e.get("active")&&e.get("workplace")===t&&(a[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),o&&!a[o.id]&&o.model.get("workplace")===t&&(a[o.id]=o);const s=Object.values(a).sort((e,t)=>e.text.localeCompare(t.text));let n=" ",d=!0;t||0!==s.length||(n=this.t("FORM:placeholder:noUserWorkplace"),d=!1),e.select2({width:"100%",placeholder:n,data:s});const c=l.divisions.get(i.data.oshDivision);this.options.editMode&&o?e.select2("enable",!1).select2("data",o):c?e.select2("enable",!1).select2("data",{id:c.id,text:c.getLabel({long:!0}),model:c}):(e.select2("enable",d),1===s.length?e.select2("data",s[0]):a[e.val()]||e.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");let t=l.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const i={};l.workplaces.forEach(e=>{e.get("active")&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!i[t.id]&&(i[t.id]=t),e.select2({width:"100%",data:Object.values(i).sort((e,t)=>e.text.localeCompare(t.text))}),e.select2("enable",!this.options.editMode||d.can.manage()||this.model.isCoordinator())},setUpDivisionSelect2:function(){const e=this.$id("division"),t=+this.$id("workplace").val();let i=l.divisions.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const o={};l.divisions.forEach(e=>{e.get("active")&&e.hasWorkplace(t)&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!o[i.id]&&(o[i.id]=i);const a=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noWorkplace"),data:a}),1===a.length?e.select2("data",a[0]):o[e.val()]||e.val("").select2("data",null),e.select2("enable",!!t&&(!this.options.editMode||d.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(){const e=this.$id("building"),t=+this.$id("division").val(),i={};l.buildings.forEach(e=>{e.get("active")&&e.hasDivision(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noDivision"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t&&(!this.options.editMode||d.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const e=this.$id("location"),t=+this.$id("building").val(),i={};l.locations.forEach(e=>{e.get("active")&&e.hasBuilding(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noBuilding"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t&&(!this.options.editMode||d.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const e=this.$id("station"),t=+this.$id("location").val(),i={};l.stations.forEach(e=>{e.get("active")&&e.hasLocation(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noLocation"),allowClear:!0,data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",o.length>0&&!!t&&(!this.options.editMode||d.can.manage()||this.model.isCoordinator()))},setUpCompanySelect2:function(){const e=this.$id("company"),t={};l.companies.forEach(e=>{e.get("active")&&(t[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const i=Object.values(t).sort((e,t)=>e.text.localeCompare(t.text));i.push({id:0,text:this.t("FORM:company:other")}),e.select2({width:"100%",placeholder:" ",data:i}),this.toggleCompanyName()},toggleCompanyName:function(){const e="0"===this.$id("company").val();this.$id("companyName").prop("disabled",!e).prop("required",e).closest(".form-group").find(".control-label").toggleClass("is-required",e)},setUpCategories:function(){const e=l.observationKinds.get(this.options.editMode?this.model.get("observationKind"):+this.$('input[name="observationKind"]:checked').val());this.setUpObservations("behaviors",e),this.setUpObservations("workConditions",e),this.toggleEasyConfirmed(!1)},setUpObservations:function(e,i){const o=new Map;i&&i.get(e).forEach(e=>{const t=l.observationCategories.get(e);t&&t.get("active")&&o.set(e,t)});const a=[];(this.model.get(e)||[]).forEach(e=>{o.delete(e.category),a.push({_id:e._id,category:e.category,text:e.text,description:l.getDescription("observationCategory",e.category),safe:e.safe,easy:e.easy,what:e.what,why:e.why})}),o.forEach(e=>{a.push({_id:n(),category:e.id,text:e.get("longName"),description:e.get("description"),safe:null,easy:null,what:"",why:""})}),this.$id(e).html(a.map(t=>this.renderPartialHtml(r,{i:this.observationI++,duplicate:!1,property:e,observation:t}))),this.$id(e).children().each((e,i)=>{this.toggleCategory(t(i))})},toggleKind:function(){const e=this.$('input[name="observationKind"]');e.length&&!e.filter(":checked").length&&e.first().click()},toggleCategory:function(e){e.removeClass("success warning danger");const t=e.find('textarea[name*="what"]'),i=e.find('textarea[name*="why"]'),o=e.find('input[name*="safe"]:checked').val(),a=e.find('input[name*="easy"]:checked').val(),s="false"===o;t.prop("disabled",!s),i.prop("disabled",!s),s||(e.find('input[name*="easy"]').prop("checked",!1).prop("disabled",!0).closest("td").addClass("disabled"),e.find("textarea").prop("required",!1)),"true"===o?e.addClass("success"):s&&(e.find('input[name*="easy"]').prop("disabled",!1).closest("td").removeClass("disabled"),e.find("textarea").prop("required",!0),"true"===a?e.addClass("warning"):"false"===a?e.addClass("danger"):(e.find('input[name*="easy"][value="true"]').prop("checked",!0),e.addClass("warning")))},toggleEasyConfirmed:function(e){const t=this.$id("behaviors").find('input[name*="easy"][value="true"]:checked'),i=this.$('input[name="easyConfirmed"]');e&&i.prop("checked",!1),i.prop("required",t.length>0).closest("div").toggleClass("hidden",0===t.length)},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){a.msg.saving();var e=s.prototype.request.apply(this,arguments);return e.always(function(){a.msg.saved()}),e},submitRequest:function(e,t){const i=this,o=new FormData;let n=0;if(i.$('input[type="file"]').each(function(){const e=this.name.replace("attachments.","");for(let t=0;t<this.files.length;++t)o.append(e,this.files[t]),n+=1}),0===n)return s.prototype.submitRequest.call(i,e,t);a.msg.saving();const l=i.ajax({type:"POST",url:"/osh/attachments",data:o,processData:!1,contentType:!1});l.done(o=>{t.attachments={added:o},s.prototype.submitRequest.call(i,e,t),a.msg.saved()}),l.fail(()=>{a.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),e.attr("disabled",!1)})}})});