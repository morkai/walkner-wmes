// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/user","app/core/views/ListView"],function(e,t,n,i,r){return r.extend({remoteTopics:{"xiconf.orders.**":"refreshCollection"},events:{"click tr[data-id]":function(e){if(""===window.getSelection().toString()&&"A"!==e.target.tagName){var t=this.collection.get(e.currentTarget.dataset.id).genClientUrl();e.ctrlKey?window.open(t):e.altKey||this.broker.publish("router.navigate",{url:t,trigger:!0,replace:!1})}}},columns:[{id:"orderNo",label:t("xiconf","PROPERTY:no")},{id:"nc12",label:t("xiconf","PROPERTY:nc12")},{id:"name",label:t("xiconf","PROPERTY:programName")},{id:"quantity",label:t("xiconf","PROPERTY:quantity")},"reqDate","createdAt","duration"],serializeActions:function(){return null},serializeRows:function(){function t(e){return r&&e.get("quantityParent")?'<a href="#orders/'+e.id+'">'+e.id+"</a>":e.id}var r=i.isAllowedTo("ORDERS:VIEW");return this.collection.map(function(i){var r=[],a=[];e.forEach(i.get("nc12"),function(e){r.push(e._id),a.push(e.name)});var o=Date.parse(i.get("createdAt"))||0,l=Date.parse(i.get("finishedAt"))||Date.now(),c=o?(l-o)/1e3:0;return{_id:i.id,className:"xiconfProgramOrders-list-item "+i.getStatusClassName(),orderNo:t(i),nc12:r.length?r.join("; "):null,name:a.length?a.join("; "):null,quantity:i.get("quantityDone").toLocaleString()+"/"+i.get("quantityTodo").toLocaleString(),reqDate:n.format(i.get("reqDate"),"YYYY-MM-DD"),createdAt:o?n.format(o,"YYYY-MM-DD"):null,duration:c?n.toString(c):null}})}})});