define(["underscore","app/time","app/user","app/viewport","app/core/views/ListView","app/wmes-ct-balancing/templates/orderPopover","app/wmes-ct-balancing/templates/commentEditor"],function(t,i,e,o,n,r,s){"use strict";return n.extend({className:function(){return"ct-balancing-list "+(e.isAllowedTo("PROD_DATA:MANAGE")?"is-editable":"")},remoteTopics:{"ct.balancing.pces.updated":function(t){var i=this;t.added?this.commenting?this.needsRefresh=!0:this.refreshCollection():t.updated&&t.updated.forEach(t=>{var e=i.collection.get(t._id);e&&e.set(t)})}},events:Object.assign({'click td[data-id="comment"]':function(t){e.isAllowedTo("PROD_DATA:MANAGE")&&this.showCommentEditor(this.$(t.currentTarget).closest(".list-item")[0].dataset.id)}},n.prototype.events),serializeColumns:function(){return[{id:"startedAt",className:"is-min"},{id:"d",className:"is-min text-right"},{id:"stt",className:"is-min text-right"},{id:"order",className:"is-min"},{id:"line",className:"is-min"},{id:"station",className:"is-min is-number",label:this.t("PROPERTY:station:short")},{id:"comment"}]},serializeActions:function(){return null},initialize:function(){n.prototype.initialize.apply(this,arguments),this.commenting=!1,this.needsRefresh=!1,this.listenTo(this.collection,"sync",function(){this.needsRefresh=!1,this.hideEditor(!1)}),this.once("afterRender",function(){this.listenTo(this.collection,"change:comment",this.onCommentChange)}),$(window).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this)).on("resize."+this.idPrefix,this.onWindowResize.bind(this))},destroy:function(){n.prototype.destroy.apply(this,arguments),$(window).off("."+this.idPrefix)},afterRender:function(){var e=this;n.prototype.afterRender.apply(e,arguments),e.$el.popover({container:e.el,selector:"td[data-id]",trigger:"hover",placement:"right",html:!0,css:{maxWidth:"350px"},hasContent:function(){return"order"===this.dataset.id},content:function(){var o=e.collection.get(this.parentNode.dataset.id);if("order"===this.dataset.id){var n=o.get("order");return e.renderPartialHtml(r,{order:{_id:n._id,nc12:n.nc12,name:t.escape(n.name),mrp:n.mrp,qty:n.qty,workerCount:n.workerCount,sapTaktTime:i.toString(n.sapTaktTime,!1,!1)}})}}})},onCommentChange:function(t){this.$cell(t.id,"comment").text(t.get("comment"))},showCommentEditor:function(t){var i=this,e=i.collection.get(t);e?(i.$editor&&(i.$editor.data("id")!==t||i.$editor.data("prop","comment"))&&this.hideEditor(),i.$editor=i.renderPartial(s,{comment:e.get("comment")}),i.$editor.data("id",t).data("prop","comment"),i.$editor.find(".form-control").on("keyup",function(t){t.ctrlKey&&"Enter"===t.key&&i.$editor.find(".btn-primary").click()}),i.$editor.on("submit",function(){var t=i.$editor.find(".form-control").val();if(t.replace(/[^A-Z0-9]+/gi,"")===e.get("comment").replace(/[^A-Z0-9]+/gi,""))return i.hideEditor(!0),!1;o.msg.saving();var n=e.save({comment:t},{wait:!0});return n.fail(function(){o.msg.savingFailed()}),n.done(function(){o.msg.saved(),i.hideEditor(!0)}),!1}),i.positionEditor(),i.$editor.appendTo("body").find(".form-control").focus()):i.hideEditor(!1)},positionEditor:function(){if(this.$editor){var t=this.$cell(this.$editor.data("id"),this.$editor.data("prop")),i=t.position();this.$editor.css({top:i.top+5+"px",left:i.left+5+"px",width:t.outerWidth()-10+"px"})}},hideEditor:function(t){this.$editor&&(this.$editor.remove(),this.$editor=null),!1!==t&&this.needsRefresh&&this.refreshCollectionNow()},onWindowKeyDown:function(t){"Escape"===t.key&&this.hideEditor(!0)},onWindowResize:function(){this.positionEditor()}})});