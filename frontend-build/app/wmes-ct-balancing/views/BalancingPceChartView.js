define(["underscore","app/i18n","app/highcharts","app/core/View"],function(t,e,i,a){"use strict";return a.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:report",this.createOrUpdate)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this.serializeSeries();this.chart=new i.Chart({chart:{renderTo:this.el,plotBorderWidth:1,spacing:[15,1,15,1],type:"column"},exporting:{filename:this.t("pceReport:chart:filename"),chartOptions:{title:{text:this.t("pceReport:chart:title")}}},title:!1,noData:{},xAxis:{categories:this.serializeCategories()},yAxis:[{title:!1,min:0,allowDecimals:!1,opposite:!1}],tooltip:{shared:!0,valueDecimals:1},legend:{enabled:!0},plotOptions:{column:{dataLabels:{enabled:!1},borderWidth:3}},series:t})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeCategories:function(){var t=this,e=t.model.get("report");if(!e||!e.stations||e.stations.length<2)return[];var i=e.stations.map(function(e){return t.t("pceReport:station",{no:e.no})});return 2===i.length&&i.pop(),i},serializeSeries:function(){var e=this,i=e.model.get("report");if(!i||!i.stations||i.stations.length<2)return[];var a={};return["min","max","avg","med"].forEach(function(t){a[t]={id:t,type:"column",name:e.t("pceReport:metric:"+t),data:[],tooltip:{valueSuffix:"s"}}}),a.stt={id:"stt",type:2===i.stations.length?"column":"line",name:e.t("pceReport:metric:stt"),data:[],tooltip:{valueSuffix:"s"}},i.stations.forEach(function(t){0===t.no&&2===i.stations.length||(a.min.data.push(s(t.min,t.stt)),a.max.data.push(s(t.max,t.stt)),a.avg.data.push(s(t.avg,t.stt)),a.med.data.push(s(t.med,t.stt)),a.stt.data.push({y:t.stt,borderColor:"#00AF00"}))}),t.values(a);function s(t,e){return{borderColor:t>e?"#e00":"#00af00",y:t}}},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});