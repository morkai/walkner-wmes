define(["app/core/View","app/core/util/decimalSeparator","app/wmes-ct-balancing/BalancingPce","app/wmes-ct-balancing/templates/recorder","css!app/wmes-ct-balancing/assets/recorder"],function(e,t,s,i){"use strict";return e.extend({template:i,events:{"dblclick .ct-balancing-recorder-duration":function(){this.hide()},"click #-start":function(){this.model.set({startedAt:new Date,finishedAt:null})},"click #-stop":function(){this.model.set({finishedAt:new Date})}},initialize:function(){this.newOrder=null,this.model=new s,this.listenTo(this.model,"change:startedAt",this.onStart),this.listenTo(this.model,"change:finishedAt",this.onStop)},updateOrder:function(e){this.$el.hasClass("is-started")?this.newOrder=e:this.model.set("order",e)},toggle:function(e){this.$el.hasClass("hidden")?this.show(e):this.hide()},show:function(e){this.newOrder=null,this.model.set({order:e,line:window.WMES_LINE_ID,station:window.WMES_STATION}),this.updateValue(),this.$el.removeClass("hidden")},hide:function(){this.model.set({startedAt:null,finishedAt:null}),this.$el.addClass("hidden"),this.stop(),this.updateValue()},onStart:function(){this.model.get("startedAt")&&!this.model.get("finishedAt")&&(this.newOrder&&(this.model.set("order",this.newOrder),this.newOrder=null),this.start())},onStop:function(){this.model.get("startedAt")&&this.model.get("finishedAt")&&(this.stop(),this.updateValue(),this.recordValue())},start:function(){this.timers.updateValue=setInterval(this.updateValue.bind(this),40),this.updateValue(),this.$el.addClass("is-started")},stop:function(){this.$el.removeClass("is-started"),clearInterval(this.timers.updateValue),this.timers.updateValue=null},updateValue:function(){var e=this.model.get("startedAt"),s=0;e&&(s=(Date.now()-e.getTime())/1e3),this.$id("value").text(s.toFixed(1).replace(".",t))},recordValue:function(){var e=this;e.$id("record").removeClass("btn-danger btn-success btn-warning").addClass("btn-info").find(".fa").removeClass("fa-thumbs-up fa-thumbs-down").addClass("fa-spinner fa-spin"),e.$el.addClass("is-recording");var t=new s(e.model.toJSON()).save();t.fail(function(){e.$id("record").removeClass("btn-info").addClass("btn-danger").find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-thumbs-down"),e.timers.restoreActions=setTimeout(e.restoreActions.bind(e),2e3)}),t.done(function(){e.$id("record").removeClass("btn-info").addClass("btn-success").find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-thumbs-up"),e.timers.restoreActions=setTimeout(e.restoreActions.bind(e),1e3)})},restoreActions:function(){this.$el.removeClass("is-recording")}})});