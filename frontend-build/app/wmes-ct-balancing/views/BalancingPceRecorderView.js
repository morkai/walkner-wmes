define(["app/core/Model","app/core/View","app/core/util/decimalSeparator","app/wmes-ct-balancing/BalancingPce","app/wmes-ct-balancing/templates/recorder","css!app/wmes-ct-balancing/assets/recorder","i18n!app/nls/wmes-ct-balancing"],function(e,t,i,s,n){"use strict";return t.extend({template:n,events:{"click .ct-balancing-recorder-hd":function(){this.hide()},"click .ct-balancing-recorder-duration":function(){this.model.get("lastPce")&&!this.model.get("recording")&&this.model.set("commenting",!0)},"click #-start":function(){this.start()},"click #-stop":function(){this.stop()},"click #-comment":function(){this.comment()}},initialize:function(){this.model=new e,this.model.nlsDomain="wmes-ct-balancing",this.reset(),this.listenTo(this.model,"change:active",this.onActiveChange),this.listenTo(this.model,"change:state",this.onStateChange),this.listenTo(this.model,"change:recording",this.onRecordingChange),this.listenTo(this.model,"change:commenting",this.onCommentingChange)},reset:function(e){this.model.set(Object.assign({state:"idle",active:!1,recording:null,commenting:!1,lastPce:null,newOrder:null,order:null,startedAt:null,finishedAt:null},e))},updateOrder:function(e){"started"===this.model.get("state")?this.model.set("newOrder",e):this.model.set("order",e)},toggle:function(e){this.model.get("active")?this.hide():this.show(e)},show:function(e){this.reset({active:!0,order:e}),this.center(),this.updateValue()},hide:function(){clearInterval(this.timers.updateValue),this.timers.updateValue=null,this.reset()},start:function(){var e=this.model.get("newOrder");e&&this.model.set({newOrder:null,order:e}),this.model.set({state:"started",startedAt:new Date}),this.timers.updateValue=setInterval(this.updateValue.bind(this),40),this.updateValue()},stop:function(){this.model.set({state:"finished",finishedAt:new Date}),clearInterval(this.timers.updateValue),this.timers.updateValue=null,this.updateValue(),this.recordValue()},comment:function(){var e=this,t=e.model.get("lastPce"),i=e.$id("text"),s=t.get("comment")||"",n=i.val().trim();if(0===n.replace(/[^A-Za-z0-9]+/,"").length&&(n=""),n!==s){e.model.set("recording","started"),i.prop("disabled",!0);var a=t.save({comment:n},{wait:!0});a.fail(function(){e.model.set("recording","failure"),e.timers.recorded=setTimeout(function(){e.model.set("recording",null),i.prop("disabled",!1).focus()},2e3)}),a.done(function(){e.model.set("recording","success"),e.timers.recorded=setTimeout(function(){i.prop("disabled",!1),e.model.set({recording:null,commenting:!1})},2e3)})}else e.model.set({recording:null,commenting:!1})},updateValue:function(){var e=this.model.get("startedAt"),t=0;e&&(t=(Date.now()-e.getTime())/1e3);var s=t.toFixed(1).split("."),n=s[0]+'<span class="ct-balancing-recorder-duration-separator">'+i+"</span>"+s[1];this.$id("value").html(n)},recordValue:function(){var e=this;e.model.set("recording","started");var t=new s({order:e.model.get("order"),line:window.WMES_LINE_ID,station:window.WMES_STATION,startedAt:e.model.get("startedAt"),finishedAt:e.model.get("finishedAt")}),i=t.save();i.fail(function(){e.model.set("recording","failure"),e.timers.recorded=setTimeout(e.model.set.bind(e.model,"recording",null),2e3)}),i.done(function(){e.model.set({recording:"success",lastPce:t}),e.timers.recorded=setTimeout(e.model.set.bind(e.model,"recording",null),2e3)})},center:function(){var e=this.el.getBoundingClientRect();this.el.style.marginLeft=-1*Math.round(e.width/2)+"px",this.el.style.marginTop=-1*Math.round(e.height/2)+"px"},onActiveChange:function(){this.$el.toggleClass("hidden",!this.model.get("active"))},onStateChange:function(){var e=this.model.get("state");this.$el[0].dataset.state=e,this.$id("title").html(this.t("balancing:title:"+e))},onRecordingChange:function(){var e=this.$id("record").removeClass("btn-danger btn-success btn-info"),t=e.find(".fa").removeClass("fa-thumbs-up fa-thumbs-down fa-spinner fa-spin");switch(this.model.get("recording")){case"started":e.addClass("btn-info"),t.addClass("fa-spinner fa-spin"),this.$el.addClass("is-recording");break;case"failure":e.addClass("btn-danger"),t.addClass("fa-thumbs-down");break;case"success":e.addClass("btn-success"),t.addClass("fa-thumbs-up");break;default:this.$el.removeClass("is-recording")}},onCommentingChange:function(){var e=this.model.get("commenting");this.$el.toggleClass("is-commenting",e),e&&this.$id("text").val(this.model.get("lastPce").get("comment")||"").select()}})});