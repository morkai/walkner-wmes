// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/user","app/time","app/viewport","app/core/views/FormView","app/pscs/templates/exam"],function(t,e,i,s,n,a,r){"use strict";var o=[2,1,4,1,3,4,2,3];return a.extend({template:r,events:t.extend({"input #-personnelId":function(t){t.target.setCustomValidity("")},"keydown #-personnelId":function(t){return 13===t.keyCode?(this.start(),!1):void 0},"click #-start":"start",'click [data-action="cancel"]':function(){this.model.clear(),this.enterSection("start")},'click [data-action="next"]':function(){var t=this.$id("section-"+this.section),i=t.find("input:checked");i.length?this.enterSection(parseInt(this.section,10)+1):(t.find('input[type="radio"]')[0].setCustomValidity(e("pscs","exam:required")),this.$id("submit").click())},'click [data-action="prev"]':function(){this.enterSection(parseInt(this.section,10)-1)},'click [data-action="finish"]':"finish",'change input[name^="answers"]':function(t){Array.isArray(this.model.attributes.answers)||(this.model.attributes.answers=o.map(function(){return-1})),this.model.attributes.answers[t.target.dataset.question]=parseInt(t.target.value,10)}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),this.section="start"},afterRender:function(){a.prototype.afterRender.apply(this,arguments),this.enterSection(this.section)},enterSection:function(t){this.$id("section-"+this.section).addClass("hidden"),this.$id("section-"+t).removeClass("hidden").find("input").first().focus(),this.$('input[type="radio"]').each(function(){this.setCustomValidity("")}),this.section=t},serializeForm:function(t){for(var e=new Array(8),i=new Array(8),s=0;8>s;++s)e[s]=parseInt(t.answers[s],10)||-1,i[s]=e[s]===o[s];return{answers:e,validity:i}},handleSuccess:function(){if("failed"===this.model.get("status")){var t=this.model.get("validity").reduce(function(t,e){return t+(e?1:0)},0);this.$id("validAnswers").text(e("pscs","exam:failure:valid",{count:t,gender:this.model.get("user").gender})),this.enterSection("failure")}else this.enterSection("success")},handleFailure:function(){this.showErrorMessage(e("pscs","exam:failure"))},start:function(){var t=this,i=t.$id("personnelId"),s=i.val().replace(/[^0-9]/g,"");if(i.val(s),!s.length)return i[0].setCustomValidity(e("pscs","exam:start:required")),void t.$id("submit").click();t.$id("start").prop("disabled",!0),t.model.set({personnelId:s,answers:[-1,-1,-1,-1,-1,-1,-1,-1]},{silent:!0});var n=this.promised(t.model.save());n.done(function(){t.enterSection("1")}),n.fail(function(i){if(400===i.status){var s=i.responseJSON.error;return void(e.has("pscs","exam:start:"+s.message)&&(t.$id("personnelId")[0].setCustomValidity(e("pscs","exam:start:"+s.message)),t.$id("submit").click()))}t.showErrorMessage(e("pscs","exam:start:failure"))}),n.always(function(){t.$id("start").prop("disabled",!1)})},finish:function(){this.$id("submit").click()}})});