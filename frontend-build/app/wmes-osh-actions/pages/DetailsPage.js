define(["underscore","jquery","app/viewport","app/wmes-osh-common/ResolutionCollection","app/wmes-osh-common/pages/DetailsPage","../Action","../views/RootCausesView","../views/SolutionView","../views/ResolutionsView","../views/VerificationFormView","app/wmes-osh-actions/templates/details/page","app/wmes-osh-actions/templates/details/props"],function(t,e,i,s,o,n,a,l,r,c,h,d){"use strict";return o.extend({template:h,propsTemplate:d,actions:function(){const t=o.prototype.actions.apply(this,arguments);return t.unshift(this.createNextStepAction()),t},initialize:function(){o.prototype.initialize.apply(this,arguments),this.once("afterRender",()=>{this.listenTo(this.model,"change:resolutions",this.resolutions.fetch.bind(this.resolutions,{reset:!0}))})},remoteTopics:function(){const t=o.prototype.remoteTopics.apply(this,arguments);return t[`${this.model.getTopicPrefix()}.relations.${this.model.id}`]="onRelationsUpdated",t},defineModels:function(){o.prototype.defineModels.apply(this,arguments),this.resolutions=new s(null,{parent:this.model})},defineViews:function(){o.prototype.defineViews.apply(this,arguments),this.rootCausesView=new a({model:this.model}),this.solutionView=new l({model:this.model}),this.resolutionsView=new r({model:this.model,resolutions:this.resolutions}),this.setView("#-rootCauses",this.rootCausesView),this.setView("#-solution",this.solutionView),this.setView("#-resolutions",this.resolutionsView)},load:function(t){return t(this.model.fetch(),this.resolutions.fetch({reset:!0}))},onRelationsUpdated:function({relation:t,change:e}){const i=this.resolutions.get(t.rid);i&&i.handleUpdate(e)},createNextStepAction:function(){const t=this.model.get("status");return"new"===t&&n.can.inProgress(this.model)?{icon:"check",type:"info",label:this.t("nextStep:inProgress:action"),callback:this.handleInProgressAction.bind(this)}:"inProgress"===t&&n.can.verification(this.model)?{icon:"gavel",type:"secondary",label:this.t("nextStep:verification:action"),callback:this.handleVerificationAction.bind(this)}:"verification"===t&&n.can.finished(this.model)?{icon:"thumbs-up",type:"success",label:this.t("nextStep:finished:action"),callback:this.handleFinishedAction.bind(this)}:null},handleInProgressAction:function(t){const s=e(t.target).closest(".btn").prop("disabled",!0);i.msg.saving();const o=this.ajax({method:"PATCH",url:this.model.url(),data:JSON.stringify({status:"inProgress"})});o.fail(()=>i.msg.savingFailed()),o.done(()=>i.msg.saved()),o.always(()=>s.prop("disabled",!1))},handleVerificationAction:function(){document.activeElement&&document.activeElement.blur();const t=new c({model:new n(JSON.parse(JSON.stringify(this.model.attributes))),resolutions:this.resolutions});i.showDialog(t,this.t("nextStep:verification:title"))},handleFinishedAction:function(t){const s=e(t.target).closest(".btn").prop("disabled",!0);i.msg.saving();const o=this.ajax({method:"PATCH",url:this.model.url(),data:JSON.stringify({status:"finished"})});o.fail(()=>i.msg.savingFailed()),o.done(()=>i.msg.saved()),o.always(()=>s.prop("disabled",!1))}})});