define(["underscore","app/user","app/time","app/viewport","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/Resolution","app/wmes-osh-common/util/userInfoDecorator","app/wmes-osh-common/views/FormView","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../Action","./ParticipantFinderView","app/wmes-osh-actions/templates/form/form","app/wmes-osh-actions/templates/form/resolutionRow"],function(t,e,i,s,o,n,a,l,r,d,c,u,h,p,g,m){"use strict";return d.extend({template:g,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDepartment").val(""),this.setUpUserDepartmentSelect2()},'change input[name="kind[]"]':function(){const t=this.$id("activityKind").val();this.$id("activityKind").val(""),this.setUpActivityKindSelect2(t),this.toggleActivityKind(),this.$('input[name="kind[]"]').first()[0].required=!this.$('input[name="kind[]"]:checked').length},"change #-activityKind":function(){this.toggleActivityKind()},'change textarea[name*="why"]':function(){this.checkWhyValidity()},'change input[type="file"][data-max]':function(t){const e=t.currentTarget,i=+e.dataset.max;e.setCustomValidity(e.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const t=this.$id("comment");if("verification"===this.model.get("status")&&!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-verification":function(){this.newStatus="verification";const t=this.$id("solution");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-finished":function(){this.newStatus="finished";const t=this.$id("solution");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-paused":function(){this.newStatus="paused";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"keydown #-resolutionRid":function(t){t.currentTarget.setCustomValidity(""),"Enter"===t.key&&t.preventDefault()},"keyup #-resolutionRid":function(t){"Enter"===t.key&&this.linkResolution()},"click #-linkResolution":function(){this.linkResolution()},'click .btn[data-action="removeResolution"]':function(t){this.resolutions.remove(this.$(t.target).closest("tr")[0].dataset.id)},"click #-addKaizenResolution":function(){this.showAddResolutionDialog("kaizen")},"click #-addActionResolution":function(){this.showAddResolutionDialog("action")},"click #-showParticipantFinder":function(){this.showParticipantFinderDialog()}},d.prototype.events),initialize:function(){d.prototype.initialize.apply(this,arguments),this.resolutionsI=0,this.newStatus=this.options.newStatus||null,this.once("afterRender",()=>{this.listenTo(this.resolutions,"add",this.addResolution),this.listenTo(this.resolutions,"remove",this.removeResolution)})},getTemplateData:function(){return{today:i.getMoment().format("YYYY-MM-DD"),kinds:a.kinds.serialize("action",this.model.get("kind")),can:{inProgress:h.can.inProgress(this.model),verification:h.can.verification(this.model),finished:h.can.finished(this.model),paused:h.can.paused(this.model),cancelled:h.can.cancelled(this.model)},relation:!!this.relation,rootCauses:this.serializeRootCauses()}},getKinds:function(){const t=this.$('input[name="kind[]"]');return t.length?t.filter(":checked").get().map(t=>+t.value):this.model.get("kind")||[]},serializeRootCauses:function(){const t=this.model.get("rootCauses");return t&&t.length?t.map(t=>{const e=a.rootCauseCategories.get(t.category);return e?{category:e.id,label:e.getLabel({long:!0}),description:!!e.get("description"),why:t.why}:{category:t.category,label:`?${t.category}?`,description:!1,why:t.why}}):a.rootCauseCategories.map(t=>({category:t.id,label:t.getLabel({long:!0}),description:!!t.get("description"),why:["","","","",""]}))},serializeToForm:function(){const t=this.model.toJSON();return t.plannedAt&&(t.plannedAt=i.utc.format(t.plannedAt,"YYYY-MM-DD")),t.rootCauses=this.serializeRootCauses().map(t=>({category:t.category,why:t.why})),delete t.coordinators,delete t.attachments,delete t.users,delete t.changes,t},serializeForm:function(t){const e=this.getActivityFeatures(),s=this.$id("userWorkplace").select2("data");if(t.userDivision=s.model.get("division"),t.userWorkplace=s.id,t.userDepartment=this.$id("userDepartment").select2("data").id,t.activityKind=this.$id("activityKind").select2("data").id,this.relation)t.relation=this.relation.getRelation();else{const e=this.$id("workplace").select2("data");t.division=e.model.get("division"),t.workplace=e.id,t.department=this.$id("department").select2("data").id,t.building=this.$id("building").select2("data").id,t.location=this.$id("location").select2("data").id,t.station=parseInt(this.$id("station").val(),10)||0}return e.rootCauses?(t.rootCauses.forEach(t=>{for(t.category=+t.category,t.why||(t.why=[]);t.why.length<5;)t.why.push("")}),t.reason="",t.suggestion=""):t.rootCauses=null,e.resolutions?(t.status="inProgress",t.resolutions||(t.resolutions=[]),t.resolutions.forEach(t=>{t._id=+t._id}),t.solution=""):t.resolutions=null,e.implementers?(t.status=this.newStatus||this.model.get("status")||"new",t.implementers=n.getUserInfo(this.$id("implementers")),t.plannedAt=i.utc.getMoment(this.$id("plannedAt").val(),"YYYY-MM-DD").toISOString()):(t.implementers=null,t.plannedAt=null),e.participants?t.participants=n.getUserInfo(this.$id("participants")):t.participants=null,t.status||(t.status="finished"),Array.isArray(t.kind)&&(t.kind=t.kind.map(t=>+t)),t},afterRender:function(){d.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.setUpDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpActivityKindSelect2(),this.setUpImplementersSelect2(),this.setUpParticipantsSelect2(),this.setUpRootCauseCategoryPopover(),this.toggleKind(),this.toggleActivityKind(),this.options.editMode&&this.resolutions.forEach(t=>this.addResolution(t,this.resolutions,{}))},setUpActivityKindSelect2:function(t){const e=this.$id("activityKind"),i=this.getKinds(),s={},n=this.options.editMode||h.can.manage()||a.isCoordinator(),l=this.relation?this.relation.getModelType():null,r=a.activityKinds.get(this.options.forcedActivityKind);a.activityKinds.forEach(t=>{if(r){if(r!==t)return}else{if(!t.get("active")||!t.hasKind(i))return;if(this.relation){if("implementers"!==t.get("resolution"))return;if(!n&&t.get("allowedTypes").includes(l))return}}s[t.id]={id:t.id,text:t.getLabel({long:!0}),description:t.get("description"),model:t}});const d=this.model.get("activityKind"),c=a.activityKinds.get(d);d&&!s[d]&&(c?c.hasKind(i)&&(s[d]={id:d,text:c.getLabel({long:!0}),description:c.get("description"),model:c}):s[d]={id:d,text:`?${d}?`});const u=Object.values(s).sort((t,e)=>t.text.localeCompare(e.text));e.select2({width:"100%",allowClear:!1,placeholder:" ",data:u,dropdownCssClass:"select2-with-description",formatResult:o.bind(null,"text","description")}),t&&s[t]?e.val(t).select2("data",s[t]):1===u.length&&e.val(u[0].id).select2("data",u[0])},setUpImplementersSelect2:function(){const t=this.$id("implementers"),i=this.model.isCoordinator()||h.can.manage();n(t,{width:"100%",multiple:!0,maximumSelectionSize:i?10:2,noPersonnelId:!0,userInfoDecorators:[r]});const s=[];if(this.options.editMode)(this.model.get("implementers")||[]).forEach(t=>{s.push({id:t.id,text:t.label,user:t})});else{const t=this.model.get("creator")||r(e.getInfo(),e.data),o=(this.model.get("implementers")||[]).find(e=>e.id!==t.id);s.push({id:t.id,text:t.label,locked:!i,user:t}),o&&s.push({id:o.id,text:o.label,user:o})}t.select2("data",s).select2("enable",!this.options.editMode||i);const o=this.$id("plannedAt");o.length&&o.prop("disabled",!!o.val()&&!i)},setUpParticipantsSelect2:function(){n(this.$id("participants"),{width:"100%",multiple:!0,userInfoDecorators:[r],noPersonnelId:!0,currentUserInfo:this.model.get("participants")||[]})},setUpRootCauseCategoryPopover:function(){const t=this.$id("rootCauses");t.popover({selector:".control-label",container:this.$id("rootCausesGroup"),className:"osh-actions-form-rootCause-popover",placement:"bottom",trigger:"click",html:!0,content:function(){const t=a.rootCauseCategories.get(+this.previousElementSibling.value);if(t)return t.get("description")}}),t.on("show.bs.popover",function(){t.find('.control-label[aria-describedby^="popover"]').popover("hide")})},toggleKind:function(){const t=this.$('input[name="kind[]"]');t.length&&!t.filter(":checked").length&&t.first().click(),t.prop("disabled",!h.can.editKind(this.model,this.options.editMode))},getActivityFeatures:function(){const t=a.activityKinds.get(+this.$id("activityKind").val()),e={resolution:"none",participants:!1,rootCauses:!1,implementers:!1,resolutions:!1};return t&&Object.assign(e,t.pick(["participants","rootCauses","resolution"])),e.implementers="implementers"===e.resolution,e.resolutions="resolutions"===e.resolution,e},toggleActivityKind:function(){const t=this.getActivityFeatures();this.toggleRootCausesFeature(t),this.toggleResolutionsFeature(t),this.toggleImplementersFeature(t),this.toggleParticipantsFeature(t),s.adjustDialogBackdrop()},toggleParticipantsFeature:function(t){this.$id("participants").prop("required",t.participants).closest(".form-group").toggleClass("has-required-select2",t.participants).closest(".row").toggleClass("hidden",!t.participants)},toggleRootCausesFeature:function(t){this.$id("problem").closest(".form-group").removeClass("col-lg-4 col-lg-12").addClass(`col-lg-${t.rootCauses?12:4}`),this.$id("rootCausesGroup").toggleClass("hidden",!t.rootCauses),this.$id("reason").closest(".form-group").toggleClass("hidden",t.rootCauses),this.$id("suggestion").closest(".form-group").toggleClass("hidden",t.rootCauses),this.checkWhyValidity()},toggleResolutionsFeature:function(t){this.$id("solution").closest(".form-group").toggleClass("hidden",t.resolutions),this.$id("resolutionsGroup").toggleClass("hidden",!t.resolutions),this.$id("addResolution").prop("disabled",s.currentDialog===this)},toggleImplementersFeature:function(t){this.$id("plannedAt").prop("required",t.implementers),this.$id("implementers").prop("required",t.implementers).closest(".form-group").toggleClass("has-required-select2",t.implementers).closest(".row").toggleClass("hidden",!t.implementers),this.$id("problem").prop("required",t.implementers).closest(".form-group").find(".control-label").toggleClass("is-required",t.implementers)},checkWhyValidity:function(){let t=!1;this.getActivityFeatures().rootCauses&&(t=!0,this.$id("rootCauses").find("textarea").each(function(){let e=this.value.trim();/^[^a-zA-Z]+$/.test(e)&&(e=""),e.length&&(t=!1),this.value=e})),this.$('textarea[name="rootCauses[0].why[0]"]').prop("required",t)},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var t=d.prototype.request.apply(this,arguments);return t.always(function(){s.msg.saved()}),t},submitRequest:function(t,e){const i=this,o=new FormData;let n=0;if(i.$('input[type="file"]').each(function(){const t=this.name.replace("attachments.","");for(let e=0;e<this.files.length;++e)o.append(t,this.files[e]),n+=1}),0===n)return d.prototype.submitRequest.call(i,t,e);s.msg.saving();const a=i.ajax({type:"POST",url:"/osh/attachments",data:o,processData:!1,contentType:!1});a.done(o=>{e.attachments={added:o},d.prototype.submitRequest.call(i,t,e),s.msg.saved()}),a.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),t.attr("disabled",!1)})},onDialogShown:function(){this.$id("subject").focus()},linkResolution:function(){const t=this.$id("resolutionRid");if(t[0].setCustomValidity(""),!t[0].checkValidity())return void t[0].reportValidity();if(!t.val().length)return void t.focus();const e=t.val().toUpperCase().split("-"),i=e[0],o=a.PREFIX_TO_TYPE[i],n=`${i}-${e[1]}-${e[2].padStart(6,"0")}`;if(n===this.model.get("rid"))return void t.val("").focus();t.val(n);const l=this.$id("resolutions").find(`tr[data-id="${n}"]`);if(l.length)return t.val(""),l.removeClass("highlight"),l.addClass("highlight"),clearTimeout(this.timers[`highlight:${n}`]),void(this.timers[`highlight:${n}`]=setTimeout(()=>l.removeClass("highlight"),1e3));s.msg.loading();const r=this.$id("resolutionsActions").find("input, button").prop("disabled",!0),d=this.ajax({url:`/osh/${a.TYPE_TO_MODULE[o]}?rid=${n}&exclude(changes)&limit(1)`});d.fail(()=>{s.msg.loadingFailed(),t[0].setCustomValidity(this.t("resolutions:error:failure"))}),d.done(e=>{if(s.msg.loaded(),!e.collection||!e.collection.length)return void t[0].setCustomValidity(this.t("resolutions:error:notFound"));const i=e.collection[0];"finished"!==i.status||(this.model.get("resolutions")||[]).some(t=>t.rid===i.rid)?(t.val(""),this.resolutions.add(i,{highlight:!0})):t[0].setCustomValidity(this.t("resolutions:error:finished"))}),d.always(()=>{r.prop("disabled",!1),this.$id("addResolution").prop("disabled",s.currentDialog===this),t[0].checkValidity()||t[0].reportValidity()})},addResolution:function(t,e,{highlight:i}){const s=this.renderPartial(m,{i:this.resolutionsI++,entry:t.serializeRow(),resolution:t.getRelation()});this.$id("resolutions").append(s),i&&(s.addClass("highlight"),this.timers[`highlight:${t.id}`]=setTimeout(()=>s.removeClass("highlight"),1e3))},removeResolution:function(t){this.$id("resolutions").find(`tr[data-id="${t.id}"]`).remove()},showAddResolutionDialog:function(t){if(!this.el.checkValidity())return this.$id("save").click();const e=Object.assign(this.model.toJSON(),this.getFormData());let i=null;if("kaizen"===t)i=new u({relation:this.model,model:new c({kind:e.kind,division:e.division,workplace:e.workplace,department:e.department,building:e.building,location:e.location,station:e.station})});else{if("action"!==t)return;{const t=this.constructor;i=new t({relation:this.model,model:new h({kind:e.kind,division:e.division,workplace:e.workplace,department:e.department,building:e.building,location:e.location,station:e.station})})}}s.showDialog(i,this.t(`resolutions:title:${t}`)),i.handleSuccess=(()=>{this.resolutions.add(i.model.toJSON(),{highlight:!0}),s.closeDialog()})},showParticipantFinderDialog:function(){const t=new p;s.showDialog(t,this.t("participantFinder:title")),this.listenToOnce(t,"users",t=>{if(s.closeDialog(),0===t.length)return;const e=this.$id("participants"),i=new Map;e.select2("data").forEach(t=>{i.set(t.id,t)}),t.forEach(t=>{i.set(t.id,{id:t.id,text:t.label})});const o=Array.from(i.values()).sort((t,e)=>t.text.localeCompare(e.text));e.select2("data",o)})}})});