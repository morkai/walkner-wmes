define(["underscore","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/Resolution","app/wmes-osh-common/util/userInfoDecorator","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../Action","app/wmes-osh-actions/templates/form/form","app/wmes-osh-actions/templates/form/resolutionRow"],function(t,e,i,s,o,n,l,a,r,d,c,h,u,p,g){"use strict";return o.extend({template:p,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDepartment").val(""),this.setUpUserDepartmentSelect2()},"change #-workplace":function(){this.$id("department").val(""),this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-department":function(){this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-building":function(){this.$id("location").val(""),this.$id("station").val(""),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()},'change input[name="kind"]':function(){this.$id("activityKind").val(""),this.setUpActivityKindSelect2(),this.toggleActivityKind()},"change #-activityKind":function(){this.toggleActivityKind()},'change textarea[name*="why"]':function(){this.checkWhyValidity()},'change input[type="file"][data-max]':function(t){const e=t.currentTarget,i=+e.dataset.max;e.setCustomValidity(e.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const t=this.$id("comment");if("verification"===this.model.get("status")&&!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-verification":function(){this.newStatus="verification";const t=this.$id("solution");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-finished":function(){this.newStatus="finished";const t=this.$id("solution");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-paused":function(){this.newStatus="paused";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"keydown #-resolutionRid":function(t){t.currentTarget.setCustomValidity(""),"Enter"===t.key&&t.preventDefault()},"keyup #-resolutionRid":function(t){"Enter"===t.key&&this.linkResolution()},"click #-linkResolution":function(){this.linkResolution()},'click .btn[data-action="removeResolution"]':function(t){this.resolutions.remove(this.$(t.target).closest("tr")[0].dataset.id)},"click #-addKaizenResolution":function(){this.showAddResolutionDialog("kaizen")},"click #-addActionResolution":function(){this.showAddResolutionDialog("action")}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.resolutionsI=0,this.newStatus=this.options.newStatus||"new",this.once("afterRender",()=>{this.listenTo(this.resolutions,"add",this.addResolution),this.listenTo(this.resolutions,"remove",this.removeResolution)})},getTemplateData:function(){return{today:i.getMoment().format("YYYY-MM-DD"),kinds:this.serializeKinds(),can:{inProgress:u.can.inProgress(this.model),verification:u.can.verification(this.model),finished:u.can.finished(this.model),paused:u.can.paused(this.model),cancelled:u.can.cancelled(this.model)},relation:!!this.relation,rootCauses:this.serializeRootCauses()}},serializeKinds:function(){const t={};a.kinds.forEach(e=>{e.get("active")&&(t[e.id]={value:e.id,label:e.getLabel({long:!0}),title:e.get("description")})});const e=a.kinds.get(this.model.get("kind"));return e&&!t[e]&&(t[e.id]={value:e.id,label:e.getLabel({long:!0}),title:e.get("description")}),Object.values(t).sort((t,e)=>t.label.localeCompare(e.label))},serializeRootCauses:function(){const t=this.model.get("rootCauses");return t&&t.length?t.map(t=>{const e=a.rootCauseCategories.get(t.category);return e?{category:e.id,label:e.getLabel({long:!0}),description:!!e.get("description"),why:t.why}:{category:t.category,label:`?${t.category}?`,description:!1,why:t.why}}):a.rootCauseCategories.map(t=>({category:t.id,label:t.getLabel({long:!0}),description:!!t.get("description"),why:["","","","",""]}))},serializeToForm:function(){const t=this.model.toJSON();return t.plannedAt&&(t.plannedAt=i.utc.format(t.plannedAt,"YYYY-MM-DD")),t.rootCauses=this.serializeRootCauses().map(t=>({category:t.category,why:t.why})),delete t.coordinators,delete t.attachments,delete t.users,delete t.changes,t},serializeForm:function(t){const e=this.getActivityFeatures(),s=this.$id("userWorkplace").select2("data");if(t.userDivision=s.model.get("division"),t.userWorkplace=s.id,t.userDepartment=this.$id("userDepartment").select2("data").id,t.activityKind=this.$id("activityKind").select2("data").id,this.relation)t.relation=this.relation.getRelation();else{const e=this.$id("workplace").select2("data");t.division=e.model.get("division"),t.workplace=e.id,t.department=this.$id("department").select2("data").id,t.building=this.$id("building").select2("data").id,t.location=this.$id("location").select2("data").id,t.station=parseInt(this.$id("station").val(),10)||null}return e.rootCauses?(t.status="inProgress",t.rootCauses.forEach(t=>{for(t.category=+t.category,t.why||(t.why=[]);t.why.length<5;)t.why.push("")}),t.resolutions||(t.resolutions=[]),t.resolutions.forEach(t=>{t._id=+t._id}),t.reason="",t.suggestion="",t.solution=""):(t.rootCauses=null,t.resolutions=null),e.implementers?(t.status=this.newStatus,t.implementers=l.getUserInfo(this.$id("implementers")),t.plannedAt=i.utc.getMoment(this.$id("plannedAt").val(),"YYYY-MM-DD").toISOString()):(t.implementers=null,t.plannedAt=null),e.participants?t.participants=l.getUserInfo(this.$id("participants")):t.participants=null,t.status||(t.status="finished"),t},afterRender:function(){o.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpActivityKindSelect2(),this.setUpImplementersSelect2(),this.setUpParticipantsSelect2(),this.setUpRootCauseCategoryPopover(),this.toggleKind(),this.toggleActivityKind(),this.options.editMode&&this.resolutions.forEach(t=>this.addResolution(t,this.resolutions,{}))},setUpUserWorkplaceSelect2:function(){const t=this.$id("userWorkplace");if(this.options.editMode){const e=a.workplaces.get(this.model.get("userWorkplace"));return t.val(e?e.id:"").select2({width:"100%",placeholder:" ",data:e?[{id:e.id,text:e.getLabel({long:!0}),model:e}]:[]}),void t.select2("enable",!1)}t.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let i=a.workplaces.get(+t.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s={};a.workplaces.forEach(t=>{t.get("active")&&(s[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!s[i.id]&&(s[i.id]=i),t.select2({width:"100%",data:Object.values(s).sort((t,e)=>t.text.localeCompare(e.text))});const o=a.workplaces.get(e.data.oshWorkplace);this.options.editMode&&i?t.select2("enable",!1).select2("data",i):o?t.select2("enable",!1).select2("data",{id:o.id,text:o.getLabel({long:!0}),model:o}):t.select2("enable",!0)},setUpUserDepartmentSelect2:function(){const t=this.$id("userDepartment");if(this.options.editMode){const e=a.departments.get(this.model.get("userDepartment"));return t.val(e?e.id:"").select2({width:"100%",placeholder:" ",data:e?[{id:e.id,text:e.getLabel({long:!0}),model:e}]:[]}),void t.select2("enable",!1)}const i=+this.$id("userWorkplace").val();let s=a.departments.get(+t.val());s&&(s={id:s.id,text:s.getLabel({long:!0}),model:s});const o={};a.departments.forEach(t=>{t.get("active")&&t.get("workplace")===i&&(o[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),s&&!o[s.id]&&s.model.get("workplace")===i&&(o[s.id]=s);const n=Object.values(o).sort((t,e)=>t.text.localeCompare(e.text));let l=" ",r=!0;i||0!==n.length||(l=this.t("FORM:placeholder:noUserWorkplace"),r=!1),t.select2({width:"100%",placeholder:l,data:n});const d=a.departments.get(e.data.oshDepartment);this.options.editMode&&s?t.select2("enable",!1).select2("data",s):d?t.select2("enable",!1).select2("data",{id:d.id,text:d.getLabel({long:!0}),model:d}):(t.select2("enable",r),1===n.length?t.select2("data",n[0]):o[t.val()]||t.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const t=this.$id("workplace");let e=a.workplaces.get(+t.val());e&&(e={id:e.id,text:e.getLabel({long:!0}),model:e});const i={};a.workplaces.forEach(t=>{t.get("active")&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),e&&!i[e.id]&&(i[e.id]=e),t.select2({width:"100%",data:Object.values(i).sort((t,e)=>t.text.localeCompare(e.text))}),t.select2("enable",!this.options.editMode||u.can.manage()||this.model.isCoordinator())},setUpDepartmentSelect2:function(){const t=this.$id("department"),e=+this.$id("workplace").val();let i=a.departments.get(+t.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s={};a.departments.forEach(t=>{t.get("active")&&t.hasWorkplace(e)&&(s[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!s[i.id]&&(s[i.id]=i);const o=Object.values(s).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noWorkplace"),data:o}),1===o.length?t.select2("data",o[0]):s[t.val()]||t.val("").select2("data",null),t.select2("enable",!!e&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(){const t=this.$id("building"),e=+this.$id("department").val(),i={};a.buildings.forEach(t=>{t.get("active")&&t.hasDepartment(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const s=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noDepartment"),data:s}),1===s.length&&t.select2("data",s[0]),t.select2("enable",!!e&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const t=this.$id("location"),e=+this.$id("building").val(),i={};a.locations.forEach(t=>{t.get("active")&&t.hasBuilding(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const s=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noBuilding"),data:s}),1===s.length&&t.select2("data",s[0]),t.select2("enable",!!e&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const t=this.$id("station"),e=+this.$id("location").val(),i={};a.stations.forEach(t=>{t.get("active")&&t.hasLocation(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const s=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noLocation"),allowClear:!0,data:s}),1===s.length&&t.select2("data",s[0]),t.select2("enable",s.length>0&&!!e&&(!this.options.editMode||u.can.manage()||this.model.isCoordinator()))},setUpActivityKindSelect2:function(){const t=this.$id("activityKind"),e=+this.$('input[name="kind"]:checked').val()||this.model.get("kind"),i={},s=this.options.editMode||u.can.manage()||a.isCoordinator(),o=this.relation?this.relation.getModelType():null,l=a.activityKinds.get(this.options.forcedActivityKind);a.activityKinds.forEach(t=>{if(l){if(l!==t)return}else{if(!t.get("active")||!t.hasKind(e))return;if(this.relation){if("implementers"!==t.get("resolution"))return;if(!s&&t.get("allowedTypes").includes(o))return}}i[t.id]={id:t.id,text:t.getLabel({long:!0}),description:t.get("description"),model:t}});const r=this.model.get("activityKind"),d=a.activityKinds.get(r);r&&!i[r]&&(d?d.hasKind(e)&&(i[r]={id:r,text:d.getLabel({long:!0}),description:d.get("description"),model:d}):i[r]={id:r,text:`?${r}?`});const c=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",allowClear:!1,placeholder:" ",data:c,dropdownCssClass:"select2-with-description",formatResult:n.bind(null,"text","description")}),1===c.length&&t.val(c[0].id).select2("data",c[0])},setUpImplementersSelect2:function(){const t=this.$id("implementers"),i=this.model.isCoordinator()||u.can.manage();l(t,{width:"100%",multiple:!0,maximumSelectionSize:i?10:2,noPersonnelId:!0,userInfoDecorators:[d]});const s=this.model.get("creator")||e.getInfo(),o=(this.model.get("implementers")||[]).find(t=>t.id!==s.id),n=[{id:s.id,text:s.label,locked:!i,user:s}];o&&n.push({id:o.id,text:o.label,user:o}),t.select2("data",n).select2("enable",!this.options.editMode||i);const a=this.$id("plannedAt");a.length&&a.prop("disabled",!!a.val()&&!i)},setUpParticipantsSelect2:function(){l(this.$id("participants"),{width:"100%",multiple:!0,userInfoDecorators:[d],noPersonnelId:!0,currentUserInfo:this.model.get("participants")||[]})},setUpRootCauseCategoryPopover:function(){const t=this.$id("rootCauses");t.popover({selector:".control-label",container:this.$id("rootCausesGroup"),className:"osh-actions-form-rootCause-popover",placement:"bottom",trigger:"click",html:!0,content:function(){const t=a.rootCauseCategories.get(+this.previousElementSibling.value);if(t)return t.get("description")}}),t.on("show.bs.popover",function(){t.find('.control-label[aria-describedby^="popover"]').popover("hide")})},toggleKind:function(){const t=this.$('input[name="kind"]');t.length&&!t.filter(":checked").length&&t.first().click(),t.prop("disabled",!u.can.editKind(this.model,this.options.editMode))},getActivityFeatures:function(){const t=a.activityKinds.get(+this.$id("activityKind").val()),e={participants:!1,resolution:"none",rootCauses:!1,implementers:!1};return t&&Object.assign(e,t.pick(["participants","resolution"])),e.rootCauses="rootCauses"===e.resolution,e.implementers="implementers"===e.resolution,e.resolution="none"!==e.resolution,e},toggleActivityKind:function(){const t=this.getActivityFeatures();this.toggleRootCausesFeature(t),this.toggleImplementersFeature(t),this.toggleRootCausesFeature(t),this.$id("participants").prop("required",t.participants).closest(".form-group").toggleClass("has-required-select2",t.participants).closest(".row").toggleClass("hidden",!t.participants),s.$dialog&&s.$dialog.modal("adjustBackdrop")},toggleRootCausesFeature:function(t){this.$id("problem").closest(".form-group").removeClass("col-lg-4 col-lg-12").addClass(`col-lg-${t.rootCauses?12:4}`),this.$id("rootCausesGroup").toggleClass("hidden",!t.rootCauses),this.$id("reason").closest(".form-group").toggleClass("hidden",t.rootCauses),this.$id("suggestion").closest(".form-group").toggleClass("hidden",t.rootCauses),this.$id("solution").closest(".form-group").toggleClass("hidden",t.rootCauses),this.$id("resolutionsGroup").toggleClass("hidden",!t.rootCauses),this.$id("addResolution").prop("disabled",s.currentDialog===this),this.checkWhyValidity()},toggleImplementersFeature:function(t){this.$id("plannedAt").prop("required",t.implementers),this.$id("implementers").prop("required",t.implementers).closest(".form-group").toggleClass("has-required-select2",t.implementers).closest(".row").toggleClass("hidden",!t.implementers),this.$id("problem").prop("required",t.implementers).closest(".form-group").find(".control-label").toggleClass("is-required",t.implementers)},checkWhyValidity:function(){let t=!1;this.getActivityFeatures().rootCauses&&(t=!0,this.$id("rootCauses").find("textarea").each(function(){let e=this.value.trim();/^[^a-zA-Z]+$/.test(e)&&(e=""),e.length&&(t=!1),this.value=e})),this.$('textarea[name="rootCauses[0].why[0]"]').prop("required",t)},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var t=o.prototype.request.apply(this,arguments);return t.always(function(){s.msg.saved()}),t},submitRequest:function(t,e){const i=this,n=new FormData;let l=0;if(i.$('input[type="file"]').each(function(){const t=this.name.replace("attachments.","");for(let e=0;e<this.files.length;++e)n.append(t,this.files[e]),l+=1}),0===l)return o.prototype.submitRequest.call(i,t,e);s.msg.saving();const a=i.ajax({type:"POST",url:"/osh/attachments",data:n,processData:!1,contentType:!1});a.done(n=>{e.attachments={added:n},o.prototype.submitRequest.call(i,t,e),s.msg.saved()}),a.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),t.attr("disabled",!1)})},onDialogShown:function(){this.$id("subject").focus()},linkResolution:function(){const t=this.$id("resolutionRid");if(t[0].setCustomValidity(""),!t[0].checkValidity())return void t[0].reportValidity();if(!t.val().length)return void t.focus();const e=t.val().toUpperCase().split("-"),i=e[0],o=a.PREFIX_TO_TYPE[i],n=`${i}-${e[1]}-${e[2].padStart(6,"0")}`;if(n===this.model.get("rid"))return void t.val("").focus();t.val(n);const l=this.$id("resolutions").find(`tr[data-id="${n}"]`);if(l.length)return t.val(""),l.removeClass("highlight"),l.addClass("highlight"),clearTimeout(this.timers[`highlight:${n}`]),void(this.timers[`highlight:${n}`]=setTimeout(()=>l.removeClass("highlight"),1e3));s.msg.loading();const r=this.$id("resolutionsActions").find("input, button").prop("disabled",!0),d=this.ajax({url:`/osh/${a.TYPE_TO_MODULE[o]}?rid=${n}&exclude(changes)&limit(1)`});d.fail(()=>{s.msg.loadingFailed(),t[0].setCustomValidity(this.t("resolutions:error:failure"))}),d.done(e=>{if(s.msg.loaded(),!e.collection||!e.collection.length)return void t[0].setCustomValidity(this.t("resolutions:error:notFound"));const i=e.collection[0];"finished"!==i.status||(this.model.get("resolutions")||[]).some(t=>t.rid===i.rid)?(t.val(""),this.resolutions.add(i,{highlight:!0})):t[0].setCustomValidity(this.t("resolutions:error:finished"))}),d.always(()=>{r.prop("disabled",!1),this.$id("addResolution").prop("disabled",s.currentDialog===this),t[0].checkValidity()||t[0].reportValidity()})},addResolution:function(t,e,{highlight:i}){const s=this.renderPartial(g,{i:this.resolutionsI++,entry:t.serializeRow(),resolution:t.getRelation()});this.$id("resolutions").append(s),i&&(s.addClass("highlight"),this.timers[`highlight:${t.id}`]=setTimeout(()=>s.removeClass("highlight"),1e3))},removeResolution:function(t){this.$id("resolutions").find(`tr[data-id="${t.id}"]`).remove()},showAddResolutionDialog:function(t){if(!this.el.checkValidity())return this.$id("save").click();const e=Object.assign(this.model.toJSON(),this.getFormData());let i=null;if("kaizen"===t)i=new h({relation:this.model,model:new c({kind:e.kind,division:e.division,workplace:e.workplace,department:e.department,building:e.building,location:e.location,station:e.station})});else{if("action"!==t)return;{const t=this.constructor;i=new t({relation:this.model,model:new u({kind:e.kind,division:e.division,workplace:e.workplace,department:e.department,building:e.building,location:e.location,station:e.station})})}}s.showDialog(i,this.t(`resolutions:title:${t}`)),i.handleSuccess=(()=>{this.resolutions.add(i.model.toJSON(),{highlight:!0}),s.closeDialog()})}})});