define(["underscore","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","../Action","app/wmes-osh-actions/templates/form"],function(t,e,i,s,o,a,l,n,c,d){"use strict";return o.extend({template:d,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDivision").val(""),this.setUpUserDivisionSelect2()},"change #-workplace":function(){this.$id("division").val(""),this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-division":function(){this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-building":function(){this.$id("location").val(""),this.$id("station").val(""),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()},'change input[name="kind"]':function(){this.$id("activityKind").val(""),this.setUpActivityKindSelect2(),this.toggleActivityKind()},"change #-activityKind":function(){this.toggleActivityKind()},'change textarea[name*="why"]':function(){this.checkWhyValidity()},'change input[type="file"][data-max]':function(t){const e=t.currentTarget,i=+e.dataset.max;e.setCustomValidity(e.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const t=this.$id("comment");if("verification"===this.model.get("status")&&!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-verification":function(){this.newStatus="verification";const t=this.$id("solution");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-finished":function(){this.newStatus="finished";const t=this.$id("solution");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-paused":function(){this.newStatus="paused";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)}},o.prototype.events),getTemplateData:function(){return{today:i.getMoment().format("YYYY-MM-DD"),kinds:this.serializeKinds(),can:{inProgress:c.can.inProgress(this.model),verification:c.can.verification(this.model),finished:c.can.finished(this.model),paused:c.can.paused(this.model),cancelled:c.can.cancelled(this.model)},relation:!!this.relation,rootCauses:this.serializeRootCauses()}},serializeKinds:function(){const t={};n.kinds.forEach(e=>{e.get("active")&&(t[e.id]={value:e.id,label:e.getLabel({long:!0}),title:e.get("description")})});const e=n.kinds.get(this.model.get("kind"));return e&&!t[e]&&(t[e.id]={value:e.id,label:e.getLabel({long:!0}),title:e.get("description")}),Object.values(t).sort((t,e)=>t.label.localeCompare(e.label))},serializeRootCauses:function(){const t=this.model.get("rootCauses");return t&&t.length?t.map(t=>{const e=n.rootCauseCategories.get(t.category);return e?{category:e.id,label:e.getLabel({long:!0}),description:!!e.get("description"),why:t.why}:{category:t.category,label:`?${t.category}?`,description:!1,why:t.why}}):n.rootCauseCategories.map(t=>({category:t.id,label:t.getLabel({long:!0}),description:!!t.get("description"),why:["","","","",""]}))},serializeToForm:function(){const t=this.model.toJSON();return t.plannedAt&&(t.plannedAt=i.utc.format(t.plannedAt,"YYYY-MM-DD")),t.rootCauses=this.serializeRootCauses().map(t=>({category:t.category,why:t.why})),delete t.coordinators,delete t.attachments,delete t.users,delete t.changes,t},serializeForm:function(t){const e=this.getActivityFeatures();return this.newStatus?t.status=this.newStatus:e.implementers||(t.status="finished"),t.userWorkplace=this.$id("userWorkplace").select2("data").id,t.userDivision=this.$id("userDivision").select2("data").id,t.activityKind=this.$id("activityKind").select2("data").id,this.relation?t.relation=this.relation.getRelation():(t.workplace=this.$id("workplace").select2("data").id,t.division=this.$id("division").select2("data").id,t.building=this.$id("building").select2("data").id,t.location=this.$id("location").select2("data").id,t.station=parseInt(this.$id("station").val(),10)||null),e.rootCauses?t.rootCauses.forEach(t=>{for(t.category=+t.category,t.why||(t.why=[]);t.why.length<5;)t.why.push("")}):t.rootCauses=[],e.implementers?(t.implementers=l.getUserInfo(this.$id("implementers")),t.plannedAt=i.utc.getMoment(this.$id("plannedAt").val(),"YYYY-MM-DD").toISOString()):(t.implementers=[],t.plannedAt=null),t.participants?t.participants=l.getUserInfo(this.$id("participants")):t.participants=[],t},afterRender:function(){o.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpActivityKindSelect2(),this.setUpImplementersSelect2(),this.setUpParticipantsSelect2(),this.setUpRootCauseCategoryPopover(),this.toggleKind(),this.toggleActivityKind()},setUpUserWorkplaceSelect2:function(){const t=this.$id("userWorkplace");if(this.options.editMode){const e=n.workplaces.get(this.model.get("userWorkplace"));return t.val(e?e.id:"").select2({width:"100%",placeholder:" ",data:e?[{id:e.id,text:e.getLabel({long:!0}),model:e}]:[]}),void t.select2("enable",!1)}t.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let i=n.workplaces.get(+t.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s={};n.workplaces.forEach(t=>{t.get("active")&&(s[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!s[i.id]&&(s[i.id]=i),t.select2({width:"100%",data:Object.values(s).sort((t,e)=>t.text.localeCompare(e.text))});const o=n.workplaces.get(e.data.oshWorkplace);this.options.editMode&&i?t.select2("enable",!1).select2("data",i):o?t.select2("enable",!1).select2("data",{id:o.id,text:o.getLabel({long:!0}),model:o}):t.select2("enable",!0)},setUpUserDivisionSelect2:function(){const t=this.$id("userDivision");if(this.options.editMode){const e=n.divisions.get(this.model.get("userDivision"));return t.val(e?e.id:"").select2({width:"100%",placeholder:" ",data:e?[{id:e.id,text:e.getLabel({long:!0}),model:e}]:[]}),void t.select2("enable",!1)}const i=+this.$id("userWorkplace").val();let s=n.divisions.get(+t.val());s&&(s={id:s.id,text:s.getLabel({long:!0}),model:s});const o={};n.divisions.forEach(t=>{t.get("active")&&t.get("workplace")===i&&(o[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),s&&!o[s.id]&&s.model.get("workplace")===i&&(o[s.id]=s);const a=Object.values(o).sort((t,e)=>t.text.localeCompare(e.text));let l=" ",c=!0;i||0!==a.length||(l=this.t("FORM:placeholder:noUserWorkplace"),c=!1),t.select2({width:"100%",placeholder:l,data:a});const d=n.divisions.get(e.data.oshDivision);this.options.editMode&&s?t.select2("enable",!1).select2("data",s):d?t.select2("enable",!1).select2("data",{id:d.id,text:d.getLabel({long:!0}),model:d}):(t.select2("enable",c),1===a.length?t.select2("data",a[0]):o[t.val()]||t.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const t=this.$id("workplace");let e=n.workplaces.get(+t.val());e&&(e={id:e.id,text:e.getLabel({long:!0}),model:e});const i={};n.workplaces.forEach(t=>{t.get("active")&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),e&&!i[e.id]&&(i[e.id]=e),t.select2({width:"100%",data:Object.values(i).sort((t,e)=>t.text.localeCompare(e.text))}),t.select2("enable",!this.options.editMode||c.can.manage()||this.model.isCoordinator())},setUpDivisionSelect2:function(){const t=this.$id("division"),e=+this.$id("workplace").val();let i=n.divisions.get(+t.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s={};n.divisions.forEach(t=>{t.get("active")&&t.hasWorkplace(e)&&(s[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!s[i.id]&&(s[i.id]=i);const o=Object.values(s).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noWorkplace"),data:o}),1===o.length?t.select2("data",o[0]):s[t.val()]||t.val("").select2("data",null),t.select2("enable",!!e&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(){const t=this.$id("building"),e=+this.$id("division").val(),i={};n.buildings.forEach(t=>{t.get("active")&&t.hasDivision(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const s=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noDivision"),data:s}),1===s.length&&t.select2("data",s[0]),t.select2("enable",!!e&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const t=this.$id("location"),e=+this.$id("building").val(),i={};n.locations.forEach(t=>{t.get("active")&&t.hasBuilding(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const s=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noBuilding"),data:s}),1===s.length&&t.select2("data",s[0]),t.select2("enable",!!e&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const t=this.$id("station"),e=+this.$id("location").val(),i={};n.stations.forEach(t=>{t.get("active")&&t.hasLocation(e)&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})});const s=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:e?" ":this.t("FORM:placeholder:noLocation"),allowClear:!0,data:s}),1===s.length&&t.select2("data",s[0]),t.select2("enable",s.length>0&&!!e&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpActivityKindSelect2:function(){const t=this.$id("activityKind"),e=+this.$('input[name="kind"]:checked').val()||this.model.get("kind"),i={};n.activityKinds.forEach(t=>{t.get("active")&&t.hasKind(e)&&(this.relation&&!t.get("implementers")||(i[t.id]={id:t.id,text:t.getLabel({long:!0}),description:t.get("description"),model:t}))});const s=this.model.get("activityKind"),o=n.activityKinds.get(s);s&&!i[s]&&(o?o.hasKind(e)&&(i[s]={id:s,text:o.getLabel({long:!0}),description:o.get("description"),model:o}):i[s]={id:s,text:`?${s}?`});const l=Object.values(i).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",allowClear:!1,placeholder:" ",data:l,dropdownCssClass:"select2-with-description",formatResult:a.bind(null,"text","description")}),1===l.length&&t.val(l[0].id).select2("data",l[0])},setUpImplementersSelect2:function(){const t=this.$id("implementers"),i=this.model.isCoordinator()||c.can.manage();l(t,{width:"100%",multiple:!0,maximumSelectionSize:i?10:2});const s=this.model.get("creator")||e.getInfo(),o=(this.model.get("implementers")||[]).find(t=>t.id!==s.id),a=[{id:s.id,text:s.label,locked:!i}];o&&a.push({id:o.id,text:o.label}),t.select2("data",a).select2("enable",!this.options.editMode||i);const n=this.$id("plannedAt");n.length&&n.prop("disabled",!!n.val()&&!i)},setUpParticipantsSelect2:function(){l(this.$id("participants"),{width:"100%",multiple:!0,currentUserInfo:this.model.get("participants")||[]})},setUpRootCauseCategoryPopover:function(){const t=this.$id("rootCauses");t.popover({selector:".control-label",container:this.$id("rootCausesGroup"),className:"osh-actions-form-rootCause-popover",placement:"bottom",trigger:"click",html:!0,content:function(){const t=n.rootCauseCategories.get(+this.previousElementSibling.value);if(t)return t.get("description")}}),t.on("show.bs.popover",function(){t.find('.control-label[aria-describedby^="popover"]').popover("hide")})},toggleKind:function(){const t=this.$('input[name="kind"]');t.length&&!t.filter(":checked").length&&t.first().click(),t.prop("disabled",!c.can.editKind(this.model,this.options.editMode))},getActivityFeatures:function(){const t=n.activityKinds.get(+this.$id("activityKind").val());return t?t.pick(["rootCauses","implementers","participants"]):{rootCauses:!1,implementers:!1,participants:!1}},toggleActivityKind:function(){const t=this.getActivityFeatures();this.$id("rootCausesGroup").toggleClass("hidden",!t.rootCauses),this.checkWhyValidity(),this.$id("plannedAt").prop("required",t.implementers),this.$id("implementers").prop("required",t.implementers).closest(".form-group").toggleClass("has-required-select2",t.implementers).closest(".row").toggleClass("hidden",!t.implementers),this.$id("participants").prop("required",t.participants).closest(".form-group").toggleClass("has-required-select2",t.participants).closest(".row").toggleClass("hidden",!t.participants),s.$dialog&&s.$dialog.modal("adjustBackdrop")},checkWhyValidity:function(){let t=!1;this.getActivityFeatures().rootCauses&&(t=!0,this.$id("rootCauses").find("textarea").each(function(){let e=this.value.trim();/^[^a-zA-Z]+$/.test(e)&&(e=""),e.length&&(t=!1),this.value=e})),this.$('textarea[name="rootCauses[0].why[0]"]').prop("required",t)},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var t=o.prototype.request.apply(this,arguments);return t.always(function(){s.msg.saved()}),t},submitRequest:function(t,e){const i=this,a=new FormData;let l=0;if(i.$('input[type="file"]').each(function(){const t=this.name.replace("attachments.","");for(let e=0;e<this.files.length;++e)a.append(t,this.files[e]),l+=1}),0===l)return o.prototype.submitRequest.call(i,t,e);s.msg.saving();const n=i.ajax({type:"POST",url:"/osh/attachments",data:a,processData:!1,contentType:!1});n.done(a=>{e.attachments={added:a},o.prototype.submitRequest.call(i,t,e),s.msg.saved()}),n.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),t.attr("disabled",!1)})},onDialogShown:function(){this.$id("subject").focus()}})});