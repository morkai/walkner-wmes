define(["underscore","select2","app/viewport","app/core/View","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-actions/templates/form/participantFinder"],function(e,t,i,n,s,a,o){"use strict";return n.extend({template:o,nlsDomain:"wmes-osh-actions",events:{submit:function(){return this.submit(),!1},'change input[name="source"]':function(){const e="brigade"===this.$('input[name="source"]:checked').val();this.$id("brigadeContainer").toggleClass("hidden",!e),this.$id("departmentContainer").toggleClass("hidden",e)},"change #-brigade":function(){const e=this.$id("brigade").val();e&&this.loadBrigade(e)},"change #-department":function(){const e=this.$id("department").val();e&&this.loadDepartment(+e)},"click #-unselectAll":function(){this.$id("users").find('input[type="checkbox"]').prop("checked",!1)},"click #-selectAll":function(){this.$id("users").find('input[type="checkbox"]').prop("checked",!0)},"click #-remove":function(){this.$id("users").find("input:not(:checked)").parent().remove()}},afterRender:function(){this.setUpBrigadeSelect2(),this.setUpDepartmentSelect2(),this.$('input[value="brigade"]').click()},setUpBrigadeSelect2:function(){s(this.$id("brigade"),{view:this})},setUpDepartmentSelect2:function(){const i=[],n={},s={long:!0};a.departments.forEach(e=>{if(!e.get("active"))return;const t=e.get("workplace");n[t]||(n[t]=[]),n[t].push({id:e.id.toString(),selection:a.workplaces.getLabel(t)+" > "+e.getLabel(),text:e.getLabel(s)})}),Object.keys(n).sort((e,t)=>(e=a.workplaces.getLabel(e,s),t=a.workplaces.getLabel(t,s),e.localeCompare(t,void 0,{numeric:!0,ignorePunctuation:!0}))).forEach(e=>{const t=a.workplaces.get(e),o=n[e];o.sort((e,t)=>e.text.localeCompare(t.text,void 0,{numeric:!0,ignorePunctuation:!0})),i.push({text:t?t.getLabel(s):e,children:o})}),this.$id("department").select2({placeholder:this.t("participantFinder:department:placeholder"),data:i,formatSelection:t=>{const i=e.escape(t.selection||t.text);return t.deactivated?'<span style="text-decoration: line-through">'+i+"</span>":i},formatResult:(e,i,n,s)=>{const a=[];return a.push('<span style="text-decoration: '+(e.deactivated?"line-through":"initial")+'">'),t.util.markMatch(e.text,n.term,a,s),a.push("</span>"),a.join("")}}),this.$id("departmentContainer").addClass("hidden")},addUsers:function(e){this.$id("noUsers").remove();const t=new Set;this.$('input[name="user"]').each((e,i)=>{t.add(i.value)}),e.forEach(e=>{t.has(e.id)||(t.add(e.id),this.addUser(e))}),i.adjustDialogBackdrop()},addUser:function(t){this.$id("users").append(`\n        <div class="checkbox">\n          <label>\n            <input type="checkbox" name="user" value="${t.id}" checked>\n            <span>${e.escape(t.label)}</span>\n          </label>\n        </div>\n      `)},toggleControls:function(e){this.$id("submit").prop("disabled",!e),this.$id("brigade").select2("enable",e),this.$id("department").select2("enable",e)},loadBrigade:function(e){this.toggleControls(!1),i.msg.loading();const t=this.ajax({url:`/osh/brigades?sort(-date)&limit(1)&leader.id=${e}`});t.fail(()=>{i.msg.loadingFailed()}),t.done(e=>{if(i.msg.loaded(),0===e.totalCount)i.msg.show({type:"warning",time:2500,text:this.t("participantFinder:noBrigade")});else{const t=e.collection[0],i=[t.leader].concat(t.members);this.addUsers(i)}}),t.always(()=>{this.toggleControls(!0)})},loadDepartment:function(e){this.toggleControls(!1),i.msg.loading();const t=this.ajax({url:`/osh/actions;participants?department=${e}`});t.fail(()=>{i.msg.loadingFailed()}),t.done(e=>{i.msg.loaded(),0===e.length?i.msg.show({type:"warning",time:2500,text:this.t("participantFinder:noDepartment")}):this.addUsers(e)}),t.always(()=>{this.toggleControls(!0)})},submit:function(){const e=[];this.$('input[name="user"]').each((t,i)=>{i.checked&&e.push({id:i.value,label:i.nextElementSibling.textContent})}),this.trigger("users",e)}})});