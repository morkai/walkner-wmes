define(["underscore","app/viewport","app/core/View","app/wmes-osh-common/dictionaries","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../Action","./FormView","app/wmes-osh-actions/templates/details/resolutions"],function(e,t,i,o,s,n,l,a,r){"use strict";return i.extend({template:r,events:{'click a[data-action="addResolution"]':function(e){this.showAddResolutionDialog(e.currentTarget.dataset.type)}},initialize:function(){i.prototype.initialize.apply(this,arguments),this.once("afterRender",()=>{const t=e.debounce(this.render,1);this.listenTo(this.resolutions,"reset change",t),this.listenTo(this.model,"change:resolutions",t),this.listenTo(this.model,"seen",this.onSeen)})},getTemplateData:function(){const e=this.model.getObserver();return{hidden:!this.model.get("resolutions"),resolutions:this.serializeResolutions(),unseen:e.notify&&(e.changes.all||e.changes.resolutions)}},serializeResolutions:function(){return(this.model.get("resolutions")||[]).filter(e=>!!this.resolutions.get(e.rid)).map(e=>this.resolutions.get(e.rid).serializeRow())},genResolutionUrl:function(e){return new(0,o.TYPE_TO_MODEL[e.type])({_id:e._id,rid:e.rid}).genClientUrl()},onSeen:function(){this.$(".osh-unseen").removeClass("osh-unseen")},showAddResolutionDialog:function(i){let o=null;if("kaizen"===i)o=new n({relation:this.model,model:new s({workplace:this.model.get("workplace"),department:this.model.get("department"),building:this.model.get("building"),location:this.model.get("location"),station:this.model.get("station")})});else{if("action"!==i)return;o=new a({relation:this.model,model:new l({workplace:this.model.get("workplace"),department:this.model.get("department"),building:this.model.get("building"),location:this.model.get("location"),station:this.model.get("station")})})}t.showDialog(o,this.t(`resolutions:title:${i}`)),o.handleSuccess=(()=>{const i=e.clone(this.model.get("resolutions")),s=o.model.getRelation();if(i.some(e=>e.rid===s.rid))return void t.closeDialog();i.push(s),t.closeDialog(),t.msg.saving();const n=this.promised(this.model.save({resolutions:i}),{wait:!0});n.fail(()=>t.msg.savingFailed()),n.done(()=>t.msg.saved())})}})});