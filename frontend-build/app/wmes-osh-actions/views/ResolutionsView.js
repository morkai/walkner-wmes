define(["underscore","app/viewport","app/core/View","app/wmes-osh-common/dictionaries","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../Action","./FormView","app/wmes-osh-actions/templates/details/resolutions"],function(e,i,t,o,s,n,l,a,r){"use strict";return t.extend({template:r,events:{'click a[data-action="addResolution"]':function(e){this.showAddResolutionDialog(e.currentTarget.dataset.type)}},initialize:function(){t.prototype.initialize.apply(this,arguments),this.once("afterRender",()=>{const i=e.debounce(this.render,1);this.listenTo(this.resolutions,"reset change",i),this.listenTo(this.model,"change:resolutions",i),this.listenTo(this.model,"seen",this.onSeen)})},getTemplateData:function(){const e=this.model.getObserver();return{resolutions:this.serializeResolutions(),unseen:e.notify&&(e.changes.all||e.changes.resolutions)}},serializeResolutions:function(){return(this.model.get("resolutions")||[]).filter(e=>!!this.resolutions.get(e.rid)).map(e=>this.resolutions.get(e.rid).serializeRow())},genResolutionUrl:function(e){return new(0,o.TYPE_TO_MODEL[e.type])({_id:e._id,rid:e.rid}).genClientUrl()},onSeen:function(){this.$(".osh-unseen").removeClass("osh-unseen")},showAddResolutionDialog:function(t){let o=null;if("kaizen"===t)o=new n({relation:this.model,model:new s({workplace:this.model.get("workplace"),division:this.model.get("division"),building:this.model.get("building"),location:this.model.get("location"),station:this.model.get("station")})});else{if("action"!==t)return;o=new a({relation:this.model,model:new l({workplace:this.model.get("workplace"),division:this.model.get("division"),building:this.model.get("building"),location:this.model.get("location"),station:this.model.get("station")})})}i.showDialog(o,this.t(`resolutions:title:${t}`)),o.handleSuccess=(()=>{const t=e.clone(this.model.get("resolutions")),s=o.model.getRelation();if(t.some(e=>e.rid===s.rid))return void i.closeDialog();t.push(s),i.closeDialog(),i.msg.saving();const n=this.promised(this.model.save({resolutions:t}),{wait:!0});n.fail(()=>i.msg.savingFailed()),n.done(()=>i.msg.saved())})}})});