define(["underscore","jquery","app/user","app/core/views/FilterView","app/core/util/forms/dateTimeRange","app/core/util/forms/dropdownRadio","app/core/util/idAndLabel","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/views/OrgUnitPickerFilterView","app/wmes-osh-actions/templates/filter","app/core/util/ExpandableSelect"],function(e,t,i,a,s,r,n,l,o,p,d){"use strict";return a.extend({filterList:["createdAt","locationPath","kind","activityKind","limit"],filterMap:{createdAt:"date",startedAt:"date",implementedAt:"date",plannedAt:"date",finishedAt:"date"},template:d,events:Object.assign({"click a[data-date-time-range]":s.handleRangeEvent,'change input[name="userType"]':function(){this.toggleUserSelect2(!0)}},a.prototype.events),defaultFormData:function(){return{userType:"others",dateFilter:"createdAt"}},termToForm:{createdAt:s.rqlToForm,startedAt:s.rqlToForm,implementedAt:s.rqlToForm,plannedAt:s.rqlToForm,finishedAt:s.rqlToForm,workplace:(e,t,i)=>{i[e]="in"===t.name?t.args[1].join(","):t.args[1]},department:"workplace",building:"workplace",location:"workplace",station:"workplace",activityKind:"workplace",kind:(e,t,i)=>{i[e]="in"===t.name?t.args[1]:[t.args[1]]},status:"kind","creator.id":(e,t,i)=>{i.userType=e.split(".")[0],i.user=t.args[1]},"implementers.id":"creator.id","participants.id":"creator.id","coordinators.id":"creator.id","users.user.id":(e,t,i)=>{"mine"===t.args[1]?(i.userType="mine",i.user=null):"unseen"===t.args[1]?(i.userType="unseen",i.user=null):(i.userType="others",i.user=t.args[1])}},initialize:function(){a.prototype.initialize.apply(this,arguments),this.setView("#-locationPath",new p({filterView:this,emptyLabel:this.t("PROPERTY:locationPath")}))},getTemplateData:function(){return{statuses:o.statuses.action.map(e=>({value:e,label:o.getLabel("status",e)})),kinds:o.kinds.map(e=>({value:e.id,label:e.getLabel({long:!0})}))}},serializeFormToQuery:function(e,t){const i=this.$('input[name="dateFilter"]:checked').val();t.sort={},t.sort[i]=-1,s.formToRql(this,e),["status","kind","activityKind"].forEach(t=>{const i=this.$id(t);let a=i.val();a&&a.length&&("string"==typeof a&&(a=a.split(",")),"SELECT"===i[0].tagName&&i[0].options.length===a.length||(1===(a=a.map(e=>/^[0-9]+$/.test(e)?parseInt(e,10):e)).length?e.push({name:"eq",args:[t,a[0]]}):e.push({name:"in",args:[t,a]})))});const a=this.$id("user").val();let r=this.$('input[name="userType"]').val();"mine"===r||"unseen"===r?e.push({name:"eq",args:["users.user.id",r]}):a&&("others"===r&&(r="users.user"),e.push({name:"eq",args:[r+".id",a]}))},afterRender:function(){a.prototype.afterRender.call(this),this.$(".is-expandable").expandableSelect(),l(this.$id("user"),{view:this,width:"100%"}),this.setUpUserType(),this.toggleUserSelect2(),this.setUpActivityKindSelect2()},setUpUserType:function(){var e=this,t=["mine","unseen","others","creator","implementers","participants","coordinators"].map(function(t){return{value:t,title:e.t(`filter:user:${t}:title`),optionLabel:e.t(`filter:user:${t}`)}});r(e.$id("userType"),{label:e.t("filter:user:others"),options:t})},toggleUserSelect2:function(e){var t=this.$('input[name="userType"]').val(),a="mine"===t||"unseen"===t,s=this.$id("user").select2("enable",!a);(a||e&&!s.val())&&s.select2("data",{id:i.data._id,text:i.getLabel()})},setUpActivityKindSelect2:function(){this.$id("activityKind").select2({width:"250px",multiple:!0,placeholder:" ",data:o.activityKinds.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,i)=>i(e.getLabel())})},destroy:function(){a.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},filterHasValue:function(e){if("date"===e){var t=this.$id("from-date"),i=this.$id("to-date");return t.val().length>0||i.val().length>0}return a.prototype.filterHasValue.apply(this,arguments)},showFilter:function(e){if("creator"===e||"implementers"===e||"participants"===e||"coordinators"===e)return this.$id("userType").val(e).trigger("change"),void this.$id("user").select2("focus");const t=this.$('.dateTimeRange-label-input[value="'+e+'"]');t.length&&(t.prop("checked",!0),s.toggleLabel(this)),a.prototype.showFilter.apply(this,arguments)}})});