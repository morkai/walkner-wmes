// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","Sortable","app/core/View","app/core/util/idAndLabel","app/data/orgUnits","../util/scrollIntoView","app/hourlyPlans/templates/dailyMrpPlans/lines","app/hourlyPlans/templates/dailyMrpPlans/linePopover"],function(e,t,i,s,o,n,l,r,a){"use strict";return s.extend({template:r,events:{"click #-edit":"showEditor","keydown .select2-input":function(e){13===e.keyCode&&this.hideEditor()},"click .dailyMrpPlan-list-item":function(e){this.toggleSelection(e.currentTarget.dataset.id)},"mouseenter .dailyMrpPlan-list-item":function(e){var t=this,i=e.currentTarget.dataset.id;this.mouseovered=i,i!==t.selected&&t.showPopover(t.$(e.currentTarget))},"mouseleave .dailyMrpPlan-list-item":function(e){var t=e.currentTarget.dataset.id;this.mouseovered=null,t!==this.selected&&this.$(e.currentTarget).popover("destroy")}},initialize:function(){this.sortable=null,this.sorting=!1,this.selected=null,this.mouseovered=null,this.ignoreScroll=!1,this.onResize=e.debounce(this.resize.bind(this),16),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"change",this.onChanged),this.listenTo(this.model,"saveChangesRequested",this.onSaveChangesRequested),this.listenTo(this.model.plan.collection,"itemSelected",this.onItemSelected),t(window).on("resize."+this.idPrefix,this.onResize)},destroy:function(){t(window).off("."+this.idPrefix),this.$item().popover("destroy"),this.hideEditor()},serialize:function(){return{idPrefix:this.idPrefix,lines:this.model.invoke("serializeListItem")}},afterRender:function(){var e=this;if(e.selected){var t=this.$item(e.selected);e.selected=null,t.length&&(e.ignoreScroll=!0,l(t[0]),t.click())}this.$id("list").on("scroll",function(t){e.ignoreScroll?e.ignoreScroll=!1:e.unselect(),e.$id("scrollIndicator").toggleClass("hidden",t.target.scrollLeft<=40)}),e.resize()},resize:function(){var e=this.$id("edit"),t=this.$id("scrollIndicator"),i=e.position();t.css({top:i.top+1+"px",left:e.outerWidth()+i.left+"px"})},showEditor:function(){var e=this,s=e.$id("edit").addClass("hidden"),l=e.hideEditor.bind(e),r=null;e.unselect(),e.$item().remove();var a=t('<input type="text">').attr("id",this.idPrefix+"-editor").val(this.model.pluck("_id").join(",")).on("select2-focus",function(){clearTimeout(r)}).on("select2-blur",function(){r=setTimeout(l,200)}).insertAfter(s).select2({width:"off",allowClear:!0,multiple:!0,openOnEnter:!1,placeholder:" ",data:n.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")&&"assembly"===e.getSubdivision().get("type")}).map(o)}).select2("focus"),d=a.select2("container").find(".select2-choices")[0];this.sortable=new i(d,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){e.sorting=!0,a.select2("onSortStart")},onEnd:function(){e.sorting=!1,a.select2("onSortEnd").select2("focus")}})},hideEditor:function(){if(this.sorting)return!1;var e=this.$id("editor");if(e.length){var t=this.$id("edit"),i=e.val().split(",").filter(function(e){return e.length>0});e.select2("destroy").remove(),t.removeClass("hidden"),this.destroySortable(),this.model.update(i)||this.render()}},toggleSelection:function(e){e===this.selected?this.unselect():this.select(e)},select:function(e){var t=this.model.get(e);if(t){e!==this.selected&&this.unselect();var i=this.$item(e).addClass("is-selected"),s=this.updatePopover(e,!0);s||this.showPopover(i,!0),this.selected=e,this.model.plan.collection.trigger("itemSelected",{type:"line",plan:this.model.plan,item:t})}},unselect:function(){if(this.selected){var e=this.$(".is-selected").removeClass("is-selected");this.saveChanges(e),this.selected===this.mouseovered?this.updatePopover(e.attr("data-id"),!1):e.popover("destroy"),this.selected=null}},destroySortable:function(){this.sortable&&(this.sortable.destroy(),this.sortable=null)},onSaveChangesRequested:function(){this.selected&&this.saveChanges(this.$item(this.selected))},onItemSelected:function(e){e.plan===this.model.plan&&"line"===e.type||this.unselect()},onChanged:function(e){this.updateWorkerCount(e),this.updateCustomTimes(e),this.updatePopover(e.id,e.id===this.selected)},$item:function(e){return e?this.$('.dailyMrpPlan-list-item[data-id="'+e+'"]'):this.$(".dailyMrpPlan-list-item")},showPopover:function(e,t){e.popover({container:this.el,trigger:"manual",placement:"top",html:!0,content:this.getPopoverContent.bind(this,e.attr("data-id"),t),template:'<div class="popover dailyMrpPlan-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")},updatePopover:function(e,t){var i=this.$item(e).data("bs.popover");return i?(i.tip().find(".popover-content").html(this.getPopoverContent(e,t)),i):null},getPopoverContent:function(e,t){var i=this.model.get(e);return a({editable:this.model.plan.isEditable()&&!!t,line:i.serializePopover()})},saveChanges:function(e){var t=e.data("bs.popover");if(t&&this.model.plan.isEditable()){var i=t.tip();this.model.get(e[0].dataset.id).update({activeFrom:i.find('[name="activeFrom"]').val(),activeTo:i.find('[name="activeTo"]').val(),workerCount:Math.max(0,parseInt(i.find('[name="workerCount"]').val(),10))})}},updateWorkerCount:function(e){var t=e.get("workerCount");this.$item(e.id).find('.dailyMrpPlan-list-property[data-property="workerCount"]').toggleClass("is-invalid",!t).find("span").text(t)},updateCustomTimes:function(e){var t=e.serializeCustomTimes();this.$item(e.id).find('.dailyMrpPlan-list-property[data-property="customTimes"]').toggleClass("hidden",!e.hasCustomTimes()).find("span").text(t)}})});