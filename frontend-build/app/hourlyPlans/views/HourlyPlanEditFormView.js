// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/onModelDeleted","app/hourlyPlans/templates/entry"],function(t,e,n,o,a,r,l){"use strict";return a.extend({template:l,events:{"blur .hourlyPlan-count":function(t){this.updateCount(t,1)},"keyup .hourlyPlan-count":function(t){this.updateCount(t,1e3)},"change .hourlyPlan-noPlan":"updatePlan","mouseenter .hourlyPlan-flow":function(t){this.hovered=t.currentTarget},"mouseleave .hourlyPlan-flow":function(){this.hovered=null},"click .hourlyPlan-noPlan-container":function(t){t.target.classList.contains("hourlyPlan-noPlan-container")&&this.$(t.target).find(".hourlyPlan-noPlan").click()},"focus .hourlyPlan-count, .hourlyPlan-noPlan":function(t){this.focused=[t.target.parentNode,t.target.parentNode.parentNode.children[0],this.el.querySelector(".hourlyPlan-column-"+t.target.parentNode.dataset.column)],this.$(this.focused).addClass("is-focused")},"blur .hourlyPlan-count, .hourlyPlan-noPlan":function(){this.$(this.focused).removeClass("is-focused")},"paste .hourlyPlan-count":"pasteCounts"},remoteTopics:function(){var t={};return t["hourlyPlans.updated."+this.model.id]="onRemoteEdit",t["hourlyPlans.deleted"]="onModelDeleted",t},initialize:function(){this.hovered=null,this.focused=[],e("body").on("paste."+this.idPrefix,this.onBodyPaste.bind(this))},destroy:function(){e("body").off("."+this.idPrefix),this.focused=null},afterRender:function(){this.listenToOnce(this.model,"change",this.render),this.focusFirstEnabledInput()},serialize:function(){return t.assign(this.model.serialize(),{editable:!0})},focusNextInput:function(t){var e=t.closest("td").next("td");if(e.length)return e.find("input").select();var n=t.closest("tr").next();if(!n.length)return this.focusFirstEnabledInput();this.focusNextEnabledInput(n)},focusFirstEnabledInput:function(){var t=this.el.querySelector(".hourlyPlan-noPlan:not(:checked)");t&&this.$(t).closest("tr").find(".hourlyPlan-count").first().select()},focusNextEnabledInput:function(t){return t.length?t.find(".hourlyPlan-noPlan:checked").length?this.focusNextEnabledInput(t.next()):void t.find(".hourlyPlan-count").first().select():this.focusFirstEnabledInput()},toggleCountsInRow:function(t,e){var n=this.$(this.el.ownerDocument.activeElement).closest("tr"),o=this.$(".hourlyPlan > tbody > :last-child"),a=t.closest("tr"),r=a.find(".hourlyPlan-count").attr("disabled",t[0].checked);return t[0].checked?(r.val("0").attr("data-value","0").removeClass("hourlyPlan-nonZero"),e?a[0]===n[0]?a[0]===o[0]?this.focusFirstEnabledInput():this.focusNextEnabledInput(a):void 0:a[0]===o[0]?this.focusFirstEnabledInput():this.focusNextEnabledInput(a)):void(e||a.find(".hourlyPlan-count").first().select())},updatePlan:function(t){var e=this,n={type:"plan",socketId:e.socket.getId(),_id:e.model.id,flowIndex:parseInt(t.target.getAttribute("data-flow"),10),newValue:t.target.checked},o=e.$(t.target);e.toggleCountsInRow(o),e.socket.emit("hourlyPlans.updatePlan",n,function(n){n&&(t.target.checked=!t.target.checked,e.toggleCountsInRow(o),e.trigger("remoteError",n))})},pasteCounts:function(t,e){var n=t.originalEvent.clipboardData.getData("text/plain")||"",a=(" "+n+" ").match(/-?([0-9]+)[^0-9]/g)||[],r=a.map(function(t){return Math.max(parseInt(t,10)||0,0)});if(!(r.length<3)){var l=this,s=l.$(e||t.currentTarget),u={type:"counts",socketId:l.socket.getId(),_id:l.model.id,newValues:r,flowIndex:parseInt(s.attr("data-flow"),10)};return"hour"===s[0].name&&(u.hourIndex=parseInt(s.attr("data-hour"),10)),o.msg.saving(),l.socket.emit("hourlyPlans.updateCounts",u,function(t){t&&(o.msg.savingFailed(),l.trigger("remoteError",t))}),!1}},updateCount:function(t,e){var n=t.target;if(13===t.which)return this.focusNextInput(this.$(n));var o=parseInt(n.getAttribute("data-value"),10)||0,a=parseInt(n.value,10)||0,r=n.getAttribute("data-flow")+":"+n.getAttribute("data-hour")+":"+n.getAttribute("name");(o!==a||this.timers[r])&&(n.setAttribute("data-value",a),n.setAttribute("data-remote","false"),n.classList.toggle("hourlyPlan-nonZero",a>0),this.timers[r]&&clearTimeout(this.timers[r]),this.timers[r]=setTimeout(this.doUpdateCount.bind(this),e,n,r,o,a))},doUpdateCount:function(t,e,n,o){delete this.timers[e];var a=t.getAttribute("data-remote"),r={type:"count",socketId:this.socket.getId(),_id:this.model.id,newValue:o,flowIndex:parseInt(t.getAttribute("data-flow"),10)};"hour"===t.name&&(r.hourIndex=parseInt(t.getAttribute("data-hour"),10));var l=this;this.socket.emit("hourlyPlans.updateCount",r,function(e){e&&("true"!==t.getAttribute("data-remote")&&(t.value=n,t.setAttribute("data-value",n),t.setAttribute("data-remote",a),t.classList.toggle("hourlyPlan-nonZero",n>0)),l.trigger("remoteError",e))})},onRemoteEdit:function(t){switch(t.type){case"plan":return this.handlePlanChange(t);case"count":return this.handleCountChange(t);case"counts":return this.handleCountsChange(t)}},handlePlanChange:function(t){if(t.socketId!==this.socket.getId()){var e='.hourlyPlan-noPlan[data-flow="'+t.flowIndex+'"]',n=this.$(e);n.length&&(n.prop("checked",t.newValue),this.toggleCountsInRow(n,!0))}},handleCountChange:function(t){if(t.socketId!==this.socket.getId()){var e=".hourlyPlan-count[data-flow="+t.flowIndex+"]";"number"==typeof t.hourIndex?e+="[data-hour="+t.hourIndex+"]":e+="[name=level]";var n=this.$(e);n.length&&(n.val(t.newValue),n.attr({"data-value":t.newValue,"data-remote":"true"}),n.toggleClass("hourlyPlan-nonZero",t.newValue>0))}},handleCountsChange:function(t){var e=".hourlyPlan-count[data-flow="+t.flowIndex+"]",n=this.$(e);n.length&&(t.newValues.forEach(function(t,e){n[e+1].value=t,n[e+1].classList.toggle("hourlyPlan-nonZero",t>0)}),t.socketId===this.socket.getId()&&o.msg.saved())},onBodyPaste:function(t){if(this.hovered)return this.pasteCounts(t,this.hovered)},onModelDeleted:function(t){r(this.broker,this.model,t)}})});