// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/core/View","../util/scrollIntoView","./DailyMrpPlanLinesView","./DailyMrpPlanOrdersView","./DailyMrpPlanLineOrdersView","app/hourlyPlans/templates/dailyMrpPlans/plan"],function(e,i,t,s,r,n,l){"use strict";return i.extend({template:l,events:{"mouseleave #-lineOrders":function(){this.$crosshair.addClass("hidden")},"mouseenter #-lineOrders":function(){this.$crosshair.removeClass("hidden")},"mousemove .dailyMrpPlan-lineOrders-list":function(e){this.$crosshair[0].style.height=this.$lineOrders.outerHeight()+6+"px",this.$crosshair[0].style.top=this.$lineOrders.position().top+"px",this.$crosshair[0].style.left=e.pageX+"px"}},initialize:function(){this.debounceGeneratePlan=e.debounce(this.model.generate.bind(this.model),1,!1),this.onLineOrdersReset=e.debounce(this.toggleTimeline.bind(this),1,!1);var i=this.model,t=i.lines,n=i.orders;this.listenTo(i,"reset",this.render),this.listenTo(i,"itemEntered",this.onItemEntered),this.listenTo(i,"itemLeft",this.onItemLeft),this.listenTo(n,"reset",this.generatePlan),this.listenTo(n,"change:operation",this.generatePlan),this.listenTo(t,"reset",this.renderLineOrders),this.listenTo(t,"reset",this.generatePlan),this.listenTo(t,"change:activeFrom change:activeTo change:workerCount",this.generatePlan),this.listenTo(t,"lineOrderClicked",this.onLineOrderClicked),this.linesView=new s({model:this.model.lines},{plan:this}),this.ordersView=new r({model:this.model.orders},{plan:this}),this.setView("#"+this.idPrefix+"-lines",this.linesView),this.setView("#"+this.idPrefix+"-orders",this.ordersView)},generatePlan:function(e,i){i&&i.skipGenerate||this.model.generate()},serialize:function(){return{idPrefix:this.idPrefix,mrp:{_id:this.model.mrp.id,name:this.model.mrp.get("description")}}},afterRender:function(){this.renderLineOrders(),this.$lineOrders=this.$id("lineOrders"),this.$crosshair=this.$id("crosshair"),this.model.lines.length&&this.model.orders.length&&!this.el.querySelector(".is-lineOrder")&&this.model.generate()},renderLineOrders:function(){var e=this,i="#"+e.idPrefix+"-lineOrders";e.removeView(i),e.model.lines.forEach(function(t){var s=new n({model:t});e.listenTo(t.orders,"reset",e.onLineOrdersReset),e.insertView(i,s),s.render()}),this.toggleTimeline()},toggleTimeline:function(){this.$id("timeline").toggleClass("hidden",!this.el.querySelector(".is-lineOrder"))},onLineOrderClicked:function(e){var i=e.lineOrder.get("orderNo");this.ordersView.selected===i?this.ordersView.unselect():this.ordersView.select(i,!0)},onItemEntered:function(e){var i=this.findItemEl(e);i.length&&(i.addClass("is-highlighted"),t(i[0]))},onItemLeft:function(e){this.findItemEl(e).removeClass("is-highlighted")},findItemEl:function(e){return"order"===e.type?this.$('.is-lineOrder[data-id^="'+e.item.id+'"]'):"lineOrder"===e.type?this.$('.is-order[data-id="'+e.item.get("orderNo")+'"]'):this.$("#NULL")}})});