// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/user","app/core/views/ListView","app/hourlyPlans/templates/dailyMrpPlans/list"],function(e,r,t,a,n,s){"use strict";return n.extend({template:s,remoteTopics:{"dailyMrpPlans.imported":"refreshCollection"},serialize:function(){var e=n.prototype.serialize.apply(this,arguments),r=e.rows[0].moment.clone().subtract(1,"days"),t=r.clone().subtract(6,"days");return e.prevLink="#dailyMrpPlans;list?select(date,mrp,orders._id,lines._id,lines.workerCount)&date>="+t.valueOf()+"&date<="+r.valueOf(),t=e.rows[6].moment.clone().add(1,"days"),r=t.clone().add(6,"days"),e.nextLink="#dailyMrpPlans;list?select(date,mrp,orders._id,lines._id,lines.workerCount)&date>="+t.valueOf()+"&date<="+r.valueOf(),e},serializeColumns:function(){return[{id:"date",className:"is-min",label:t("hourlyPlans","property:date")}]},serializeRows:function(){for(var t=e.find(this.collection.rqlQuery.selector.args,function(e){return"ge"===e.name&&"date"===e.args[0]}).args[1],a=[],n={},s=0;s<7;++s){var i=r.getMoment(t).add(s,"days"),l={moment:i,date:i.format("YYYY-MM-DD"),mrps:[]};n[l.moment.valueOf()]=l,a.push(l)}return this.collection.forEach(function(e){var r=n[e.date.getTime()];r&&r.mrps.push({_id:e.mrp.id,lines:e.get("lines"),orderCount:(e.get("orders")||[]).length})}),a.forEach(function(e){e.mrps.sort(function(e,r){return e._id.localeCompare(r._id)})}),a}})});