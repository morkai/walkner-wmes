// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","js2form","app/time","app/data/orgUnits","app/core/util/ExpandableSelect","app/core/util/idAndLabel","app/core/views/FilterView","app/hourlyPlans/templates/dailyMrpPlans/filter"],function(e,t,s,i,a,n,r,l){"use strict";return r.extend({template:l,events:e.assign({"change #-date":function(){this.needsReset=!0,this.scheduleReset(333)},"focus #-date":function(){this.needsReset=!1,clearTimeout(this.timers.reset)},"blur #-date":function(){this.needsReset&&this.reset()},"change #-mrp":function(){this.needsReset=!0,this.scheduleReset(333)},"focus #-mrp":function(){this.needsReset=!1,clearTimeout(this.timers.reset)},"blur #-mrp":function(){this.needsReset&&this.reset()},"click #-wrap":function(){this.model.options.set("wrap",!this.model.options.get("wrap"))},"click #-generatePlans":function(){this.model.invoke("generate")},"click #-savePlans":function(){var e=this.$id("savePlans").prop("disabled",!0),t=e.find(".fa").removeClass("fa-save").addClass("fa-spinner fa-spin");this.model.saveLines().always(function(){t.removeClass("fa-spinner fa-spin").addClass("fa-save"),e.prop("disabled",!1)})},"click #-setHourlyPlans":function(){var e=this.$id("setHourlyPlans").prop("disabled",!0),t=e.find(".fa").removeClass("fa-calendar").addClass("fa-spinner fa-spin");this.model.setHourlyPlans().always(function(){t.removeClass("fa-spinner fa-spin").addClass("fa-calendar"),e.prop("disabled",!1)})}},r.prototype.events),defaultFormData:{date:"",mrp:[]},termToForm:{date:function(e,t,i){i[e]=s.getMoment(t.args[1]).format("YYYY-MM-DD")},mrp:function(e,t,s){s[e]="in"===t.name?t.args[1]:[t.args[1]]}},initialize:function(){r.prototype.initialize.apply(this,arguments),this.listenTo(this.model.options,"change:wrap",this.toggleWrapButton)},destroy:function(){r.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},serialize:function(){var t={};return i.getAllByType("mrpController").forEach(function(e){"assembly"===e.getSubdivision().get("type")&&(t[e.id.replace(/~.+$/,"")]=1)}),e.assign(r.prototype.serialize.call(this),{mrpControllers:Object.keys(t).map(function(e){return{id:e,text:e}})})},afterRender:function(){r.prototype.afterRender.call(this),this.$(".is-expandable").expandableSelect(),this.toggleWrapButton()},scheduleReset:function(e){var t=this;clearTimeout(t.timers.reset),t.timers.reset=setTimeout(function(){t.timers.reset=null,t.needsReset=!1,t.reset()},e)},reset:function(){clearTimeout(this.timers.reset),this.timers.reset=null;var t=this.$id("date").val(),s=this.$id("mrp").val(),i=this.model.rqlQuery.selector.args=[];return e.isEmpty(t)||i.push({name:"eq",args:["date",t]}),e.isEmpty(s)||i.push({name:"in",args:["mrp",s]}),2!==i.length?void this.model.reset([]):void this.model.fetch({reset:!0})},toggleWrapButton:function(){var e=!!this.model.options.get("wrap");this.$id("wrap").toggleClass("active",!e).attr("title",e?"Włącz przewijanie list":"Wyłącz przewijanie list")}})});