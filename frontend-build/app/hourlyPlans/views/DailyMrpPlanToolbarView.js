// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/viewport","app/core/View","../util/shift","app/hourlyPlans/templates/dailyMrpPlans/toolbar","app/hourlyPlans/templates/dailyMrpPlans/printPage","app/hourlyPlans/templates/dailyMrpPlans/_printLineList"],function(e,i,t,n,s,a,o,r,l){"use strict";return s.extend({template:o,events:{"click #-generatePlan":function(){this.model.generate()},"click #-savePlan":function(){var e=this.$id("savePlan").prop("disabled",!0),i=e.find(".fa").removeClass("fa-save").addClass("fa-spinner fa-spin");this.model.saveLines().always(function(){i.removeClass("fa-spinner fa-spin").addClass("fa-save"),e.prop("disabled",!1)})},"click #-setHourlyPlan":function(){var e=this,i=e.$id("setHourlyPlan").prop("disabled",!0),t=i.find(".fa").removeClass("fa-calendar").addClass("fa-spinner fa-spin");this.model.collection.setHourlyPlans(function(i){return i===e.model}).always(function(){t.removeClass("fa-spinner fa-spin").addClass("fa-calendar"),i.prop("disabled",!1)})},"click a[data-print-line]":function(e){this.printLine(e.currentTarget.dataset.printLine)},"click #-showTimes":function(){return this.model.collection.options.set("printOrderTimes",!this.model.collection.options.get("printOrderTimes")),this.toggleShowTimes(),!1},"show.bs.dropdown #-printDropdown":"toggleShowTimes"},initialize:function(){this.listenTo(this.model.lines,"reset",this.onLinesReset)},serialize:function(){return{idPrefix:this.idPrefix,lines:this.model.lines.pluck("_id")}},onLinesReset:function(){this.$id("printPlan").prop("disabled",!this.model.lines.length),this.$id("printList").html(l({idPrefix:this.idPrefix,lines:this.model.lines.pluck("_id")}))},printLine:function(e){var t=this.model,s=t.lines.get(e);if(s){var o=window.open(null,"PLANNING:PLAN_PRINT");if(!o)return n.msg.show({type:"error",time:5e3,text:i("hourlyPlans","planning:toolbar:popups")});var l=-1;o.document.body.innerHTML=r({mrp:t.mrp.id,line:s.id,date:t.date,hourlyPlan:s.get("hourlyPlan"),showTimes:t.collection.options.get("printOrderTimes"),orders:s.orders.map(function(e,i){var n=t.orders.get(e.get("orderNo")),s=a.getShiftNo(e.get("startAt")),o=-1!==l&&s!==l;return l=s,{no:i+1,orderNo:n.id,nc12:n.get("nc12"),name:n.get("name"),qtyTodo:n.get("qtyTodo"),qtyPlan:e.get("qty"),startAt:e.get("startAt"),finishAt:e.get("finishAt"),nextShift:o}})}),o.print()}},toggleShowTimes:function(){this.$id("showTimes").blur().find(".fa").removeClass("fa-check fa-times").addClass(this.model.collection.options.get("printOrderTimes")?"fa-check":"fa-times")}})});