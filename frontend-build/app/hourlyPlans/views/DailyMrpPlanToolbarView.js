// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/viewport","app/core/View","../util/shift","app/hourlyPlans/templates/dailyMrpPlans/toolbar","app/hourlyPlans/templates/dailyMrpPlans/printPage","app/hourlyPlans/templates/dailyMrpPlans/_printLineList"],function(e,n,i,t,a,s,l,r,o){"use strict";return a.extend({template:l,events:{"click #-generatePlan":function(){this.model.generate()},"click #-savePlan":function(){var e=this.$id("savePlan").prop("disabled",!0),n=e.find(".fa").removeClass("fa-save").addClass("fa-spinner fa-spin");this.model.saveLines().always(function(){n.removeClass("fa-spinner fa-spin").addClass("fa-save"),e.prop("disabled",!1)})},"click #-setHourlyPlan":function(){var e=this,n=e.$id("setHourlyPlan").prop("disabled",!0),i=n.find(".fa").removeClass("fa-calendar").addClass("fa-spinner fa-spin");this.model.collection.setHourlyPlans(function(n){return n===e.model}).always(function(){i.removeClass("fa-spinner fa-spin").addClass("fa-calendar"),n.prop("disabled",!1)})},"click a[data-print-line]":function(e){this.printLine(e.currentTarget.dataset.printLine)}},initialize:function(){this.listenTo(this.model.lines,"reset",this.onLinesReset)},serialize:function(){return{idPrefix:this.idPrefix,lines:this.model.lines.pluck("_id")}},onLinesReset:function(){this.$id("printPlan").prop("disabled",!this.model.lines.length),this.$id("printList").html(o({lines:this.model.lines.pluck("_id")}))},printLine:function(e){var i=this.model,a=i.lines.get(e);if(a){var l=window.open(null,"PLANNING:PLAN_PRINT");if(!l)return t.msg.show({type:"error",time:5e3,text:n("hourlyPlans","planning:toolbar:popups")});var o=-1;l.document.body.innerHTML=r({mrp:i.mrp.id,line:a.id,date:i.date,hourlyPlan:a.get("hourlyPlan"),orders:a.orders.map(function(e,n){var t=i.orders.get(e.get("orderNo")),a=s.getShiftNo(e.get("startAt")),l=-1!==o&&a!==o;return o=a,{no:n+1,orderNo:t.id,nc12:t.get("nc12"),name:t.get("name"),qtyTodo:t.get("qtyTodo"),qtyPlan:e.get("qty"),startAt:e.get("startAt"),finishAt:e.get("finishAt"),nextShift:l}})}),l.print()}}})});