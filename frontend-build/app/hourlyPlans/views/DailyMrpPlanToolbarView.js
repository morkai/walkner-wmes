// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/viewport","app/core/View","../util/shift","app/hourlyPlans/templates/dailyMrpPlans/toolbar","app/hourlyPlans/templates/dailyMrpPlans/printPage","app/hourlyPlans/templates/dailyMrpPlans/_printLineList"],function(e,i,t,n,s,a,r,l,o){"use strict";return s.extend({template:r,events:{"click #-generatePlan":function(){this.model.generate()},"click #-savePlan":function(){var e=this.$id("savePlan").prop("disabled",!0),i=e.find(".fa").removeClass("fa-save").addClass("fa-spinner fa-spin");this.model.saveLines().always(function(){i.removeClass("fa-spinner fa-spin").addClass("fa-save"),e.prop("disabled",!1)})},"click #-setHourlyPlan":function(){var e=this,i=e.$id("setHourlyPlan").prop("disabled",!0),t=i.find(".fa").removeClass("fa-calendar").addClass("fa-spinner fa-spin");this.model.collection.setHourlyPlans(function(i){return i===e.model}).always(function(){t.removeClass("fa-spinner fa-spin").addClass("fa-calendar"),i.prop("disabled",!1)})},"click a[data-print-line]":function(e){this.printLines(e.currentTarget.dataset.printLine)},"click #-showTimes":function(){return this.model.collection.options.set("printOrderTimes",!this.model.collection.options.get("printOrderTimes")),this.toggleShowTimes(),!1},"show.bs.dropdown #-printDropdown":"toggleShowTimes"},initialize:function(){this.listenTo(this.model.lines,"reset",this.onLinesReset)},serialize:function(){return{idPrefix:this.idPrefix,lines:this.model.lines.pluck("_id")}},onLinesReset:function(){this.$id("printPlan").prop("disabled",!this.model.lines.length),this.$id("printList").html(o({idPrefix:this.idPrefix,lines:this.model.lines.pluck("_id")}))},printLines:function(t){var s=this.model,r=[];if(e.isString(t))if("__ALL__"===t)r=s.lines.models;else{var o=s.lines.get(t);o&&r.push(o)}else e.forEach(t,function(e){var i=s.lines.get(e);i&&r.push(i)});if(r.length){var d=window.open(null,"PLANNING:PLAN_PRINT");if(!d)return n.msg.show({type:"error",time:5e3,text:i("hourlyPlans","planning:toolbar:popups")});var p=-1;d.document.body.innerHTML=l({mrp:s.mrp.id,date:s.date,lines:e.pluck(r,"id").join(", "),showTimes:s.collection.options.get("printOrderTimes"),pages:r.map(function(e){return{line:e.id,hourlyPlan:e.get("hourlyPlan"),orders:e.orders.map(function(e,i){var t=s.orders.get(e.get("orderNo")),n=a.getShiftNo(e.get("startAt")),r=-1!==p&&n!==p;return p=n,{no:i+1,orderNo:t.id,nc12:t.get("nc12"),name:t.get("name"),qtyTodo:t.get("qtyTodo"),qtyPlan:e.get("qty"),startAt:e.get("startAt"),finishAt:e.get("finishAt"),nextShift:r}})}})}),d.print()}},toggleShowTimes:function(){this.$id("showTimes").blur().find(".fa").removeClass("fa-check fa-times").addClass(this.model.collection.options.get("printOrderTimes")?"fa-check":"fa-times")}})});