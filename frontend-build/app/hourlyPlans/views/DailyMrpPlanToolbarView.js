// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/viewport","app/core/View","../util/shift","app/hourlyPlans/templates/dailyMrpPlans/toolbar","app/hourlyPlans/templates/dailyMrpPlans/printPage","app/hourlyPlans/templates/dailyMrpPlans/_printLineList"],function(e,i,t,n,s,r,l,a,o){"use strict";return s.extend({template:l,events:{"click #-generatePlan":function(){this.model.generate()},"click #-savePlan":function(){var e=this.$id("savePlan").prop("disabled",!0),i=e.find(".fa").removeClass("fa-save").addClass("fa-spinner fa-spin");this.model.saveLines().always(function(){i.removeClass("fa-spinner fa-spin").addClass("fa-save"),e.prop("disabled",!1)})},"click #-setHourlyPlan":function(){var e=this,i=e.$id("setHourlyPlan").prop("disabled",!0),t=i.find(".fa").removeClass("fa-calendar").addClass("fa-spinner fa-spin");this.model.collection.setHourlyPlans(function(i){return i===e.model}).always(function(){t.removeClass("fa-spinner fa-spin").addClass("fa-calendar"),i.prop("disabled",!1)})},"click a[data-print-line]":function(e){this.printLines(e.currentTarget.dataset.printLine)},"click #-showTimes":function(){return this.model.collection.options.set("printOrderTimes",!this.model.collection.options.get("printOrderTimes")),this.toggleShowTimes(),!1},"show.bs.dropdown #-printDropdown":"toggleShowTimes"},initialize:function(){this.listenTo(this.model.lines,"reset",this.onLinesReset)},serialize:function(){return{idPrefix:this.idPrefix,lines:this.model.lines.pluck("_id"),editable:this.model.isEditable()}},onLinesReset:function(){this.$id("printPlan").prop("disabled",!this.model.lines.length),this.$id("printList").html(o({idPrefix:this.idPrefix,lines:this.model.lines.pluck("_id")}))},printLines:function(t){var s=this.model,r=[];if(e.isString(t))if("__ALL__"===t)r=s.lines.models;else{var l=s.lines.get(t);l&&r.push(l)}else e.forEach(t,function(e){var i=s.lines.get(e);i&&r.push(i)});if(r.length){var o=window.open(null,"PLANNING:PLAN_PRINT");if(!o)return n.msg.show({type:"error",time:5e3,text:i("hourlyPlans","planning:toolbar:popups")});o.document.body.innerHTML=a({mrp:s.mrp.id,date:s.date,lines:e.pluck(r,"id").join(", "),showTimes:s.collection.options.get("printOrderTimes"),pages:this.serializePrintPages(r)}),o.print()}},serializePrintPages:function(e){var i=this.model,t=-1,n=[];return e.forEach(function(e){var s={pageNo:1,pageCount:1,line:e.id,hourlyPlan:e.get("hourlyPlan"),workerCount:e.get("workerCount"),orders:e.orders.map(function(e,n){var s=i.orders.get(e.get("orderNo")),l=r.getShiftNo(e.get("startAt")),a=t!==-1&&l!==t;return t=l,{no:n+1,orderNo:s.id,nc12:s.get("nc12"),name:s.get("name"),qtyTodo:s.get("qtyTodo"),qtyPlan:e.get("qty"),startAt:e.get("startAt"),finishAt:e.get("finishAt"),nextShift:a}})},l=42,a=35,o=s.orders.length;if(o<=l)return o>a&&(s.hourlyPlan=null),void n.push(s);for(var d=Math.ceil(o/l),p=1;p<=d;++p){var h=s.orders.slice((p-1)*l,p*l);n.push({pageNo:p,pageCount:d,line:s.line,hourlyPlan:p===d&&h.length<=a?s.hourlyPlan:null,orders:h})}}),n},toggleShowTimes:function(){this.$id("showTimes").blur().find(".fa").removeClass("fa-check fa-times").addClass(this.model.collection.options.get("printOrderTimes")?"fa-check":"fa-times")}})});