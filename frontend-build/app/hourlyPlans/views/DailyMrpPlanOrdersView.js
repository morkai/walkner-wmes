// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","Sortable","app/core/View","app/core/util/idAndLabel","app/production/util/orderPickerHelpers","app/orders/util/resolveProductName","../util/scrollIntoView","../DailyMrpPlanOrder","app/hourlyPlans/templates/dailyMrpPlans/orders","app/hourlyPlans/templates/dailyMrpPlans/orderPopover"],function(e,t,i,o,s,n,r,l,a,d,c){"use strict";return o.extend({template:d,events:{"click #-edit":"showEditor","keydown .select2-input":function(e){13===e.keyCode&&this.hideEditor()},"click .dailyMrpPlan-list-item":function(e){var t=e.currentTarget.dataset.id;e.ctrlKey&&window.open("/#orders/"+t),this.toggleSelection(t)},"mouseenter .dailyMrpPlan-list-item":function(e){var t=this,i=e.currentTarget.dataset.id;this.mouseovered=i,this.model.plan.trigger("itemEntered",{type:"order",item:this.model.get(i)}),i!==t.selected&&t.showPopover(t.$(e.currentTarget))},"mouseleave .dailyMrpPlan-list-item":function(e){var t=e.currentTarget.dataset.id;this.mouseovered=null,this.model.plan.trigger("itemLeft",{type:"order",item:this.model.get(t)}),t!==this.selected&&this.$(e.currentTarget).popover("destroy")}},initialize:function(){this.sortable=null,this.sorting=!1,this.selected=null,this.mouseovered=null,this.ignoreScroll=!1,this.selectedOperation=void 0,this.onResize=e.debounce(this.resize.bind(this),16),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"change:qtyPlan",this.onQtyPlanChanged),this.listenTo(this.model,"change:operation",this.onOperationChanged),this.listenTo(this.model,"change:ignored",this.onIgnoredChanged),this.listenTo(this.model,"saveChangesRequested",this.onSaveChangesRequested),this.listenTo(this.model.plan.collection,"itemSelected",this.onItemSelected),t(window).on("resize."+this.idPrefix,this.onResize)},destroy:function(){t(window).off("."+this.idPrefix),this.$item().popover("destroy"),this.hideEditor()},serialize:function(){return{idPrefix:this.idPrefix,orders:this.model.invoke("serializeListItem")}},afterRender:function(){var e=this;if(e.selected){var t=this.$item(e.selected);e.selected=null,t.length&&(e.ignoreScroll=!0,l(t[0]),t.click())}e.$id("list").on("scroll",function(t){e.ignoreScroll?e.ignoreScroll=!1:e.unselect(),e.$id("scrollIndicator").toggleClass("hidden",t.target.scrollLeft<=40)}),e.resize()},resize:function(){var e=this.$id("edit"),t=this.$id("scrollIndicator"),i=e.position();t.css({top:i.top+1+"px",left:e.outerWidth()+i.left+"px"})},showEditor:function(){var o=this,s=o.$id("edit").addClass("hidden"),n=o.hideEditor.bind(o),l=null;o.unselect(),this.$item().remove();var d=t('<input type="text">').attr("id",o.idPrefix+"-editor").val(o.model.pluck("_id").join(",")).on("select2-focus",function(){clearTimeout(l)}).on("select2-blur",function(){l=setTimeout(n,200)}).insertAfter(s).select2({width:"off",allowClear:!0,multiple:!0,openOnEnter:!1,placeholder:" ",minimumInputLength:7,formatSelection:function(t){return e.escape(t.id)},formatResult:function(t){return e.escape(t.id+": "+r(t.planOrder))},ajax:{cache:!0,quietMillis:300,url:function(e){e=e.replace(/[^0-9]+/g,"");var t=9===e.length?e:"regex="+encodeURIComponent("^"+e.replace(/[^0-9]+/g,""));return"/orders?select("+a.ORDER_PROPERTIES.join(",")+")&limit(100)&_id="+t},results:function(t){return{results:e.map(t.collection,function(e){return{id:e._id,text:e._id,planOrder:a.prepareFromSapOrder(e)}})}},transport:function(e){return t.ajax.apply(t,arguments).fail(function(){e.success({collection:[]})})}}}).select2("data",o.model.map(function(e){return{id:e.id,text:e.id,planOrder:e.toJSON()}})).select2("focus"),c=d.select2("container").find(".select2-choices")[0];this.sortable=new i(c,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){o.sorting=!0,d.select2("onSortStart")},onEnd:function(){o.sorting=!1,d.select2("onSortEnd").select2("focus")}})},hideEditor:function(){if(this.sorting)return!1;var t=this.$id("editor");if(t.length){var i=this.$id("edit"),o=e.map(t.select2("data"),function(e){return e.planOrder});t.select2("destroy").remove(),i.removeClass("hidden"),this.destroySortable(),this.model.update(o)||this.render()}},toggleSelection:function(e){e===this.selected?this.unselect():this.select(e)},select:function(t,i){if(!this.$id("editor").length){var o=this.model.get(t);if(o){t!==this.selected&&this.unselect();var s=this.$item(t).addClass("is-selected");if(i)this.ignoreScroll=!0,l(s[0]),e.defer(this.showPopover.bind(this,s,!0));else{var n=this.updatePopover(t,!0);n||this.showPopover(s,!0)}this.selected=t,this.model.plan.collection.trigger("itemSelected",{type:"order",plan:this.model.plan,item:o})}}},unselect:function(){if(this.selected){var e=this.$(".is-selected").removeClass("is-selected");this.saveChanges(e),this.selected===this.mouseovered?this.updatePopover(e.attr("data-id"),!1):e.popover("destroy"),this.selected=null}},destroySortable:function(){this.sortable&&(this.sortable.destroy(),this.sortable=null)},onSaveChangesRequested:function(){this.selected&&this.saveChanges(this.$item(this.selected))},onItemSelected:function(e){e.plan===this.model.plan&&"order"===e.type||this.unselect()},onQtyPlanChanged:function(e){this.updatePopover(e.id,e.id===this.selected),this.$item(e.id).find('[data-property="qtyPlan"]').toggleClass("hidden",!e.get("qtyPlan"))},onIgnoredChanged:function(e){this.updatePopover(e.id,e.id===this.selected),this.$item(e.id).toggleClass("is-ignored",!!e.get("ignored"))},onOperationChanged:function(e){var t=e.id===this.selected;this.updatePopover(e.id,t),t&&this.lastOperations&&this.populateOperations(this.lastOperations,this.selected)},$item:function(e){return e?this.$('.dailyMrpPlan-list-item[data-id="'+e+'"]'):this.$(".dailyMrpPlan-list-item")},showPopover:function(e,t){e.popover({container:this.el,trigger:"manual",placement:"top",html:!0,content:this.getPopoverContent.bind(this,e.attr("data-id"),t),template:'<div class="popover dailyMrpPlan-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")},updatePopover:function(e,t){var i=this.$item(e).data("bs.popover");return i?(i.tip().find(".popover-content").html(this.getPopoverContent(e,t)),i):null},getPopoverContent:function(e,t){var i=this.model.get(e);return c({editable:this.model.plan.isEditable()&&!!t,order:i.serializePopover()})},saveChanges:function(e){var t=e.data("bs.popover");if(t&&this.model.plan.isEditable()){var i=t.tip();this.model.get(e[0].dataset.id).update({qtyPlan:Math.max(0,parseInt(i.find('[name="qtyPlan"]').val(),10)||0),ignored:"1"===i.find('[name="ignored"]:checked').val(),operation:this.selectedOperation}),this.selectedOperation=void 0}},loadOperations:function(){var t=this,i=t.selected,o="/orders/"+i+"?select(operations)";t.selectedOperation=void 0,t.ajax({url:o}).done(function(o){t.selected===i&&o&&e.isArray(o.operations)&&o.operations.length&&t.populateOperations(o.operations,i)})},populateOperations:function(t,i){var o=this,s=o.$item(i).data("bs.popover");if(s){var n=o.model.get(i).get("operation"),r=t.map(function(t){return'<option value="'+t.no+'" data-labor-time="'+t.laborTime+'"'+(n&&t.no===n.no?" selected":"")+">"+e.escape(t.name||t.no)+"</option>"}).join("");s.tip().find('select[name="operation"]').html(r).on("change",function(i){o.selectedOperation=e.find(t,{no:i.target.value})||void 0,o.$(i.target).closest("table").find('[data-property="laborTime"]').text(parseFloat(i.target.selectedOptions[0].dataset.laborTime).toLocaleString())}),o.lastOperations=t}}})});