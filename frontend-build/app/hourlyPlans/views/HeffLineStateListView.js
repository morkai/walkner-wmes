// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/core/View","app/data/orgUnits","../HeffLineState","app/hourlyPlans/templates/heffLineStateList","app/hourlyPlans/templates/heffLineStateItem"],function(e,t,i,n,a){"use strict";return e.extend({template:n,events:{"click .heffLineStates-item-title":function(e){this.$(e.target).closest(".heffLineStates-item").find(".form-control").select()},"keydown .form-control":function(e){13===e.which&&this.updatePlan(e.target.dataset.line,e.target.value)},"blur .form-control":function(e){this.updatePlan(e.target.dataset.line,e.target.value)}},remoteTopics:{"heffLineStates.added":function(e){this.updatePlan(e.model._id,e.model.plan,!1)},"heffLineStates.edited":function(e){this.updatePlan(e.model._id,e.model.plan,!1)},"heffLineStates.deleted":function(e){this.updatePlan(e.model._id,"",!1)}},refreshCollectionNow:function(){this.render()},afterRender:function(){var e=null,i=[];this.collection.rqlQuery.selector.args.forEach(function(t){"eq"===t.name&&"division"===t.args[0]?e=t.args[1]:"in"===t.name&&"prodFlows"===t.args[0]&&(i=t.args[1])}),t.getAllByType("prodLine").forEach(function(n){if(!n.get("deactivatedAt")){var a=t.getAllForProdLine(n);if(!(e&&a.division!==e||i.length&&-1===i.indexOf(a.prodFlow))){if("assembly"===t.getByTypeAndId("subdivision",a.subdivision).get("type")){var o=this.collection.get(n.id);this.renderLine({division:t.getByTypeAndId("division",a.division),prodFlow:t.getByTypeAndId("prodFlow",a.prodFlow),prodLine:n,plan:o?o.get("plan"):""})}}}},this)},renderLine:function(e){this.$id("list").append(a({prodLine:e.prodLine.id,plan:e.plan}))},updatePlan:function(e,t,n){var a=this.collection.get(e);a||(a=new i({_id:e,plan:""}),a.id=null);var o=a.get("plan"),l=t.split(/[^0-9]/).map(function(e){return parseInt(e,10)}).filter(function(e){return e>=0}).splice(0,8).join(" ");this.$('.form-control[data-line="'+e+'"]').val(l),l!==o&&(a.set("plan",l),!1!==n&&this.ajax(a.save()),null===a.id&&(a.id=e,this.collection.add(a)))}})});