// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/viewport","app/core/View","../DailyMrpPlan","../DailyMrpPlanOrder","app/hourlyPlans/templates/dailyMrpPlans/import"],function(e,n,i,t,r,a,o){"use strict";return t.extend({template:o,events:{submit:function(e){e.preventDefault();var i=n.getMoment(this.$id("date").val(),"YYYY-MM-DD").valueOf(),t=this.$('input[name="mrps[]"]:checked').map(function(){return this.value}).get(),r=this.$id("submit").prop("disabled",!0),a=r.find(".fa-spinner").removeClass("hidden");this["import"](i,t,function(e){e&&(a.addClass("hidden"),r.prop("disabled",!1))})}},initialize:function(){this.cancelled=!1},closeDialog:function(){this.cancelled=!0},serialize:function(){return{idPrefix:this.idPrefix,date:this.model.date||"",mrps:e.map(this.model.mrpToOrdersMap,function(e,n){return{_id:n,orderCount:e.length,checked:e.length>0}})}},"import":function(n,i,t){var r=this,a={},o={};e.forEach(i,function(n){a[n]=[],e.forEach(r.model.mrpToOrdersMap[n],function(e){a[n].push(e._id),o[e._id]=e})}),r.importOrders(n,a,o,t)},importOrders:function(n,i,t,r){var o=this,l=o.ajax({url:"/orders?limit(1000)&select("+a.ORDER_PROPERTIES.join(",")+")&_id=in=("+Object.keys(t).join(",")+")"});l.fail(function(){o.cancelled||r("FIND_ORDERS")}),l.done(function(l){if(!o.cancelled){var s={};e.forEach(l.collection,function(e){s[e._id]=a.prepareFromSapOrder(e)}),e.forEach(t,function(e,n){s[n]||(s[n]=a.prepareFromMrpOrder(e))}),o.importMrps(n,i,s,r)}})},importMrps:function(n,i,t,a){var o=this,l={},s=Object.keys(i),c=o.ajax({url:"/dailyMrpPlans?limit(1000)&date="+n+"&mrp=in=("+s.join(",")+")"});c.fail(function(){o.cancelled||a("FIND_PLANS")}),c.done(function(c){if(!o.cancelled){e.forEach(c.collection,function(e){l[e.mrp]=new r(e)});var d=[];e.forEach(s,function(e){l[e]||(d.push(e),l[e]=new r({updatedAt:Date.now(),date:n,mrp:e})),l[e].orders.reset(i[e].map(function(e){return t[e]}))}),o.importLines(n,s,l,d,a)}})},importLines:function(i,t,r,a,o){var l=this;if(!a.length)return l.generatePlans(t,r,o);var s=l.ajax({url:"/dailyMrpPlans?limit(1000)&sort(-date)&select(mrp,lines._id,lines.name,lines.activeFrom,lines.activeTo,lines.workerCount)&date<="+i+"&date>="+n.getMoment(i).subtract(5,"days").valueOf()+"&mrp=in=("+a.join(",")+")"});s.fail(function(){l.cancelled||o("FIND_LINES")}),s.done(function(n){l.cancelled||(e.forEach(n.collection,function(e){var n=r[e.mrp];n.lines.length||n.lines.reset(e.lines)}),l.generatePlans(t,r,o))})},generatePlans:function(e,n,i){function t(){var o=e.shift();if(o){var l=n[o];a.push(l),l.generate(),setTimeout(t,1)}else r.importPlans(a,i)}var r=this,a=[];t()},importPlans:function(e,n){i.msg.saving();var t=this,r=t.promised(t.model.dailyMrpPlans["import"](e));r.fail(function(){t.cancelled||(n("IMPORT_PLANS"),i.msg.savingFailed())}),r.done(function(){i.msg.saved(),t.trigger("imported")})}})});