// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/time","app/viewport","app/user","app/data/divisions","app/orgUnits/views/OrgUnitDropdownsView","app/core/Model","app/core/View","app/core/util/getShiftStartInfo","app/hourlyPlans/templates/addForm"],function(i,e,t,s,n,o,r,a,d,l){"use strict";var u=o.ORG_UNIT;return a.extend({template:l,events:{submit:"submitForm"},initialize:function(){this.readonlyDivision=!1,this.$submit=null,this.oudView=new o({orgUnit:u.DIVISION,divisionFilter:function(i){return"prod"===i.get("type")&&i.isActive()},allowClear:!0,noGrid:!0,required:!0}),this.setView(".orgUnitDropdowns-container",this.oudView)},destroy:function(){null!==this.$submit&&(this.$submit.remove(),this.$submit=null)},serialize:function(){return{idPrefix:this.idPrefix,date:d(this.model.get("date")||new Date).moment.format("YYYY-MM-DD")}},afterRender:function(){var i=this,e=s.getDivision();this.$submit=this.$(".btn-primary").attr("disabled",!0),this.listenToOnce(this.oudView,"afterRender",function(){i.oudView.$id("division").on("change",function(e){i.$submit.attr("disabled",""===e.val||null===e.val)});var t=null,n=null;null!==e&&(n=u.DIVISION,t=new r({division:e.id})),i.oudView.selectValue(t,n),i.readonlyDivision=!s.isAllowedTo("HOURLY_PLANS:ALL")&&e,i.oudView.$id("division").select2("readonly",i.readonlyDivision),i.readonlyDivision?i.$submit.focus():i.oudView.$id("division").select2("focus"),e&&i.model.get("date")&&i.$submit.click()})},submitForm:function(s){if(s.preventDefault(),!this.socket.isConnected())return t.msg.show({type:"error",time:5e3,text:i("hourlyPlans","addForm:msg:offline")});var n=this,o=this.oudView.$id("division"),r=this.$submit.find("i").removeClass("fa-edit").addClass("fa-spinner fa-spin");o.select2("readonly",!0),this.$submit.attr("disabled",!0);var a={division:o.select2("val"),date:e.getMoment(this.$id("date").val(),"YYYY-MM-DD").toDate(),shift:1};this.socket.emit("hourlyPlans.findOrCreate",a,function(e,s){if(s&&n.model.set("_id",s),e)return"AUTH"===e.message&&s?n.trigger("uneditable",n.model):(r.removeClass("fa-spinner fa-spin").addClass("fa-edit"),o.select2("readonly",n.readonlyDivision),n.$submit.attr("disabled",!1).focus(),t.msg.show({type:"error",time:5e3,text:i("hourlyPlans","addForm:msg:failure",{error:e.message})}));n.trigger("editable",n.model)})}})});