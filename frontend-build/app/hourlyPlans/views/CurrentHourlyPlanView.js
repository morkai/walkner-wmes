define(["app/i18n","app/viewport","app/user","app/data/divisions","app/data/views/OrgUnitDropdownsView","app/core/Model","app/core/View","app/hourlyPlans/templates/current","i18n!app/nls/hourlyPlans"],function(i,e,t,s,n,r,o,l){var a=n.ORG_UNIT;return o.extend({template:l,idPrefix:"currentHourlyPlan",events:{"click .btn-primary":"onSubmit"},initialize:function(){this.readonlyDivision=!1,this.$submit=null,this.oudView=new n({orgUnit:a.DIVISION,allowClear:!0,noGrid:!0}),this.setView(".orgUnitDropdowns-container",this.oudView)},destroy:function(){null!==this.$submit&&(this.$submit.remove(),this.$submit=null)},afterRender:function(){var i=this,e=t.getDivision();this.$submit=this.$(".btn-primary").attr("disabled",!0),this.listenToOnce(this.oudView,"afterRender",function(){i.oudView.$id("division").on("change",function(e){i.$submit.attr("disabled",""===e.val||null===e.val)});var s=null,n=null;null!==e&&(n=a.DIVISION,s=new r({division:e.id})),i.oudView.selectValue(s,n),i.readonlyDivision=!(t.isAllowedTo("HOURLY_PLANS:ALL")&&!e),i.oudView.$id("division").select2("readonly",i.readonlyDivision),i.readonlyDivision?i.$submit.focus():i.oudView.$id("division").select2("focus")})},onSubmit:function(){if(!this.socket.isConnected())return e.msg.show({type:"error",time:5e3,text:i("hourlyPlans","msg:offline")});var t=this,s=this.oudView.$id("division"),n=this.$submit.find("i").removeClass("fa-edit").addClass("fa-spinner fa-spin");s.select2("readonly",!0),this.$submit.attr("disabled",!0),this.socket.emit("hourlyPlans.getCurrentEntryId",s.select2("val"),function(r,o){return r?"LOCKED"===r.message?t.broker.publish("router.navigate",{url:"#hourlyPlans/"+o,trigger:!0}):(n.removeClass("fa-spinner fa-spin").addClass("fa-edit"),s.select2("readonly",t.readonlyDivision),t.$submit.attr("disabled",!1).focus(),console.error(r),e.msg.show({type:"error",time:5e3,text:i("hourlyPlans","msg:failure")})):(t.broker.publish("router.navigate",{url:"#hourlyPlans/"+o+";edit",trigger:!0}),void 0)})}})});