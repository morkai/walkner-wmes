define(["app/i18n","app/viewport","app/user","app/data/divisions","app/data/views/OrgUnitDropdownsView","app/core/Model","app/core/View","app/hourlyPlans/templates/current"],function(i,e,t,n,s,r,o,a){var l=s.ORG_UNIT;return o.extend({template:a,idPrefix:"currentHourlyPlan",events:{"click .btn-primary":"onSubmit"},initialize:function(){this.readonlyDivision=!1,this.$submit=null,this.oudView=new s({orgUnit:l.DIVISION,divisionFilter:function(i){return"prod"===i.get("type")},allowClear:!0,noGrid:!0}),this.setView(".orgUnitDropdowns-container",this.oudView)},destroy:function(){null!==this.$submit&&(this.$submit.remove(),this.$submit=null)},afterRender:function(){var i=this,e=t.getDivision();this.$submit=this.$(".btn-primary").attr("disabled",!0),this.listenToOnce(this.oudView,"afterRender",function(){i.oudView.$id("division").on("change",function(e){i.$submit.attr("disabled",""===e.val||null===e.val)});var n=null,s=null;null!==e&&(s=l.DIVISION,n=new r({division:e.id})),i.oudView.selectValue(n,s),i.readonlyDivision=!(t.isAllowedTo("HOURLY_PLANS:ALL")&&!e),i.oudView.$id("division").select2("readonly",i.readonlyDivision),i.readonlyDivision?i.$submit.focus():i.oudView.$id("division").select2("focus")})},onSubmit:function(){if(!this.socket.isConnected())return e.msg.show({type:"error",time:5e3,text:i("hourlyPlans","msg:offline")});var t=this,n=this.oudView.$id("division"),s=this.$submit.find("i").removeClass("fa-edit").addClass("fa-spinner fa-spin");n.select2("readonly",!0),this.$submit.attr("disabled",!0),this.socket.emit("hourlyPlans.getCurrentEntryId",n.select2("val"),function(r,o){return r?"LOCKED"===r.message?t.broker.publish("router.navigate",{url:"#hourlyPlans/"+o,trigger:!0}):(s.removeClass("fa-spinner fa-spin").addClass("fa-edit"),n.select2("readonly",t.readonlyDivision),t.$submit.attr("disabled",!1).focus(),e.msg.show({type:"error",time:5e3,text:i("hourlyPlans","current:msg:failure",{error:r.message})})):void t.broker.publish("router.navigate",{url:"#hourlyPlans/"+o+";edit",trigger:!0})})}})});