define(["underscore","jquery","moment","app/i18n","app/user","app/core/View","app/hourlyPlans/templates/entry"],function(e,t,n,i,r,s,o){return s.extend({template:o,idPrefix:"hourlyPlanForm",events:{"change .hourlyPlan-count":"updateCount","keyup .hourlyPlan-count":"updateCount","change .hourlyPlan-noPlan":"updatePlan","click .hourlyPlan-noPlan-container":function(e){e.target.classList.contains("hourlyPlan-noPlan-container")&&this.$(e.target).find(".hourlyPlan-noPlan").click()}},initialize:function(){var e=this;this.listenToOnce(this.model,"sync",function(){var t=e.redirectToDetails.bind(e);e.pubsub.subscribe("hourlyPlans.updated."+e.model.id,e.onRemoteEdit.bind(e)),e.pubsub.subscribe("hourlyPlans.locked."+e.model.id,t),e.pubsub.subscribe("shiftChanged",t)})},afterRender:function(){return this.model.get("locked")?this.broker.publish("router.navigate",{url:this.model.genClientUrl(),replace:!0,trigger:!0}):(this.listenToOnce(this.model,"change",this.render),this.focusFirstEnabledInput(),void 0)},serialize:function(){return e.extend(this.model.serialize(),{editable:!0})},focusNextInput:function(e){var t=e.closest("td").next("td");if(t.length)return t.find("input").select();var n=e.closest("tr").next();return n.length?(this.focusNextEnabledInput(n),void 0):this.focusFirstEnabledInput()},focusFirstEnabledInput:function(){var e=this.el.querySelector(".hourlyPlan-noPlan:not(:checked)");e&&this.$(e).closest("tr").find(".hourlyPlan-count").first().select()},focusNextEnabledInput:function(e){return e.length?e.find(".hourlyPlan-noPlan:checked").length?this.focusNextEnabledInput(e.next()):(e.find(".hourlyPlan-count").first().select(),void 0):this.focusFirstEnabledInput()},toggleCountsInRow:function(e,t){var n=this.$(this.el.ownerDocument.activeElement).closest("tr"),i=this.$(".hourlyPlan > tbody > :last-child"),r=e.closest("tr"),s=r.find(".hourlyPlan-count").attr("disabled",e[0].checked);return e[0].checked?(s.val("0").attr("data-value","0"),t?r[0]===n[0]?r[0]===i[0]?this.focusFirstEnabledInput():this.focusNextEnabledInput(r):void 0:r[0]===i[0]?this.focusFirstEnabledInput():this.focusNextEnabledInput(r)):(t||r.find(".hourlyPlan-count").first().select(),void 0)},updatePlan:function(e){var t={type:"plan",socketId:this.socket.getId(),_id:this.model.id,flowIndex:parseInt(e.target.getAttribute("data-flow"),10),newValue:e.target.checked},n=this.$(e.target),i=this;this.toggleCountsInRow(n),this.socket.emit("hourlyPlans.updatePlan",t,function(t){t&&(console.error(t),e.target.checked=!e.target.checked,i.toggleCountsInRow(n))})},updateCount:function(e){if(13===e.which)return this.focusNextInput(this.$(e.target));var t=parseInt(e.target.getAttribute("data-value"),10)||0,n=parseInt(e.target.value,10)||0;if(t!==n){var i=e.target.getAttribute("data-flow")+":"+e.target.getAttribute("data-hour")+":"+e.target.getAttribute("name");this.timers[i]&&clearTimeout(this.timers[i]),this.timers[i]=setTimeout(this.doUpdateCount.bind(this),250,e.target,i,t,n)}},doUpdateCount:function(e,t,n,i){delete this.timers[t];var r=e.getAttribute("data-remote"),s={type:"count",socketId:this.socket.getId(),_id:this.model.id,newValue:i,flowIndex:parseInt(e.getAttribute("data-flow"),10)};"hour"===e.name&&(s.hourIndex=parseInt(e.getAttribute("data-hour"),10)),e.setAttribute("data-value",s.newValue),e.setAttribute("data-remote","false"),this.socket.emit("hourlyPlans.updateCount",s,function(t){t&&(console.error(t),"true"!==e.getAttribute("data-remote")&&(e.value=n,e.setAttribute("data-value",n),e.setAttribute("data-remote",r)))})},onRemoteEdit:function(e){if(e.socketId!==this.socket.getId())switch(e.type){case"plan":return this.handlePlanChange(e);case"count":return this.handleCountChange(e)}},handlePlanChange:function(e){var t='.hourlyPlan-noPlan[data-flow="'+e.flowIndex+'"]',n=this.$(t);n.length&&(n.prop("checked",e.newValue),this.toggleCountsInRow(n,!0))},handleCountChange:function(e){var t=".hourlyPlan-count[data-flow="+e.flowIndex+"]";t+="number"==typeof e.hourIndex?"[data-hour="+e.hourIndex+"]":"[name=level]";var n=this.$(t);n.length&&(n.val(e.newValue),n.attr({"data-value":e.newValue,"data-remote":"true"}))},redirectToDetails:function(){this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!0})}})});