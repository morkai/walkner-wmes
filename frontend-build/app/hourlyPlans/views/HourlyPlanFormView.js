define(["underscore","jquery","moment","app/i18n","app/user","app/core/View","app/hourlyPlans/templates/entry","i18n!app/nls/hourlyPlans"],function(t,e,n,a,o,r,i){return r.extend({template:i,idPrefix:"hourlyPlanForm",events:{"change .hourlyPlan-count":"updateCount","keyup .hourlyPlan-count":"updateCount","change .hourlyPlan-noPlan":"updatePlan","click .hourlyPlan-noPlan-container":function(t){t.target.classList.contains("hourlyPlan-noPlan-container")&&this.$(t.target).find(".hourlyPlan-noPlan").click()}},initialize:function(){var t=this;this.listenToOnce(this.model,"sync",function(){var e=t.redirectToDetails.bind(t);t.pubsub.subscribe("hourlyPlans.updated."+t.model.id,t.onRemoteEdit.bind(t)),t.pubsub.subscribe("hourlyPlans.locked."+t.model.id,e),t.pubsub.subscribe("shiftChanged",e)})},afterRender:function(){return this.model.get("locked")?this.broker.publish("router.navigate",{url:this.model.genClientUrl(),replace:!0,trigger:!0}):(this.listenToOnce(this.model,"change",this.render),this.focusFirstEnabledInput(),void 0)},serialize:function(){return t.extend(this.model.serialize(),{editable:!0})},focusNextInput:function(t){var e=t.closest("td").next("td");if(e.length)return e.find("input").select();var n=t.closest("tr").next();return n.length?(this.focusNextEnabledInput(n),void 0):this.focusFirstEnabledInput()},focusFirstEnabledInput:function(){var t=this.el.querySelector(".hourlyPlan-noPlan:not(:checked)");t&&this.$(t).closest("tr").find(".hourlyPlan-count").first().select()},focusNextEnabledInput:function(t){return t.length?t.find(".hourlyPlan-noPlan:checked").length?this.focusNextEnabledInput(t.next()):(t.find(".hourlyPlan-count").first().select(),void 0):this.focusFirstEnabledInput()},toggleCountsInRow:function(t,e){var n=this.$(this.el.ownerDocument.activeElement).closest("tr"),a=this.$(".hourlyPlan > tbody > :last-child"),o=t.closest("tr"),r=o.find(".hourlyPlan-count").attr("disabled",t[0].checked);return t[0].checked?(r.val("0").attr("data-value","0"),e?o[0]===n[0]?o[0]===a[0]?this.focusFirstEnabledInput():this.focusNextEnabledInput(o):void 0:o[0]===a[0]?this.focusFirstEnabledInput():this.focusNextEnabledInput(o)):(e||o.find(".hourlyPlan-count").first().select(),void 0)},updatePlan:function(t){var e={type:"plan",socketId:this.socket.getId(),_id:this.model.id,flowIndex:parseInt(t.target.getAttribute("data-flow"),10),newValue:t.target.checked},n=this.$(t.target),a=this;this.toggleCountsInRow(n),this.socket.emit("hourlyPlans.updatePlan",e,function(e){e&&(console.error(e),t.target.checked=!t.target.checked,a.toggleCountsInRow(n))})},updateCount:function(t){if(13===t.which)return this.focusNextInput(this.$(t.target));var e=parseInt(t.target.getAttribute("data-value"),10)||0,n=parseInt(t.target.value,10)||0;if(e!==n){var a=t.target.getAttribute("data-flow")+":"+t.target.getAttribute("data-hour")+":"+t.target.getAttribute("name");this.timers[a]&&clearTimeout(this.timers[a]),this.timers[a]=setTimeout(this.doUpdateCount.bind(this),250,t.target,a,e,n)}},doUpdateCount:function(t,e,n,a){delete this.timers[e];var o=t.getAttribute("data-remote"),r={type:"count",socketId:this.socket.getId(),_id:this.model.id,newValue:a,flowIndex:parseInt(t.getAttribute("data-flow"),10)};"hour"===t.name&&(r.hourIndex=parseInt(t.getAttribute("data-hour"),10)),t.setAttribute("data-value",r.newValue),t.setAttribute("data-remote","false"),this.socket.emit("hourlyPlans.updateCount",r,function(e){e&&(console.error(e),"true"!==t.getAttribute("data-remote")&&(t.value=n,t.setAttribute("data-value",n),t.setAttribute("data-remote",o)))})},onRemoteEdit:function(t){if(t.socketId!==this.socket.getId())switch(t.type){case"plan":return this.handlePlanChange(t);case"count":return this.handleCountChange(t)}},handlePlanChange:function(t){var e='.hourlyPlan-noPlan[data-flow="'+t.flowIndex+'"]',n=this.$(e);n.length&&(n.prop("checked",t.newValue),this.toggleCountsInRow(n,!0))},handleCountChange:function(t){var e=".hourlyPlan-count[data-flow="+t.flowIndex+"]";e+="number"==typeof t.hourIndex?"[data-hour="+t.hourIndex+"]":"[name=level]";var n=this.$(e);n.length&&(n.val(t.newValue),n.attr({"data-value":t.newValue,"data-remote":"true"}))},redirectToDetails:function(){this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!0})}})});