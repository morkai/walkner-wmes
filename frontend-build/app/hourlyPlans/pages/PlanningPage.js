// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/bindLoadingMessage","../views/DailyMrpPlanFilterView","../views/DailyMrpPlanView","../views/DailyMrpPlanImportView","app/hourlyPlans/templates/dailyMrpPlans/page"],function(e,t,i,r,n,s,a,o,l,d,h){"use strict";return s.extend({layoutName:"page",template:h,actions:null,breadcrumbs:[{href:"#hourlyPlans",label:i.bound("hourlyPlans","BREADCRUMBS:browse")},i.bound("hourlyPlans","BREADCRUMBS:planning")],events:{},initialize:function(){var i=this.idPrefix,r=this.handleDragEvent.bind(this);this.model=a(this.model.subscribe(this.pubsub),this),this.filterView=new o({model:this.model}),this.setView("#"+i+"-filter",this.filterView),this.listenTo(this.model,"import",this.onImport),this.listenTo(this.model,"reset",e.after(1,this.onReset)),this.listenTo(this.model.options,"change:wrap",this.onWrapChange),t("body").on("paste."+i,this.onBodyPaste.bind(this)).on("keydown."+i,this.onBodyKeyDown.bind(this)),t(document).on("dragstart."+i,r).on("dragenter."+i,r).on("dragleave."+i,r).on("dragover."+i,r).on("drop."+i,this.onDrop.bind(this))},destroy:function(){t("body").off("."+this.idPrefix).css("overflow-x",""),t(document).off("."+this.idPrefix)},load:function(e){return this.readCurrentFilterIfNeeded(),this.model.hasRequiredFilters()?e(this.loadStyles(),this.model.fetch({reset:!0})):e(this.loadStyles())},serialize:function(){return{idPrefix:this.idPrefix,wrap:!!this.model.options.get("wrap")}},loadStyles:function(){var e=t.Deferred(),i=t("head");return i.find('link[href$="planning.css"]').length?e.resolve():t('<link rel="stylesheet" href="/app/hourlyPlans/assets/planning.css">').on("load",function(){e.resolve()}).appendTo(i),e.promise()},afterRender:function(){t("body").css("overflow-x","hidden"),this.renderPlans(),this.toggleMessages()},toggleMessages:function(){var e=this.model.hasRequiredFilters();this.$id("msg-filter").toggleClass("hidden",e),this.$id("msg-empty").toggleClass("hidden",this.model.length>0)},renderPlans:function(){var e=this,t="#"+e.idPrefix+"-plans";e.removeView(t),e.model.forEach(function(i){var r=new l({model:i});e.insertView(t,r),r.render()})},onImport:function(e){this.model.setCurrentFilter(e),this.storeCurrentFilter(),this.filterView.render()},onReset:function(){this.storeCurrentFilter(),this.updateClientUrl(),this.renderPlans(),this.toggleMessages()},storeCurrentFilter:function(){localStorage.setItem("PLANNING:FILTER",JSON.stringify(this.model.getCurrentFilter()))},readCurrentFilterIfNeeded:function(){var t=JSON.parse(localStorage.getItem("PLANNING:FILTER")||"{}"),i=this.model.getCurrentFilter(),r=!1;e.forEach(i,function(n,s){e.isEmpty(n)&&!e.isEmpty(t[s])&&(i[s]=t[s],r=!0)}),r&&this.model.setCurrentFilter(i)},onWrapChange:function(){this.$el.toggleClass("wrap",!!this.model.options.get("wrap"))},updateClientUrl:function(){this.broker.publish("router.navigate",{url:"/hourlyPlans;planning?"+this.model.rqlQuery,trigger:!1,replace:!0})},handleDragEvent:function(e){return"dragstart"===e.type?void(this.sortableDragged=e.target.classList.contains("select2-search-choice")):(e.preventDefault(),void e.stopPropagation())},onDrop:function(t){if(this.sortableDragged)return void(this.sortableDragged=!1);if(t=t.originalEvent,t.preventDefault(),t.stopPropagation(),!t.dataTransfer.files.length)return n.msg.show({type:"warning",time:3e3,text:i("hourlyPlans","planning:msg:filesOnly")});var r=e.find(t.dataTransfer.files,function(e){return/vnd.ms-excel.sheet|spreadsheetml.sheet/.test(e.type)&&/\.xls(x|m)$/.test(e.name)});if(!r)return n.msg.show({type:"warning",time:3e3,text:i("hourlyPlans","planning:msg:invalidFile")});n.msg.loading();var s=new FormData;s.append("plan",r);var a=this,o=a.ajax({type:"POST",url:"/dailyMrpPlans;parse",data:s,processData:!1,contentType:!1});o.fail(function(){n.msg.loadingFailed()}),o.done(function(e){n.msg.loaded(),a.showImportDialog(e)})},onBodyKeyDown:function(e){if(27===e.keyCode)this.$(".is-selected").click();else if(13===e.keyCode){var t=this.$(".dailyMrpPlan-popover-editable");t.length&&this.saveChanges(t)}},onBodyPaste:function(e){if("INPUT"!==e.target.tagName){var t=e.originalEvent.clipboardData.getData("text/plain")||"",i=this.parseInput(t);this.showImportDialog(i)}},parseInput:function(e){var t={__DATE__:this.filterView.$id("date").val()||null},i=null,n=["_id","nc12","name","qty","rbh","operators","shifts"],s=null;e.split("\n").forEach(function(e){if(!s){var r=e.match(/([0-9]{1,2}[^0-9][0-9]{1,2}[^0-9][0-9]{4})/);if(r)return void(s=r[1])}if(e=" "+e+" ",/\s+[0-9]{9}\s+/.test(e)){var a={},o=0;return e.trim().split("	").forEach(function(e){if(o!==n.length){if(e=e.trim(),0===o)return void(/^[0-9]{9}$/.test(e)&&(a._id=e,o+=1));/^[0-9](,[0-9]+)?$/.test(e)&&(e=parseFloat(e.replace(",","."))),a[n[o]]=e,o+=1}}),t[i]||(t[i]=[]),void t[i].push(a)}var l=e.match(/\s+([A-Z][A-Z0-9]{2})\s+/);return l?(i=l[1],void(t[i]||(t[i]=[]))):void 0});var a=r.getMoment(s,"DD.MM.YYYY");return a.isValid()&&(t.__DATE__=a.format("YYYY-MM-DD")),t},showImportDialog:function(t){if(!n.currentDialog){var r=t.__DATE__;if(delete t.__DATE__,!e.isEmpty(t)){var s=new d({model:{dailyMrpPlans:this.model,date:r,mrpToOrdersMap:t}});this.listenToOnce(s,"imported",function(){n.closeDialog()}),n.showDialog(s,i("hourlyPlans","planning:import:title"))}}},saveChanges:function(e){var t=this.model.get(e.attr("data-plan"));if(t){var i=e.attr("data-item-type");"order"===i?t.orders.trigger("saveChangesRequested"):"line"===i&&t.lines.trigger("saveChangesRequested")}}})});