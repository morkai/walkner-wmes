// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/bindLoadingMessage","../DailyMrpPlanLine","../views/DailyMrpPlanFilterView","../views/DailyMrpPlanView","../views/DailyMrpPlanImportView","app/hourlyPlans/templates/dailyMrpPlans/page"],function(e,t,i,n,r,a,o,s,l,d,p,g){"use strict";return a.extend({layoutName:"page",template:g,actions:null,breadcrumbs:[{href:"#hourlyPlans",label:i.bound("hourlyPlans","BREADCRUMBS:browse")},i.bound("hourlyPlans","BREADCRUMBS:planning")],events:{"click .dailyMrpPlan-message-mrp":function(e){var t=e.currentTarget.textContent,i=this.model.find(function(e){return e.mrp.id===t});i&&i.trigger("scrollIntoView")}},initialize:function(){var i=this,n=i.idPrefix,r=i.handleDragEvent.bind(i);i.model=o(i.model.subscribe(i.pubsub),i),i.filterView=new l({model:i.model}),i.setView("#"+n+"-filter",i.filterView),i.listenTo(this.model,"import",i.onImport),i.listenTo(this.model,"reset",e.after(1,i.onReset)),i.listenTo(this.model,"checkOverlappingLinesRequested",e.debounce(i.checkOverlappingLines,50)),i.listenTo(this.model.options,"change:wrap",i.onWrapChange),t("body").on("paste."+n,i.onBodyPaste.bind(i)).on("keydown."+n,i.onBodyKeyDown.bind(i)),t(document).on("dragstart."+n,r).on("dragenter."+n,r).on("dragleave."+n,r).on("dragover."+n,r).on("drop."+n,i.onDrop.bind(i))},destroy:function(){t("body").off("."+this.idPrefix).css("overflow-x",""),t(document).off("."+this.idPrefix)},load:function(e){return this.readCurrentFilterIfNeeded(),this.model.hasRequiredFilters()?e(this.loadStyles(),this.model.fetch({reset:!0})):e(this.loadStyles())},serialize:function(){return{idPrefix:this.idPrefix,wrap:!!this.model.options.get("wrap")}},loadStyles:function(){var e=t.Deferred(),i=t("head");return i.find('link[href$="planning.css"]').length?e.resolve():t('<link rel="stylesheet" href="/app/hourlyPlans/assets/planning.css">').on("load",function(){e.resolve()}).appendTo(i),e.promise()},afterRender:function(){t("body").css("overflow-x","hidden"),this.renderPlans(),this.toggleMessages(),this.checkOverlappingLines()},toggleMessages:function(){var e=this.model.hasRequiredFilters();this.$id("msg-filter").toggleClass("hidden",e),this.$id("msg-empty").toggleClass("hidden",this.model.length>0)},renderPlans:function(){var e=this,t="#"+e.idPrefix+"-plans";e.removeView(t),e.model.forEach(function(i){var n=new d({model:i});e.insertView(t,n),n.render()})},onImport:function(e){this.model.setCurrentFilter(e),this.storeCurrentFilter(),this.filterView.render()},onReset:function(){this.storeCurrentFilter(),this.updateClientUrl(),this.renderPlans(),this.toggleMessages()},storeCurrentFilter:function(){localStorage.setItem("PLANNING:FILTER",JSON.stringify(this.model.getCurrentFilter()))},readCurrentFilterIfNeeded:function(){var t=JSON.parse(localStorage.getItem("PLANNING:FILTER")||"{}"),i=this.model.getCurrentFilter(),n=!1;e.forEach(i,function(r,a){e.isEmpty(r)&&!e.isEmpty(t[a])&&(i[a]=t[a],n=!0)}),n&&this.model.setCurrentFilter(i)},onWrapChange:function(){this.$el.toggleClass("wrap",!!this.model.options.get("wrap"))},updateClientUrl:function(){this.broker.publish("router.navigate",{url:"/hourlyPlans;planning?"+this.model.rqlQuery,trigger:!1,replace:!0})},handleDragEvent:function(e){return"dragstart"===e.type?void(this.sortableDragged=e.target.classList.contains("select2-search-choice")):(e.preventDefault(),void e.stopPropagation())},onDrop:function(t){if(this.sortableDragged)return void(this.sortableDragged=!1);if(t=t.originalEvent,t.preventDefault(),t.stopPropagation(),!t.dataTransfer.files.length)return r.msg.show({type:"warning",time:3e3,text:i("hourlyPlans","planning:msg:filesOnly")});var n=e.find(t.dataTransfer.files,function(e){return/vnd.ms-excel.sheet|spreadsheetml.sheet/.test(e.type)&&/\.xls(x|m)$/.test(e.name)});if(!n)return r.msg.show({type:"warning",time:3e3,text:i("hourlyPlans","planning:msg:invalidFile")});r.msg.loading();var a=new FormData;a.append("plan",n);var o=this,s=o.ajax({type:"POST",url:"/dailyMrpPlans;parse",data:a,processData:!1,contentType:!1});s.fail(function(){r.msg.loadingFailed()}),s.done(function(e){r.msg.loaded(),o.showImportDialog(e)})},onBodyKeyDown:function(e){if(27===e.keyCode)this.$(".is-selected").click();else if(13===e.keyCode){var t=this.$(".dailyMrpPlan-popover-editable");t.length&&this.saveChanges(t)}},onBodyPaste:function(e){if("INPUT"!==e.target.tagName){var t=e.originalEvent.clipboardData.getData("text/plain")||"",i=this.parseInput(t);this.showImportDialog(i)}},parseInput:function(e){var t={__DATE__:this.filterView.$id("date").val()||null},i=null,r=["_id","nc12","name","qty","rbh","operators","shifts"],a=null;e.split("\n").forEach(function(e){if(!a){var n=e.match(/([0-9]{1,2}[^0-9][0-9]{1,2}[^0-9][0-9]{4})/);if(n)return void(a=n[1])}if(e=" "+e+" ",/\s+[0-9]{9}\s+/.test(e)){var o={},s=0;return e.trim().split("	").forEach(function(e){if(s!==r.length){if(e=e.trim(),0===s)return void(/^[0-9]{9}$/.test(e)&&(o._id=e,s+=1));/^[0-9]+(,[0-9]+)?$/.test(e)&&(e=parseFloat(e.replace(",","."))),o[r[s]]=e,s+=1}}),t[i]||(t[i]=[]),void t[i].push(o)}var l=e.match(/\s+([A-Z][A-Z0-9]{2})\s+/);return l?(i=l[1],void(t[i]||(t[i]=[]))):void 0});var o=n.getMoment(a,"DD.MM.YYYY");return o.isValid()&&(t.__DATE__=o.format("YYYY-MM-DD")),t},showImportDialog:function(t){if(!r.currentDialog){var n=t.__DATE__;if(delete t.__DATE__,!e.isEmpty(t)){var a=new p({model:{dailyMrpPlans:this.model,date:n,mrpToOrdersMap:t}});this.listenToOnce(a,"imported",function(){r.closeDialog()}),r.showDialog(a,i("hourlyPlans","planning:import:title"))}}},saveChanges:function(e){var t=this.model.get(e.attr("data-plan"));if(t){var i=e.attr("data-item-type");"order"===i?t.orders.trigger("saveChangesRequested"):"line"===i&&t.lines.trigger("saveChangesRequested")}},checkOverlappingLines:function(){var t=this;if(this.model.length){var i=t.model.at(0).date.getTime(),n="/dailyMrpPlans?select(lines._id,lines.activeFrom,lines.activeTo)&date="+i;t.ajax({url:n}).done(function(n){t.model.trigger("checkingOverlappingLines");var r={},a={};e.forEach(n.collection,function(t){e.isEmpty(t.lines)||(r[t._id]={},t.lines.forEach(function(e){a[e._id]||(a[e._id]=[]),a[e._id].push(t._id),r[t._id][e._id]={activeFrom:s.getActiveFromMoment(i,e.activeFrom).toDate(),activeTo:s.getActiveToMoment(i,e.activeTo).toDate()}}))}),e.forEach(a,function(e,i){1!==e.length&&t.checkLineOverlapping(i,e.map(function(e){return{line:i,plan:e,from:r[e][i].activeFrom,to:r[e][i].activeTo}}))})})}},checkLineOverlapping:function(e,t){for(var i=0;i<t.length;++i)for(var n=t[i],r=i+1;r<t.length;++r){var a=t[r];if(!(n.from>=a.to||n.to<=a.from)){var o=this.model.get(n.plan);o&&o.trigger("overlappingLine",{line:e,plan:a.plan,mrp:a.plan.split("-")[1]});var s=this.model.get(a.plan);s&&s.trigger("overlappingLine",{line:e,plan:n.plan,mrp:n.plan.split("-")[1]})}}}})});