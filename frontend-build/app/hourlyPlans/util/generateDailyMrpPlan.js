// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/data/orgUnits","./shift","./autoDowntimeCache"],function(e,t,r,n,i){"use strict";var o=!1;return function(a){function u(){var e=T();if(!e)return!1;var t=e.get("qtyPlan"),r=t>0?t:e.get("qtyTodo"),n=e.get("qtyDone"),i=r-n;0>=i&&(i=r);var o=O?i:r;return o>w?f(e,o):l(e,o),!0}function f(t,r){var n=v();if(0===n.length)return!1;if(1===n.length)return l(t,r);if(2===n.length)return h(r,2).forEach(function(e){l(t,e)});for(var i=[],o=2;o<=n.length;++o){var a=[],u=h(r,o).map(function(e,r){var i=n[r];return a.push(i),c(t,e,n[r])}),f=0,T=0,d=0;if(u.forEach(function(t){f+=t.orders.length,e.forEach(t.orders,function(e){e.qty>w&&(T+=1)})}),f===o&&(d+=1),0===T&&(d+=2),i.push({allOrderCount:f,bigOrderCount:T,lineCount:a.length,rank:d,lines:a,candidates:u}),3===d)break}i.sort(function(e,t){return e.rank===t.rank?e.candidates.length===t.lines.length?t.allOrderCount-e.allOrderCount:t.lineCount-e.lineCount:t.rank-e.rank});var m=i[0];m.candidates.forEach(function(e,t){s(e,m.lines[t])})}function l(e,t){var r=v();if(0===r.length)return!1;for(var n=0;n<r.length;++n){var i=r[n],o=c(e,t,i);if(o){s(o,i);break}}return!0}function s(e,t){if(!g(t.orders)||!g(e.orders)){t.shiftNo=e.shiftNo,t.activeFrom=e.activeFrom,t.nextDowntime=e.nextDowntime,t.orders=t.orders.concat(e.orders),t.full=e.full,t.pceTimes=t.pceTimes.concat(e.pceTimes);for(var r=0;24>r;++r)t.hourlyPlan[r]+=e.hourlyPlan[r]}}function c(r,i,o){for(var a=r.getPceTime(o.workerCount),u=o.shiftNo,f=o.nextDowntime,l=o.activeTo.valueOf(),s=!1,c=o.activeFrom.valueOf(),T=c+d(o),h=0,v=[],m=n.EMPTY_HOURLY_PLAN.slice(),g=[];i>=h;){for(var p=T+a;f&&f.startAt<=p;)p+=f.duration,f=f.next;var D=new Date(p),N=D.getHours();if(p>l||3===u&&N>=6&&22>N){h>0&&v.push({_id:r.id+"-"+u,orderNo:r.id,qty:h,startAt:new Date(c),finishAt:new Date(T),pceTime:a,incomplete:i-h}),s=!0;break}if(1===u&&N>=14||2===u&&(N>=22||6>N))0===h?(u+=1,c=E[u].START_TIME,T=c+E[u].START_DOWNTIME):(v.push({_id:r.id+"-"+u,orderNo:r.id,qty:h,startAt:new Date(c),finishAt:new Date(T),pceTime:a,incomplete:!1}),u+=1,c=E[u].START_TIME,T=c+A,i-=h,h=0);else{if(h===i){v.push({_id:r.id+"-"+u,orderNo:r.id,qty:h,startAt:new Date(c),finishAt:new Date(T),pceTime:a,incomplete:!1});break}T=p,h+=1,g.push(N,D.getMinutes()),m[n.HOUR_TO_INDEX[N]]+=1}}return v.length?{shiftNo:u,activeFrom:t.getMoment(e.last(v).finishAt.getTime()),nextDowntime:f,orders:v,full:s,hourlyPlan:m,pceTimes:g}:null}function T(){for(;I.length;){var e=I.shift();if(!(M&&e.isCompleted()||_&&e.isConfirmed()||N&&e.isDelivered())&&e.isValid())return e}return null}function d(e){if(e.orders.length)return A;var t=E[e.shiftNo];if(!t.START_DOWNTIME)return A;var r=e.activeFrom.valueOf(),n=t.START_TIME+t.START_DOWNTIME;return r>=n?A:t.START_DOWNTIME-(r-t.START_TIME)}function h(t,r){for(var n=Math.floor(t/r),i=e.map(new Array(r),function(){return n}),o=t%r,a=0;o;)i[a++]+=1,o-=1,a===r&&(a=0);return i}function v(){return D.filter(function(e){return!e.full}).sort(m)}function m(e,t){return e.activeFrom.valueOf()-t.activeFrom.valueOf()}function g(t){var r=e.last(t);return r?r.incomplete>0:!1}if(!o){var p=(performance.now(),a.date.getTime());if(!a.lines.length)return!1;o=!0;var D=a.lines.filter(function(e){return e.get("workerCount")>0}).map(function(e){var t=r.getByTypeAndId("prodLine",e.id),o=r.getSubdivisionFor(t),a=e.getActiveFromMoment();return{id:e.id,shiftNo:n.getShiftNo(a.valueOf()),activeFrom:a,activeTo:e.getActiveToMoment(),workerCount:e.get("workerCount"),nextDowntime:i.get(o,p),orders:[],hourlyPlan:n.EMPTY_HOURLY_PLAN.slice(),pceTimes:[],full:!1}});if(!D.length||!a.orders.length)return a.lines.invoke("reset"),o=!1,!0;for(var A=3e4,E={1:{START_TIME:new Date(p).setHours(6),START_DOWNTIME:3e5,END_DOWNTIME:3e5},2:{START_TIME:new Date(p).setHours(14),START_DOWNTIME:3e5,END_DOWNTIME:3e5},3:{START_TIME:new Date(p).setHours(22),START_DOWNTIME:3e5,END_DOWNTIME:3e5}},N=!1,_=!1,M=!1,O=!1,w=70,I=a.orders.models.slice();u(););return D.forEach(function(e){var t=a.lines.get(e.id);t.set({hourlyPlan:e.hourlyPlan,pceTimes:e.pceTimes,totalQty:e.pceTimes.length/2}),t.orders.reset(e.orders)}),o=!1,!0}}});