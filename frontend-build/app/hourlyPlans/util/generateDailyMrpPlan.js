// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/data/orgUnits","./shift","./autoDowntimeCache","../DailyMrpPlanOrder"],function(e,t,r,n,i,o){"use strict";var a=("production"!==window.ENV,!1);return function(u,l){function f(){var e=m();if(!e)return!1;var t=e.get("qtyPlan"),r=t>0?t:e.get("qtyTodo"),n=e.get("qtyDone"),i=r-n;0>=i&&(i=r);var o=S?i:r;return o>R?s(e,o):c(e,o),!0}function s(t,r){var n=p();if(0===n.length)return!1;if(1===n.length)return c(t,r);if(2===n.length)return g(r,2).forEach(function(e){c(t,e)});for(var i=[],o=2;o<=n.length;++o){var a=[],u=g(r,o).map(function(e,r){var i=n[r];return a.push(i),h(t,e,n[r])}),l=0,f=0,s=0,T=0;if(u.forEach(function(t){l+=t.orders.length,e.forEach(t.orders,function(e){e.qty>R&&(f+=1),e.incomplete&&(s+=1)})}),l===o&&(T+=1),0===f&&(T+=2),0===s&&(T+=1),i.push({allOrderCount:l,bigOrderCount:f,lineCount:a.length,rank:T,lines:a,candidates:u}),4===T)break}i.sort(function(e,t){return e.rank===t.rank?e.candidates.length===t.lines.length?t.allOrderCount-e.allOrderCount:t.lineCount-e.lineCount:t.rank-e.rank});var m=i[0];m.candidates.forEach(function(e,t){d(e,m.lines[t])})}function c(e,t){var r=p();if(0===r.length)return!1;for(var n=0;n<r.length;++n){var i=r[n],o=h(e,t,i);if(o){d(o,i);break}}return!0}function d(t,r){if(!w(r.orders)||!w(t.orders)){r.shiftNo=t.shiftNo,r.activeFrom=t.activeFrom,r.nextDowntime=t.nextDowntime,r.orders=r.orders.concat(t.orders),r.full=t.full,r.pceTimes=r.pceTimes.concat(t.pceTimes);for(var n=0;24>n;++n)r.hourlyPlan[n]+=t.hourlyPlan[n];T(e.last(r.orders))}}function T(e){if(e.incomplete){var t=u.orders.get(e.orderNo).toJSON(),r=new o(t);r.set({qtyDone:0,qtyPlan:e.incomplete});var n=p();0!==n.length&&h(r,e.incomplete,n[0])&&(e.incomplete=0,k.unshift(r))}}function h(r,i,o){for(var a=r.getPceTime(o.workerCount),u=o.shiftNo,l=o.nextDowntime,f=o.activeTo.valueOf(),s=!1,c=o.activeFrom.valueOf(),d=c+v(o),T=0,h=[],m=n.EMPTY_HOURLY_PLAN.slice(),g=[];i>=T;){for(var p=d+a;l&&l.startAt<=p;)p+=l.duration,l=l.next;var D=new Date(p),w=D.getHours();if(p>f||3===u&&w>=6&&22>w){T>0&&h.push({_id:r.id+"-"+u,orderNo:r.id,qty:T,startAt:new Date(c),finishAt:new Date(d),pceTime:a,incomplete:i-T}),s=!0;break}if(1===u&&w>=14||2===u&&(w>=22||6>w))if(0===T)u+=1,c=E[u].START_TIME,d=c+E[u].START_DOWNTIME;else{if(h.push({_id:r.id+"-"+u,orderNo:r.id,qty:T,startAt:new Date(c),finishAt:new Date(d),pceTime:a,incomplete:!1}),i-T===0)break;u+=1,c=E[u].START_TIME,d=c+y,i-=T,T=0}else{if(T===i){h.push({_id:r.id+"-"+u,orderNo:r.id,qty:T,startAt:new Date(c),finishAt:new Date(d),pceTime:a,incomplete:!1});break}d=p,T+=1,g.push(w,D.getMinutes()),m[n.HOUR_TO_INDEX[w]]+=1}}return h.length?{shiftNo:u,activeFrom:t.getMoment(e.last(h).finishAt.getTime()),nextDowntime:l,orders:h,full:s,hourlyPlan:m,pceTimes:g}:null}function m(){for(;k.length;){var e=k.shift();if(e.isValid()){if(e.get("qtyPlan")>0)return e;if(!(M&&e.isCompleted()||_&&e.isConfirmed()||N&&e.isDelivered()))return e}}return null}function v(e){if(e.orders.length)return y;var t=E[e.shiftNo];if(!t.START_DOWNTIME)return y;var r=e.activeFrom.valueOf(),n=t.START_TIME+t.START_DOWNTIME;return r>=n?y:t.START_DOWNTIME-(r-t.START_TIME)}function g(t,r){for(var n=Math.floor(t/r),i=e.map(new Array(r),function(){return n}),o=t%r,a=0;o;)i[a++]+=1,o-=1,a===r&&(a=0);return i}function p(){return O.filter(function(e){return!e.full}).sort(D)}function D(e,t){return e.activeFrom.valueOf()-t.activeFrom.valueOf()}function w(t){var r=e.last(t);return r?r.incomplete>0:!1}if(!a){var A=(performance.now(),u.date.getTime());if(!u.lines.length)return!1;a=!0;var O=u.lines.filter(function(e){return e.get("workerCount")>0}).map(function(e){var t=r.getByTypeAndId("prodLine",e.id),o=r.getSubdivisionFor(t),a=e.getActiveFromMoment();return{id:e.id,shiftNo:n.getShiftNo(a.valueOf()),activeFrom:a,activeTo:e.getActiveToMoment(),workerCount:e.get("workerCount"),nextDowntime:i.get(o,A),orders:[],hourlyPlan:n.EMPTY_HOURLY_PLAN.slice(),pceTimes:[],full:!1}});if(!O.length||!u.orders.length)return u.lines.invoke("reset"),a=!1,!0;for(var y=l.perOrderOverhead||0,E={1:{START_TIME:new Date(A).setHours(6),START_DOWNTIME:l.shiftStartDowntime[1]||0},2:{START_TIME:new Date(A).setHours(14),START_DOWNTIME:l.shiftStartDowntime[2]||0},3:{START_TIME:new Date(A).setHours(22),START_DOWNTIME:l.shiftStartDowntime[3]||0}},N=!!l.ignoreDlv,_=!!l.ignoreCnf,M=!!l.ignoreDone,S=!!l.qtyRemaining,R=l.bigOrderQty||0,k=u.orders.models.slice();f(););return O.forEach(function(e){var t=u.lines.get(e.id);t.set({hourlyPlan:e.hourlyPlan,pceTimes:e.pceTimes,totalQty:e.pceTimes.length/2}),t.orders.reset(e.orders,{skipGenerate:!0})}),a=!1,!0}}});