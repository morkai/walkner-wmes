// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/data/orgUnits","./shift","./autoDowntimeCache","../DailyMrpPlanOrder"],function(e,t,r,n,o,i){"use strict";var a=("production"!==window.ENV,!1);return function(l,s){function u(){var e=v();if(!e)return!1;var t=e.get("qtyPlan"),r=t>0?t:e.get("qtyTodo"),n=e.get("qtyDone"),o=r-n;o<=0&&(o=r);var i=P?o:r;return i>R?f(e,i):c(e,i),!0}function f(t,r){var n=D();if(0===n.length)return!1;if(1===n.length)return c(t,r);if(2===n.length)return p(r,2).forEach(function(e){c(t,e)});for(var o=[],i=2;i<=n.length;++i){var a=[],l=p(r,i).map(function(e,r){var o=n[r];return a.push(o),T(t,e,n[r])}),s=0,u=0,f=0,m=0;if(l.forEach(function(t){s+=t.orders.length,e.forEach(t.orders,function(e){e.qty>R&&(u+=1),e.incomplete&&(f+=1)})}),s===i&&(m+=1),0===u&&(m+=2),0===f&&(m+=1),o.push({allOrderCount:s,bigOrderCount:u,lineCount:a.length,rank:m,lines:a,candidates:l}),4===m)break}o.sort(function(e,t){return e.rank===t.rank?e.candidates.length===t.lines.length?t.allOrderCount-e.allOrderCount:t.lineCount-e.lineCount:t.rank-e.rank});var h=o[0];h.candidates.forEach(function(e,r){d(t,e,h.lines[r])})}function c(e,t){var r=D();if(0===r.length)return!1;for(var n=0;n<r.length;++n){var o=r[n],i=T(e,t,o);if(i){d(e,i,o);break}}return!0}function d(t,r,n){if(!y(n.orders)||!y(r.orders)){var o=e.last(n.orders),i=e.first(r.orders);if(n.prev&&o&&o.orderNo===i.orderNo)return m(t,r,n);n.prev={shiftNo:n.shiftNo,activeFrom:n.activeFrom,nextDowntime:n.nextDowntime,orders:n.orders,full:n.full,pceTimes:n.pceTimes,hourlyPlan:[].concat(n.hourlyPlan),incomplete:null},n.shiftNo=r.shiftNo,n.activeFrom=r.activeFrom,n.nextDowntime=r.nextDowntime,n.orders=n.orders.concat(r.orders),n.full=r.full,n.pceTimes=n.pceTimes.concat(r.pceTimes);for(var a=0;a<24;++a)n.hourlyPlan[a]+=r.hourlyPlan[a];h(n,e.last(n.orders))}}function m(t,r,n){var o=n.prev;o.incomplete&&I.shift();var i=e.last(n.orders),a=e.first(r.orders);n.prev=null,n.shiftNo=o.shiftNo,n.activeFrom=o.activeFrom,n.nextDowntime=o.nextDowntime,n.orders=o.orders,n.full=o.full,n.pceTimes=o.pceTimes,n.hourlyPlan=o.hourlyPlan;var l=T(t,i.qty+a.qty,n);d(t,l,n)}function h(e,t){if(t.incomplete){var r=l.orders.get(t.orderNo).toJSON(),n=new i(r);n.set({qtyDone:0,qtyPlan:t.incomplete});var o=D();0!==o.length&&T(n,t.incomplete,o[0])&&(e.prev.incomplete=n,t.incomplete=0,I.unshift(n))}}function T(r,o,i){for(var a=r.getPceTime(i.workerCount),l=i.shiftNo,s=i.nextDowntime,u=i.activeTo.valueOf(),f=!1,c=i.activeFrom.valueOf(),d=c+g(i),m=0,h=[],T=n.EMPTY_HOURLY_PLAN.slice(),v=[];m<=o;){for(var p=d+a;s&&s.startAt<=p;)p+=s.duration,s=s.next;var D=new Date(p),w=D.getHours();if(p>u||3===l&&w>=6&&w<22){m>0&&h.push({_id:r.id+"-"+l+"-"+(1+i.orders.length+h.length),orderNo:r.id,qty:m,startAt:new Date(c),finishAt:new Date(d),pceTime:a,incomplete:o-m}),f=!0;break}if(1===l&&w>=14||2===l&&(w>=22||w<6))if(0===m)l+=1,c=E[l].START_TIME,d=c+E[l].START_DOWNTIME;else{if(h.push({_id:r.id+"-"+l+"-"+(1+i.orders.length+h.length),orderNo:r.id,qty:m,startAt:new Date(c),finishAt:new Date(d),pceTime:a,incomplete:!1}),o-m===0)break;l+=1,c=E[l].START_TIME,d=c+O,o-=m,m=0}else{if(m===o){h.push({_id:r.id+"-"+l+"-"+(1+i.orders.length+h.length),orderNo:r.id,qty:m,startAt:new Date(c),finishAt:new Date(d),pceTime:a,incomplete:!1});break}d=p,m+=1,v.push(w,D.getMinutes()),T[n.HOUR_TO_INDEX[w]]+=1}}return h.length?{shiftNo:l,activeFrom:t.getMoment(e.last(h).finishAt.getTime()),nextDowntime:s,orders:h,full:f,hourlyPlan:T,pceTimes:v}:null}function v(){for(;I.length;){var e=I.shift();if(e.isValid()){if(e.get("qtyPlan")>0)return e;if(!(e.isIgnored()||S&&e.isCompleted()||M&&e.isConfirmed()||_&&e.isDelivered()))return e}}return null}function g(e){if(e.orders.length)return O;var t=E[e.shiftNo];if(!t.START_DOWNTIME)return O;var r=e.activeFrom.valueOf(),n=t.START_TIME+t.START_DOWNTIME;return r>=n?O:t.START_DOWNTIME-(r-t.START_TIME)}function p(t,r){for(var n=Math.floor(t/r),o=e.map(new Array(r),function(){return n}),i=t%r,a=0;i;)o[a++]+=1,i-=1,a===r&&(a=0);return o}function D(){return N.filter(function(e){return!e.full}).sort(w)}function w(e,t){return e.activeFrom.valueOf()-t.activeFrom.valueOf()}function y(t){var r=e.last(t);return!!r&&r.incomplete>0}if(!a){var A=(performance.now(),l.date.getTime());if(!l.lines.length)return!1;a=!0;var N=l.lines.filter(function(e){return e.get("workerCount")>0}).map(function(e){var t=r.getByTypeAndId("prodLine",e.id),i=r.getSubdivisionFor(t),a=e.getActiveFromMoment(),l=s.lineAutoDowntimes[t.id]||i.get("autoDowntimes")||[];return{id:e.id,shiftNo:n.getShiftNo(a.valueOf()),activeFrom:a,activeTo:e.getActiveToMoment(),workerCount:e.get("workerCount"),autoDowntimes:l,nextDowntime:o.get(t,A,l),orders:[],hourlyPlan:n.EMPTY_HOURLY_PLAN.slice(),pceTimes:[],full:!1}});if(!N.length||!l.orders.length)return l.lines.invoke("reset"),a=!1,!0;for(var O=s.perOrderOverhead||0,E={1:{START_TIME:new Date(A).setHours(6),START_DOWNTIME:s.shiftStartDowntime[1]||0},2:{START_TIME:new Date(A).setHours(14),START_DOWNTIME:s.shiftStartDowntime[2]||0},3:{START_TIME:new Date(A).setHours(22),START_DOWNTIME:s.shiftStartDowntime[3]||0}},_=!!s.ignoreDlv,M=!!s.ignoreCnf,S=!!s.ignoreDone,P=!!s.qtyRemaining,R=s.bigOrderQty||0,I=l.orders.models.slice();u(););return N.forEach(function(e){var t=l.lines.get(e.id);t.set({hourlyPlan:e.hourlyPlan,pceTimes:e.pceTimes,totalQty:e.pceTimes.length/2,downtimes:e.autoDowntimes}),t.orders.reset(e.orders,{skipGenerate:!0})}),a=!1,!0}}});