// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../i18n","../time","../data/divisions","../orgUnits/util/renderOrgUnitPath","../core/Model"],function(e,t,i,n,r){"use strict";return r.extend({urlRoot:"/hourlyPlans",clientUrlRoot:"#hourlyPlans",topicPrefix:"hourlyPlans",privilegePrefix:"HOURLY_PLANS",nlsDomain:"hourlyPlans",defaults:{division:null,date:null,shift:null,flows:null,createdAt:null,creator:null,updatedAt:null,updater:null},getLabel:function(){return this.get("division")+", "+t.format(this.get("date"),"LL")},serialize:function(){var r=i.get(this.get("division"));return{division:r?n(r,!1,!1):"?",date:t.format(this.get("date"),"LL"),shift:e("core","SHIFT:"+this.get("shift")),flows:this.get("flows")}},serializeToPrint:function(){for(var e=i.get(this.get("division")),r=this.get("flows").filter(function(e){if(e.noPlan)return!1;if(e.level>0)return!0;for(var t=0;t<23;++t)if(e.hours[t]>0)return!0;return!1}),l=[{flows:[]}];r.length;)30===l[l.length-1].flows.length&&l.push({flows:[]}),l[l.length-1].flows.push(r.shift());return{division:e?n(e,!1,!1):"?",date:t.format(this.get("date"),"LL"),pages:l}},isEditable:function(e){if(e.isAllowedTo("PROD_DATA:MANAGE"))return!0;if(!e.isAllowedTo(this.getPrivilegePrefix()+":MANAGE"))return!1;var t=Date.now();if(t>Date.parse(this.get("date"))+864e5&&t>=Date.parse(this.get("createdAt"))+288e5)return!1;var i=e.getDivision();return!(i&&!e.isAllowedTo(this.getPrivilegePrefix()+":ALL"))||this.get("division")===i.id},handleUpdateMessage:function(e){var t=this.get("flows");if(t){var i=t[e.flowIndex];if(i){if("plan"===e.type)i.noPlan=e.newValue,i.level=0,i.hours=i.hours.map(function(){return 0});else if("count"===e.type)"number"==typeof e.hourIndex?i.hours[e.hourIndex]=e.newValue:i.level=e.newValue;else{if("counts"!==e.type)return;i.hours=e.newValues}this.trigger("change:flows"),this.trigger("change")}}}})});