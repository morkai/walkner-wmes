// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../i18n","../time","../data/divisions","../data/views/renderOrgUnitPath","../core/Model"],function(e,t,i,r,n){"use strict";return n.extend({urlRoot:"/hourlyPlans",clientUrlRoot:"#hourlyPlans",topicPrefix:"hourlyPlans",privilegePrefix:"HOURLY_PLANS",nlsDomain:"hourlyPlans",defaults:{division:null,date:null,shift:null,flows:null,createdAt:null,creator:null,updatedAt:null,updater:null},getLabel:function(){return this.get("division")+", "+t.format(this.get("date"),"LL")},serialize:function(){var n=i.get(this.get("division"));return{division:n?r(n,!1,!1):"?",date:t.format(this.get("date"),"LL"),shift:e("core","SHIFT:"+this.get("shift")),flows:this.get("flows")}},isEditable:function(e){if(e.isAllowedTo("PROD_DATA:MANAGE"))return!0;if(!e.isAllowedTo(this.getPrivilegePrefix()+":MANAGE"))return!1;var t=Date.now(),i=Date.parse(this.get("date"))+864e5;if(t>i){var r=Date.parse(this.get("createdAt"));if(t>=r+288e5)return!1}var n=e.getDivision();if(!n||e.isAllowedTo(this.getPrivilegePrefix()+":ALL"))return!0;var l=this.get("division");return l===n.id},handleUpdateMessage:function(e){var t=this.get("flows");if(t){var i=t[e.flowIndex];if(i){if("plan"===e.type)i.noPlan=e.newValue,i.level=0,i.hours=i.hours.map(function(){return 0});else if("count"===e.type)"number"==typeof e.hourIndex?i.hours[e.hourIndex]=e.newValue:i.level=e.newValue;else{if("counts"!==e.type)return;i.hours=e.newValues}this.trigger("change:flows"),this.trigger("change")}}}})});