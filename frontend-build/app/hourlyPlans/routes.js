// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../broker","../router","../viewport","../user","../time","../core/util/showDeleteFormPage","../core/util/getRelativeDateRange","../core/util/fixRelativeDateInRql","./HourlyPlan","./HourlyPlanCollection"],function(e,a,n,l,r,t,o,i,u,s){"use strict";var d="i18n!app/nls/hourlyPlans",p=l.auth("HOURLY_PLANS:VIEW"),P=l.auth("HOURLY_PLANS:MANAGE","PROD_DATA:MANAGE");a.map("/hourlyPlans",p,function(e){n.loadPage(["app/hourlyPlans/pages/HourlyPlanListPage","i18n!app/nls/fte",d],function(a){return new a({collection:new s(null,{rqlQuery:i(e.rql,{property:"date",range:!0,shift:!0})})})})}),a.map("/hourlyPlans;heff",P,function(e){n.loadPage(["app/hourlyPlans/HeffLineStateCollection","app/hourlyPlans/pages/HeffLineStatePage",d],function(a,n){return new n({collection:new a(null,{rqlQuery:e.rql})})})}),a.map("/hourlyPlans;settings",l.auth("PROD_DATA:MANAGE"),function(e){n.loadPage(["app/hourlyPlans/pages/PlanningSettingsPage",d],function(a){return new a({initialTab:e.query.tab})})}),a.map("/hourlyPlans;add",P,function(e){n.loadPage(["app/hourlyPlans/pages/HourlyPlanAddFormPage",d],function(a){var n=o(e.query.date);return new a({model:new u({date:n?n.from.setHours(6):null})})})}),a.map("/hourlyPlans/:date/:division",p,function(a){function n(){e.publish("router.navigate",{url:"/hourlyPlans?sort(-date)&limit(20)&date>="+l+"&date<"+r.getMoment(/^[0-9]+$/.test(l)?+l:l).add(1,"days").valueOf()+"&division="+a.params.division,trigger:!0,replace:!0})}var l=a.params.date,t=new s(null,{rqlQuery:"select(_id)&date="+l+"&division="+a.params.division});t.on("error",n),t.on("sync",function(){1===t.length?e.publish("router.navigate",{url:"/hourlyPlans/"+t.models[0].id,trigger:!0,replace:!0}):n()}),t.fetch({reset:!0})}),a.map("/hourlyPlans/:id",p,function(e){n.loadPage(["app/hourlyPlans/pages/HourlyPlanDetailsPage",d],function(a){return new a({model:new u({_id:e.params.id})})})}),a.map("/hourlyPlans/:id;edit",P,function(e){n.loadPage(["app/hourlyPlans/pages/HourlyPlanEditFormPage",d],function(a){return new a({model:new u({_id:e.params.id})})})}),a.map("/hourlyPlans/:id;delete",P,t.bind(null,u))});