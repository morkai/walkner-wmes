// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../broker","../router","../viewport","../user","../time","../core/util/showDeleteFormPage","../core/util/getRelativeDateRange","../core/util/fixRelativeDateInRql","./HourlyPlan","./HourlyPlanCollection"],function(a,l,n,e,r,t,o,i,u,s){"use strict";var p="i18n!app/nls/hourlyPlans",P=e.auth("HOURLY_PLANS:VIEW"),d=e.auth("HOURLY_PLANS:MANAGE","PROD_DATA:MANAGE");l.map("/hourlyPlans",P,function(a){n.loadPage(["app/hourlyPlans/HourlyPlanCollection","app/hourlyPlans/pages/HourlyPlanListPage","i18n!app/nls/fte",p],function(l,n){return new n({collection:new l(null,{rqlQuery:i(a.rql,{property:"date",range:!0,shift:!0})})})})}),l.map("/hourlyPlans;heff",d,function(a){n.loadPage(["app/hourlyPlans/HeffLineStateCollection","app/hourlyPlans/pages/HeffLineStatePage",p],function(l,n){return new n({collection:new l(null,{rqlQuery:a.rql})})})}),l.map("/hourlyPlans;settings",e.auth("PROD_DATA:MANAGE"),function(a){n.loadPage(["app/hourlyPlans/pages/PlanningSettingsPage",p],function(l){return new l({initialTab:a.query.tab})})}),l.map("/hourlyPlans;planning",d,function(l){a.publish("router.navigate",{url:"/dailyMrpPlans?"+l.rql,replace:!0,trigger:!0})}),l.map("/dailyMrpPlans;list",d,function(a){n.loadPage(["app/hourlyPlans/DailyMrpPlanCollection","app/hourlyPlans/pages/DailyMrpPlanListPage",p],function(l,n){return new n({collection:new l(null,{rqlQuery:a.rql,paginate:!1})})})}),l.map("/dailyMrpPlans",d,function(a){n.loadPage(["app/hourlyPlans/settings","app/hourlyPlans/DailyMrpPlanCollection","app/hourlyPlans/pages/PlanningPage",p],function(l,n,e){return new e({model:new n(null,{settings:l.acquire(),rqlQuery:i(a.rql,{property:"date",shift:!0,format:"YYYY-MM-DD"}),paginate:!1})})})}),l.map("/hourlyPlans;add",d,function(a){n.loadPage(["app/hourlyPlans/pages/HourlyPlanAddFormPage",p],function(l){var n=o(a.query.date);return new l({model:new u({date:n?n.from.setHours(6):null})})})}),l.map("/hourlyPlans/:date/:division",P,function(l){function n(){a.publish("router.navigate",{url:"/hourlyPlans?sort(-date)&limit(20)&date>="+e+"&date<"+r.getMoment(/^[0-9]+$/.test(e)?+e:e).add(1,"days").valueOf()+"&division="+l.params.division,trigger:!0,replace:!0})}var e=l.params.date,t=new s(null,{rqlQuery:"select(_id)&date="+e+"&division="+l.params.division});t.on("error",n),t.on("sync",function(){1===t.length?a.publish("router.navigate",{url:"/hourlyPlans/"+t.models[0].id,trigger:!0,replace:!0}):n()}),t.fetch({reset:!0})}),l.map("/hourlyPlans/:id",P,function(a){n.loadPage(["app/hourlyPlans/pages/HourlyPlanDetailsPage",p],function(l){return new l({modelId:a.params.id})})}),l.map("/hourlyPlans/:id;edit",d,function(a){n.loadPage(["app/hourlyPlans/pages/HourlyPlanEditFormPage",p],function(l){return new l({modelId:a.params.id})})}),l.map("/hourlyPlans/:id;print",P,function(a){n.loadPage(["app/hourlyPlans/pages/HourlyPlanDetailsPrintablePage",p],function(l){return new l({modelId:a.params.id})})}),l.map("/hourlyPlans/:id;delete",d,t.bind(null,u))});