// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../socket","../core/Model","../core/Collection","../data/orgUnits","./util/shift","./DailyMrpPlan"],function(e,n,t,r,i,a,o,s,u){"use strict";return a.extend({model:u,comparator:"mrp",initialize:function(){this.options=new i(JSON.parse(localStorage.getItem("PLANNING:OPTIONS")||"{}")),this.options.on("change",function(){localStorage.setItem("PLANNING:OPTIONS",JSON.stringify(this.toJSON()))})},subscribe:function(e){return e.subscribe("dailyMrpPlans.imported",this.handleImportedMessage.bind(this)),e.subscribe("dailyMrpPlans.updated",this.handleUpdatedMessage.bind(this)),this},getCurrentFilter:function(){var e={date:"",mrp:[]};return this.rqlQuery.selector.args.forEach(function(n){var t=n.args[0];("eq"===n.name&&"date"===t||"in"===n.name&&"mrp"===t)&&(e[t]=n.args[1])}),e},setCurrentFilter:function(n){n=e.assign(this.getCurrentFilter(),n),this.rqlQuery.selector.args=[{name:"eq",args:["date",n.date]},{name:"in",args:["mrp",n.mrp]}]},hasRequiredFilters:function(){var e=this.rqlQuery.selector.args.filter(function(e){return"eq"===e.name&&"date"===e.args[0]||"in"===e.name&&"mrp"===e.args[0]});return 2===e.length},"import":function(r){var i=this,a=n.ajax({method:"POST",url:"/dailyMrpPlans;import",data:JSON.stringify({instanceId:window.INSTANCE_ID,dailyMrpPlans:r})});return a.done(function(n){e.forEach(r,function(e){e.set("updatedAt",n[e.id],{silent:!0})}),i.trigger("import",{date:t.format(r[0].date,"YYYY-MM-DD"),mrp:r.map(function(e){return e.mrp.id})}),i.reset(r)}),a},update:function(e,t,r){return n.ajax({method:"POST",url:"/dailyMrpPlans;update",data:JSON.stringify({instanceId:window.INSTANCE_ID,action:e,planId:t,data:r})})},saveLines:function(){return n.when.apply(n,this.map(function(e){return e.saveLines()}))},setHourlyPlans:function(t){var r=this;if(!r.length)return n.when();var i={};r.forEach(function(n){(!t||t(n))&&n.lines.forEach(function(n){var t=o.getByTypeAndId("prodLine",n.id);if(t){var r=o.getAllForProdLine(t),a=r.division,u=r.prodFlow;if(a&&u){var d=i[a];d||(d=i[a]={});var l=d[u];l||(l=d[u]=s.EMPTY_HOURLY_PLAN.slice()),e.forEach(n.get("hourlyPlan"),function(e,n){l[n]+=e})}}})});var a=r.at(0).date.toISOString(),u=1,d=[];return e.forEach(i,function(e,n){d.push(r.setHourlyPlan(n,a,u,e))}),n.when.apply(n,d)},setHourlyPlan:function(e,t,i,a){var o=n.Deferred(),s={division:e,date:t,shift:i};return r.emit("hourlyPlans.findOrCreate",s,function(e,t){if(e)return o.reject(e);var i=n.ajax({url:"/hourlyPlans/"+t});i.fail(function(){o.reject(new Error("FIND_HOURLY_PLAN_FAILURE"))}),i.done(function(e){var i=[];e.flows.forEach(function(e,u){var d=a[e.id];if(d){var l=n.Deferred();s={type:"counts",socketId:r.getId(),_id:t,flowIndex:u,newValues:d},r.emit("hourlyPlans.updateCounts",s,function(e){e?l.reject(e):o.resolve()}),i.push(l.promise())}}),n.when.apply(n,i).then(function(){o.resolve()},function(e){o.reject(e)})})}),o.promise()},handleImportedMessage:function(t){if(t.instanceId!==window.INSTANCE_ID){var r=this,i=e.intersection(t.plans,r.map(function(e){return e.id}));e.forEach(i,function(e){r.get(e).importing()}),n.ajax({url:"/dailyMrpPlans?_id=in=("+i.join(",")+")"}).done(function(n){e.forEach(n.collection,function(e){var n=r.get(e._id);n&&n.imported(e)})})}},handleUpdatedMessage:function(e){var n=this.get(e.planId);n&&n.update(e)}})});