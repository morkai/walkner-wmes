// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../socket","../core/Model","../core/Collection","../data/orgUnits","./util/shift","./DailyMrpPlan"],function(n,t,e,r,i,a,o,s,u){"use strict";return a.extend({model:u,comparator:"mrp",initialize:function(){this.options=new i(JSON.parse(localStorage.getItem("PLANNING:OPTIONS")||"{}")),this.options.on("change",function(){localStorage.setItem("PLANNING:OPTIONS",JSON.stringify(this.toJSON()))})},subscribe:function(n){return n.subscribe("dailyMrpPlans.imported",this.handleImportedMessage.bind(this)),n.subscribe("dailyMrpPlans.updated",this.handleUpdatedMessage.bind(this)),this},hasRequiredFilters:function(){var n=this.rqlQuery.selector.args.filter(function(n){return"eq"===n.name&&"date"===n.args[0]||"in"===n.name&&"mrp"===n.args[0]});return 2===n.length},"import":function(r){var i=this,a=t.ajax({method:"POST",url:"/dailyMrpPlans;import",data:JSON.stringify({instanceId:window.INSTANCE_ID,dailyMrpPlans:r})});return a.done(function(t){n.forEach(r,function(n){n.set("updatedAt",t[n.id],{silent:!0})}),i.trigger("import",{date:e.format(r[0].date,"YYYY-MM-DD"),mrps:r.map(function(n){return n.mrp.id})}),i.reset(r)}),a},update:function(n,e,r){return t.ajax({method:"POST",url:"/dailyMrpPlans;update",data:JSON.stringify({instanceId:window.INSTANCE_ID,action:n,planId:e,data:r})})},saveLines:function(){return t.when.apply(t,this.map(function(n){return n.saveLines()}))},setHourlyPlans:function(){var e=this;if(!e.length)return t.when();var r={};e.forEach(function(t){t.lines.forEach(function(t){var e=o.getByTypeAndId("prodLine",t.id);if(e){var i=o.getAllForProdLine(e),a=i.division,u=i.prodFlow;if(a&&u){var d=r[a];d||(d=r[a]={});var l=d[u];l||(l=d[u]=s.EMPTY_HOURLY_PLAN.slice()),n.forEach(t.get("hourlyPlan"),function(n,t){l[t]+=n})}}})});var i=e.at(0).date.toISOString(),a=1,u=[];return n.forEach(r,function(t,r){u.push(e.setHourlyPlan(r,i,a,t)),n.forEach(t,function(n,t){})}),t.when.apply(t,u)},setHourlyPlan:function(n,e,i,a){var o=t.Deferred(),s={division:n,date:e,shift:i};return r.emit("hourlyPlans.findOrCreate",s,function(n,e){if(n)return o.reject(n);var i=t.ajax({url:"/hourlyPlans/"+e});i.fail(function(){o.reject(new Error("FIND_HOURLY_PLAN_FAILURE"))}),i.done(function(n){var i=[];n.flows.forEach(function(n,u){var d=a[n.id];if(d){var l=t.Deferred();s={type:"counts",socketId:r.getId(),_id:e,flowIndex:u,newValues:d},r.emit("hourlyPlans.updateCounts",s,function(n){n?l.reject(n):o.resolve()}),i.push(l.promise())}}),t.when.apply(t,i).then(function(){o.resolve()},function(n){o.reject(n)})})}),o.promise()},handleImportedMessage:function(e){if(e.instanceId!==window.INSTANCE_ID){var r=this,i=n.intersection(e.plans,r.map(function(n){return n.id}));n.forEach(i,function(n){r.get(n).importing()}),t.ajax({url:"/dailyMrpPlans?_id=in=("+i.join(",")+")"}).done(function(t){n.forEach(t.collection,function(n){var t=r.get(n._id);t&&t.imported(n)})})}},handleUpdatedMessage:function(n){var t=this.get(n.planId);t&&t.update(n)}})});