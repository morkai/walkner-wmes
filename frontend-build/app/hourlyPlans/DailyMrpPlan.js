// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","backbone","../i18n","../time","../core/Model","../data/orgUnits","../mrpControllers/MrpController","./util/generateDailyMrpPlan","./DailyMrpPlanOrderCollection","./DailyMrpPlanLineCollection"],function(t,e,i,r,n,s,d,a,o,u){"use strict";return n.extend({urlRoot:"/dailyMrpPlans",url:function(){return"/dailyMrpPlans/"+encodeURIComponent(this.date.toISOString())+"/"+encodeURIComponent(this.mrp.id)},initialize:function(t){this.updateQueue=null,this.date=new Date(t.date),this.mrp=s.getByTypeAndId("mrpController",t.mrp)||new d({_id:t.mrp,description:"?"}),this.id||this.set("_id",this.constructor.generateId(this.date,this.mrp.id)),this.orders=new o(t.orders,{plan:this}),this.lines=new u(t.lines,{plan:this})},toJSON:function(){return{_id:this.id,updatedAt:this.get("updatedAt"),date:this.date.toISOString(),mrp:this.mrp.id,orders:this.orders.toJSON(),lines:this.lines.toJSON()}},importing:function(){this.updateQueue=[]},imported:function(e){e.updatedAt>this.get("updatedAt")&&(this.set("updatedAt",e.updatedAt,{silent:!0}),this.orders.reset(e.orders));var i=this.updateQueue;this.updateQueue=null,t.forEach(i,this.update,this)},update:function(t){if(this.updateQueue)return void this.updateQueue.push(t);if(!(t.updatedAt<=this.get("updatedAt"))){var e=t.instanceId===window.INSTANCE_ID;switch(this.attributes.updatedAt=t.updatedAt,t.action){case"resetLines":e||this.lines.reset(t.data.lines,{skipGenerate:!0});break;case"updateLine":var i=this.lines.get(t.data._id);i&&i.set(t.data);break;case"resetOrders":e||this.orders.reset(t.data.orders,{skipGenerate:!0});break;case"updateOrder":var r=this.orders.get(t.data._id);r&&r.set(t.data)}}},saveLines:function(){var t=this,e=t.collection.update("resetLines",t.id,{lines:t.lines.toJSON()});return t.trigger("request",this,e,{syncMethod:"read"}),e.fail(function(){t.trigger("error")}),e.done(function(){t.trigger("sync")}),e},generate:function(){a(this,this.collection.settings.getPlanGeneratorSettings())&&this.trigger("generated")}},{generateId:function(t,e){return r.getMoment(t).format("YYMMDD")+"-"+e}})});