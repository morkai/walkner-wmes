// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../core/Collection","./util/shift","./DailyMrpPlanLineOrder"],function(e,n,r){"use strict";return e.extend({model:r,initialize:function(e,n){this.line=n.line},serializeShifts:function(){var e=this.line,r=this.line.collection.plan,t=r.collection,i=this.map(function(e){return{plan:r.id,mrp:r.mrp.id,lineOrder:e}});t.forEach(function(n){if(n!==r){var t=n.lines.get(e.id);t&&t.orders.forEach(function(e){i.push({plan:n.id,mrp:n.mrp.id,lineOrder:e})})}}),i>this.length&&i.sort(function(e,n){return e.lineOrder.startMoment.valueOf()-n.lineOrder.startMoment.valueOf()});for(var l={1:[],2:[],3:[]},o=0;o<i.length;++o){var a=i[o],d=a.plan,s=a.lineOrder,h=l[s.shiftNo],u=h[h.length-1],f=u?u.lineOrder.finishMoment.valueOf():n.getShiftStartTime(s.startMoment.valueOf());h.push({_id:s.id,orderNo:s.get("orderNo"),qty:s.get("qty"),margin:100*(s.startMoment.valueOf()-f)/n.SHIFT_DURATION,width:100*s.duration/n.SHIFT_DURATION,incomplete:s.get("incomplete"),lineOrder:s,plan:d,mrp:a.mrp,external:d!==r.id})}var p=[];return l[1].length&&p.push({no:1,orders:l[1]}),l[2].length&&p.push({no:2,orders:l[2]}),l[3].length&&p.push({no:3,orders:l[3]}),p}})});