// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../core/Model","../data/orgUnits","./util/shift","./DailyMrpPlanLineOrderCollection"],function(t,e,i,o,n,r){"use strict";return i.extend({defaults:function(){return{name:"?",activeFrom:null,activeTo:null,workerCount:0,hourlyPlan:n.EMPTY_HOURLY_PLAN.slice(),pceTimes:[],totalQty:0,orders:[],downtimes:[]}},initialize:function(t){this.orders=new r(t.orders,{line:this})},toJSON:function(){return t.defaults({orders:this.orders.toJSON()},this.attributes)},serializeListItem:function(){return{_id:this.id,name:this.get("name"),workerCount:this.get("workerCount"),customTimes:this.serializeCustomTimes()}},serializePopover:function(){var t=o.getAllForProdLine(this.id);return{_id:this.id,plan:this.collection.plan.id,division:t.division,prodFlow:o.getByTypeAndId("prodFlow",t.prodFlow).getLabel(),prodLine:this.get("name"),activeFrom:this.get("activeFrom"),activeTo:this.get("activeTo"),workerCount:this.get("workerCount")}},serializeCustomTimes:function(){var t=this.get("activeFrom"),e=this.get("activeTo");return t||e?(t||"06:00")+"-"+(e||"06:00"):""},hasCustomTimes:function(){return!!this.get("activeFrom")||!!this.get("activeTo")},getActiveFromMoment:function(t){return this.constructor.getActiveFromMoment(t?+t:+this.collection.plan.date,this.get("activeFrom"))},getActiveToMoment:function(t){return this.constructor.getActiveToMoment(t?+t:+this.collection.plan.date,this.get("activeTo"))},update:function(i){var o=e.getMoment("2017-01-01 "+(i.activeFrom||"06:00"),"YYYY-MM-DD HH:mm"),n=e.getMoment("2017-01-01 "+(i.activeTo||"06:00"),"YYYY-MM-DD HH:mm");o.isValid()||(o=e.getMoment("2017-01-01T05:00:00.000Z")),n.isValid()||(n=e.getMoment("2017-01-02T05:00:00.000Z"));var r=o.format("HH:mm"),s=n.format("HH:mm"),a={_id:this.id,activeFrom:"06:00"===r?null:r,activeTo:"06:00"===s?null:s,workerCount:i.workerCount>0?i.workerCount:0},c=this.attributes;t.some(a,function(t,e){return c[e]!==t})&&this.collection.plan.collection.update("updateLine",this.collection.plan.id,a)},reset:function(){this.set({hourlyPlan:n.EMPTY_HOURLY_PLAN.slice(),pceTimes:[],totalQty:0,orders:[],downtimes:[]}),this.orders.reset([])}},{getActiveFromMoment:function(t,i){var o=e.getMoment(+t),n=6,r=0;if(i){var s=i.split(":");n=+s[0],r=+s[1]}return n<6&&o.add(1,"days"),o.hours(n).minutes(r),o},getActiveToMoment:function(t,i){var o=e.getMoment(+t),n=6,r=0;if(i){var s=i.split(":");n=+s[0],r=+s[1]}return(n<6||6===n&&0===r)&&o.add(1,"days"),o.hours(n).minutes(r),o}})});