// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../core/Model","../data/orgUnits","./util/shift","./DailyMrpPlanLineOrderCollection"],function(t,e,i,o,r,n){"use strict";return i.extend({defaults:function(){return{name:"?",activeFrom:null,activeTo:null,workerCount:0,hourlyPlan:r.EMPTY_HOURLY_PLAN.slice(),pceTimes:[],totalQty:0,orders:[]}},initialize:function(t){this.orders=new n(t.orders,{line:this})},toJSON:function(){return t.defaults({orders:this.orders.toJSON()},this.attributes)},serializeListItem:function(){return{_id:this.id,name:this.get("name"),workerCount:this.get("workerCount"),customTimes:this.serializeCustomTimes()}},serializePopover:function(){var t=o.getAllForProdLine(this.id);return{_id:this.id,plan:this.collection.plan.id,division:t.division,prodFlow:o.getByTypeAndId("prodFlow",t.prodFlow).getLabel(),prodLine:this.get("name"),activeFrom:this.get("activeFrom"),activeTo:this.get("activeTo"),workerCount:this.get("workerCount")}},serializeCustomTimes:function(){var t=this.get("activeFrom"),e=this.get("activeTo");return t||e?(t||"06:00")+"-"+(e||"06:00"):""},hasCustomTimes:function(){return!!this.get("activeFrom")||!!this.get("activeTo")},getActiveFromMoment:function(t){var i=e.getMoment(t?+t:+this.collection.plan.date),o=this.get("activeFrom"),r=6,n=0;if(o){var s=o.split(":");r=+s[0],n=+s[1]}return 6>r&&i.add(1,"days"),i.hours(r).minutes(n),i},getActiveToMoment:function(t){var i=e.getMoment(t?+t:+this.collection.plan.date),o=this.get("activeTo"),r=6,n=0;if(o){var s=o.split(":");r=+s[0],n=+s[1]}return(6>r||6===r&&0===n)&&i.add(1,"days"),i.hours(r).minutes(n),i},update:function(i){var o=e.getMoment("2017-01-01 "+(i.activeFrom||"06:00"),"YYYY-MM-DD HH:mm"),r=e.getMoment("2017-01-01 "+(i.activeTo||"06:00"),"YYYY-MM-DD HH:mm");o.isValid()||(o=e.getMoment("2017-01-01T05:00:00.000Z")),r.isValid()||(r=e.getMoment("2017-01-02T05:00:00.000Z"));var n=o.format("HH:mm"),s=r.format("HH:mm"),a={_id:this.id,activeFrom:"06:00"===n?null:n,activeTo:"06:00"===s?null:s,workerCount:i.workerCount>0?i.workerCount:0},l=this.attributes;t.some(a,function(t,e){return l[e]!==t})&&this.collection.plan.collection.update("updateLine",this.collection.plan.id,a)},reset:function(){this.set({hourlyPlan:r.EMPTY_HOURLY_PLAN.slice(),pceTimes:[],totalQty:0,orders:[]}),this.orders.reset([])}})});