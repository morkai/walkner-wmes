// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/views/ListView","app/data/aors","app/data/downtimeReasons","app/prodShifts/ProdShift","app/prodShifts/views/ProdShiftTimelineView","app/prodShiftOrders/ProdShiftOrder","app/prodShiftOrders/ProdShiftOrderCollection","app/prodDowntimes/ProdDowntime","app/prodDowntimes/ProdDowntimeCollection","app/core/templates/userInfo","app/prodChangeRequests/templates/detailsRow","app/prodChangeRequests/templates/quantitiesDone"],function(e,t,i,r,s,o,n,a,d,l,h,c,p,f,m,u,g,w){"use strict";var v={shift:l,order:c,downtime:f},C=["date","shift","master","leader","operator"],R={shift:["quantitiesDone"],order:["orderId","operationNo","quantityDone","workerCount","startedAt","finishedAt"],downtime:["reason","aor","reasonComment","startedAt","finishedAt"]},S={shift:"prodShifts",order:"prodShiftOrders",downtime:"prodDowntimes"};return n.extend({className:function(){return this.collection.isNewStatus()?"":"is-colored"},remoteTopics:{"prodChangeRequests.**":function(){this.showingDetails?this.requiresRefresh=!0:this.refreshCollection()},"prodShiftOrders.**":"handleProdModelChange","prodDowntimes.**":"handleProdModelChange"},events:{"click .list-item[data-id]":function(e){"A"===e.target.tagName||this.el.classList.contains("is-loading")||this.toggleDetails(e.currentTarget.dataset.id)},"click #-accept":function(e){this.confirm(e.currentTarget.dataset.id,"accepted")},"click #-reject":function(e){this.confirm(e.currentTarget.dataset.id,"rejected")}},initialize:function(){n.prototype.initialize.apply(this,arguments),this.timelineView=null,this.requiresRefresh=!1,this.showingDetails=!1,this.$errorMessage=null},destroy:function(){n.prototype.destroy.apply(this,arguments),this.hideErrorMessage()},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.requiresRefresh=!1,this.showingDetails=!1,this.hideErrorMessage()},serializeColumns:function(){var e=this.collection.isNewStatus(),t=[{id:"division",className:"is-min"},{id:"prodLine",className:"is-min"},{id:"operation",className:e?"is-min":""},"creatorComment",{id:"creator",className:"is-min"},{id:"createdAt",className:"is-min"}];return e||t.push("confirmerComment",{id:"confirmer",className:"is-min"},{id:"confirmedAt",className:"is-min"}),t},serializeActions:function(){return null},serializeRows:function(){var e=this;return this.collection.map(function(t){var i=t.get("confirmedAt"),s=t.get("confirmer"),o=t.get("status"),n="accepted"===o?"success":"rejected"===o?"danger":"";return{_id:t.id,className:"prodChangeRequests-list-item "+n,division:t.get("division"),prodLine:t.get("prodLine"),operation:e.serializeOperation(t),createdAt:r.format(t.get("createdAt"),"LLL"),creator:u({userInfo:t.get("creator")}),creatorComment:t.get("creatorComment")||"-",confirmedAt:i?r.format(t.get("confirmedAt"),"LLL"):"-",confirmer:s?u({userInfo:s}):"-",confirmerComment:t.get("confirmerComment")||"-"}})},serializeOperation:function(t){var s=t.get("status"),o=t.get("modelType"),n=t.get("data"),a=t.get("operation"),l=new v[o](e.extend({_id:t.get("modelId")},n)),h="?",c="add"===a||"delete"===a&&"new"!==s?null:l.genClientUrl();switch(o){case"shift":h=i("core","SHIFT",{date:r.format(n.date,"YYYY-MM-DD"),shift:i("core","SHIFT:"+n.shift)});break;case"order":h=l.getLabel(!1);break;case"downtime":if("add"===a){var p=l.get("reason"),f=d.get(p);h=f?f.getLabel():p}else h=l.get("rid")}var m=i("prodChangeRequests","operation:"+a+":"+o,{extra:h});return c?'<a href="'+c+'">'+m+"</a>":m},toggleDetails:function(e){var t=this.$('.list-item[data-id="'+e+'"]'),i=this.$(".is-expanded");this.collapseDetails(i),t[0]===i[0]?this.requiresRefresh&&this.refreshCollectionNow():this.expandDetails(e,t)},collapseDetails:function(e){this.removeView(".prodChangeRequests-timeline"),e.removeClass("is-expanded").next().remove()},expandDetails:function(e,i){var r=this.collection.get(e);if("new"===r.get("status")){var s=t(g({idPrefix:this.idPrefix,showForm:"new"===r.get("status")&&this.isCurrentUserAllowedToConfirm(r),changeRequestId:e,isEdit:"edit"===r.get("operation"),changes:this.serializeChanges(r)}));s.insertAfter(i),i.addClass("is-expanded"),this.showingDetails=!0,this.loadTimeline(r)}},isCurrentUserAllowedToConfirm:function(e){if(!s.isAllowedTo("PROD_DATA:MANAGE","PROD_DATA:CHANGES:MANAGE"))return!1;var t=s.getDivision();return!t||t.id===e.get("division")},serializeChanges:function(t){var r=[],s=t.get("operation");if("delete"===s||"new"!==t.get("status"))return r;var o=t.get("modelType"),n=S[o],a=[].concat(C,R[o]),d=t.get("prodModel"),l=t.get("data"),h=this;return e.forEach(a,function(t){var o=d?d[t]:null,a=l[t];if("edit"!==s||!e.isEqual(o,a)){var c=i(n,"PROPERTY:"+t);if("quantitiesDone"===t)r.push({property:c,value:w({oldQuantitiesDone:o,newQuantitiesDone:a})});else{var p={property:c,oldValue:h.serializeProperty(t,o),newValue:h.serializeProperty(t,a)};p.oldValue!==p.newValue&&r.push(p)}}}),r},serializeProperty:function(e,t){if(null===t||void 0===t||""===t)return"-";switch(e){case"master":case"leader":case"operator":return u({userInfo:t});case"date":return r.format(t,"LL");case"shift":return i("core","SHIFT:"+t);case"startedAt":case"finishedAt":return r.format(t,"LLLL");case"reason":var s=d.get(t);return s?s.getLabel():t;case"aor":var o=a.get(t);return o?o.getLabel():t}return"number"==typeof t?t.toLocaleString():String(t)},confirm:function(e,t){var r=this.collection.get(e);if(r){var s=this.$el.addClass("is-loading"),n=this.$(".prodChangeRequests-details").find(".form-control, .btn").prop("disabled",!0),a=this,d=r.save({status:t,confirmerComment:this.$id("confirmerComment").val().trim()},{method:"POST"});d.done(function(){s.removeClass("is-loading"),a.requiresRefresh=!0,a.toggleDetails(e),o.msg.show({type:"success",time:2500,text:i("prodChangeRequests","confirm:success:"+t)})}),d.fail(function(e){var t=S[r.get("modelType")],o=e.responseJSON?e.responseJSON.error.message:null;o=i.has("prodChangeRequests","confirm:error:"+o)?i("prodChangeRequests","confirm:error:"+o):i.has(t,"FORM:ERROR:"+o)?i(t,"FORM:ERROR:"+o):i("prodChangeRequests","confirm:error"),a.showErrorMessage(o),n.prop("disabled",!1),s.removeClass("is-loading")})}},showErrorMessage:function(e){this.hideErrorMessage(),this.$errorMessage=o.msg.show({type:"error",time:5e3,text:e})},hideErrorMessage:function(){this.$errorMessage&&(o.msg.hide(this.$errorMessage),this.$errorMessage=null)},loadTimeline:function(e){var i=this,r=this.$(".prodChangeRequests-timeline");return this.cancelRequests(),"add"===e.get("operation")&&"shift"===e.get("modelType")?r.remove():void this.resolveProdShift(e,function(s){if(!s)return r.removeClass("progress-bar-primary active").addClass("progress-bar-danger");var o=new p(null,{rqlQuery:"sort(startedAt)&prodShift="+s.id}),n=new m(null,{rqlQuery:"sort(startedAt)&prodShift="+s.id}),a=t.when(i.promised(o.fetch({reset:!0})),i.promised(n.fetch({reset:!0})));a.fail(function(){r.removeClass("progress-bar-primary active").addClass("progress-bar-danger")}),a.done(function(){i.renderTimeline(s,o,n,e)})})},resolveProdShift:function(e,t){var i=e.get("modelType"),r=e.get("prodModel"),s=e.get("data");if("shift"===i)return t(new l(r));var o=new l({_id:r?r.prodShift:s.prodShift}),n=this.promised(o.fetch());n.fail(function(){t(null)}),n.done(function(){t(o)})},renderTimeline:function(e,t,i,r){this.timelineView=new h({editable:!0,resizable:!0,itemHeight:30,prodShift:e,prodShiftOrders:t,prodDowntimes:i}),this.setView(".prodChangeRequests-timeline",this.timelineView),this.timelineView.render(),this.timelineView.highlightItem(r.get("modelId"))},handleProdModelChange:function(e,t){if(this.timelineView){var i=t.split("."),r=i[0],s="prodShiftOrders"===r?this.timelineView.prodShiftOrders:this.timelineView.prodDowntimes;if(e.prodShift){if(e.prodShift!==this.timelineView.prodShift.id)return}else{var o=i[2];if(o&&!s.get(o))return}this.promised(s.fetch())}}})});