// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/views/ListView","app/data/aors","app/data/downtimeReasons","app/data/orgUnits","app/data/companies","app/data/prodFunctions","app/prodShifts/ProdShift","app/prodShifts/views/ProdShiftTimelineView","app/prodShiftOrders/ProdShiftOrder","app/prodShiftOrders/ProdShiftOrderCollection","app/prodDowntimes/ProdDowntime","app/prodDowntimes/ProdDowntimeCollection","app/fte/FteMasterEntry","app/fte/FteLeaderEntry","app/core/templates/userInfo","app/prodChangeRequests/templates/detailsRow","app/prodChangeRequests/templates/quantitiesDone"],function(e,t,i,r,s,a,o,n,d,l,c,p,h,f,u,m,g,w,v,C,y,S,R){"use strict";var A={shift:h,order:u,downtime:g,fteMaster:v,fteLeader:C},L=["date","shift","master","leader","operator"],D={shift:["quantitiesDone"],order:["orderId","operationNo","quantityDone","workerCount","startedAt","finishedAt"],downtime:["reason","aor","reasonComment","startedAt","finishedAt"]},T={shift:"prodShifts",order:"prodShiftOrders",downtime:"prodDowntimes",fteMaster:"fte",fteLeader:"fte"};return o.extend({className:function(){return this.collection.isNewStatus()?"":"is-colored"},remoteTopics:{"prodChangeRequests.**":function(){this.showingDetails?this.requiresRefresh=!0:this.refreshCollection()},"prodShiftOrders.**":"handleProdModelChange","prodDowntimes.**":"handleProdModelChange"},events:{"click .list-item[data-id]":function(e){"A"===e.target.tagName||this.el.classList.contains("is-loading")||this.toggleDetails(e.currentTarget.dataset.id)},"click #-accept":function(e){this.confirm(e.currentTarget.dataset.id,"accepted")},"click #-reject":function(e){this.confirm(e.currentTarget.dataset.id,"rejected")}},initialize:function(){o.prototype.initialize.apply(this,arguments),this.timelineView=null,this.requiresRefresh=!1,this.showingDetails=!1,this.$errorMessage=null},destroy:function(){o.prototype.destroy.apply(this,arguments),this.hideErrorMessage()},afterRender:function(){o.prototype.afterRender.apply(this,arguments),this.requiresRefresh=!1,this.showingDetails=!1,this.hideErrorMessage()},serializeColumns:function(){var e=this.collection.isNewStatus(),t=[{id:"division",className:"is-min"},{id:"orgUnit",className:"is-min"},{id:"operation",className:e?"is-min":""},"creatorComment",{id:"creator",className:"is-min"},{id:"createdAt",className:"is-min"}];return e||t.push("confirmerComment",{id:"confirmer",className:"is-min"},{id:"confirmedAt",className:"is-min"}),t},serializeActions:function(){return null},serializeRows:function(){var e=this;return this.collection.map(function(t){var i=t.get("confirmedAt"),s=t.get("confirmer"),a=t.get("status"),o="accepted"===a?"success":"rejected"===a?"danger":"";return{_id:t.id,className:"prodChangeRequests-list-item "+o,division:t.get("division"),orgUnit:e.serializeOrgUnit(t),operation:e.serializeOperation(t),createdAt:r.format(t.get("createdAt"),"LLL"),creator:y({userInfo:t.get("creator")}),creatorComment:t.get("creatorComment")||"-",confirmedAt:i?r.format(t.get("confirmedAt"),"LLL"):"-",confirmer:s?y({userInfo:s}):"-",confirmerComment:t.get("confirmerComment")||"-"}})},serializeOrgUnit:function(e){if(e.isFte()){var t=l.getByTypeAndId("subdivision",e.get("data").subdivision);return t?t.getLabel():"?"}return e.get("prodLine")},serializeOperation:function(t){var s=t.get("status"),a=t.get("modelType"),o=t.get("data"),n=t.get("operation"),l=new A[a](e.extend({_id:t.get("modelId")},o)),c="?",p="add"===n||"delete"===n&&"new"!==s?null:l.genClientUrl();switch(a){case"shift":c=i("core","SHIFT",{date:r.format(o.date,"L"),shift:i("core","SHIFT:"+o.shift)});break;case"order":c=l.getLabel(!1);break;case"downtime":if("add"===n){var h=l.get("reason"),f=d.get(h);c=f?f.getLabel():h}else c=l.get("rid");break;case"fteMaster":case"fteLeader":var u=r.getMoment(o.date),m=u.hours();c=i("core","SHIFT",{date:u.format("L"),shift:i("core","SHIFT:"+(6===m?1:14===m?2:3))})}var g=i("prodChangeRequests","operation:"+n+":"+a,{extra:c});return p?'<a href="'+p+'">'+g+"</a>":g},toggleDetails:function(e){var t=this.$('.list-item[data-id="'+e+'"]'),i=this.$(".is-expanded");this.collapseDetails(i),t[0]===i[0]?this.requiresRefresh&&this.refreshCollectionNow():this.expandDetails(e,t)},collapseDetails:function(e){this.removeView(".prodChangeRequests-timeline"),e.removeClass("is-expanded").next().remove()},expandDetails:function(e,i){var r=this.collection.get(e);if("new"===r.get("status")){var s=t(S({idPrefix:this.idPrefix,showForm:"new"===r.get("status")&&this.isCurrentUserAllowedToConfirm(r),changeRequestId:e,isEdit:"edit"===r.get("operation"),isFte:r.isFte(),changes:this.serializeChanges(r)}));s.insertAfter(i),i.addClass("is-expanded"),this.showingDetails=!0,this.loadTimeline(r)}},isCurrentUserAllowedToConfirm:function(e){if(!s.isAllowedTo("PROD_DATA:MANAGE","PROD_DATA:CHANGES:MANAGE"))return!1;var t=s.getDivision();return!t||t.id===e.get("division")},serializeChanges:function(e){return"delete"===e.get("operation")||"new"!==e.get("status")?[]:e.isFte()?this.serializeFteChanges(e):this.serializePropertyChanges(e)},serializePropertyChanges:function(t){var r=[],s=t.get("operation"),a=t.get("modelType"),o=T[a],n=[].concat(L,D[a]),d=t.get("prodModel"),l=t.get("data"),c=this;return e.forEach(n,function(t){var a=d?d[t]:null,n=l[t];if("edit"!==s||!e.isEqual(a,n)){var p=i(o,"PROPERTY:"+t);if("quantitiesDone"===t)r.push({property:p,value:R({oldQuantitiesDone:a,newQuantitiesDone:n})});else{var h={property:p,oldValue:c.serializeProperty(t,a),newValue:c.serializeProperty(t,n)};h.oldValue!==h.newValue&&r.push(h)}}}),r},serializeProperty:function(e,t){if(null===t||void 0===t||""===t)return"-";switch(e){case"master":case"leader":case"operator":return y({userInfo:t});case"date":return r.format(t,"LL");case"shift":return i("core","SHIFT:"+t);case"startedAt":case"finishedAt":return r.format(t,"LLLL");case"reason":var s=d.get(t);return s?s.getLabel():t;case"aor":var a=n.get(t);return a?a.getLabel():t}return"number"==typeof t?t.toLocaleString():String(t)},serializeFteChanges:function(t){var i={},r=null;return e.forEach(t.get("data").changes,function(e){r=i[e.taskId],r||(r=i[e.taskId]={id:e.taskId,name:e.taskName,values:[]});var s=p.get(e.functionId),a=c.get(e.companyId),o=l.getByTypeAndId("division",e.divisionId);r.values.push({kind:"fteMaster"===t.get("modelType")?e.kind||(e.demand?"demand":"supply"):null,function:s?s.getLabel():e.functionId,company:a?a.getLabel():e.companyId,division:o?o.getLabel():null,old:e.oldValue.toLocaleString(),new:e.newValue.toLocaleString()})}),e.values(i)},confirm:function(e,t){var r=this.collection.get(e);if(r){var s=this.$el.addClass("is-loading"),o=this.$(".prodChangeRequests-details").find(".form-control, .btn").prop("disabled",!0),n=this,d=r.save({status:t,confirmerComment:this.$id("confirmerComment").val().trim()},{method:"POST",wait:!0});d.done(function(){s.removeClass("is-loading"),n.requiresRefresh=!0,n.toggleDetails(e),a.msg.show({type:"success",time:2500,text:i("prodChangeRequests","confirm:success:"+t)})}),d.fail(function(e){var t=T[r.get("modelType")],a=e.responseJSON?e.responseJSON.error.message:null;a=i.has("prodChangeRequests","confirm:error:"+a)?i("prodChangeRequests","confirm:error:"+a):i.has(t,"FORM:ERROR:"+a)?i(t,"FORM:ERROR:"+a):i("prodChangeRequests","confirm:error"),n.showErrorMessage(a),o.prop("disabled",!1),s.removeClass("is-loading")})}},showErrorMessage:function(e){this.hideErrorMessage(),this.$errorMessage=a.msg.show({type:"error",time:5e3,text:e})},hideErrorMessage:function(){this.$errorMessage&&(a.msg.hide(this.$errorMessage),this.$errorMessage=null)},loadTimeline:function(e){var i=this,r=e.get("modelType"),s=this.$(".prodChangeRequests-timeline");return this.cancelRequests(),e.isFte()||"add"===e.get("operation")&&"shift"===r?s.remove():void this.resolveProdShift(e,function(r){if(!r)return s.removeClass("progress-bar-primary active").addClass("progress-bar-danger");var a=new m(null,{rqlQuery:"sort(startedAt)&prodShift="+r.id}),o=new w(null,{rqlQuery:"sort(startedAt)&prodShift="+r.id}),n=t.when(i.promised(a.fetch({reset:!0})),i.promised(o.fetch({reset:!0})));n.fail(function(){s.removeClass("progress-bar-primary active").addClass("progress-bar-danger")}),n.done(function(){"add"===e.get("operation")&&("order"===e.get("modelType")?a.add(e.get("data")):o.add(e.get("data"))),i.renderTimeline(r,a,o,e)})})},resolveProdShift:function(e,t){var i=e.get("modelType"),r=e.get("prodModel"),s=e.get("data");if("shift"===i)return t(new h(r));var a=new h({_id:r?r.prodShift:s.prodShift}),o=this.promised(a.fetch());o.fail(function(){t(null)}),o.done(function(){t(a)})},renderTimeline:function(e,t,i,r){this.timelineView=new f({editable:!0,resizable:!0,itemHeight:30,prodShift:e,prodShiftOrders:t,prodDowntimes:i}),this.setView(".prodChangeRequests-timeline",this.timelineView),this.timelineView.render(),this.timelineView.highlightItem(r.getModelId())},handleProdModelChange:function(e,t){if(this.timelineView){var i=t.split("."),r=i[0],s="prodShiftOrders"===r?this.timelineView.prodShiftOrders:this.timelineView.prodDowntimes;if(e.prodShift){if(e.prodShift!==this.timelineView.prodShift.id)return}else{var a=i[2];if(a&&!s.get(a))return}this.promised(s.fetch())}}})});