define(["app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/buttonGroup","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/util/userInfoDecorator","app/wmes-osh-brigades/templates/form"],function(e,t,s,i,a,o,l,r,d){"use strict";return i.extend({template:d,events:Object.assign({"change #-date":"loadExisting","change #-leader":function(){this.updateOrgUnits(),this.loadExisting()},"change #-workplace":function(){this.$id("department").val(""),this.setUpDepartmentSelect2()}},i.prototype.events),serializeToForm:function(){const e=this.model.get("date"),s=this.model.get("leader");return{date:e?t.utc.format(e,"YYYY-MM"):"",shift:this.model.get("shift")||1,workplace:s?s.oshWorkplace:"",department:s?s.oshDepartment:""}},serializeForm:function(e){this.options.editMode?e.leader=this.model.get("leader"):(e.date+="-01T00:00:00Z",e.leader=o.getUserInfo(this.$id("leader")));const t=this.$id("workplace").select2("data").model,s=this.$id("department").select2("data").model;return e.leader.oshDivision=t.get("division"),e.leader.oshWorkplace=t.id,e.leader.oshDepartment=s.id,e.members=o.getUserInfo(this.$id("members")),e},afterRender:function(){i.prototype.afterRender.apply(this,arguments),this.setUpLeaderSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpMembersSelect2(),a.toggle(this.$id("shift"))},setUpLeaderSelect2:function(){const t=e.isAllowedTo("OSH:HR:MANAGE");let s=this.model.get("leader");s||t||(s={id:e.data._id,label:e.getLabel(),user:e.data});const i=o(this.$id("leader"),{width:"100%",allowClear:!1,currentUserInfo:s,noPersonnelId:!0,userInfoDecorators:[r]});t||i.select2("enable",!1)},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");let t=l.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const s={};l.workplaces.forEach(e=>{e.get("active")&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!s[t.id]&&(s[t.id]=t),e.select2({width:"100%",data:Object.values(s).sort((e,t)=>e.text.localeCompare(t.text))})},setUpDepartmentSelect2:function(){const e=this.$id("department"),t=+this.$id("workplace").val();let s=l.departments.get(+e.val());s&&(s={id:s.id,text:s.getLabel({long:!0}),model:s});const i={};l.departments.forEach(e=>{e.get("active")&&e.hasWorkplace(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),s&&!i[s.id]&&(i[s.id]=s);const a=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("wmes-osh-common","FORM:placeholder:noWorkplace"),data:a}),1===a.length?e.select2("data",a[0]):i[e.val()]||e.val("").select2("data",null),e.select2("enable",!!a.length)},setUpMembersSelect2:function(){o(this.$id("members"),{width:"100%",multiple:!0,currentUserInfo:this.model.get("members"),noPersonnelId:!0})},loadExisting:function(){if(!this.$id("date").val())return;const e=t.utc.getMoment(`${this.$id("date").val()}-01`,"YYYY-MM-DD");if(!e.isValid())return;const i=this.$id("leader").val();if(!i.length)return;const a=o.getUserInfo(this.$id("leader"));s.msg.loading();const l=this.ajax({url:`/osh/brigades?date<=${e.valueOf()}&leader.id=${i}&sort(-date)&limit(1)`});l.fail(()=>{s.msg.loadingFailed()}),l.done(t=>{s.msg.loaded();const i=t.collection&&t.collection[0]||{};i.date!==e.toISOString()&&(i._id=void 0),i.date=e.toISOString(),i.leader=a,this.model.set(i,{silent:!0}),this.render()})},updateOrgUnits:function(){const e=o.getUserInfo(this.$id("leader"))||{oshWorkplace:"",oshDepartment:""};this.$id("workplace").val(e.oshWorkplace||""),this.$id("department").val(e.oshDepartment||""),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2()}})});