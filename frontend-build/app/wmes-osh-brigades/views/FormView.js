define(["app/user","app/time","app/viewport","app/core/views/FormView","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-brigades/templates/form"],function(e,t,i,s,n,r,o){"use strict";return s.extend({template:o,events:Object.assign({"change #-date":"loadExisting","change #-leader":"loadExisting"},s.prototype.events),getTemplateData:function(){return{}},serializeToForm:function(){const e=this.model.get("date");return{date:e?t.utc.format(e,"YYYY-MM"):""}},serializeForm:function(e){return this.options.editMode||(e.date+="-01T00:00:00Z",e.leader=n.getUserInfo(this.$id("leader"))),e.members=n.getUserInfo(this.$id("members")),e},afterRender:function(){s.prototype.afterRender.apply(this,arguments),this.setUpLeaderSelect2(),this.setUpMembersSelect2()},setUpLeaderSelect2:function(){const t=e.isAllowedTo("OSH:HR:MANAGE");let i=this.model.get("leader");i||t||(i={id:e.data._id,label:e.getLabel(),user:e.data});const s=n(this.$id("leader"),{width:"100%",currentUserInfo:i,noPersonnelId:!0});t||s.select2("enable",!1)},setUpMembersSelect2:function(){n(this.$id("members"),{width:"100%",multiple:!0,currentUserInfo:this.model.get("members"),noPersonnelId:!0})},loadExisting:function(){if(!this.$id("date").val())return;const e=t.utc.getMoment(`${this.$id("date").val()}-01`,"YYYY-MM-DD");if(!e.isValid())return;const s=this.$id("leader").val();if(!s.length)return;const r=n.getUserInfo(this.$id("leader"));i.msg.loading();const o=this.ajax({url:`/osh/brigades?date<=${e.valueOf()}&leader.id=${s}&sort(-date)&limit(1)`});o.fail(()=>{i.msg.loadingFailed()}),o.done(t=>{i.msg.loaded();const s=t.collection&&t.collection[0]||{};s.date!==e.toISOString()&&(s._id=void 0),s.date=e.toISOString(),s.leader=r,this.model.set(s,{silent:!0}),this.render()})}})});