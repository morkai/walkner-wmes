// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../user","../core/Model","app/kaizenOrders/dictionaries","app/core/templates/userInfo"],function(e,t,r,i,n,a,s){"use strict";var o=["date"],u=["createdAt","updatedAt"],f=["creator","updater","observer","superior"];return n.extend({urlRoot:"/behaviorObsCards",clientUrlRoot:"#behaviorObsCards",topicPrefix:"behaviorObsCards",privilegePrefix:"KAIZEN",nlsDomain:"behaviorObsCards",labelAttribute:"rid",defaults:function(){return{date:new Date}},serialize:function(e){var i=e&&e.longDateTime,n=i?"LL":"L",c=i?"LLLL":"L, LTS",d=this.toJSON();return d.section=a.sections.getLabel(d.section),d.observerSection=a.sections.getLabel(d.observerSection),o.forEach(function(e){d[e]=d[e]?r.format(d[e],n):null}),u.forEach(function(e){d[e]=d[e]?r.format(d[e],c):null}),f.forEach(function(e){d[e]=s({userInfo:d[e]})}),d.shift&&(d.date=t("core","SHIFT",{date:d.date,shift:d.shift})),d},serializeRow:function(t){var r=this.serialize(t);if(r.observations.length){var i=e.find(r.observations,function(e){return!e.safe&&!e.easy});i||(i=e.find(r.observations,function(e){return!e.safe})),r.observation=i?i.observation||i.behavior:""}if(r.risks.length){var n=e.find(r.risks,function(e){return!e.easy});n||(n=r.risks[0]),r.risk=n?n.risk:""}return r.difficulties.length&&r.difficulties.forEach(function(e){!r.hardBehavior&&e.behavior?r.hardBehavior=e.problem:r.hardCondition||e.behavior||(r.hardCondition=e.problem)}),r},serializeDetails:function(){return this.serialize({longDateTime:!0})},isCreator:function(){return this.attributes.creator&&this.attributes.creator.id===i.data._id},canEdit:function(){return!!i.isAllowedTo(this.privilegePrefix+":MANAGE")||!!this.isCreator()&&Date.now()-Date.parse(this.get("updatedAt")||this.get("createdAt"))<864e5},canDelete:function(){return!!i.isAllowedTo(this.privilegePrefix+":MANAGE")||!!this.isCreator()&&Date.now()-Date.parse(this.get("updatedAt")||this.get("createdAt"))<288e5},hasAnyEasy:function(){return e.any(this.get("observations"),function(e){return!e.safe&&e.easy})||e.any(this.get("risks"),function(e){return e.easy})}})});