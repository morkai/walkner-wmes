// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../user","../core/Model","app/kaizenOrders/dictionaries","app/core/templates/userInfo"],function(e,r,i,t,n,a){"use strict";var o=["date"],s=["createdAt","updatedAt"],u=["creator","updater","observer","superior"];return t.extend({urlRoot:"/behaviorObsCards",clientUrlRoot:"#behaviorObsCards",topicPrefix:"behaviorObsCards",privilegePrefix:"KAIZEN",nlsDomain:"behaviorObsCards",labelAttribute:"rid",defaults:function(){return{date:new Date}},serialize:function(e){var i=e&&e.longDateTime,t=i?"LL":"L",f=i?"LLLL":"L, LTS",c=this.toJSON();return c.section=n.sections.getLabel(c.section),o.forEach(function(e){c[e]=c[e]?r.format(c[e],t):null}),s.forEach(function(e){c[e]=c[e]?r.format(c[e],f):null}),u.forEach(function(e){c[e]=a({userInfo:c[e]})}),c},serializeRow:function(r){var i=this.serialize(r);if(i.observations.length){var t=e.find(i.observations,function(e){return!e.safe&&!e.easy});t||(t=e.find(i.observation,function(e){return!e.safe})),i.observation=t?t.observation||t.behavior:""}if(i.risks.length){var n=e.find(i.risks,function(e){return!e.easy});n||(n=i.risks[0]),i.risk=n?n.risk:""}return i.difficulties.length&&i.difficulties.forEach(function(e){!i.hardBehavior&&e.behavior?i.hardBehavior=e.problem:i.hardCondition||e.behavior||(i.hardCondition=e.problem)}),i},serializeDetails:function(){return this.serialize({longDateTime:!0})},isCreator:function(){return this.attributes.creator&&this.attributes.creator.id===i.data._id},canEdit:function(){return!!i.isAllowedTo(this.privilegePrefix+":MANAGE")||!!this.isCreator()&&Date.now()-Date.parse(this.get("date"))<864e5},canDelete:function(){return!!i.isAllowedTo(this.privilegePrefix+":MANAGE")||!!this.isCreator()&&Date.now()-Date.parse(this.get("date"))<288e5},hasAnyEasy:function(){return e.any(this.get("observations"),function(e){return!e.safe&&e.easy})||e.any(this.get("risks"),function(e){return e.easy})}})});