define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","../kaizenOrders/dictionaries"],function(e,r,s,o,t,a){"use strict";var i=["total","countBySection","countByObserverSection","safeBySection","riskyBySection","categories"];return o.extend({urlRoot:"/behaviorObsCards/reports/count",nlsDomain:"behaviorObsCards",defaults:function(){return{from:0,to:0,interval:"month",sections:[],observerSections:[],superior:"",company:[],shift:0,anyHardObservations:0,anyHardRisks:0}},fetch:function(r){return e.isObject(r)||(r={}),r.data=e.assign(r.data||{},e.pick(this.attributes,["from","to","interval","sections","observerSections","superior","company","shift","anyHardObservations","anyHardRisks"])),r.data.sections=r.data.sections.join(","),r.data.observerSections=r.data.observerSections.join(","),r.data.company=r.data.company.join(","),o.prototype.fetch.call(this,r)},genClientUrl:function(){return"/behaviorObsCardCountReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&observerSections="+this.get("observerSections")+"&superior="+this.get("superior")+"&company="+this.get("company")+"&shift="+this.get("shift")+"&anyHardObservations="+this.get("anyHardObservations")+"&anyHardRisks="+this.get("anyHardRisks")},parse:function(r){var s=this,o=r.totals,t={total:{rows:s.prepareTotalRows(o),series:s.prepareTotalSeries()},observer:{categories:this.prepareUserCategories(r.users,o.observers),series:this.prepareObserverSeries(o.observers,r.groups)}};return e.forEach(i,function(e){if(!t[e])if("categories"===e){var i=r.categories;a.behaviours.forEach(function(e){i[e.id]=e.t("name")}),t[e]={rows:s.prepareRows(o.risky,o.categories,"categories",i),series:{}}}else t[e]={rows:s.prepareRows(o[e.replace("BySection","")],o[e],"sections",r.sections),series:{}}}),e.forEach(r.groups,function(r){var o;"number"==typeof r?r={key:o=r,type:{}}:o=r.key,t.total.series.behaviorObsCard.data.push({x:o,y:r.count||null}),e.forEach(i,function(e){s.createSeriesFromRows(e,t,r)})}),t},prepareTotalRows:function(e){return[{id:"behaviorObsCard",abs:e.count,rel:1,color:"#5bc0de"}]},prepareTotalSeries:function(){return{behaviorObsCard:{data:[],color:"#5bc0de"}}},prepareRows:function(e,s,o,a){var i={id:"total",abs:0,rel:1,color:"#DDD",label:r("behaviorObsCards","report:series:total")},n=s.map(function(r){return i.abs+=r[1],{id:r[0],abs:r[1],rel:r[1]/e,color:t.getColor("behaviorObsCards/count/"+o,r[0]),label:a[r[0]]}});return n.push(i),n},createSeriesFromRows:function(r,s,o){var t=s[r].series;e.forEach(s[r].rows,function(e){t[e.id]||(t[e.id]={name:e.label,data:[],color:e.color}),t[e.id].data.push({x:o.key,y:o[r]&&o[r][e.id]||null})})},prepareUserCategories:function(e,r){return r.map(function(r){var s=r[0];return e[s]||s})},prepareObserverSeries:function(s){var o=[{id:"behaviorObsCards",name:r.bound("behaviorObsCards","report:series:card"),data:[],color:"#5bc0de"}];return e.forEach(s,function(e){o[0].data.push(e[1])}),o}},{TABLE_AND_CHART_METRICS:i,fromQuery:function(r){return void 0===r.from&&void 0===r.to&&(r.from=s.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+r.from||void 0,to:+r.to||void 0,interval:r.interval||void 0,sections:e.isEmpty(r.sections)?[]:r.sections.split(","),observerSections:e.isEmpty(r.observerSections)?[]:r.observerSections.split(","),superior:r.superior||"",company:e.isEmpty(r.company)?[]:r.company.split(","),shift:+r.shift||0,anyHardObservations:+r.anyHardObservations||0,anyHardRisks:+r.anyHardRisks||0})}})});