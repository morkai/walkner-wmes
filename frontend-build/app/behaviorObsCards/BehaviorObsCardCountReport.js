// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(r,e,o,t,s){"use strict";var i="#5bc0de",a=["total","countBySection","safeBySection","riskyBySection","categories"];return t.extend({urlRoot:"/behaviorObsCards/reports/count",nlsDomain:"behaviorObsCards",defaults:function(){return{from:0,to:0,interval:"month",sections:[],superior:""}},fetch:function(e){return r.isObject(e)||(e={}),e.data=r.extend(e.data||{},r.pick(this.attributes,["from","to","interval","sections","superior"])),e.data.sections=e.data.sections.join(","),t.prototype.fetch.call(this,e)},genClientUrl:function(){return"/behaviorObsCardCountReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&superior="+this.get("superior")},parse:function(e){var o=this,t=e.totals,s={total:{rows:o.prepareTotalRows(t),series:o.prepareTotalSeries()},observer:{categories:this.prepareUserCategories(e.users,t.observers),series:this.prepareObserverSeries(t.observers,e.groups)}};return r.forEach(a,function(r){s[r]||("categories"===r?s[r]={rows:o.prepareRows(t.risky,t.categories,"categories",e.categories),series:{}}:s[r]={rows:o.prepareRows(t[r.replace("BySection","")],t[r],"sections",e.sections),series:{}})}),r.forEach(e.groups,function(e){var t;"number"==typeof e?(t=e,e={key:t,type:{}}):t=e.key;var i=s.total.series;i.behaviorObsCard.data.push({x:t,y:e.count||null}),r.forEach(a,function(r){o.createSeriesFromRows(r,s,e)})}),s},prepareTotalRows:function(r){return[{id:"behaviorObsCard",abs:r.count,rel:1,color:i}]},prepareTotalSeries:function(){return{behaviorObsCard:{data:[],color:i}}},prepareRows:function(r,o,t,i){var a={id:"total",abs:0,rel:1,color:"#DDD",label:e("behaviorObsCards","report:series:total")},n=o.map(function(e){return a.abs+=e[1],{id:e[0],abs:e[1],rel:e[1]/r,color:s.getColor("behaviorObsCards/count/"+t,e[0]),label:i[e[0]]}});return n.push(a),n},createSeriesFromRows:function(e,o,t){var s=o[e].series;r.forEach(o[e].rows,function(r){s[r.id]||(s[r.id]={name:r.label,data:[],color:r.color}),s[r.id].data.push({x:t.key,y:t[e]?t[e][r.id]||null:null})})},prepareUserCategories:function(r,e){return e.map(function(e){var o=e[0];return r[o]||o})},prepareObserverSeries:function(o){var t=[{id:"behaviorObsCards",name:e.bound("behaviorObsCards","report:series:card"),data:[],color:"#5bc0de"}];return r.forEach(o,function(r){t[0].data.push(r[1])}),t}},{TABLE_AND_CHART_METRICS:a,fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=o.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+e.from||void 0,to:+e.to||void 0,interval:e.interval||void 0,sections:r.isEmpty(e.sections)?[]:e.sections.split(","),superior:e.superior||""})}})});