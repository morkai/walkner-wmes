// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","app/kaizenOrders/dictionaries"],function(e,t,r,o,s,i){"use strict";var a="#5bc0de",n=["countBySection","safeBySection","riskyBySection","categories"];return o.extend({urlRoot:"/behaviorObsCards/reports/count",nlsDomain:"behaviorObsCards",defaults:function(){return{from:0,to:0,interval:"month",sections:[]}},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.extend(t.data||{},e.pick(this.attributes,["from","to","interval","sections"])),t.data.sections=t.data.sections.join(","),o.prototype.fetch.call(this,t)},genClientUrl:function(){return"/behaviorObsCardCountReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")},parse:function(t){var r=this,o=t.totals,s={total:{rows:r.prepareTotalRows(o),series:r.prepareTotalSeries()}};return e.forEach(n,function(e){"categories"===e?s[e]={rows:r.prepareRows(o.risky,o.categories,"categories",t.categories),series:{}}:s[e]={rows:r.prepareRows(o[e.replace("BySection","")],o[e],"sections",t.sections),series:{}}}),e.forEach(t.groups,function(t){var o;"number"==typeof t?(o=t,t={key:o,type:{}}):o=t.key;var i=s.total.series;i.behaviorObsCard.data.push({x:o,y:t.count||null}),e.forEach(n,function(e){r.createSeriesFromRows(e,s,t)})}),s},prepareTotalRows:function(e){return[{id:"behaviorObsCard",abs:e.count,rel:1,color:a}]},prepareTotalSeries:function(){return{behaviorObsCard:{data:[],color:a}}},prepareRows:function(e,r,o,i){var a={id:"total",abs:0,rel:1,color:"#DDD",label:t("behaviorObsCards","report:series:total")},n=r.map(function(t){return a.abs+=t[1],{id:t[0],abs:t[1],rel:t[1]/e,color:s.getColor("behaviorObsCards/count/"+o,t[0]),label:i[t[0]]}});return n.push(a),n},createSeriesFromRows:function(t,r,o){var s=r[t].series;e.forEach(r[t].rows,function(e){s[e.id]||(s[e.id]={name:e.label,data:[],color:e.color}),s[e.id].data.push({x:o.key,y:o[t]?o[t][e.id]||null:null})})}},{TABLE_AND_CHART_METRICS:n,fromQuery:function(t){return void 0===t.from&&void 0===t.to&&(t.from=r.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+t.from||void 0,to:+t.to||void 0,interval:t.interval||void 0,sections:e.isEmpty(t.sections)?[]:t.sections.split(",")})}})});