// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/core/views/FilterView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","app/behaviorObsCards/templates/filter","app/core/util/ExpandableSelect"],function(e,s,t,r,a,n){"use strict";return t.extend({template:n,events:e.extend({'change input[name="userType"]':"toggleUserSelect2","keyup select":function(e){return 27===e.keyCode?(e.target.selectedIndex=-1,!1):void 0},"dblclick select":function(e){e.target.selectedIndex=-1}},t.prototype.events),defaultFormData:function(){return{section:[],userType:"others",user:null,from:"",to:"",anyHard:[]}},termToForm:{"observer.id":function(e,s,t){t.userType="observer",t.user=s.args[1]},users:function(e,s,t){"mine"===s.args[1]?(t.userType="mine",t.user=null):(t.userType="others",t.user=s.args[1])},date:function(e,t,r){r["ge"===t.name?"from":"to"]=s.format(t.args[1],"YYYY-MM-DD")},section:function(e,s,t){t[e]="in"===s.name?s.args[1]:[s.args[1]]},anyHardObservations:function(e,s,t){s.args[1]&&t.anyHard.push("observations")},anyHardRisks:function(e,s,t){s.args[1]&&t.anyHard.push("risks")}},serialize:function(){return e.extend(t.prototype.serialize.call(this),{sections:a.sections.toJSON()})},serializeFormToQuery:function(t){var r=s.getMoment(this.$id("from").val(),"YYYY-MM-DD"),a=s.getMoment(this.$id("to").val(),"YYYY-MM-DD"),n=this.$('input[name="userType"]:checked').val(),i=this.$id("user").val(),o=this.getButtonGroupValue("anyHard");r.isValid()&&t.push({name:"ge",args:["date",r.valueOf()]}),a.isValid()&&(a.valueOf()===r.valueOf()&&this.$id("to").val(a.add(1,"days").format("YYYY-MM-DD")),t.push({name:"lt",args:["date",a.valueOf()]})),"observer"===n?t.push({name:"eq",args:["observer.id",i]}):"mine"===n?t.push({name:"eq",args:["users","mine"]}):i&&t.push({name:"eq",args:["users",i]}),e.contains(o,"observations")&&t.push({name:"eq",args:["anyHardObservations",!0]}),e.contains(o,"risks")&&t.push({name:"eq",args:["anyHardRisks",!0]}),["section"].forEach(function(s){var r=(this.$id(s).val()||[]).filter(function(s){return!e.isEmpty(s)});1===r.length?t.push({name:"eq",args:[s,r[0]]}):r.length&&t.push({name:"in",args:[s,r]})},this)},afterRender:function(){t.prototype.afterRender.call(this),this.$(".is-expandable").expandableSelect(),r(this.$id("user"),{width:"300px",view:this}),this.toggleUserSelect2()},destroy:function(){t.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},toggleUserSelect2:function(){var e=this.$('input[name="userType"]:checked').val();this.$id("user").select2("enable","others"===e||"observer"===e)}})});