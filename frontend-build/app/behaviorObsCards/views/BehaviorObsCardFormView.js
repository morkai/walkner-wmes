// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","form2js","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/data/prodLines","app/kaizenOrders/dictionaries","../BehaviorObsCard","app/behaviorObsCards/templates/form","app/behaviorObsCards/templates/_formObservation","app/behaviorObsCards/templates/_formRisk","app/behaviorObsCards/templates/_formDifficulty"],function(e,i,t,s,r,a,n,o,l,u,d,c,f,h,v,b,p){"use strict";return l.extend({template:h,events:e.extend({"click .behaviorObsCards-form-radio":function(e){"TD"===e.target.tagName&&e.target.querySelector("input").click()},"click #-addRisk":function(){this.$id("risks").append(b({risk:{risk:"",cause:"",easy:null},i:++this.rowIndex}))},"click #-addDifficulty":function(){this.$id("difficulties").append(p({difficulty:{problem:"",solution:"",behavior:null},i:++this.rowIndex}))},"click .btn[data-remove]":function(e){var t=this;this.$(e.target).closest("tr").fadeOut("fast",function(){i(this).remove(),"observation"===e.currentTarget.dataset.remove&&t.setUpAddObservationSelect2()})},"change #-addObservation":function(){var e=this.$id("addObservation"),i=c.behaviours.get(e.val()),t={};(this.model.get("observations")||[]).forEach(function(e){t[e.id]=e}),this.$id("observations").append(v({observation:t[i.id]||{id:i.id,behavior:i.get("name"),observation:"",cause:"",safe:!0,easy:!0},i:++this.rowIndex})),e.select2("val",""),this.setUpAddObservationSelect2()}},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.rowIndex=0},serialize:function(){return e.extend(l.prototype.serialize.call(this),{})},hasAnyObservation:function(){return e.some(t(this.$id("observations")[0]).observations,this.filterObservation)},hasAnyRisk:function(){return e.some(t(this.$id("risks")[0]).risks,this.filterRisk)},hasAnyDifficulty:function(){return e.some(t(this.$id("difficulties")[0]).difficulties,this.filterDifficulty)},checkValidity:function(e){return(e.observations||[]).length||(e.risks||[]).length||(e.difficulties||[]).length},serializeToForm:function(){var e=this.model.toJSON();return e.date=r.format(e.date,"YYYY-MM-DD"),e},serializeForm:function(e){var i=this.$id("observer").select2("data"),t=r.getMoment(e.date,"YYYY-MM-DD");return e.observer={id:i.id,label:i.text},e.date=t.isValid()?t.toISOString():null,e.easyDiscussed=!!e.easyDiscussed,e.observations=e.observations.filter(this.filterObservation),e.risks=e.risks.filter(this.filterRisk),e.difficulties=e.difficulties.filter(this.filterDifficulty),e},filterObservation:function(e){return e.id=e.behavior,e.behavior=c.behaviours.get(e.id).get("name"),e.observation=(e.observation||"").trim(),e.cause=(e.cause||"").trim(),e.safe="-1"===e.safe?null:"1"===e.safe,e.easy="-1"===e.easy?null:"1"===e.easy,null!==e.safe&&null!==e.easy},filterRisk:function(e){return e.risk=(e.risk||"").trim(),e.cause=(e.cause||"").trim(),e.easy="-1"===e.easy?null:"1"===e.easy,(e.risk.length>0||e.cause.length>0)&&null!==e.easy},filterDifficulty:function(e){return e.problem=(e.problem||"").trim(),e.solution=(e.solution||"").trim(),e.behavior="-1"===e.behavior?null:"1"===e.behavior,(e.problem.length>0||e.solution.length>0)&&null!==e.behavior},afterRender:function(){l.prototype.afterRender.call(this),this.$id("section").select2({data:c.sections.map(o)}),this.$id("line").select2({data:d.filter(function(e){return!e.get("deactivatedAt")}).map(o).sort(function(e,i){return e.text.localeCompare(i.text)})}),this.setUpObserverSelect2(),this.renderObservations(),this.renderRisks(),this.renderDifficulties(),this.setUpAddObservationSelect2(),this.$("input[autofocus]").focus()},setUpObserverSelect2:function(){var e=this.model.get("observer"),i=u(this.$id("observer"),{textFormatter:function(e,i){return i}});e&&i.select2("data",{id:e.id,text:e.label})},setUpAddObservationSelect2:function(){var e={};this.$id("observations").find('input[name$="behavior"]').each(function(){e[this.value]=1}),this.$id("addObservation").select2({width:"500px",placeholder:"Wybierz kategorię zachowań, aby dodać nową obserwację...",minimumResultsForSearch:7,data:c.behaviours.filter(function(i){return!e[i.id]}).map(o)})},renderObservations:function(){var e=this;this.$id("observations").html(this.serializeObservationsToForm().map(function(i){return v({observation:i,i:++e.rowIndex})}).join(""))},serializeObservationsToForm:function(){var i={},t=[];return(this.model.get("observations")||[]).forEach(function(e){i[e.id]=e}),c.behaviours.forEach(function(e){var s=i[e.id];s&&(s.behavior=e.get("name"),t.push(s),delete i[e.id])}),e.forEach(i,function(e){t.push(e)}),t},renderRisks:function(){var e=this;this.$id("risks").html(this.serializeRisksToForm().map(function(i){return b({risk:i,i:++e.rowIndex})}).join(""))},serializeRisksToForm:function(){var e=this.model.get("risks")||[];return e.length||e.push({risk:"",cause:"",easy:!0}),e},renderDifficulties:function(){var e=this;this.$id("difficulties").html(this.serializeDifficultiesToForm().map(function(i){return p({difficulty:i,i:++e.rowIndex})}).join(""))},serializeDifficultiesToForm:function(){var e=this.model.get("difficulties")||[];return e.length||e.push({problem:"",solution:"",behavior:!0}),e}})});