// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","form2js","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/data/prodLines","app/kaizenOrders/dictionaries","../BehaviorObsCard","app/behaviorObsCards/templates/form","app/behaviorObsCards/templates/_formObservation","app/behaviorObsCards/templates/_formRisk","app/behaviorObsCards/templates/_formDifficulty"],function(i,e,t,s,r,n,o,a,l,u,f,c,d,h,p,v,m){"use strict";return l.extend({template:h,events:i.extend({"click .behaviorObsCards-form-radio":function(i){"TD"===i.target.tagName&&i.target.querySelector("input").click()},'mousedown input[type="radio"]':function(i){i.preventDefault()},'mouseup input[type="radio"]':function(i){i.preventDefault()},'click input[type="radio"]':function(i){var e=this;i.preventDefault(),setTimeout(function(){i.target.checked=!i.target.checked,i.target.checked||e.$(i.target).closest("tr").find('input[name="'+i.target.name+'"][value="-1"]').prop("checked",!0),e.toggleValidity()},1)},"click #-addRisk":function(){this.$id("risks").append(v({risk:{risk:"",cause:"",easy:null},i:++this.rowIndex}))},"click #-addDifficulty":function(){this.$id("difficulties").append(m({difficulty:{problem:"",solution:"",behavior:null},i:++this.rowIndex}))}},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.rowIndex=0},serialize:function(){return i.extend(l.prototype.serialize.call(this),{})},toggleValidity:function(){var i=this.hasAnyObservation()||this.hasAnyRisk()||this.hasAnyDifficulty();this.$id("observations").find("textarea").first()[0].setCustomValidity(i?"":s("behaviorObsCards","FORM:ERROR:empty"))},hasAnyObservation:function(){return i.some(t(this.$id("observations")[0]).observations,this.filterObservation)},hasAnyRisk:function(){return i.some(t(this.$id("risks")[0]).risks,this.filterRisk)},hasAnyDifficulty:function(){return i.some(t(this.$id("difficulties")[0]).difficulties,this.filterDifficulty)},checkValidity:function(i){return(i.observations||[]).length||(i.risks||[]).length||(i.difficulties||[]).length},serializeToForm:function(){var i=this.model.toJSON();return i.date=r.format(i.date,"YYYY-MM-DD"),i},serializeForm:function(i){var e=this.$id("observer").select2("data"),t=r.getMoment(i.date,"YYYY-MM-DD");return i.observer={id:e.id,label:e.text},i.date=t.isValid()?t.toISOString():null,i.easyDiscussed=!!i.easyDiscussed,i.observations=i.observations.filter(this.filterObservation),i.risks=i.risks.filter(this.filterRisk),i.difficulties=i.difficulties.filter(this.filterDifficulty),i},filterObservation:function(i){return i.id=i.behavior,i.behavior=c.behaviours.get(i.id).get("name"),i.observation=(i.observation||"").trim(),i.safe="-1"===i.safe?null:"1"===i.safe,i.easy="-1"===i.easy?null:"1"===i.easy,null!==i.safe&&null!==i.easy},filterRisk:function(i){return i.risk=(i.risk||"").trim(),i.cause=(i.cause||"").trim(),i.easy="-1"===i.easy?null:"1"===i.easy,(i.risk.length>0||i.cause.length>0)&&null!==i.easy},filterDifficulty:function(i){return i.problem=(i.problem||"").trim(),i.solution=(i.solution||"").trim(),i.behavior="-1"===i.behavior?null:"1"===i.behavior,(i.problem.length>0||i.solution.length>0)&&null!==i.behavior},afterRender:function(){l.prototype.afterRender.call(this),this.$id("section").select2({data:c.sections.map(a)}),this.$id("line").select2({data:f.filter(function(i){return!i.get("deactivatedAt")}).map(a).sort(function(i,e){return i.text.localeCompare(e.text)})}),this.setUpObserverSelect2(),this.renderObservations(),this.renderRisks(),this.renderDifficulties(),this.toggleValidity(),this.$("input[autofocus]").focus()},setUpObserverSelect2:function(){var i=this.model.get("observer"),e=u(this.$id("observer"),{textFormatter:function(i,e){return e}});i&&e.select2("data",{id:i.id,text:i.label})},renderObservations:function(){var i=this;this.$id("observations").html(this.serializeObservationsToForm().map(function(e){return p({observation:e,i:++i.rowIndex})}).join(""))},serializeObservationsToForm:function(){var e={},t=[];return(this.model.get("observations")||[]).forEach(function(i){e[i.id]=i}),c.behaviours.forEach(function(i){var s=e[i.id];s?(s.behavior=i.get("name"),t.push(s),delete e[i.id]):t.push({id:i.id,behavior:i.get("name"),observation:"",safe:null,easy:null})}),i.forEach(e,function(i){t.push(i)}),t},renderRisks:function(){var i=this;this.$id("risks").html(this.serializeRisksToForm().map(function(e){return v({risk:e,i:++i.rowIndex})}).join(""))},serializeRisksToForm:function(){var i=this.model.get("risks")||[];return i.push({risk:"",cause:"",easy:null}),i},renderDifficulties:function(){var i=this;this.$id("difficulties").html(this.serializeDifficultiesToForm().map(function(e){return m({difficulty:e,i:++i.rowIndex})}).join(""))},serializeDifficultiesToForm:function(){var i=this.model.get("difficulties")||[];return i.push({problem:"",solution:"",behavior:null}),i}})});