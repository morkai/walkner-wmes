// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/data/mrpControllers","app/core/views/ListView"],function(e,t,r,i,n,s,a){"use strict";return a.extend({className:"is-clickable",localTopics:{"mrpControllers.synced":"render"},remoteTopics:{"mechOrders.synced":"refreshCollection","mechOrders.edited":function(e){var t=e.model,r=this.collection.get(t._id);r&&t.mrp!==r.get("mrp")&&(r.set("mrp",t.mrp),this.$(".list-item[data-id="+r.id+"] > td[data-id=mrp]").html(this.prepareMrpCell(t.mrp)))}},events:e.extend(a.prototype.events,{"click .mechOrders-editMrp":"showMrpEditor"}),columns:[{id:"_id",className:"is-min"},"name","mrp",{id:"materialNorm",className:"is-min"}],serializeActions:function(){var e=this.collection;return function(t){return[a.actions.viewDetails(e.get(t._id))]}},serializeRows:function(){var e=this,t=i.isAllowedTo("ORDERS:MANAGE");return this.collection.map(function(r){var i=r.toJSON();return t&&(i.mrp=e.prepareMrpCell(i.mrp)),i})},prepareMrpCell:function(e){var t="";return e&&(t+="<span>"+e+"</span>"),t+=' <button class="btn btn-link mechOrders-editMrp">'+r("mechOrders","list:mrp:"+(e?"edit":"set"))+"</button>"},showMrpEditor:function(e){var i=this.$(e.target).closest("td"),n=this.collection.get(i.parent().attr("data-id")),a=this,p=t('<input type="text">');i.empty().append(p),p.select2({allowClear:!0,placeholder:r("mechOrders","list:mrp:placeholder"),data:s.map(function(e){return{id:e.id,text:e.getLabel()}})}),p.on("change",function(e){var t=e.val.length?e.val:null;return t===n.get("mrp")?i.html(a.prepareMrpCell(t)):(i.html('<i class="fa fa-spinner fa-spin"></i><span>'+t+"</span>"),a.updateMrp(n,t,i),void i.parent().next("tr").find(".mechOrders-editMrp").focus())}),p.select2("open")},updateMrp:function(e,t,i){var s=e.get("mrp"),a=Date.now(),p=this.promised(e.save("mrp",t,{patch:!0})),l=this;p.then(function(){l.delay(500,a,function(){i.html(l.prepareMrpCell(t))})}),p.fail(function(){e.set("mrp",s),i.html(l.prepareMrpCell(s)),n.msg.show({type:"error",time:3e3,text:r("mechOrders","list:mrp:failure",{nc12:e.id})})})},delay:function(e,t,r){var i=Date.now()-t;i>e?r():this.timers[Math.random()]=setTimeout(r,e-i)}})});