define(["underscore","jquery","app/i18n","app/user","app/viewport","app/data/mrpControllers","app/core/views/ListView"],function(e,t,r,i,s,a,p){"use strict";return p.extend({className:"is-clickable",localTopics:{"mrpControllers.synced":"render"},remoteTopics:{"mechOrders.synced":"refreshCollection","mechOrders.edited":function(e){const t=e.model,r=this.collection.get(t._id);r&&t.mrp!==r.get("mrp")&&(r.set("mrp",t.mrp),this.$(`.list-item[data-id="${r.id}"] > td[data-id="mrp"]`).html(this.prepareMrpCell(t.mrp)))}},events:Object.assign({"click .mechOrders-editMrp":"showMrpEditor"},p.prototype.events),columns:[{id:"_id",className:"is-min",tdClassName:"text-fixed"},{id:"name",className:"is-min"},{id:"mrp",className:"is-min"},{id:"materialNorm",className:"is-min",tdClassName:"is-number"},"-"],serializeActions:function(){return e=>[p.actions.viewDetails(this.collection.get(e._id))]},serializeRows:function(){const e=i.isAllowedTo("ORDERS:MANAGE");return this.collection.map(t=>{var r=t.serialize();return e&&(r.mrp=this.prepareMrpCell(r.mrp)),r})},prepareMrpCell:function(e){let t="";return e&&(t+="<span>"+e+"</span>"),t+=' <button class="btn btn-link mechOrders-editMrp">'+this.t(`list:mrp:${e?"edit":"set"}`)+"</button>"},showMrpEditor:function(e){const r=this.$(e.target).closest("td"),i=this.collection.get(r.parent().attr("data-id")),s=t('<input type="text" autocomplete="off">');r.empty().append(s),s.select2({allowClear:!0,placeholder:this.t("list:mrp:placeholder"),data:a.map(e=>({id:e.id,text:e.getLabel()}))}),s.on("change",e=>{const t=e.val.length?e.val:null;if(t===i.get("mrp"))return r.html(this.prepareMrpCell(t));r.html(`<i class="fa fa-spinner fa-spin"></i><span>${t}</span>`),this.updateMrp(i,t,r),r.parent().next("tr").find(".mechOrders-editMrp").focus()}),s.select2("open")},updateMrp:function(e,t,r){const i=e.get("mrp"),a=Date.now(),p=this.promised(e.save("mrp",t,{patch:!0}));p.then(()=>{this.delay(500,a,()=>r.html(this.prepareMrpCell(t)))}),p.fail(()=>{e.set("mrp",i),r.html(this.prepareMrpCell(i)),s.msg.show({type:"error",time:3e3,text:this.t("list:mrp:failure",{nc12:e.id})})})},delay:function(e,t,r){var i=Date.now()-t;i>e?r():this.timers[Math.random()]=setTimeout(r,e-i)}})});