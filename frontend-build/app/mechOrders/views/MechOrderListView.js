define(["jquery","app/i18n","app/user","app/viewport","app/data/mrpControllers","app/core/views/ListView"],function(e,t,r,i,n,p){return p.extend({localTopics:{"mrpControllers.synced":"render"},remoteTopics:{"mechOrders.synced":"refreshCollection","mechOrders.edited":function(e){var t=e.model,r=this.collection.get(t._id);r&&t.mrp!==r.get("mrp")&&(r.set("mrp",t.mrp),this.$(".list-item[data-id="+r.id+"] > td[data-id=mrp]").html(this.prepareMrpCell(t.mrp)))}},events:{"click .mechOrders-editMrp":"showMrpEditor"},columns:["_id","name","mrp","materialNorm"],serializeActions:function(){var e=this.collection;return function(t){return[p.actions.viewDetails(e.get(t._id))]}},serializeRows:function(){var e=this,t=r.isAllowedTo("ORDERS:MANAGE");return this.collection.map(function(r){var i=r.toJSON();return t&&(i.mrp=e.prepareMrpCell(i.mrp)),i})},prepareMrpCell:function(e){var r="";return e&&(r+="<span>"+e+"</span>"),r+=' <button class="btn btn-link mechOrders-editMrp">'+t("mechOrders","list:mrp:"+(e?"edit":"set"))+"</button>"},showMrpEditor:function(r){var i=this.$(r.target).closest("td"),p=this.collection.get(i.parent().attr("data-id")),a=this,l=e('<input type="text">');i.empty().append(l),l.select2({allowClear:!0,placeholder:t("mechOrders","list:mrp:placeholder"),data:n.map(function(e){return{id:e.id,text:e.getLabel()}})}),l.on("change",function(e){var t=e.val.length?e.val:null;return t===p.get("mrp")?i.html(a.prepareMrpCell(t)):(i.html('<i class="fa fa-spinner fa-spin"></i><span>'+t+"</span>"),a.updateMrp(p,t,i),void i.parent().next("tr").find(".mechOrders-editMrp").focus())}),l.select2("open")},updateMrp:function(e,r,n){var p=e.get("mrp"),a=Date.now(),l=this.promised(e.save("mrp",r,{patch:!0})),s=this;l.then(function(){s.delay(500,a,function(){n.html(s.prepareMrpCell(r))})}),l.fail(function(){e.set("mrp",p),n.html(s.prepareMrpCell(p)),i.msg.show({type:"error",time:3e3,text:t("mechOrders","list:mrp:failure",{nc12:e.id})})})},delay:function(e,t,r){var i=Date.now()-t;i>e?r():this.timers[Math.random()]=setTimeout(r,e-i)}})});