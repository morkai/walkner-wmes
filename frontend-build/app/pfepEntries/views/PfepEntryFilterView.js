// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/core/views/FilterView","app/core/util/idAndLabel","app/users/util/setUpUserSelect2","app/pfepEntries/templates/filter"],function(e,t,i,r,a,n){"use strict";var s=["nc12","packType","vendor","creator","limit"],o={};return i.extend({template:n,events:e.extend({"mouseup #-result > .btn":function(e){var t=e.currentTarget,i=t.firstElementChild;i.checked&&setTimeout(function(){t.classList.remove("active"),i.checked=!1},1)},"click a[data-filter]":function(e){e.preventDefault(),this.showFilter(e.currentTarget.dataset.filter)}},i.prototype.events),defaultFormData:function(){return{from:"",to:"",nc12:"",packType:"",vendor:"",creator:""}},termToForm:{createdAt:function(e,i,r){r["ge"===i.name?"from":"to"]=t.format(i.args[1],"YYYY-MM-DD")},nc12:function(e,t,i){i.nc12=t.args[1].replace(/[^A-Z0-9]+/g,"")},packType:function(e,t,i){i[e]=t.args[1]},"creator.id":function(e,t,i){i[e.split(".")[0]]="in"===t.name?t.args[1].join(","):t.args[1]}},serializeFormToQuery:function(e){var i=t.getMoment(this.$id("from").val(),"YYYY-MM-DD"),r=t.getMoment(this.$id("to").val(),"YYYY-MM-DD"),a=this.$id("nc12").val().replace(/[^0-9A-Za-z]+/g,"").toUpperCase(),n=this.$id("creator").val();i.isValid()&&e.push({name:"ge",args:["createdAt",i.valueOf()]}),r.isValid()&&(r.valueOf()===i.valueOf()&&this.$id("to").val(r.add(1,"days").format("YYYY-MM-DD")),e.push({name:"lt",args:["createdAt",r.valueOf()]})),/^([0-9]{12}|[A-Z][A-Z0-9]{6})$/.test(a)?e.push({name:"eq",args:["nc12",a]}):a.length&&e.push({name:"regex",args:["nc12","^"+a]}),n.length&&(-1===n.indexOf(",")?e.push({name:"eq",args:["creator.id",n]}):e.push({name:"in",args:["creator.id",n.split(",")]})),["packType","vendor"].forEach(function(t){var i=this.$id(t).val().trim();i&&e.push({name:"eq",args:[t,i]})},this)},changeFilter:function(){i.prototype.changeFilter.apply(this,arguments),this.toggleFilters()},serialize:function(){return e.assign(i.prototype.serialize.apply(this,arguments),{filters:s})},afterRender:function(){i.prototype.afterRender.call(this),this.$id("limit").parent().attr("data-filter","limit"),this.$id("filters").select2({width:"175px"}),a(this.$id("creator"),{view:this,width:"275px"}),this.toggleFilters()},toggleFilters:function(){var e=this;s.forEach(function(t){e.$('.form-group[data-filter="'+t+'"]').toggleClass("hidden",!e.filterHasValue(t))})},filterHasValue:function(e){var t=this.$id(e).val();return"limit"===e?15!=+t:t.length>0},showFilter:function(e){if("date"===e)return void this.$id("from").focus();this.$('.form-group[data-filter="'+(o[e]||e)+'"]').removeClass("hidden").find("input, select").first().focus()}})});