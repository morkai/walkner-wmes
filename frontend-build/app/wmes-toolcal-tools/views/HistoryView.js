define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/wmes-toolcal-tools/dictionaries","app/wmes-toolcal-tools/templates/historyItem","app/wmes-toolcal-tools/templates/history"],function(t,e,i,a,r,s,n,o,l,u,m){"use strict";return n.extend({template:m,events:{"submit form":function(){var t=this,e=t.$id("comment"),i=e.val().trim();if(""===i)return!1;var a=t.$id("submit").prop("disabled",!0),r=t.ajax({type:"PUT",url:"/toolcal/tools/"+t.model.id,data:JSON.stringify({comment:i})});return r.done(function(){e.val("")}),r.fail(function(){s.msg.show({type:"error",time:3e3,text:t.t("MSG:comment:failure")})}),r.always(function(){a.prop("disabled",!1)}),!1}},initialize:function(){this.once("afterRender",function(){this.listenTo(this.model,"change:changes",this.updateHistory)})},getTemplateData:function(){return{canEdit:this.model.canEdit(),editUrl:this.model.genClientUrl("edit"),items:this.serializeItems()}},serializeItems:function(){return this.model.get("changes").map(this.serializeItem,this)},serializeItem:function(e,i){var r,s,n=this;return e.data&&e.data.observer?(s=[],r=n.t("history:observer:"+e.data.observer[0])):(s=t.map(e.data,function(t,e){return{label:n.t("PROPERTY:"+e),oldValue:n.serializeItemValue(e,t[0],!0,i),newValue:n.serializeItemValue(e,t[1],!1,i)}}),r=e.comment.trim()),{time:a.toTagData(e.date),user:o({userInfo:e.user}),changes:s,comment:r}},serializeItemValue:function(e,i,r,s){if(null==i||""===i)return"-";if(/Date$/i.test(e))return a.format(i,"LL");if(/File$/.test(e)){var n=e.replace(/File$/,"");return'<a href="'+(this.model.url()+"/attachments/"+n+"?change="+s+"&old="+(r?1:0))+'" target="_blank">'+t.escape(i.name)+"</a>"}switch(e){case"users":return i.map(function(t){return o({userInfo:t,noIp:!0})}).join(", ");case"status":return this.t("status:"+i);case"intervalUnit":return this.t("interval:unit:"+i);case"type":var u=l.forProperty(e).get(i);return u?u.getLabel():i;case"name":case"sn":return i.length<=43?i:{more:i,toString:function(){return i.substr(0,40)+"..."}};default:return i||""}},afterRender:function(){this.lastChangeCount=this.model.get("changes").length,this.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",template:this.$el.popover.Constructor.DEFAULTS.template.replace('class="popover"','class="popover toolcal-tools-history-popover"'),title:function(){return e(this).closest("tr").children().first().text()}}),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4))},updateHistory:function(){for(var t=this.model.get("changes"),i="",a=this.lastChangeCount;a<t.length;++a)i+=u({item:this.serializeItem(t[a],a)});var r=e(i),s=this.$(".toolcal-tools-history-item").last();s.length?r.insertAfter(s):r.insertAfter(this.$(".panel-heading")),r.addClass("highlight"),this.lastChangeCount=t.length},updateTimes:function(){this.$(".toolcal-tools-history-time").each(function(){var t=a.toTagData(this.getAttribute("datetime"));this.textContent=t.daysAgo>5?t.long:t.human})}})});