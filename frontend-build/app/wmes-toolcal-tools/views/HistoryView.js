define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/wmes-toolcal-tools/dictionaries","app/wmes-toolcal-tools/templates/historyItem","app/wmes-toolcal-tools/templates/history"],function(t,e,i,s,a,r,o,n,l,u,m){"use strict";return o.extend({template:m,events:{"submit form":function(){var t=this,e=t.$id("comment"),i=e.val().trim();if(""===i)return!1;var s=t.$id("submit").prop("disabled",!0),a=t.ajax({type:"PUT",url:"/toolcal/tools/"+t.model.id,data:JSON.stringify({comment:i})});return a.done(function(){e.val("")}),a.fail(function(){r.msg.show({type:"error",time:3e3,text:t.t("MSG:comment:failure")})}),a.always(function(){s.prop("disabled",!1)}),!1}},getTemplateData:function(){return{canEdit:this.model.canEdit(),editUrl:this.model.genClientUrl("edit"),items:this.serializeItems()}},serializeItems:function(){return this.model.get("changes").map(this.serializeItem,this)},serializeItem:function(e,i){var a,r,o=this;return e.data&&e.data.observer?(r=[],a=o.t("history:observer:"+e.data.observer[0])):(r=t.map(e.data,function(t,e){return{label:o.t("PROPERTY:"+e),oldValue:o.serializeItemValue(e,t[0],!0,i),newValue:o.serializeItemValue(e,t[1],!1,i)}}),a=e.comment.trim()),{time:s.toTagData(e.date),user:n({userInfo:e.user}),changes:r,comment:a}},serializeItemValue:function(t,e){if(null==e||""===e)return"-";if(/Date$/i.test(t))return s.format(e,"LL");switch(t){case"users":return e.map(function(t){return(t.label||"").replace(/\s*\(.*?\)/,"")}).join(", ");case"status":return this.t("status:"+e);case"intervalUnit":return this.t("interval:unit:"+e);case"type":var i=l.forProperty(t).get(e);return i?i.getLabel():e;case"name":case"sn":return e.length<=43?e:{more:e,toString:function(){return e.substr(0,40)+"..."}};default:return e||""}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.lastChangeCount=this.model.get("changes").length,this.listenTo(this.model,"change:changes",this.updateHistory),this.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",template:this.$el.popover.Constructor.DEFAULTS.template.replace('class="popover"','class="popover toolcal-tools-history-popover"'),title:function(){return e(this).closest("tr").children().first().text()}}),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4))},updateHistory:function(){for(var t=this.model.get("changes"),i="",s=this.lastChangeCount;s<t.length;++s)i+=u({item:this.serializeItem(t[s],s)});e(i).insertAfter(this.$(".toolcal-tools-history-item").last()).addClass("highlight"),this.lastChangeCount=t.length},updateTimes:function(){this.$(".toolcal-tools-history-time").each(function(){var t=s.toTagData(this.getAttribute("datetime"));this.textContent=t.daysAgo>5?t.long:t.human})}})});