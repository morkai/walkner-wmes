define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","../dictionaries","../Tool","app/wmes-toolcal-tools/templates/form"],function(e,t,i,a,s,n,r,l,o,u,p,d,c){"use strict";return o.extend({template:c,events:e.assign({"change #-interval":function(e){var t=e.target.value.match(/([0-9]+)\s*([mwd])/i);t&&(e.target.value=this.t("interval:"+t[2],{v:t[1]}))}},o.prototype.events),serialize:function(){return e.assign(o.prototype.serialize.call(this),{statuses:p.statuses})},serializeToForm:function(){var t=this.model.toJSON();t.lastDate=t.lastDate?a.format(t.lastDate,"YYYY-MM-DD"):"";var i=this.model.groupUsers(!1);return e.forEach(i,function(i,a){t[a+"Users"]=e.pluck(i,"id").join(",")}),t},serializeForm:function(e){var t=this;e.users=[],["individual","current"].forEach(function(i){var a=t.$id(i+"Users").select2("data").map(function(e){return{id:e.id,label:e.text,kind:i}}).filter(function(e){return!!e.id});e.users=e.users.concat(a)}),e.interval=+e.interval;var i=a.getMoment(e.lastDate,"YYYY-MM-DD");return e.lastDate=i.isValid()?i.toISOString():null,delete e.certificateFile,e},afterRender:function(){o.prototype.afterRender.call(this),this.$id("type").select2({data:p.types.map(l)}),r.toggle(this.$id("status")),this.setUpUsersSelect2("individual"),this.setUpUsersSelect2("current")},setUpUsersSelect2:function(e){var t=this.options.editMode,i=this.model,a=[];if(t){var n=i.get("users");Array.isArray(n)&&n.length&&(a=n.filter(function(t){return t.kind===e}).map(function(e){return{id:e.id,text:e.label}}))}u(this.$id(e+"Users"),{multiple:!0,noPersonnelId:!0}).select2("data",a).select2("enable",s.isAllowedTo("TOOLCAL:MANAGE"))},submitRequest:function(){n.msg.saving(),this.$(".panel-footer").find(".btn").prop("disabled",!0);var e=this.$('input[type="file"]').filter(function(){return!!this.value}).get();this.uploadNextFile(e,arguments)},uploadNextFile:function(e,t){var i=this;if(0!==e.length){var a=e.shift(),s=new FormData;s.append("file",a.files[0]);var n=i.ajax({type:"POST",url:"/toolcal/attachments;upload",data:s,processData:!1,contentType:!1});n.fail(i.handleFailure.bind(i)),n.done(function(s){i.model.set(a.name,s,{silent:!0}),i.uploadNextFile(e,t)})}else o.prototype.submitRequest.apply(i,t)},handleSuccess:function(){n.msg.saved(),o.prototype.handleSuccess.apply(this,arguments)},handleFailure:function(){n.msg.hide(null,!0),n.msg.savingFailed(),this.$(".panel-footer").find(".btn").prop("disabled",!1),o.prototype.handleFailure.apply(this,arguments)}})});