define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","../dictionaries","../Tool","app/wmes-toolcal-tools/templates/form"],function(t,e,r,i,s,a,n,l,o,u,c,p){"use strict";function d(t,e){return e}return l.extend({template:p,events:t.assign({"change #-interval":function(t){var e=t.target.value.match(/([0-9]+)\s*([mwd])/i);e&&(t.target.value=this.t("interval:"+e[2],{v:e[1]}))}},l.prototype.events),serialize:function(){return t.assign(l.prototype.serialize.call(this),{statuses:u.statuses})},serializeToForm:function(){var e=this.model.toJSON();e.lastDate=e.lastDate?i.format(e.lastDate,"YYYY-MM-DD"):"";var r=this.model.groupUsers(!1);return t.forEach(r,function(r,i){e[i+"Users"]=t.pluck(r,"id").join(",")}),e},serializeForm:function(t){var e=this;t.users=[],["individual","current"].forEach(function(r){var i=e.$id(r+"Users").select2("data").map(function(t){return{id:t.id,label:t.text,kind:r}}).filter(function(t){return!!t.id});t.users=t.users.concat(i)}),t.interval=+t.interval;var r=i.getMoment(t.lastDate,"YYYY-MM-DD");return t.lastDate=r.isValid()?r.toISOString():null,t},afterRender:function(){l.prototype.afterRender.call(this),this.$id("type").select2({data:u.types.map(n)}),a.toggle(this.$id("status")),this.setUpUsersSelect2("individual"),this.setUpUsersSelect2("current")},setUpUsersSelect2:function(t){var e=this.options.editMode,r=this.model,i=[];if(e){var a=r.get("users");Array.isArray(a)&&a.length&&(i=a.filter(function(e){return e.kind===t}).map(function(t){return{id:t.id,text:t.label}}))}o(this.$id(t+"Users"),{multiple:!0,textFormatter:d}).select2("data",i).select2("enable",s.isAllowedTo("TOOLCAL:MANAGE"))}})});