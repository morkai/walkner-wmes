define(["jquery","../broker","../pubsub","../user","../wmes-toolcal-types/TypeCollection"],function(e,l,t,n,o){"use strict";var r={type:"types"},u=null,i=null,a=null,s={statuses:["in-use","retired"],types:new o,loaded:!1,load:function(){return null!==i&&(clearTimeout(i),i=null),s.loaded?null:null!==u?u:((u=e.ajax({url:"/toolcal/dictionaries"})).done(function(e){s.loaded=!0,d(e)}),u.fail(c),u.always(function(){u=null}),(a=t.sandbox()).subscribe("toolcal.types.**",f),u)},unload:function(){null!==i&&clearTimeout(i),i=setTimeout(c,3e4)},getLabel:function(e,l){if("string"==typeof e&&(e=this.forProperty(e)||s[e]),!e||Array.isArray(e))return l;var t=e.get(l);return t?t.getLabel():l},forProperty:function(e){return this[r[e]]||null}};function d(e){["types"].forEach(function(l){s[l].reset(e?e[l]:[])})}function c(){i=null,null!==a&&(a.destroy(),a=null),s.loaded=!1,d()}function f(e,t){var n=t.split("."),o=s[n[1]];if(o){switch(n[2]){case"added":o.add(e.model);break;case"edited":var r=o.get(e.model._id);r&&r.set(e.model);break;case"deleted":o.remove(o.get(e.model._id))}l.publish(t,e)}}return s});