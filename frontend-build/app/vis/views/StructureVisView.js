// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","d3","app/user","app/data/divisions","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/workCenters","app/data/prodLines","app/core/View","app/vis/templates/structureLegend"],function(t,e,i,n,s,o,r,a,d,l,c,h){"use strict";var u={};return c.extend({className:"vis-structure",localTopics:{"divisions.synced":"serializeAndRestart","subdivisions.synced":"serializeAndRestart","mrpControllers.synced":"serializeAndRestart","prodFlows.synced":"serializeAndRestart","workCenters.synced":"serializeAndRestart","prodLines.synced":"serializeAndRestart"},deactivatedVisible:!1,initialize:function(){this.onResize=t.debounce(this.onResize.bind(this),100),this.idToIndex={},this.listenTo(this.model.nodePositions,"change",this.onPositionChange),e(window).on("resize."+this.idPrefix,this.onResize)},destroy:function(){e(window).off("."+this.idPrefix),this.force&&(this.force.stop(),this.force=null),this.nodes=null,this.links=null,this.vis=null},beforeRender:function(){this.$el.empty(),this.serializeNodesAndLinks()},afterRender:function(){var t=this.getSize();this.setUpVis(t),this.setUpForce(t),this.restart(),this.$el.append(h()),this.zoom(.15,this.model.nodePositions.get("root"))},getSize:function(){var t=window.innerWidth-28,i=window.innerHeight-14-parseInt(e("body").css("margin-top"),10)-e(".page > .hd").outerHeight(!0)-e(".page > .ft").outerHeight(!0);return{width:t,height:i}},onResize:function(){var t=this.getSize();this.$("svg").attr(t).find("rect").attr(t),this.force.size([t.width,t.height])},serializeAndRestart:function(){this.serializeNodesAndLinks(),this.restart()},serializeNodesAndLinks:function(){function t(t,s,o){var r=t+":"+o.id,a=e.model.nodePositions.getPosition(r),d={type:t,id:r,label:o.getLabel(),deactivated:!!o.get("deactivatedAt"),x:a.x,y:a.y,fixed:a.fixed},l=i.length;i.push(d),u[d.id]=l,"division"===t?n.push({source:l,target:0}):[].concat(o.get(s)).forEach(function(t){var e=s+":"+t,o=u[e],r=i[o];r.fixed&&!d.fixed&&(d.x=r.x,d.y=r.y),o&&n.push({source:l,target:o})})}var e=this,i=e.nodes=[],n=e.links=[],c=e.model.nodePositions.getPosition("root"),h={type:"root",id:"root",label:"PLP",deactivated:!1,x:c.x,y:c.y,fixed:c.fixed};i.push(h);var u=e.idToIndex={root:0};s.forEach(t.bind(null,"division",null)),o.forEach(t.bind(null,"subdivision","division")),r.forEach(t.bind(null,"mrpController","subdivision")),a.forEach(t.bind(null,"prodFlow","mrpController")),d.forEach(function(t){var s="workCenter:"+t.id,o=e.model.nodePositions.getPosition(s),r={type:"workCenter",id:s,label:t.getLabel(),deactivated:!!t.get("deactivatedAt"),x:o.x,y:o.y,fixed:o.fixed};i.push(r);var a=i.length-1;u[r.id]=a;var d=u["mrpController:"+t.get("mrpController")]||u["prodFlow:"+t.get("prodFlow")];d&&n.push({source:a,target:d})}),l.forEach(t.bind(null,"prodLine","workCenter"))},setUpVis:function(t){function e(){n.vis.attr("transform","translate("+i.event.translate+") scale("+i.event.scale+")"),i.event.scale>=.5?n.$("text").fadeIn():n.$("text").fadeOut()}var n=this,s=i.behavior.zoom().on("zoom",e),o=i.select(this.el).append("svg").attr("width",t.width).attr("height",t.height).attr("pointer-events","all").append("g").call(s);o.append("rect").attr("width",t.width).attr("height",t.height).attr("fill","#f8f8f8"),this.zoom=function(e,i){s.scale(e),i&&null!==i.get("x")&&s.translate([-i.get("x")*e+t.width/2,-i.get("y")*e+t.height/2]),s.event(o)},this.vis=o.append("g")},setUpForce:function(t){var e=i.layout.force().nodes(this.nodes).links(this.links).gravity(.05).distance(function(t){return t.distance||100}).charge(-500).size([t.width,t.height]),n=this;e.on("tick",function(){n.vis&&(n.vis.selectAll(".link").attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),n.vis.selectAll(".node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}))}),this.force=e},getNodeClassNames:function(t){return"node "+t.type+" "+(t.deactivated?"is-deactivated":"")},enterNodes:function(t){var e=this,n=this.force.drag(),s=t.enter().append("g").attr("class",this.getNodeClassNames).style("display",function(t){return e.deactivatedVisible||!t.deactivated?"":"none"}).call(n).on("mousedown",function(){i.event.stopPropagation()}).on("dblclick",function(t){i.event.stopPropagation(),e.freePosition(t)});n.on("dragend",e.fixPosition.bind(e));var o=i.svg.symbol().size(800).type(function(t){return u[t.type]||"circle"});s.append("path").attr("d",o),s.append("text").attr("x",20).attr("y",4).text(function(t){return t.label})},updateNodes:function(t){t.attr("class",this.getNodeClassNames).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),t.selectAll("text").text(function(t){return t.label})},exitNodes:function(t){t.exit().remove()},restart:function(){this.restartLinks(),this.restartNodes(),this.restartForce()},restartLinks:function(t){var e=this,i=this.force.nodes(),n=this.vis.selectAll(".link").data(this.links,function(t){var e=i[t.source],n=i[t.target];return t.deactivated=e&&e.deactivated||n&&n.deactivated,t.source+"-"+t.target});n.enter().insert("line","g.node").attr("class",function(t){return"link "+(t.deactivated?"is-deactivated":"")}).style("display",function(t){return e.deactivatedVisible||!t.deactivated?"":"none"}),n.exit().remove(),t&&this.restartForce()},restartNodes:function(t){var e=this.vis.selectAll("g.node").data(this.nodes,function(t){return t.id});this.updateNodes(e),this.enterNodes(e),this.exitNodes(e),t&&this.restartForce()},restartForce:function(){this.force.nodes(this.nodes).links(this.links).start()},showDeactivated:function(){this.$(".is-deactivated").css("display","")},hideDeactivated:function(){this.$(".is-deactivated").css("display","none")},freePosition:function(t){n.isAllowedTo("REPORTS:MANGE")&&this.promised(this.model.nodePositions.update(t.id,null,null))},fixPosition:function(t){n.isAllowedTo("REPORTS:MANGE")&&this.promised(this.model.nodePositions.update(t.id,t.x,t.y))},onPositionChange:function(t){var e=this.nodes[this.idToIndex[t.id]];if(e){var i=t.get("x"),n=t.get("y");null===i||null===n?e.fixed=!1:(e.fixed=!0,e.x=i,e.y=n,e.px=i,e.py=n),this.restartForce()}}})});