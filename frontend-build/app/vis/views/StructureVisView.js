define(["underscore","jquery","d3","app/i18n","app/data/divisions","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/workCenters","app/data/prodLines","app/core/View","app/vis/templates/structureLegend","i18n!app/nls/vis"],function(e,t,n,r,i,o,a,s,l,d,u,c){var p={};return u.extend({className:"vis-structure",localTopics:{"divisions.synced":"serializeAndRestart","subdivisions.synced":"serializeAndRestart","mrpControllers.synced":"serializeAndRestart","prodFlows.synced":"serializeAndRestart","workCenters.synced":"serializeAndRestart","prodLines.synced":"serializeAndRestart"},destroy:function(){t(window).off("resize",this.onResize),this.force&&(this.force.stop(),this.force=null),this.nodes=null,this.links=null,this.vis=null},beforeRender:function(){this.$el.empty(),this.serializeNodesAndLinks()},afterRender:function(){var n=this.getSize();this.setUpVis(n),this.setUpForce(n),this.restart(),this.onResize=e.debounce(this.onResize.bind(this),100),t(window).on("resize",this.onResize),this.$el.append(c())},getSize:function(){var e=window.innerWidth-28,n=window.innerHeight-28-parseInt(t("body").css("margin-top"),10)-t(".page > .hd").outerHeight(!0)-t(".page > .ft").outerHeight(!0);return{width:e,height:n}},onResize:function(){var e=this.getSize();this.$("svg").attr(e).find("rect").attr(e),this.force.size([e.width,e.height])},serializeAndRestart:function(){this.serializeNodesAndLinks(),this.restart()},serializeNodesAndLinks:function(){function e(e,i,o){t.push({type:e,id:o.id,label:o.getLabel()});var a=t.length-1;r[o.id]=a,"division"===e?n.push({source:a,target:0}):[].concat(o.get(i)).forEach(function(e){var t=r[e];t&&n.push({source:a,target:t})})}var t=this.nodes=[],n=this.links=[];t.push({type:"root",id:"root",label:"PHILIPS"});var r={root:0};i.forEach(e.bind(null,"division",null)),o.forEach(e.bind(null,"subdivision","division")),a.forEach(e.bind(null,"mrpController","subdivision")),s.forEach(e.bind(null,"prodFlow","mrpController")),l.forEach(function(e){t.push({type:"workCenter",id:e.id,label:e.getLabel()});var i=t.length-1;r[e.id]=i;var o=r[e.get("mrpController")||e.get("prodFlow")];o&&n.push({source:i,target:o})}),d.forEach(e.bind(null,"prodLine","workCenter"))},setUpVis:function(e){function t(){r.vis.attr("transform","translate("+n.event.translate+") scale("+n.event.scale+")"),n.event.scale>=.5?r.$("text").fadeIn():r.$("text").fadeOut()}var r=this,i=n.select(this.el).append("svg").attr("width",e.width).attr("height",e.height).attr("pointer-events","all").append("g").call(n.behavior.zoom().on("zoom",t));i.append("rect").attr("width",e.width).attr("height",e.height).attr("fill","#f8f8f8"),this.vis=i.append("g")},setUpForce:function(e){var t=n.layout.force().nodes(this.nodes).links(this.links).gravity(.05).distance(function(e){return e.distance||100}).charge(-500).size([e.width,e.height]),r=this;t.on("tick",function(){r.vis.selectAll(".link").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),r.vis.selectAll(".node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"})}),this.force=t},getNodeClassNames:function(e){return"node "+e.type},enterNodes:function(e){var t=e.enter().append("g").attr("class",this.getNodeClassNames).call(this.force.drag).on("mousedown",function(){n.event.stopPropagation()}),r=n.svg.symbol().size(800).type(function(e){return p[e.type]||"circle"});t.append("path").attr("d",r),t.append("text").attr("x",20).attr("y",4).text(function(e){return e.label})},updateNodes:function(e){e.attr("class",this.getNodeClassNames),e.selectAll("text").text(function(e){return e.label})},exitNodes:function(e){e.exit().remove()},restart:function(){this.restartLinks(),this.restartNodes(),this.restartForce()},restartLinks:function(e){var t=this.vis.selectAll(".link").data(this.links,function(e){return e.source+"-"+e.target});t.enter().insert("line","g.node").attr("class","link").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),t.exit().remove(),e&&this.restartForce()},restartNodes:function(e){var t=this.vis.selectAll("g.node").data(this.nodes,function(e){return e.id});this.updateNodes(t),this.enterNodes(t),this.exitNodes(t),e&&this.restartForce()},restartForce:function(){this.force.nodes(this.nodes).links(this.links).start()}})});