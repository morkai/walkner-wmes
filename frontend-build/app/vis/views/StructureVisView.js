// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","d3","app/data/divisions","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/workCenters","app/data/prodLines","app/core/View","app/vis/templates/structureLegend"],function(t,e,i,s,n,r,a,o,d,l,c){"use strict";var h={};return l.extend({className:"vis-structure",localTopics:{"divisions.synced":"serializeAndRestart","subdivisions.synced":"serializeAndRestart","mrpControllers.synced":"serializeAndRestart","prodFlows.synced":"serializeAndRestart","workCenters.synced":"serializeAndRestart","prodLines.synced":"serializeAndRestart"},initialize:function(){this.onResize=t.debounce(this.onResize.bind(this),100),e(window).on("resize",this.onResize)},destroy:function(){e(window).off("resize",this.onResize),this.force&&(this.force.stop(),this.force=null),this.nodes=null,this.links=null,this.vis=null},beforeRender:function(){this.$el.empty(),this.serializeNodesAndLinks()},afterRender:function(){var t=this.getSize();this.setUpVis(t),this.setUpForce(t),this.restart(),this.$el.append(c())},getSize:function(){var t=window.innerWidth-28,i=window.innerHeight-14-parseInt(e("body").css("margin-top"),10)-e(".page > .hd").outerHeight(!0)-e(".page > .ft").outerHeight(!0);return{width:t,height:i}},onResize:function(){var t=this.getSize();this.$("svg").attr(t).find("rect").attr(t),this.force.size([t.width,t.height])},serializeAndRestart:function(){this.serializeNodesAndLinks(),this.restart()},serializeNodesAndLinks:function(){function t(t,s,n){e.push({type:t,id:n.id,label:n.getLabel(),deactivated:!!n.get("deactivatedAt")});var r=e.length-1;l[n.id]=r,"division"===t?i.push({source:r,target:0}):[].concat(n.get(s)).forEach(function(t){var e=l[t];e&&i.push({source:r,target:e})})}var e=this.nodes=[],i=this.links=[];e.push({type:"root",id:"root",label:"PHILIPS"});var l={root:0};s.forEach(t.bind(null,"division",null)),n.forEach(t.bind(null,"subdivision","division")),r.forEach(t.bind(null,"mrpController","subdivision")),a.forEach(t.bind(null,"prodFlow","mrpController")),o.forEach(function(t){e.push({type:"workCenter",id:t.id,label:t.getLabel()});var s=e.length-1;l[t.id]=s;var n=l[t.get("mrpController")||t.get("prodFlow")];n&&i.push({source:s,target:n})}),d.forEach(t.bind(null,"prodLine","workCenter"))},setUpVis:function(t){function e(){s.vis.attr("transform","translate("+i.event.translate+") scale("+i.event.scale+")"),i.event.scale>=.5?s.$("text").fadeIn():s.$("text").fadeOut()}var s=this,n=i.select(this.el).append("svg").attr("width",t.width).attr("height",t.height).attr("pointer-events","all").append("g").call(i.behavior.zoom().on("zoom",e));n.append("rect").attr("width",t.width).attr("height",t.height).attr("fill","#f8f8f8"),this.vis=n.append("g")},setUpForce:function(t){var e=i.layout.force().nodes(this.nodes).links(this.links).gravity(.05).distance(function(t){return t.distance||100}).charge(-500).size([t.width,t.height]),s=this;e.on("tick",function(){s.vis.selectAll(".link").attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),s.vis.selectAll(".node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}),this.force=e},getNodeClassNames:function(t){return"node "+t.type},enterNodes:function(t){var e=t.enter().append("g").attr("class",this.getNodeClassNames).call(this.force.drag).on("mousedown",function(){i.event.stopPropagation()}),s=i.svg.symbol().size(800).type(function(t){return h[t.type]||"circle"});e.append("path").attr("d",s),e.append("text").attr("x",20).attr("y",4).text(function(t){return t.label})},updateNodes:function(t){t.attr("class",this.getNodeClassNames),t.selectAll("text").text(function(t){return t.label})},exitNodes:function(t){t.exit().remove()},restart:function(){this.restartLinks(),this.restartNodes(),this.restartForce()},restartLinks:function(t){var e=this.force.nodes(),i=this.vis.selectAll(".link").data(this.links,function(t){return t.source+"-"+t.target});i.enter().insert("line","g.node").attr("class",function(t){var i=e[t.source],s=e[t.target],n=i&&i.deactivated||s&&s.deactivated;return"link"+(n?" is-deactivated":"")}),i.exit().remove(),t&&this.restartForce()},restartNodes:function(t){var e=this.vis.selectAll("g.node").data(this.nodes,function(t){return t.id});this.updateNodes(e),this.enterNodes(e),this.exitNodes(e),t&&this.restartForce()},restartForce:function(){this.force.nodes(this.nodes).links(this.links).start()}})});