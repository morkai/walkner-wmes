define(["jquery","app/time","app/core/View","app/core/util/bindLoadingMessage","app/data/colorFactory","app/planning/PlanSettings","app/orders/OrderCollection","../OrderGroupCollection","../views/TesterFilterView","../views/TesterGroupsView","app/planning-orderGroups/templates/tester/page"],function(e,t,r,n,o,s,i,a,l,u,d){"use strict";return r.extend({template:d,modelProperty:"orderGroups",breadcrumbs:function(){return[{href:"#planning/plans",label:this.t("BREADCRUMB:base")},{href:"#planning/orderGroups",label:this.t("BREADCRUMB:browse")},this.t("tester:breadcrumb")]},initialize:function(){this.orderGroups=n(new a([],{rqlQuery:"sort(name)&limit(0)",sortByName:!0}),this),this.planSettings=n(new s({_id:this.model.get("date")}),this),this.sapOrders=n(new i([],{rqlQuery:"select(mrp,nc12,qty,name,description,bom)&limit(0)&statuses=in=REL&statuses=nin=(TECO,DLT,DLFL)&scheduledStartDate="+t.getMoment(this.model.get("date"),"YYYY-MM-DD").valueOf()+"&mrp="+this.model.get("mrp")}),this),this.filterView=new l({model:this.model}),this.groupsView=new u({model:this.model}),this.setView("#-filter",this.filterView),this.setView("#-groups",this.groupsView),this.listenTo(this.model,"filtered",this.onFiltered),this.once("afterLoad",this.matchGroups)},load:function(e){return e(this.orderGroups.fetch({reset:!0}),this.sapOrders.fetch({reset:!0}),this.planSettings.fetch())},onFiltered:function(){var r=this,n=r.model.get("mrp"),o=r.model.get("date"),s=t.getMoment(o,"YYYY-MM-DD").valueOf();r.planSettings.set("_id",o),r.sapOrders.rqlQuery.selector.args.forEach(function(e){"eq"===e.name&&"scheduledStartDate"===e.args[0]?e.args[1]=s:"eq"===e.name&&"mrp"===e.args[0]&&(e.args[1]=n)}),r.model.set("loading",!0),r.load(e.when.bind(e)).then(function(){r.model.set("loading",!1),r.matchGroups()}),r.broker.publish("router.navigate",{url:"/planning/orderGroups;tester?date="+o+"&mrp="+n,replace:!0,trigger:!1})},matchGroups:function(){const e={},t="planOrderGroup"+Date.now();this.sapOrders.forEach(r=>{r=r.attributes;const n=this.matchSapOrder(r);n.forEach(t=>{e[t.orderGroup.id]||(e[t.orderGroup.id]={orderGroup:t.orderGroup,sapOrders:[]}),e[t.orderGroup.id].sapOrders.push(r)}),r.color=n.length>1?o.getColor(t,r._id):""}),this.model.set({groups:Object.values(e)})},matchSapOrder:function(e){const t=[],r=e.mrp,n=((e.nc12||"")+" "+(e.name||"")+" "+(e.description||"")).trim().toUpperCase(),o=[];(e.bom||[]).forEach(e=>{const t="ITEM "+(e.get("item")||"0000")+" 12NC "+(e.get("nc12")||"000000000000")+" NAME "+(e.get("name")||"?");o.push(t.trim().toUpperCase())});let s=null;return this.orderGroups.forEach(i=>{i.isNoMatchGroup()?s=i:this.matchOrderGroup(i,r,n,o)&&t.push({orderGroup:i,sapOrder:e})}),0===t.length&&t.push({orderGroup:s,sapOrder:e}),t},matchOrderGroup:function(e,t,r,n){return!e.isEmptyGroup()&&this.matchMrp(e.get("mrp"),t)&&this.matchProductInclude(e.get("productInclude"),r)&&this.matchProductExclude(e.get("productExclude"),r)&&this.matchBomInclude(e.get("bomInclude"),n)&&this.matchBomExclude(e.get("bomExclude"),n)},matchAllWords:function(e,t){if(1===e.length)return t.includes(e[0]);for(var r=0;r<e.length;++r)if(!t.includes(e[r]))return!1;return!0},matchAnyWord:function(e,t){return e.filter(e=>t.includes(e))},matchMrp:function(e,t){return 0===e.length||e.includes(t)},matchProductInclude:function(e,t){return 0===e.length||e.some(e=>this.matchAllWords(e,t))},matchProductExclude:function(e,t){return 0===e.length||e.every(e=>!this.matchAllWords(e,t))},matchBomInclude:function(e,t){if(0===e.length)return!0;for(let r=0;r<e.length;++r){const n=e[r],o=new Set;for(let e=0;e<t.length;++e)this.matchAnyWord(n,t[e]).forEach(e=>o.add(e));if(o.size===n.length)return!0}return!1},matchBomExclude:function(e,t){if(0===e.length)return!0;for(let r=0;r<e.length;++r){const n=e[r],o=new Set;for(let e=0;e<t.length;++e)this.matchAnyWord(n,t[e]).forEach(e=>o.add(e));if(o.size===n.length)return!1}return!0}})});