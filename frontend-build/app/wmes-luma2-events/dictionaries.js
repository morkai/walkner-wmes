define(["jquery","../broker","../pubsub","../wmes-luma2-lines/LineCollection"],function(e,l,n,t){"use strict";var u={line:"lines"},r=null,i=null,o=null,a={types:[],lines:new t,loaded:!1,load:function(){return null!==i&&(clearTimeout(i),i=null),a.loaded?null:null!==r?r:((r=e.ajax({url:"/luma2/dictionaries"})).done(function(e){a.loaded=!0,s(e)}),r.fail(d),r.always(function(){r=null}),o=n.sandbox(),Object.keys(u).forEach(function(e){o.subscribe("luma2."+u[e]+".**",c)}),r)},unload:function(){null!==i&&clearTimeout(i),i=setTimeout(d,3e4)},getLabel:function(e,l){if("string"==typeof e&&(e=this.forProperty(e)||a[e]),!e||Array.isArray(e))return l;var n=e.get(l);return n?n.getLabel():l},forProperty:function(e){return this[u[e]]||null}};function s(e){e&&e.types&&(a.types=e.types),Object.keys(u).forEach(function(l){var n=u[l];a[n].reset(e?e[n]:[])})}function d(){i=null,null!==o&&(o.destroy(),o=null),a.loaded=!1,s()}function c(e,n){var t=n.split("."),u=a[t[1]];if(u){switch(t[2]){case"added":u.add(e.model);break;case"edited":var r=u.get(e.model._id);r&&r.set(e.model);break;case"deleted":u.remove(u.get(e.model._id))}l.publish(n,e)}}return a});