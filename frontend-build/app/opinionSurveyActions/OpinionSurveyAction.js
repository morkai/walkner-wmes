// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../i18n","../time","../user","../core/Model","../opinionSurveys/dictionaries","../opinionSurveys/OpinionSurvey","app/core/templates/userInfo"],function(t,e,i,r,n,o,s){"use strict";return r.extend({urlRoot:"/opinionSurveys/actions",clientUrlRoot:"#opinionSurveyActions",topicPrefix:"opinionSurveys.actions",privilegePrefix:"OPINION_SURVEYS",nlsDomain:"opinionSurveyActions",labelAttribute:"rid",defaults:{status:"planned"},url:function(){var t=r.prototype.url.apply(this,arguments);return this.isNew()?t:t+"?populate(survey)"},serialize:function(i){var r=this.toJSON();i||(i=new o(r.survey&&r.survey._id?r.survey:{_id:r.survey})),i.cacheMaps||i.buildCacheMaps();var a=n.divisions.get(r.division);return r.division=a?a.get("short"):r.division||"?",r.survey=i.get("label")||i.id,r.createdAt=e.format(r.createdAt,"LLLL"),r.creator=s({userInfo:r.creator}),r.updatedAt=r.updatedAt?e.format(r.updatedAt,"LLLL"):"-",r.updater=s({userInfo:r.updater}),r.owners=r.owners.map(function(t){return s({userInfo:t})}).join(", "),r.superior=s({userInfo:r.superior}),r.startDate=r.startDate?e.format(r.startDate,"LL"):"-",r.finishDate=r.finishDate?e.format(r.finishDate,"LL"):"-",r.status=t("opinionSurveyActions","status:"+r.status),r.question=r.question||"-",r.problem=r.problem||"-",r.cause=r.cause||"-",r.action=r.action||"-",r},canEdit:function(){return i.isAllowedTo("OPINION_SURVEYS:MANAGE")||this.attributes.participants.indexOf(i.data._id)!==-1},canDelete:function(){return i.isAllowedTo("OPINION_SURVEYS:MANAGE")||this.attributes.creator.id===i.data._id}})});