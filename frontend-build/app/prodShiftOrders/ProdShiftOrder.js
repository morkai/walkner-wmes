define(["underscore","../user","../time","../data/prodLog","../core/Model","../core/util/getShiftEndDate"],function(e,t,n,r,i,o){return i.extend({urlRoot:"/prodShiftOrders",clientUrlRoot:"#prodShiftOrders",topicPrefix:"prodShiftOrders",privilegePrefix:"PROD_DATA",nlsDomain:"prodShiftOrders",defaults:{prodShift:null,division:null,subdivision:null,mrpControllers:null,prodFlow:null,workCenter:null,prodLine:null,date:null,shift:null,mechOrder:null,orderId:null,operationNo:null,orderData:null,workerCount:null,quantityDone:null,creator:null,startedAt:null,finishedAt:null},sync:function(e){if("read"===e)return i.prototype.sync.apply(this,arguments);throw new Error("Method not supported: "+e)},onShiftChanged:function(){this.set({_id:null,prodShift:null,division:null,subdivision:null,mrpControllers:null,prodFlow:null,workCenter:null,prodLine:null,date:null,shift:null,workerCount:null,quantityDone:null,creator:null,startedAt:null,finishedAt:null})},onOrderChanged:function(e,r,i){this.prepareOperations(r),this.set({prodShift:e.id,division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,date:e.get("date"),shift:e.get("shift"),mechOrder:null===r.no,orderId:r.no||r.nc12,operationNo:i,orderData:r,workerCount:0,quantityDone:0,creator:t.getInfo(),startedAt:n.getMoment().toDate(),finishedAt:null}),this.generateId(e)},onOrderContinued:function(e){this.set({prodShift:e.id,division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,date:e.get("date"),shift:e.get("shift"),workerCount:0,quantityDone:0,creator:t.getInfo(),startedAt:n.getMoment().toDate(),finishedAt:null}),this.generateId(e)},generateId:function(e){this.set("_id",r.generateId(this.get("startedAt"),e.id+this.get("orderId")))},onWorkEnded:function(){this.clear()},getOrderNo:function(){var e=this.get("orderData");return e?e.no||"?":"-"},getNc12:function(){var e=this.get("orderData");return e?e.nc12||"?":"-"},getProductName:function(){var e=this.get("orderData");return e?e.name||"?":"-"},getOperationName:function(){var e=this.get("orderData"),t=this.get("operationNo");return e&&t?e.operations&&e.operations[t]?e.operations[t].name||t:t:"-"},getTaktTime:function(){var e=this.get("orderData"),t=this.get("operationNo");if(!e||!t)return"-";var n=e.operations?e.operations[t]:null;if(!n)return"?";var r=this.get("workerCount");return r||(r=this.getWorkerCountSap()),"number"!=typeof r||0===r||n.laborTime<=0?"?":Math.max(Math.round(3600*(1.053*n.laborTime/r)/100),1)},getActualTaktTime:function(){var e=n.getMoment(this.get("finishedAt"));if(!e.isValid())return"-";var t=e.diff(this.get("startedAt"),"seconds"),r=this.get("quantityDone");return r?Math.max(1,Math.round(t/r)):"?"},getWorkerCountSap:function(){var e=this.get("orderData"),t=this.get("operationNo");if(!e||!t)return"-";var n=e.operations?e.operations[t]:null;return!n||n.laborTime<=0||n.machineTime<=0?"?":Math.max(Math.round(n.laborTime/n.machineTime),1)},getWorkerCount:function(){return this.get("workerCount")||0},getMaxWorkerCount:function(){var e=this.getWorkerCountSap();return"number"==typeof e?e+Math.max(1,Math.round(.25*e)):15},getMaxQuantityDone:function(){var e=this.get("orderData");return e&&e.qty?Math.ceil(1.25*e.qty):999},getStartedAt:function(){var e=this.get("startedAt");return e?n.format(e,"HH:mm:ss"):"?"},getQuantityDone:function(){return this.get("quantityDone")||0},hasOrderData:function(){return!!this.get("orderId")&&!!this.get("operationNo")&&!!this.get("orderData")},finish:function(){if(!this.id||null!=this.get("finishedAt"))return null;var e=n.getMoment().toDate(),t=o(this.get("date"),this.get("shift"));return e>t&&(e=t),this.set("finishedAt",e),{_id:this.id,finishedAt:e}},prepareOperations:function(t){var n={};return Array.isArray(t.operations)?t.operations.forEach(function(e){n[e.no]=e}):e.isObject(t.operations)&&(n=t.operations),t.operations=n,t}})});