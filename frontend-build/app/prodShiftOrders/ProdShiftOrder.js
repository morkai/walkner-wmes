// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../user","../time","../data/prodLog","../data/subdivisions","../core/Model","../core/util/getShiftEndDate"],function(t,e,r,n,o,i,a){return i.extend({urlRoot:"/prodShiftOrders",clientUrlRoot:"#prodShiftOrders",topicPrefix:"prodShiftOrders",privilegePrefix:"PROD_DATA",nlsDomain:"prodShiftOrders",defaults:{pressWorksheet:null,prodShift:null,division:null,subdivision:null,mrpControllers:null,prodFlow:null,workCenter:null,prodLine:null,date:null,shift:null,mechOrder:null,orderId:null,operationNo:null,orderData:null,workerCount:null,totalQuantity:null,quantityDone:null,quantityLost:null,creator:null,startedAt:null,finishedAt:null,master:null,leader:null,operator:null,operators:null},getLabel:function(){return this.get("prodLine")+": "+this.get("orderId")+", "+this.get("operationNo")},onShiftChanged:function(){this.set({_id:null,prodShift:null,division:null,subdivision:null,mrpControllers:null,prodFlow:null,workCenter:null,prodLine:null,date:null,shift:null,workerCount:null,totalQuantity:null,quantityDone:null,quantityLost:null,losses:null,creator:null,startedAt:null,finishedAt:null,master:null,leader:null,operator:null,operators:null})},onOrderChanged:function(t,n,o){this.prepareOperations(n),this.set({prodShift:t.id,division:t.get("division"),subdivision:t.get("subdivision"),mrpControllers:t.get("mrpControllers"),prodFlow:t.get("prodFlow"),workCenter:t.get("workCenter"),prodLine:t.prodLine.id,date:t.get("date"),shift:t.get("shift"),mechOrder:null===n.no,orderId:n.no||n.nc12,operationNo:o,orderData:n,workerCount:0,totalQuantity:0,quantityDone:0,quantityLost:0,losses:null,creator:e.getInfo(),startedAt:r.getMoment().toDate(),finishedAt:null,master:t.get("master"),leader:t.get("leader"),operator:t.get("operator"),operators:t.get("operators")}),this.generateId(t)},onOrderCorrected:function(t,r,n){var o=r.no||r.nc12;if(o===this.get("orderId")&&n===this.get("operationNo"))return null;this.prepareOperations(r);var i={mechOrder:null===r.no,orderId:o,operationNo:n,orderData:r,creator:e.getInfo()};return this.set(i),this.get("workerCount")>this.getMaxWorkerCount()&&t.changeWorkerCount(0),this.get("quantityDone")>this.getMaxQuantityDone()&&t.changeQuantityDone(0),i},onOrderContinued:function(t){this.set({prodShift:t.id,division:t.get("division"),subdivision:t.get("subdivision"),mrpControllers:t.get("mrpControllers"),prodFlow:t.get("prodFlow"),workCenter:t.get("workCenter"),prodLine:t.prodLine.id,date:t.get("date"),shift:t.get("shift"),workerCount:0,totalQuantity:0,quantityDone:0,quantityLost:0,losses:null,creator:e.getInfo(),startedAt:r.getMoment().toDate(),finishedAt:null,master:t.get("master"),leader:t.get("leader"),operator:t.get("operator"),operators:t.get("operators")}),this.generateId(t)},generateId:function(t){this.set("_id",n.generateId(this.get("startedAt"),t.id+this.get("orderId")))},onWorkEnded:function(){this.clear()},isMechOrder:function(){return this.get("mechOrder")},getOrderNo:function(){var t=this.get("orderData");return t?t.no||"?":"-"},getNc12:function(){var t=this.get("orderData");return t?t.nc12||"?":"-"},getProductName:function(){var t=this.get("orderData");return t?t.name||"?":"-"},getOperationName:function(){var t=this.get("orderData"),e=this.get("operationNo");return t&&e?t.operations&&t.operations[e]?t.operations[e].name||e:e:"-"},getTaktTime:function(){var t=this.get("orderData"),e=this.get("operationNo");if(!t||!e)return"-";var r=t.operations?t.operations[e]:null;if(!r)return"?";var n=this.get("workerCount");return n||(n=this.getWorkerCountSap()),"number"!=typeof n||0===n||r.laborTime<=0?"?":Math.max(Math.round(1.053*r.laborTime/n*3600/100),1)},getActualTaktTime:function(){var t=r.getMoment(this.get("finishedAt"));if(!t.isValid())return"-";var e=t.diff(this.get("startedAt"),"seconds"),n=this.get("quantityDone");return n?Math.max(1,Math.round(e/n)):"?"},getWorkerCountSap:function(){var t=this.get("orderData"),e=this.get("operationNo");if(!t||!e)return"-";var r=t.operations?t.operations[e]:null;return!r||r.laborTime<=0||r.machineTime<=0?"?":Math.max(Math.round(r.laborTime/r.machineTime),1)},getWorkerCount:function(){return this.get("workerCount")||0},getWorkerCountForEdit:function(){var t=this.getWorkerCount();return 0!==t?t:(t=this.getWorkerCountSap(),"string"==typeof t||0===t?0:t)},getMaxWorkerCount:function(){var t=this.getWorkerCountSap();return"number"==typeof t?t+Math.max(1,Math.round(.25*t)):15},getMaxQuantityDone:function(){var t=this.get("orderData");return t&&t.qty?Math.ceil(1.25*t.qty):999},getStartedAt:function(){var t=this.get("startedAt");return t?r.format(t,"HH:mm:ss"):"?"},getQuantityDone:function(){return this.get("quantityDone")||0},getSubdivisionType:function(){var t=o.get(this.get("subdivision"));return t?t.get("type"):null},getOrderIdType:function(){return"press"===this.getSubdivisionType()?"nc12":"no"},hasOrderData:function(){return!!this.get("orderId")&&!!this.get("operationNo")&&!!this.get("orderData")},isEditable:function(){return this.hasEnded()&&!this.isFromPressWorksheet()},hasEnded:function(){return null!=this.get("finishedAt")},isFromPressWorksheet:function(){return null!=this.get("pressWorksheet")},finish:function(){if(!this.id||this.hasEnded())return null;var t=r.getMoment().toDate(),e=a(this.get("date"),this.get("shift"));return t>e&&(t=e),this.set("finishedAt",t),{_id:this.id,finishedAt:t}},prepareOperations:function(e){if(Array.isArray(e.operations)){var r={};e.operations.forEach(function(t){""!==t.workCenter&&-1!==t.laborTime&&(r[t.no]=t)}),e.operations=r}else t.isObject(e.operations)||(e.operations={});return e}})});