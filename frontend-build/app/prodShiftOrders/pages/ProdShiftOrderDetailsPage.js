// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/user","app/viewport","app/core/util/bindLoadingMessage","app/core/util/pageActions","app/core/util/onModelDeleted","app/core/View","app/prodChangeRequests/util/createDeletePageAction","app/delayReasons/storage","app/production/settings","app/mechOrders/MechOrder","app/mechOrders/views/MechOrderDetailsView","app/orders/Order","app/orders/OperationCollection","app/orders/views/OrderDetailsView","app/orders/views/OperationListView","app/prodDowntimes/ProdDowntimeCollection","app/prodDowntimes/views/ProdDowntimeListView","app/prodSerialNumbers/ProdSerialNumberCollection","../ProdShiftOrder","../views/ProdShiftOrderDetailsView","../views/SerialNumbersView","app/prodShiftOrders/templates/detailsPage"],function(e,i,t,r,s,d,o,n,h,a,p,l,u,c,f,m,w,O,S,b,g,D,V,T,A){"use strict";return h.extend({template:A,layoutName:"page",pageId:"details",breadcrumbs:function(){return[{label:i.bound("prodShiftOrders","BREADCRUMBS:browse"),href:this.prodShiftOrder.genClientUrl("base")},this.prodShiftOrder.getLabel()]},actions:function(){var e=[{label:i.bound("prodShiftOrders","PAGE_ACTION:prodLogEntries"),icon:"list-ol",href:"#prodLogEntries?sort(createdAt)&limit(20)&prodShiftOrder="+encodeURIComponent(this.prodShiftOrder.id)}];return this.prodShiftOrder.isEditable()&&r.isAllowedTo("PROD_DATA:MANAGE","PROD_DATA:CHANGES:REQUEST")&&e.push(o.edit(this.prodShiftOrder,!1),a(this,this.prodShiftOrder)),e},initialize:function(){this.defineModels(),this.defineViews(),this.listenToOnce(this.prodShiftOrder,"sync",this.onSync),this.setView("#"+this.idPrefix+"-details",this.detailsView),this.insertView("#"+this.idPrefix+"-downtimes",this.downtimesView),this.insertView("#"+this.idPrefix+"-serialNumbers",this.serialNumbersView)},destroy:function(){l.release(),p.release()},defineModels:function(){this.settings=d(l.acquire(),this),this.delayReasons=d(p.acquire(),this),this.prodShiftOrder=d(new D({_id:this.options.modelId},{settings:this.settings}),this),this.prodDowntimes=d(new S(null,{rqlQuery:{sort:{startedAt:1},limit:9999,selector:{name:"and",args:[{name:"eq",args:["prodShiftOrder",this.prodShiftOrder.id]}]}}}),this),this.prodSerialNumbers=d(new g(null,{rqlQuery:{sort:{scannedAt:1},limit:9999,selector:{name:"and",args:[{name:"eq",args:["prodShiftOrder",this.prodShiftOrder.id]}]}}}),this)},defineViews:function(){this.detailsView=new V({model:this.prodShiftOrder}),this.downtimesView=new b({collection:this.prodDowntimes,simple:!0}),this.serialNumbersView=new T({collection:this.prodSerialNumbers,model:this.prodShiftOrder})},load:function(e){return e(this.prodShiftOrder.fetch(),this.prodDowntimes.fetch({reset:!0}),this.prodSerialNumbers.fetch({reset:!0}),this.delayReasons.isEmpty()?this.delayReasons.fetch({reset:!0}):null,this.settings.isEmpty()?this.settings.fetch({reset:!0}):null)},afterRender:function(){l.acquire(),p.acquire(),this.$id("serialNumbers").toggleClass("hidden",!r.isAllowedTo("PROD_DATA:VIEW"))},onSync:function(){this.setUpRemoteTopics();var e=this.prepareOrderData(),t=this.prodShiftOrder;this.order=t.get("mechOrder")?new u(e):new f(e);var r={model:this.order,panelType:"default",panelTitle:i("prodShiftOrders","PANEL:TITLE:orderDetails"),delayReasons:this.delayReasons};this.orderDetailsView=t.get("mechOrder")?new c(r):new w(r),this.operationListView=new O({model:this.order,highlighted:t.get("operationNo"),summedTimes:{laborSetupTime:t.get("laborSetupTime"),laborTime:t.get("laborTime"),machineSetupTime:t.get("machineSetupTime"),machineTime:t.get("machineTime")}}),this.setView("#"+this.idPrefix+"-order",this.orderDetailsView),this.setView("#"+this.idPrefix+"-operations",this.operationListView)},prepareOrderData:function(){var i=e.clone(this.prodShiftOrder.get("orderData"));return i.no&&(i._id=i.no),i.operations=new m(e.values(i.operations||{})),i},setUpRemoteTopics:function(){function e(e){return e.model._id===i}var i=this.prodShiftOrder.get("pressWorksheet");i?(this.pubsub.subscribe("pressWorksheets.edited",this.onWorksheetEdited.bind(this)).setFilter(e),this.pubsub.subscribe("pressWorksheets.deleted",this.onModelDeleted.bind(this)).setFilter(e)):(this.pubsub.subscribe("prodShiftOrders.updated."+this.prodShiftOrder.id,this.onProdShiftOrderUpdated.bind(this)),this.pubsub.subscribe("prodShiftOrders.deleted."+this.prodShiftOrder.id,this.onModelDeleted.bind(this)))},onProdShiftOrderUpdated:function(e){this.prodShiftOrder.set(e)},onWorksheetEdited:function(){this.timers.refreshData=setTimeout(function(e){e.promised(e.prodShiftOrder.fetch()).fail(function(i){404===i.status&&e.onModelDeleted()})},2500,this)},onModelDeleted:function(){n(this.broker,this.prodShiftOrder,null,!0)}})});