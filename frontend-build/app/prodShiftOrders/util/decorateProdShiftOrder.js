// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/time","app/i18n","app/user","app/data/subdivisions","app/data/mrpControllers","app/data/prodFlows","app/data/prodLines","app/data/views/renderOrgUnitPath","app/core/util/getShiftStartInfo","app/core/templates/userInfo"],function(e,t,r,a,o,i,d,n,p,s){"use strict";return function(o,d){var n=o.toJSON(),f=Date.parse(n.startedAt),m=Date.parse(n.finishedAt);if(n.date)n.date=e.format(n.date,"L");else{var l=p(n.startedAt);n.date=l.moment.format("L"),n.shift=l.shift}if(n.shift=t("core","SHIFT:"+n.shift),n.startedAt=e.format(n.startedAt,"LTS"),n.finishedAt=e.format(n.finishedAt,"LTS"),n.duration=m?e.toString((m-f)/1e3):"",n.creator=s({userInfo:n.creator}),d.orgUnits){var c=a.get(n.subdivision),h=i.get(n.prodFlow);n.subdivision=c?c.getLabel():"?",n.prodFlow=h?h.getLabel():"?",n.mrpControllers=Array.isArray(n.mrpControllers)&&n.mrpControllers.length?n.mrpControllers.join("; "):"?"}if(n.prodShift=n.prodShift?'<a href="#prodShifts/'+n.prodShift+'">'+n.date+", "+n.shift+"</a>":n.date+", "+n.shift,n.orderData){var T=(n.orderData.operations||{})[n.operationNo]||{};n.order=n.orderId+": <em>"+(n.orderData.description||n.orderData.name||"?")+"</em>",n.operation=n.operationNo+": <em>"+(T.name||"?")+"</em>"}else n.order=n.orderId,n.operation=n.operationNo;d.orderUrl&&r.isAllowedTo("ORDERS:VIEW")&&(n.orderUrl="#"+(n.mechOrder?"mechOrders":"orders")+"/"+encodeURIComponent(n.orderId)),n.taktTimeOk=o.isTaktTimeOk(),n.taktTimeSap=o.getTaktTime(),n.taktTime=o.getActualTaktTime(),n.taktTimeEff=o.getTaktTimeEfficiency(),n.workerCountSap=o.getWorkerCountSap(),n.efficiency="";var u=o.getEfficiency();return u?n.efficiency=Math.round(100*u)+"%":n.taktTimeEff&&(n.efficiency=n.taktTimeEff+"%"),n}});