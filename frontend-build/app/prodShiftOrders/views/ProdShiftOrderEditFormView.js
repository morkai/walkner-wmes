define(["underscore","app/i18n","app/time","app/viewport","app/core/views/FormView","app/users/util/setUpUserSelect2","app/production/util/orderPickerHelpers","app/prodShiftOrders/templates/editForm"],function(e,t,r,i,s,o,a,d){return s.extend({template:d,idPrefix:"prodShiftOrderEditForm",destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},afterRender:function(){s.prototype.afterRender.call(this),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),a.setUpOrderSelect2(this.$id("order"),this.$id("operation"),this.model),a.setUpOperationSelect2(this.$id("operation"),[]),a.selectOrder(this.$id("order"),this.model),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=o(this.$id(e)),r=this.model.get(e);r&&r.id&&r.label&&t.select2("data",{id:r.id,text:r.label,name:r.label})},showErrorMessage:function(e){return this.$errorMessage=i.msg.show({type:"error",text:t("prodShiftOrders","FORM:ERROR:"+e)}),!1},checkValidity:function(e){return"string"==typeof e.orderId&&e.orderId.length?"string"==typeof e.operationNo&&e.operationNo.length?e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt"):this.showErrorMessage("operation"):this.showErrorMessage("order")},checkTimeValidity:function(e,t){var r=e[t].getTime(),i=Date.parse(this.model.get("date")),s=i+288e5;return r===s&&(r-=1),i>r||r>=s?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=r.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=r.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=r.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=r.format(e.finishedAt,"HH:mm:ss"),e},serializeForm:function(e){return e.master=this.serializeUserInfo("master"),e.leader=this.serializeUserInfo("leader"),e.operator=this.serializeUserInfo("operator"),e.operators=e.operator?[e.operator]:[],e.quantityDone=parseInt(e.quantityDone,10),e.workerCount=parseInt(e.workerCount,10),(isNaN(e.quantityDone)||e.quantityDone<0)&&(e.quantityDone=0),(isNaN(e.workerCount)||e.workerCount<1)&&(e.workerCount=1),e.operationNo=this.$id("operation").select2("val"),e.orderData=this.$id("order").select2("data"),e.orderData?e.orderData.sameOrder?(delete e.sameOrder,e.orderId=this.model.get("orderId")):(a.prepareOrderInfo(this.model,e.orderData),e.mechOrder=null===e.orderData.no,e.orderId=e.orderData[e.mechOrder?"nc12":"no"]):e.orderId=null,e.startedAt=new Date(e.startedAtDate+" "+e.startedAtTime),e.finishedAt=new Date(e.finishedAtDate+" "+e.finishedAtTime),delete e.startedAtDate,delete e.startedAtTime,delete e.finishedAtDate,delete e.finishedAtTime,e},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.name}},handleFailure:function(e){e.responseJSON&&e.responseJSON.error&&"INVALID_CHANGES"===e.responseJSON.error.message?this.$errorMessage=i.msg.show({type:"warning",time:5e3,text:t("prodShiftOrders","FORM:ERROR:INVALID_CHANGES")}):s.prototype.handleFailure.apply(this,arguments)}})});