// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/time","app/viewport","app/core/views/FormView","app/users/util/setUpUserSelect2","app/production/util/orderPickerHelpers","app/prodShiftOrders/templates/form"],function(e,t,r,s,i,o,a){"use strict";return s.extend({template:a,afterRender:function(){s.prototype.afterRender.call(this),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),o.setUpOrderSelect2(this.$id("order"),this.$id("operation"),this.model),o.setUpOperationSelect2(this.$id("operation"),[]),o.selectOrder(this.$id("order"),this.model),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=i(this.$id(e)),r=this.model.get(e);r&&r.id&&r.label&&t.select2("data",{id:r.id,text:r.label})},showErrorMessage:function(t){return this.$errorMessage=r.msg.show({type:"error",text:e("prodShiftOrders","FORM:ERROR:"+t)}),!1},checkValidity:function(e){return"string"==typeof e.orderId&&e.orderId.length?"string"==typeof e.operationNo&&e.operationNo.length?e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt"):this.showErrorMessage("operation"):this.showErrorMessage("order")},checkTimeValidity:function(e,t){var r=e[t].getTime(),s=Date.parse(this.model.get("date")),i=s+288e5;return r===i&&(r-=1),s>r||r>=i?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=t.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=t.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=t.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=t.format(e.finishedAt,"HH:mm:ss"),e},serializeForm:function(e){return e.master=this.serializeUserInfo("master"),e.leader=this.serializeUserInfo("leader"),e.operator=this.serializeUserInfo("operator"),e.operators=e.operator?[e.operator]:[],e.quantityDone=parseInt(e.quantityDone,10),e.workerCount=parseInt(e.workerCount,10),(isNaN(e.quantityDone)||e.quantityDone<0)&&(e.quantityDone=0),(isNaN(e.workerCount)||e.workerCount<1)&&(e.workerCount=1),e.operationNo=this.$id("operation").select2("val"),e.orderData=this.$id("order").select2("data"),e.orderData?e.orderData.sameOrder?(delete e.sameOrder,e.orderId=this.model.get("orderId")):(o.prepareOrderInfo(this.model,e.orderData),e.mechOrder=null===e.orderData.no,e.orderId=e.orderData[e.mechOrder?"nc12":"no"]):e.orderId=null,e.startedAt=t.getMoment(e.startedAtDate+" "+e.startedAtTime).toDate(),e.finishedAt=t.getMoment(e.finishedAtDate+" "+e.finishedAtTime).toDate(),delete e.startedAtDate,delete e.startedAtTime,delete e.finishedAtDate,delete e.finishedAtTime,e},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleFailure:function(t){t.responseJSON&&t.responseJSON.error&&e.has("prodShiftOrders","FORM:ERROR:"+t.responseJSON.error.message)?this.showErrorMessage(t.responseJSON.error.message):s.prototype.handleFailure.apply(this,arguments)}})});