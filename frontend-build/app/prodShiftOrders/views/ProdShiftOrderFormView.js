// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user","app/time","app/viewport","app/core/views/FormView","app/users/util/setUpUserSelect2","app/prodChangeRequests/util/isChangeRequest","app/production/util/orderPickerHelpers","app/prodShiftOrders/templates/form"],function(e,t,r,s,i,o,a,d,n,h){"use strict";return o.extend({template:h,serialize:function(){return e.extend(o.prototype.serialize.call(this),{isChangeRequest:d()})},afterRender:function(){o.prototype.afterRender.call(this),this.setUpUserSelect2("master"),this.setUpUserSelect2("leader"),this.setUpUserSelect2("operator"),n.setUpOrderSelect2(this.$id("order"),this.$id("operation"),this.model),n.setUpOperationSelect2(this.$id("operation"),[]),n.selectOrder(this.$id("order"),this.model),this.$id("master").select2("focus")},setUpUserSelect2:function(e){var t=a(this.$id(e)),r=this.model.get(e);r&&r.id&&r.label&&t.select2("data",{id:r.id,text:r.label})},showErrorMessage:function(e){return t.has("prodShiftOrders","FORM:ERROR:"+e)&&(e=t("prodShiftOrders","FORM:ERROR:"+e)),o.prototype.showErrorMessage.call(this,e)},checkValidity:function(e){return"string"==typeof e.orderId&&e.orderId.length?"string"==typeof e.operationNo&&e.operationNo.length?e.finishedAt<=e.startedAt?this.showErrorMessage("times"):this.checkTimeValidity(e,"startedAt")&&this.checkTimeValidity(e,"finishedAt"):this.showErrorMessage("operation"):this.showErrorMessage("order")},checkTimeValidity:function(e,t){var r=e[t].getTime(),s=Date.parse(this.model.get("date")),i=s+288e5;return r===i&&(r-=1),s>r||r>=i?this.showErrorMessage(t):!0},serializeToForm:function(){var e=this.model.toJSON();return e.startedAtDate=s.format(e.startedAt,"YYYY-MM-DD"),e.startedAtTime=s.format(e.startedAt,"HH:mm:ss"),e.finishedAtDate=s.format(e.finishedAt,"YYYY-MM-DD"),e.finishedAtTime=s.format(e.finishedAt,"HH:mm:ss"),e.requestComment="",e},serializeForm:function(e){return e.master=this.serializeUserInfo("master"),e.leader=this.serializeUserInfo("leader"),e.operator=this.serializeUserInfo("operator"),e.operators=e.operator?[e.operator]:[],e.quantityDone=parseInt(e.quantityDone,10),e.workerCount=parseInt(e.workerCount,10),(isNaN(e.quantityDone)||e.quantityDone<0)&&(e.quantityDone=0),(isNaN(e.workerCount)||e.workerCount<1)&&(e.workerCount=1),e.operationNo=this.$id("operation").select2("val"),e.orderData=this.$id("order").select2("data"),e.orderData?e.orderData.sameOrder?(delete e.sameOrder,e.orderId=this.model.get("orderId")):(n.prepareOrderInfo(this.model,e.orderData),e.mechOrder=null===e.orderData.no,e.orderId=e.orderData[e.mechOrder?"nc12":"no"]):e.orderId=null,e.startedAt=s.getMoment(e.startedAtDate+" "+e.startedAtTime).toDate(),e.finishedAt=s.getMoment(e.finishedAtDate+" "+e.finishedAtTime).toDate(),delete e.startedAtDate,delete e.startedAtTime,delete e.finishedAtDate,delete e.finishedAtTime,e},serializeUserInfo:function(e){var t=this.$id(e).select2("data");return null===t?null:{id:t.id,label:t.text}},handleSuccess:function(){if(d()){if(this.options.editMode)return this.handleEditSuccess();i.msg.show({type:"success",time:2500,text:t("prodShiftOrders","changeRequest:msg:success:add")})}o.prototype.handleSuccess.apply(this,arguments)},handleEditSuccess:function(){function e(){i.msg.show({type:"success",time:5e3,text:t("prodShiftOrders","changeRequest:msg:success:edit")})}return this.model.set(this.model.previousAttributes()),i.currentDialog===this?e():this.broker.subscribe("router.executing").setLimit(1).on("message",e),o.prototype.handleSuccess.apply(this,arguments)},handleFailure:function(e){var r=e.responseJSON;r&&r.error&&t.has("prodShiftOrders","FORM:ERROR:"+r.error.message)?this.showErrorMessage(r.error.message):d()?this.showErrorMessage(t("prodShiftOrders","changeRequest:msg:failure:"+(this.options.editMode?"edit":"add"))):o.prototype.handleFailure.apply(this,arguments)}})});