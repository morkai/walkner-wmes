define(["underscore","moment","js2form","reltime","app/i18n","app/user","app/data/prodLines","app/core/View","app/core/util/fixTimeRange","app/prodShiftOrders/templates/filter","select2"],function(e,i,t,r,a,n,o,s,l,d){return s.extend({template:d,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("prodShiftOrderFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();t(this.el.querySelector(".filter-form"),e),this.$id("prodLine").select2({width:"275px",allowClear:!n.getDivision(),data:this.getApplicableProdLines()})},getApplicableProdLines:function(){return o.getForCurrentUser().map(function(e){return{id:e.id,text:e.getLabel()}})},serializeRqlQuery:function(){var e=this.model.rqlQuery,i={createdAt:"",prodLine:null,type:null,shift:0,orderId:"",operationNo:"",limit:e.limit<5?5:e.limit>100?100:e.limit};return e.selector.args.forEach(function(e){var t=e.args[0];switch(t){case"date":l.toFormData(i,e,"date");break;case"prodLine":case"shift":case"orderId":case"operationNo":"eq"===e.name&&(i[t]=e.args[1])}}),i},changeFilter:function(){var e=this.model.rqlQuery,i=l.fromView(this,{defaultTime:"06:00"}),t=[],r=this.$id("prodLine").val(),a=parseInt(this.$("input[name=shift]:checked").val(),10),n=this.$id("orderId").val(),o=this.fixOperationNo();n&&n.length&&t.push({name:"eq",args:["orderId",n]}),r&&r.length&&t.push({name:"eq",args:["prodLine",r]}),a&&t.push({name:"eq",args:["shift",a]}),o&&o.length&&t.push({name:"eq",args:["operationNo",o]}),i.from&&t.push({name:"ge",args:["date",i.from]}),i.to&&t.push({name:"le",args:["date",i.to]}),e.selector={name:"and",args:t},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},fixOperationNo:function(){var e=this.$id("operationNo"),i=e.val().trim();if(i.length>0)for(;i.length<4;)i="0"+i;return e.val(i),i}})});