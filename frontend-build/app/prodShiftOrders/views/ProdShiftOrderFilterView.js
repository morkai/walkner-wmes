// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","select2","app/user","app/data/mrpControllers","app/data/prodLines","app/core/views/FilterView","app/core/util/fixTimeRange","app/prodShiftOrders/templates/filter"],function(e,t,r,a,i,n,o,s,l){"use strict";return o.extend({template:l,defaultFormData:{from:"",to:"",mrp:"",prodLine:null,type:null,shift:0,orderId:"",bom:""},termToForm:{startedAt:function(e,t,r){s.toFormData(r,t,"date")},"orderData.mrp":function(e,t,r){r[e]=t.args[1].join(",")},orderId:function(e,t,r){var a=t.args[1],i=r[e];i+="all"===t.name?" "+a.join("+"):"in"===t.name?" "+a.join(","):" "+a,r[e]=i.trim()},"orderData.bom.nc12":function(e,t,r){var a=t.args[1],i=r.bom;i+="all"===t.name?" "+a.join("+"):"in"===t.name?" "+a.join(","):" "+a,r.bom=i.trim()},"orderData.bom.item":"orderData.bom.nc12",prodLine:function(e,t,r){r[e]=t.args[1]},shift:"prodLine"},events:e.assign({"focus .prodShiftOrders-filter-orderId":function(e){var r=this.$(e.currentTarget),a=r.closest(".form-group"),i=t('<textarea class="form-control" rows="4"></textarea>').css({position:"absolute",marginTop:"-34px",width:"383px",zIndex:"2"}).val(r.val().split(" ").join("\n")).appendTo(a).focus();i.on("blur",function(){r.val(i.val().split("\n").join(" ")).prop("disabled",!1),i.remove()}),r[0].disabled=!0}},o.prototype.events),afterRender:function(){o.prototype.afterRender.apply(this,arguments),this.$id("mrp").select2({width:"325px",multiple:!0,allowClear:!0,data:this.getApplicableMrps(),matcher:function(e,r,a){return t().select2.defaults.matcher(e,a.id)||t().select2.defaults.matcher(e,r)},formatResult:function(e,t,a,i){if(!e.id)return i(e.text);var n=[];return r.util.markMatch(e.id,a.term,n,i),n.push(": "),r.util.markMatch(e.text,a.term,n,i),n.join("")},formatSelection:function(e){return e.id}}),this.$id("prodLine").select2({width:"175px",allowClear:!a.getDivision(),data:this.getApplicableProdLines(),formatResult:function(e,t,a,i){if(!e.id)return i(e.text);var n=[];return n.push('<span style="text-decoration: '+(e.deactivatedAt?"line-through":"initial")+'">'),r.util.markMatch(e.text,a.term,n,i),n.push("</span>"),n.join("")},formatSelection:function(e){return e.deactivatedAt?'<span style="text-decoration: line-through">'+e.id+"</span>":e.id}})},getApplicableMrps:function(){return i.getForCurrentUser().filter(function(e){return!e.get("deactivatedAt")}).map(function(e){return{id:e.id,text:e.get("description")}})},getApplicableProdLines:function(){return n.getForCurrentUser().map(function(e){return{id:e.id,text:e.getLabel(),deactivatedAt:e.get("deactivatedAt")}})},serializeOrderId:function(t){var r=this.$id("orderId").val().replace(/\s+/g," ").replace(/\s*,\s*/g,",").replace(/\s*\+\s*/g,"+").toUpperCase().split(" "),a={},i={};r.forEach(function(t){var r=i,n=",";e.includes(t,"+")&&(r=a,n="+"),t.split(n).forEach(function(e){e=e.replace(/[^0-9A-Z]+/g,""),e.length&&(r[e]=1)})}),a=e.keys(a),i=e.keys(i),a.length&&t.push({name:"all",args:["orderId",a]}),i.length&&t.push({name:"in",args:["orderId",i]})},serializeBom:function(t){var r=this.$id("bom").val().replace(/\s+/g," ").replace(/\s*,\s*/g,",").replace(/\s*\+\s*/g,"+").toUpperCase().split(" "),a={nc12:{},item:{}},i={nc12:{},item:{}};r.forEach(function(t){var r=i,n=",";e.includes(t,"+")&&(r=a,n="+");var o=t.split(n).map(function(e){return e.replace(/[^0-9A-Z]+/g,"")}).filter(function(e){return/^([0-9]{1,4}|[0-9A-Z]{6,12})$/.test(e)});o.length&&(r=o[0].length<=4?r.item:r.nc12,o.forEach(function(e){for(;e.length<4;)e="0"+e;r[e]=1}))}),["nc12","item"].forEach(function(r){a[r]=e.keys(a[r]),i[r]=e.keys(i[r]),a[r].length&&t.push({name:"all",args:["orderData.bom."+r,a[r]]}),i[r].length&&t.push({name:"in",args:["orderData.bom."+r,i[r]]})})},serializeFormToQuery:function(e){var t=s.fromView(this,{defaultTime:"06:00"}),r=this.$id("mrp").val(),a=this.$id("prodLine").val(),i=parseInt(this.$("input[name=shift]:checked").val(),10);this.serializeOrderId(e),this.serializeBom(e),r&&r.length&&e.push({name:"in",args:["orderData.mrp",r.split(",")]}),a&&a.length&&e.push({name:"eq",args:["prodLine",a]}),i&&e.push({name:"eq",args:["shift",i]}),t.from&&e.push({name:"ge",args:["startedAt",t.from]}),t.to&&e.push({name:"lt",args:["startedAt",t.to]})}})});