// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","select2","app/user","app/data/mrpControllers","app/core/views/FilterView","app/core/util/fixTimeRange","app/orgUnits/views/OrgUnitPickerView","app/mrpControllers/util/setUpMrpSelect2","app/prodShiftOrders/templates/filter"],function(e,r,t,a,i,n,o,s,l,p){"use strict";return n.extend({template:p,defaultFormData:{from:"",to:"",mrp:"",type:null,shift:0,orderId:"",bom:""},termToForm:{startedAt:function(e,r,t){o.toFormData(t,r,"date")},"orderData.mrp":function(e,r,t){t.mrp=Array.isArray(r.args[1])?r.args[1].join(","):""},orderId:function(e,r,t){var a=r.args[1],i=t[e];"all"===r.name?i+=" "+a.join("+"):"in"===r.name?i+=" "+a.join(","):i+=" "+a,t[e]=i.trim()},"orderData.bom.nc12":function(e,r,t){var a=r.args[1],i=t.bom;"all"===r.name?i+=" "+a.join("+"):"in"===r.name?i+=" "+a.join(","):i+=" "+a,t.bom=i.trim()},"orderData.bom.item":"orderData.bom.nc12",shift:function(e,r,t){t[e]=r.args[1]}},events:e.assign({"focus .prodShiftOrders-filter-orderId":function(e){var t=this.$(e.currentTarget),a=t.closest(".form-group"),i=r('<textarea class="form-control" rows="4"></textarea>').css({position:"absolute",marginTop:"-34px",width:"383px",zIndex:"2"}).val(t.val().split(" ").join("\n")).appendTo(a).focus();i.on("blur",function(){t.val(i.val().split("\n").join(" ")).prop("disabled",!1),i.remove()}),t[0].disabled=!0}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),this.setView("#-orgUnit",new s({filterView:this}))},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.toggleButtonGroup("shift"),l(this.$id("mrp"),{own:!0,view:this})},serializeOrderId:function(r){var t=this.$id("orderId").val().replace(/\s+/g," ").replace(/\s*,\s*/g,",").replace(/\s*\+\s*/g,"+").toUpperCase().split(" "),a={},i={};t.forEach(function(r){var t=i,n=",";e.includes(r,"+")&&(t=a,n="+"),r.split(n).forEach(function(e){e=e.replace(/[^0-9A-Z]+/g,""),e.length&&(t[e]=1)})}),a=e.keys(a),i=e.keys(i),a.length&&r.push({name:"all",args:["orderId",a]}),i.length&&r.push({name:"in",args:["orderId",i]})},serializeBom:function(r){var t=this.$id("bom").val().replace(/\s+/g," ").replace(/\s*,\s*/g,",").replace(/\s*\+\s*/g,"+").toUpperCase().split(" "),a={nc12:{},item:{}},i={nc12:{},item:{}};t.forEach(function(r){var t=i,n=",";e.includes(r,"+")&&(t=a,n="+");var o=r.split(n).map(function(e){return e.replace(/[^0-9A-Z]+/g,"")}).filter(function(e){return/^([0-9]{1,4}|[0-9A-Z]{6,12})$/.test(e)});o.length&&(t=o[0].length<=4?t.item:t.nc12,o.forEach(function(e){for(;e.length<4;)e="0"+e;t[e]=1}))}),["nc12","item"].forEach(function(t){a[t]=e.keys(a[t]),i[t]=e.keys(i[t]),a[t].length&&r.push({name:"all",args:["orderData.bom."+t,a[t]]}),i[t].length&&r.push({name:"in",args:["orderData.bom."+t,i[t]]})})},serializeFormToQuery:function(e){var r=o.fromView(this,{defaultTime:"06:00"}),t=this.$id("mrp").val(),a=parseInt(this.$("input[name=shift]:checked").val(),10);this.serializeOrderId(e),this.serializeBom(e),t&&t.length&&e.push({name:"in",args:["orderData.mrp",t.split(",")]}),a&&e.push({name:"eq",args:["shift",a]}),r.from&&e.push({name:"ge",args:["startedAt",r.from]}),r.to&&e.push({name:"lt",args:["startedAt",r.to]})}})});