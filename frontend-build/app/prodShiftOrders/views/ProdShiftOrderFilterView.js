define(["underscore","jquery","select2","app/user","app/data/mrpControllers","app/core/views/FilterView","app/core/util/forms/dateTimeRange","app/orgUnits/views/OrgUnitPickerView","app/mrpControllers/util/setUpMrpSelect2","app/prodShiftOrders/templates/filter"],function(e,r,t,i,a,o,n,s,p,l){"use strict";return o.extend({filterList:["shift","orderId","product","bom","mrp","orgUnit","mechOrder","limit"],filterMap:{mrpControllers:"mrp",prodFlow:"orgUnit",prodLine:"orgUnit",order:"orderId",prodShift:"shift"},template:l,events:e.assign({"click a[data-date-time-range]":n.handleRangeEvent,"focus .prodShiftOrders-filter-orderId":function(e){var t=this.$(e.currentTarget),i=t.closest(".form-group"),a=r('<textarea class="form-control" rows="4"></textarea>').css({position:"absolute",marginTop:"-34px",width:"383px",zIndex:"3"}).val(t.val().split(" ").join("\n")).appendTo(i).focus();a.on("blur",function(){t.val(a.val().split("\n").join(" ")).prop("disabled",!1),a.remove()}),t[0].disabled=!0}},o.prototype.events),defaultFormData:{mrp:"",type:null,shift:0,orderId:"",bom:"",mechOrder:!1},termToForm:{startedAt:n.rqlToForm,"orderData.mrp":function(e,r,t){t.mrp=Array.isArray(r.args[1])?r.args[1].join(","):""},orderId:function(e,r,t){var i=r.args[1],a=t[e];"all"===r.name?a+=" "+i.join("+"):"in"===r.name?a+=" "+i.join(","):a+=" "+i,t[e]=a.trim()},"orderData.bom.nc12":function(e,r,t){var i=r.args[1],a=t.bom;"all"===r.name?a+=" "+i.join("+"):"in"===r.name?a+=" "+i.join(","):a+=" "+i,t.bom=a.trim()},"orderData.bom.item":"orderData.bom.nc12","orderData.nc12":function(e,r,t){t.product=r.args[1]},"orderData.description":function(e,r,t){t.product=this.unescapeRegExp(r.args[1].substring(1))},shift:function(e,r,t){t[e]=r.args[1]},mechOrder:"shift"},initialize:function(){o.prototype.initialize.apply(this,arguments),this.setView("#-orgUnit",new s({filterView:this}))},afterRender:function(){o.prototype.afterRender.apply(this,arguments),this.toggleButtonGroup("shift"),this.toggleButtonGroup("mechOrder"),p(this.$id("mrp"),{own:!0,view:this})},serializeOrderId:function(r){var t={},i={};this.$id("orderId").val().replace(/\s+/g," ").replace(/\s*,\s*/g,",").replace(/\s*\+\s*/g,"+").toUpperCase().split(" ").forEach(function(r){var a=i,o=",";e.includes(r,"+")&&(a=t,o="+"),r.split(o).forEach(function(e){(e=e.replace(/[^0-9A-Z]+/g,"")).length&&(a[e]=1)})}),t=e.keys(t),i=e.keys(i),t.length&&r.push({name:"all",args:["orderId",t]}),i.length&&r.push({name:"in",args:["orderId",i]})},serializeBom:function(r){var t={nc12:{},item:{}},i={nc12:{},item:{}};this.$id("bom").val().replace(/\s+/g," ").replace(/\s*,\s*/g,",").replace(/\s*\+\s*/g,"+").toUpperCase().split(" ").forEach(function(r){var a=i,o=",";e.includes(r,"+")&&(a=t,o="+");var n=r.split(o).map(function(e){return e.replace(/[^0-9A-Z]+/g,"")}).filter(function(e){return/^([0-9]{1,4}|[0-9A-Z]{6,12})$/.test(e)});n.length&&(a=n[0].length<=4?a.item:a.nc12,n.forEach(function(e){for(;e.length<4;)e="0"+e;a[e]=1}))}),["nc12","item"].forEach(function(a){t[a]=e.keys(t[a]),i[a]=e.keys(i[a]),t[a].length&&r.push({name:"all",args:["orderData.bom."+a,t[a]]}),i[a].length&&r.push({name:"in",args:["orderData.bom."+a,i[a]]})})},serializeFormToQuery:function(e){this.serializeOrderId(e),this.serializeBom(e),n.formToRql(this,e);var r=this.$id("product").val();r&&(12===r.length?e.push({name:"eq",args:["orderData.nc12",r]}):e.push({name:"regex",args:["orderData.description","^"+this.escapeRegExp(r.toUpperCase())]}));var t=this.$id("mrp").val();t&&t.length&&e.push({name:"in",args:["orderData.mrp",t.split(",")]});var i=parseInt(this.$('input[name="shift"]:checked').val(),10);i&&e.push({name:"eq",args:["shift",i]}),e.push({name:"eq",args:["mechOrder","true"===this.$('input[name="mechOrder"]:checked').val()]})},showFilter:function(e){"startedAt"!==e?o.prototype.showFilter.apply(this,arguments):this.$id("from-date").focus()},filterHasValue:function(e){return"mechOrder"===e?"true"===this.getButtonGroupValue(e):o.prototype.filterHasValue.apply(this,arguments)}})});