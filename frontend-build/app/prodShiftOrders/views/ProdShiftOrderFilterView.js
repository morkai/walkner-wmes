// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","select2","app/user","app/data/mrpControllers","app/data/prodLines","app/core/views/FilterView","app/core/util/fixTimeRange","app/prodShiftOrders/templates/filter"],function(t,e,r,i,n,a,o,s){"use strict";return a.extend({template:s,defaultFormData:{from:"",to:"",mrp:"",prodLine:null,type:null,shift:0,orderId:"",bom:""},termToForm:{startedAt:function(t,e,r){o.toFormData(r,e,"date")},"orderData.mrp":function(t,e,r){r[t]=e.args[1].join(",")},orderId:function(t,e,r){r[t]="in"===e.name?e.args[1].join(", "):e.args[1]},"orderData.bom.nc12":function(t,e,r){r.bom="in"===e.name?e.args[1].join(", "):e.args[1]},prodLine:function(t,e,r){r[t]=e.args[1]},shift:"prodLine"},afterRender:function(){a.prototype.afterRender.call(this),this.$id("mrp").select2({width:"325px",multiple:!0,allowClear:!0,data:this.getApplicableMrps(),matcher:function(e,r,i){return t().select2.defaults.matcher(e,i.id)||t().select2.defaults.matcher(e,r)},formatResult:function(t,r,i,n){if(!t.id)return n(t.text);var a=[];return e.util.markMatch(t.id,i.term,a,n),a.push(": "),e.util.markMatch(t.text,i.term,a,n),a.join("")},formatSelection:function(t){return t.id}}),this.$id("prodLine").select2({width:"175px",allowClear:!r.getDivision(),data:this.getApplicableProdLines(),formatResult:function(t,r,i,n){if(!t.id)return n(t.text);var a=[];return a.push('<span style="text-decoration: '+(t.deactivatedAt?"line-through":"initial")+'">'),e.util.markMatch(t.text,i.term,a,n),a.push("</span>"),a.join("")},formatSelection:function(t){return t.deactivatedAt?'<span style="text-decoration: line-through">'+t.id+"</span>":t.id}})},getApplicableMrps:function(){return i.getForCurrentUser().filter(function(t){return!t.get("deactivatedAt")}).map(function(t){return{id:t.id,text:t.get("description")}})},getApplicableProdLines:function(){return n.getForCurrentUser().map(function(t){return{id:t.id,text:t.getLabel(),deactivatedAt:t.get("deactivatedAt")}})},serializeFormToQuery:function(t){var e=o.fromView(this,{defaultTime:"06:00"}),r=this.$id("mrp").val(),i=this.$id("prodLine").val(),n=parseInt(this.$("input[name=shift]:checked").val(),10),a=this.$id("orderId").val().toUpperCase().split(/[^0-9A-Z]+/).filter(function(t){return t.length}),s=this.$id("bom").val().toUpperCase().split(/[^0-9A-Z]+/).filter(function(t){return 7===t.length||12===t.length});1===a.length?t.push({name:"eq",args:["orderId",a[0]]}):a.length&&t.push({name:"in",args:["orderId",a]}),1===s.length?t.push({name:"eq",args:["orderData.bom.nc12",s[0]]}):s.length&&t.push({name:"in",args:["orderData.bom.nc12",s]}),r&&r.length&&t.push({name:"in",args:["orderData.mrp",r.split(",")]}),i&&i.length&&t.push({name:"eq",args:["prodLine",i]}),n&&t.push({name:"eq",args:["shift",n]}),e.from&&t.push({name:"ge",args:["startedAt",e.from]}),e.to&&t.push({name:"lt",args:["startedAt",e.to]})}})});