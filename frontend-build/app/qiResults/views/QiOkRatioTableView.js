define(["underscore","jquery","app/i18n","app/user","app/core/View","../dictionaries","app/qiResults/templates/okRatioTable","app/qiResults/templates/okRatioTotalsTable"],function(e,t,s,i,o,l,n,a){"use strict";return o.extend({template:n,events:{"mouseenter tr[data-key]":function(e){null===this.selectedKey&&this.renderTotals(this.model.get("groups")[e.currentTarget.dataset.i])},"mouseleave #-monthly":function(){null===this.selectedKey&&this.renderTotals(this.model.get("total"))},'click .is-clickable[data-property="month"]':function(e){var t=this.$(e.currentTarget),s=t.parent(),i=s[0].dataset.i,o=s[0].dataset.key;this.selectedKey===o?(this.selectedKey=null,t.removeClass("is-selected")):(this.selectedKey=o,this.$(".is-selected").removeClass("is-selected"),t.addClass("is-selected"),this.renderTotals(this.model.get("groups")[i]))},'click .is-clickable[data-property="ratio"]':function(s){var i=this,o=i.$(s.currentTarget),n=o.parent(),a=n[0].dataset.i,r=+n[0].dataset.key,d=l.settings.getWhQty(r),h=t("<form></form>").submit(function(){return p(),!1}),c=t('<input class="form-control input-lg no-controls" type="number" min="0">').val(d).on("keydown",function(t){27===t.which&&e.defer(u)}).css({position:"absolute",width:"110px"}).appendTo(h);function u(){h.remove()}function p(){var e=parseInt(c.val(),10);if(u(),!(isNaN(e)||e<0)){l.settings.setWhQty(r,e);var t=e-d,s=i.model.attributes;s.total.wh.all+=t,s.total.wh.ratio=100-s.total.wh.nok/s.total.wh.all||0,s.groups[a].wh.all=e,s.groups[a].wh.ratio=100-s.groups[a].wh.nok/s.groups[a].wh.all||0,i.model.trigger("change:groups")}}h.appendTo(o),e.defer(function(){c.select().on("blur",function(){e.defer(p)})})}},initialize:function(){this.isLoading=!1,this.selectedKey=null,this.lastColumns=[],this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups",this.render)},serialize:function(){var e=this.model,t=[];return e.get("divisions").forEach(function(e){"prod"===e.type&&t.push({_id:e._id,label:e._id})}),t.push({_id:"prod",label:s("qiResults","report:series:prod")},{_id:"wh",label:s("qiResults","report:series:wh")}),this.lastColumns=t,{idPrefix:this.idPrefix,renderOkRatioTotalsTable:a,columns:t,rows:e.get("groups"),okRatioRef:l.settings.getOkRatioRef(),canManage:i.isAllowedTo("QI:DICTIONARIES:MANAGE"),total:e.get("total")}},afterRender:function(){if(this.selectedKey){var e=this.$('tr[data-key="'+this.selectedKey+'"]');this.selectedKey=null,e.length&&e.find('.is-clickable[data-property="month"]').click()}},renderTotals:function(e){this.$id("totals").html(a({idPrefix:this.idPrefix,columns:this.lastColumns,total:e}))},onModelLoading:function(){this.isLoading=!0},onModelLoaded:function(){this.isLoading=!1},onModelError:function(){this.isLoading=!1}})});