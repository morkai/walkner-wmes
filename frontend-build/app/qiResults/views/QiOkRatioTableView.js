// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/core/View","../dictionaries","app/qiResults/templates/okRatioTable","app/qiResults/templates/okRatioTotalsTable"],function(e,t,s,i,o,l,n,a){"use strict";return o.extend({template:n,events:{"mouseenter tr[data-key]":function(e){null===this.selectedKey&&this.renderTotals(this.model.get("groups")[e.currentTarget.dataset.i])},"mouseleave #-monthly":function(){null===this.selectedKey&&this.renderTotals(this.model.get("total"))},'click .is-clickable[data-property="month"]':function(e){var t=this.$(e.currentTarget),s=t.parent(),i=s[0].dataset.i,o=s[0].dataset.key;this.selectedKey===o?(this.selectedKey=null,t.removeClass("is-selected")):(this.selectedKey=o,this.$(".is-selected").removeClass("is-selected"),t.addClass("is-selected"),this.renderTotals(this.model.get("groups")[i]))},'click .is-clickable[data-property="ratio"]':function(s){function i(){u.remove()}function o(){var e=parseInt(p.val(),10);if(i(),!(isNaN(e)||0>e)){l.settings.setWhQty(h,e);var t=e-c,s=n.model.attributes;s.total.wh.all+=t,s.total.wh.ratio=100-s.total.wh.nok/s.total.wh.all||0,s.groups[d].wh.all=e,s.groups[d].wh.ratio=100-s.groups[d].wh.nok/s.groups[d].wh.all||0,n.model.trigger("change:groups")}}var n=this,a=n.$(s.currentTarget),r=a.parent(),d=r[0].dataset.i,h=+r[0].dataset.key,c=l.settings.getWhQty(h),u=t("<form></form>").submit(function(){return o(),!1}),p=t('<input class="form-control input-lg no-controls" type="number" min="0">').val(c).on("keydown",function(t){27===t.which&&e.defer(i)}).css({position:"absolute",width:"110px"}).appendTo(u);u.appendTo(a),e.defer(function(){p.select().on("blur",function(){e.defer(o)})})}},initialize:function(){this.isLoading=!1,this.selectedKey=null,this.lastColumns=[],this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups",this.render)},serialize:function(){var e=this.model,t=e.get("divisions"),o=[];return t.forEach(function(e){"prod"===e.type&&o.push({_id:e._id,label:e._id})}),o.push({_id:"prod",label:s("qiResults","report:series:prod")},{_id:"wh",label:s("qiResults","report:series:wh")}),this.lastColumns=o,{idPrefix:this.idPrefix,renderOkRatioTotalsTable:a,columns:o,rows:e.get("groups"),okRatioRef:l.settings.getOkRatioRef(),canManage:i.isAllowedTo("QI:DICTIONARIES:MANAGE"),total:e.get("total")}},afterRender:function(){if(this.selectedKey){var e=this.$('tr[data-key="'+this.selectedKey+'"]');this.selectedKey=null,e.length&&e.find('.is-clickable[data-property="month"]').click()}},renderTotals:function(e){this.$id("totals").html(a({idPrefix:this.idPrefix,columns:this.lastColumns,total:e}))},onModelLoading:function(){this.isLoading=!0},onModelLoaded:function(){this.isLoading=!1},onModelError:function(){this.isLoading=!1}})});