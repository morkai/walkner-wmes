define(["underscore","jquery","app/i18n","app/user","app/core/View","../dictionaries","app/qiResults/templates/okRatioTable","app/qiResults/templates/okRatioTotalsTable"],function(t,e,s,i,o,l,n,a){"use strict";return o.extend({template:n,events:{"mouseenter tr[data-key]":function(t){null===this.selectedKey&&this.renderTotals(this.model.get("groups")[t.currentTarget.dataset.i])},"mouseleave #-monthly":function(){null===this.selectedKey&&this.renderTotals(this.model.get("total"))},'click .is-clickable[data-property="month"]':function(t){var e=this.$(t.currentTarget),s=e.parent(),i=s[0].dataset.i,o=s[0].dataset.key;this.selectedKey===o?(this.selectedKey=null,e.removeClass("is-selected")):(this.selectedKey=o,this.$(".is-selected").removeClass("is-selected"),e.addClass("is-selected"),this.renderTotals(this.model.get("groups")[i]))},'click .is-clickable[data-property="ratio"]':function(s){var i=this,o=i.$(s.currentTarget),n=o.parent(),a=n[0].dataset.i,r=+n[0].dataset.key,d=l.settings.getWhQty(r),h=e("<form></form>").submit(function(){return p(),!1}),c=e('<input class="form-control input-lg no-controls" type="number" min="0">').val(d).on("keydown",function(e){27===e.which&&t.defer(u)}).css({position:"absolute",width:"110px"}).appendTo(h);function u(){h.remove()}function p(){var t=parseInt(c.val(),10);if(u(),!(isNaN(t)||t<0)){l.settings.setWhQty(r,t);var e=t-d,s=i.model.attributes;s.total.wh.all+=e,s.total.wh.ratio=100-s.total.wh.nok/s.total.wh.all||0,s.groups[a].wh.all=t,s.groups[a].wh.ratio=100-s.groups[a].wh.nok/s.groups[a].wh.all||0,i.model.trigger("change:groups")}}h.appendTo(o),t.defer(function(){c.select().on("blur",function(){t.defer(p)})})}},initialize:function(){this.isLoading=!1,this.selectedKey=null,this.lastColumns=[],this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups",this.render)},getTemplateData:function(){var t=this.model,e=[];return t.get("divisions").forEach(function(t){"prod"===t.type&&e.push({_id:t._id,label:t._id})}),e.push({_id:"prod",label:s("qiResults","report:series:prod")},{_id:"wh",label:s("qiResults","report:series:wh")}),this.lastColumns=e,{renderOkRatioTotalsTable:a,columns:e,rows:t.get("groups"),okRatioRef:l.settings.getOkRatioRef(),canManage:i.isAllowedTo("QI:DICTIONARIES:MANAGE"),total:t.get("total")}},afterRender:function(){if(this.selectedKey){var t=this.$('tr[data-key="'+this.selectedKey+'"]');this.selectedKey=null,t.length&&t.find('.is-clickable[data-property="month"]').click()}},renderTotals:function(t){this.$id("totals").html(this.renderPartialHtml(a,{columns:this.lastColumns,total:t}))},onModelLoading:function(){this.isLoading=!0},onModelLoaded:function(){this.isLoading=!1},onModelError:function(){this.isLoading=!1}})});