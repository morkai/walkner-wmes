// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/core/views/FilterView","app/core/util/idAndLabel","app/data/orgUnits","app/users/util/setUpUserSelect2","app/qiResults/dictionaries","app/qiResults/templates/filter"],function(e,t,i,a,r,s,l,n){"use strict";var o=["order","productFamily","division","line","kind","errorCategory","faultCode","status","inspector","nokOwner","leader","limit"],d={orderNo:"order",nc12:"order",correctiveAction:"status"};return i.extend({template:n,events:e.extend({"mouseup #-result > .btn":function(e){var t=e.currentTarget,i=t.firstElementChild;i.checked&&setTimeout(function(){t.classList.remove("active"),i.checked=!1},1)},"click a[data-filter]":function(e){e.preventDefault(),this.showFilter(e.currentTarget.dataset.filter)}},i.prototype.events),defaultFormData:function(){return{from:"",to:"",result:"",order:"",productFamily:"",division:"",line:"",kind:"",errorCategory:"",faultCode:"",inspector:"",nokOwner:"",leader:"",status:""}},termToForm:{ok:function(e,t,i){i.result=t.args[1]?"ok":"nok"},inspectedAt:function(e,i,a){a["ge"===i.name?"from":"to"]=t.format(i.args[1],"YYYY-MM-DD")},nc12:function(e,t,i){i.order=t.args[1].replace(/[^A-Z0-9]+/g,"")},orderNo:"nc12",division:function(e,t,i){i[e]=t.args[1]},productFamily:function(e,t,i){i[e]="in"===t.name?t.args[1].join(","):t.args[1]},"inspector.id":function(e,t,i){i[e.split(".")[0]]="in"===t.name?t.args[1].join(","):t.args[1]},"nokOwner.id":"inspector.id","leader.id":"inspector.id",line:"inspector.id",kind:"division",errorCategory:"division",faultCode:"productFamily","correctiveActions.status":"division"},serializeFormToQuery:function(e){var i=this.getButtonGroupValue("result"),a=t.getMoment(this.$id("from").val(),"YYYY-MM-DD"),r=t.getMoment(this.$id("to").val(),"YYYY-MM-DD"),s=this.$id("order").val().replace(/[^0-9A-Za-z]+/g,"").toUpperCase(),l=this.$id("inspector").val(),n=this.$id("nokOwner").val(),o=this.$id("leader").val(),d=this.$id("productFamily").val(),p=this.$id("line").val(),u=this.$id("faultCode").val(),c=this.$id("status").val();"ok"===i?e.push({name:"eq",args:["ok",!0]}):"nok"===i&&e.push({name:"eq",args:["ok",!1]}),a.isValid()&&e.push({name:"ge",args:["inspectedAt",a.valueOf()]}),r.isValid()&&(r.valueOf()===a.valueOf()&&this.$id("to").val(r.add(1,"days").format("YYYY-MM-DD")),e.push({name:"lt",args:["inspectedAt",r.valueOf()]})),9===s.length?e.push({name:"eq",args:["orderNo",s]}):/^([0-9]{12}|[A-Z][A-Z0-9]{6})$/.test(s)?e.push({name:"eq",args:["nc12",s]}):s.length&&e.push({name:"regex",args:["nc12","^"+s]}),l.length&&(l.indexOf(",")===-1?e.push({name:"eq",args:["inspector.id",l]}):e.push({name:"in",args:["inspector.id",l.split(",")]})),n.length&&(n.indexOf(",")===-1?e.push({name:"eq",args:["nokOwner.id",n]}):e.push({name:"in",args:["nokOwner.id",n.split(",")]})),o.length&&(o.indexOf(",")===-1?e.push({name:"eq",args:["leader.id",o]}):e.push({name:"in",args:["leader.id",o.split(",")]})),p.length&&(p.indexOf(",")===-1?e.push({name:"eq",args:["line",p]}):e.push({name:"in",args:["line",p.split(",")]})),d.length&&(d.indexOf(",")===-1?e.push({name:"eq",args:["productFamily",d]}):e.push({name:"in",args:["productFamily",d.split(",")]})),u.length&&(u.indexOf(",")===-1?e.push({name:"eq",args:["faultCode",u]}):e.push({name:"in",args:["faultCode",u.split(",")]})),c.length&&e.push({name:"eq",args:["correctiveActions.status",c]}),["division","kind","errorCategory"].forEach(function(t){var i=this.$id(t).val();i&&e.push({name:"eq",args:[t,i]})},this)},changeFilter:function(){i.prototype.changeFilter.apply(this,arguments),this.toggleFilters()},serialize:function(){return e.assign(i.prototype.serialize.apply(this,arguments),{filters:o})},afterRender:function(){i.prototype.afterRender.call(this),this.$id("limit").parent().attr("data-filter","limit"),this.toggleButtonGroup("result"),this.$id("filters").select2({width:"175px"}),this.$id("productFamily").select2({width:"200px",allowClear:!0,multiple:!0,placeholder:" ",data:l.productFamilies.map(function(e){return{id:e,text:e}})}),this.$id("division").select2({width:"80px",allowClear:!0,placeholder:" ",data:r.getAllByType("division").filter(function(e){return"prod"===e.get("type")||"dist"===e.get("type")}).map(a)}),this.$id("line").select2({width:"175px",multiple:!0,allowClear:!0,placeholder:" ",data:r.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(a)}),this.$id("kind").select2({width:"200px",allowClear:!0,placeholder:" ",data:l.kinds.map(a)}),this.$id("errorCategory").select2({width:"140px",allowClear:!0,placeholder:" ",data:l.errorCategories.map(a)}),this.$id("faultCode").select2({width:"195px",allowClear:!0,multiple:!0,placeholder:" ",data:l.faults.map(a)}),this.$id("status").select2({width:"125px",allowClear:!0,placeholder:" ",data:l.actionStatuses.map(a)}),this.$id("inspector").select2({width:"230px",multiple:!0,allowClear:!0,placeholder:" ",data:l.inspectors.map(a)}),this.$id("nokOwner").select2({width:"230px",multiple:!0,allowClear:!0,placeholder:" ",data:l.masters.map(a)}),this.$id("leader").select2({width:"230px",multiple:!0,allowClear:!0,placeholder:" ",data:l.leaders.map(a)}),this.toggleFilters()},toggleFilters:function(){var e=this;o.forEach(function(t){e.$('.form-group[data-filter="'+t+'"]').toggleClass("hidden",!e.filterHasValue(t))})},filterHasValue:function(e){var t=this.$id(e).val();return"limit"===e?20!==+t:t.length>0},showFilter:function(e){return"inspectedAt"===e?void this.$id("from").focus():void this.$('.form-group[data-filter="'+(d[e]||e)+'"]').removeClass("hidden").find("input, select").first().focus()}})});