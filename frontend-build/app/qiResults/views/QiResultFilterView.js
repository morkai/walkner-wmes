// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/core/views/FilterView","app/core/util/idAndLabel","app/data/orgUnits","app/users/util/setUpUserSelect2","app/qiResults/dictionaries","app/qiResults/templates/filter"],function(e,t,r,i,a,o,s,l){"use strict";return r.extend({template:l,events:e.extend({"mouseup #-result > .btn":function(e){var t=e.currentTarget,r=t.firstElementChild;r.checked&&setTimeout(function(){t.classList.remove("active"),r.checked=!1},1)}},r.prototype.events),defaultFormData:function(){return{from:"",to:"",result:"",order:"",productFamily:"",division:"",kind:"",errorCategory:"",faultCode:"",inspector:""}},termToForm:{ok:function(e,t,r){r.result=t.args[1]?"ok":"nok"},inspectedAt:function(e,r,i){i["ge"===r.name?"from":"to"]=t.format(r.args[1],"YYYY-MM-DD")},nc12:function(e,t,r){r[e]=t.args[1].replace(/[^A-Z0-9]+/g,"")},orderNo:"nc12",division:function(e,t,r){r[e]=t.args[1]},productFamily:"division",kind:"division",errorCategory:"division",faultCode:"division","inspector.id":function(e,t,r){r.inspector=t.args[1]}},serialize:function(){return e.extend(r.prototype.serialize.call(this),{errorCategories:s.errorCategories.toJSON(),faults:s.faults.toJSON()})},serializeFormToQuery:function(e){var r=this.getButtonGroupValue("result"),i=t.getMoment(this.$id("from").val(),"YYYY-MM-DD"),a=t.getMoment(this.$id("to").val(),"YYYY-MM-DD"),o=this.$id("order").val().replace(/[^0-9A-Za-z]+/g,"").toUpperCase(),s=this.$id("inspector").val();"ok"===r?e.push({name:"eq",args:["ok",!0]}):"nok"===r&&e.push({name:"eq",args:["ok",!1]}),i.isValid()&&e.push({name:"ge",args:["inspectedAt",i.valueOf()]}),a.isValid()&&(a.valueOf()===i.valueOf()&&this.$id("to").val(a.add(1,"days").format("YYYY-MM-DD")),e.push({name:"lt",args:["inspectedAt",a.valueOf()]})),9===o.length?e.push({name:"eq",args:["orderNo",o]}):/^([0-9]{12}|[A-Z][A-Z0-9]{6})$/.test(o)?e.push({name:"eq",args:["nc12",o]}):o.length&&e.push({name:"regex",args:["nc12","^"+o]}),s.length&&e.push({name:"eq",args:["inspector.id",s]}),["productFamily","division","kind","errorCategory","faultCode"].forEach(function(t){var r=this.$id(t).val();r&&e.push({name:"eq",args:[t,r]})},this)},afterRender:function(){r.prototype.afterRender.call(this),this.toggleButtonGroup("result"),this.$id("productFamily").select2({width:"130px",allowClear:!0,placeholder:" ",data:s.productFamilies.map(function(e){return{id:e,text:e}})}),this.$id("division").select2({width:"90px",allowClear:!0,placeholder:" ",data:a.getAllByType("division").filter(function(e){return"prod"===e.get("type")}).map(i)}),this.$id("kind").select2({width:"200px",allowClear:!0,placeholder:" ",data:s.kinds.map(i)}),this.$id("errorCategory").select2({width:"150px",allowClear:!0,placeholder:" ",data:s.errorCategories.map(i)}),this.$id("faultCode").select2({width:"90px",allowClear:!0,placeholder:" ",data:s.faults.map(i)}),this.$id("inspector").select2({width:"200px",allowClear:!0,placeholder:" ",data:s.inspectors.map(i)})}})});