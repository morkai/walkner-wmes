define(["underscore","app/i18n","app/highcharts","app/core/View","app/reports/util/formatTooltipHeader","app/reports/util/formatXAxis","../dictionaries"],function(t,i,e,o,r,s,a){"use strict";return o.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:division",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this.serializeChartSeries();this.chart=new e.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:350},exporting:{filename:i("qiResults","report:filenames:nokRatio:division"),chartOptions:{legend:{enabled:!1}}},title:{text:i("qiResults","report:title:nokRatio:division")},noData:{},xAxis:{type:"datetime",labels:s.labels(this)},yAxis:{title:!1,allowDecimals:!0,min:t.min<10?0:t.min-1,max:100},tooltip:{shared:!0,valueDecimals:2,valueSuffix:"%",headerFormatter:r.bind(this)},legend:{enabled:!0},plotOptions:{column:{dataLabels:{enabled:!1,style:{color:"#000",fontSize:"12px",fontWeight:"bold",textShadow:"0 0 6px #fff, 0 0 3px #fff"},formatter:function(){return this.y||""}}}},series:t})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeChartSeries:function(){var e=this.model.get("divisions").filter(function(t){return"prod"===t.type}).sort(function(t,i){return t._id.localeCompare(i._id)}),o=this.factoryLayoutSettings,r=a.settings.getNokRatioRef(),s=[],n=t.map(e,function(t){return{id:t._id,type:"column",name:t._id,data:[],color:o.getColor(t._id)}}),h=r>0?r:100;return t.forEach(this.model.get("division"),function(i){t.forEach(e,function(t,e){var o=(i[t._id]||{qtyNok:0,qtyNokInspected:0,qtyInspected:0,ratio:0,ratioInspected:0}).ratioInspected;n[e].data.push({x:i.key,y:o}),o<h&&(h=o)}),s.push({x:i.key,y:r})}),r>0&&n.push({id:"ref",type:"line",name:i.bound("qiResults","report:series:okRatioRef"),data:s,color:"#5cb85c"}),n.min=h,n},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});