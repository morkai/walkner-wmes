// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/highcharts","app/core/View","app/data/colorFactory","../dictionaries","app/reports/util/formatTooltipHeader"],function(t,e,i,o,r,n,s){"use strict";return o.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this,o=t.serializeChartSeries(),r=t.model;t.chart=new i.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:370,events:{click:function(e){r.selectNearestGroup(t.mouseOverX||e.xAxis[0].value)}}},exporting:{filename:e.bound("qiResults","report:filenames:nokCountPerDivision"),chartOptions:{title:{text:e.bound("qiResults","report:title:nokCountPerDivision")},legend:{enabled:!0}}},title:!1,noData:{},xAxis:{type:"datetime"},yAxis:{title:!1,min:0,allowDecimals:!1},tooltip:{shared:!0,valueDecimals:0,headerFormatter:function(e){return t.mouseOverX=e.x,s.apply(t,arguments)}},legend:{enabled:!0},plotOptions:{series:{cursor:"pointer",events:{click:function(t){r.set("selectedGroupKey",t.point.x)},legendItemClick:function(){this.options.isDivision&&r.toggleDivision(this.options.id,!this.visible)}}},column:{borderWidth:0,stacking:"normal",dataLabels:{enabled:!0,style:{color:"#fff",fontSize:"12px",fontWeight:"bold",textShadow:"0 0 6px #000, 0 0 3px #000"},formatter:function(){return this.y||""}}},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:t.getMarkerStyles(o.length?o[0].data.length:0)}},series:o})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeChartSeries:function(){var i=Object.keys(this.model.get("divisions")).sort(function(t,e){return t.localeCompare(e)}),o=this.factoryLayoutSettings,r=t.map(i,function(t){return{id:t,type:"column",name:t,data:[],color:o.getColor(t),isDivision:!0}}),s=n.settings.getMaxNokPerDay(),a=[];return t.forEach(this.model.get("groups"),function(e){"number"==typeof e&&(e={key:e,workingDayCount:0,nokCountPerDivision:{}}),t.forEach(i,function(t,i){r[i].data.push({x:e.key,y:e.nokCountPerDivision[t]||0})}),a.push({x:e.key,y:e.workingDayCount*s})}),r.push({type:"line",name:e.bound("qiResults","report:series:maxNokCount"),data:a,color:"#5cb85c",isDivision:!1}),r},getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});