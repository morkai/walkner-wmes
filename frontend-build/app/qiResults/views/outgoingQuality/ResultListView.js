define(["underscore","jquery","app/time","app/viewport","app/core/views/ListView","app/data/orgUnits","app/data/prodFunctions","app/qiResults/dictionaries","app/core/templates/userInfo"],function(t,e,i,n,r,a,s,o,c){"use strict";return r.extend({className:"is-clickable",remoteTopics:{},events:t.assign(r.prototype.events,{'click td[data-id="rid"]':function(t){if(this.collection.report.canManage())return this.showResultsEditor(t.currentTarget),!1},'click td[data-id="standard"]':function(t){if(this.collection.report.canManage())return this.showStandardEditor(t.currentTarget),!1}}),initialize:function(){this.listenTo(this.collection.report,"change:oqlWeek",this.onOqlWeekChanged),e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){e(window).off("."+this.idPrefix)},onKeyDown:function(t){"Escape"===t.key&&(this.hideEditors(),this.hideEditors())},onOqlWeekChanged:function(t,e){e===t.getCurrentWeek()&&this.render()},showResultsEditor:function(i){var r=this,a=r.$(i);if(a.find("form").length)return!1;r.hideEditors();var s=r.collection.report.getCurrentWeek();if(!s)return!1;var o=a.html(),c=e('<form class="qi-oqlReport-results-editor"></form>').css({position:"absolute",marginTop:"-17px"}),d=e("<input>").val(s.results.join(",")),l=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');c.append(d).append(l),l.on("click",function(){var e=d.val().split(",").filter(function(t){return t.length>0}).map(function(t){return+t});if(t.isEqual(e,s.results))return r.hideEditors(),!1;n.msg.saving(),a.css({textAlign:"center"}).html('<i class="fa fa-spinner fa-spin"></i>');var i=r.ajax({method:"POST",url:"/qi/reports/outgoingQuality/weeks/"+s._id,data:JSON.stringify({results:e})});return i.fail(function(){n.msg.savingFailed()}),i.done(function(){n.msg.saved()}),i.always(function(){a.css({textAlign:""}).html(o)}),!1}),a.html("").append(c),d.select2({width:"300px",allowClear:!0,multiple:!0,placeholder:" ",maximumSelectionSize:3,data:r.collection.map(function(t){var e=t.get("rid").toString();return{id:e,text:e,result:t}}),formatSelection:function(t){return t.id},formatResult:function(t){return'<span class="text-mono">'+t.id+"; "+t.result.get("pareto")+"; "+t.result.get("concern")+"</span>"}}),setTimeout(function(){d.focus()},1)},showStandardEditor:function(t){var i=this,r=i.$(t);if(r.find("form").length)return r.find("select").focus(),!1;i.hideEditors();var a=i.collection.get(r.closest("tr").attr("data-id")),s=r.text(),c=e('<form class="qi-oqlReport-results-editor"></form>'),d=e('<select class="form-control"><option></option></select>'),l=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');o.standards.forEach(function(t){e("<option></option>").attr("value",t.id).prop("selected",t.id===a.get("standard")).text(t.get("name")).appendTo(d)}),c.append(d).append(l),l.on("click",function(){var t=d.val(),e=o.standards.get(t);if(e||(t=null),t===a.get("standard"))return i.hideEditors(),!1;n.msg.saving(),r.css({textAlign:"center"}).html('<i class="fa fa-spinner fa-spin"></i>');var c=i.ajax({method:"PUT",url:"/qi/results/"+a.id,data:JSON.stringify({standard:t})});return c.fail(function(){n.msg.savingFailed(),r.text(s)}),c.done(function(){n.msg.saved(),a.set("standard",t),r.text(e?e.get("name"):"")}),c.always(function(){r.css({textAlign:""})}),!1}),r.html("").append(c),setTimeout(function(){d.focus()},1)},hideEditors:function(){var e=this.$("form").parent(),i=this.collection.get(e.closest("tr").attr("data-id")),n="";if(i)if("rid"===e[0].dataset.id){var r=i.get("rid"),a=this.collection.report.getSpecifiedResults();n=r.toString(),t.includes(a,r)&&(n="<strong>"+r+"</strong>")}else{var s=o.standards.get(i.get("standard"));s&&(n=t.escape(s.get("name")))}e.html(n)},serializeColumns:function(){return[{id:"rid",tdClassName:"is-min is-number"},{id:"kpi",className:"is-min"},{id:"site",className:"is-min"},{id:"date",className:"is-min"},{id:"pareto"},{id:"concern"},{id:"cause"},{id:"countermeasure"},{id:"check",className:"is-min"},{id:"standard",className:"is-min"},{id:"who",className:"is-min"},{id:"when",className:"is-min"}]},serializeActions:function(){return null},serializeRows:function(e){var n=this.collection;if(!n.length)return[];var r=n.report,d=r.getTopCount(),l={};t.forEach((r.get("top")||{}).what,function(t,e){e<d&&(l[t[0]]=t[1])});var u={},f=n.map(function(t){var e=t.toJSON();e.kpi="OQ",e.site="KÄ™trzyn",e.date=i.format(e.date,"L"),e.check=e.check.map(function(t){return s.get(t)?s.get(t).getLabel():t}).join("; "),e.who=e.who.map(function(t){return c({userInfo:t})}).join("<br>"),e.when=i.format(e.when,"L");var n=a.getByTypeAndId("mrpController",e.pareto);n&&(e.pareto+=": "+n.get("description")),e.fault=e.concern,e.weight=0;var r=o.faults.get(e.concern);r&&(e.weight=r.get("weight"),e.concern+=": "+r.get("name"));var d=o.standards.get(e.standard);return d&&(e.standard=d.get("name")),u[e.rid]=e,e});!1!==e&&(f=f.filter(function(t){return!!l[t.fault]})).sort(function(t,e){var i=l[e.fault]-l[t.fault];return 0===i&&(i=e.weight-t.weight),i});var p=[];r.getSpecifiedResults().forEach(function(t){var e=u[t];e&&(e.rid="<strong>"+e.rid+"</strong>",p.push(e),delete u[t])});for(var g=0;g<d&&p.length!==d;++g){var h=f.shift();h&&u[h.rid]&&p.push(h)}return p}})});