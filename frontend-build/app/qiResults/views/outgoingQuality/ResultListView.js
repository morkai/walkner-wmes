define(["underscore","jquery","app/time","app/viewport","app/core/views/ListView","app/data/orgUnits","app/data/prodFunctions","app/qiResults/dictionaries","app/core/templates/userInfo"],function(t,e,n,i,r,a,s,o,c){"use strict";return r.extend({className:function(){return this.collection.report.get("printable")?"":"is-clickable"},remoteTopics:{},events:t.assign(r.prototype.events,{'click td[data-id="rid"]':function(t){if(this.canManage())return this.showResultsEditor(t.currentTarget),!1},'click td[data-id="standard"]':function(t){if(this.canManage())return this.showStandardEditor(t.currentTarget),!1}}),initialize:function(){this.listenTo(this.collection.report,"change:oqlWeek",this.onOqlWeekChanged),e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){e(window).off("."+this.idPrefix)},onKeyDown:function(t){"Escape"===t.key&&(this.hideEditors(),this.hideEditors())},onOqlWeekChanged:function(t,e){e===t.getCurrentWeek()&&this.render()},canManage:function(){var t=this.collection.report;return!t.get("printable")&&t.canManage()},showResultsEditor:function(n){var r=this,a=r.$(n);if(a.find("form").length)return!1;r.hideEditors();var s=r.collection.report.getCurrentWeek();if(!s)return!1;var o=a.html(),c=e('<form class="qi-oqlReport-results-editor"></form>').css({position:"absolute",marginTop:"-17px"}),l=e("<input>").val(s.results.join(",")),d=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');c.append(l).append(d),d.on("click",function(){var e=l.val().split(",").filter(function(t){return t.length>0}).map(function(t){return+t});if(t.isEqual(e,s.results))return r.hideEditors(),!1;i.msg.saving(),a.css({textAlign:"center"}).html('<i class="fa fa-spinner fa-spin"></i>');var n=r.ajax({method:"POST",url:"/qi/reports/outgoingQuality/weeks/"+s._id,data:JSON.stringify({results:e})});return n.fail(function(){i.msg.savingFailed()}),n.done(function(){i.msg.saved()}),n.always(function(){a.css({textAlign:""}).html(o)}),!1}),a.html("").append(c),l.select2({width:"300px",allowClear:!0,multiple:!0,placeholder:" ",maximumSelectionSize:3,data:r.collection.map(function(t){var e=t.get("rid").toString();return{id:e,text:e,result:t}}),formatSelection:function(t){return t.id},formatResult:function(t){return'<span class="text-mono">'+t.id+"; "+t.result.get("pareto")+"; "+t.result.get("concern")+"</span>"}}),setTimeout(function(){l.focus()},1)},showStandardEditor:function(t){var n=this,r=n.$(t);if(r.find("form").length)return r.find("select").focus(),!1;n.hideEditors();var a=n.collection.get(r.closest("tr").attr("data-id")),s=r.text(),c=e('<form class="qi-oqlReport-results-editor"></form>'),l=e('<select class="form-control"><option></option></select>'),d=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');o.standards.forEach(function(t){e("<option></option>").attr("value",t.id).prop("selected",t.id===a.get("standard")).text(t.get("name")).appendTo(l)}),c.append(l).append(d),d.on("click",function(){var t=l.val(),e=o.standards.get(t);if(e||(t=null),t===a.get("standard"))return n.hideEditors(),!1;i.msg.saving(),r.css({textAlign:"center"}).html('<i class="fa fa-spinner fa-spin"></i>');var c=n.ajax({method:"PUT",url:"/qi/results/"+a.id,data:JSON.stringify({standard:t})});return c.fail(function(){i.msg.savingFailed(),r.text(s)}),c.done(function(){i.msg.saved(),a.set("standard",t),r.text(e?e.get("name"):"")}),c.always(function(){r.css({textAlign:""})}),!1}),r.html("").append(c),setTimeout(function(){l.focus()},1)},hideEditors:function(){var e=this.$("form").parent(),n=this.collection.get(e.closest("tr").attr("data-id")),i="";if(n)if("rid"===e[0].dataset.id){var r=n.get("rid"),a=this.collection.report.getSpecifiedResults();i=r.toString(),t.includes(a,r)&&(i="<strong>"+r+"</strong>")}else{var s=o.standards.get(n.get("standard"));s&&(i=t.escape(s.get("name")))}e.html(i)},serializeColumns:function(){var t=[{id:"kpi",className:"is-min"},{id:"site",className:"is-min"},{id:"date",className:"is-min"},{id:"pareto"},{id:"concern"},{id:"cause"},{id:"countermeasure"},{id:"check",className:"is-min"},{id:"standard",className:"is-min"},{id:"who",className:"is-min"},{id:"when",className:"is-min"}];return this.collection.report.get("printable")||t.unshift({id:"rid",tdClassName:"is-min is-number"}),t},serializeActions:function(){return null},serializeRows:function(e){var i=this.collection;if(!i.length)return[];var r=i.report,l=r.getTopCount(),d={};t.forEach((r.get("top")||{}).what,function(t,e){e<l&&(d[t[0]]=t[1])});var u=r.get("printable"),f={},p=i.map(function(t){var e=t.toJSON();u&&(e.check=e.check.slice(0,1),e.who=e.who.slice(0,1),e.cause.length>105&&(e.cause=e.cause.substring(0,100)+"..."),e.countermeasure.length>105&&(e.countermeasure=e.countermeasure.substring(0,100)+"...")),e.kpi="OQ",e.site="KÄ™trzyn",e.date=n.format(e.date,"L"),e.check=e.check.map(function(t){return s.get(t)?s.get(t).getLabel():t}).join("; "),e.who=e.who.map(function(t){return c({userInfo:t})}).join("<br>"),e.when=n.format(e.when,"L");var i=a.getByTypeAndId("mrpController",e.pareto);!u&&i&&(e.pareto+=": "+i.get("description")),e.fault=e.concern,e.weight=0;var r=o.faults.get(e.concern);r&&(e.weight=r.get("weight"),u||(e.concern+=": "+r.get("name")));var l=o.standards.get(e.standard);return l&&(e.standard=l.get("name")),f[e.rid]=e,e});!1!==e&&(p=p.filter(function(t){return!!d[t.fault]})).sort(function(t,e){var n=d[e.fault]-d[t.fault];return 0===n&&(n=e.weight-t.weight),n});var g=[];r.getSpecifiedResults().forEach(function(t){var e=f[t];e&&(e.rid="<strong>"+e.rid+"</strong>",g.push(e),delete f[t])});for(var h=0;h<l&&g.length!==l;++h){var m=p.shift();m&&f[m.rid]&&g.push(m)}return g}})});