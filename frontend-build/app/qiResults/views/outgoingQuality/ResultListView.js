define(["underscore","jquery","app/time","app/viewport","app/core/View","app/core/templates/userInfo","app/data/orgUnits","app/data/prodFunctions","app/qiResults/dictionaries","app/qiResults/templates/outgoingQuality/results"],function(t,e,i,n,r,a,o,s,l,d){"use strict";function u(t){return(t||"").replace(/\n+/g,"\n").trim()}return r.extend({template:d,events:{'click a[data-action="editResults"]':function(t){return this.showResultsEditor(t.currentTarget),!1},'click a[data-action="editStandard"]':function(t){return this.showStandardEditor(t.currentTarget),!1}},initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection.report,"change:oqlWeek",this.onOqlWeekChanged),e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){e(window).off("."+this.idPrefix)},getTemplateData:function(){return{canManage:this.canManage(),results:this.serializeResults()}},onKeyDown:function(t){"Escape"===t.key&&this.hideEditors()},onOqlWeekChanged:function(t,e){e===t.getCurrentWeek()&&this.render()},canManage:function(){return this.collection.report.canManage()},showResultsEditor:function(i){var r=this,a=r.$(i).closest(".qi-oql-prop");if(!a.find("form").length){r.hideEditors();var o=r.collection.report.getCurrentWeek();if(o){var s=a.html(),l=e('<form class="qi-oql-results-editor"></form>'),d=e("<input>").val(o.results.join(",")),u=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');l.append(d).append(u),u.on("click",function(){var e=d.val().split(",").filter(function(t){return t.length>0}).map(function(t){return+t});if(t.isEqual(e,o.results))return r.hideEditors(),!1;n.msg.saving(),a.find(".qi-oql-prop-value").html('<i class="fa fa-spinner fa-spin"></i>');var i=r.ajax({method:"POST",url:"/qi/reports/outgoingQuality/weeks/"+o._id,data:JSON.stringify({results:e})});return i.fail(function(){n.msg.savingFailed(),a.html(s)}),i.done(function(){n.msg.saved(),r.hideEditors()}),!1}),a.append(l),d.select2({width:"300px",allowClear:!0,multiple:!0,placeholder:" ",maximumSelectionSize:3,data:r.collection.map(function(t){var e=t.get("rid").toString();return{id:e,text:e,result:t}}),formatSelection:function(t){return t.id},formatResult:function(t){return'<span class="text-mono">'+t.id+" | "+t.result.get("mrp")+" | "+t.result.get("faultCode")+"</span>"}}),setTimeout(function(){d.focus()},1)}}},showStandardEditor:function(t){var i=this,r=i.$(t).closest(".qi-oql-prop");if(!r.find("form").length){i.hideEditors();var a=i.collection.get(r.closest(".qi-oql-result").attr("data-id")),o=r.find(".qi-oql-prop-value").text(),s=e('<form class="qi-oql-results-editor"></form>'),d=e('<select class="form-control"><option></option></select>'),u=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');l.standards.forEach(function(t){e("<option></option>").attr("value",t.id).prop("selected",t.id===a.get("standard")).text(t.get("name")).appendTo(d)}),s.append(d).append(u),u.on("click",function(){var t=d.val();if(l.standards.get(t)||(t=null),t===a.get("standard"))return i.hideEditors(),!1;n.msg.saving(),r.find(".qi-oql-prop-value").html('<i class="fa fa-spinner fa-spin"></i>');var e=i.ajax({method:"PUT",url:"/qi/results/"+a.id,data:JSON.stringify({standard:t})});return e.fail(function(){n.msg.savingFailed(),r.find(".qi-oql-prop-value").text(o)}),e.done(function(){n.msg.saved(),a.set("standard",t),i.hideEditors()}),!1}),r.append(s),setTimeout(function(){d.focus()},1)}},hideEditors:function(){var e=this.$("form");if(e.length){var i=e.closest(".qi-oql-prop");e.remove();var n=this.collection.get(i.closest(".qi-oql-result").attr("data-id"));if(n){var r=i.attr("data-id"),a="-";if("rid"===r){var o=n.get("rid"),s=this.collection.report.getSpecifiedResults();a=o.toString(),t.includes(s,o)&&(a="<strong>"+o+"</strong>")}else if("standard"===r){var d=l.standards.get(n.get("standard"));d&&(a=t.escape(d.get("name")))}i.find(".qi-oql-prop-value").html(a)}}},serializeResults:function(){var e=this,i=e.collection;if(!i.length)return[];var n=i.report,r=n.getTopCount(),a={};t.forEach((n.get("top")||{}).what,function(t,e){e<r&&(a[t[0]]=t[1])});var o={},s=i.map(function(t){return o[t.get("rid")]=e.serializeResult(t)}).filter(function(t){return!!a[t.faultCode]}).sort(function(t,e){var i=a[e.faultCode]-a[t.faultCode];return 0===i&&(i=e.weight-t.weight),i}),l=[];n.getSpecifiedResults().forEach(function(t){var e=o[t];e&&(e.rid="<strong>"+e.rid+"</strong>",l.push(e),delete o[t])});for(var d=0;d<r&&l.length!==r;++d){var u=s.shift();u&&o[u.rid]&&l.push(u)}return l},serializeResult:function(t){var e=t.toJSON();e.kpi="OQ",e.site="KÄ™trzyn",e.date=i.format(e.inspectedAt,"L"),e.problem=u(e.problem),e.family=e.mrp;var n=o.getByTypeAndId("mrpController",e.mrp);n&&(e.family+=": "+n.get("description")),e.weight=0,e.concern=e.faultCode;var r=l.faults.get(e.faultCode);r&&(e.weight=r.get("weight"),e.concern+=": "+r.get("name"));var d=l.standards.get(e.standard);return d&&(e.standard=d.get("name")),e.rootCause.forEach(function(t){t.forEach(function(e,i){t[i]=u(e)})}),e.correctiveActions=e.correctiveActions.map(function(t){return{when:i.format(t.when,"L"),who:t.who.map(function(t){var e=a({userInfo:t}),i=s.get(t.prodFunction);return i&&(e+=" ("+i.getLabel()+")"),e}),what:u(t.what)}}),e}})});