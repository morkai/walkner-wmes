define(["underscore","jquery","app/time","app/viewport","app/core/views/ListView","app/data/orgUnits","app/data/prodFunctions","app/qiResults/dictionaries","app/core/templates/userInfo","app/qiResults/templates/outgoingQuality/resultListPrint"],function(t,e,i,n,r,s,a,o,l,c){"use strict";return r.extend({className:function(){return this.isPrintable()?"":"is-clickable"},template:function(t){return(this.isPrintable()?c:r.prototype.template)(t)},remoteTopics:{},events:t.assign(r.prototype.events,{'click td[data-id="rid"]':function(t){if(this.canManage())return this.showResultsEditor(t.currentTarget),!1},'click td[data-id="standard"]':function(t){if(this.canManage())return this.showStandardEditor(t.currentTarget),!1}}),initialize:function(){this.listenTo(this.collection.report,"change:oqlWeek",this.onOqlWeekChanged),e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){e(window).off("."+this.idPrefix)},onKeyDown:function(t){"Escape"===t.key&&(this.hideEditors(),this.hideEditors())},onOqlWeekChanged:function(t,e){e===t.getCurrentWeek()&&this.render()},canManage:function(){var t=this.collection.report;return!t.get("printable")&&t.canManage()},showResultsEditor:function(i){var r=this,s=r.$(i);if(s.find("form").length)return!1;r.hideEditors();var a=r.collection.report.getCurrentWeek();if(!a)return!1;var o=s.html(),l=e('<form class="qi-oqlReport-results-editor"></form>').css({position:"absolute",marginTop:"-17px"}),c=e("<input>").val(a.results.join(",")),u=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');l.append(c).append(u),u.on("click",function(){var e=c.val().split(",").filter(function(t){return t.length>0}).map(function(t){return+t});if(t.isEqual(e,a.results))return r.hideEditors(),!1;n.msg.saving(),s.css({textAlign:"center"}).html('<i class="fa fa-spinner fa-spin"></i>');var i=r.ajax({method:"POST",url:"/qi/reports/outgoingQuality/weeks/"+a._id,data:JSON.stringify({results:e})});return i.fail(function(){n.msg.savingFailed()}),i.done(function(){n.msg.saved()}),i.always(function(){s.css({textAlign:""}).html(o)}),!1}),s.html("").append(l),c.select2({width:"300px",allowClear:!0,multiple:!0,placeholder:" ",maximumSelectionSize:3,data:r.collection.map(function(t){var e=t.get("rid").toString();return{id:e,text:e,result:t}}),formatSelection:function(t){return t.id},formatResult:function(t){return'<span class="text-mono">'+t.id+"; "+t.result.get("pareto")+"; "+t.result.get("concern")+"</span>"}}),setTimeout(function(){c.focus()},1)},showStandardEditor:function(t){var i=this,r=i.$(t);if(r.find("form").length)return r.find("select").focus(),!1;i.hideEditors();var s=i.collection.get(r.closest("tr").attr("data-id")),a=r.text(),l=e('<form class="qi-oqlReport-results-editor"></form>'),c=e('<select class="form-control"><option></option></select>'),u=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');o.standards.forEach(function(t){e("<option></option>").attr("value",t.id).prop("selected",t.id===s.get("standard")).text(t.get("name")).appendTo(c)}),l.append(c).append(u),u.on("click",function(){var t=c.val(),e=o.standards.get(t);if(e||(t=null),t===s.get("standard"))return i.hideEditors(),!1;n.msg.saving(),r.css({textAlign:"center"}).html('<i class="fa fa-spinner fa-spin"></i>');var l=i.ajax({method:"PUT",url:"/qi/results/"+s.id,data:JSON.stringify({standard:t})});return l.fail(function(){n.msg.savingFailed(),r.text(a)}),l.done(function(){n.msg.saved(),s.set("standard",t),r.text(e?e.get("name"):"")}),l.always(function(){r.css({textAlign:""})}),!1}),r.html("").append(l),setTimeout(function(){c.focus()},1)},hideEditors:function(){var e=this.$("form").parent(),i=this.collection.get(e.closest("tr").attr("data-id")),n="";if(i)if("rid"===e[0].dataset.id){var r=i.get("rid"),s=this.collection.report.getSpecifiedResults();n=r.toString(),t.includes(s,r)&&(n="<strong>"+r+"</strong>")}else{var a=o.standards.get(i.get("standard"));a&&(n=t.escape(a.get("name")))}e.html(n)},isPrintable:function(){return this.collection.report.get("printable")},serializeColumns:function(){var t=this.isPrintable();return[{id:"rid",tdClassName:"is-min is-number",visible:!t},{id:"kpi",className:"is-min"},{id:"site",className:"is-min"},{id:"date",className:"is-min"},{id:"pareto"},{id:"concern"},{id:"rootCause",visible:!t},{id:"problem"},{id:"countermeasure"},{id:"check",className:t?"":"is-min"},{id:"standard",className:"is-min"},{id:"who",className:t?"":"is-min"},{id:"when",className:"is-min"}]},serializeActions:function(){return null},serializeRows:function(e){var n=this.collection;if(!n.length)return[];var r=n.report,c=r.getTopCount(),u={};t.forEach((r.get("top")||{}).what,function(t,e){e<c&&(u[t[0]]=t[1])});var d=this.isPrintable(),p={},f=n.map(function(e){var n=e.toJSON();n.rootCause=n.rootCause.map(function(e){return d?e.map(function(e,i){return i+1+". "+t.escape(e)}).join("; "):"<ol><li>"+e.map(function(e){return t.escape(e)}).join("<li>")+"</ol>"}).join(""),d&&(n.check=n.check.slice(0,1),n.who=n.who.slice(0,1),n.rootCause.length>205&&(n.rootCause=n.rootCause.substring(0,200)+"..."),n.problem.length>205&&(n.problem=n.problem.substring(0,200)+"..."),n.countermeasure.length>205&&(n.countermeasure=n.countermeasure.substring(0,200)+"...")),n.kpi="OQ",n.site="KÄ™trzyn",n.date=i.format(n.date,"L"),n.check=n.check.map(function(t){return a.get(t)?a.get(t).getLabel():t}).join("; "),n.who=n.who.map(function(t){return l({userInfo:t})}).join("<br>"),n.when=i.format(n.when,"L");var r=s.getByTypeAndId("mrpController",n.pareto);r&&(n.pareto+=": "+r.get("description")),d&&n.pareto.length>95&&(n.pareto=n.pareto.substring(0,90)+"..."),n.fault=n.concern,n.weight=0;var c=o.faults.get(n.concern);c&&(n.weight=c.get("weight"),d||(n.concern+=": "+c.get("name")));var u=o.standards.get(n.standard);return u&&(n.standard=u.get("name")),p[n.rid]=n,n});!1!==e&&(f=f.filter(function(t){return!!u[t.fault]})).sort(function(t,e){var i=u[e.fault]-u[t.fault];return 0===i&&(i=e.weight-t.weight),i});var g=[];r.getSpecifiedResults().forEach(function(t){var e=p[t];e&&(e.rid="<strong>"+e.rid+"</strong>",g.push(e),delete p[t])});for(var h=0;h<c&&g.length!==c;++h){var m=f.shift();m&&p[m.rid]&&g.push(m)}return g}})});