define(["underscore","jquery","app/time","app/viewport","app/core/View","app/core/templates/userInfo","app/data/orgUnits","app/data/prodFunctions","app/qiResults/dictionaries","app/qiResults/templates/outgoingQuality/results"],function(t,e,i,r,n,o,a,s,l,d){"use strict";function u(t){return(t||"").replace(/\n+/g,"\n").trim()}return n.extend({template:d,events:{'click a[data-action="editResults"]':function(t){return this.showResultsEditor(t.currentTarget),!1},'click a[data-action="editStandard"]':function(t){return this.showStandardEditor(t.currentTarget),!1}},initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection.report,"change:oqlWeek",this.onOqlWeekChanged),e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){e(window).off("."+this.idPrefix)},getTemplateData:function(){return{canManage:this.canManage(),results:this.serializeResults()}},onKeyDown:function(t){"Escape"===t.key&&this.hideEditors()},onOqlWeekChanged:function(t,e){e===t.getCurrentWeek()&&this.render()},canManage:function(){return this.collection.report.canManage()},showResultsEditor:function(i){var n=this,o=n.$(i).closest(".qi-oql-prop");if(!o.find("form").length){n.hideEditors();var a=n.collection.report.getCurrentWeek();if(a){var s=o.html(),l=e('<form class="qi-oql-results-editor"></form>'),d=e("<input>").val(a.results.join(",")),u=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');l.append(d).append(u),u.on("click",function(){var e=d.val().split(",").filter(function(t){return t.length>0}).map(function(t){return+t});if(t.isEqual(e,a.results))return n.hideEditors(),!1;r.msg.saving(),o.find(".qi-oql-prop-value").html('<i class="fa fa-spinner fa-spin"></i>');var i=n.ajax({method:"POST",url:"/qi/reports/outgoingQuality/weeks/"+a._id,data:JSON.stringify({results:e})});return i.fail(function(){r.msg.savingFailed(),o.html(s)}),i.done(function(){r.msg.saved(),n.hideEditors()}),!1}),o.append(l),d.select2({width:"300px",allowClear:!0,multiple:!0,placeholder:" ",maximumSelectionSize:3,data:n.collection.map(function(t){var e=t.get("rid").toString();return{id:e,text:e,result:t}}),formatSelection:function(t){return t.id},formatResult:function(t){return'<span class="text-mono">'+t.id+" | "+t.result.get("mrp")+" | "+t.result.get("faultCode")+"</span>"}}),setTimeout(function(){d.focus()},1)}}},showStandardEditor:function(t){var i=this,n=i.$(t).closest(".qi-oql-prop");if(!n.find("form").length){i.hideEditors();var o=i.collection.get(n.closest(".qi-oql-result").attr("data-id")),a=n.find(".qi-oql-prop-value").text(),s=e('<form class="qi-oql-results-editor"></form>'),d=e('<select class="form-control"><option></option></select>'),u=e('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');l.standards.forEach(function(t){e("<option></option>").attr("value",t.id).prop("selected",t.id===o.get("standard")).text(t.get("name")).appendTo(d)}),s.append(d).append(u),u.on("click",function(){var t=d.val();if(l.standards.get(t)||(t=null),t===o.get("standard"))return i.hideEditors(),!1;r.msg.saving(),n.find(".qi-oql-prop-value").html('<i class="fa fa-spinner fa-spin"></i>');var e=i.ajax({method:"PUT",url:"/qi/results/"+o.id,data:JSON.stringify({standard:t})});return e.fail(function(){r.msg.savingFailed(),n.find(".qi-oql-prop-value").text(a)}),e.done(function(){r.msg.saved(),o.set("standard",t),i.hideEditors()}),!1}),n.append(s),setTimeout(function(){d.focus()},1)}},hideEditors:function(){var e=this.$("form");if(e.length){var i=e.closest(".qi-oql-prop");e.remove();var r=this.collection.get(i.closest(".qi-oql-result").attr("data-id"));if(r){var n=i.attr("data-id"),o="-";if("rid"===n){var a=r.get("rid"),s=this.collection.report.getSpecifiedResults();o=a.toString(),t.includes(s,a)&&(o="<strong>"+a+"</strong>")}else if("standard"===n){var d=l.standards.get(r.get("standard"));d&&(o=t.escape(d.get("name")))}i.find(".qi-oql-prop-value").html(o)}}},serializeResults:function(){var e=this,i=e.collection;if(!i.length)return[];var r=i.report,n=r.getTopCount(),o={};t.forEach((r.get("top")||{}).what,function(t,e){e<n&&(o[t[0]]=t[1])});var a={},s=i.map(function(t){return a[t.get("rid")]=e.serializeResult(t)}).filter(function(t){return!!o[t.faultCode]}).sort(function(t,e){var i=o[e.faultCode]-o[t.faultCode];return 0===i&&(i=e.weight-t.weight),i}),l=[];r.getSpecifiedResults().forEach(function(t){var e=a[t];e&&(e.rid="<strong>"+e.rid+"</strong>",l.push(e),delete a[t])});for(var d=0;d<n&&l.length!==n;++d){var u=s.shift();u&&a[u.rid]&&l.push(u)}return l},serializeResult:function(t){var e=t.toJSON();e.kpi="OQ",e.site="KÄ™trzyn",e.date=i.format(e.inspectedAt,"L"),e.problem=u(e.problem),e.family=e.mrp;var r=a.getByTypeAndId("mrpController",e.mrp);r&&(e.family+=": "+r.get("description")),e.weight=0,e.concern=e.faultCode;var n=l.faults.get(e.faultCode);n&&(e.weight=n.get("weight"),e.concern+=": "+n.get("name"));var d=l.errorCategories.get(e.errorCategory);d&&(e.errorCategory=d.getLabel());var c=l.standards.get(e.standard);return c&&(e.standard=c.get("name")),e.rootCause.forEach(function(t){t.forEach(function(e,i){t[i]=u(e)})}),e.correctiveActions=e.correctiveActions.map(function(t){return{when:i.format(t.when,"L"),who:t.who.map(function(t){var e=o({userInfo:t}),i=s.get(t.prodFunction);return i&&(e+=" ("+i.getLabel()+")"),e}),what:u(t.what)}}),e}})});