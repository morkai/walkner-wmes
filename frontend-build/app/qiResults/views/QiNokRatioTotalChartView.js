// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/highcharts","app/core/View","app/reports/util/formatTooltipHeader","../dictionaries"],function(t,e,i,o,s,r){"use strict";return o.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:total",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this,o=t.serializeChartSeries();t.chart=new i.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:350},exporting:{filename:e("qiResults","report:filenames:nokRatio:total"),chartOptions:{legend:{enabled:!1}}},title:{text:e("qiResults","report:title:nokRatio:total")},noData:{},xAxis:{type:"datetime"},yAxis:{title:!1,allowDecimals:!0,min:o.min<10?0:o.min-1,max:100},tooltip:{shared:!0,valueDecimals:2,valueSuffix:"%",headerFormatter:s.bind(t),extraRowsProvider:function(t,i){var o=t[0].point.options;i.push({color:"#000000",decimals:0,name:e("qiResults","report:series:qtyNok"),value:o.qtyNok},{color:"#000000",decimals:0,name:e("qiResults","report:series:qtyNokInspected"),value:o.qtyNokInspected},{color:"#000000",decimals:0,name:e("qiResults","report:series:qtyInspected"),value:o.qtyInspected})}},legend:{enabled:!0},plotOptions:{column:{dataLabels:{enabled:!1,style:{color:"#000",fontSize:"12px",fontWeight:"bold",textShadow:"0 0 6px #fff, 0 0 3px #fff"},formatter:function(){return this.y||""}}}},series:o})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeChartSeries:function(){var i=r.settings.getNokRatioRef(),o=[],s=[{id:"total",type:"column",name:e("qiResults","report:series:nokRatio"),data:[],color:"#ffd580"}],a=i>0?i:100;return t.forEach(this.model.get("total"),function(t){var e=t.ratioInspected;s[0].data.push({x:t.key,y:e,qtyNok:t.qtyNok,qtyNokInspected:t.qtyNokInspected,qtyInspected:t.qtyInspected}),e<a&&(a=e),o.push({x:t.key,y:i})}),i>0&&s.push({id:"ref",type:"line",name:e.bound("qiResults","report:series:nokRatioRef"),data:o,color:"#5cb85c"}),s.min=a,s},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});