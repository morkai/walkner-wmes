// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/highcharts","app/core/View","app/data/colorFactory"],function(t,e,i,r,a){"use strict";return r.extend({initialize:function(){this.chart=null,this.isLoading=!1;var e=this.model;this.listenTo(e,"request",this.onModelLoading),this.listenTo(e,"sync",this.onModelLoaded),this.listenTo(e,"error",this.onModelError),this.listenTo(e,"change:groups change:selectedGroupKey",t.debounce(this.render.bind(this),1)),this.listenTo(e,"change:ignoredDivisions",this.updateSeriesData)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this.serializeChartData();this.chart=new i.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:500},exporting:{filename:e.bound("qiResults","report:filenames:nokQtyPerFamily"),chartOptions:{title:{text:{toString:this.getChartTitle.bind(this)}},legend:{enabled:!1}}},title:!1,noData:{},xAxis:{categories:t.categories},yAxis:{title:!1,min:0,allowDecimals:!1},tooltip:{shared:!0,valueDecimals:0,headerFormatter:function(t){return t.points[0].point.family}},legend:{enabled:!1},plotOptions:{column:{dataLabels:{enabled:!0,style:{color:"#000",fontSize:"12px",fontWeight:"bold",textShadow:"0 0 6px #fff, 0 0 3px #fff"}}}},series:[{type:"column",name:e.bound("qiResults","report:series:nokQty"),data:t.nokQty}]})},getChartTitle:function(){return this.el.parentNode.previousElementSibling.textContent},updateChart:function(){this.chart.destroy(),this.createChart()},updateSeriesData:function(){var t=this.serializeChartData();this.chart.xAxis[0].setCategories(t.categories,!1),this.chart.series[0].setData(t.nokQty,!0,!1,!1)},serializeChartData:function(){var e={categories:[],nokQty:[]},i=this.model,r=i.getSelectedGroup();if(!r)return e;var o=i.hasAnyIgnoredDivisions(),n=[];return t.forEach(r.nokQtyPerFamily,function(e,r){if(o){var a=e.perDivision;if("string"!=typeof a)e={qty:0,ridPerFault:{}},t.forEach(a,function(r,a){i.isIgnoredDivision(a)||(e.qty+=r.qty,t.forEach(r.ridPerFault,function(t,i){e.ridPerFault[i]||(e.ridPerFault[i]=[]),e.ridPerFault[i]=e.ridPerFault[i].concat(t)}))});else if(i.isIgnoredDivision(a))return}n.push({category:r,quantity:e.qty,ridPerFault:e.ridPerFault})}),n.sort(function(t,e){return e.quantity-t.quantity}),t.forEach(n,function(i){if(n.length<=20){var r=[];t.forEach(i.ridPerFault,function(t,e){r.push(e+"-"+t.join(","))}),e.categories.push("<b>"+i.category+"</b><br>"+r.join("; "))}else e.categories.push(i.category);e.nokQty.push({family:i.category,y:i.quantity,color:a.getColor("productFamily",i.category)})}),e},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});