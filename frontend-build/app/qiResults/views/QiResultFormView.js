// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/qiResults/dictionaries","../QiResult","app/qiResults/templates/form","app/qiResults/templates/correctiveActionFormRow"],function(t,i,e,n,s,a,o,r,d,l,c,u,h){"use strict";return r.extend({template:u,events:t.extend({"input #-orderNo":function(){this.clearOrderFields(),this.scheduleFindOrder()},"change #-faultCode":function(){var t=l.faults.get(this.$id("faultCode").val());this.$id("faultDescription").val(t.get("description")||t.get("name"))},"change #-kind":"updateDivision","click #-addAction":"addEmptyAction",'click [name="removeAction"]':function(t){var i=this,e=i.$(t.target).closest("tr");e.fadeOut("fast",function(){e.remove(),i.recountActions()})},'change [name="removeFile[]"]':function(t){this.$('input[name="'+t.target.value+'File"]').prop("disabled",t.target.checked)}},r.prototype.events),initialize:function(){r.prototype.initialize.apply(this,arguments),this.scheduleFindOrder=t.debounce(this.findOrder.bind(this),250),this.findOrderReq=null,this.statuses=null,this.actions=0},serialize:function(){return t.extend(r.prototype.serialize.call(this),{inspectedAtMin:"2000-01-01",inspectedAtMax:n.getMoment().startOf("day").add(1,"days").format("YYYY-MM-DD"),kinds:l.kinds.map(o),faults:l.faults.map(function(t){return{id:t.id,text:t.id+": "+t.get("name")}}),errorCategories:l.errorCategories.map(o),inspectors:this.serializeInspectors()})},serializeInspectors:function(){var t={},i=[];l.inspectors.forEach(function(e){var n=o(e);t[n.id]=!0,i.push(n)});var e=this.model.get("inspector");return this.options.editMode&&!t[e.id]&&i.unshift({id:e.id,text:e.text}),i},checkValidity:function(){return!0},submitRequest:function(i,n){var s=this,a=new FormData,o=0;if(this.$('input[type="file"]').each(function(){!this.disabled&&this.files.length&&(a.append(this.name,this.files[0]),++o)}),n.attachments={},t.forEach(n.removeFile,function(t){n.attachments[t+"File"]=null}),0===o)return r.prototype.submitRequest.call(s,i,n);var d=this.$el.find(".fa-spinner").removeClass("hidden"),l=this.ajax({type:"POST",url:"/qi/results;upload",data:a,processData:!1,contentType:!1});l.done(function(e){t.extend(n.attachments,e),r.prototype.submitRequest.call(s,i,n)}),l.fail(function(){s.showErrorMessage(e("qiResults","FORM:ERROR:upload")),i.attr("disabled",!1)}),l.always(function(){d.addClass("hidden")})},serializeToForm:function(){var i=this.model.toJSON();if(i.inspector=i.inspector?i.inspector.id:"",i.inspectedAt=n.format(i.inspectedAt,"YYYY-MM-DD"),t.forEach(i.correctiveActions,function(t){var i=n.getMoment(t.when);t.when=i.isValid()?i.format("YYYY-MM-DD"):""}),!this.options.editMode){var e=l.faults.at(0);i.faultDescription=e?e.get("description")||e.get("name"):""}return i.okFile="",i.nokFile="",i},serializeForm:function(i){var e=this.$id("inspector")[0].selectedOptions[0];this.options.editMode&&(i.updater=s.getInfo()),i.inspector={id:e.value,label:e.label.trim()},this.$("textarea").each(function(){i[this.name]||(i[this.name]="")});var a=this.$id("actions").children();return i.correctiveActions=t.map(i.correctiveActions,function(i,e){var s=n.getMoment(i.when);return{what:i.what||"",when:s.isValid()?s.toDate():null,who:t.map(a.eq(e).find('input[name$="who"]').select2("data"),function(t){return{id:t.id,label:t.text}}),status:i.status}}).filter(function(t){return t.what.length>0}),i},afterRender:function(){r.prototype.afterRender.call(this),this.options.editMode?t.forEach(this.model.get("correctiveActions"),this.addAction,this):this.addEmptyAction(),this.findOrder(),this.toggleRoleFields()},toggleRoleFields:function(){var t=s.isAllowedTo("QI:RESULTS:MANAGE"),i=s.isAllowedTo("QI:INSPECTOR"),e=s.isAllowedTo("QI:SPECIALIST");this.$("[data-role]").each(function(){var n,s=this.dataset.role;n=t||!s?!0:i&&"inspector"===s||e&&"specialist"===s,this.disabled=!n})},clearOrderFields:function(){this.$id("nc12").val(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val("")},findOrder:function(){var t=this;t.findOrderReq&&(t.findOrderReq.abort(),t.findOrderReq=null);var i=t.$id("orderNo");i[0].setCustomValidity(e("qiResults","FORM:ERROR:orderNo"));var n=t.$id("orderNo").val().replace(/[^0-9]+/g,"");if(9===n.length){var s=t.ajax({method:"GET",url:"/qi/results;order",data:{no:n}});s.always(function(){t.findOrderReq=null}),s.done(function(e){t.$id("nc12").val(e.nc12),t.$id("productName").val(e.productName),t.$id("productFamily").val(e.productFamily),t.$id("division").val(e.division).attr("data-orders-division",e.division),i[0].setCustomValidity(""),t.updateDivision()}),t.findOrderReq=s}},addEmptyAction:function(){this.addAction({status:"",when:"",who:[],what:""})},addAction:function(t){this.statuses||(this.statuses=l.actionStatuses.map(o));var i=this.$id("actions");t.i=this.actions++,t.no=i.children().length+1,i.append(h({statuses:this.statuses,action:t}));var e=d(i.children().last().find('[name$="who"]'),{width:"300px",allowClear:!0,multiple:!0,textFormatter:function(t,i){return i}});e.select2("data",t.who.map(function(t){return{id:t.id,text:t.label}}))},recountActions:function(){this.$id("actions").children().each(function(t){this.firstElementChild.textContent=t+1})},updateDivision:function(){var t=l.kinds.get(this.$id("kind").val());if(t){var i=this.$id("division"),e=i.attr("data-orders-division"),n=t.get("division");i.val(n||e)}}})});