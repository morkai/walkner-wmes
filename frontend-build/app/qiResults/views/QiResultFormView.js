define(["underscore","jquery","app/i18n","app/time","app/user","app/data/orgUnits","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/util/getInputLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/qiResults/dictionaries","../QiResult","app/qiResults/templates/form","app/qiResults/templates/correctiveActionFormRow"],function(e,t,i,s,r,n,a,o,d,l,c,u,h,p,f){"use strict";var m=/Android/i.test(window.navigator.userAgent);return l.extend({template:p,events:e.assign({"input #-orderNo":function(){this.clearOrderFields(),this.scheduleFindOrder()},"change #-faultCode":function(){var e=u.faults.get(this.$id("faultCode").val()),t=e.get("name").trim(),i=e.get("description").trim();this.$id("faultDescription").val(t+(i?":\n"+i:""))},"change #-kind":function(){this.updateDivision(),this.toggleRequireOrder()},"click #-addAction":"addEmptyAction",'click [name="removeAction"]':function(e){var t=this,i=t.$(e.target).closest("tr");i.fadeOut("fast",function(){i.remove(),t.recountActions()})},'change [name="removeFile[]"]':function(e){this.$('input[name="'+e.target.value+'File"]').prop("disabled",e.target.checked)},'change [name="ok"]':function(){this.model.set(e.assign(this.getFormData(),{ok:this.$id("ok").prop("checked")}),{silent:!0}),this.render()},"change #-serialNumbers":function(e){e.target.value=this.parseSerialNumbers(e.target.value).join(", ")}},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.scheduleFindOrder=e.debounce(this.findOrder.bind(this),250),this.findOrderCount=0,this.findOrderReq=null,this.statuses=null,this.actions=0},serialize:function(){var t=this.model.get("faultCode");return e.assign(l.prototype.serialize.call(this),{inspectedAtMin:s.getMoment(this.model.get("inspectedAt")).clone().subtract(14,"days").format("YYYY-MM-DD"),inspectedAtMax:s.getMoment().startOf("day").add(1,"days").format("YYYY-MM-DD"),kinds:u.kinds.map(o),faults:u.faults.filter(function(e){return e.id===t||!1!==e.get("active")}).map(function(e){return{id:e.id,text:e.id+": "+e.get("name")}}),errorCategories:u.errorCategories.map(o),inspectors:this.serializeInspectors(),masters:this.serializeLeaders("masters","nokOwner"),leaders:this.serializeLeaders("leaders","leader"),divisions:n.getAllByType("division"),isAndroid:m,canEditAttachments:this.model.canEditAttachments(this.options.editMode),canEditActions:this.model.canEditActions(this.options.editMode),canAddActions:this.model.canAddActions()})},serializeInspectors:function(){var e={},t=[];u.inspectors.forEach(function(i){if(i.get("active")){var s=o(i);e[s.id]=!0,t.push(s)}});var i=this.model.get("inspector");return i&&!e[i.id]&&t.unshift({id:i.id,text:i.label}),t.sort(function(e,t){return e.text.localeCompare(t.text)})},serializeLeaders:function(e,t){var i={},s=[];u[e].forEach(function(e){if(e.get("active")){var t=o(e);i[t.id]=!0,s.push(t)}});var r=this.model.get(t);return r&&!i[r.id]&&s.unshift({id:r.id,text:r.label}),s.sort(function(e,t){return e.text.localeCompare(t.text)})},checkValidity:function(){return!0},submitRequest:function(t,s){var r=this,n=new FormData,a=0;if(this.$('input[type="file"]').each(function(){!this.disabled&&this.files.length&&(n.append(this.name,this.files[0]),++a)}),s.attachments={},e.forEach(s.removeFile,function(e){s.attachments[e+"File"]=null}),0===a)return l.prototype.submitRequest.call(r,t,s);var o=this.$el.find(".fa-spinner").removeClass("hidden"),d=this.ajax({type:"POST",url:"/qi/results;upload",data:n,processData:!1,contentType:!1});d.done(function(i){e.assign(s.attachments,i),l.prototype.submitRequest.call(r,t,s)}),d.fail(function(){r.showErrorMessage(i("qiResults","FORM:ERROR:upload")),t.attr("disabled",!1)}),d.always(function(){o.addClass("hidden")})},serializeToForm:function(){var t=this.model.toJSON();if(t.inspector=t.inspector?t.inspector.id:"",t.nokOwner=t.nokOwner?t.nokOwner.id:"",t.leader=t.leader?t.leader.id:"",t.inspectedAt=s.format(t.inspectedAt,"YYYY-MM-DD"),t.serialNumbers=t.serialNumbers?t.serialNumbers.join(", "):"",e.forEach(t.correctiveActions,function(e){var t=s.getMoment(e.when);e.when=t.isValid()?t.format("YYYY-MM-DD"):""}),!this.options.editMode){var i=u.faults.at(0);t.faultDescription=i?i.get("description")||i.get("name"):""}return t.okFile="",t.nokFile="","000000000"===t.orderNo&&(t.orderNo="",t.nc12="",t.productFamily="",t.productName=""),t},serializeForm:function(i){var n=this;return i=e.assign(this.model.toJSON(),i),["inspector","nokOwner","leader"].forEach(function(e){var t=(n.$id(e)[0]||{selectedOptions:[]}).selectedOptions[0];t&&t.value?i[e]={id:t.value,label:t.label.trim()}:t&&(i[e]=null)}),i.line||(i.line=null),n.options.editMode&&(i.updater=r.getInfo()),n.$("textarea").each(function(){i[this.name]||(i[this.name]="")}),i.serialNumbers=this.parseSerialNumbers(i.serialNumbers),i.correctiveActions=[],n.$id("actions").children().each(function(){var r=s.getMoment(this.querySelector('[name$="when"]').value),n=this.querySelector('[name$="what"]').value.trim();""!==n&&i.correctiveActions.push({what:n,when:r.isValid()?r.toDate():null,who:e.map(t(this.querySelector('[name$="who"]')).select2("data"),function(e){return{id:e.id,label:e.text}}),status:this.querySelector('[name$="status"]').value})}),i.orderNo||u.kinds.get(i.kind).get("order")||(i.orderNo="000000000",i.nc12="000000000000",i.productFamily="000000",i.productName="0"),i},afterRender:function(){l.prototype.afterRender.call(this);var t=this.model.get("correctiveActions");e.isEmpty(t)?this.addEmptyAction():e.forEach(this.model.get("correctiveActions"),this.addAction,this),this.setUpInspectorSelect2(),this.setUpLeaderSelect2("nokOwner"),this.setUpLeaderSelect2("leader"),a.toggle(this.$id("result")),this.toggleRoleFields(),this.toggleRequireOrder(),this.findOrder()},setUpInspectorSelect2:function(){m||this.$id("inspector").removeClass("form-control").select2().closest(".form-group").addClass("has-required-select2")},setUpLeaderSelect2:function(e){m||this.$id(e).removeClass("form-control").select2({placeholder:" ",allowClear:!0})},parseSerialNumbers:function(e){if(Array.isArray(e))return e;var t=this.$id("orderNo").val();return/^[0-9]{9}$/.test(t)||(t=""),(e||"").split(/(\s+|,|;)/).filter(function(e){return/^[a-zA-Z0-9.]+$/.test(e)}).map(function(e){if(/^[0-9]{1,4}$/.test(e)&&t){for(;e.length<4;)e="0"+e;return"PL04."+t+"."+e}return e.toUpperCase()})},toggleRoleFields:function(){var e=r.isAllowedTo("QI:RESULTS:MANAGE"),i=this.model.isInspector(),s=r.isAllowedTo("QI:SPECIALIST"),n=this.model.isNokOwner(),a=this.model.isLeader();this.$("[data-role]").each(function(){var r,o=this.dataset.role;r=!(!e&&o)||(i&&-1!==o.indexOf("inspector")||s&&-1!==o.indexOf("specialist")||n&&-1!==o.indexOf("nokOwner")||a&&-1!==o.indexOf("leader")),this.disabled=!r,m||"inspector"!==this.name&&"nokOwner"!==this.name||t(this).select2("enable",!this.disabled)}),this.$id("result").find(".btn").toggleClass("disabled",!e&&!i)},clearOrderFields:function(){this.$id("nc12").val(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val(""),this.$id("qtyOrder").val(""),this.updateLeaders([]),this.updateLines([])},findOrder:function(){var e=this,t=e.$id("orderNo");if(t.prop("disabled"))return this.updateLines([]),void this.updateLeaders([]);e.findOrderCount+=1,e.findOrderReq&&(e.findOrderReq.abort(),e.findOrderReq=null),t[0].setCustomValidity(t[0].required?i("qiResults","FORM:ERROR:orderNo"):"");var s=e.$id("orderNo").val().replace(/[^0-9]+/g,"").replace(/^0+/,"");if(9===s.length){var r=e.ajax({method:"GET",url:"/qi/results;order",data:{no:s}});r.always(function(){e.findOrderReq=null,t[0].setCustomValidity(i("qiResults","FORM:ERROR:orderNo"))}),r.done(function(i){e.$id("nc12").val(i.nc12),e.$id("productName").val(i.productName),e.$id("productFamily").val(i.productFamily),e.$id("division").val(i.division).attr("data-orders-division",i.division),e.$id("qtyOrder").val(i.quantity),e.updateLines(i.lines),e.updateLeaders(i.leaders),e.updateDivision(),t[0].setCustomValidity("")}),e.findOrderReq=r}},addEmptyAction:function(){this.addAction({status:"new",when:"",who:[],what:""})},addAction:function(t){this.statuses||(this.statuses=u.actionStatuses.map(o));var i=this.$id("actions");t.i=this.actions++,t.no=i.children().length+1;var s=r.isAllowedTo("QI:RESULTS:MANAGE","QI:SPECIALIST"),n=this.model.isNokOwner(),a=this.model.isLeader(),d=r.isAllowedTo("FN:master","FN:leader"),l=e.some(t.who,function(e){return e.id===r.data._id});i.append(f({statuses:this.statuses,action:t,canChangeStatus:s,canChangeWhen:s||n||a||l||d,canChangeWho:s||n||d,canChangeWhat:s||n||a||l||d,canRemove:s||n&&"new"===t.status})),c(i.children().last().find('[name$="who"]'),{width:"300px",allowClear:!0,multiple:!0,textFormatter:function(e,t){return t}}).select2("data",t.who.map(function(e){return{id:e.id,text:e.label}}))},recountActions:function(){this.$id("actions").children().each(function(e){this.firstElementChild.textContent=e+1})},updateDivision:function(){var e=u.kinds.get(this.$id("kind").val());if(e){var t=this.$id("division"),i=t.attr("data-orders-division"),s=e.get("division");t.val(s||i)}},toggleRequireOrder:function(){var e=u.kinds.get(this.$id("kind").val());if(e){var t=this.$id("orderGroup"),i=this.$id("orderNo"),s=!i.prop("disabled")&&!!e.get("order");d(i).toggleClass("is-required",s),s||""!==i.val().trim()||i[0].setCustomValidity(""),t.find("input").prop("required",s)}},updateLines:function(t){var i=this.$id("line"),s=[],r={},a=this.model.get("line");m||s.push({id:"",text:""}),t.forEach(function(e){s.push({id:e,text:e}),r[e]=1}),t.length&&s.push({id:"",text:"",disabled:!0}),s=s.concat(n.getAllByType("prodLine").filter(function(e){return!(r[e.id]||e.get("deactivatedAt")&&e.id!==a)}).map(function(e){return{id:e.id,text:e.id}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})})),i.html(s.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?i.val(a||""):i.val(a||(t.length?t[0]:"")),m||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})},updateLeaders:function(t){var i=this.$id("leader"),s=[],r={},n=this.model.get("leader");m||s.push({id:"",text:""}),t.forEach(function(e){var t,i=u.leaders.get(e.id);if(i)t=i.getLabel();else{var n=e.label.replace(/ \(.*?$/,"").split(" "),a=n.shift();t=n.join(" ")+" "+a}s.push({id:e.id,text:t}),r[e.id]=1}),t.length&&s.push({id:"",text:"",disabled:!0}),!n||r[n.id]||u.leaders.get(n.id)||s.push({id:n.id,text:n.label}),u.leaders.forEach(function(e){r[e.id]||s.push({id:e.id,text:e.getLabel()})}),i.html(s.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?i.val(n?n.id:""):i.val(n?n.id:t.length?t[0].id:""),m||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})}})});