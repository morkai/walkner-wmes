// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/data/orgUnits","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/qiResults/dictionaries","../QiResult","app/qiResults/templates/form","app/qiResults/templates/correctiveActionFormRow"],function(e,t,i,n,s,a,r,o,d,l,c,u,h,p){"use strict";var f=/Android/i.test(window.navigator.userAgent);return d.extend({template:h,events:e.extend({"input #-orderNo":function(){this.clearOrderFields(),this.scheduleFindOrder()},"change #-faultCode":function(){var e=c.faults.get(this.$id("faultCode").val()),t=e.get("name").trim(),i=e.get("description").trim();this.$id("faultDescription").val(t+(i?":\n"+i:""))},"change #-kind":"updateDivision","click #-addAction":"addEmptyAction",'click [name="removeAction"]':function(e){var t=this,i=t.$(e.target).closest("tr");i.fadeOut("fast",function(){i.remove(),t.recountActions()})},'change [name="removeFile[]"]':function(e){this.$('input[name="'+e.target.value+'File"]').prop("disabled",e.target.checked)},'change [name="ok"]':function(){this.model.set(e.extend(this.getFormData(),{ok:this.$id("ok").prop("checked")}),{silent:!0}),this.render()},"change #-serialNumbers":function(e){e.target.value=this.parseSerialNumbers(e.target.value).join(", ")}},d.prototype.events),initialize:function(){d.prototype.initialize.apply(this,arguments),this.scheduleFindOrder=e.debounce(this.findOrder.bind(this),250),this.findOrderCount=0,this.findOrderReq=null,this.statuses=null,this.actions=0},serialize:function(){var t=this.model.get("faultCode");return e.extend(d.prototype.serialize.call(this),{inspectedAtMin:n.getMoment(this.model.get("inspectedAt")).clone().subtract(14,"days").format("YYYY-MM-DD"),inspectedAtMax:n.getMoment().startOf("day").add(1,"days").format("YYYY-MM-DD"),kinds:c.kinds.map(o),faults:c.faults.filter(function(e){return e.id===t||!1!==e.get("active")}).map(function(e){return{id:e.id,text:e.id+": "+e.get("name")}}),errorCategories:c.errorCategories.map(o),inspectors:this.serializeInspectors(),masters:this.serializeLeaders("masters","nokOwner"),leaders:this.serializeLeaders("leaders","leader"),divisions:a.getAllByType("division"),isAndroid:f,canEditAttachments:this.model.canEditAttachments(this.options.editMode),canEditActions:this.model.canEditActions(this.options.editMode),canAddActions:this.model.canAddActions()})},serializeInspectors:function(){var e={},t=[];c.inspectors.forEach(function(i){var n=o(i);e[n.id]=!0,t.push(n)});var i=this.model.get("inspector");return i&&!e[i.id]&&t.unshift({id:i.id,text:i.label}),t.sort(function(e,t){return e.text.localeCompare(t.text)})},serializeLeaders:function(e,t){var i={},n=[];c[e].forEach(function(e){var t=o(e);i[t.id]=!0,n.push(t)});var s=this.model.get(t);return s&&!i[s.id]&&n.unshift({id:s.id,text:s.label}),n.sort(function(e,t){return e.text.localeCompare(t.text)})},checkValidity:function(){return!0},submitRequest:function(t,n){var s=this,a=new FormData,r=0;if(this.$('input[type="file"]').each(function(){!this.disabled&&this.files.length&&(a.append(this.name,this.files[0]),++r)}),n.attachments={},e.forEach(n.removeFile,function(e){n.attachments[e+"File"]=null}),0===r)return d.prototype.submitRequest.call(s,t,n);var o=this.$el.find(".fa-spinner").removeClass("hidden"),l=this.ajax({type:"POST",url:"/qi/results;upload",data:a,processData:!1,contentType:!1});l.done(function(i){e.extend(n.attachments,i),d.prototype.submitRequest.call(s,t,n)}),l.fail(function(){s.showErrorMessage(i("qiResults","FORM:ERROR:upload")),t.attr("disabled",!1)}),l.always(function(){o.addClass("hidden")})},serializeToForm:function(){var t=this.model.toJSON();if(t.inspector=t.inspector?t.inspector.id:"",t.nokOwner=t.nokOwner?t.nokOwner.id:"",t.leader=t.leader?t.leader.id:"",t.inspectedAt=n.format(t.inspectedAt,"YYYY-MM-DD"),t.serialNumbers=t.serialNumbers?t.serialNumbers.join(", "):"",e.forEach(t.correctiveActions,function(e){var t=n.getMoment(e.when);e.when=t.isValid()?t.format("YYYY-MM-DD"):""}),!this.options.editMode){var i=c.faults.at(0);t.faultDescription=i?i.get("description")||i.get("name"):""}return t.okFile="",t.nokFile="",t},serializeForm:function(i){var a=this;return["inspector","nokOwner","leader"].forEach(function(e){var t=(a.$id(e)[0]||{selectedOptions:[]}).selectedOptions[0];t&&t.value?i[e]={id:t.value,label:t.label.trim()}:t&&(i[e]=null)}),i.line||(i.line=null),a.options.editMode&&(i.updater=s.getInfo()),a.$("textarea").each(function(){i[this.name]||(i[this.name]="")}),i.serialNumbers=this.parseSerialNumbers(i.serialNumbers),i.correctiveActions=[],a.$id("actions").children().each(function(){var s=n.getMoment(this.querySelector('[name$="when"]').value),a=this.querySelector('[name$="what"]').value.trim();""!==a&&i.correctiveActions.push({what:a,when:s.isValid()?s.toDate():null,who:e.map(t(this.querySelector('[name$="who"]')).select2("data"),function(e){return{id:e.id,label:e.text}}),status:this.querySelector('[name$="status"]').value})}),i},afterRender:function(){d.prototype.afterRender.call(this);var t=this.model.get("correctiveActions");e.isEmpty(t)?this.addEmptyAction():e.forEach(this.model.get("correctiveActions"),this.addAction,this),this.setUpInspectorSelect2(),this.setUpLeaderSelect2("nokOwner"),this.setUpLeaderSelect2("leader"),r.toggle(this.$id("result")),this.toggleRoleFields(),this.findOrder()},setUpInspectorSelect2:function(){f||this.$id("inspector").removeClass("form-control").select2().closest(".form-group").addClass("has-required-select2")},setUpLeaderSelect2:function(e){f||this.$id(e).removeClass("form-control").select2({placeholder:" ",allowClear:!0})},parseSerialNumbers:function(e){var t=this.$id("orderNo").val();return/^[0-9]{9}$/.test(t)||(t=""),(e||"").split(/(\s+|,|;)/).filter(function(e){return/^[a-zA-Z0-9.]+$/.test(e)}).map(function(e){if(/^[0-9]{1,4}$/.test(e)&&t){for(;e.length<4;)e="0"+e;return"PL04."+t+"."+e}return e.toUpperCase()})},toggleRoleFields:function(){var e=s.isAllowedTo("QI:RESULTS:MANAGE"),i=this.model.isInspector(),n=s.isAllowedTo("QI:SPECIALIST"),a=this.model.isNokOwner(),r=this.model.isLeader();this.$("[data-role]").each(function(){var s,o=this.dataset.role;s=!(!e&&o)||(i&&-1!==o.indexOf("inspector")||n&&-1!==o.indexOf("specialist")||a&&-1!==o.indexOf("nokOwner")||r&&-1!==o.indexOf("leader")),this.disabled=!s,f||"inspector"!==this.name&&"nokOwner"!==this.name||t(this).select2("enable",!this.disabled)}),this.$id("result").find(".btn").toggleClass("disabled",!e&&!i)},clearOrderFields:function(){this.$id("nc12").val(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val(""),this.$id("qtyOrder").val(""),this.updateLeaders([]),this.updateLines([])},findOrder:function(){var e=this,t=e.$id("orderNo");if(t.prop("disabled"))return this.updateLines([]),void this.updateLeaders([]);e.findOrderCount+=1,e.findOrderReq&&(e.findOrderReq.abort(),e.findOrderReq=null),t[0].setCustomValidity(i("qiResults","FORM:ERROR:orderNo"));var n=e.$id("orderNo").val().replace(/[^0-9]+/g,"");if(9===n.length){var s=e.ajax({method:"GET",url:"/qi/results;order",data:{no:n}});s.always(function(){e.findOrderReq=null}),s.done(function(i){e.$id("nc12").val(i.nc12),e.$id("productName").val(i.productName),e.$id("productFamily").val(i.productFamily),e.$id("division").val(i.division).attr("data-orders-division",i.division),e.$id("qtyOrder").val(i.quantity),e.updateLines(i.lines),e.updateLeaders(i.leaders),e.updateDivision(),t[0].setCustomValidity("")}),e.findOrderReq=s}},addEmptyAction:function(){this.addAction({status:"new",when:"",who:[],what:""})},addAction:function(t){this.statuses||(this.statuses=c.actionStatuses.map(o));var i=this.$id("actions");t.i=this.actions++,t.no=i.children().length+1;var n=s.isAllowedTo("QI:RESULTS:MANAGE","QI:SPECIALIST"),a=this.model.isNokOwner(),r=this.model.isLeader(),d=e.some(t.who,function(e){return e.id===s.data._id});i.append(p({statuses:this.statuses,action:t,canChangeStatus:n,canChangeWhen:n||a||r||d,canChangeWho:n||a,canChangeWhat:n||a||r||d,canRemove:n||a&&"new"===t.status})),l(i.children().last().find('[name$="who"]'),{width:"300px",allowClear:!0,multiple:!0,textFormatter:function(e,t){return t}}).select2("data",t.who.map(function(e){return{id:e.id,text:e.label}}))},recountActions:function(){this.$id("actions").children().each(function(e){this.firstElementChild.textContent=e+1})},updateDivision:function(){var e=c.kinds.get(this.$id("kind").val());if(e){var t=this.$id("division"),i=t.attr("data-orders-division"),n=e.get("division");t.val(n||i)}},updateLines:function(t){var i=this.$id("line"),n=[],s={},r=this.model.get("line");f||n.push({id:"",text:""}),t.forEach(function(e){n.push({id:e,text:e}),s[e]=1}),t.length&&n.push({id:"",text:"",disabled:!0}),n=n.concat(a.getAllByType("prodLine").filter(function(e){return!(s[e.id]||e.get("deactivatedAt")&&e.id!==r)}).map(function(e){return{id:e.id,text:e.id}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})})),i.html(n.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?i.val(r||""):i.val(r||(t.length?t[0]:"")),f||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})},updateLeaders:function(t){var i=this.$id("leader"),n=[],s={},a=this.model.get("leader");f||n.push({id:"",text:""}),t.forEach(function(e){var t,i=c.leaders.get(e.id);if(i)t=i.getLabel();else{var a=e.label.replace(/ \(.*?$/,"").split(" "),r=a.shift();t=a.join(" ")+" "+r}n.push({id:e.id,text:t}),s[e.id]=1}),t.length&&n.push({id:"",text:"",disabled:!0}),!a||s[a.id]||c.leaders.get(a.id)||n.push({id:a.id,text:a.label}),c.leaders.forEach(function(e){s[e.id]||n.push({id:e.id,text:e.getLabel()})}),i.html(n.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?i.val(a?a.id:""):i.val(a?a.id:t.length?t[0].id:""),f||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})}})});