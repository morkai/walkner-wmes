define(["underscore","jquery","app/i18n","app/time","app/user","app/data/orgUnits","app/data/localStorage","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/util/getInputLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/qiResults/dictionaries","../QiResult","app/qiResults/templates/form","app/qiResults/templates/correctiveActionFormRow"],function(e,t,i,r,s,n,o,a,d,l,c,u,h,p,m,f){"use strict";var g=/Android/i.test(window.navigator.userAgent);return c.extend({template:m,events:e.assign({"change #-source":function(){o.setItem("WMES_QI_SOURCE",this.getSource()),this.setUpLeaderSelect2(),this.toggleSourceFields(),this.toggleRequireOrder(),this.clearOrderFields(),this.clearComponentFields()},"input #-orderNo":function(){this.clearOrderFields(),this.scheduleFindOrder()},"input #-nc12":function(){this.clearComponentFields(),this.scheduleFindComponent()},"change #-faultCode":function(){var e=h.faults.get(this.$id("faultCode").val()),t=e.get("name").trim(),i=e.get("description").trim();this.$id("faultDescription").val(t+(i?":\n"+i:""))},"change #-kind":function(){this.updateDivision(),this.toggleRequireOrder()},"click #-addAction":"addEmptyAction",'click [name="removeAction"]':function(e){var t=this,i=t.$(e.target).closest("tr");i.fadeOut("fast",function(){i.remove(),t.recountActions()})},'change [name="removeFile[]"]':function(e){this.$('input[name="'+e.target.value+'File"]').prop("disabled",e.target.checked)},'change [name="ok"]':function(){this.model.set(e.assign(this.getFormData(),{ok:this.$id("ok").prop("checked")}),{silent:!0}),this.render()},"change #-serialNumbers":function(e){e.target.value=this.parseSerialNumbers(e.target.value).join(", ")}},c.prototype.events),initialize:function(){c.prototype.initialize.apply(this,arguments),this.scheduleFindOrder=e.debounce(this.findOrder.bind(this),250),this.scheduleFindComponent=e.debounce(this.findComponent.bind(this),250),this.findOrderCount=0,this.findOrderReq=null,this.statuses=null,this.actions=0,this.listenToOnce(this,"beforeRender",function(){if(!this.model.get("errorCategory")){var e=h.settings.getValue("defaultErrorCategory"),t=h.errorCategories.get(e);t&&this.model.set({errorCategory:t.id},{silent:!0})}})},serialize:function(){var t=this.model.get("faultCode");return e.assign(c.prototype.serialize.call(this),{inspectedAtMin:r.getMoment(this.model.get("inspectedAt")).clone().subtract(14,"days").format("YYYY-MM-DD"),inspectedAtMax:r.getMoment().startOf("day").add(1,"days").format("YYYY-MM-DD"),kinds:h.kinds.map(d),faults:h.faults.filter(function(e){return e.id===t||!1!==e.get("active")}).map(function(e){return{id:e.id,text:e.id+": "+e.get("name")}}),errorCategories:h.errorCategories.map(d),inspectors:this.serializeInspectors(),masters:this.serializeLeaders("masters","nokOwner"),divisions:n.getAllByType("division"),isAndroid:g,canEditAttachments:this.model.canEditAttachments(this.options.editMode),canEditActions:this.model.canEditActions(this.options.editMode),canAddActions:this.model.canAddActions()})},serializeInspectors:function(){var e={},t=[];h.inspectors.forEach(function(i){if(i.get("active")){var r=d(i);e[r.id]=!0,t.push(r)}});var i=this.model.get("inspector");return i&&!e[i.id]&&t.unshift({id:i.id,text:i.label}),t.sort(function(e,t){return e.text.localeCompare(t.text)})},serializeLeaders:function(e,t){var i={},r=[];h[e].forEach(function(e){if(e.get("active")){var t=d(e);i[t.id]=!0,r.push(t)}});var s=this.model.get(t);return s&&!i[s.id]&&r.unshift({id:s.id,text:s.label}),r.sort(function(e,t){return e.text.localeCompare(t.text)})},checkValidity:function(){return!0},submitRequest:function(t,r){var s=this,n=new FormData,o=0;if(this.$('input[type="file"]').each(function(){!this.disabled&&this.files.length&&(n.append(this.name,this.files[0]),++o)}),r.attachments={},e.forEach(r.removeFile,function(e){r.attachments[e+"File"]=null}),0===o)return c.prototype.submitRequest.call(s,t,r);var a=this.$el.find(".fa-spinner").removeClass("hidden"),d=this.ajax({type:"POST",url:"/qi/results;upload",data:n,processData:!1,contentType:!1});d.done(function(i){e.assign(r.attachments,i),c.prototype.submitRequest.call(s,t,r)}),d.fail(function(){s.showErrorMessage(i("qiResults","FORM:ERROR:upload")),t.attr("disabled",!1)}),d.always(function(){a.addClass("hidden")})},serializeToForm:function(){var t=this.model.toJSON();if(t.inspector=t.inspector?t.inspector.id:"",t.nokOwner=t.nokOwner?t.nokOwner.id:"",t.leader=t.leader?t.leader.id:"",t.inspectedAt=r.format(t.inspectedAt,"YYYY-MM-DD"),t.serialNumbers=t.serialNumbers?t.serialNumbers.join(", "):"",e.forEach(t.correctiveActions,function(e){var t=r.getMoment(e.when);e.when=t.isValid()?t.format("YYYY-MM-DD"):""}),!this.options.editMode){var i=h.faults.at(0);t.faultDescription=i?i.get("description")||i.get("name"):""}return t.okFile="",t.nokFile="","wh"===t.source?(t.orderNo="",t.productFamily="",t.location=t.line,t.line=null):"000000000"===t.orderNo&&(t.orderNo="",t.nc12="",t.productFamily="",t.productName=""),t},serializeForm:function(i){var n=this;return(i=e.assign(this.model.toJSON(),i)).standard||(i.standard=null),["inspector","nokOwner","leader"].forEach(function(e){var t=(n.$id(e)[0]||{selectedOptions:[]}).selectedOptions[0];t&&t.value?i[e]={id:t.value,label:t.label.trim()}:t&&(i[e]=null)}),i.line||(i.line=null),n.options.editMode&&(i.updater=s.getInfo()),n.$("textarea").each(function(){i[this.name]||(i[this.name]="")}),i.serialNumbers=this.parseSerialNumbers(i.serialNumbers),i.correctiveActions=[],n.$id("actions").children().each(function(){var s=r.getMoment(this.querySelector('[name$="when"]').value),n=this.querySelector('[name$="what"]').value.trim();""!==n&&i.correctiveActions.push({what:n,when:s.isValid()?s.toDate():null,who:e.map(t(this.querySelector('[name$="who"]')).select2("data"),function(e){return{id:e.id,label:e.text}}),status:this.querySelector('[name$="status"]').value})}),"wh"===i.source?(i.orderNo="000000000",i.productFamily="000000",i.line=i.location||null):i.orderNo||h.kinds.get(i.kind).get("order")||(i.orderNo="000000000",i.nc12="000000000000",i.productFamily="000000",i.productName="0"),i.mrp=n.$id("division").attr("data-orders-mrp")||"",i},afterRender:function(){c.prototype.afterRender.call(this);var t=this.model.get("correctiveActions");e.isEmpty(t)?this.addEmptyAction():e.forEach(this.model.get("correctiveActions"),this.addAction,this),this.setUpInspectorSelect2(),this.setUpMasterSelect2(),this.setUpLeaderSelect2(),a.toggle(this.$id("source")),a.toggle(this.$id("result")),this.toggleRoleFields(),this.toggleSourceFields(),this.toggleRequireOrder(),"wh"===this.getSource()?this.findComponent():this.findOrder()},getSource:function(){return this.options.editMode?this.model.get("source"):a.getValue(this.$id("source"))},setUpInspectorSelect2:function(){g||this.$id("inspector").removeClass("form-control").select2().closest(".form-group").addClass("has-required-select2")},setUpMasterSelect2:function(){g||this.$id("nokOwner").removeClass("form-control").select2({placeholder:" ",allowClear:!0})},setUpLeaderSelect2:function(){var t=this.serializeLeaders("prod"===this.getSource()?"leaders":"whman","leader"),i=this.$id("leader"),r=i.val(),s="<option></option>";null===r&&(r=this.model.get("leader"))&&(r=r.id),t.forEach(function(t){s+='<option value="'+t.id+'" '+(r===t.id?"selected":"")+">"+e.escape(t.text)}),i.html(s),g||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})},parseSerialNumbers:function(e){if(Array.isArray(e))return e;var t=this.$id("orderNo").val();return/^[0-9]{9}$/.test(t)||(t=""),(e||"").split(/(\s+|,|;)/).filter(function(e){return/^[a-zA-Z0-9.]+$/.test(e)}).map(function(e){if(/^[0-9]{1,4}$/.test(e)&&t){for(;e.length<4;)e="0"+e;return"PL04."+t+"."+e}return e.toUpperCase()})},toggleRoleFields:function(){var e=s.isAllowedTo("QI:RESULTS:MANAGE"),i=this.model.isInspector(),r=s.isAllowedTo("QI:SPECIALIST"),n=this.model.isNokOwner(),o=this.model.isLeader();this.$("[data-role]").each(function(){var s,a=this.dataset.role;s=!(!e&&a)||(i&&-1!==a.indexOf("inspector")||r&&-1!==a.indexOf("specialist")||n&&-1!==a.indexOf("nokOwner")||o&&-1!==a.indexOf("leader")),this.disabled=!s,g||"inspector"!==this.name&&"nokOwner"!==this.name||t(this).select2("enable",!this.disabled)}),this.$id("source").find(".btn").toggleClass("disabled",this.options.editMode||!e&&!i),this.$id("result").find(".btn").toggleClass("disabled",!e&&!i)},toggleSourceFields:function(){var e=this.getSource();if(this.$("[data-source]").each(function(){this.classList.toggle("hidden",this.dataset.source!==e)}),"wh"===e){var t=h.kinds.find(function(e){return"LD"===e.get("division")});t&&this.$id("kind").val(t.id).trigger("change")}},clearOrderFields:function(){this.$id("nc12").val("")[0].setCustomValidity(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val(""),this.$id("qtyOrder").val(""),this.model.set({nc12:"",productFamily:"",division:"",qtyOrder:""},{silent:!0}),this.updateLeaders([]),this.updateLines([])},findOrder:function(){var e=this,t=e.$id("orderNo");if(t.prop("disabled"))return this.updateLines([]),void this.updateLeaders([]);e.findOrderCount+=1,e.findOrderReq&&(e.findOrderReq.abort(),e.findOrderReq=null),t[0].setCustomValidity(t[0].required?e.t("FORM:ERROR:orderNo"):"");var i=e.$id("orderNo").val().replace(/[^0-9]+/g,"").replace(/^0+/,"");if(9===i.length){var r=e.ajax({method:"GET",url:"/qi/results;order",data:{no:i}});r.always(function(){e.findOrderReq=null,t[0].setCustomValidity(e.t("FORM:ERROR:orderNo"))}),r.done(function(i){e.$id("nc12").val(i.nc12),e.$id("productName").val(i.productName),e.$id("productFamily").val(i.productFamily),e.$id("division").val(i.division).attr("data-orders-division",i.division).attr("data-orders-mrp",i.mrp),e.$id("qtyOrder").val(i.quantity),e.updateLines(i.lines),e.updateLeaders(i.leaders),e.updateDivision(),t[0].setCustomValidity("")}),e.findOrderReq=r}},clearComponentFields:function(){this.$id("orderNo").val("")[0].setCustomValidity(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val(""),this.$id("qtyOrder").val(""),this.model.set({orderNo:"",productFamily:"",division:"",qtyOrder:""},{silent:!0}),this.updateLeaders([]),this.updateLines([])},findComponent:function(){var e=this,t=e.$id("nc12");if(t.prop("disabled"))return this.updateLines([]),void this.updateLeaders([]);e.findOrderCount+=1,e.findOrderReq&&(e.findOrderReq.abort(),e.findOrderReq=null),t[0].setCustomValidity(t[0].required?e.t("FORM:ERROR:nc12"):"");var i=e.$id("nc12").val().replace(/[^0-9]+/g,"").toUpperCase();if(12===i.length){var r=e.ajax({method:"GET",url:"/qi/results;component",data:{nc12:i.replace(/^0+/,"")}});r.always(function(){e.findOrderReq=null,t[0].setCustomValidity(e.t("FORM:ERROR:nc12"))}),r.done(function(i){e.$id("nc12").val(i.nc12),e.$id("productName").val(i.productName),e.$id("productFamily").val(""),e.$id("division").val("LD").attr("data-orders-division","").attr("data-orders-mrp",""),e.$id("qtyOrder").val(""),t[0].setCustomValidity("")}),e.findOrderReq=r}},addEmptyAction:function(){this.addAction({status:"new",when:"",who:[],what:""})},addAction:function(t){this.statuses||(this.statuses=h.actionStatuses.map(d));var i=this.$id("actions");t.i=this.actions++,t.no=i.children().length+1;var r=s.isAllowedTo("QI:RESULTS:MANAGE","QI:SPECIALIST"),n=this.model.isNokOwner(),o=this.model.isLeader(),a=s.isAllowedTo("FN:master","FN:leader"),l=e.some(t.who,function(e){return e.id===s.data._id});i.append(f({statuses:this.statuses,action:t,canChangeStatus:r,canChangeWhen:r||n||o||l||a,canChangeWho:r||n||a,canChangeWhat:r||n||o||l||a,canRemove:r||n&&"new"===t.status})),u(i.children().last().find('[name$="who"]'),{width:"300px",allowClear:!0,multiple:!0,textFormatter:function(e,t){return t}}).select2("data",t.who.map(function(e){return{id:e.id,text:e.label}}))},recountActions:function(){this.$id("actions").children().each(function(e){this.firstElementChild.textContent=e+1})},updateDivision:function(){var e=h.kinds.get(this.$id("kind").val());if(e){var t=this.$id("division"),i=t.attr("data-orders-division"),r=e.get("division");t.val(r||i)}},toggleRequireOrder:function(){"wh"===this.getSource()?this.toggleRequireComponent():this.toggleRequireOrderNo()},toggleRequireOrderNo:function(){var e=h.kinds.get(this.$id("kind").val()),t=this.$id("orderGroup"),i=this.$id("orderNo"),r=!i.prop("disabled")&&!!e&&!!e.get("order");l(i).toggleClass("is-required",r),r||""!==i.val().trim()||i[0].setCustomValidity(""),t.find("input").prop("required",r)},toggleRequireComponent:function(){var e=this.$id("orderNo"),t=this.$id("nc12"),i=!e.prop("disabled");l(t).toggleClass("is-required",i),t.prop("readonly",!i),""===t.val().trim()&&t[0].setCustomValidity(""),this.$id("orderGroup").find("input").prop("required",i),e.prop("required",!1),this.$id("productFamily").prop("required",!1)},updateLines:function(t){var i=this.$id("line"),r=[],s={},o=this.model.get("line");g||r.push({id:"",text:""}),t.forEach(function(e){r.push({id:e,text:e}),s[e]=1}),t.length&&r.push({id:"",text:"",disabled:!0}),r=r.concat(n.getAllByType("prodLine").filter(function(e){return!(s[e.id]||e.get("deactivatedAt")&&e.id!==o)}).map(function(e){return{id:e.id,text:e.id}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})})),i.html(r.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?i.val(o||""):i.val(o||(t.length?t[0]:"")),g||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})},updateLeaders:function(t){var i=this.getSource(),r=h["wh"===i?"whman":"leaders"],s=this.$id("leader"),n=[],o={},a=this.model.get("leader");g||n.push({id:"",text:""}),t.forEach(function(e){var t,i=r.get(e.id);if(i)t=i.getLabel();else{var s=e.label.replace(/ \(.*?$/,"").split(" "),a=s.shift();t=s.join(" ")+" "+a}n.push({id:e.id,text:t}),o[e.id]=1}),t.length&&n.push({id:"",text:"",disabled:!0}),!a||o[a.id]||r.get(a.id)||n.push({id:a.id,text:a.label}),r.forEach(function(e){o[e.id]||n.push({id:e.id,text:e.getLabel()})}),s.html(n.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?s.val(a?a.id:""):s.val(a?a.id:t.length?t[0].id:""),g||s.removeClass("form-control").select2({placeholder:" ",allowClear:!0})}})});