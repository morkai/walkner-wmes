define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/data/orgUnits","app/data/localStorage","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/util/getInputLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","app/suggestions/Suggestion","app/suggestions/views/SuggestionFormView","app/qiResults/dictionaries","../QiResult","app/qiResults/templates/form","app/qiResults/templates/correctiveActionFormRow"],function(e,t,i,o,r,n,s,a,d,l,c,u,h,p,f,m,g,v,C,$){"use strict";var R=/Android/i.test(window.navigator.userAgent);return u.extend({template:C,events:e.assign({"change #-source":function(){a.setItem("WMES_QI_SOURCE",this.getSource()),this.setUpLeaderSelect2(),this.toggleSourceFields(),this.toggleRequireOrder(),this.toggleRequireInspector(),this.clearOrderFields(),this.clearComponentFields()},"input #-orderNo":function(){this.clearOrderFields(),this.scheduleFindOrder()},"input #-nc12":function(){this.clearComponentFields(),this.scheduleFindComponent()},"change #-faultCode":function(){var e=this.$id("faultCode").val(),t=g.faults.get(e),i=t?t.get("name").trim():e,o=t?t.get("description").trim():"";this.$id("faultDescription").val(i+(o?":\n"+o:""))},"change #-kind":function(){this.updateDivision(),this.toggleRequireOrder()},"change #-inspector":function(){this.toggleRequireInspector()},"change #-leader":function(){this.toggleRequireInspector()},"click #-addStdAction":"addStdAction",'click [name="removeAction"]':function(e){var t=this,i=t.$(e.target).closest("tr");i.fadeOut("fast",function(){i.remove(),t.recountActions()})},'change [name="removeFile[]"]':function(e){this.$('input[name="'+e.target.value+'File"]').prop("disabled",e.target.checked)},'change [name="ok"]':function(){this.model.set(e.assign(this.getFormData(),{ok:this.$id("ok").prop("checked")}),{silent:!0}),this.render()},"change #-serialNumbers":function(e){e.target.value=this.parseSerialNumbers(e.target.value).join(", ")},"input .qiResults-form-rootCause":function(e){var i=this.$(e.currentTarget).closest(".form-group"),o=i[0].dataset.i,r=i.find(".qiResults-form-rootCause");if(r.length>2){var n=r.length;r.each(function(){this!==e.target&&2!==n&&""===this.value.trim()&&(n-=1,t(this).remove())})}var s=i.find(".qiResults-form-rootCause").last();""!==s.val().trim()&&s.clone().attr("name","rootCause["+o+"]["+Date.now()+"]").val("").insertAfter(s),"0"===o&&i.find(".qiResults-form-rootCause").each(function(e){this.required=e<2})},"click #-rootCauses label":function(e){this.$(e.currentTarget).closest(".form-group").find(".qiResults-form-rootCause").first().focus()},"click #-addRootCause":function(){var e=this,i=e.$id("rootCauses"),o=i.find(".form-group").last().clone(),r=Date.now().toString();o.attr("data-i",r).find("input").each(function(e){e>1?t(this).remove():(this.value="",this.name="rootCause["+r+"]["+e+"]")}),i.append(o);var n=i.find(".form-group");i.find(".form-group").each(function(i){t(this).find("label").toggleClass("is-required",0===i).find("span").text(e.t("FORM:rootCause:label",{n:i+1,total:n.length})),i>0&&t(this).find("input").prop("required",!1)})},"click .qiResults-form-removeRootCause":function(e){var i=this;i.$(e.currentTarget).closest(".form-group").fadeOut("fast",function(){t(this).remove();var e=i.$id("rootCauses").find("label");e.each(function(o){t(this).find("span").text(i.t("FORM:rootCause:label",{n:o+1,total:e.length}))})})},'input textarea[name$=".what"]':function(e){this.resizeTextArea(e.target)},"keydown #-kzActionRid":function(e){if("Enter"===e.key)return this.$id("linkKzAction").click(),!1},"input #-kzActionRid":function(){this.$id("kzActionRid")[0].setCustomValidity("")},"click #-linkKzAction":"linkKzAction","click #-addKzAction":"addKzAction"},u.prototype.events),initialize:function(){u.prototype.initialize.apply(this,arguments),this.scheduleFindOrder=e.debounce(this.findOrder.bind(this),250),this.scheduleFindComponent=e.debounce(this.findComponent.bind(this),250),this.findOrderCount=0,this.findOrderReq=null,this.statuses=null,this.actions=0,this.listenToOnce(this,"beforeRender",function(){if(!this.model.get("errorCategory")){var e=g.settings.getValue("defaultErrorCategory"),t=g.errorCategories.get(e);t&&this.model.set({errorCategory:t.id},{silent:!0})}})},destroy:function(){u.prototype.destroy.apply(this,arguments),p.loaded&&p.unload()},serializeModel:function(){var e=this.model.toJSON();return Array.isArray(e.rootCause)||(e.rootCause=[]),e.rootCause.length||e.rootCause.push([]),e},getTemplateData:function(){var e=this.model.get("faultCode");return{inspectedAtMin:o.getMoment(this.model.get("inspectedAt")).clone().subtract(14,"days").format("YYYY-MM-DD"),inspectedAtMax:o.getMoment().startOf("day").add(1,"days").format("YYYY-MM-DD"),kinds:g.kinds.map(l),faults:g.faults.filter(function(t){return t.id===e||!1!==t.get("active")}).map(function(e){return{id:e.id,text:e.id+": "+e.get("name")}}),errorCategories:g.errorCategories.map(l),inspectors:this.serializeInspectors(),masters:this.serializeLeaders("masters","nokOwner"),divisions:s.getAllByType("division"),isAndroid:R,canEditAttachments:this.model.canEditAttachments(this.options.editMode),canEditActions:this.model.canEditActions(this.options.editMode),canAddActions:this.model.canAddActions(this.options.editMode)}},serializeInspectors:function(){var e={},t=[];g.inspectors.forEach(function(i){if(i.get("active")){var o=l(i);e[o.id]=!0,t.push(o)}});var i=this.model.get("inspector");return i&&!e[i.id]&&t.unshift({id:i.id,text:i.label}),t.sort(function(e,t){return e.text.localeCompare(t.text)})},serializeLeaders:function(e,t){var i={},o=[];g[e].forEach(function(e){if(e.get("active")){var t=l(e);i[t.id]=!0,o.push(t)}});var r=this.model.get(t);return r&&!i[r.id]&&o.unshift({id:r.id,text:r.label}),o.sort(function(e,t){return e.text.localeCompare(t.text)})},checkValidity:function(){return!0},submitRequest:function(t,o){var r=this,n=new FormData,s=0;if(this.$('input[type="file"]').each(function(){!this.disabled&&this.files.length&&(n.append(this.name,this.files[0]),++s)}),o.attachments={},e.forEach(o.removeFile,function(e){o.attachments[e+"File"]=null}),0===s)return u.prototype.submitRequest.call(r,t,o);var a=this.$el.find(".fa-spinner").removeClass("hidden"),d=this.ajax({type:"POST",url:"/qi/results;upload",data:n,processData:!1,contentType:!1});d.done(function(i){e.assign(o.attachments,i),u.prototype.submitRequest.call(r,t,o)}),d.fail(function(){r.showErrorMessage(i("qiResults","FORM:ERROR:upload")),t.attr("disabled",!1)}),d.always(function(){a.addClass("hidden")})},serializeToForm:function(){var t=this.model.toJSON();if(t.inspector=t.inspector?t.inspector.id:"",t.nokOwner=t.nokOwner?t.nokOwner.id:"",t.leader=t.leader?t.leader.id:"",t.coach=t.coach?t.coach.id:"",t.operator=t.operator?t.operator.id:"",t.inspectedAt=o.format(t.inspectedAt,"YYYY-MM-DD"),t.serialNumbers=t.serialNumbers?t.serialNumbers.join(", "):"",e.forEach(t.correctiveActions,function(e){var t=o.getMoment(e.when);e.when=t.isValid()?t.format("YYYY-MM-DD"):""}),!this.options.editMode){var i=g.faults.at(0);t.faultDescription=i?i.get("description")||i.get("name"):""}return t.okFile="",t.nokFile="","wh"===t.source?(t.orderNo="",t.productFamily="",t.location=t.line,t.line=null):"000000000"===t.orderNo&&(t.orderNo="",t.nc12="",t.productFamily="",t.productName=""),t},serializeForm:function(i){var n=this;return(i=e.assign(this.model.toJSON(),i)).standard||(i.standard=null),i.coach=h.getUserInfo(n.$id("coach")),i.operator=h.getUserInfo(n.$id("operator")),["inspector","nokOwner","leader"].forEach(function(e){var t=(n.$id(e)[0]||{selectedOptions:[]}).selectedOptions[0];t&&t.value?i[e]={id:t.value,label:t.label.trim()}:t&&(i[e]=null)}),i.line||(i.line=null),n.options.editMode&&(i.updater=r.getInfo()),n.$("textarea").each(function(){i[this.name]||(i[this.name]="")}),i.serialNumbers=this.parseSerialNumbers(i.serialNumbers),i.correctiveActions=[],n.$id("actions").children().each(function(){var e=o.getMoment(this.querySelector('[name$="when"]').value),r=this.querySelector('[name$="what"]').value.trim();if(""!==r){var n=this.querySelector('[name$="kind"]').value,s=+this.querySelector('[name$="rid"]').value;"std"!==n&&0===s||i.correctiveActions.push({kind:n,rid:s,what:r,when:e.isValid()?e.toDate():null,who:h.getUserInfo(t(this.querySelector('[name$="who"]'))),status:this.querySelector('[name$="status"]').value})}}),"wh"===i.source?(i.orderNo="000000000",i.productFamily="000000",i.line=i.location||null):i.orderNo||g.kinds.get(i.kind).get("order")||(i.orderNo="000000000",i.nc12="000000000000",i.productFamily="000000",i.productName="0"),i.mrp=n.$id("division").attr("data-orders-mrp")||"",i.rootCause=(i.rootCause||[]).map(function(e){return(e||[]).map(function(e){return e.trim()}).filter(function(e){return/[a-zA-Z]+/.test(e)})}).filter(function(e){return e.length>0}),i},afterRender:function(){u.prototype.afterRender.call(this),e.forEach(this.model.get("correctiveActions"),this.addAction,this),this.setUpInspectorSelect2(),this.setUpMasterSelect2(),this.setUpLeaderSelect2(),this.setUpCoachSelect2(),this.setUpOperatorSelect2(),d.toggle(this.$id("source")),d.toggle(this.$id("result")),this.toggleRoleFields(),this.toggleSourceFields(),this.toggleRequireOrder(),this.toggleRequireInspector(),"wh"===this.getSource()?this.findComponent():this.findOrder()},getSource:function(){return this.options.editMode?this.model.get("source"):d.getValue(this.$id("source"))},setUpInspectorSelect2:function(){R||this.$id("inspector").removeClass("form-control").select2({placeholder:" ",allowClear:!0}).closest(".form-group").addClass("has-required-select2")},setUpMasterSelect2:function(){R||this.$id("nokOwner").removeClass("form-control").select2({placeholder:" ",allowClear:!0})},setUpLeaderSelect2:function(){var t=this.serializeLeaders("prod"===this.getSource()?"leaders":"whman","leader"),i=this.$id("leader"),o=i.val(),r="<option></option>";null===o&&(o=this.model.get("leader"))&&(o=o.id),t.forEach(function(t){r+='<option value="'+t.id+'" '+(o===t.id?"selected":"")+">"+e.escape(t.text)}),i.html(r),R||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})},setUpCoachSelect2:function(){var e=this.$id("coach"),t=this.model.get("coach");h(e,{noPersonnelId:!0}),t&&e.select2("data",{id:t.id,text:t.label})},setUpOperatorSelect2:function(){var e=this.$id("operator"),t=this.model.get("operator");h(e,{noPersonnelId:!0}),t&&e.select2("data",{id:t.id,text:t.label})},parseSerialNumbers:function(e){if(Array.isArray(e))return e;var t=this.$id("orderNo").val();return/^[0-9]{9}$/.test(t)||(t=""),(e||"").split(/(\s+|,|;)/).filter(function(e){return/^[a-zA-Z0-9.]+$/.test(e)}).map(function(e){if(/^[0-9]{1,4}$/.test(e)&&t){for(;e.length<4;)e="0"+e;return"PL04."+t+"."+e}return e.toUpperCase()})},toggleRoleFields:function(){var e=r.isAllowedTo("QI:RESULTS:MANAGE"),i=r.isAllowedTo("QI:SPECIALIST"),o=this.model.isNokOwner(),n=this.model.isLeader(),s=this.model.isInspector()||n;this.$("[data-role]").each(function(){var r,a=this.dataset.role;r=!(!e&&a)||(s&&-1!==a.indexOf("inspector")||i&&-1!==a.indexOf("specialist")||o&&-1!==a.indexOf("nokOwner")||n&&-1!==a.indexOf("leader")),this.disabled=!r,R||"inspector"!==this.name&&"nokOwner"!==this.name||t(this).select2("enable",!this.disabled)}),this.$id("source").find(".btn").toggleClass("disabled",this.options.editMode||!e&&!s),this.$id("result").find(".btn").toggleClass("disabled",!e&&!s)},toggleSourceFields:function(){var e=this.getSource();if(this.$("[data-source]").each(function(){this.classList.toggle("hidden",this.dataset.source!==e)}),"wh"===e){var t=g.kinds.find(function(e){return"LD"===e.get("division")});t&&this.$id("kind").val(t.id).trigger("change")}},clearOrderFields:function(){this.$id("nc12").val("")[0].setCustomValidity(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val(""),this.$id("qtyOrder").val(""),this.model.set({nc12:"",productFamily:"",division:"",qtyOrder:""},{silent:!0}),this.updateLeaders([]),this.updateLines([])},findOrder:function(){var e=this,t=e.$id("orderNo");if(!t.length||t.prop("disabled"))return this.updateLines([]),void this.updateLeaders([]);e.findOrderCount+=1,e.findOrderReq&&(e.findOrderReq.abort(),e.findOrderReq=null),t[0].setCustomValidity(t[0].required?e.t("FORM:ERROR:orderNo"):"");var i=e.$id("orderNo").val().replace(/[^0-9]+/g,"").replace(/^0+/,"");if(9===i.length){e.$id("submit").prop("disabled",!0);var o=e.ajax({method:"GET",url:"/qi/results;order",data:{no:i}});o.always(function(){e.findOrderReq=null,t[0].setCustomValidity(e.t("FORM:ERROR:orderNo"))}),o.done(function(i){e.$id("nc12").val(i.nc12),e.$id("productName").val(i.productName),e.$id("productFamily").val(i.productFamily),e.$id("division").val(i.division).attr("data-orders-division",i.division).attr("data-orders-mrp",i.mrp),e.$id("qtyOrder").val(i.quantity),e.updateLines(i.lines),e.updateLeaders(i.leaders),e.updateDivision(),t[0].setCustomValidity(""),e.$id("submit").prop("disabled",!1)}),e.findOrderReq=o}},clearComponentFields:function(){this.$id("orderNo").val("")[0].setCustomValidity(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val(""),this.$id("qtyOrder").val(""),this.model.set({orderNo:"",productFamily:"",division:"",qtyOrder:""},{silent:!0}),this.updateLeaders([]),this.updateLines([])},findComponent:function(){var e=this,t=e.$id("nc12");if(t.prop("disabled"))return this.updateLines([]),void this.updateLeaders([]);e.findOrderCount+=1,e.findOrderReq&&(e.findOrderReq.abort(),e.findOrderReq=null),t[0].setCustomValidity(t[0].required?e.t("FORM:ERROR:nc12"):"");var i=e.$id("nc12").val().replace(/[^0-9]+/g,"").toUpperCase();if(12===i.length){var o=e.ajax({method:"GET",url:"/qi/results;component",data:{nc12:i.replace(/^0+/,"")}});o.always(function(){e.findOrderReq=null,t[0].setCustomValidity(e.t("FORM:ERROR:nc12"))}),o.done(function(i){e.$id("nc12").val(i.nc12),e.$id("productName").val(i.productName),e.$id("productFamily").val(""),e.$id("division").val("LD").attr("data-orders-division","").attr("data-orders-mrp",""),e.$id("qtyOrder").val(""),t[0].setCustomValidity("")}),e.findOrderReq=o}},addStdAction:function(){this.addAction({kind:"std",rid:0,status:"inProgress",when:"",who:[],what:""})},addAction:function(t){var i=this;i.statuses||(i.statuses=g.actionStatuses.map(function(e){return{id:e,text:i.t("actionStatus:"+e)}}));var o=i.$id("actions");t.i=i.actions++,t.no=o.children().length+1;var n="std"===t.kind,s=r.isAllowedTo("QI:RESULTS:MANAGE","QI:SPECIALIST"),a=i.model.isNokOwner(),d=i.model.isLeader(),l=r.isAllowedTo("FN:master","FN:leader"),c=e.some(t.who,function(e){return e.id===r.data._id}),u=i.renderPartial($,{statuses:i.statuses,action:t,canChangeStatus:n&&s,canChangeWhen:s||a||d||c||l,canChangeWho:n&&(s||a||l),canChangeWhat:s||a||d||c||l,canRemove:s});o.append(u),h(u.find('[name$="who"]'),{width:"350px",allowClear:!0,multiple:!0,textFormatter:function(e,t){return t}}).select2("data",t.who.map(function(e){return{id:e.id,text:e.label}})),i.resizeTextArea(u.find('[name$="what"]')[0])},recountActions:function(){this.$id("actions").children().each(function(e){this.firstElementChild.textContent=e+1})},updateDivision:function(){var e=g.kinds.get(this.$id("kind").val());if(e){var t=this.$id("division"),i=t.attr("data-orders-division"),o=e.get("division");t.val(o||i)}},toggleRequireInspector:function(){var e=this.$id("inspector"),t=this.$id("leader"),i="";e.val().length||t.val().length||(i=this.t("FORM:ERROR:inspector")),e[0].setCustomValidity(i)},toggleRequireOrder:function(){"wh"===this.getSource()?this.toggleRequireComponent():this.toggleRequireOrderNo()},toggleRequireOrderNo:function(){var e=g.kinds.get(this.$id("kind").val()),t=this.$id("orderGroup"),i=this.$id("orderNo"),o=!i.prop("disabled")&&!!e&&!!e.get("order");c(i).toggleClass("is-required",o),o||""!==i.val().trim()||i[0].setCustomValidity(""),t.find("input").prop("required",o)},toggleRequireComponent:function(){var e=this.$id("orderNo"),t=this.$id("nc12"),i=!e.prop("disabled");c(t).toggleClass("is-required",i),t.prop("readonly",!i),""===t.val().trim()&&t[0].setCustomValidity(""),this.$id("orderGroup").find("input").prop("required",i),e.prop("required",!1),this.$id("productFamily").prop("required",!1)},updateLines:function(t){var i=this.$id("line"),o=[],r={},n=this.model.get("line");R||o.push({id:"",text:""}),t.forEach(function(e){o.push({id:e,text:e}),r[e]=1}),t.length&&o.push({id:"",text:"",disabled:!0}),o=o.concat(s.getAllByType("prodLine").filter(function(e){return!(r[e.id]||e.get("deactivatedAt")&&e.id!==n)}).map(function(e){return{id:e.id,text:e.id}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})})),i.html(o.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?i.val(n||""):i.val(n||(t.length?t[0]:"")),R||i.removeClass("form-control").select2({placeholder:" ",allowClear:!0})},updateLeaders:function(t){var i=this.getSource(),o=g["wh"===i?"whman":"leaders"],r=this.$id("leader"),n=[],s={},a=this.model.get("leader");R||n.push({id:"",text:""}),t.forEach(function(e){var t,i=o.get(e.id);if(i)t=i.getLabel();else{var r=e.label.replace(/ \(.*?$/,"").split(" "),a=r.shift();t=r.join(" ")+" "+a}n.push({id:e.id,text:t}),s[e.id]=1}),t.length&&n.push({id:"",text:"",disabled:!0}),!a||s[a.id]||o.get(a.id)||n.push({id:a.id,text:a.label}),o.forEach(function(e){s[e.id]||n.push({id:e.id,text:e.getLabel()})}),r.html(n.map(function(t){return'<option value="'+t.id+'" '+(t.disabled?"disabled":"")+">"+e.escape(t.text)+"</option>"}).join("")),this.options.editMode&&1===this.findOrderCount?r.val(a?a.id:""):r.val(a?a.id:t.length?t[0].id:""),R||r.removeClass("form-control").select2({placeholder:" ",allowClear:!0})},resizeTextArea:function(e){if(e){var i=this.$id("textAreaGhost");i.length||(i=t('<div class="form-control"></div>').attr("id",this.idPrefix+"-textAreaGhost").css({position:"absolute",top:"0",left:"-9999px",whiteSpace:"pre-wrap",height:"auto"}).appendTo(this.el)),i[0].style.width=e.offsetWidth+"px",i[0].innerHTML=e.value.endsWith("\n")?e.value+"x":e.value,e.style.height=Math.min(114,Math.max(34,i[0].offsetHeight))+"px"}},linkKzAction:function(){var e=this,t=e.$id("kzActionRid");if(!t.prop("disabled")){if(!t[0].validity.valid)return t[0].reportValidity();var i=parseInt(t.val(),10);if(!(i>0))return t.select();if(e.$('input[name$=".rid"][value="'+i+'"]').length)t.val("").focus();else{n.msg.loading(),t.prop("disabled",!0);var o=e.ajax({url:"/suggestions/"+t.val()});o.fail(function(){if(404!==o.status)return n.msg.loadingFailed();n.msg.loaded(),t[0].setCustomValidity(e.t("correctiveActions:notFound")),setTimeout(function(){t[0].reportValidity()},1)}),o.done(function(i){t.val(""),n.msg.loaded(),e.addAction({kind:"kz",rid:i.rid,status:i.status,when:"",who:i.kaizenOwners,what:i.subject})}),o.always(function(){t.prop("disabled",!1)})}}},addKzAction:function(){var e=this,t=e.$id("addKzAction").prop("disabled",!0);function o(){var o=new f,r=new m({dialogClassName:"qiResults-form-suggestion-dialog",editMode:!1,model:o,formMethod:"POST",formAction:o.url(),formActionText:e.t("correctiveActions:add:kz:submit"),failureText:i("core","FORM:ERROR:addFailure"),panelTitleText:e.t("correctiveActions:add:kz:title"),handleSuccess:function(){n.closeDialog(),e.addAction({kind:"kz",rid:o.get("rid"),status:o.get("status"),when:"",who:o.get("kaizenOwners"),what:o.get("subject")})}});e.listenTo(r,"dialog:hidden",function(){t.prop("disabled",!1)}),n.showDialog(r)}p.loaded?o():(n.msg.loading(),p.load().done(function(){n.msg.loaded(),o()}).fail(function(){n.msg.loadingFailed(),t.prop("disabled",!1)}))}})});