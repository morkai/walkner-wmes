// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/data/orgUnits","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/qiResults/dictionaries","../QiResult","app/qiResults/templates/form","app/qiResults/templates/correctiveActionFormRow"],function(t,e,i,n,s,a,o,r,d,l,c,u,h,p){"use strict";return d.extend({template:h,events:t.extend({"input #-orderNo":function(){this.clearOrderFields(),this.scheduleFindOrder()},"change #-faultCode":function(){var t=c.faults.get(this.$id("faultCode").val());this.$id("faultDescription").val(t.get("description")||t.get("name"))},"change #-kind":"updateDivision","click #-addAction":"addEmptyAction",'click [name="removeAction"]':function(t){var e=this,i=e.$(t.target).closest("tr");i.fadeOut("fast",function(){i.remove(),e.recountActions()})},'change [name="removeFile[]"]':function(t){this.$('input[name="'+t.target.value+'File"]').prop("disabled",t.target.checked)},'change [name="ok"]':function(){this.model.set(t.extend(this.getFormData(),{ok:this.$id("ok").prop("checked")}),{silent:!0}),this.render()}},d.prototype.events),initialize:function(){d.prototype.initialize.apply(this,arguments),this.scheduleFindOrder=t.debounce(this.findOrder.bind(this),250),this.findOrderReq=null,this.statuses=null,this.actions=0},serialize:function(){return t.extend(d.prototype.serialize.call(this),{inspectedAtMin:"2014-01-01",inspectedAtMax:n.getMoment().startOf("day").add(1,"days").format("YYYY-MM-DD"),kinds:c.kinds.map(r),faults:c.faults.map(function(t){return{id:t.id,text:t.id+": "+t.get("name")}}),errorCategories:c.errorCategories.map(r),inspectors:this.serializeInspectors(),divisions:a.getAllByType("division")})},serializeInspectors:function(){var t={},e=[];c.inspectors.forEach(function(i){var n=r(i);t[n.id]=!0,e.push(n)});var i=this.model.get("inspector");return this.options.editMode&&!t[i.id]&&e.unshift({id:i.id,text:i.text}),e},checkValidity:function(){return!0},submitRequest:function(e,n){var s=this,a=new FormData,o=0;if(this.$('input[type="file"]').each(function(){!this.disabled&&this.files.length&&(a.append(this.name,this.files[0]),++o)}),n.attachments={},t.forEach(n.removeFile,function(t){n.attachments[t+"File"]=null}),0===o)return d.prototype.submitRequest.call(s,e,n);var r=this.$el.find(".fa-spinner").removeClass("hidden"),l=this.ajax({type:"POST",url:"/qi/results;upload",data:a,processData:!1,contentType:!1});l.done(function(i){t.extend(n.attachments,i),d.prototype.submitRequest.call(s,e,n)}),l.fail(function(){s.showErrorMessage(i("qiResults","FORM:ERROR:upload")),e.attr("disabled",!1)}),l.always(function(){r.addClass("hidden")})},serializeToForm:function(){var e=this.model.toJSON();if(e.inspector=e.inspector?e.inspector.id:"",e.inspectedAt=n.format(e.inspectedAt,"YYYY-MM-DD"),t.forEach(e.correctiveActions,function(t){var e=n.getMoment(t.when);t.when=e.isValid()?e.format("YYYY-MM-DD"):""}),!this.options.editMode){var i=c.faults.at(0);e.faultDescription=i?i.get("description")||i.get("name"):""}return e.okFile="",e.nokFile="",e},serializeForm:function(e){var i=this.$id("inspector")[0].selectedOptions[0];e.inspector={id:i.value,label:i.label.trim()};var a=this.$id("nokOwner"),o=this.$id("nokOwner").select2("data");a.prop("disabled")||(o?e.nokOwner={id:o.id,label:o.text}:e.nokOwner=null),this.options.editMode&&(e.updater=s.getInfo()),this.$("textarea").each(function(){e[this.name]||(e[this.name]="")});var r=this.$id("actions").children();return e.correctiveActions=t.map(e.correctiveActions,function(e,i){var s=n.getMoment(e.when);return{what:e.what||"",when:s.isValid()?s.toDate():null,who:t.map(r.eq(i).find('input[name$="who"]').select2("data"),function(t){return{id:t.id,label:t.text}}),status:e.status}}).filter(function(t){return t.what.length>0}),e},afterRender:function(){d.prototype.afterRender.call(this);var e=this.model.get("correctiveActions");t.isEmpty(e)?this.addEmptyAction():t.forEach(this.model.get("correctiveActions"),this.addAction,this),this.setUpNokOwnerSelect2(),o.toggle(this.$id("result")),this.findOrder(),this.toggleRoleFields()},setUpNokOwnerSelect2:function(){l(this.$id("nokOwner"),{allowClear:!0,textFormatter:function(t,e){return e}})},toggleRoleFields:function(){var t=s.isAllowedTo("QI:RESULTS:MANAGE"),i=s.isAllowedTo("QI:INSPECTOR"),n=s.isAllowedTo("QI:SPECIALIST"),a=this.model.isNokOwner();this.$("[data-role]").each(function(){var s,o=this.dataset.role;s=t||!o?!0:i&&-1!==o.indexOf("inspector")||n&&-1!==o.indexOf("specialist")||a&&-1!==o.indexOf("nokOwner"),this.disabled=!s,"nokOwner"===this.name&&e(this).select2("enable",!this.disabled)})},clearOrderFields:function(){this.$id("nc12").val(""),this.$id("productName").val(""),this.$id("productFamily").val(""),this.$id("division").val(""),this.$id("qtyOrder").val("")},findOrder:function(){var t=this;t.findOrderReq&&(t.findOrderReq.abort(),t.findOrderReq=null);var e=t.$id("orderNo");e[0].setCustomValidity(i("qiResults","FORM:ERROR:orderNo"));var n=t.$id("orderNo").val().replace(/[^0-9]+/g,"");if(9===n.length){var s=t.ajax({method:"GET",url:"/qi/results;order",data:{no:n}});s.always(function(){t.findOrderReq=null}),s.done(function(i){t.$id("nc12").val(i.nc12),t.$id("productName").val(i.productName),t.$id("productFamily").val(i.productFamily),t.$id("division").val(i.division).attr("data-orders-division",i.division),t.$id("qtyOrder").val(i.quantity),e[0].setCustomValidity(""),t.updateDivision()}),t.findOrderReq=s}},addEmptyAction:function(){this.addAction({status:"",when:"",who:[],what:""})},addAction:function(t){this.statuses||(this.statuses=c.actionStatuses.map(r));var e=this.$id("actions");t.i=this.actions++,t.no=e.children().length+1,e.append(p({statuses:this.statuses,action:t}));var i=l(e.children().last().find('[name$="who"]'),{width:"300px",allowClear:!0,multiple:!0,textFormatter:function(t,e){return e}});i.select2("data",t.who.map(function(t){return{id:t.id,text:t.label}}))},recountActions:function(){this.$id("actions").children().each(function(t){this.firstElementChild.textContent=t+1})},updateDivision:function(){var t=c.kinds.get(this.$id("kind").val());if(t){var e=this.$id("division"),i=e.attr("data-orders-division"),n=t.get("division");e.val(n||i)}}})});