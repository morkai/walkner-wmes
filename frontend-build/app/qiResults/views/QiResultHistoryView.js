define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/qiResults/QiResult","app/qiResults/dictionaries","app/qiResults/templates/correctiveActionsTable","app/qiResults/templates/historyItem","app/qiResults/templates/history"],function(t,e,s,i,a,r,o,n,l,c,u,h,m){"use strict";return o.extend({template:m,events:{"submit form":function(){var t=this.$id("comment"),e=t.val().trim();if(""===e)return!1;var i=this.$id("submit").prop("disabled",!0),a=this.ajax({type:"PUT",url:"/qi/results/"+this.model.id,data:JSON.stringify({comment:e})});return a.done(function(){t.val("")}),a.fail(function(){r.msg.show({type:"error",time:3e3,text:s("qiResults","MSG:comment:failure")})}),a.always(function(){i.prop("disabled",!1)}),!1},"click .qiResults-history-correctiveActions":"toggleCorrectiveActions"},initialize:function(){this.lastChangeCount=0,this.$lastToggle=null,this.$lastTable=null},destroy:function(){this.$lastToggle&&(this.$lastTable.remove(),this.$lastTable=null,this.$lastToggle=null),this.$el.popover("destroy")},getTemplateData:function(){return{canEdit:this.model.canEdit(),editUrl:this.model.genClientUrl("edit"),items:this.serializeItems()}},serializeItems:function(){var t=(this.model.get("changes")||[]).map(this.serializeItem,this);return t.unshift(this.serializeItem({user:this.model.get("creator"),date:this.model.get("createdAt"),data:{},comment:this.t("history:added")},0)),t},serializeItem:function(e,a){return{seen:!0,time:i.toTagData(e.date),user:n({userInfo:e.user}),changes:t.map(e.data,function(t,e){return{label:s("qiResults","PROPERTY:"+e),oldValue:this.serializeItemValue(e,t[0],!0,a),newValue:this.serializeItemValue(e,t[1],!1,a)}},this),comment:e.comment.trim()}},serializeItemValue:function(e,a,r,o){if("ok"===e)return s("qiResults","ok:"+a);if("number"==typeof a)return a.toLocaleString();if(t.isEmpty(a))return"-";switch(e){case"inspectedAt":return i.format(a,"LL");case"inspector":case"nokOwner":case"leader":return n({userInfo:a});case"kind":case"errorCategory":case"faultCode":var l=c.forProperty(e).get(a);return l?l.getLabel():a;case"faultDescription":case"problem":case"immediateActions":case"immediateResults":case"rootCause":return a.length<=43?a:{more:a,toString:function(){return a.substr(0,40)+"..."}};case"okFile":case"nokFile":return'<a href="/qi/results/'+this.model.id+"/attachments/"+e+"?change="+(r?-o:o)+'">'+t.escape(a.name)+"</a>";case"correctiveActions":return'<a class="qiResults-history-correctiveActions" data-property="'+e+'"data-index="'+o+'" data-which="'+(r?"0":"1")+'">'+s("qiResults","history:correctiveActions",{count:a.length})+"</a>";case"serialNumbers":return a.join(", ");default:return a||""}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.lastChangeCount=(this.model.get("changes")||[]).length,this.listenTo(this.model,"change:changes",this.updateHistory),this.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",template:this.$el.popover.Constructor.DEFAULTS.template.replace('class="popover"','class="popover qiResults-history-popover"'),title:function(){return e(this).closest("tr").children().first().text()}}),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4))},updateHistory:function(){for(var t=this.model.get("changes"),s="",i=this.lastChangeCount;i<t.length;++i)s+=this.renderPartialHtml(h,{item:this.serializeItem(t[i],i)});e(s).insertAfter(this.$(".qiResults-history-item").last()).addClass("highlight"),this.lastChangeCount=t.length},updateTimes:function(){this.$(".qiResults-history-time").each(function(){var t=i.toTagData(this.getAttribute("datetime"));this.textContent=t.daysAgo>5?t.long:t.human})},toggleCorrectiveActions:function(t){var e=!1;if(this.$lastToggle&&(e=this.$lastToggle[0]===t.target,this.$lastTable.remove(),this.$lastTable=null,this.$lastToggle=null),!e){var s=t.target.dataset,i=this.$(t.target),a=i.closest("tr"),r=i.position(),o=r.top+i.outerHeight()+2,n=r.left,h=this.renderPartial(u,{bordered:!0,correctiveActions:l.serializeCorrectiveActions(c,this.model.get("changes")[s.index].data[s.property][s.which])});h.css({position:"absolute",top:o+"px",left:n+"px",width:Math.min(a.outerWidth()-n,900)+"px",background:"#FFF"}).appendTo("body"),this.$lastToggle=i,this.$lastTable=h}}})});