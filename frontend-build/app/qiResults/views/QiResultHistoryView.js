// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/qiResults/QiResult","app/qiResults/dictionaries","app/qiResults/templates/correctiveActionsTable","app/qiResults/templates/historyItem","app/qiResults/templates/history"],function(t,e,i,s,a,r,o,n,l,c,u,h,p){"use strict";return o.extend({template:p,events:{"submit form":function(){var t=this.$id("comment"),e=t.val().trim();if(""===e)return!1;var s=this.$id("submit").prop("disabled",!0),a=this.ajax({type:"PUT",url:"/qi/results/"+this.model.id,data:JSON.stringify({comment:e})});return a.done(function(){t.val("")}),a.fail(function(){r.msg.show({type:"error",time:3e3,text:i("qiResults","MSG:comment:failure")})}),a.always(function(){s.prop("disabled",!1)}),!1},"click .qiResults-history-correctiveActions":"toggleCorrectiveActions"},initialize:function(){this.lastChangeCount=0,this.$lastToggle=null,this.$lastTable=null},destroy:function(){this.$lastToggle&&(this.$lastTable.remove(),this.$lastTable=null,this.$lastToggle=null),this.$el.popover("destroy")},serialize:function(){return{idPrefix:this.idPrefix,canEdit:this.model.canEdit(),editUrl:this.model.genClientUrl("edit"),items:this.serializeItems()}},serializeItems:function(){var t=this.model.get("changes").map(this.serializeItem,this);return t.unshift(this.serializeItem({user:this.model.get("creator"),date:this.model.get("createdAt"),data:{},comment:i("qiResults","history:added")},0)),t},serializeItem:function(e,a){return{seen:!0,time:s.toTagData(e.date),user:n({userInfo:e.user}),changes:t.map(e.data,function(t,e){return{label:i("qiResults","PROPERTY:"+e),oldValue:this.serializeItemValue(e,t[0],!0,a),newValue:this.serializeItemValue(e,t[1],!1,a)}},this),comment:e.comment.trim()}},serializeItemValue:function(e,a,r,o){if("ok"===e)return i("qiResults","ok:"+a);if("number"==typeof a)return a.toLocaleString();if(t.isEmpty(a))return"-";switch(e){case"inspectedAt":return s.format(a,"LL");case"inspector":case"nokOwner":case"leader":return n({userInfo:a});case"kind":case"errorCategory":case"faultCode":var l=c.forProperty(e).get(a);return l?l.getLabel():a;case"faultDescription":case"problem":case"immediateActions":case"immediateResults":case"rootCause":return a.length<=43?a:{more:a,toString:function(){return a.substr(0,40)+"..."}};case"okFile":case"nokFile":return'<a href="/qi/results/'+this.model.id+"/attachments/"+e+"?change="+(r?-o:o)+'">'+t.escape(a.name)+"</a>";case"correctiveActions":return'<a class="qiResults-history-correctiveActions" data-property="'+e+'"data-index="'+o+'" data-which="'+(r?"0":"1")+'">'+i("qiResults","history:correctiveActions",{count:a.length})+"</a>";default:return a||""}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.lastChangeCount=this.model.get("changes").length,this.listenTo(this.model,"change:changes",this.updateHistory),this.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",template:this.$el.popover.Constructor.DEFAULTS.template.replace('class="popover"','class="popover qiResults-history-popover"'),title:function(){return e(this).closest("tr").children().first().text()}}),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4))},updateHistory:function(){for(var t=this.model.get("changes"),i="",s=this.lastChangeCount;s<t.length;++s)i+=h({item:this.serializeItem(t[s],s)});e(i).insertAfter(this.$(".qiResults-history-item").last()).addClass("highlight"),this.lastChangeCount=t.length},updateTimes:function(){this.$(".qiResults-history-time").each(function(){var t=s.toTagData(this.getAttribute("datetime"));this.textContent=t.daysAgo>5?t.long:t.human})},toggleCorrectiveActions:function(t){var i=!1;if(this.$lastToggle&&(i=this.$lastToggle[0]===t.target,this.$lastTable.remove(),this.$lastTable=null,this.$lastToggle=null),!i){var s=t.target.dataset,a=this.$(t.target),r=a.closest("tr"),o=a.position(),n=o.top+a.outerHeight()+2,h=o.left,p=e(u({bordered:!0,correctiveActions:l.serializeCorrectiveActions(c,this.model.get("changes")[s.index].data[s.property][s.which])}));p.css({position:"absolute",top:n+"px",left:h+"px",width:Math.min(r.outerWidth()-h,900)+"px",background:"#FFF"}).appendTo("body"),this.$lastToggle=a,this.$lastTable=p}}})});