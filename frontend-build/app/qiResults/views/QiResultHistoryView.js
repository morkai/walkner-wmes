define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/qiResults/QiResult","app/qiResults/dictionaries","app/qiResults/templates/correctiveActionsTable","app/qiResults/templates/historyItem","app/qiResults/templates/history"],function(t,e,i,s,a,r,o,n,l,c,h,u,p){"use strict";return o.extend({template:p,events:{"submit form":function(){var t=this,e=t.$id("comment"),i=e.val().trim();if(""===i)return!1;var s=t.$id("submit").prop("disabled",!0),a=t.ajax({type:"PUT",url:"/qi/results/"+t.model.id,data:JSON.stringify({comment:i})});return a.done(function(){e.val("")}),a.fail(function(){r.msg.show({type:"error",time:3e3,text:t.t("MSG:comment:failure")})}),a.always(function(){s.prop("disabled",!1)}),!1},"click .qiResults-history-correctiveActions":"toggleCorrectiveActions"},initialize:function(){this.lastChangeCount=0,this.$lastToggle=null,this.$lastTable=null},destroy:function(){this.$lastToggle&&(this.$lastTable.remove(),this.$lastTable=null,this.$lastToggle=null),this.$el.popover("destroy")},getTemplateData:function(){return{canEdit:this.model.canEdit(),editUrl:this.model.genClientUrl("edit"),items:this.serializeItems()}},serializeItems:function(){var t=(this.model.get("changes")||[]).map(this.serializeItem,this);return t.unshift(this.serializeItem({user:this.model.get("creator"),date:this.model.get("createdAt"),data:{},comment:this.t("history:added")},0)),t},serializeItem:function(e,i){return{seen:!0,time:s.toTagData(e.date),user:n({userInfo:e.user}),changes:t.map(e.data,function(t,e){return{label:this.t("PROPERTY:"+e),oldValue:this.serializeItemValue(e,t[0],!0,i),newValue:this.serializeItemValue(e,t[1],!1,i)}},this),comment:e.comment.trim()}},serializeItemValue:function(e,i,a,r){if("ok"===e)return this.t("ok:"+i);if("number"==typeof i)return i.toLocaleString();if(t.isEmpty(i))return"-";var o=null;switch("rootCause"===e&&(o="",i.forEach(function(e){o+="<ol>",e.forEach(function(e){o+="<li>"+t.escape(e)+"</li>"}),o+="</ol>"}),i=i[0].join("\n")),e){case"inspectedAt":return s.format(i,"LL");case"inspector":case"nokOwner":case"leader":case"coach":case"operator":return n({userInfo:i});case"kind":case"errorCategory":case"faultCode":case"standard":var l=c.forProperty(e).get(i);return l?l.getLabel():i;case"okFile":case"nokFile":return'<a href="/qi/results/'+this.model.id+"/attachments/"+e+"?change="+(a?-r:r)+'">'+t.escape(i.name)+"</a>";case"correctiveActions":return'<a class="qiResults-history-correctiveActions" data-property="'+e+'" data-index="'+r+'" data-which="'+(a?"0":"1")+'">'+this.t("history:correctiveActions",{count:i.length})+"</a>";case"serialNumbers":return i.join(", ");default:return i.length<=43?i:{more:o||i,toString:function(){return i.substr(0,40)+"..."}}}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.lastChangeCount=(this.model.get("changes")||[]).length,this.listenTo(this.model,"change:changes",this.updateHistory),this.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",html:!0,template:this.$el.popover.Constructor.DEFAULTS.template.replace('class="popover"','class="popover qiResults-history-popover"'),title:function(){return e(this).closest("tr").children().first().text()}}),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4))},updateHistory:function(){for(var t=this.model.get("changes"),i="",s=this.lastChangeCount;s<t.length;++s)i+=this.renderPartialHtml(u,{item:this.serializeItem(t[s],s)});e(i).insertAfter(this.$(".qiResults-history-item").last()).addClass("highlight"),this.lastChangeCount=t.length},updateTimes:function(){this.$(".qiResults-history-time").each(function(){var t=s.toTagData(this.getAttribute("datetime"));this.textContent=t.daysAgo>5?t.long:t.human})},toggleCorrectiveActions:function(t){var e=!1;if(this.$lastToggle&&(e=this.$lastToggle[0]===t.target,this.$lastTable.remove(),this.$lastTable=null,this.$lastToggle=null),!e){var i=t.target.dataset,s=this.$(t.target),a=s.closest("tr"),r=s.position(),o=r.top+s.outerHeight()+2,n=r.left,u=this.renderPartial(h,{bordered:!0,correctiveActions:l.serializeCorrectiveActions(c,this.model.get("changes")[i.index].data[i.property][i.which])});u.css({position:"absolute",top:o+"px",left:n+"px",width:Math.min(a.outerWidth()-n,900)+"px",background:"#FFF"}).appendTo("body"),this.$lastToggle=s,this.$lastTable=u}}})});