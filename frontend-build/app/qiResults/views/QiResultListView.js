// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/core/views/ListView","../dictionaries","app/qiResults/templates/correctiveActionsTable"],function(e,i,t,s,n,r){"use strict";return s.extend({className:"qiResults-list is-clickable is-colored",events:e.extend({"click .action-print":function(e){if(0===e.button){var i=e.currentTarget.href,t=window.open(i);return t?(t.onload=t.print.bind(t),!1):void(window.location.href=i)}}},s.prototype.events),destroy:function(){this.$el.popover("destroy")},serializeColumns:function(){var e=[{id:"rid",tdClassName:"is-min is-number"},{id:"orderNo",tdClassName:"is-min is-number"},{id:"nc12",tdClassName:"is-min is-number"},{id:"productFamily",tdClassName:"is-min"},"productName",{id:"division",tdClassName:"is-min",label:i("qiResults","LIST:COLUMN:division")},"kind",{id:"inspectedAt",tdClassName:"is-min"},"inspector",{id:"qtyOrder",tdClassName:"is-min is-number",label:i("qiResults","LIST:COLUMN:qtyOrder")},{id:"qtyInspected",tdClassName:"is-min is-number",label:i("qiResults","LIST:COLUMN:qtyInspected")}];return this.collection.hasAnyNokResult()&&e.push({id:"qtyToFix",tdClassName:"is-min is-number",label:i("qiResults","LIST:COLUMN:qtyToFix")},{id:"qtyNok",tdClassName:"is-min is-number",label:i("qiResults","LIST:COLUMN:qtyNok")},{id:"errorCategory",tdClassName:"is-min"},{id:"faultCode",tdClassName:"is-min"},{id:"correctiveAction",label:i("qiResults","PROPERTY:correctiveActions"),noData:""}),e},serializeRows:function(){var e={dateFormat:"L",today:t.getMoment().startOf("day").hours(6).valueOf()};return this.collection.map(function(i){return i.serializeRow(n,e)})},serializeActions:function(){var e=this.collection;return function(t){var n=e.get(t._id),r=[s.actions.viewDetails(n)],o=n.url()+".pdf";return r.push({id:"print",icon:"print",label:i(n.getNlsDomain(),"PAGE_ACTION:print"),href:o,className:n.get("ok")?"disabled":""}),n.canEdit()&&r.push(s.actions.edit(n)),n.canDelete()&&r.push(s.actions.delete(n)),r}},afterRender:function(){s.prototype.afterRender.call(this);var e=this;this.$el.popover({selector:".list-item > td",container:this.el,trigger:"hover",placement:"auto left",html:!0,content:function(){var i=e.$el.data("bs.popover").tip().removeClass("is-correctiveAction"),t=e.collection.get(this.parentNode.dataset.id);if("faultCode"===this.dataset.id)return t.get("faultDescription");if("correctiveAction"===this.dataset.id){var s=t.get("correctiveActions");if(s&&s.length)return i.addClass("is-correctiveAction"),r({bordered:!1,correctiveActions:t.serializeCorrectiveActions(n)})}}}).on("shown.bs.popover",function(i){e.$el.find(".popover").toggleClass("is-correctiveAction","correctiveAction"===i.target.dataset.id)})}})});