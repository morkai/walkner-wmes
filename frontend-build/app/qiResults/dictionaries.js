// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../broker","../pubsub","../user","../users/UserCollection","../data/createSettings","./QiSettingCollection","../qiKinds/QiKindCollection","../qiErrorCategories/QiErrorCategoryCollection","../qiFaults/QiFaultCollection","../qiActionStatuses/QiActionStatusCollection"],function(e,t,r,n,i,u,o,s,l,a,c,d){"use strict";function f(e){h.forEach(function(t){x[t].reset(e?e[t]:[])}),x.settings.reset(e?e.settings:[]),x.inspectors.reset(e?e.inspectors:[]),x.productFamilies=e?e.productFamilies:[],x.counter=e&&e.counter||{actual:0,required:0},b()}function g(e){"qi.requiredCount"===e.id&&(x.counter.required=x.settings.getValue("requiredCount")||0,b())}function q(e){e.user===i.data._id&&(x.counter.actual=e.count,b())}function b(){var r=t(".qi-counter");if(r.length){var n=x.counter;r.toggleClass("success",n.actual>=n.required).toggleClass("hidden",!n.required||!e.includes(i.data.privileges,"QI:INSPECTOR")),r.find(".qi-counter-actual").text(n.actual),r.find(".qi-counter-required").text(n.required)}}function C(){w=null,null!==Q&&(Q.destroy(),Q=null),null!==k&&(k.destroy(),k=null),x.loaded=!1,f(),E.release()}function p(e,t){var n=t.split("."),i=x[n[1]];if(i){switch(n[2]){case"added":i.add(e.model);break;case"edited":var u=i.get(e.model._id);u&&u.set(e.model);break;case"deleted":i.remove(i.get(e.model._id))}r.publish(t,e)}}function m(){x.inspectors.fetch()}function y(){S=t.ajax({url:"/qi/dictionaries"}),S.done(function(e){x.loaded=!0,f(e)}),S.fail(C),S.always(function(){S=null})}var h=["kinds","errorCategories","faults","actionStatuses"],v={kind:"kinds",errorCategory:"errorCategories",fault:"faults",actionStatus:"actionStatuses"},S=null,w=null,k=null,Q=null,E=o(s),x={inspectors:new u(null,{rqlQuery:"select(firstName,lastName,login)&privileges=QI%3AINSPECTOR"}),productFamilies:[],settings:E.acquire(),counter:{actual:0,required:0},kinds:new l,errorCategories:new a,faults:new c,actionStatuses:new d,loaded:!1,load:function(){return null!==w&&(clearTimeout(w),w=null),x.loaded?null:null!==S?S:(y(),Q=r.sandbox(),Q.subscribe("socket.connected",y),Q.subscribe("viewport.page.shown",b),k=n.sandbox(),h.forEach(function(e){k.subscribe("qi."+e+".**",p)}),k.subscribe("users.*",m),k.subscribe("qi.counter.recounted",q),x.settings.on("change",g),S)},unload:function(){null!==w&&clearTimeout(w),w=setTimeout(C,3e4)},getLabel:function(e,t){if("string"==typeof e&&(e=this.forProperty(e)||x[e]),!e||Array.isArray(e))return t;var r=e.get(t);return r?r.getLabel():t},forProperty:function(e){return this[v[e]]||null}};return x});