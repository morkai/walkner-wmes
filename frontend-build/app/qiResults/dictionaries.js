define(["underscore","jquery","../broker","../pubsub","../user","../users/UserCollection","../data/createSettings","./QiSettingCollection","../qiKinds/QiKindCollection","../qiErrorCategories/QiErrorCategoryCollection","../qiFaults/QiFaultCollection","../qiActionStatuses/QiActionStatusCollection"],function(e,t,r,n,i,s,a,l,u,o,c,d){"use strict";var f=["kinds","errorCategories","faults","actionStatuses"],g={kind:"kinds",errorCategory:"errorCategories",faultCode:"faults",actionStatus:"actionStatuses"},m=null,q=null,p=null,b=null,h=a(l),C={inspectors:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&privileges=QI%3AINSPECTOR"}),masters:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&prodFunction=master"}),leaders:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&prodFunction=in=(leader,prod_whman)"}),whman:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&prodFunction=regex=whman"}),productFamilies:[],settings:h.acquire(),counter:{actual:0,required:0},kinds:new u,errorCategories:new o,faults:new c,actionStatuses:new d,loaded:!1,load:function(){return null!==q&&(clearTimeout(q),q=null),C.loaded?null:null!==m?m:(F(),(b=r.sandbox()).subscribe("socket.connected",F),b.subscribe("viewport.page.shown",Q),p=n.sandbox(),f.forEach(function(e){p.subscribe("qi."+e+".**",S)}),p.subscribe("users.*",k),p.subscribe("qi.counter.recounted",v),C.settings.on("change",y),m)},unload:function(){null!==q&&clearTimeout(q),q=setTimeout(N,3e4)},getLabel:function(e,t){if("string"==typeof e&&(e=this.forProperty(e)||C[e]),!e||Array.isArray(e))return t;var r=e.get(t);return r?r.getLabel():t},forProperty:function(e){return this[g[e]]||null}};function w(e){f.forEach(function(t){C[t].reset(e?e[t]:[])}),C.settings.reset(e?e.settings:[]),C.inspectors.reset(e?e.inspectors:[]),C.masters.reset(e?e.masters:[]),C.leaders.reset(e?e.leaders:[]),C.whman.reset(e?e.whman:[]),C.productFamilies=e?e.productFamilies:[],C.counter=e&&e.counter||{actual:0,required:0},Q()}function y(e){"qi.requiredCount"===e.id&&(C.counter.required=C.settings.getValue("requiredCount")||0,Q())}function v(e){e.user===i.data._id&&(C.counter.actual=e.count,Q())}function Q(){var r=t(".qi-counter");if(r.length){var n=C.counter;r.toggleClass("success",n.actual>=n.required).toggleClass("hidden",!n.required||!e.includes(i.data.privileges,"QI:INSPECTOR")),r.find(".qi-counter-actual").text(n.actual),r.find(".qi-counter-required").text(n.required)}}function N(){q=null,null!==b&&(b.destroy(),b=null),null!==p&&(p.destroy(),p=null),C.loaded=!1,w(),h.release()}function S(e,t){var n=t.split("."),i=C[n[1]];if(i){switch(n[2]){case"added":i.add(e.model);break;case"edited":var s=i.get(e.model._id);s&&s.set(e.model);break;case"deleted":i.remove(i.get(e.model._id))}r.publish(t,e)}}function k(){C.inspectors.fetch(),C.masters.fetch(),C.leaders.fetch(),C.whman.fetch()}function F(){(m=t.ajax({url:"/qi/dictionaries"})).done(function(e){C.loaded=!0,w(e)}),m.fail(N),m.always(function(){m=null})}return C});