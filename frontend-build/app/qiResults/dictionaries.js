define(["underscore","jquery","../broker","../pubsub","../user","../users/UserCollection","../data/createSettings","./QiSettingCollection","../qiKinds/QiKindCollection","../qiErrorCategories/QiErrorCategoryCollection","../qiFaults/QiFaultCollection","../qiStandards/QiStandardCollection","../qiActionStatuses/QiActionStatusCollection"],function(e,t,n,r,i,s,a,o,l,u,c,d,f){"use strict";var g=["kinds","errorCategories","faults","standards","actionStatuses"],m={kind:"kinds",errorCategory:"errorCategories",faultCode:"faults",standard:"standards",actionStatus:"actionStatuses"},q=null,b=null,h=null,p=null,C=a(o),w={inspectors:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&privileges=QI%3AINSPECTOR"}),masters:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&prodFunction=master"}),leaders:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&prodFunction=in=(leader,prod_whman)"}),whman:new s(null,{rqlQuery:"select(firstName,lastName,login,active)&prodFunction=regex=whman"}),productFamilies:[],settings:C.acquire(),counter:{actual:0,required:0},kinds:new l,errorCategories:new u,faults:new c,standards:new d,actionStatuses:new f,loaded:!1,load:function(){return null!==b&&(clearTimeout(b),b=null),w.loaded?null:null!==q?q:(x(),(p=n.sandbox()).subscribe("socket.connected",x),p.subscribe("viewport.page.shown",S),h=r.sandbox(),g.forEach(function(e){h.subscribe("qi."+e+".**",k)}),h.subscribe("users.*",F),h.subscribe("qi.counter.recounted",Q),w.settings.on("change",y),q)},unload:function(){null!==b&&clearTimeout(b),b=setTimeout(N,3e4)},getLabel:function(e,t){if("string"==typeof e&&(e=this.forProperty(e)||w[e]),!e||Array.isArray(e))return t;var n=e.get(t);return n?n.getLabel():t},forProperty:function(e){return this[m[e]]||null},bind:function(e){var t=this;return e.on("beforeLoad",function(e,n){n.push(t.load())}),e.on("afterRender",t.load.bind(t)),e.once("remove",t.unload.bind(t)),e}};function v(e){g.forEach(function(t){w[t].reset(e?e[t]:[])}),w.settings.reset(e?e.settings:[]),w.inspectors.reset(e?e.inspectors:[]),w.masters.reset(e?e.masters:[]),w.leaders.reset(e?e.leaders:[]),w.whman.reset(e?e.whman:[]),w.productFamilies=e?e.productFamilies:[],w.counter=e&&e.counter||{actual:0,required:0},S()}function y(e){"qi.requiredCount"===e.id&&(w.counter.required=w.settings.getValue("requiredCount")||0,S())}function Q(e){e.user===i.data._id&&(w.counter.actual=e.count,S())}function S(){var n=t(".qi-counter");if(n.length){var r=w.counter;n.toggleClass("success",r.actual>=r.required).toggleClass("hidden",!r.required||!e.includes(i.data.privileges,"QI:INSPECTOR")),n.find(".qi-counter-actual").text(r.actual),n.find(".qi-counter-required").text(r.required)}}function N(){b=null,null!==p&&(p.destroy(),p=null),null!==h&&(h.destroy(),h=null),w.loaded=!1,v(),C.release()}function k(e,t){var r=t.split("."),i=w[r[1]];if(i){switch(r[2]){case"added":i.add(e.model);break;case"edited":var s=i.get(e.model._id);s&&s.set(e.model);break;case"deleted":i.remove(i.get(e.model._id))}n.publish(t,e)}}function F(){w.inspectors.fetch(),w.masters.fetch(),w.leaders.fetch(),w.whman.fetch()}function x(){(q=t.ajax({url:"/qi/dictionaries"})).done(function(e){w.loaded=!0,v(e)}),q.fail(N),q.always(function(){q=null})}return w});