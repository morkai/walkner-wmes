// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../broker","../pubsub","../user","../users/UserCollection","../data/createSettings","./QiSettingCollection","../qiKinds/QiKindCollection","../qiErrorCategories/QiErrorCategoryCollection","../qiFaults/QiFaultCollection","../qiActionStatuses/QiActionStatusCollection"],function(e,t,r,n,i,s,u,l,o,a,c,d){"use strict";function f(e){h.forEach(function(t){F[t].reset(e?e[t]:[])}),F.settings.reset(e?e.settings:[]),F.inspectors.reset(e?e.inspectors:[]),F.masters.reset(e?e.masters:[]),F.leaders.reset(e?e.leaders:[]),F.productFamilies=e?e.productFamilies:[],F.counter=e&&e.counter||{actual:0,required:0},m()}function g(e){"qi.requiredCount"===e.id&&(F.counter.required=F.settings.getValue("requiredCount")||0,m())}function q(e){e.user===i.data._id&&(F.counter.actual=e.count,m())}function m(){var r=t(".qi-counter");if(r.length){var n=F.counter;r.toggleClass("success",n.actual>=n.required).toggleClass("hidden",!n.required||!e.includes(i.data.privileges,"QI:INSPECTOR")),r.find(".qi-counter-actual").text(n.actual),r.find(".qi-counter-required").text(n.required)}}function b(){Q=null,null!==k&&(k.destroy(),k=null),null!==S&&(S.destroy(),S=null),F.loaded=!1,f(),N.release()}function p(e,t){var n=t.split("."),i=F[n[1]];if(i){switch(n[2]){case"added":i.add(e.model);break;case"edited":var s=i.get(e.model._id);s&&s.set(e.model);break;case"deleted":i.remove(i.get(e.model._id))}r.publish(t,e)}}function C(){F.inspectors.fetch(),F.masters.fetch(),F.leaders.fetch()}function y(){v=t.ajax({url:"/qi/dictionaries"}),v.done(function(e){F.loaded=!0,f(e)}),v.fail(b),v.always(function(){v=null})}var h=["kinds","errorCategories","faults","actionStatuses"],w={kind:"kinds",errorCategory:"errorCategories",faultCode:"faults",actionStatus:"actionStatuses"},v=null,Q=null,S=null,k=null,N=u(l),F={inspectors:new s(null,{rqlQuery:"select(firstName,lastName,login)&privileges=QI%3AINSPECTOR"}),masters:new s(null,{rqlQuery:"select(firstName,lastName,login)&prodFunction=master"}),leaders:new s(null,{rqlQuery:"select(firstName,lastName,login)&prodFunction=leader"}),productFamilies:[],settings:N.acquire(),counter:{actual:0,required:0},kinds:new o,errorCategories:new a,faults:new c,actionStatuses:new d,loaded:!1,load:function(){return null!==Q&&(clearTimeout(Q),Q=null),F.loaded?null:null!==v?v:(y(),k=r.sandbox(),k.subscribe("socket.connected",y),k.subscribe("viewport.page.shown",m),S=n.sandbox(),h.forEach(function(e){S.subscribe("qi."+e+".**",p)}),S.subscribe("users.*",C),S.subscribe("qi.counter.recounted",q),F.settings.on("change",g),v)},unload:function(){null!==Q&&clearTimeout(Q),Q=setTimeout(b,3e4)},getLabel:function(e,t){if("string"==typeof e&&(e=this.forProperty(e)||F[e]),!e||Array.isArray(e))return t;var r=e.get(t);return r?r.getLabel():t},forProperty:function(e){return this[w[e]]||null}};return F});