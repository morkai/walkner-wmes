// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../broker","../pubsub","../user","../users/UserCollection","../data/createSettings","./QiSettingCollection","../qiKinds/QiKindCollection","../qiErrorCategories/QiErrorCategoryCollection","../qiFaults/QiFaultCollection","../qiActionStatuses/QiActionStatusCollection"],function(e,t,r,n,i,s,u,o,l,a,c,d){"use strict";function f(e){h.forEach(function(t){F[t].reset(e?e[t]:[])}),F.settings.reset(e?e.settings:[]),F.inspectors.reset(e?e.inspectors:[]),F.masters.reset(e?e.masters:[]),F.productFamilies=e?e.productFamilies:[],F.counter=e&&e.counter||{actual:0,required:0},b()}function g(e){"qi.requiredCount"===e.id&&(F.counter.required=F.settings.getValue("requiredCount")||0,b())}function q(e){e.user===i.data._id&&(F.counter.actual=e.count,b())}function b(){var r=t(".qi-counter");if(r.length){var n=F.counter;r.toggleClass("success",n.actual>=n.required).toggleClass("hidden",!n.required||!e.includes(i.data.privileges,"QI:INSPECTOR")),r.find(".qi-counter-actual").text(n.actual),r.find(".qi-counter-required").text(n.required)}}function m(){S=null,null!==k&&(k.destroy(),k=null),null!==Q&&(Q.destroy(),Q=null),F.loaded=!1,f(),E.release()}function C(e,t){var n=t.split("."),i=F[n[1]];if(i){switch(n[2]){case"added":i.add(e.model);break;case"edited":var s=i.get(e.model._id);s&&s.set(e.model);break;case"deleted":i.remove(i.get(e.model._id))}r.publish(t,e)}}function p(){F.inspectors.fetch(),F.masters.fetch()}function y(){w=t.ajax({url:"/qi/dictionaries"}),w.done(function(e){F.loaded=!0,f(e)}),w.fail(m),w.always(function(){w=null})}var h=["kinds","errorCategories","faults","actionStatuses"],v={kind:"kinds",errorCategory:"errorCategories",faultCode:"faults",actionStatus:"actionStatuses"},w=null,S=null,Q=null,k=null,E=u(o),F={inspectors:new s(null,{rqlQuery:"select(firstName,lastName,login)&privileges=QI%3AINSPECTOR"}),masters:new s(null,{rqlQuery:"select(firstName,lastName,login)&prodFunction=master"}),productFamilies:[],settings:E.acquire(),counter:{actual:0,required:0},kinds:new l,errorCategories:new a,faults:new c,actionStatuses:new d,loaded:!1,load:function(){return null!==S&&(clearTimeout(S),S=null),F.loaded?null:null!==w?w:(y(),k=r.sandbox(),k.subscribe("socket.connected",y),k.subscribe("viewport.page.shown",b),Q=n.sandbox(),h.forEach(function(e){Q.subscribe("qi."+e+".**",C)}),Q.subscribe("users.*",p),Q.subscribe("qi.counter.recounted",q),F.settings.on("change",g),w)},unload:function(){null!==S&&clearTimeout(S),S=setTimeout(m,3e4)},getLabel:function(e,t){if("string"==typeof e&&(e=this.forProperty(e)||F[e]),!e||Array.isArray(e))return t;var r=e.get(t);return r?r.getLabel():t},forProperty:function(e){return this[v[e]]||null}};return F});