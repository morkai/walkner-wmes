// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../user","../i18n","../core/Model","app/core/templates/userInfo"],function(e,t,i,r,o,a){"use strict";function n(i,r){return e.map(r,function(e){return{status:i.getLabel("actionStatus",e.status),when:t.format(e.when,"LL"),who:e.who.map(function(e){return e.label}).join(", "),what:e.what}})}var s={"application/octet-stream":"file-archive-o","application/x-zip-compressed":"file-archive-o","application/x-7z-compressed":"file-archive-o","application/x-rar-compressed":"file-archive-o","application/pdf":"file-pdf-o","application/json":"file-text-o","application/msword":"file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"file-word-o","application/vnd.ms-excel":"file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"file-excel-o","application/vnd.ms-powerpoint":"file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"file-powerpoint-o"};return o.extend({urlRoot:"/qi/results",clientUrlRoot:"#qi/results",topicPrefix:"qi.results",privilegePrefix:"QI:RESULTS",nlsDomain:"qiResults",labelAttribute:"rid",canEdit:function(){if(i.isAllowedTo("QI:RESULTS:MANAGE"))return!0;var e=this.attributes,t=Date.parse(e.updatedAt||e.createdAt);return Date.now()-t>12096e5?!1:!e.ok&&i.isAllowedTo("QI:SPECIALIST")?!0:e.creator&&e.creator.id===i.data._id?!0:e.inspector&&e.inspector.id===i.data._id?!0:!1},canDelete:function(){if(i.isAllowedTo("QI:RESULTS:MANAGE"))return!0;var e=this.attributes,t=Date.parse(e.updatedAt||e.createdAt);return Date.now()-t>864e5?!1:e.creator&&e.creator.id===i.data._id?!0:e.inspector&&e.inspector.id===i.data._id?!0:!1},isNokOwner:function(){return this.attributes.nokOwner&&this.attributes.nokOwner.id===i.data._id},serialize:function(e,i){var r=this.toJSON();return r.createdAt=t.format(r.createdAt,"LLLL"),r.creator=a({userInfo:r.creator}),r.updatedAt=t.format(r.updatedAt,"LLLL"),r.updater=a({userInfo:r.updater}),r.inspectedAt=t.format(r.inspectedAt,i.dateFormat||"L"),r.inspector=a({userInfo:r.inspector}),r.nokOwner=a({userInfo:r.nokOwner}),r.kind=e.getLabel("kind",r.kind),r.qtyOrder=r.qtyOrder?r.qtyOrder.toLocaleString():"0",r.qtyInspected=r.qtyInspected.toLocaleString(),r.ok?(r.errorCategory="",r.faultCode="",r.qtyToFix="",r.qtyNok="",r.qtyNokInspected=""):(r.errorCategory=e.getLabel("errorCategory",r.errorCategory),r.qtyToFix=r.qtyToFix.toLocaleString(),r.qtyNok=r.qtyNok.toLocaleString(),r.qtyNokInspected=r.qtyNokInspected>=0?r.qtyNokInspected.toLocaleString():"",r.correctiveActions=this.serializeCorrectiveActions(e)),r},serializeRow:function(e,i){var r=this.serialize(e,i);return r.className=r.ok?"success":"danger",!r.ok&&r.correctiveActions.length&&(r.correctiveAction=this.serializeBestCorrectiveAction(e,i&&i.today||t.getMoment().startOf("day").hours(6).valueOf())),r},serializeDetails:function(e){var t=this.serialize(e,{dateFormat:"LL"});return t.okFile=this.serializeFile(t.okFile),t.nokFile=this.serializeFile(t.nokFile),t},serializeCorrectiveActions:function(e){return n(e,this.get("correctiveActions"))},serializeBestCorrectiveAction:function(e,i){var r,o=this.get("correctiveActions");if(0===o.length)return"";if(1===o.length)r=o[0];else{var a=o.map(function(e){var t=Date.parse(e.when)-i;return{diff:0>t?Number.MAX_VALUE:t,action:e}}).sort(function(e,t){return e.diff-t.diff});for(r=a[0].action;a.length;){var n=a.shift().action;if("finished"!==n.status){r=n;break}}}var s=e.getLabel("actionStatus",r.status);return r.when&&(s+=", "+t.format(r.when,"L")),o.length>1&&(s+=" +"+(o.length-1)),s},serializeFile:function(e){if(!e)return null;var t=e.type.split("/");switch(t[0]){case"image":case"video":case"audio":case"text":e.icon="file-"+t[0]+"-o";break;case"multipart":e.icon="file-archive-o";break;default:e.icon=s[e.type]||"file-o"}return e}},{serializeCorrectiveActions:n})});