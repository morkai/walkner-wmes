// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../user","../core/Model","app/core/templates/userInfo"],function(e,t,i,o,r){"use strict";var a={"application/octet-stream":"file-archive-o","application/x-zip-compressed":"file-archive-o","application/x-7z-compressed":"file-archive-o","application/x-rar-compressed":"file-archive-o","application/pdf":"file-pdf-o","application/json":"file-text-o","application/msword":"file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"file-word-o","application/vnd.ms-excel":"file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"file-excel-o","application/vnd.ms-powerpoint":"file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"file-powerpoint-o"};return o.extend({urlRoot:"/qi/results",clientUrlRoot:"#qi/results",topicPrefix:"qi.results",privilegePrefix:"QI:RESULTS",nlsDomain:"qiResults",labelAttribute:"rid",canEdit:function(){if(i.isAllowedTo("QI:RESULTS:MANAGE"))return!0;var e=this.attributes,t=Date.parse(e.updatedAt||e.createdAt);return Date.now()-t>12096e5?!1:!e.ok&&i.isAllowedTo("QI:SPECIALIST")?!0:e.creator&&e.creator.id===i.data._id?!0:e.inspector&&e.inspector.id===i.data._id?!0:!1},canDelete:function(){if(i.isAllowedTo("QI:RESULTS:MANAGE"))return!0;var e=this.attributes,t=Date.parse(e.updatedAt||e.createdAt);return Date.now()-t>864e5?!1:e.creator&&e.creator.id===i.data._id?!0:e.inspector&&e.inspector.id===i.data._id?!0:!1},serialize:function(e,i){var o=this.toJSON();return o.createdAt=t.format(o.createdAt,"LLLL"),o.creator=r({userInfo:o.creator}),o.updatedAt=t.format(o.updatedAt,"LLLL"),o.updater=r({userInfo:o.updater}),o.inspectedAt=t.format(o.inspectedAt,i.dateFormat||"YYYY-MM-DD"),o.inspector=r({userInfo:o.inspector}),o.kind=e.getLabel("kind",o.kind),o.qtyInspected=o.qtyInspected.toLocaleString(),o.ok?(o.errorCategory="",o.faultCode="",o.qtyToFix="",o.qtyNok=""):(o.errorCategory=e.getLabel("errorCategory",o.errorCategory),o.qtyToFix=o.qtyToFix.toLocaleString(),o.qtyNok=o.qtyNok.toLocaleString()),o},serializeRow:function(e){var t=this.serialize(e,{});return t.className=t.ok?"success":"danger",t},serializeDetails:function(e){var t=this.serialize(e,{dateFormat:"LL"});return t.correctiveActions=this.serializeCorrectiveActions(e),t.okFile=this.serializeFile(t.okFile),t.nokFile=this.serializeFile(t.nokFile),t},serializeCorrectiveActions:function(i){return e.map(this.get("correctiveActions"),function(e){return{status:i.getLabel("actionStatus",e.status),when:t.format(e.when,"LL"),who:e.who.map(function(e){return e.label}).join(", "),what:e.what}})},serializeFile:function(e){if(!e)return null;var t=e.type.split("/");switch(t[0]){case"image":case"video":case"audio":case"text":e.icon="file-"+t[0]+"-o";break;case"multipart":e.icon="file-archive-o";break;default:e.icon=a[e.type]||"file-o"}return e}})});