define(["underscore","../i18n","../time","../user","../core/Model","../core/Collection"],function(t,e,r,i,n,s){"use strict";var o=s.extend({url:"/qi/reports/outgoingQuality/results",rqlQuery:"rid=in=()",model:n.extend({nlsDomain:"qiResults",clientUrlRoot:"#qi/results"})});return n.extend({urlRoot:"/qi/reports/outgoingQuality",nlsDomain:"qiResults",defaults:function(){return{printable:!1,interval:"week",week:"",options:{},totals:{},top:{},groups:{}}},initialize:function(){this.results=t.assign(new o(null,{paginate:!1}),{report:this}),this.on("change:results",function(){var t=(this.get("results")||[]).map(function(t){return t.rid});this.results.rqlQuery.selector.args[0].args[1]=t,t.length?this.results.fetch({reset:!0}):this.results.reset([])})},fetch:function(e){return t.isObject(e)||(e={}),e.data=t.assign(e.data||{},t.pick(this.attributes,["week"])),n.prototype.fetch.call(this,e)},genClientUrl:function(){return this.urlRoot+"?week="+encodeURIComponent(this.get("week"))},canManage:function(){return i.isAllowedTo("QI:RESULTS:MANAGE","FN:quality_engineer")},getTopCount:function(){return this.attributes.options.topCount||4},getCurrentWeek:function(){return t.last(this.attributes.options.oqlWeeks)||null},getSpecifiedResults:function(){var t=this.getCurrentWeek();return t?t.results:[]},updateOqlWeek:function(e){var r=this.attributes.options,i=r.oqlWeeks;if(r.oqlWeeks&&!(e._id<r.fromTime||e._id>=r.toTime)){var n=t.find(i,function(t){return t._id===e._id});n?e=t.assign(n,e):(i.push(e),i.sort(function(t,e){return t._id-e._id})),this.updateGroupTargets(e),this.trigger("change:oqlWeek",this,e),this.trigger("change",this)}},updateGroupTargets:function(){var t=this.get("groups"),e=[].concat(this.get("options").oqlWeeks),r=e[0].target,i=!0;t.forEach(function(t){for(;e.length&&e[0]._id<=t.key;)r=e.shift().target||r;t.oqlTarget!==r&&(t.oqlTarget=r,i=!0)}),i&&this.trigger("change:groups",this,t)}},{fromQuery:function(t){return new this({week:this.parseWeek(t.week)})},parseWeek:function(t){t=(t||"").trim();var e=r.getMoment(),i=t.match(/([0-9]{2,4})?.*?W([0-9]{1,2})/),n=0,s=0;return i?(n=+i[1],s=+i[2]):/[0-9]{1,2}/.test(t)&&(s=+t.match(/([0-9]{1,2})/)[1]),n||s||e.subtract(1,"weeks"),n?n<100&&(n+=2e3):n=e.isoWeekYear(),(!s||s<1||s>53)&&(s=e.isoWeek()),s<10&&(s="0"+s),n+"-W"+s}})});