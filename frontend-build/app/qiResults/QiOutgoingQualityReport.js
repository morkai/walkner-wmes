define(["underscore","../i18n","../time","../user","../core/Model","../core/Collection"],function(t,e,i,r,s,n){"use strict";var o=n.extend({url:"/qi/reports/outgoingQuality/results",rqlQuery:"rid=in=()",model:s.extend({nlsDomain:"qiResults",clientUrlRoot:"#qi/results"})});return s.extend({urlRoot:"/qi/reports/outgoingQuality",nlsDomain:"qiResults",defaults:function(){return{printable:!1,interval:"week",week:"",options:{},totals:{},top:{},groups:{}}},initialize:function(){this.results=t.assign(new o(null,{paginate:!1}),{report:this}),this.on("change:results",function(){var t=(this.get("results")||[]).map(function(t){return t.rid});this.results.rqlQuery.selector.args[0].args[1]=t,t.length?this.results.fetch({reset:!0}):this.results.reset([])})},fetch:function(e){return t.isObject(e)||(e={}),e.data=t.assign(e.data||{},t.pick(this.attributes,["week"])),s.prototype.fetch.call(this,e)},genClientUrl:function(){return this.urlRoot+"?week="+encodeURIComponent(this.get("week"))},canManage:function(){return r.isAllowedTo("QI:RESULTS:MANAGE","FN:quality_engineer")},getTopCount:function(){return this.attributes.options.topCount||4},getCurrentWeek:function(){var e=t.last(this.attributes.options.oqlWeeks);return e?(i.format(e._id,"GGGG-[W]WW")!==this.attributes.week&&((e=t.clone(e))._id=i.getMoment(this.attributes.week,"GGGG-[W]WW").valueOf(),this.attributes.options.oqlWeeks.push(e)),e):null},getSpecifiedResults:function(){var t=this.getCurrentWeek();return t?t.results:[]},updateOqlWeek:function(e){var i=this.attributes.options,r=i.oqlWeeks;if(i.oqlWeeks){var s=t.find(r,function(t){return t._id===e._id});if(s)e=t.assign(s,e);else{if(e._id<i.fromTime||e._id>=i.toTime)return;r.push(e),r.sort(function(t,e){return t._id-e._id})}this.updateGroupTargets(e),this.trigger("change:oqlWeek",this,e),this.trigger("change",this)}},updateGroupTargets:function(){var t=this.get("groups"),e=[].concat(this.get("options").oqlWeeks),i=e[0].target,r=!0;t.forEach(function(t){for(;e.length&&e[0]._id<=t.key;)i=e.shift().target||i;t.oqlTarget!==i&&(t.oqlTarget=i,r=!0)}),r&&this.trigger("change:groups",this,t)}},{fromQuery:function(t){return new this({week:this.parseWeek(t.week)})},parseWeek:function(t){t=(t||"").trim();var e=i.getMoment(),r=t.match(/([0-9]{2,4})?.*?W([0-9]{1,2})/),s=0,n=0;return r?(s=+r[1],n=+r[2]):/[0-9]{1,2}/.test(t)&&(n=+t.match(/([0-9]{1,2})/)[1]),s||n||e.subtract(1,"weeks"),s?s<100&&(s+=2e3):s=e.isoWeekYear(),(!n||n<1||n>53)&&(n=e.isoWeek()),n<10&&(n="0"+n),s+"-W"+n}})});