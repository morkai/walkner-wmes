// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/core/View","app/reports/util/formatTooltipHeader","../dictionaries","../QiCountReport","../views/QiCountReportFilterView","../views/QiTotalNokCountChartView","../views/QiNokCountPerDivisionChartView","../views/QiNokQtyPerFamilyChartView","app/qiResults/templates/countReportPage"],function(e,t,i,o,s,n,r,l,d,u,a){"use strict";return i.extend({layoutName:"page",template:a,breadcrumbs:[t.bound("qiResults","BREADCRUMBS:base"),t.bound("qiResults","BREADCRUMBS:reports:count")],actions:function(){return[{label:t.bound("qiResults","PAGE_ACTION:settings"),icon:"cogs",privileges:"QI:DICTIONARIES:MANAGE",href:"#qi/settings?tab=reports"}]},initialize:function(){var e=this.model;this.setView(".filter-container",new r({model:e})),this.setView("#"+this.idPrefix+"-totalNokCount",new l({model:e})),this.setView("#"+this.idPrefix+"-nokCountPerDivision",new d({model:e})),this.setView("#"+this.idPrefix+"-nokQtyPerFamily",new u({model:e})),this.listenTo(e,"filtered",this.onFiltered),this.listenTo(e,"change:selectedGroupKey",this.updateSelectedGroup),this.listenTo(e,"change:ignoredDivisions",this.updateSelectedDivisions)},destroy:function(){s.unload()},load:function(e){return s.loaded?e(this.model.fetch()):s.load().then(this.model.fetch.bind(this.model))},afterRender:function(){s.load(),this.updateSelectedGroup()},onFiltered:function(){this.promised(this.model.fetch()),this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!1,replace:!0})},updateSelectedGroup:function(){var e=this.model.get("selectedGroupKey");if(!e){var t=this.model.getSelectedGroup();t&&(e=t.key)}this.$id("selectedGroup").text(e?o.call({model:this.model},e):"?")},updateSelectedDivisions:function(){var e=this.model,t=Object.keys(e.get("divisions")),i=t.filter(function(t){return!e.isIgnoredDivision(t)});this.$id("selectedDivisions").text(i.length===t.length?"":"; "+i.join(", "))}})});