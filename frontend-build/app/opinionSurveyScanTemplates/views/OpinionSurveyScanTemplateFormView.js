// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/core/views/FormView","app/core/util/idAndLabel","app/opinionSurveyScanTemplates/templates/form","app/opinionSurveyScanTemplates/templates/formAnswer"],function(e,t,i,s,r){"use strict";return t.extend({template:s,events:e.extend({"change #-survey":function(e){this.selectSurvey(e.added.id)}},t.prototype.events),afterRender:function(){t.prototype.afterRender.call(this),this.$id("survey").select2({minimumResultsForSearch:5,data:this.model.surveys.map(i)}),this.options.editMode?(this.selectSurvey(this.model.get("survey")._id),this.$id("comment").focus()):this.model.surveys.length?(this.selectSurvey(this.model.surveys.at(0).id),this.$id(1===this.model.surveys.length?"comment":"survey").focus()):(this.setUpEmployerSelect2([]),this.setUpSuperiorSelect2([]),this.$id("survey").focus())},setUpEmployerSelect2:function(e){this.$id("employer").select2({minimumResultsForSearch:5,data:e.map(function(e){return{id:e._id,text:e.full}})})},setUpSuperiorSelect2:function(e){this.$id("superior").select2({minimumResultsForSearch:5,data:e.map(function(e){return{id:e._id,text:e.full+" ("+e.division+")",division:e.division}})})},selectSurvey:function(e){var t=this.model.surveys.get(e);if(t){this.setUpEmployerSelect2(t.get("employers")),this.setUpSuperiorSelect2(t.get("superiors"));var i=this.idPrefix,s=this.model.get("answers")||[],n=t.get("questions").map(function(e,t){return r({idPrefix:i,index:t,question:e,value:s[t]?s[t].answer:"na"})});this.$id("survey").select2("val",e),this.$id("answers").html(n.join(""))}},serializeForm:function(e){return e.division=this.$id("superior").select2("data").division,e}})});