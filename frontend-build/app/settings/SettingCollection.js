// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../core/Collection","./Setting"],function(e,t,r){"use strict";return t.extend({model:r,rqlQuery:"select(value)",matchSettingId:null,topicSuffix:"**",initialize:function(e,t){t.pubsub&&this.setUpPubsub(t.pubsub)},setUpPubsub:function(e){var t=this;e.subscribe("settings.updated."+this.topicSuffix,function(e){var r=t.get(e._id);r?r.set(e):t.add(e)})},fetchIfEmpty:function(t,r){if(!this.isEmpty())return t?t.call(r):null;var n=e.Deferred(),i=this.fetch({reset:!0});return t?(i.done(function(){var i=[].concat(t.call(r));e.when.apply(e,i).then(function(){n.resolve()},function(){n.reject()})}),n.promise()):i},update:function(t,r){if(r=this.prepareValue(t,"string"==typeof r?r.trim():r),void 0===r)return e.Deferred().reject().promise();var n=this.get(t);if(n){if(n.getValue()===r)return e.Deferred().resolve().promise()}else this.add({_id:t,value:null}),n=this.get(t);return n.save({value:r})},prepareValue:function(e,t){return t},prepareObjectIdValue:function(e){if(null===e||""===e)return null;var t=String(e).toLowerCase();return/^[a-f0-9]{24}$/.test(t)?t:void 0},prepareMultiObjectIdValue:function(e){return String(e).toLowerCase().split(",").filter(function(e){return/^[a-f0-9]{24}$/.test(e)})},prepareMultiSelect2Value:function(e){return String(e||"").split(",").filter(function(e){return e.length>0})},prepareNumericValue:function(e,t,r){var n=parseInt(e,10);if(!isNaN(n))return t>n?t:n>r?r:n}})});