define(["underscore","jquery","app/core/Collection","./Setting"],function(e,t,r,n){"use strict";return r.extend({model:n,rqlQuery:"select(value)",matchSettingId:null,topicSuffix:"**",initialize:function(e,t){t.pubsub&&this.setUpPubsub(t.pubsub)},setUpPubsub:function(t){var r=this,n=Array.isArray(r.topicSuffix)?r.topicSuffix:[r.topicSuffix];e.forEach(n,function(e){t.subscribe("settings.updated."+e,function(e){var t=r.get(e._id);t?t.set(e):r.add(e)})})},fetchIfEmpty:function(e,r){if(!this.isEmpty())return e?e.call(r):null;var n=t.Deferred(),u=this.fetch({reset:!0});return e?(u.done(function(){var u=[].concat(e.call(r));t.when.apply(t,u).then(function(){n.resolve()},function(){n.reject()})}),n.promise()):u},update:function(r,n){if(void 0===(n=this.prepareValue(r,"string"==typeof n?n.trim():n)))return t.Deferred().reject().promise();var u=this.get(r);if(u){if(e.isEqual(u.getValue(),n))return t.Deferred().resolve().promise()}else this.add({_id:r,value:null}),u=this.get(r);return u.save({value:n})},prepareValue:function(e,t){return t},prepareObjectIdValue:function(e){if(null===e||""===e)return null;var t=String(e).toLowerCase();return/^[a-f0-9]{24}$/.test(t)?t:void 0},prepareMultiObjectIdValue:function(e){return String(e).toLowerCase().split(",").filter(function(e){return/^[a-f0-9]{24}$/.test(e)})},prepareMultiSelect2Value:function(e){return String(e||"").split(",").filter(function(e){return e.length>0})},prepareNumericValue:function(e,t,r,n){var u=parseInt(e,10);return isNaN(u)?n:null!=t&&u<t?t:null!=r&&u>r?r:u},prepareFloatValue:function(e,t,r,n){var u=parseFloat(e);return isNaN(u)?n:null!=t&&u<t?t:null!=r&&u>r?r:u},prepareFormValue:function(e,t){return t||""},getValue:function(e,t){var r=this.get((this.idPrefix||"")+e);return r?r.getValue():null==t?null:t}})});