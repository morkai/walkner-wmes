// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../core/Collection","./Setting"],function(e,t,r){"use strict";return t.extend({model:r,rqlQuery:"select(value)",matchSettingId:null,topicSuffix:"**",initialize:function(e,t){t.pubsub&&this.setUpPubsub(t.pubsub)},setUpPubsub:function(e){var t=this;e.subscribe("settings.updated."+this.topicSuffix,function(e){var r=t.get(e._id);r?r.set(e):t.add(e)})},fetchIfEmpty:function(t,r){if(!this.isEmpty())return t?t.call(r):null;var i=e.Deferred(),n=this.fetch({reset:!0});return t?(n.done(function(){var n=[].concat(t.call(r));e.when.apply(e,n).then(function(){i.resolve()},function(){i.reject()})}),i.promise()):n},update:function(t,r){if(r=this.prepareValue(t,"string"==typeof r?r.trim():r),void 0===r)return e.Deferred().reject().promise();var i=this.get(t);if(i){if(i.getValue()===r)return e.Deferred().resolve().promise()}else this.add({_id:t,value:null}),i=this.get(t);return i.save({value:r})},prepareValue:function(e,t){return t},prepareObjectIdValue:function(e){if(null===e||""===e)return null;var t=String(e).toLowerCase();return/^[a-f0-9]{24}$/.test(t)?t:void 0},prepareNumericValue:function(e,t,r){var i=parseInt(e,10);if(!isNaN(i))return t>i?t:i>r?r:i}})});