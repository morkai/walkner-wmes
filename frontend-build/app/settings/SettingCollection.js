// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../core/Collection","./Setting"],function(e,t,r,n){"use strict";return r.extend({model:n,rqlQuery:"select(value)",matchSettingId:null,topicSuffix:"**",initialize:function(e,t){t.pubsub&&this.setUpPubsub(t.pubsub)},setUpPubsub:function(e){var t=this;e.subscribe("settings.updated."+this.topicSuffix,function(e){var r=t.get(e._id);r?r.set(e):t.add(e)})},fetchIfEmpty:function(e,r){if(!this.isEmpty())return e?e.call(r):null;var n=t.Deferred(),i=this.fetch({reset:!0});return e?(i.done(function(){var i=[].concat(e.call(r));t.when.apply(t,i).then(function(){n.resolve()},function(){n.reject()})}),n.promise()):i},update:function(r,n){if(n=this.prepareValue(r,"string"==typeof n?n.trim():n),void 0===n)return t.Deferred().reject().promise();var i=this.get(r);if(i){if(e.isEqual(i.getValue(),n))return t.Deferred().resolve().promise()}else this.add({_id:r,value:null}),i=this.get(r);return i.save({value:n})},prepareValue:function(e,t){return t},prepareObjectIdValue:function(e){if(null===e||""===e)return null;var t=String(e).toLowerCase();return/^[a-f0-9]{24}$/.test(t)?t:void 0},prepareMultiObjectIdValue:function(e){return String(e).toLowerCase().split(",").filter(function(e){return/^[a-f0-9]{24}$/.test(e)})},prepareMultiSelect2Value:function(e){return String(e||"").split(",").filter(function(e){return e.length>0})},prepareNumericValue:function(e,t,r){var n=parseInt(e,10);if(!isNaN(n))return t>n?t:n>r?r:n}})});