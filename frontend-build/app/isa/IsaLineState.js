// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../time","../core/Model","../data/orgUnits","../data/isaPalletKinds"],function(e,t,i,n){"use strict";function r(e){return"string"==typeof e.updatedAt&&(e.updatedAt=new Date(e.updatedAt)),"string"==typeof e.requestedAt&&(e.requestedAt=new Date(e.requestedAt)),"string"==typeof e.respondedAt&&(e.respondedAt=new Date(e.respondedAt)),e}return t.extend({urlRoot:"/isaLineStates",topicPrefix:"isaLineStates",privilegePrefix:"ISA",nlsDomain:"isa",initialize:function(){this.updateOrgUnits(),this.updateTime(),this.on("change:requestedAt",this.updateTime.bind(this,!1))},parse:r,updateOrgUnits:function(e){var t=i.getAllForProdLine(this.id);t.prodLine=i.getByTypeAndId("prodLine",t.prodLine).getLabel().toUpperCase().replace(/(_+|~.*?)$/,"").replace(/_/g," "),t.prodFlow=i.getByTypeAndId("prodFlow",t.prodFlow).getLabel().replace(/\s+(;|,)/g,"$1"),this.set("orgUnits",t,{silent:e})},updateTime:function(t){this.set("time",e.toTagData(this.get("requestedAt"),!0),{silent:t})},getPalletKind:function(){var e=this.get("data");return e&&e.palletKind||{id:"",label:""}},getWhman:function(){return this.get("responder")||{id:"",label:"?"}},serialize:function(){var e=this.toJSON(),t=this.getPalletKind(),i=n.get(t.id);return e.palletKind=this.getPalletKind().label,e.palletKindFull=i?i.get("fullName"):"",e.whman=this.getWhman().label,e},matchResponder:function(e){if(!e)return!0;var t=this.get("responder");return t&&t.id===e.id},act:function(e,t){var i=this,n=i.sync("patch",i,{attrs:e});return n.fail(function(e){var n=e.responseJSON?e.responseJSON.error:null;n||(n={message:e.statusText}),n.statusCode=e.status,t(n),i.trigger("error")}),n.done(function(e){t(null,e),i.trigger("sync")}),n},pickup:function(e,t){return this.act({action:"requestPickup",secretKey:e},t)},deliver:function(e,t,i){return this.act({action:"requestDelivery",secretKey:t,palletKind:e},i)},cancel:function(e,t){return this.act({action:"cancelRequest",secretKey:e},t)},accept:function(e,t){return this.act({action:"acceptRequest",responder:e},t)},finish:function(e){return this.act({action:"finishRequest"},e)}},{parse:r})});