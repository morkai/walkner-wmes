define(["underscore","../time","../i18n","../core/Model","../data/orgUnits","../data/isaPalletKinds","app/core/templates/userInfo"],function(e,t,i,r,n,s,d){"use strict";var a={new:"debug",accepted:"warning",finished:"success",cancelled:"danger"};function o(t){var i=e.last(t);if(i&&"prodLine"===i.type)return i.id;var r=e.find(t,function(e){return"prodLine"===e.type});return r?r.id:null}function u(e){if(["requestedAt","respondedAt","finishedAt"].forEach(function(t){"string"==typeof e[t]&&(e[t]=new Date(e[t]))}),e.orgUnits&&!e.orgUnit){var t=o(e.orgUnits),i=n.getAllForProdLine(t),r=n.getByTypeAndId("prodLine",i.prodLine),s=n.getByTypeAndId("prodFlow",i.prodFlow);i.prodLine=r?n.getByTypeAndId("prodLine",i.prodLine).getLabel().toUpperCase().replace(/(_+|~.*?)$/,"").replace(/_/g," "):t,i.prodFlow=s?s.getLabel().replace(/\s+(;|,)/g,"$1"):"?",e.orgUnit=i}return e}return r.extend({urlRoot:"/isaRequests",clientUrlRoot:"#isa/requests",topicPrefix:"isaRequests",privilegePrefix:"ISA",nlsDomain:"isa",parse:u,initialize:function(){this.updateOrgUnits(),this.updateTime()},updateOrgUnits:function(e){var t=n.getAllForProdLine(this.getProdLineId()),i=n.getByTypeAndId("prodLine",t.prodLine),r=n.getByTypeAndId("prodFlow",t.prodFlow);t.prodLine=(i?i.getLabel():this.getProdLineId()).toUpperCase().replace(/(_+|~.*?)$/,"").replace(/_/g," "),t.prodFlow=r?r.getLabel().replace(/\s+(;|,)/g,"$1"):"?",this.set("orgUnit",t,{silent:e})},updateTime:function(e){this.set("time",t.toTagData(this.get("requestedAt"),!0),{silent:e})},serialize:function(){var e=this.toJSON();return e.qty=this.getQty(),e.palletKind=this.getPalletKind().label,e.palletKindFull=this.getFullPalletKind(),e.whman=this.getWhman().label,e},serializeRow:function(){var e=this.toJSON();return e.className=a[e.status],e.line=this.getProdLineId(),e.type=i("isa","requests:type:"+e.type,{qty:e.data.qty||8,palletKind:e.data.palletKind?e.data.palletKind.label:"?"}),e.status=i("isa","requests:status:"+e.status),e.requester=d({userInfo:e.requester}),e.responder=d({userInfo:e.responder}),e.finisher=d({userInfo:e.finisher}),e.requestedAt=t.format(e.requestedAt,"LL, LTS"),e.respondedAt=e.respondedAt?t.format(e.respondedAt,"LTS"):"-",e.finishedAt=e.finishedAt?t.format(e.finishedAt,"LTS"):"-",e.duration=t.toString(this.getDuration()),e.request=i("isa","requests:date+user",{date:e.requestedAt,user:e.requester}),e.response="-"===e.respondedAt?"-":i("isa","requests:time+user",{time:e.respondedAt,user:e.responder}),e.finish="-"===e.finishedAt?"-":i("isa","requests:time+user",{time:e.finishedAt,user:e.finisher}),e},getProdLineId:function(){return o(this.get("orgUnits"))},getPalletKind:function(){var e=this.get("data");return e&&e.palletKind||{id:"",label:""}},getQty:function(){var e=this.get("data");return e&&e.qty||8},getFullPalletKind:function(){var e=this.getPalletKind(),t=s.get(e.id);return t?t.get("fullName"):"?"},getWhman:function(){return this.get("responder")||{id:"",label:"?"}},isCompleted:function(){return"finished"===this.get("status")||"cancelled"===this.get("status")},getDuration:function(){return this.isCompleted()?this.get("duration"):(Date.now()-Date.parse(this.get("requestedAt")))/1e3},matchResponder:function(e){if(!e)return!0;var t=this.get("responder");return t&&t.id===e.id}},{parse:u})});