// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../i18n","../core/Model","app/core/templates/userInfo"],function(e,t,s,r,i){"use strict";var n={"new":"debug",accepted:"warning",finished:"success",cancelled:"danger"};return r.extend({urlRoot:"/isaRequests",clientUrlRoot:"#isa/requests",topicPrefix:"isaRequests",privilegePrefix:"ISA",nlsDomain:"isa",serializeRow:function(){var e=this.toJSON();return e.className=n[e.status],e.line=this.getProdLineId(),e.type=s("isa","requests:type:"+e.type,{palletKind:e.data.palletKind?e.data.palletKind.label:"?"}),e.status=s("isa","requests:status:"+e.status),e.requester=i({userInfo:e.requester}),e.responder=i({userInfo:e.responder}),e.finisher=i({userInfo:e.finisher}),e.requestedAt=t.format(e.requestedAt,"LL, HH:mm:ss"),e.respondedAt=e.respondedAt?t.format(e.respondedAt,"HH:mm:ss"):"-",e.finishedAt=e.finishedAt?t.format(e.finishedAt,"HH:mm:ss"):"-",e.duration=t.toString(this.getDuration()),e.request=s("isa","requests:date+user",{date:e.requestedAt,user:e.requester}),e.response="-"===e.respondedAt?"-":s("isa","requests:time+user",{time:e.respondedAt,user:e.responder}),e.finish="-"===e.finishedAt?"-":s("isa","requests:time+user",{time:e.finishedAt,user:e.finisher}),e},getProdLineId:function(){var t=this.get("orgUnits"),s=e.last(t);if(s&&"prodLine"===s.type)return s.id;var r=e.find(t,function(e){return"prodLine"===e.type});return r?r.id:null},isCompleted:function(){return"finished"===this.get("status")||"cancelled"===this.get("status")},getDuration:function(){return this.isCompleted()?this.get("duration"):(Date.now()-Date.parse(this.get("requestedAt")))/1e3}})});