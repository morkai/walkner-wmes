// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../core/Collection","./IsaRequest"],function(e,t,r){"use strict";return t.extend({model:r,rqlQuery:"sort(-requestedAt)&limit(20)",parse:function(e){return e.collection.map(r.parse)},getFirstPickup:function(){return this.find(function(e){return"pickup"===e.get("type")})},getFirstDelivery:function(){return this.find(function(e){return"delivery"===e.get("type")})},act:function(t,r){var n=this,i=n.url;t.requestId&&(i="/isaActiveRequests/"+this.get(t.requestId).getProdLineId());var u=e.ajax({method:"PATCH",url:i,data:JSON.stringify(t)});return n.trigger("request",this,u,{}),u.fail(function(e){var t=e.responseJSON?e.responseJSON.error:null;t||(t={message:e.statusText}),t.statusCode=e.status,r(t),n.trigger("error",u)}),u.done(function(e){r(null,e),n.trigger("sync",e,u)}),u},pickup:function(e,t){return this.act({action:"requestPickup",secretKey:e},t)},deliver:function(e,t,r){return this.act({action:"requestDelivery",secretKey:t,palletKind:e},r)},cancel:function(e,t,r){return this.act({action:"cancelRequest",secretKey:t,requestId:e},r)},accept:function(e,t,r){return this.act({action:"acceptRequest",responder:t,requestId:e},r)},finish:function(e,t){return this.act({action:"finishRequest",requestId:e},t)}},{active:function(){return new this(null,{url:"/isaActiveRequests",comparator:function(e,t){return e=e.attributes,t=t.attributes,null===e.requestedAt?1:null===t.requestedAt?-1:e.type!==t.type?"delivery"===e.type?-1:1:e.requestedAt-t.requestedAt}})},activeForLine:function(e){return new this(null,{url:"/isaActiveRequests/"+e})}})});