// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/core/util/bindLoadingMessage","../IsaLineState","../views/IsaShiftPersonnelView","../views/IsaLineStatesView","../views/IsaEventsView","../views/IsaResponderPickerView","app/isa/templates/page"],function(e,t,s,i,n,o,h,a,l,r,d,c){"use strict";return n.extend({template:c,layoutName:"page",pageId:"isa",title:[s.bound("isa","BREADCRUMBS:base")],actions:[],localTopics:{"socket.connected":function(){this.promised(this.lineStates.fetch({reset:!0})),this.promised(this.shiftPersonnel.fetch()),this.$el.removeClass("isa-is-disconnected")},"socket.disconnected":function(){this.$el.addClass("isa-is-disconnected")}},remoteTopics:{"isaShiftPersonnel.updated":function(e){this.shiftPersonnel.set(e)},"isaLineStates.created.**":function(e){e=new h(h.parse(e)),this.pendingChanges?this.pendingChanges.push(e):this.applyChanges(e)},"isaLineStates.updated.**":function(e){e=h.parse(e),this.pendingChanges?this.pendingChanges.push(e):this.applyChanges(e)},"isaEvents.saved":function(e){this.eventz.unshift(e),this.eventz.length>50&&this.eventz.pop()}},events:{"click #-shiftPersonnel":function(e){e.currentTarget.blur();var t=new a({model:this.shiftPersonnel});t.listenToOnce(this.shiftPersonnel,"sync",i.closeDialog.bind(i)),i.showDialog(t,s("isa","shiftPersonnel:title"))},"click #-responderFilter":function(){var e=this.$id("responderFilter").removeClass("isa-attract"),t=new d({model:this.model.shiftPersonnel,includeSelf:!0});this.listenToOnce(t,"picked",function(e){t.hide(),this.model.selectedResponder=e,localStorage.ISA_SELECTED_RESPONDER=JSON.stringify(e),this.$id("selectedResponder").text(e?e.label:""),this.lineStates.trigger("filter")}),t.show(e,this.model.selectedResponder?this.model.selectedResponder.id:null)},"click .isa-tab":function(e){var t=this.$(e.currentTarget);t.hasClass("active")||(this.$(".isa-tab.active").removeClass("active"),t.addClass("active"),this.el.dataset.tab=e.currentTarget.dataset.tab)},"click .is-collapsed":function(e){this.$(e.currentTarget).removeClass("is-collapsed is-collapsing")},"click #-collapseEvents":"collapseEvents","click #-toggleFullscreen":"toggleFullscreen"},initialize:function(){this.onResize=e.debounce(this.resize.bind(this),30),this.onActivity=e.debounce(this.handleInactivity.bind(this),3e4),this.pendingChanges=[],this.keys={AltLeft:!1,AltRight:!1,ShiftLeft:!1,ShiftRight:!1},this.timers.updateTime=setInterval(this.updateTimes.bind(this),15e3),this.defineModels(),this.defineViews(),this.defineBindings(),this.setView("#"+this.idPrefix+"-requests",this.requestsView),this.setView("#"+this.idPrefix+"-responses",this.responsesView),this.setView("#"+this.idPrefix+"-events",this.eventsView)},destroy:function(){document.body.style.overflow="",document.body.classList.remove("isa-is-fullscreen"),t(window).off("."+this.idPrefix)},defineModels:function(){this.shiftPersonnel=o(this.model.shiftPersonnel,this),this.lineStates=o(this.model.lineStates,this),this.eventz=o(this.model.events,this),this.listenTo(this.lineStates,"change:status",function(e){var t=e.previous("status"),s=e.get("status");"request"===t&&"response"===s&&window.innerWidth>800&&e.matchResponder(this.model.selectedResponder)&&this.moveLineState(e)})},defineViews:function(){this.requestsView=new l({mode:"requests",model:this.model}),this.responsesView=new l({mode:"responses",model:this.model}),this.eventsView=new r({collection:this.eventz})},defineBindings:function(){this.listenTo(this.lineStates,"request",function(e){e!==this.lineStates||this.pendingChanges||(this.pendingChanges=[])}),this.listenTo(this.lineStates,"error sync",this.applyPendingChanges),this.listenTo(this.shiftPersonnel,"change:users",this.attractToShiftPersonnel),this.listenTo(this.requestsView,"recount",this.recount.bind(this,"requests")),this.listenTo(this.responsesView,"recount",this.recount.bind(this,"responses")),t(window).on("resize."+this.idPrefix,this.onResize).on("mouseenter."+this.idPrefix,this.onActivity).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("keyup."+this.idPrefix,this.onKeyUp.bind(this))},load:function(e){return this.model.selectedResponder=JSON.parse(localStorage.ISA_SELECTED_RESPONDER||"null"),e(this.shiftPersonnel.fetch(),this.lineStates.fetch({reset:!0}),this.eventz.fetch({reset:!0}))},applyPendingChanges:function(){this.pendingChanges&&(this.pendingChanges.forEach(this.applyChanges.bind(this)),this.pendingChanges=null)},applyChanges:function(e){if(e instanceof h){var t=e,s=this.lineStates.get(t.id);s?t.get("updatedAt")>s.get("updatedAt")&&s.set(t.attributes):this.lineStates.add(t)}else{var i=this.lineStates.get(e._id);if(!i)return this.scheduleLineStatesReload();e.updatedAt>i.get("updatedAt")&&i.set(e)}},scheduleLineStatesReload:function(){clearTimeout(this.timers.reloadLineStates),this.timers.reloadLineStates=setTimeout(function(e){e.promised(e.lineStates.fetch({reset:!0}))},1,this)},serialize:function(){return{idPrefix:this.idPrefix,height:this.calcHeight(),disconnected:!this.socket.isConnected(),mobile:/iPhone|iPad|iPod|Android/i.test(window.navigator.userAgent),selectedResponder:this.model.selectedResponder?this.model.selectedResponder.label:""}},afterRender:function(){document.body.style.overflow="hidden",this.resize(),this.model.shiftPersonnel.isEmpty()&&this.$id("shiftPersonnel").addClass("isa-attract"),this.model.selectedResponder&&this.$id("responderFilter").addClass("isa-attract")},attractToShiftPersonnel:function(){var e=this.$id("shiftPersonnel").removeClass("isa-attract");this.model.shiftPersonnel.isEmpty()&&e.addClass("isa-attract")},resize:function(){this.$el.height(this.calcHeight())},calcHeight:function(){var e=this.options.fullscreen||window.innerWidth<=800||window.outerWidth===window.screen.width&&window.outerHeight===window.screen.height,s=window.innerHeight-15;return document.body.classList.toggle("isa-is-fullscreen",e),s-=e?15:t(".hd").outerHeight(!0)+t(".ft").outerHeight(!0)},updateTimes:function(){this.lineStates.forEach(function(e){"idle"!==e.get("status")&&e.updateTime(!0)}),this.requestsView.updateTimes(),this.responsesView.updateTimes()},moveLineState:function(e){var t=this;t.model.moving[e.id]=!0,t.requestsView.move(e,function(){t.responsesView.insert(e,function(){delete t.model.moving[e.id]})})},handleInactivity:function(){this.$(".isa-section-body").prop("scrollTop",0)},recount:function(e,t){this.$id("count-"+e).text(t||"")},onKeyDown:function(e){var t=e.originalEvent.code;return"boolean"==typeof this.keys[t]?(this.keys[t]=!0,"AltRight"===t&&(this.keys.ShiftLeft=!1,this.$el.removeClass("isa-hotkey-ShiftLeft")),this.$el.addClass("isa-hotkey-"+t),!1):void 0},onKeyUp:function(e){this.onActivity();var t=e.originalEvent.code;if("boolean"==typeof this.keys[t])return this.keys[t]=!1,this.$el.removeClass("isa-hotkey-"+t),!1;if("KeyP"===t)return void this.$id("shiftPersonnel").click();if("KeyF"===t)return void this.$id("responderFilter").click();var s=e.keyCode-48;if(!(1>s||s>9)){var i,n;return this.keys.ShiftLeft?(i=this.requestsView,n="accept"):this.keys.AltLeft?(i=this.responsesView,n="finish"):this.keys.AltRight?(i=this.requestsView,n="cancel"):this.keys.ShiftRight&&(i=this.responsesView,n="cancel"),i?(i.actAt(n,s),!1):void 0}},collapseEvents:function(){var e=this.$(".isa-section-events");e.addClass("is-collapsing"),e.css("width","25px"),this.timers.collapsed=setTimeout(function(){e.addClass("is-collapsed")},400)},toggleFullscreen:function(){this.options.fullscreen=!this.options.fullscreen,this.broker.publish("router.navigate",{url:"#isa"+(this.options.fullscreen?"?fullscreen=1":""),replace:!0,trigger:!1}),this.resize()}})});