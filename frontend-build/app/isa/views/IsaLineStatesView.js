// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/core/View","app/core/views/DialogView","./IsaResponderPickerView","app/isa/templates/lineStates","app/isa/templates/lineState","app/isa/templates/cancelDialog"],function(e,t,i,s,n,a,r,o,l){"use strict";return s.extend({template:r,events:{"click .isa-lineState-accept":function(e){e.currentTarget.blur(),this.accept(this.findLineStateId(e.target))},"click .isa-lineState-finish":function(e){e.currentTarget.blur(),this.finish(this.findLineStateId(e.target))},"click .isa-lineState-cancel":function(e){e.currentTarget.blur(),this.cancel(this.findLineStateId(e.target))}},initialize:function(){this.requiredStatus="requests"===this.options.mode?"new":"accepted",this.cancelling=null;var e=this.model.requests;this.listenTo(e,"reset",this.render),this.listenTo(e,"filter",this.render),this.listenTo(e,"add",this.onAdd),this.listenTo(e,"remove",this.onRemove),this.listenTo(e,"change",this.onChange)},serialize:function(){var e="responses"===this.options.mode&&this.model.selectedResponder?this.model.selectedResponder:null;return{idPrefix:this.idPrefix,mode:this.options.mode,requests:this.model.requests.where({status:this.requiredStatus}).filter(function(t){return t.matchResponder(e)}).map(function(e){return e.serialize()}),renderRequest:o}},afterRender:function(){this.recount()},updateTimes:function(){var e=this.model.requests;this.$(".isa-lineState").each(function(){var t=e.get(this.dataset.id),i=t.get("time"),s=this.querySelector(".isa-lineState-time");s.setAttribute("datetime",i.iso),s.setAttribute("title",i.long),s.textContent=i.human})},actAt:function(e,t){var i=this.el.children[t];i&&this[e](i.dataset.id)},cancel:function(e){var s=this,a=s.model.requests.get(e);if(a){var r=s.findRequestEl(a.id);if(r.length){var o=r.find(".btn").prop("disabled",!0),d=new n({template:l});s.listenToOnce(d,"dialog:hidden",function(){o.prop("disabled",!1),s.cancelling=null}),s.listenToOnce(d,"answered",function(e){"yes"===e&&s.model.requests.cancel(a.id,null,function(e){e&&i.msg.show({type:"error",time:5e3,text:t.has("isa","cancel:"+e.message)?t("isa","cancel:"+e.message):t("isa","cancel:failure")})})}),i.showDialog(d,t("isa","cancel:title")),this.cancelling=e}}},accept:function(e){var s=this,n=s.model.requests.get(e);if(n){var r=s.findRequestEl(n.id);if(r.length){var o=new a({model:s.model.shiftPersonnel});s.listenToOnce(o,"picked",function(e){o.hide(),e&&s.model.requests.accept(n.id,e,function(e){e&&i.msg.show({type:"error",time:5e3,text:t.has("isa","accept:"+e.message)?t("isa","accept:"+e.message):t("isa","accept:failure")})})}),o.show(r.find(".isa-lineState-actions"))}}},finish:function(e){var s=this,n=s.model.requests.get(e);if(n){var a=s.findRequestEl(n.id);a.length&&s.model.requests.finish(n.id,function(e){e&&i.msg.show({type:"error",time:5e3,text:t.has("isa","finish:"+e.message)?t("isa","finish:"+e.message):t("isa","finish:failure")})})}},recount:function(){this.$(".btn").each(function(e){var t=e+1;t%2===1&&(t+=1);var i=t/2;this.children[1].textContent=i>9?"":i}),this.trigger("recount",this.el.childElementCount-1)},move:function(e,t){var i=this.findRequestEl(e.id);if(!i.length)return t();var s=i.position();i.css({top:s.top+"px",left:s.left+"px",width:i.outerWidth()+"px",height:i.outerHeight()+"px"}),i.addClass("is-moving");var n=this;setTimeout(function(){i.remove(),t(),n.recount()},750)},insert:function(t,i){if(t.get("status")!==this.requiredStatus||"responses"===this.options.mode&&!t.matchResponder(this.model.selectedResponder))i&&i();else{var s=e(this.renderLineState(t));if("requests"===this.options.mode&&"delivery"===t.get("type")){var n=this.$('.isa-lineState[data-request-type="delivery"]').last();if(n.length)s.insertAfter(n);else{var a=this.$(".isa-lineState").first();a.length?s.insertBefore(a):this.$el.append(s)}}else this.$el.append(s);s.stop(!0,!1).fadeIn(i),this.recount()}},renderLineState:function(e){return o({hidden:!0,mode:this.options.mode,request:e.serialize(),hotkey:""})},findLineStateId:function(e){return this.$(e).closest(".isa-lineState").attr("data-id")},findRequestEl:function(e){return this.$('.isa-lineState[data-id="'+e+'"]')},onAdd:function(e){this.onChange(e)},onRemove:function(e){var t=this;t.cancelling===e.id&&i.closeDialog();var s=t.findRequestEl(e.id);s.length&&s.stop(!0,!1).fadeOut(function(){s.remove(),t.recount()})},onChange:function(e){if(e!==this.model.requests){var t=this.findRequestEl(e.id);return t.length?void(e.get("status")===this.requiredStatus?(t.stop(!0,!0),t=this.findRequestEl(e.id),t.length?t.fadeIn():this.insert(e)):this.model.moving[e.id]||this.onRemove(e)):void(e.get("status")!==this.requiredStatus||this.model.moving[e.id]||this.insert(e))}}})});