// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/user","app/core/View","app/isa/templates/responderPicker"],function(e,t,i,s,n,r){"use strict";return n.extend({template:r,events:{"click .list-group-item":function(){return!1},keydown:function(e){switch(e.keyCode){case 13:case 32:this.pick(e.target);break;case 37:this.el.firstElementChild&&this.el.firstElementChild.focus();break;case 38:e.target.previousElementSibling?e.target.previousElementSibling.focus():this.el.lastElementChild&&this.el.lastElementChild.focus();break;case 39:this.el.lastElementChild&&this.el.lastElementChild.focus();break;case 40:e.target.nextElementSibling?e.target.nextElementSibling.focus():this.el.firstElementChild&&this.el.firstElementChild.focus()}var t=this.el.children[e.keyCode-49];t&&this.pick(t)},mouseenter:function(){clearTimeout(this.timers.hide)},mouseleave:function(){this.timers.hide=setTimeout(this.pick.bind(this,null),1e4)}},initialize:function(){var t=this;e(document.body).on("mousedown."+this.idPrefix,function(e){t.pick(e.target)}),e(document.body).on("keydown."+this.idPrefix,function(e){return 9===e.keyCode?(t.el.firstElementChild&&t.el.firstElementChild.focus(),!1):void(27===e.keyCode&&t.pick(null))})},destroy:function(){e(document.body).off("."+this.idPrefix)},serialize:function(){return{idPrefix:this.idPrefix,users:this.model.serializeUsers(this.options.includeSelf)}},afterRender:function(){var e=this.$el.children().first().focus();e.length||i.msg.show({type:"warning",time:2500,text:t("isa","responderPicker:empty")})},show:function(e,t){if(!this.el.classList.contains("isa-responderPicker")){this.render().$el.css("left","-1000px").appendTo(e);var i=e.position(),n=e.outerWidth();this.$el.css({display:"none",top:i.top-1+"px",left:i.left+n-this.$el.outerWidth()+1+"px"})}this.$el.stop(!0,!1).fadeIn({duration:"fast",start:function(){var e=this.querySelector('[data-user-id="'+t||s.data._id+'"]');e?e.focus():this.firstElementChild&&this.firstElementChild.focus()}})},hide:function(){this.$el.stop(!0,!1).fadeOut("fast",this.remove.bind(this))},pick:function(e){e&&"SPAN"===e.tagName&&(e=e.parentNode),this.trigger("picked",e&&e.dataset.userId?{id:e.dataset.userId,label:e.querySelector("span").textContent}:null)}})});