// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","app/core/View","app/users/util/setUpUserSelect2","app/isa/templates/shiftPersonnel"],function(e,t,s,i,n,r){"use strict";return i.extend({template:r,events:{submit:function(){var e=this.$id("users").select2("data").map(function(e){return{id:e.id,label:e.text}}),i=this.model.save({users:e},{wait:!0});return i.fail(function(){s.msg.show({type:"error",time:4e3,text:t("isa","shiftPersonnel:msg:failure")})}),i.done(function(){s.msg.show({type:"success",time:2e3,text:t("isa","shiftPersonnel:msg:success")})}),!1}},serialize:function(){return{idPrefix:this.idPrefix,users:this.model.get("users").map(function(e){return e.id}).join(",")}},afterRender:function(){var t=this,s="/users?select(firstName,lastName,login)&sort(lastName,firstName)&limit(100)&privileges="+encodeURIComponent("ISA:WHMAN");this.ajax({url:s}).done(function(s){var i=[];e.forEach(s.collection,function(e){var t=e.login;e.lastName&&(t=e.lastName,e.firstName&&(t+=" "+e.firstName)),i.push({id:e._id,text:t})}),t.setUpSelect2(i)}),this.setUpSelect2(this.model.get("users").map(function(e){return{id:e.id,text:e.label}}))},setUpSelect2:function(e){this.$id("users").select2({allowClear:!0,multiple:!0,data:e})},onDialogShown:function(){this.$id("users").select2("focus")}})});