define(["underscore","jquery","app/time","app/i18n","app/viewport","app/data/downtimeReasons","app/data/prodLines","app/core/Model","app/core/views/FormView","app/users/util/setUpUserSelect2","../PressWorksheetCollection","app/pressWorksheets/templates/form","app/pressWorksheets/templates/ordersTable","app/pressWorksheets/templates/ordersTableRow","app/pressWorksheets/templates/ordersTableNotesRow"],function(e,t,s,r,i,o,n,a,d,l,h,p,c,f,u){"use strict";var m={PAINT:"PAINT_",METALASS:"METALASS_"};return d.extend({template:p,events:{keydown:function(e){13===e.keyCode&&"TEXTAREA"!==e.target.tagName&&e.preventDefault()},"click button[type=submit]":function(e){this.checkOverlapping=e.target.classList.contains("btn-primary")},submit:function(e){return this.removeIsOverlapping(),this.submitForm(e)},"blur .pressWorksheets-form-time":function(e){var t=e.target.value;if(/opWorkDuration$/.test(e.target.name)&&/[0-9]+%/.test(e.target.value)){var r=this.$(e.target).closest("tr"),i=s.utc.getMoment(r.find('input[name$="startedAt"]').val(),"HH:mm"),o=s.utc.getMoment(r.find('input[name$="finishedAt"]').val(),"HH:mm").diff(i);o>0?(o*=parseInt(t,10)/100,t=Math.round(o/6e4).toString()):t=""}if(t=t.trim(),/^[0-9]+$/.test(t)&&(t+="m"),/[a-z]/.test(t)&&(t=s.toString(s.toSeconds(t),!0).split(":").slice(0,2).join(":")),0!==(t=t.replace(/[^0-9: \-]+/g,"").trim()).length){var n=t.match(/^([0-9]+)(?::| +|-)+([0-9]+)/),a=0,d=0;n?(a=parseInt(n[1],10),d=parseInt(n[2],10)):4===t.length?(a=parseInt(t.substr(0,2),10),d=parseInt(t.substr(2),10)):3===t.length?(a=parseInt(t[0],10),d=parseInt(t.substr(1),10)):d=parseInt(t,10);var l=isNaN(a)||a>=24,h=isNaN(d)||d>=60;l&&(a=0),h&&(d=0),e.target.value=(a<10?"0":"")+a.toString(10)+":"+(d<10?"0":"")+d.toString(10),this.validateTimes(e.target)}else e.target.value=""},"blur .pressWorksheets-form-count":function(e){var t=parseInt(e.target.value,10);e.target.value=isNaN(t)?"":t,e.target.classList.contains("is-downtime")&&this.validateTimes(e.target)},"blur .pressWorksheets-form-quantityDone":function(e){var t=parseInt(e.target.value,10);e.target.value=isNaN(t)||t<0?"":t,this.calcOpWorkDuration(e.currentTarget)},"focus input":function(e){e.target.classList.contains("select2-focusser")&&e.target.parentNode.classList.contains("pressWorksheets-form-part")?this.$(".table-responsive").prop("scrollLeft",0):e.target.classList.contains("pressWorksheets-form-time")&&e.target.parentNode.classList.contains("form-group")&&(this.paintShopTimeFocused=!0)},"focus .pressWorksheets-form-order input":function(e){var t=this.$(e.target);t.closest("td").addClass("is-focused"),t.hasClass("select2-focusser")&&(t=t.parent().next("input")),t.length&&t[0].dataset.column&&this.$('th[data-column="'+t[0].dataset.column+'"]').addClass("is-focused")},"blur .pressWorksheets-form-order input":function(e){this.$(e.target).closest("td").removeClass("is-focused"),this.$("th.is-focused").removeClass("is-focused")},"change input[name=shift]":function(){this.checkShiftStartTimeValidity(),this.validateTimes(null),this.checkForExistingWorksheet()},"change input[name=date]":function(){this.checkShiftStartTimeValidity(),this.checkForExistingWorksheet()},"change input[name=operator]":function(){this.checkForExistingWorksheet()},"change input[name=type]":function(){this.prepareProdLinesData(),this.togglePaintShop(),this.filling||(this.renderOrdersTable(),this.addOrderRow())},'change input[name$=".part"]':function(e){this.calcOpWorkDuration(e.currentTarget)},'change input[name$=".operation"]':function(e){this.calcOpWorkDuration(e.currentTarget)},"click .pressWorksheets-form-comment":function(e){var t=this.$(e.currentTarget).closest(".pressWorksheets-form-order").next(".pressWorksheets-form-notes");t[t.is(":visible")?"fadeOut":"fadeIn"]("fast",function(){t.find("textarea").focus()})},"click a[data-auto-wc]":function(e){e.preventDefault(),this.generateAutoOrders(e.currentTarget.dataset.autoWc)}},initialize:function(){d.prototype.initialize.apply(this,arguments),this.checkOverlapping=!0,this.filling=!1,this.lastOrderNo=-1,this.lossReasons=[],this.downtimeReasons=[],this.paintShopTimeFocused=!1,this.onKeyDown=this.onKeyDown.bind(this),this.existingWorksheets=new h(null,{rqlQuery:"select(rid)"}),this.listenTo(this.existingWorksheets,"request",function(){this.$id("existingWarning").fadeOut()}),this.listenTo(this.existingWorksheets,"reset",this.toggleExistingWarning),t(document.body).on("keydown."+this.idPrefix,this.onKeyDown)},destroy:function(){t(document.body).off("."+this.idPrefix)},afterRender:function(){d.prototype.afterRender.call(this),this.prepareProdLinesData(),l(this.$id("master"));var e=l(this.$id("operator")),t=l(this.$id("operators"),{multiple:!0}),s=this;t.on("change",function(){e.select2("data")||(e.select2("data",t.select2("data")[0]),s.checkForExistingWorksheet())}),this.fillType(),this.togglePaintShop(),this.renderOrdersTable(),this.fillModelData(),this.addOrderRow(),this.model.id||this.$id("type").focus()},prepareProdLinesData:function(){var e=Date.parse(this.model.get("createdAt")||new Date)<s.getMoment().subtract(1,"days").valueOf();this.prodLinesData=n.filter(function(t){var s=t.getSubdivision();if(!s)return!1;var r=s.get("type");return("press"===r||"paintShop"===r)&&(e||!t.get("deactivatedAt"))}).map(function(e){return{id:e.id,text:e.id}})},renderOrdersTable:function(){var e="optics"===this.getType(),t=e?"opticsPosition":"pressPosition";this.lossReasons=e?[]:this.model.lossReasons.toJSON(),this.downtimeReasons=o.filter(function(e){return e.get(t)>=0}).map(function(e){return e.toJSON()}).sort(function(e,s){return e[t]-s[t]}),this.lastOrderNo=-1,this.$id("ordersTable").html(this.renderPartial(c,{rowspan:this.lossReasons.length||this.downtimeReasons.length?2:0,lossReasons:this.lossReasons,downtimeReasons:this.downtimeReasons}))},serializeForm:function(e){var t=this.$(".pressWorksheets-form-order");e.orders=(e.orders||[]).filter(function(e){return e.part&&e.part.length&&e.operation&&e.operation.length}).map(this.serializeOrder.bind(this,t,this.model.lossReasons)),e.operators=l.getUserInfo(this.$id("operators")),e.operator=l.getUserInfo(this.$id("operator")),e.master=l.getUserInfo(this.$id("master")),e.shift=parseInt(e.shift,10);var s={},r={};return e.orders.forEach(function(e){s[e.division]=1,r[e.prodLine]=1}),e.divisions=Object.keys(s),e.prodLines=Object.keys(r),e},serializeOrder:function(t,s,r,i){var a=t.eq(i),d=a.find(".pressWorksheets-form-part"),l=d.select2("data").data;l._id&&(l.nc12=l._id,delete l._id);var h=e.find(l.operations,function(e){return e.no===r.operation}),p=[];r.losses&&Object.keys(r.losses).forEach(function(e){e=s.get(e),r.losses[e.id]>0&&p.push({reason:e.id,label:e.get("label"),count:parseInt(r.losses[e.id],10)})});var c=[];r.downtimes&&Object.keys(r.downtimes).forEach(function(e){var t=parseInt(r.downtimes[e],10);if(t>0){e=o.get(e);var s=a.find('.is-downtime[data-reason="'+e.id+'"]');c.push({prodDowntime:s.attr("data-prodDowntime")||null,reason:e.id,label:e.get("label"),duration:t})}});var f=n.get(r.prodLine).getSubdivision(),u=0;if(r.opWorkDuration){var m=r.opWorkDuration.split(":");u=1e3*(3600*m[0]+60*m[1])/36e5}return{prodShiftOrder:d.attr("data-prodShiftOrder")||null,division:f?f.get("division"):null,prodLine:r.prodLine,nc12:l.nc12,name:l.name,operationNo:h.no,operationName:h.name,orderData:l,quantityDone:r.quantityDone,startedAt:r.startedAt||null,finishedAt:r.finishedAt||null,opWorkDuration:u,losses:p,downtimes:c,notes:r.notes||""}},checkShiftStartTimeValidity:function(){var e=this.$id("date"),t=this.getShiftMoment();e[0].setCustomValidity(t.valueOf()>Date.now()?r("pressWorksheets","FORM:ERROR:date"):"");var s=this.$id("startedAt"),i=this.$id("finishedAt");t.isValid()&&(this.paintShopTimeFocused||(s.val(t.format("HH:mm")),i.val(t.add(8,"hours").format("HH:mm"))))},getShiftMoment:function(){var e=this.$id("date"),t=parseInt(this.$("input[name=shift]:checked").val(),10);return s.getMoment(e.val()+" 06:00:00","YYYY-MM-DD HH:mm:ss").add(8*(t-1),"hours")},getType:function(){return this.$("input[name=type]:checked").val()},isPaintShop:function(){return"paintShop"===this.getType()},showFieldError:function(e,t){return e.hasClass("select2-offscreen")?e.select2("focus"):e.focus(),this.$errorMessage=i.msg.show({type:"error",time:3e3,text:r("pressWorksheets","FORM:ERROR:"+t)}),!1},setUpOrderSelect2:function(e){var t=this;e.removeClass("form-control"),e.select2({allowClear:!0,minimumInputLength:10,ajax:{cache:!0,quietMillis:300,url:function(e){return"/production/orders?nc12="+encodeURIComponent(e)},results:function(e){return{results:(e||[]).map(function(e){return{id:e._id,text:e._id+" - "+(e.name||"?"),data:e}})}}}}),e.on("change",function(s){var r=e.closest(".pressWorksheets-form-order"),i=r.next(),o=t.isLastOrderRow(r);if(!s.added&&!o){var a=r.next().next();return a.length||(a=r.prev().prev()),a.find(".pressWorksheets-form-part").select2("focus"),i.is(":visible")?i.fadeOut(function(){i.remove()}):i.remove(),r.fadeOut(function(){r.remove(),t.setUpPartValidation(),t.recalcOrderNoColumn()}),void(s.added||2!==t.$(".pressWorksheets-form-order").length||t.$id("typeChangeWarning").fadeOut())}var d=[];s.added&&Array.isArray(s.added.data.operations)&&s.added.data.operations.forEach(function(e){""!==e.workCenter&&-1!==e.laborTime&&d.push(e)});var l=r.find(".pressWorksheets-form-operation");if(t.setUpOperationSelect2(l,d.map(function(e){return{id:e.no,text:e.no+" - "+(e.name||"?")}})),d.length){var h=d[0].no,p=!0;if(t.isPaintShop()){var c=d.find(function(e){return"PAINT"===e.workCenter});c&&(h=c.no),n.get("PAINT_")?(r.find(".pressWorksheets-form-prodLine").val("PAINT_").select2("val","PAINT_"),r.find(".pressWorksheets-form-quantityDone").focus(),p=!1):(r.find(".pressWorksheets-form-prodLine").select2("focus"),p=!1)}l.select2("val",h),p&&l.select2("focus")}else l.select2("destroy"),l.select2("destroy"),l.addClass("form-control").val(""),e.select2("focus");o&&t.addOrderRow(r)})},setUpOperationSelect2:function(e,t){e.removeClass("form-control"),e.select2({openOnEnter:null,allowClear:!1,data:t||[]})},setUpProdLineSelect2:function(e,t){e.removeClass("form-control"),e.select2({width:"185px",openOnEnter:null,allowClear:!1,data:this.prodLinesData}),t&&e.select2("val",t.find(".pressWorksheets-form-prodLine").select2("val"))},isLastOrderRow:function(e){return this.$("tbody > tr:last-child").prev()[0]===e[0]},addOrderRow:function(e,t){t=!1!==t,++this.lastOrderNo;var s=this.renderPartial(f,{no:this.lastOrderNo,lossReasons:this.lossReasons,downtimeReasons:this.downtimeReasons}),r=this.renderPartial(u,{no:this.lastOrderNo,colspan:s.find("td").length});r.hide(),this.lastOrderNo>0&&t&&s.hide(),this.$(".pressWorksheets-form-prodLine:last-child").attr("required",!0),this.$(".pressWorksheets-form-quantityDone:last-child").attr("required",!0),this.isPaintShop()||(this.$(".pressWorksheets-form-startedAt:last-child").attr("required",!0),this.$(".pressWorksheets-form-finishedAt:last-child").attr("required",!0)),this.$(".pressWorksheets-form-orders > tbody").append(s).append(r),this.lastOrderNo>0&&t&&s.fadeIn(),this.setUpOrderSelect2(s.find(".pressWorksheets-form-part")),this.setUpProdLineSelect2(s.find(".pressWorksheets-form-prodLine"),e);var i=this.$id("typeChangeWarning");return t?this.lastOrderNo>0?i.fadeIn():i.fadeOut():i.toggle(this.lastOrderNo>0),t&&(this.setUpPartValidation(),this.recalcOrderNoColumn()),e&&this.copyDataFromPrevRow(e),s},copyDataFromPrevRow:function(e){var t=e.prev();t.length&&(t.hasClass("pressWorksheets-form-notes")&&(t=t.prev()),e.find(".pressWorksheets-form-prodLine").select2("val",t.find(".pressWorksheets-form-prodLine").val()),e.find(".pressWorksheets-form-startedAt").val(t.find(".pressWorksheets-form-finishedAt").val()))},setUpPartValidation:function(){var e=this.$("input.pressWorksheets-form-part");e.last().attr("required",1===e.length)},recalcOrderNoColumn:function(){this.$(".pressWorksheets-form-order").each(function(e){var s=t(this),r=s.next();s.find(".pressWorksheets-form-no").text(e+1+".");var i=e%2!=0;s.toggleClass("is-even",i),r.toggleClass("is-even",i)})},togglePaintShop:function(){var e=this.isPaintShop();this.$el.toggleClass("pressWorksheets-form-paintShop",e),this.$(".pressWorksheets-form-group-paintShop input").attr("required",e)},validateTimes:function(e){if(this.isPaintShop())this.checkPaintShopValidity();else if(e)this.checkOrderTimesValidity(e);else{var t=this;this.$(".pressWorksheets-form-startedAt").each(function(){t.checkOrderTimesValidity(this)})}},checkPaintShopValidity:function(){var e=this.$id("startedAt"),t=this.$id("finishedAt");e[0].setCustomValidity(""),t[0].setCustomValidity(""),this.checkTimesValidity(null,e,t)},checkOrderTimesValidity:function(e){var t=this.$(e).closest(".pressWorksheets-form-order"),s=t.find(".pressWorksheets-form-startedAt"),r=t.find(".pressWorksheets-form-finishedAt");s[0].setCustomValidity(""),r[0].setCustomValidity(""),s.prop("required")&&""!==s.val()&&""!==r.val()&&this.checkTimesValidity(t,s,r)},checkTimesValidity:function(e,t,i){var o=this.$id("date").val();o||(o=s.format(new Date,"YYYY-MM-DD"));var n=this.getShiftMoment().valueOf(),a=n+288e5,d=this.getTimeFromString(o,t.val(),!1),l=this.getTimeFromString(o,i.val(),!0);if(d<n||d>a)return t[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:startedAt:boundries"));if(l<n||l>a)return i[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:finishedAt:boundries"));if(l<=d)return i[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:finishedAt:gt"));var h=(l-d)/36e5;return this.countDowntimeDuration(this.isPaintShop()?null:e)>=h?i[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:finishedAt:downtime")):void 0},checkValidity:function(){if(!this.checkOverlapping)return!0;for(var e=this.el.querySelectorAll(".pressWorksheets-form-order"),t=e.length-1,s=this.$id("date").val(),r={},i=0;i<t;++i){var o=e[i],n=o.querySelector("input.pressWorksheets-form-prodLine").value;r[n]||(r[n]=[]),r[n].push({orderRowEl:o,startedAt:this.getTimeFromString(s,o.querySelector(".pressWorksheets-form-startedAt").value,!1),finishedAt:this.getTimeFromString(s,o.querySelector(".pressWorksheets-form-finishedAt").value,!1)})}var a=!0,d=this;return Object.keys(r).forEach(function(e){if(a)for(var t=r[e];t.length;)for(var s=t.shift(),i=0,o=t.length;i<o;++i){var n=t[i];if(n.startedAt>=s.startedAt&&n.startedAt<s.finishedAt||n.finishedAt>s.startedAt&&n.finishedAt<=s.finishedAt)return void(a=d.showOverlappingError(s,n));if(s.startedAt>=n.startedAt&&s.startedAt<n.finishedAt||s.finishedAt>n.startedAt&&s.finishedAt<=n.finishedAt)return void(a=d.showOverlappingError(n,s))}}),a},showOverlappingError:function(e,t){return this.$errorMessage=i.msg.show({type:"error",time:5e3,text:r("pressWorksheets","FORM:ERROR:overlapping")}),e.orderRowEl.classList.add("is-overlapping"),t.orderRowEl.classList.add("is-overlapping"),this.timers.removeIsOverlapping=setTimeout(this.removeIsOverlapping.bind(this),5e3),this.$(".btn-danger").fadeIn(),!1},removeIsOverlapping:function(){this.timers.removeIsOverlapping&&(clearTimeout(this.timers.removeIsOverlapping),this.timers.removeIsOverlapping=null),this.$(".is-overlapping").removeClass("is-overlapping"),this.$(".btn-danger").fadeOut()},countDowntimeDuration:function(e){var t=0;return(e||this.$el).find(".pressWorksheets-form-count.is-downtime").each(function(){var e=parseInt(this.value,10);t+=isNaN(e)||e<=0?0:e}),t/60},getTimeFromString:function(e,t,r){var i=s.getMoment(e+" "+t+":00","YYYY-MM-DD HH:mm:ss");return r&&6===i.hours()&&0===i.minutes()&&i.hours(5).minutes(59).seconds(59).milliseconds(999),i.hours()<6&&i.add(1,"days"),i.valueOf()},serializeToForm:function(){return{type:this.model.get("type")}},fillModelData:function(){this.filling=!0,this.fillPersonnel(),this.fillDateAndTimes();var e=this.model.get("orders");Array.isArray(e)&&e.length&&e.forEach(this.fillOrder,this),this.filling=!1},fillType:function(){this.$("input[name=type][value="+this.model.get("type")+"]").trigger("click",!0)},fillPersonnel:function(){var e=this.model.get("operators"),t=this.model.get("operator"),s=this.model.get("master");function r(e){return{id:e.id,text:e.label}}Array.isArray(e)&&e.length&&this.$id("operators").select2("data",e.map(r)),t&&this.$id("operator").select2("data",r(t)),s&&this.$id("master").select2("data",r(s))},fillDateAndTimes:function(){this.$id("date").val(s.format(this.model.get("date"),"YYYY-MM-DD")),this.$("input[name=shift][value="+this.model.get("shift")+"]").click(),"paintShop"===this.model.get("type")&&(this.$id("startedAt").val(this.model.get("startedAt")),this.$id("finishedAt").val(this.model.get("finishedAt")))},fillOrder:function(t){var r=this.addOrderRow(null,!1),i=r.find(".pressWorksheets-form-part"),o=r.find(".pressWorksheets-form-operation");if(i.attr("data-prodShiftOrder",t.prodShiftOrder).select2("data",{id:t.nc12,text:t.nc12+" - "+(t.name||"?"),data:t.orderData}),this.setUpOperationSelect2(o,e.map(t.orderData.operations,function(e){return{id:e.no,text:e.no+" - "+(e.name||"?")}})),o.select2("val",t.operationNo),r.find(".pressWorksheets-form-prodLine").select2("val",t.prodLine),r.find(".pressWorksheets-form-quantityDone").val(t.quantityDone),Array.isArray(t.losses)&&t.losses.forEach(this.fillLoss.bind(this,r)),Array.isArray(t.downtimes)&&t.downtimes.forEach(this.fillDowntime.bind(this,r)),!this.isPaintShop()){var n=t.opWorkDuration>0?s.toString(3600*t.opWorkDuration,!0).split(":").slice(0,2).join(":"):"";r.find('input[name$="startedAt"]').val(t.startedAt),r.find('input[name$="finishedAt"]').val(t.finishedAt),r.find('input[name$="opWorkDuration"]').val(n)}t.notes&&r.next().show().find("textarea").val(t.notes)},fillLoss:function(e,t){e.find('.is-loss[data-reason="'+t.reason+'"]').val(t.count)},fillDowntime:function(e,t){e.find('.is-downtime[data-reason="'+t.reason+'"]').attr("data-prodDowntime",t.prodDowntime).val(t.duration)},toggleExistingWarning:function(){var e=this.$id("existingWarning");this.existingWorksheets.length?e.html(r("pressWorksheets","FORM:existingWarning",{count:this.existingWorksheets.length,links:this.existingWorksheets.map(function(e){return'<a href="'+e.genClientUrl()+'">'+e.getLabel()+"</a>"}).join(", ")})).fadeIn():e.fadeOut()},checkForExistingWorksheet:function(){var e=s.getMoment(this.$id("date").val()+" 06:00:00","YYYY-MM-DD HH:mm:ss").toDate(),t=parseInt(this.$("input[name=shift]:checked").val(),10),r=this.$id("operator").val(),i=this.$id("existingWarning");if(isNaN(e.getTime())||!t||!r.length)return i.fadeOut();2===t?e.setHours(14):3===t&&e.setHours(22);var o=this.existingWorksheets.rqlQuery.selector;o.args=[{name:"eq",args:["date",e.getTime()]},{name:"eq",args:["operators.id",r]}],this.model.id&&o.args.push({name:"ne",args:["_id",this.model.id]}),this.promised(this.existingWorksheets.fetch({reset:!0}))},onKeyDown:function(e){e.altKey&&13===e.keyCode&&this.$(".pressWorksheets-form-order").last().find(".pressWorksheets-form-part").select2("focus")},calcOpWorkDuration:function(t){var r=this.$(t).closest(".pressWorksheets-form-order"),i=r.find('input[name$=".opWorkDuration"]'),o=r.find('input[name$=".part"]').select2("data"),n=r.find('input[name$=".operation"]').select2("data"),a=parseInt(r.find('input[name$=".quantityDone"]').val(),10);if(o&&n&&a){var d=e.find(o.data.operations,function(e){return e.no===n.id});if(d&&d.laborTime.toFixed(3)!==d.machineTime.toFixed(3)){var l=Math.round(d.laborTime/100*a*3600),h=s.toString(l,!0,!1).split(":");h.pop();var p=h.join(":");i.val(p)}else i.val("")}else i.val("")},generateAutoOrders:async function(t){var s=this.getShiftMoment().utc(!0).valueOf();if(!s)return void this.$id("startedAt").focus();var r=await fetch(`/paintShop/orders?select(workOrders)&limit(0)&workOrders.shift=${s}`),o=await r.json();if(!o.totalCount)return void i.msg.show({type:"warning",time:2500,text:this.t("FORM:autoOrders:noWorkOrders")});var a={},d={};o.collection.forEach(e=>{e.workOrders.forEach(e=>{Date.parse(e.shift)===s&&(a[e.childOrder]||(a[e.childOrder]={_id:e.childOrder,nc12:"",operations:[],workOrders:[],prevWorkOrders:[]}),a[e.childOrder].workOrders.push(e),e.workers.forEach(e=>{d[e.id]={id:e.id,text:e.label}}))})});var l=Object.keys(a),h=await fetch("/paintShop/orders?select(workOrders)&limit(0)"+`&childOrders.order=in=(${l})&workOrders.shift<${s}`);(await h.json()).collection.forEach(e=>{e.workOrders.forEach(e=>{!a[e.childOrder]||Date.parse(e.shift)>=s||a[e.childOrder].prevWorkOrders.push(e)})});var p=await fetch(`/orders?select(nc12,operations)&_id=in=(${l})`);(await p.json()).collection.forEach(e=>{var t=a[e._id];t.nc12=e.nc12;var s=[];e.operations.forEach(e=>{"PAINT"===e.workCenter?(t.operations.length&&(s=[]),e.qtyDone=0,e.related=s,t.operations.push(e)):s.push(e)})});const c={};l.forEach(e=>{var t=a[e];if(t.nc12&&t.operations.length){c[t.nc12]||(c[t.nc12]={});var s=c[t.nc12];t.operations.forEach(e=>{s[e.no]||(s[e.no]={qtyDone:0,related:e.related})}),t.prevWorkOrders.length&&v(t,t.prevWorkOrders,null),v(t,t.workOrders,s)}});var f=Object.keys(c),u=await fetch(`/production/orders?nc12=${f}`),g={};(await u.json()).forEach(e=>{e.nc12=e._id,delete e._id,g[e.nc12]=e});var k=this.getFormData();k.operators.forEach(e=>{d[e.id]={id:e.id,text:e.label}}),this.$id("operators").select2("data",Object.values(d).sort((e,t)=>e.text.localeCompare(t.text)));var O={};k.orders.forEach(e=>{var t=`${e.nc12}:${e.operationNo}`;O[t]||(O[t]=e)}),this.renderOrdersTable();var y=n.get(m[t]);if(y){var W=y.getSubdivision();f.forEach(s=>{var r=g[s];Object.keys(c[s]).forEach(i=>{var{qtyDone:o,related:n}=c[s][i];if(o){var a=[];"PAINT"===t?a.push(e.find(r.operations,e=>e.no===i)):n.forEach(e=>a.push(e)),a.forEach(e=>{if(e){var t=O[`${s}:${e.no}`],i={prodShiftOrder:null,division:W?W.get("division"):null,prodLine:y.id,nc12:s,name:r.name,operationNo:e.no,operationName:e.name,orderData:r,quantityDone:o,startedAt:null,finishedAt:null,opWorkDuration:0,losses:t?t.losses:[],downtimes:t?t.downtimes:[],notes:t?t.notes:""};this.fillOrder(i)}})}})}),this.addOrderRow()}else this.addOrderRow()}});function v(e,t,s){var r=[].concat(e.operations);t.forEach(e=>{for(;r.length;){var t=r[0],i=t.qty-t.qtyDone;if(i<=0)r.shift();else{if(!(e.qtyDone>i)){s&&(s[t.no].qtyDone+=e.qtyDone),t.qtyDone+=e.qtyDone,e.qtyDone=0;break}s&&(s[t.no].qtyDone+=i),t.qtyDone+=i,e.qtyDone-=i,r.shift()}}});var i=0;t.forEach(e=>{i+=e.qtyDone});var o=Math.ceil(i/e.operations.length);e.operations.forEach(e=>{s&&(s[e.no].qtyDone+=o),e.qtyDone+=o,(i-=o)<0&&(e.qtyDone+=i,s&&(s[e.no].qtyDone+=i))})}});