define(["underscore","jquery","app/time","app/i18n","app/viewport","app/data/downtimeReasons","app/data/prodLines","app/core/Model","app/core/views/FormView","app/pressWorksheets/templates/form","app/pressWorksheets/templates/orderRow"],function(e,t,n,r,i,o,a,s,l,u,d){var c={cache:!0,quietMillis:500,url:function(e){return"/users?select(lastName,firstName)&sort(lastName,firstName)&limit(20)&regex(lastName,"+encodeURIComponent("^"+e)+",i)"},results:function(e){return{results:(e.collection||[]).map(function(e){return{id:e._id,text:e.lastName+" "+e.firstName}})}}};return l.extend({template:u,idPrefix:"pressWorksheetForm",events:{submit:"submitForm","blur .pressWorksheets-form-time":function(e){var t=e.target.value.trim().replace(/[^0-9: \-]+/g,""),n=t.match(/^([0-9]+)(?::| +|\-)+([0-9]+)$/),r=0,i=0;n?(r=parseInt(n[1],10),i=parseInt(n[2],10)):4===t.length?(r=parseInt(t.substr(0,2),10),i=parseInt(t.substr(2),10)):3===t.length?(r=parseInt(t[0],10),i=parseInt(t.substr(1),10)):i=parseInt(t,10),(isNaN(r)||r>=24)&&(r=0),(isNaN(i)||i>=60)&&(i=0),e.target.value=(10>r?"0":"")+r.toString(10)+":"+(10>i?"0":"")+i.toString(10)},"blur .pressWorksheets-form-count":function(e){var t=parseInt(e.target.value,10);e.target.value=isNaN(t)?"":t},"blur .pressWorksheets-form-quantityDone":function(e){var t=parseInt(e.target.value,10);e.target.value=isNaN(t)||0>t?0:t},"focus input":function(e){e.target.classList.contains("select2-focusser")&&e.target.parentNode.classList.contains("pressWorksheets-form-part")?this.$(".table-responsive").prop("scrollLeft",0):e.target.classList.contains("pressWorksheets-form-time")&&e.target.parentNode.classList.contains("form-group")&&(this.paintShopTimeFocused=!0)},"change input[name=shift]":"validateShiftStartTime","change input[name=date]":"validateShiftStartTime","change input[name=paintShop]":function(e){this.$el.toggleClass("pressWorksheets-form-paintShop",e.target.checked)}},initialize:function(){l.prototype.initialize.apply(this,arguments),this.lastOrderNo=-1,this.lossReasons=[],this.paintShopTimeFocused=!1,this.downtimeReasons=o.filter(function(e){return e.get("pressPosition")>=0}).map(function(e){return e.toJSON()}).sort(function(e,t){return e.pressPosition-t.pressPosition})},beforeRender:function(){this.lossReasons=this.model.lossReasons.toJSON()},afterRender:function(){l.prototype.afterRender.call(this),this.prodLinesData=a.filter(function(e){var t=e.getSubdivision();return t&&"press"===t.get("type")}).map(function(e){return{id:e.id,text:e.id}});var e=this.$id("operators").select2({width:"100%",allowClear:!0,multiple:!0,minimumInputLength:3,ajax:c}),t=this.$id("operator").select2({width:"100%",allowClear:!0,minimumInputLength:3,ajax:c});this.$id("master").select2({width:"100%",allowClear:!0,minimumInputLength:3,ajax:c}),this.addOrderRow(),e.on("change",function(){t.select2("data")||t.select2("data",e.select2("data")[0])}),this.$id("paintShop").focus()},serialize:function(){return e.extend(l.prototype.serialize.call(this),{rowspan:this.lossReasons.length||this.downtimeReasons.length?2:0,lossReasons:this.lossReasons,downtimeReasons:this.downtimeReasons})},serializeForm:function(e){function t(e){return{id:e.id,label:e.text}}var n=this.$(".pressWorksheets-form-order");return e.orders=(e.orders||[]).filter(function(e){return e.part&&e.part.length&&e.operation&&e.operation.length}).map(this.serializeOrder.bind(this,n,this.model.lossReasons)),e.operators=this.$id("operators").select2("data").map(t),e.operator=t(this.$id("operator").select2("data")),e.master=t(this.$id("master").select2("data")),e.shift=parseInt(e.shift,10),e},serializeOrder:function(t,n,r,i){var a=t.eq(i),s=a.find(".pressWorksheets-form-part").select2("data").data,l=e.find(s.operations,function(e){return e.no===r.operation}),u=[];r.losses&&Object.keys(r.losses).forEach(function(e){e=n.get(e),r.losses[e.id]>0&&u.push({_id:e.id,label:e.get("label"),count:r.losses[e.id]})});var d=[];return r.downtimes&&Object.keys(r.downtimes).forEach(function(e){e=o.get(e),r.downtimes[e.id]>0&&d.push({_id:e.id,label:e.get("label"),count:r.downtimes[e.id]})}),{prodLine:r.prodLine,nc12:s._id,name:s.name,operationNo:l.no,operationName:l.name,orderData:s,quantityDone:r.quantityDone,startedAt:r.startedAt||null,finishedAt:r.finishedAt||null,losses:u,downtimes:d}},validateShiftStartTime:function(){var e=this.$id("date"),t=this.getShiftMoment();if(e[0].setCustomValidity(t.valueOf()>Date.now()?r("pressWorksheets","FORM:ERROR:date"):""),this.$id("paintShop")[0].checked){var n=this.$id("startedAt"),i=this.$id("finishedAt");if(!t.isValid())return;this.paintShopTimeFocused||(n.val(t.format("HH:mm")),i.val(t.add("hours",8).format("HH:mm")))}},getShiftMoment:function(){var e=this.$id("date"),t=parseInt(this.$("input[name=shift]:checked").val(),10);return n.getMoment(e.val()).hours(6).add("h",8*(t-1))},checkValidity:function(e){var t=this.$id("paintShop")[0].checked;if(t&&!this.checkPaintShopValidity())return!1;if(0===e.orders.length)return this.showOrderFieldError(0,"part"),!1;var n=this;return!e.orders.some(function(e,r){return e.prodLine&&e.prodLine.length?isNaN(parseInt(e.quantityDone,10))?n.showOrderFieldError(r,"quantityDone"):t||e.startedAt&&e.startedAt.length?t||e.finishedAt&&e.finishedAt.length?!1:n.showOrderFieldError(r,"finishedAt"):n.showOrderFieldError(r,"startedAt"):n.showOrderFieldError(r,"prodLine")})},getTimeFromString:function(e,t,r){var i=n.getMoment(e+" "+t+":00");return r&&6===i.hours()&&0===i.minutes()&&i.hours(5).minutes(59).seconds(59).milliseconds(999),i.hours()<6&&i.add("days",1),i.valueOf()},checkPaintShopValidity:function(){var e=this.$id("startedAt"),t=this.$id("finishedAt");if(""===e.val().trim())return this.showFieldError(e,"startedAt");if(""===t.val().trim())return this.showFieldError(t,"finishedAt");var n=this.getShiftMoment(),r=n.valueOf(),i=r+288e5,o=this.$id("date").val(),a=this.getTimeFromString(o,e.val(),!1),s=this.getTimeFromString(o,t.val(),!0);return r>a||a>i?this.showFieldError(e,"startedAt:boundries"):r>s||s>i?this.showFieldError(t,"finishedAt:boundries"):a>=s?this.showFieldError(t,"finishedAt:gt"):!0},showFieldError:function(e,t){return e.hasClass("select2-offscreen")?e.select2("focus"):e.focus(),this.$errorMessage=i.msg.show({type:"error",time:3e3,text:r("pressWorksheets","FORM:ERROR:"+t)}),!1},showOrderFieldError:function(e,t){var n=this.$(".pressWorksheets-form-order").eq(e).find(".pressWorksheets-form-"+t);return this.showFieldError(n,t),!0},setUpOrderSelect2:function(e){var t=this;e.removeClass("form-control"),e.select2({allowClear:!0,minimumInputLength:3,ajax:{cache:!0,quietMillis:500,url:function(e){return"/production/orders?nc12="+encodeURIComponent(e)},results:function(e){return{results:(e||[]).map(function(e){return{id:e._id,text:e._id+" - "+(e.name||"?"),data:e}})}}}}),e.on("change",function(n){var r=e.closest(".pressWorksheets-form-order"),i=t.isLastOrderRow(r);if(!n.added&&!i)return(r.next()||r.prev()).find(".pressWorksheets-form-part").select2("focus"),r.fadeOut(function(){r.remove()}),void 0;var o=n.added&&Array.isArray(n.added.data.operations)?n.added.data.operations:[],a=r.find(".pressWorksheets-form-operation");t.setUpOperationSelect2(a,o.map(function(e){return{id:e.no,text:e.no+" - "+e.name}})),o.length?a.select2("val",o[0].no).select2("focus"):(a.select2("destroy"),a.select2("destroy"),a.addClass("form-control").val(""),e.select2("focus")),i&&t.addOrderRow(r)})},setUpOperationSelect2:function(e,t){e.removeClass("form-control"),e.select2({openOnEnter:null,allowClear:!1,data:t||[]})},setUpProdLineSelect2:function(e,t){e.removeClass("form-control"),e.select2({width:"185px",openOnEnter:null,allowClear:!1,data:this.prodLinesData}),t&&e.select2("val",t.find(".pressWorksheets-form-prodLine").select2("val"))},isLastOrderRow:function(e){return this.$(".pressWorksheets-form-order:last-child")[0]===e[0]},addOrderRow:function(e){++this.lastOrderNo;var n=t(d({no:this.lastOrderNo,lossReasons:this.lossReasons,downtimeReasons:this.downtimeReasons}));this.lastOrderNo>0&&n.hide(),this.$(".pressWorksheets-form-orders > tbody").append(n),this.lastOrderNo>0&&n.fadeIn(),this.setUpOrderSelect2(n.find(".pressWorksheets-form-part")),this.setUpProdLineSelect2(n.find(".pressWorksheets-form-prodLine"),e)}})});