define(["underscore","jquery","app/time","app/i18n","app/viewport","app/data/downtimeReasons","app/data/prodLines","app/core/Model","app/core/views/FormView","app/pressWorksheets/templates/form","app/pressWorksheets/templates/ordersTable","app/pressWorksheets/templates/ordersTableRow"],function(e,t,s,r,i,o,a,n,d,l,h,p){var u={cache:!0,quietMillis:500,url:function(e){return"/users?select(lastName,firstName)&sort(lastName,firstName)&limit(20)&regex(lastName,"+encodeURIComponent("^"+e)+",i)"},results:function(e){return{results:(e.collection||[]).map(function(e){return{id:e._id,text:e.lastName+" "+e.firstName}})}}};return d.extend({template:l,idPrefix:"pressWorksheetForm",events:{keydown:function(e){return 13===e.keyCode?!1:void 0},submit:function(e){return this.removeIsOverlapping(),this.submitForm(e)},"blur .pressWorksheets-form-time":function(e){var t=e.target.value.trim().replace(/[^0-9: \-]+/g,"");if(0!==t.length){var s=t.match(/^([0-9]+)(?::| +|\-)+([0-9]+)$/),r=0,i=0;s?(r=parseInt(s[1],10),i=parseInt(s[2],10)):4===t.length?(r=parseInt(t.substr(0,2),10),i=parseInt(t.substr(2),10)):3===t.length?(r=parseInt(t[0],10),i=parseInt(t.substr(1),10)):i=parseInt(t,10);var o=isNaN(r)||r>=24,a=isNaN(i)||i>=60;o&&(r=0),a&&(i=0),e.target.value=(10>r?"0":"")+r.toString(10)+":"+(10>i?"0":"")+i.toString(10),this.validateTimes(e.target)}},"blur .pressWorksheets-form-count":function(e){var t=parseInt(e.target.value,10);e.target.value=isNaN(t)?"":t,e.target.classList.contains("is-downtime")&&this.validateTimes(e.target)},"blur .pressWorksheets-form-quantityDone":function(e){var t=parseInt(e.target.value,10);e.target.value=isNaN(t)||0>t?"":t},"focus input":function(e){e.target.classList.contains("select2-focusser")&&e.target.parentNode.classList.contains("pressWorksheets-form-part")?this.$(".table-responsive").prop("scrollLeft",0):e.target.classList.contains("pressWorksheets-form-time")&&e.target.parentNode.classList.contains("form-group")&&(this.paintShopTimeFocused=!0)},"focus .pressWorksheets-form-order input":function(e){var t=this.$(e.target);t.closest("td").addClass("is-focused"),t.hasClass("select2-focusser")&&(t=t.parent().next(".select2-offscreen")),t[0].dataset.column&&this.$('th[data-column="'+t[0].dataset.column+'"]').addClass("is-focused")},"blur .pressWorksheets-form-order input":function(e){this.$(e.target).closest("td").removeClass("is-focused"),this.$("th.is-focused").removeClass("is-focused")},"change input[name=shift]":function(){this.checkShiftStartTimeValidity(),this.validateTimes(null)},"change input[name=date]":"checkShiftStartTimeValidity","change input[name=type]":function(){this.togglePaintShop(),this.renderOrdersTable(),this.addOrderRow()}},initialize:function(){d.prototype.initialize.apply(this,arguments),this.lastOrderNo=-1,this.lossReasons=[],this.downtimeReasons=[],this.paintShopTimeFocused=!1},destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},afterRender:function(){d.prototype.afterRender.call(this),this.prodLinesData=a.filter(function(e){var t=e.getSubdivision();return t&&"press"===t.get("type")}).map(function(e){return{id:e.id,text:e.id}});var e=this.$id("operators").select2({width:"100%",allowClear:!0,multiple:!0,minimumInputLength:3,ajax:u});e.on("change",function(){t.select2("data")||t.select2("data",e.select2("data")[0])});var t=this.$id("operator").select2({width:"100%",allowClear:!0,minimumInputLength:3,ajax:u});this.$id("master").select2({width:"100%",allowClear:!0,minimumInputLength:3,ajax:u}),this.renderOrdersTable(),this.addOrderRow(),this.$id("type").focus()},renderOrdersTable:function(){var e="optics"===this.getType(),t=e?"opticsPosition":"pressPosition";this.lossReasons=e?[]:this.model.lossReasons.toJSON(),this.downtimeReasons=o.filter(function(e){return e.get(t)>=0}).map(function(e){return e.toJSON()}).sort(function(e,s){return e[t]-s[t]}),this.lastOrderNo=-1,this.$id("ordersTable").html(h({rowspan:this.lossReasons.length||this.downtimeReasons.length?2:0,lossReasons:this.lossReasons,downtimeReasons:this.downtimeReasons}))},serializeForm:function(e){function t(e){return{id:e.id,label:e.text}}var s=this.$(".pressWorksheets-form-order");return e.orders=(e.orders||[]).filter(function(e){return e.part&&e.part.length&&e.operation&&e.operation.length}).map(this.serializeOrder.bind(this,s,this.model.lossReasons)),e.operators=this.$id("operators").select2("data").map(t),e.operator=t(this.$id("operator").select2("data")),e.master=t(this.$id("master").select2("data")),e.shift=parseInt(e.shift,10),e},serializeOrder:function(t,s,r,i){var a=t.eq(i),n=a.find(".pressWorksheets-form-part").select2("data").data;n._id&&(n.nc12=n._id,delete n._id);var d=e.find(n.operations,function(e){return e.no===r.operation}),l=[];r.losses&&Object.keys(r.losses).forEach(function(e){e=s.get(e),r.losses[e.id]>0&&l.push({reason:e.id,label:e.get("label"),count:parseInt(r.losses[e.id],10)})});var h=[];return r.downtimes&&Object.keys(r.downtimes).forEach(function(e){e=o.get(e),r.downtimes[e.id]>0&&h.push({prodDowntime:null,reason:e.id,label:e.get("label"),duration:parseInt(r.downtimes[e.id],10)})}),{prodShiftOrder:null,prodLine:r.prodLine,nc12:n.nc12,name:n.name,operationNo:d.no,operationName:d.name,orderData:n,quantityDone:r.quantityDone,startedAt:r.startedAt||null,finishedAt:r.finishedAt||null,losses:l,downtimes:h}},checkShiftStartTimeValidity:function(){var e=this.$id("date"),t=this.getShiftMoment();if(e[0].setCustomValidity(t.valueOf()>Date.now()?r("pressWorksheets","FORM:ERROR:date"):""),this.isPaintShop()){var s=this.$id("startedAt"),i=this.$id("finishedAt");if(!t.isValid())return;this.paintShopTimeFocused||(s.val(t.format("HH:mm")),i.val(t.add("hours",8).format("HH:mm")))}},getShiftMoment:function(){var e=this.$id("date"),t=parseInt(this.$("input[name=shift]:checked").val(),10);return s.getMoment(e.val()+" 06:00:00").add("h",8*(t-1))},getType:function(){return this.$("input[name=type]:checked").val()},isPaintShop:function(){return"paintShop"===this.getType()},showFieldError:function(e,t){return e.hasClass("select2-offscreen")?e.select2("focus"):e.focus(),this.$errorMessage=i.msg.show({type:"error",time:3e3,text:r("pressWorksheets","FORM:ERROR:"+t)}),!1},setUpOrderSelect2:function(e){var t=this;e.removeClass("form-control"),e.select2({allowClear:!0,minimumInputLength:6,ajax:{cache:!0,quietMillis:300,url:function(e){return"/production/orders?nc12="+encodeURIComponent(e)},results:function(e){return{results:(e||[]).map(function(e){return{id:e._id,text:e._id+" - "+(e.name||"?"),data:e}})}}}}),e.on("change",function(s){var r=e.closest(".pressWorksheets-form-order"),i=t.isLastOrderRow(r);if(!s.added&&!i)return(r.next()||r.prev()).find(".pressWorksheets-form-part").select2("focus"),r.fadeOut(function(){r.remove(),t.setUpPartValidation(),t.recalcOrderNoColumn()}),void(s.added||2!==t.$(".pressWorksheets-form-order").length||t.$(".message-warning").fadeOut());var o=s.added&&Array.isArray(s.added.data.operations)?s.added.data.operations:[],a=r.find(".pressWorksheets-form-operation");t.setUpOperationSelect2(a,o.map(function(e){return{id:e.no,text:e.no+" - "+e.name}})),o.length?a.select2("val",o[0].no).select2("focus"):(a.select2("destroy"),a.select2("destroy"),a.addClass("form-control").val(""),e.select2("focus")),i&&t.addOrderRow(r)})},setUpOperationSelect2:function(e,t){e.removeClass("form-control"),e.select2({openOnEnter:null,allowClear:!1,data:t||[]})},setUpProdLineSelect2:function(e,t){e.removeClass("form-control"),e.select2({width:"185px",openOnEnter:null,allowClear:!1,data:this.prodLinesData}),t&&e.select2("val",t.find(".pressWorksheets-form-prodLine").select2("val"))},isLastOrderRow:function(e){return this.$(".pressWorksheets-form-order:last-child")[0]===e[0]},addOrderRow:function(e){++this.lastOrderNo;var s=t(p({no:this.lastOrderNo,lossReasons:this.lossReasons,downtimeReasons:this.downtimeReasons}));this.lastOrderNo>0&&s.hide(),this.$(".pressWorksheets-form-prodLine:last-child").attr("required",!0),this.$(".pressWorksheets-form-quantityDone:last-child").attr("required",!0),this.isPaintShop()||(this.$(".pressWorksheets-form-startedAt:last-child").attr("required",!0),this.$(".pressWorksheets-form-finishedAt:last-child").attr("required",!0)),this.$(".pressWorksheets-form-orders > tbody").append(s),this.lastOrderNo>0&&s.fadeIn(),this.setUpOrderSelect2(s.find(".pressWorksheets-form-part")),this.setUpProdLineSelect2(s.find(".pressWorksheets-form-prodLine"),e);var r=this.$(".message-warning");this.lastOrderNo>0?r.fadeIn():r.fadeOut(),this.setUpPartValidation(),this.recalcOrderNoColumn()},setUpPartValidation:function(){var e=this.$("input.pressWorksheets-form-part");e.last().attr("required",1===e.length)},recalcOrderNoColumn:function(){this.$(".pressWorksheets-form-order > td:first-child").each(function(e){this.innerHTML=e+1+"."})},togglePaintShop:function(){var e=this.isPaintShop();this.$el.toggleClass("pressWorksheets-form-paintShop",e),this.$(".pressWorksheets-form-group-paintShop input").attr("required",e)},validateTimes:function(e){if(this.isPaintShop())this.checkPaintShopValidity();else if(e)this.checkOrderTimesValidity(e);else{var t=this;this.$(".pressWorksheets-form-startedAt").each(function(){t.checkOrderTimesValidity(this)})}},checkPaintShopValidity:function(){var e=this.$id("startedAt"),t=this.$id("finishedAt");e[0].setCustomValidity(""),t[0].setCustomValidity(""),this.checkTimesValidity(null,e,t)},checkOrderTimesValidity:function(e){var t=this.$(e).closest(".pressWorksheets-form-order"),s=t.find(".pressWorksheets-form-startedAt"),r=t.find(".pressWorksheets-form-finishedAt");s[0].setCustomValidity(""),r[0].setCustomValidity(""),s.prop("required")&&""!==s.val()&&""!==r.val()&&this.checkTimesValidity(t,s,r)},checkTimesValidity:function(e,t,i){var o=this.$id("date").val();o||(o=s.format(new Date,"YYYY-MM-DD"));var a=this.getShiftMoment(),n=a.valueOf(),d=n+288e5,l=this.getTimeFromString(o,t.val(),!1),h=this.getTimeFromString(o,i.val(),!0);if(n>l||l>d)return t[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:startedAt:boundries"));if(n>h||h>d)return i[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:finishedAt:boundries"));if(l>=h)return i[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:finishedAt:gt"));var p=(h-l)/36e5,u=this.countDowntimeDuration(this.isPaintShop()?null:e);return u>=p?i[0].setCustomValidity(r("pressWorksheets","FORM:ERROR:finishedAt:downtime")):void 0},checkValidity:function(){for(var e=this.el.querySelectorAll(".pressWorksheets-form-order"),t=e.length-1,s=this.$id("date").val(),r={},i=0;t>i;++i){var o=e[i],a=o.querySelector("input.pressWorksheets-form-prodLine").value;r[a]||(r[a]=[]),r[a].push({orderRowEl:o,startedAt:this.getTimeFromString(s,o.querySelector(".pressWorksheets-form-startedAt").value,!1),finishedAt:this.getTimeFromString(s,o.querySelector(".pressWorksheets-form-finishedAt").value,!1)})}var n=!0,d=this;return Object.keys(r).forEach(function(e){if(n)for(var t=r[e];t.length;)for(var s=t.shift(),i=0,o=t.length;o>i;++i){var a=t[i];if(a.startedAt>=s.startedAt&&a.startedAt<s.finishedAt||a.finishedAt>s.startedAt&&a.finishedAt<=s.finishedAt)return void(n=d.showOverlappingError(s,a));if(s.startedAt>=a.startedAt&&s.startedAt<a.finishedAt||s.finishedAt>a.startedAt&&s.finishedAt<=a.finishedAt)return void(n=d.showOverlappingError(a,s))}}),n},showOverlappingError:function(e,t){return this.$errorMessage=i.msg.show({type:"error",time:5e3,text:r("pressWorksheets","FORM:ERROR:overlapping")}),e.orderRowEl.classList.add("is-overlapping"),t.orderRowEl.classList.add("is-overlapping"),this.timers.removeIsOverlapping=setTimeout(this.removeIsOverlapping.bind(this),5e3),!1},removeIsOverlapping:function(){this.timers.removeIsOverlapping&&(clearTimeout(this.timers.removeIsOverlapping),this.timers.removeIsOverlapping=null),this.$(".is-overlapping").removeClass("is-overlapping")},countDowntimeDuration:function(e){var t=0;return(e||this.$el).find(".pressWorksheets-form-count.is-downtime").each(function(){var e=parseInt(this.value,10);t+=isNaN(e)||0>=e?0:e}),t/60},getTimeFromString:function(e,t,r){var i=s.getMoment(e+" "+t+":00");return r&&6===i.hours()&&0===i.minutes()&&i.hours(5).minutes(59).seconds(59).milliseconds(999),i.hours()<6&&i.add("days",1),i.valueOf()}})});