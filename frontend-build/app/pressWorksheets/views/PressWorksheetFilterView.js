define(["underscore","js2form","app/i18n","app/user","app/time","app/core/Model","app/core/View","app/users/util/setUpUserSelect2","app/pressWorksheets/templates/filter"],function(e,t,i,s,r,a,n,u,l){return n.extend({template:l,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("pressWorksheetsFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();t(this.el.querySelector(".filter-form"),e),this.toggleButtonGroup("shift"),this.toggleButtonGroup("type"),this.toggleButtonGroup("mine"),u(this.$id("user")).select2("data",null===e.user.id?null:e.user)},toggleButtonGroup:function(e){this.$id(e).find("input:checked").parent().addClass("active")},serializeRqlQuery:function(){var e=this.model.rqlQuery,t={date:"",shift:0,type:"any",limit:e.limit<5?5:e.limit>100?100:e.limit,mine:!1,userType:"operators",user:{id:null,text:null}},i=this;return e.selector.args.forEach(function(e){if("eq"===e.name||"in"===e.name){var s=e.args[0];switch(s){case"date":if("in"===e.name)t.date=r.format(e.args[1][0],"YYYY-MM-DD");else{var a=r.getMoment(e.args[1]);t.date=a.format("YYYY-MM-DD"),t.shift=i.getShiftNoFromMoment(a)}break;case"shift":case"type":case"mine":t[s]=e.args[1];break;case"master.id":case"operator.id":case"operators.id":t.userType=s.split(".")[0],t.user.id=e.args[1],null===t.user.text&&(t.user.text=e.args[1]);break;case"user":t.user.text=e.args[1]}}}),t},changeFilter:function(){var e=this.model.rqlQuery,t=[],i=r.getMoment(this.$id("date").val()),s=parseInt(this.$("input[name=shift]:checked").val(),10),a=this.$("input[name=type]:checked").val(),n=this.$("input[name=mine]:checked").val(),u=this.$("input[name=userType]:checked").val(),l=this.$id("user").select2("data");if(this.setHoursByShiftNo(i,s),i.isValid())if(0===s){var o=i.valueOf();t.push({name:"in",args:["date",[o+216e5,o+504e5,o+792e5]]})}else t.push({name:"eq",args:["date",i.valueOf()]});else 0!==s&&t.push({name:"eq",args:["shift",s]});"any"!==a&&t.push({name:"eq",args:["type",a]}),l&&(t.push({name:"eq",args:[u+".id",l.id]}),t.push({name:"eq",args:["user",l.text]})),n?(t.push({name:"eq",args:["mine",1]}),e.sort={createdAt:-1}):e.sort={date:-1},e.selector={name:"and",args:t},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},getShiftNoFromMoment:function(e){var t=e.hours();return 6===t?1:14===t?2:22===t?3:0},setHoursByShiftNo:function(e,t){e.hours(1===t?6:2===t?14:3===t?22:0)}})});