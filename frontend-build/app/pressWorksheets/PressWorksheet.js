define(["underscore","../i18n","../time","../core/Model","../core/util/getShiftStartInfo"],function(r,e,t,o,s){"use strict";function n(r){return r&&r.label?r.label:null}return o.extend({urlRoot:"/pressWorksheets",clientUrlRoot:"#pressWorksheets",topicPrefix:"pressWorksheets",privilegePrefix:"PRESS_WORKSHEETS",nlsDomain:"pressWorksheets",labelAttribute:"rid",defaults:function(){var r=s(Date.now());return{rid:null,date:t.format(r.moment.valueOf(),"YYYY-MM-DD"),shift:r.no,type:"mech",divisions:[],prodLines:[],startedAt:null,finishedAt:null,master:null,operator:null,operators:null,orders:null,createdAt:null,creator:null}},serialize:function(){var r=this.toJSON();return r.date=t.format(r.date,"LL"),r.shift=e("core","SHIFT:"+r.shift),r.master=n(r.master),r.operator=n(r.operator),r.operators=(r.operators||[]).map(n).filter(function(r){return!!r}),r.creator=n(r.creator),r.createdAt=r.createdAt?t.format(r.createdAt,"LLLL"):null,r.losses=this.hasAnyLosses(),r.machineManHours=0,r.orders&&(r.orders=this.constructor.serializeOrders(r.orders,r)),Array.isArray(r.divisions)&&(r.divisions=r.divisions.join("; ")),Array.isArray(r.prodLines)&&(r.prodLines=r.prodLines.join("; ")),r.type=e("pressWorksheets","PROPERTY:type:"+r.type),r},hasAnyLosses:function(){for(var r=this.get("orders")||[],e=0;e<r.length;++e){var t=r[e];if(Array.isArray(t.losses)&&t.losses.length)return!0}return!1}},{serializeOrders:function(e,o){var s=e.length&&e[0].startedAt.length>5;return e.map(function(e){e=r.clone(e);var n=t.getMoment(e.startedAt,s?void 0:"HH:mm"),i=t.getMoment(e.finishedAt,s?void 0:"HH:mm");e.opWorkDuration||(e.opWorkDuration=i.diff(n)/36e5),e.opWorkDuration=t.utc.format(36e5*e.opWorkDuration,"HH:mm"),s&&(e.startedAt=n.format("HH:mm:ss"),e.finishedAt=i.format("HH:mm:ss"));var a=e.orderData.operations[e.operationNo];return a&&o&&(o.machineManHours+=e.machineManHours=a.machineTime/100*e.quantityDone),e})}})});