// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/user","app/core/Model","app/core/View","app/kaizenOrders/KaizenOrderCollection","app/kaizenOrders/views/KaizenOrderListView","app/suggestions/SuggestionCollection","app/suggestions/views/SuggestionListView","../views/KaizenMetricsView","../views/KaizenTop10View","app/dashboard/templates/dashboard"],function(s,e,i,t,r,o,n,a,d,u,l){"use strict";return t.extend({template:l,events:{"click .dashboard-top-card":function(s){s.currentTarget.classList.toggle("is-flipped")},"mouseenter .dashboard-top-card":function(s){s.currentTarget.classList.add("is-hovered")},"mouseleave .dashboard-top-card":function(s){s.currentTarget.classList.remove("is-hovered")}},initialize:function(){this.defineModels(),this.defineViews(),this.setView("#"+this.idPrefix+"-nearMiss-metrics",this.nearMissMetricsView),this.setView("#"+this.idPrefix+"-nearMiss-list",this.nearMissListView),this.setView("#"+this.idPrefix+"-nearMiss-top10-current",this.nearMissCurrentTop10View),this.setView("#"+this.idPrefix+"-nearMiss-top10-previous",this.nearMissPreviousTop10View),this.setView("#"+this.idPrefix+"-suggestion-metrics",this.suggestionMetricsView),this.setView("#"+this.idPrefix+"-suggestion-list",this.suggestionListView),this.setView("#"+this.idPrefix+"-suggestion-top10-current",this.suggestionCurrentTop10View),this.setView("#"+this.idPrefix+"-suggestion-top10-previous",this.suggestionPreviousTop10View),this.load(),this.timers.reload=setInterval(this.load.bind(this),6e5),this.timers.flipTop10=setInterval(this.flipTop10.bind(this),3e4)},defineModels:function(){this.nearMissStats=new i(null,{url:"/kaizen/stats"}),this.nearMisses=new r(null,{paginate:!1,rqlQuery:"select(rid,status,subject)&sort(-updatedAt)&limit(11)&observers.user.id=mine&status=in=(new,accepted,todo,inProgress,paused)"}),this.suggestionStats=new i(null,{url:"/suggestions/stats"}),this.suggestions=new n(null,{paginate:!1,rqlQuery:"select(rid,status,subject)&sort(-updatedAt)&limit(11)&observers.user.id=mine&status=in=(new,accepted,todo,inProgress,paused)"})},defineViews:function(){var e="#kaizenOrders?exclude(changes)&sort(-eventDate)&limit(20)&eventDate=ge=${from}&eventDate=lt=${to}&owners.id=${user}",i="#suggestions?exclude(changes)&sort(-date)&limit(20)&date=ge=${from}&date=lt=${to}&owners.id=${user}";this.nearMissMetricsView=new d({model:this.nearMissStats,buttonType:"danger",buttonUrl:"#kaizenOrders;add",buttonLabel:s.bound("dashboard","addButton:nearMiss"),browseUrl:"#kaizenOrders",sortProperty:"eventDate"}),this.nearMissListView=new o({collection:this.nearMisses,simple:!0,noData:s.bound("dashboard","list:noData:nearMiss"),serializeColumns:this.serializeListColumns,serializeRow:this.serializeListRow}),this.nearMissCurrentTop10View=new u({model:this.nearMissStats,top10Property:"currentTop10",urlTemplate:e}),this.nearMissPreviousTop10View=new u({model:this.nearMissStats,top10Property:"previousTop10",month:-1,urlTemplate:e}),this.suggestionMetricsView=new d({model:this.suggestionStats,buttonType:"warning",buttonUrl:"#suggestions;add",buttonLabel:s.bound("dashboard","addButton:suggestion"),browseUrl:"#suggestions",sortProperty:"date"}),this.suggestionListView=new a({collection:this.suggestions,simple:!0,noData:s.bound("dashboard","list:noData:suggestion"),serializeColumns:this.serializeListColumns,serializeRow:this.serializeListRow}),this.suggestionCurrentTop10View=new u({model:this.suggestionStats,top10Property:"currentTop10",urlTemplate:i}),this.suggestionPreviousTop10View=new u({model:this.suggestionStats,top10Property:"previousTop10",month:-1,urlTemplate:i})},load:function(){this.promised(this.nearMissStats.fetch()),this.promised(this.nearMisses.fetch({reset:!0})),this.promised(this.suggestionStats.fetch()),this.promised(this.suggestions.fetch({reset:!0}))},flipTop10:function(){this.$(".dashboard-top-card").each(function(){this.classList.contains("is-hovered")||this.classList.toggle("is-flipped")})},serializeListColumns:function(){return[{id:"rid",label:s("dashboard","list:rid"),className:"is-min is-number"},{id:"status",label:s("dashboard","list:status"),className:"is-min"},{id:"subject",label:s("dashboard","list:subject")}]},serializeListRow:function(s){return s.serializeRow({nlsDomain:"dashboard"})}})});