define(["underscore","jquery","app/socket","app/user","app/core/pages/DetailsPage","app/core/util/onModelDeleted","app/core/util/pageActions","../dictionaries","../views/DetailsView"],function(e,t,i,s,n,o,a,r,l){"use strict";return n.extend({DetailsView:l,remoteTopicsAfterSync:!0,remoteTopics:function(){var e={"fap.entries.deleted":"onDeleted"};return e["fap.entries.updated."+this.model.id]="onUpdated",e["fap.entries.presence."+this.model.id]="onPresence",e},localTopics:{"socket.connected":"join","fap.entries.seen":function(t){var i=this.model.id;e.some(t.seenEntries,function(e){return e===i})&&this.model.handleChange({date:new Date,user:s.getInfo(),data:{},comment:""})}},actions:function(){var e=[],t=this.model.serializeDetails(),i=t.auth,n=this.model.get("status");return"finished"===n?i.restart&&e.push({type:"info",label:this.t("PAGE_ACTION:restart"),callback:this.start.bind(this)}):i.status&&("pending"===n&&e.push({type:"info",label:this.t("PAGE_ACTION:start"),callback:this.start.bind(this)}),e.push({type:"success",label:this.t("PAGE_ACTION:finish"),callback:this.finish.bind(this)})),e.push({icon:"eye",label:this.t("PAGE_ACTION:markAsSeen"),callback:this.markAsSeen.bind(this),disabled:!t.observer.notify}),"viewer"!==t.observer.role&&(this.model.get("unsubscribed")[s.data._id]?e.push({icon:"bell-o",label:this.t("PAGE_ACTION:subscribe"),callback:this.subscribe.bind(this)}):e.push({icon:"bell-slash-o",label:this.t("PAGE_ACTION:unsubscribe"),callback:this.unsubscribe.bind(this)})),e.push({icon:"calendar",label:this.t("PAGE_ACTION:history"),href:this.model.genClientUrl("history")}),i.delete&&e.push(a.delete(this.model,!1)),e},initialize:function(){var i=this;n.prototype.initialize.apply(i,arguments);var s=i.model;i.listenTo(s,"updateFailure",function(){s.fetch()});var o=parseInt(s.id,10)<9999999;i.listenToOnce(s,"sync",function(){i.listenTo(s,"sync",i.render),o&&i.broker.publish("router.navigate",{url:s.genClientUrl(),replace:!0,trigger:!1})}),i.listenTo(s,"change:status change:observers change:unsubscribed",e.debounce(i.updateActions.bind(i),1)),i.listenTo(s,"change",i.scheduleMarkAsSeen.bind(i)),t(window).on("focus."+i.idPrefix,i.onFocus.bind(i))},setUpLayout:function(e){this.layout=e},destroy:function(){t(window).off("."+this.idPrefix),this.leave(),r.unload()},load:function(e){var i=this;if(r.loaded)return e(i.model.fetch());var s=t.Deferred();return r.load().then(function(){return i.model.fetch()}).done(function(){s.resolve()}).fail(function(){s.reject()}),e(s.promise())},afterRender:function(){n.prototype.afterRender.apply(this,arguments),r.load(),this.join()},join:function(){this.socket.emit("fap.entries.join",this.model.id)},leave:function(){this.socket.emit("fap.entries.leave",this.model.id)},finish:function(){""===this.model.get("solution").trim()?this.view.showEditor(this.$('.fap-is-editable[data-prop="solution"]'),"solution"):this.model.multiChange({status:"finished",finishedAt:new Date})},start:function(){this.model.multiChange({status:"started",startedAt:new Date,finishedAt:null})},subscribe:function(){this.model.change("unsubscribed",!1,!0)},unsubscribe:function(){this.model.change("unsubscribed",!0,!1)},markAsSeen:function(){this.model.serializeDetails().observer.notify&&this.model.multiChange({})},scheduleMarkAsSeen:function(){var e=this;e.timers&&(clearTimeout(e.timers.markAsSeen),e.timers.markAsSeen=setTimeout(function(){document.hasFocus()&&e.markAsSeen()},1e4))},updateActions:function(){this.layout&&this.layout.setActions(this.actions,this)},onDeleted:function(e){o(this.broker,this.model,e)},onUpdated:function(e){var t=e.change;i.getId()!==e.socketId?this.model.handleChange(t,e.notify):t.data.subscribers&&this.model.handleChange({date:t.date,user:t.user,data:{subscribers:t.data.subscribers},comment:""},e.notify)},onPresence:function(e){this.model.handlePresence(e.userId,e.presence)},onFocus:function(){this.scheduleMarkAsSeen()}})});