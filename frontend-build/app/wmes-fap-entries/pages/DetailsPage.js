define(["app/socket","app/core/pages/DetailsPage","app/core/util/onModelDeleted","app/core/util/pageActions","../dictionaries","../views/DetailsView"],function(t,e,i,s,n,o){"use strict";return e.extend({DetailsView:o,remoteTopics:function(){var t={"fap.entries.deleted":"onDeleted"};return t["fap.entries.updated."+this.model.id]="onUpdated",t["fap.entries.presence."+this.model.id]="onPresence",t},localTopics:{"socket.connected":"join"},actions:function(){var t=[],e=this.model.serializeDetails().auth,i=this.model.get("status");return"finished"===i?e.restart&&t.push({type:"info",label:this.t("PAGE_ACTION:restart"),callback:this.start.bind(this)}):e.status&&("pending"===i&&t.push({type:"info",label:this.t("PAGE_ACTION:start"),callback:this.start.bind(this)}),t.push({type:"success",label:this.t("PAGE_ACTION:finish"),callback:this.finish.bind(this)})),e.delete&&t.push(s.delete(this.model,!1)),t},initialize:function(){e.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"updateFailure",function(){this.model.fetch()}),this.listenToOnce(this.model,"sync",function(){this.listenTo(this.model,"sync",this.render)}),this.listenTo(this.model,"change:status",this.updateStatus)},setUpLayout:function(t){this.layout=t},destroy:function(){this.leave(),n.unload()},load:function(t){return t(this.model.fetch(),n.load())},afterRender:function(){e.prototype.afterRender.apply(this,arguments),n.load(),this.join()},join:function(){this.socket.emit("fap.entries.join",this.model.id)},leave:function(){this.socket.emit("fap.entries.leave",this.model.id)},finish:function(){""===this.model.get("solution").trim()?this.view.showEditor(this.$('.fap-is-editable[data-prop="solution"]'),"solution"):this.model.change("status","finished")},start:function(){this.model.change("status","started")},updateStatus:function(){this.layout&&this.layout.setActions(this.actions,this)},onDeleted:function(t){i(this.broker,this.model,t)},onUpdated:function(e){var i=e.change;t.getId()!==e.socketId?this.model.handleChange(i):i.data.subscribers&&this.model.handleChange({date:i.date,user:i.user,data:{subscribers:i.data.subscribers},comment:""})},onPresence:function(t){this.model.handlePresence(t.userId,t.presence)}})});