define(["jquery","../broker","../pubsub","../user","../wmes-fap-categories/CategoryCollection","../wmes-fap-subCategories/SubCategoryCollection","./SettingCollection"],function(e,t,n,o,r,s,i){"use strict";var l={category:"categories",subCategory:"subCategories"},a=null,u=null,d=null,c={statuses:["pending","started","finished"],subdivisionTypes:["assembly","press","wh"],reqFields:["orderNo","lines","componentCode"],categories:new r,subCategories:new s,settings:new i,loaded:!1,load:function(){return null!==u&&(clearTimeout(u),u=null),c.loaded?e.Deferred().resolve():null!==a?a:((a=e.ajax({url:"/fap/dictionaries"})).done(function(e){c.loaded=!0,f(e)}),a.fail(b),a.always(function(){a=null}),d=n.sandbox(),Object.keys(l).forEach(function(e){d.subscribe("fap."+l[e]+".**",g)}),c.settings.setUpPubsub(d),a)},unload:function(){null!==u&&clearTimeout(u),u=setTimeout(b,3e4)},getLabel:function(e,t){if("string"==typeof e&&(e=this.forProperty(e)||c[e]),!e||Array.isArray(e))return t;var n=e.get(t);return n?n.getLabel():t},forProperty:function(e){return this[l[e]]||null},bind:function(e){var t=this;return e.on("beforeLoad",function(e,n){n.push(t.load())}),e.on("afterRender",t.load.bind(t)),e.once("remove",t.unload.bind(t)),e}};function f(e){Object.keys(l).forEach(function(t){var n=l[t];c[n].reset(e?e[n]:[])}),c.settings.reset(e?e.settings:[])}function b(){u=null,null!==d&&(d.destroy(),d=null),c.loaded=!1,f()}function g(e,n){var o=n.split("."),r=c[o[1]];if(r){switch(o[2]){case"added":r.add(e.model);break;case"edited":var s=r.get(e.model._id);s&&s.set(e.model);break;case"deleted":r.remove(r.get(e.model._id))}t.publish(n,e)}}return c});