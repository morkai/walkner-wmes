define(["underscore","jquery","autolinker","../i18n","../time","../user","../socket","../core/Model","../data/colorFactory","./dictionaries","app/core/templates/userInfo"],function(e,t,a,s,i,n,r,o,l,d,c){"use strict";var u={pending:"danger",started:"info",analyzing:"warning",finished:"success"},f={image:"fa-file-image-o",text:"fa-file-text-o",audio:"fa-audio-o",video:"fa-video-o","application/octet-stream":"fa-file-archive-o","application/x-zip-compressed":"fa-file-archive-o","application/x-7z-compressed":"fa-file-archive-o","application/x-rar-compressed":"fa-file-archive-o","application/pdf":"fa-file-pdf-o","application/json":"fa-file-code-o","application/msword":"fa-file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/vnd.ms-excel":"fa-file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"fa-file-excel-o","application/vnd.ms-powerpoint":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o"};l.setColors("fap/users",["#0af","#5cb85c","#fa0","#a0f","#f0a","#f00","#ff0","#9ff"]);var h=null;return o.extend({urlRoot:"/fap/entries",clientUrlRoot:"#fap/entries",topicPrefix:"fap.entries",privilegePrefix:"FAP",nlsDomain:"wmes-fap-entries",labelAttribute:"rid",initialize:function(){this.serialized=null,this.on("change",function(){this.serialized=null})},isObserver:function(){return e.some(this.get("observers"),function(e){return e.user.id===n.data._id})},serialize:function(){if(this.serialized)return this.serialized;var e=this.toJSON();e.createdAt=i.format(e.createdAt,"L HH:mm");var t=d.categories.get(e.category);return t&&(e.category=t.getLabel()),e.divisions=e.divisions.join("; "),e.lines=e.lines.join("; "),e.assessment=s(this.nlsDomain,"assessment:"+e.assessment),e.analyzing="pending"!==e.status&&e.analysisNeed&&!e.analysisDone,e.analysisDone=e.analysisNeed?s("core","BOOL:"+e.analysisDone):"-",e.analysisNeed=s("core","BOOL:"+e.analysisNeed),e.orderNo||(e.orderNo="-",e.nc12="-",e.productName="-",e.mrp="-",e.qtyTodo="-",e.qtyDone="-"),e.lines||(e.lines="-",e.divisions="-"),e.observer=this.serializeObserver(),this.serialized=e},serializeRow:function(){if(this.serialized)return this.serialized;var t=this.serialize();return t.className=u[t.analyzing?"analyzing":t.status],t.observer.changes.any&&(t.className+=" fap-is-unseen"),t.category='<span class="fap-list-category">'+e.escape(t.category)+"</span>",t.problem='<span class="fap-list-problem">'+e.escape(t.problem)+"</span>",t.lines='<span class="fap-list-lines">'+e.escape(t.lines)+"</span>",this.serialized=t},serializeDetails:function(){if(this.serialized)return this.serialized;var e=this.serialize();switch(e.auth=this.serializeAuth(),e.problem=e.problem.trim().replace(/\n{3,}/,"\n\n"),e.solution=e.solution.trim().replace(/\n{3,}/,"\n\n")||"-",e.solver=e.solver?e.solver.label:"",e.solutionSteps=e.solutionSteps.trim().replace(/\n{3,}/,"\n\n")||"-",e.empty={solution:"-"===e.solution},e.multiline={problem:-1!==e.problem.indexOf("\n"),solution:-1!==e.solution.indexOf("\n"),solutionSteps:-1!==e.solutionSteps.indexOf("\n")},e.mainAnalyzer=e.analyzers.length?e.analyzers[0].label:"-",e.analyzers=e.analyzers.length>1?e.analyzers.slice(1).map(function(e){return e.label}).join("; "):"-",e.chat=this.serializeChat(),e.attachments=e.attachments.map(this.serializeAttachment,this),e.observers=this.serializeObservers(),e.message={type:"",text:""},e.status){case"pending":e.message.type="error",e.message.text=s(this.nlsDomain,"message:pending");break;case"started":e.message.type=e.analyzing?"warning":"info",e.message.text=s(this.nlsDomain,"message:started:"+e.analyzing);break;case"finished":e.message.type=e.analyzing?"warning":"success",e.message.text=s(this.nlsDomain,"message:finished:"+e.analyzing)}return this.serialized=e},serializeAuth:function(){var t=n.isAllowedTo("FAP:MANAGE"),a=n.isLoggedIn(),s=n.isAllowedTo("FN:process-engineer","FN:process-engineer-NPI"),i=n.isAllowedTo("FN:designer","FN:designer_eto"),r=n.isAllowedTo("FN:master"),o=n.isAllowedTo("FN:leader"),l=this.get("analyzers"),d=e.some(l,function(e){return n.data._id===e.id}),c=d&&l[0].id===n.data._id,u=this.get("status"),f="pending"===u,h="started"===u,p=this.get("analysisNeed"),m=this.get("analysisDone"),g=!f&&p&&!m&&(t||s||r);return{delete:this.canDelete(),comment:a,attachments:a,observers:a,restart:t,status:t||s||i||r||o,solution:t||s||i||r||o,problem:h&&(t||s||i||r||o),category:t||s||i,orderNo:h&&(t||s),lines:h&&(t||s),assessment:!f&&(t||s||r),analysisNeed:!f&&(t||s||r),analysisDone:!f&&p&&(t||s||r),mainAnalyzer:g,analyzers:(l.length||g)&&!f&&p&&!m&&(t||s||r||c),why5:!f&&p&&!m&&(t||s||r||o||d),solutionSteps:!f&&p&&!m&&(t||s||r||o||d)}},serializeObserver:function(){var t=e.assign({user:n.getInfo(),role:"viewer",func:n.data.prodFunction||null,lastSeenAt:Date.now(),notify:!1,changes:{}},e.find(this.get("observers"),function(e){return e.user.id===n.data._id}));t.lastSeenAt=Date.parse(t.lastSeenAt||0);var a=Object.keys(t.changes).length>0;return t.changes.any=t.notify||a,t.changes.all=t.notify&&!a,t},serializeChat:function(){var e=this,t={};e.attributes.attachments.forEach(function(e){t[e._id]=!0});var a=e.get("createdAt"),r=i.getMoment(a),o=e.get("owner"),d=o.id===n.data._id,u=[{user:{id:o.id,label:c({userInfo:o,noIp:!0}),self:d},color:d?"transparent":l.getColor("fap/users",o.id),lines:[{time:r.format("LLLL"),text:s(e.nlsDomain,"history:added",{day:r.day(),ddd:r.format("ddd"),date:r.format("D MMMM YYYY"),time:r.format("HH:mm:ss")})}]}];return e.get("changes").forEach(function(a){if(a.user){var s=!!a.comment,i=!!a.data.attachments&&!a.data.attachments[0]&&!!a.data.attachments[1],n=!!a.data.status,r=!!a.data.analysisNeed||!!a.data.analysisDone;(s||i||n||r)&&e.serializeChatMessage(a,u,t)}}),u},serializeChatMessage:function(t,r,o){var d,u=this,f=r&&r[r.length-1],p="<time>"+i.format(t.date,"HH:mm:ss")+"</time>",m=i.format(t.date,"dddd, LL LTS"),g=[];if(t.comment){var v=function(e){return h||(h=new a({urls:{schemeMatches:!0,wwwMatches:!0,tldMatches:!0},email:!0,phone:!1,mention:!1,hashtag:!1,stripPrefix:!0,stripTrailingSlash:!0,newWindow:!0,truncate:{length:0,location:"end"},className:"",replaceFn:function(e){var t=e.getUrl(),a=e.buildTag();if("url"===e.getType()&&-1!==t.indexOf(window.location.host)){var s=a.innerHTML.split("?");s.length>1&&s[1].length&&(a.innerHTML=s[0]+"?&hellip;"),delete a.attrs.rel}else a.innerHTML.length>=60&&(a.innerHTML=a.innerHTML.substring(0,50)+"&hellip;");return a}})),h.link(e)}(e.escape(t.comment)).replace(/ðŸ‘¤/g,'<i class="fa fa-user"></i>');g.push({time:m,text:p+'<span class="fap-chat-line-text">'+v+"</span>"})}t.data.status&&(d="?","finished"===t.data.status[1]&&(d=(d=Date.parse(t.date)-Date.parse(this.get("createdAt")))>0?i.toString(d/1e3):"?"),g.push({time:m,text:s(this.nlsDomain,"chat:status:"+t.data.status.join(":"),{duration:d})})),t.data.analysisNeed&&t.data.analysisNeed[1]&&g.push({time:m,text:s(this.nlsDomain,"chat:analysis:started")}),t.data.analysisDone&&t.data.analysisDone[1]&&(d=(d=Date.parse(t.date)-Date.parse(this.get("analysisStartedAt")))>0?i.toString(d/1e3):"?",g.push({time:m,text:s(this.nlsDomain,"chat:analysis:finished",{duration:d})}));var y=t.data.attachments;if(y&&!y[0]&&y[1]&&t.data.attachments[1].forEach(function(t){if(!o||o[t._id]){var a=u.serializeAttachment(t);g.push({time:m,text:'<span class="fap-chat-attachment" data-attachment-id="'+t._id+'"><i class="fa '+a.icon+'"></i><a>'+e.escape(a.label)+"</a></span>"})}}),f&&f.user.id===t.user.id)return f.lines.push.apply(f.lines,g),f;var b=t.user.id===n.data._id,A={user:{id:t.user.id,label:c({userInfo:t.user,noIp:!0}),self:b},color:b?"transparent":l.getColor("fap/users",t.user.id),lines:g};return r&&A.lines.length&&r.push(A),A},serializeObservers:function(){var e=this,t=n.isAllowedTo("FAP:MANAGE");return e.get("observers").map(function(a){var s=a.user.id===n.data._id;return{_id:a.user.id,label:c({userInfo:a.user,noIp:!0}),color:s?"#000":l.getColor("fap/users",a.user.id),lastSeenAt:a.lastSeenAt?Date.parse(a.lastSeenAt):0,online:s||!!e.attributes.presence[a.user.id],canUnsubscribe:s||t}}).sort(function(e,t){return t.lastSeenAt-e.lastSeenAt})},serializeAttachment:function(e){var t=e.type.split("/")[0];return{_id:e._id,icon:f[e.type]||f[t]||"fa-file-o",preview:"image"===t,label:e.name,menu:n.isAllowedTo("FAP:MANAGE","FN:master","FN:leader","FN:process-engineer","FN:process-engineer-NPI")||e.user&&e.user.id===n.data._id}},canDelete:function(){return n.isAllowedTo(this.privilegePrefix+":MANAGE")},change:function(e,t,a){void 0===a&&(a=this.get(e));var s={date:new Date,user:n.getInfo(),data:{},comment:""},i={};s.data[e]=[a,t],i[e]=t,this.handleChange(s),this.update(i)},multiChange:function(e,t){var a=this,s={date:new Date,user:n.getInfo(),data:{},comment:""},i={};Object.keys(e).forEach(function(n){var r,o;t?(r=e[n][0],o=e[n][1]):(r=a.get(n),o=e[n]),JSON.stringify(o)!==JSON.stringify(r)&&(s.data[n]=[r,o],i[n]=o)}),a.handleChange(s),a.update(i)},update:function(e){var a=this,s=t.ajax({method:"PATCH",url:"/fap/entries/"+a.id,data:JSON.stringify({socketId:r.getId(),data:e})});return s.fail(function(){a.fetch()}),s},handlePresence:function(e,t){var a=this.attributes.presence||{};void 0===a[e]&&(a[e]=!1),a[e]!==t&&(a[e]=t,this.trigger("change:presence",this,a,{userId:e,online:t}),this.serialized&&(this.serialized.observers=this.serializeObservers()))},handleChange:function(t,a){var s=this,i={};!t.comment.length&&e.isEmpty(t.data)||(i.changes=s.get("changes").concat(t)),Object.keys(t.data).forEach(function(e){var a=e.split("$")[0],n=t.data[e],r=s.propChangeHandlers[a];1===r?i[a]=n[1]:r&&r.call(s.propChangeHandlers,i,s,n,t)});var r=i.observers||[].concat(s.get("observers")),o=e.findIndex(r,function(e){return e.user.id===n.data._id});if(-1!==o){var l=r[o];t.user.id===n.data._id?(r[o]=e.defaults({lastSeenAt:t.date,notify:!1,changes:{}},l),i.observers=r):a&&a[n.data._id]&&(r[o]=e.defaults({lastSeenAt:t.date,notify:!0,changes:a[n.data._id]},l),i.observers=r)}s.set(i)},propChangeHandlers:{subscribers:function(e,t,a){var s=e.observers||t.get("observers");null===a[0]?this.addObservers(e,t,s,a[1]):null===a[1]&&this.removeObservers(e,t,s,a[0])},addObservers:function(e,t,a,s){var i={};a.forEach(function(e){i[e.user.id]=!0});var n=[].concat(a);s.forEach(function(e){i[e.id]||(n.push({user:e}),i[e.id]=!0)}),e.observers=n},removeObservers:function(e,t,a,s){var i={};s.forEach(function(e){i[e.id]=!0}),e.observers=a.filter(function(e){return!i[e.user.id]})},attachments:function(e,t,a){var s=t.get("attachments");null===a[0]?this.addAttachments(e,t,s,a[1]):null===a[1]?this.removeAttachments(e,t,s,a[0]):this.editAttachments(e,t,s,a[1])},addAttachments:function(e,t,a,s){var i={};a.forEach(function(e){i[e._id]=!0});var n=[].concat(a);s.forEach(function(e){i[e._id]||(n.push(e),i[e.id]=!0)}),e.attachments=n},removeAttachments:function(e,t,a,s){var i={};s.forEach(function(e){i[e._id]=!0}),e.attachments=a.filter(function(e){return!i[e._id]})},editAttachments:function(e,t,a,s){var i={};s.forEach(function(e){i[e._id]=e}),e.attachments=a.map(function(e){return i[e._id]||e})},unsubscribed:function(t,a,s,i){var n=e.clone(a.get("unsubscribed"));s[1]?n[i.user.id]=!0:delete n[i.user.id],t.unsubscribed=n},status:1,startedAt:1,finishedAt:1,problem:1,solution:1,solver:1,category:1,divisions:1,lines:1,why5:1,solutionSteps:1,assessment:1,analysisNeed:1,analysisDone:1,analysisStartedAt:1,analysisFinishedAt:1,orderNo:1,mrp:1,nc12:1,productName:1,qtyTodo:1,qtyDone:1,analyzers:1}},{AUTH_PROPS:{status:!0,analysisNeed:!0,analysisDone:!0,analyzers:!0}})});