define(["underscore","../i18n","../time","../user","../core/Model","../data/delayReasons","app/core/templates/userInfo"],function(e,i,t,r,s,a,n){"use strict";var o={pending:"",started:"warning",finished:"success"};return s.extend({urlRoot:"/fap/entries",clientUrlRoot:"#fap/entries",topicPrefix:"fap.entries",privilegePrefix:"FAP",nlsDomain:"wmes-fap-entries",labelAttribute:"rid",serialize:function(){var e=this.toJSON();e.createdAt=t.format(e.createdAt,"L HH:mm");var i=a.get(e.category);return i&&(e.category=i.getLabel()),e.divisions=e.divisions.join("; "),e.lines=e.lines.join("; "),e},serializeRow:function(){var i=this.serialize();return i.className=o[i.status],i.category='<span class="fap-list-category">'+e.escape(i.category)+"</span>",i.problem='<span class="fap-list-problem">'+e.escape(i.problem)+"</span>",i},serializeDetails:function(){var e=this.serialize();return e.problem=e.problem.trim().replace(/\n{3,}/,"\n\n"),e.multilineProblem=-1!==e.problem.indexOf("\n"),e.chat=this.serializeChat(),e},serializeChat:function(){var e=this.get("owner"),r=t.format(this.get("createdAt"),"LLLL"),s=[{user:{id:e.id,label:n({userInfo:e})},lines:[{time:r,text:i(this.nlsDomain,"history:added",{createdAt:r})}]}];return this.get("changes").forEach(function(e){if(e.comment&&e.user){var i=s[s.length-1],r={time:t.format(e.date,"LLLL"),text:e.comment};i.user.id===e.user.id?i.lines.push(r):s.push({user:{id:e.user.id,label:n({userInfo:e.user})},lines:[r]})}}),s},canDelete:function(){return r.isAllowedTo(this.privilegePrefix+":MANAGE")}})});