define(["underscore","jquery","../i18n","../time","../user","../socket","../core/Model","../core/util/autolinker","../data/colorFactory","./dictionaries","app/core/templates/userInfo","app/wmes-fap-entries/templates/levelIndicator"],function(e,a,t,s,i,n,r,o,l,d,c,u){"use strict";var f={pending:"danger",started:"info",analyzing:"warning",finished:"success"},h={image:"fa-file-image-o",text:"fa-file-text-o",audio:"fa-audio-o",video:"fa-video-o","application/octet-stream":"fa-file-archive-o","application/x-zip-compressed":"fa-file-archive-o","application/x-7z-compressed":"fa-file-archive-o","application/x-rar-compressed":"fa-file-archive-o","application/pdf":"fa-file-pdf-o","application/json":"fa-file-code-o","application/msword":"fa-file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/vnd.ms-excel":"fa-file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"fa-file-excel-o","application/vnd.ms-powerpoint":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o"};return l.setColors("fap/users",["#0af","#5cb85c","#fa0","#a0f","#f0a","#f00","#ff0","#9ff"]),r.extend({urlRoot:"/fap/entries",clientUrlRoot:"#fap/entries",topicPrefix:"fap.entries",privilegePrefix:"FAP",nlsDomain:"wmes-fap-entries",labelAttribute:"rid",defaults:function(){return{subdivisionType:"assembly"}},initialize:function(){this.serialized=null,this.on("change",function(){this.serialized=null})},isObserver:function(){return e.some(this.get("observers"),function(e){return e.user.id===i.data._id})},serialize:function(){if(this.serialized)return this.serialized;var e=this.toJSON();e.createdAt=s.format(e.createdAt,"L HH:mm");var a=d.categories.get(e.category);a&&(e.category=a.getLabel());var i=d.subCategories.get(e.subCategory);return i&&(e.subCategory=i.getLabel()),e.subCategory||(e.subCategory="-"),e.divisions=e.divisions?e.divisions.join("; "):"",e.lines=e.lines?e.lines.join("; "):"",e.assessment=t(this.nlsDomain,"assessment:"+e.assessment),e.analyzing="pending"!==e.status&&e.analysisNeed&&!e.analysisDone,e.analysisDone=e.analysisNeed?t("core","BOOL:"+e.analysisDone):"-",e.analysisNeed=t("core","BOOL:"+e.analysisNeed),e.orderNo||(e.orderNo="-",e.nc12="-",e.productName="-",e.mrp="-",e.qtyTodo="-",e.qtyDone="-"),e.lines||(e.lines="-",e.divisions="-"),e.subdivisionType=t(this.nlsDomain,"subdivisionType:"+e.subdivisionType),e.componentCode||(e.componentCode="-"),e.componentName||(e.componentName="-"),e.observer=this.serializeObserver(),this.serialized=e},serializeRow:function(){if(this.serialized)return this.serialized;var a=this.serialize();a.className=f[a.analyzing?"analyzing":a.status],a.observer.changes.any&&(a.className+=" fap-is-unseen");var t=a.category;return"-"!==a.subCategory&&(t=a.subCategory),a.category='<span class="fap-list-category">'+e.escape(t)+"</span>",a.problem='<span class="fap-list-problem">'+e.escape(a.problem)+"</span>",a.lines='<span class="fap-list-lines">'+e.escape(a.lines)+"</span>","-"!==a.componentCode&&(a.nc12=a.componentCode,a.productName=a.componentName),a.levelIndicator=u({level:a.level,canIncrease:!1,canManage:!1}),this.serialized=a},serializeDetails:function(){if(this.serialized)return this.serialized;var e=this.serialize();switch(e.auth=this.serializeAuth(),e.problem=this.serializeText(e.problem),e.solution=this.serializeText(e.solution||"-"),e.solver=e.solver?e.solver.label:"",e.solutionSteps=this.serializeText(e.solutionSteps||"-"),e.empty={solution:"-"===e.solution},e.multiline={problem:-1!==e.problem.indexOf("\n"),solution:-1!==e.solution.indexOf("\n"),solutionSteps:-1!==e.solutionSteps.indexOf("\n")},e.mainAnalyzer=e.analyzers&&e.analyzers.length?e.analyzers[0].label:"-",e.analyzers=e.analyzers&&e.analyzers.length>1?e.analyzers.slice(1).map(function(e){return e.label}).join("; "):"-",e.chat=this.serializeChat(),e.attachments=(e.attachments||[]).map(this.serializeAttachment,this),e.observers=this.serializeObservers(),e.message={type:"",text:""},e.status){case"pending":e.message.type="error",e.message.text=t(this.nlsDomain,"message:pending");break;case"started":e.message.type=e.analyzing?"warning":"info",e.message.text=t(this.nlsDomain,"message:started:"+e.analyzing);break;case"finished":e.message.type=e.analyzing?"warning":"success",e.message.text=t(this.nlsDomain,"message:finished:"+e.analyzing)}return e.levelIndicator=u({level:e.level,canIncrease:e.auth.level,canManage:e.auth.manage}),this.serialized=e},updateAuth:function(){this.serialized&&(this.serialized.auth=this.serializeAuth())},serializeAuth:function(){var a=i.isLoggedIn(),t=i.isAllowedTo("FAP:MANAGE"),s=i.isAllowedTo("FN:manager"),n=i.isAllowedTo("FN:process-engineer","FN:process-engineer-NPI"),r=i.isAllowedTo("FN:warehouse-process-engineer"),o=i.isAllowedTo("FN:designer","FN:designer_eto"),l=i.isAllowedTo("FN:master"),c=i.isAllowedTo("FN:leader"),u=i.isAllowedTo("FN:whman","FN:prod_whman","FN:in_whman"),f=this.get("analyzers")||[],h=e.some(f,function(e){return i.data._id===e.id}),p=h&&f[0].id===i.data._id,m="wh"===this.get("subdivisionType"),g=this.get("status"),v="pending"===g,y="started"===g,b="finished"===g,z=this.get("analysisNeed"),A=this.get("analysisDone"),N=!v&&z&&!A&&(t||n||l),w=t||n||r||o||l||c||m&&u,x=d.settings.canChangeCategory();return{delete:this.canDelete(),manage:t,comment:a,attachments:a,observers:a,restart:t,status:w,level:!b&&(w||s||u),solution:w,problem:y&&(t||n||o||l||c),category:t||x,subCategory:t||x,subdivisionType:t||n||o||l||c,componentCode:y&&(t||n),orderNo:y&&(t||n),lines:y&&(t||n),assessment:!v&&(t||n||l),analysisNeed:!v&&(t||n||l),analysisDone:!v&&z&&(t||n||l),mainAnalyzer:N,analyzers:(f.length||N)&&!v&&z&&!A&&(t||n||l||p),why5:!v&&z&&!A&&(t||n||l||c||h),solutionSteps:!v&&z&&!A&&(t||n||l||c||h)}},serializeObserver:function(){var a=e.assign({user:i.getInfo(),role:"viewer",func:i.data.prodFunction||null,lastSeenAt:Date.now(),notify:!1,changes:{}},e.find(this.get("observers"),function(e){return e.user.id===i.data._id}));a.lastSeenAt=Date.parse(a.lastSeenAt||0);var t=Object.keys(a.changes).length>0;return a.changes.any=a.notify||t,a.changes.all=a.notify&&!t,a},serializeChat:function(){var e=this,a={};(e.get("attachments")||[]).forEach(function(e){a[e._id]=!0});var n=e.get("createdAt"),r=s.getMoment(n),o=e.get("owner"),d=o.id===i.data._id,u=[{user:{id:o.id,label:c({userInfo:o,noIp:!0}),self:d},color:d?"transparent":l.getColor("fap/users",o.id),lines:[{time:r.format("LLLL"),text:t(e.nlsDomain,"history:added",{day:r.day(),ddd:r.format("ddd"),date:r.format("D MMMM YYYY"),time:r.format("HH:mm:ss")})}]}];return(e.get("changes")||[]).forEach(function(t){if(t.user){var s=!!t.comment,i=!!t.data.attachments&&!t.data.attachments[0]&&!!t.data.attachments[1],n=!!t.data.status,r=!!t.data.analysisNeed||!!t.data.analysisDone,o=!!t.data.level;(s||i||n||r||o)&&e.serializeChatMessage(t,u,a)}}),u},serializeChatMessage:function(a,n,r){var o,d=this,u=n&&n[n.length-1],f="<time>"+s.format(a.date,"HH:mm:ss")+"</time>",h=s.format(a.date,"dddd, LL LTS"),p=[];if(a.comment){var m=this.serializeText(a.comment);p.push({time:h,text:f+'<span class="fap-chat-line-text">'+m+"</span>"})}if(a.data.status&&(o="?","finished"===a.data.status[1]&&(o=(o=Date.parse(a.date)-Date.parse(this.get("createdAt")))>0?s.toString(o/1e3):"?"),p.push({time:h,text:t(this.nlsDomain,"chat:status:"+a.data.status.join(":"),{duration:o})})),a.data.analysisNeed&&a.data.analysisNeed[1]&&p.push({time:h,text:t(this.nlsDomain,"chat:analysis:started")}),a.data.analysisDone&&a.data.analysisDone[1]&&(o=(o=Date.parse(a.date)-Date.parse(this.get("analysisStartedAt")))>0?s.toString(o/1e3):"?",p.push({time:h,text:t(this.nlsDomain,"chat:analysis:finished",{duration:o})})),a.data.level){var g=a.data.level[1]>a.data.level[0]?"up":"down";p.push({time:h,text:t(this.nlsDomain,"chat:level:"+g,{level:a.data.level[1]})})}var v=a.data.attachments;if(v&&!v[0]&&v[1]){var y=t(d.nlsDomain,"autolink:attachment");a.data.attachments[1].forEach(function(a){if(!r||r[a._id]){var t=d.serializeAttachment(a);p.push({time:h,text:'<span class="fap-chat-attachment" title="'+y+'" data-attachment-id="'+a._id+'"><i class="fa '+t.icon+'"></i><a>'+e.escape(t.label)+"</a></span>"})}})}if(u&&u.user.id===a.user.id)return u.lines.push.apply(u.lines,p),u;var b=a.user.id===i.data._id,z={user:{id:a.user.id,label:c({userInfo:a.user,noIp:!0}),self:b},color:b?"transparent":l.getColor("fap/users",a.user.id),lines:p};return n&&z.lines.length&&n.push(z),z},serializeText:function(e){return o.autolinkMessage(e,this)},serializeObservers:function(){var e=this,a=i.isAllowedTo("FAP:MANAGE");return e.get("observers").map(function(t){var s=t.user.id===i.data._id;return{_id:t.user.id,label:c({userInfo:t.user,noIp:!0}),color:s?"#000":l.getColor("fap/users",t.user.id),lastSeenAt:t.lastSeenAt?Date.parse(t.lastSeenAt):0,online:s||!!e.attributes.presence[t.user.id],canUnsubscribe:s||a}}).sort(function(e,a){return a.lastSeenAt-e.lastSeenAt})},serializeAttachment:function(e){var a=e.type.split("/")[0];return{_id:e._id,icon:h[e.type]||h[a]||"fa-file-o",preview:"image"===a,label:e.name,menu:i.isAllowedTo("FAP:MANAGE","FN:master","FN:leader","FN:process-engineer","FN:process-engineer-NPI")||e.user&&e.user.id===i.data._id}},canDelete:function(){return i.isAllowedTo(this.privilegePrefix+":MANAGE")},change:function(e,a,t){void 0===t&&(t=this.get(e));var s={};s[e]=[t,a],this.multiChange(s,!0)},multiChange:function(e,a){var t=this,s={date:new Date,user:i.getInfo(),data:{},comment:""},n={};Object.keys(e).forEach(function(i){var r,o;a?(r=e[i][0],o=e[i][1]):(r=t.get(i),o=e[i]),JSON.stringify(o)!==JSON.stringify(r)&&(s.data[i]=[r,o],n[i]=o)}),Object.keys(e).length&&!Object.keys(n).length||(i.isLoggedIn()&&!this.isObserver()&&(s.data.subscribers||(s.data.subscribers=[null,[]]),s.data.subscribers[0]||s.data.subscribers[1].push({id:i.data._id,label:i.getLabel()})),t.handleChange(s),t.update(n))},update:function(e){var t=this,s=a.ajax({method:"PATCH",url:"/fap/entries/"+t.id,data:JSON.stringify({socketId:n.getId(),data:e})});return s.fail(function(){t.fetch()}),s},handlePresence:function(e,a){var t=this.attributes.presence||{};void 0===t[e]&&(t[e]=!1),t[e]!==a&&(t[e]=a,this.trigger("change:presence",this,t,{userId:e,online:a}),this.serialized&&(this.serialized.observers=this.serializeObservers()))},handleChange:function(a,t){var s=this,n={};!a.comment.length&&e.isEmpty(a.data)||(n.changes=s.get("changes").concat(a)),Object.keys(a.data).forEach(function(e){var t=e.split("$")[0],i=a.data[e],r=s.propChangeHandlers[t];1===r?n[t]=i[1]:r&&r.call(s.propChangeHandlers,n,s,i,a)});var r={};(n.observers||[]).concat(s.get("observers")).forEach(function(e){e&&e.user&&(r[e.user.id]=e)}),r=e.values(r);var o=e.findIndex(r,function(e){return e.user.id===i.data._id});if(-1!==o){var l=r[o];if(a.user.id===i.data._id){if(!1===l.notify&&!Object.keys(n).length)return;r[o]=e.defaults({lastSeenAt:a.date,notify:!1,changes:{}},l),n.observers=r}else t&&t[i.data._id]&&(r[o]=e.defaults({lastSeenAt:a.date,notify:!0,changes:t[i.data._id]},l),n.observers=r)}s.set(n)},propChangeHandlers:{subscribers:function(e,a,t){var s=e.observers||a.get("observers");null===t[0]?this.addObservers(e,a,s,t[1]):null===t[1]&&this.removeObservers(e,a,s,t[0])},addObservers:function(e,a,t,s){var i={};t.forEach(function(e){i[e.user.id]=!0});var n=[].concat(t);s.forEach(function(e){i[e.id]||(n.push({lastSeenAt:new Date,notify:!1,changes:{},user:e}),i[e.id]=!0)}),e.observers=n},removeObservers:function(e,a,t,s){var i={};s.forEach(function(e){i[e.id]=!0}),e.observers=t.filter(function(e){return!i[e.user.id]})},attachments:function(e,a,t){var s=a.get("attachments");null===t[0]?this.addAttachments(e,a,s,t[1]):null===t[1]?this.removeAttachments(e,a,s,t[0]):this.editAttachments(e,a,s,t[1])},addAttachments:function(e,a,t,s){var i={};t.forEach(function(e){i[e._id]=!0});var n=[].concat(t);s.forEach(function(e){i[e._id]||(n.push(e),i[e.id]=!0)}),e.attachments=n},removeAttachments:function(e,a,t,s){var i={};s.forEach(function(e){i[e._id]=!0}),e.attachments=t.filter(function(e){return!i[e._id]})},editAttachments:function(e,a,t,s){var i={};s.forEach(function(e){i[e._id]=e}),e.attachments=t.map(function(e){return i[e._id]||e})},unsubscribed:function(a,t,s,i){var n=e.clone(t.get("unsubscribed"));s[1]?n[i.user.id]=!0:delete n[i.user.id],a.unsubscribed=n},status:1,level:1,startedAt:1,finishedAt:1,problem:1,solution:1,solver:1,category:1,subCategory:1,divisions:1,lines:1,why5:1,solutionSteps:1,assessment:1,analysisNeed:1,analysisDone:1,analysisStartedAt:1,analysisFinishedAt:1,orderNo:1,mrp:1,nc12:1,productName:1,qtyTodo:1,qtyDone:1,analyzers:1,subdivisionType:1,componentCode:1,componentName:1}},{AUTH_PROPS:{status:!0,analysisNeed:!0,analysisDone:!0,analyzers:!0}})});