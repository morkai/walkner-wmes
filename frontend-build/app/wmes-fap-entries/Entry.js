define(["underscore","jquery","../i18n","../time","../user","../socket","../core/Model","../data/colorFactory","./dictionaries","app/core/templates/userInfo"],function(e,a,t,s,i,n,r,o,l,d){"use strict";var c={pending:"danger",started:"info",analyzing:"warning",finished:"success"},f={image:"fa-file-image-o",text:"fa-file-text-o",audio:"fa-audio-o",video:"fa-video-o","application/octet-stream":"fa-file-archive-o","application/x-zip-compressed":"fa-file-archive-o","application/x-7z-compressed":"fa-file-archive-o","application/x-rar-compressed":"fa-file-archive-o","application/pdf":"fa-file-pdf-o","application/json":"fa-file-code-o","application/msword":"fa-file-word-o","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"fa-file-word-o","application/vnd.ms-excel":"fa-file-excel-o","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"fa-file-excel-o","application/vnd.ms-powerpoint":"fa-file-powerpoint-o","application/vnd.openxmlformats-officedocument.presentationml.presentation":"fa-file-powerpoint-o"};return o.setColors("fap/users",["#0af","#5cb85c","#fa0","#a0f","#f0a","#f00","#ff0","#9ff"]),r.extend({urlRoot:"/fap/entries",clientUrlRoot:"#fap/entries",topicPrefix:"fap.entries",privilegePrefix:"FAP",nlsDomain:"wmes-fap-entries",labelAttribute:"rid",initialize:function(){this.serialized=null,this.on("sync change",function(){this.serialized=null})},isObserver:function(){return e.some(this.get("observers"),function(e){return e.user.id===i.data._id})},serialize:function(){if(this.serialized)return this.serialized;var e=this.toJSON();e.createdAt=s.format(e.createdAt,"L HH:mm");var a=l.categories.get(e.category);return a&&(e.category=a.getLabel()),e.divisions=e.divisions.join("; "),e.lines=e.lines.join("; "),e.assessment=t(this.nlsDomain,"assessment:"+e.assessment),e.analyzing=e.analysisNeed&&!e.analysisDone,e.analysisDone=e.analysisNeed?t("core","BOOL:"+e.analysisDone):"-",e.analysisNeed=t("core","BOOL:"+e.analysisNeed),this.serialized=e},serializeRow:function(){if(this.serialized)return this.serialized;var a=this.serialize();return a.className=c[a.analyzing?"analyzing":a.status],a.category='<span class="fap-list-category">'+e.escape(a.category)+"</span>",a.problem='<span class="fap-list-problem">'+e.escape(a.problem)+"</span>",this.serialized=a},serializeDetails:function(){if(this.serialized)return this.serialized;var e=this.serialize();switch(e.problem=e.problem.trim().replace(/\n{3,}/,"\n\n"),e.solution=e.solution.trim().replace(/\n{3,}/,"\n\n")||"-",e.problemMultiline=-1!==e.problem.indexOf("\n"),e.solutionMultiline=-1!==e.solution.indexOf("\n"),e.chat=this.serializeChat(),e.attachments=e.attachments.map(this.serializeAttachment,this),e.observers=this.serializeObservers(),e.auth=this.serializeAuth(),e.message={type:"",text:""},e.status){case"pending":e.message.type="error",e.message.text=t(this.nlsDomain,"message:pending");break;case"started":e.message.type=e.analyzing?"warning":"info",e.message.text=t(this.nlsDomain,"message:started:"+e.analyzing);break;case"finished":e.message.type=e.analyzing?"warning":"success",e.message.text=t(this.nlsDomain,"message:finished:"+e.analyzing)}return this.serialized=e},serializeAuth:function(){var a=i.isAllowedTo("FAP:MANAGE"),t=i.isAllowedTo("FN:process-engineer"),s=i.isAllowedTo("FN:master"),n=i.isAllowedTo("FN:leader"),r=e.some(this.get("analyzers"),function(e){return i.data._id===e.id}),o=this.get("status"),l="pending"===o,d="started"===o,c=this.get("analysisNeed"),f=this.get("analysisDone");return{delete:this.canDelete(),restart:a,status:a||t||s||n,problem:d&&(a||t||s||n),category:d&&(a||t),lines:d&&(a||t),assessment:!l&&(a||t||s),analysisNeed:!l&&(a||t||s),analysisDone:!l&&c&&(a||t||s),analysers:!l&&c&&!f&&(a||t||s),why5:!l&&c&&!f&&(a||t||s||n||r),solution:!l&&c&&!f&&(a||t||s||n||r)}},serializeChat:function(){var a=this,n=a.get("createdAt"),r=s.getMoment(n),l=a.get("owner"),c=l.id===i.data._id,f=[{user:{id:l.id,label:d({userInfo:l}),self:c},color:c?"transparent":o.getColor("fap/users",l.id),lines:[{time:r.format("LLLL"),text:t(a.nlsDomain,"history:added",{day:r.day(),ddd:r.format("ddd"),date:r.format("D MMMM YYYY"),time:r.format("HH:mm:ss")})}]}];return a.get("attachments").forEach(function(t){if(t.user.id===l.id&&t.date===n){var s=a.serializeAttachment(t);f[0].lines.push({time:f[0].lines[0].time,text:'<span class="fap-chat-attachment" data-attachment-id="'+t._id+'"><i class="fa '+s.icon+'"></i><a>'+e.escape(s.label)+"</a></span>"})}}),a.get("changes").forEach(function(e){if(e.user){var t=!!e.comment,s=!!e.data.attachments&&!e.data.attachments.added.length;(t||s)&&a.serializeChatMessage(e,f)}}),f},serializeChatMessage:function(a,t){var n=t&&t[t.length-1],r={time:s.format(a.date,"dddd, LL LTS"),text:e.escape(a.comment)};if(n&&n.user.id===a.user.id)return n.lines.push(r),n;var l=a.user.id===i.data._id,c={user:{id:a.user.id,label:d({userInfo:a.user}),self:l},color:l?"transparent":o.getColor("fap/users",a.user.id),lines:[r]};return t&&t.push(c),c},serializeObservers:function(){var e=this;return e.get("observers").map(function(a){var t=a.user.id===i.data._id;return{_id:a.user.id,label:d({userInfo:a.user,noIp:!0}),color:t?"#000":o.getColor("fap/users",a.user.id),lastSeenAt:a.lastSeenAt?Date.parse(a.lastSeenAt):0,online:t||!!e.attributes.presence[a.user.id]}}).sort(function(e,a){return a.lastSeenAt-e.lastSeenAt})},serializeAttachment:function(e){var a=e.type.split("/")[0];return{_id:e._id,icon:f[e.type]||f[a]||"fa-file-o",preview:"image"===a,label:e.name}},canDelete:function(){return i.isAllowedTo(this.privilegePrefix+":MANAGE")},change:function(e,a,t){void 0===t&&(t=this.get(e));var s={date:new Date,user:i.getInfo(),data:{},comment:""},n={};s.data[e]=[t,a],n[e]=a,this.handleChange(s),this.update(n)},multiChange:function(e,a){var t=this,s={date:new Date,user:i.getInfo(),data:{},comment:""},n={};Object.keys(e).forEach(function(i){var r,o;a?(r=e[i][0],o=e[i][1]):(r=t.get(i),o=e[i]),s.data[i]=[r,o],n[i]=o}),t.handleChange(s),t.update(n)},update:function(e){var t=this,s=a.ajax({method:"PATCH",url:"/fap/entries/"+t.id,data:JSON.stringify({socketId:n.getId(),data:e})});return s.fail(function(){t.fetch()}),s},handlePresence:function(e,a){var t=this.attributes.presence;void 0===t[e]&&(t[e]=!1),t[e]!==a&&(t[e]=a,this.trigger("change:presence",this,t,{userId:e,online:a}),this.trigger("change",this,{}))},handleChange:function(e){var a=this,t={changes:a.get("changes").concat(e)};Object.keys(e.data).forEach(function(s){var i=a.propChangeHandlers[s];1===i?t[s]=e.data[s][1]:i&&i.call(a.propChangeHandlers,t,a,e.data[s],e)}),a.set(t)},propChangeHandlers:{subscribers:function(e,a,t){var s=a.get("observers");null===t[0]?this.addObservers(e,a,s,t[1]):null===t[1]&&this.removeObservers(e,a,s,t[0])},addObservers:function(e,a,t,s){var i={};t.forEach(function(e){i[e.user.id]=!0});var n=[].concat(t);s.forEach(function(e){i[e.id]||(n.push({user:e}),i[e.id]=!0)}),e.observers=n},removeObservers:function(e,a,t,s){var i={};s.forEach(function(e){i[e.id]=!0}),e.observers=t.filter(function(e){return!i[e.user.id]})},status:1,problem:1,category:1,divisions:1,lines:1,why5:1,solution:1,assessment:1,analysisNeed:1,analysisDone:1}},{AUTH_PROPS:{status:!0,analysisNeed:!0,analysisDone:!0,analyzers:!0}})});