define(["underscore","jquery","app/user","app/viewport","app/core/views/FormView","app/core/util/uuid","app/core/util/idAndLabel","app/data/delayReasons","app/data/orgUnits","app/users/util/setUpUserSelect2","app/wmes-fap-entries/templates/addForm","app/wmes-fap-entries/templates/addFormUpload","app/wmes-fap-entries/templates/notificationsPopover"],function(e,t,a,o,d,i,n,r,l,s,u,p,c){"use strict";return d.extend({template:u,events:Object.assign({"click #-cancel":function(){this.trigger("cancel")},'click a[data-action="removeUpload"]':function(e){var t=this.$(e.target).closest(".fap-addForm-upload")[0].dataset.uploadId,a=this.model;return a.uploading&&a.uploading._id===t?(a.uploading.abort(),a.uploading=null):(a.uploadQueue=a.uploadQueue.filter(function(e){return e._id!==t}),a.uploadedFiles=a.uploadedFiles.filter(function(e){return e._id!==t})),this.removeUpload(t),!1},"change #-category":function(e){this.model.attributes[e.target.name]=e.target.value,this.saveInputFocus(e.target),this.updateNotifications()},"input #-orderNo, #-problem":function(e){this.model.attributes[e.target.name]=e.target.value,e.target.setCustomValidity(""),this.saveInputFocus(e.target)},"focus input, textarea":function(e){this.saveInputFocus(e.target)},"blur input, textarea":function(e){this.saveInputFocus(e.target)},"change #-orderNo":"validateOrder","click .fap-addForm-upload-name":function(e){this.showUploadNameEditor(this.$(e.target).closest(".fap-addForm-upload")[0].dataset.uploadId)}},d.prototype.events),initialize:function(){d.prototype.initialize.apply(this,arguments),this.reloadLock=a.lockReload();var e=this.model;e.uploadQueue||(e.uploadQueue=[],e.uploading=null,e.uploadedFiles=[])},destroy:function(){d.prototype.destroy.apply(this,arguments),this.model.focusedInput&&this.saveInputFocus(this.$id(this.model.focusedInput.name)[0]),t(".fap-addForm-backdrop").remove(),a.unlockReload(this.reloadLock)},afterRender:function(){var e=this;d.prototype.afterRender.apply(e,arguments);var a=t(".fap-addForm-backdrop");a.length||(a=t('<div class="fap-addForm-backdrop"></div>').appendTo("body").on("click",function(){e.trigger("cancel")})),e.$id("category").select2({dropdownCssClass:"fap-addForm-select2",data:r.map(n)}),e.renderUploads(),e.setUpOwnerSelect2(),e.setUpDnd(e.$el),e.setUpDnd(a),e.updateNotifications(),e.focusInput()},renderUploads:function(){var e=this,a=e.$id("uploads");e.model.uploadedFiles.forEach(function(t){e.renderUpload(t,!0).appendTo(a)}),e.model.uploading&&e.renderUpload(e.model.uploading,!1).appendTo(a),e.model.uploadQueue.forEach(function(t){e.renderUpload(t,!1).appendTo(a)}),a[0].childElementCount>1&&a[0].firstElementChild.classList.add("hidden"),a.popover({placement:"left",trigger:"hover",container:a.parent()[0],selector:".fap-addForm-upload",html:!0,content:function(){if(!e.$el.hasClass("fap-addForm-editing")){var t=this.dataset.uploadId,a=e.findUpload(t);if(a&&a.img)return a.img}},template:function(e){return t(e).addClass("fap-addForm-upload-popover").attr("data-upload-id",this.dataset.uploadId)}})},renderUpload:function(e,t){return this.renderPartial(p,{uploaded:t,upload:e})},setUpOwnerSelect2:function(){var e=this.$id("owner");e.length&&s(e,{view:this,width:"100%",dropdownCssClass:"fap-addForm-select2"})},setUpDnd:function(e){e.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}).on("drop",this.onDrop.bind(this))},onDrop:function(t){var a=this,d=a.model,n=Array.prototype.slice.call(t.originalEvent.dataTransfer.files);return(d.uploading?1:0)+d.uploadQueue.length+d.uploadedFiles.length+n.length>5?(o.msg.show({type:"warning",time:2500,text:a.t("addForm:upload:tooMany",{max:5})}),!1):(n.forEach(function(t){var o=null;0===t.type.indexOf("image/")&&((o=new Image).src=URL.createObjectURL(t)),d.uploadQueue.push({_id:i(),file:t,name:t.name.replace(/\..*?$/,""),img:o});var n=a.$id("uploads");n[0].firstElementChild.classList.add("hidden"),a.renderUpload(e.last(d.uploadQueue),!1).appendTo(n)}),a.uploading||a.uploadNext(),!1)},uploadNext:function(){var e=this,t=e.model,a=t.uploadQueue.shift();if(a){e.$id("submit").prop("disabled",!0);var d=e.$id("uploads"),i=new FormData;i.append("file",a.file),t.uploading=e.ajax({type:"POST",url:"/fap/entries;upload",data:i,processData:!1,contentType:!1}),t.uploading.fail(function(){e.removeUpload(a._id),o.msg.show({type:"error",time:2500,text:e.t("addForm:upload:failure",{file:a.file.name})})}),t.uploading.done(function(e){d.find('[data-upload-id="'+a._id+'"]').find(".fa-spinner").removeClass("fa-spinner fa-spin").addClass("fa-times"),a.hash=e,t.uploadedFiles.push(a)}),t.uploading.always(function(){t.uploading=null,e.uploadNext()})}else e.$id("submit").prop("disabled",!1)},removeUpload:function(e){var t=this.$id("uploads");t.find('[data-upload-id="'+e+'"]').remove(),this.$('.popover[data-upload-id="'+e+'"]').remove(),1===t[0].childElementCount&&t[0].firstElementChild.classList.remove("hidden")},saveInputFocus:function(e){e&&!e.classList.contains("select2-focusser")&&(this.model.focusedInput={name:e.name,selectionStart:e.selectionStart,selectionEnd:e.selectionEnd})},focusInput:function(){if(this.model.focusedInput){var e=this.$id(this.model.focusedInput.name)[0];if(e){if("TEXTAREA"===e.tagName){var t=e.value;e.value=t.substring(0,this.model.focusedInput.selectionEnd),e.scrollTop=e.scrollHeight,e.value=t}e.setSelectionRange&&e.setSelectionRange(this.model.focusedInput.selectionStart,this.model.focusedInput.selectionEnd),e.focus()}else this.$id("orderNo").focus()}else this.$id("orderNo").focus()},updateNotifications:function(){var e=r.get(this.$id("category").val());(e&&e.get("notifications")||[]).length?this.$id("notifications").removeClass("hidden").popover({placement:"bottom",trigger:"hover",html:!0,content:this.renderPartial(c,{notifications:e.serialize().notifications}),template:function(e){return t(e).addClass("fap-addForm-notifications-popover")}}):this.$id("notifications").addClass("hidden")},validateOrder:function(){var e=this,t=e.$id("orderNo"),a=t.val();if(/^[0-9]{9}$/.test(a)&&"000000000"!==a){var o=e.ajax({url:"/orders/"+a+"?select(_id)"});o.fail(function(){404===o.status&&t[0].setCustomValidity(e.t("addForm:orderNo:notFound"))})}},findUpload:function(e){var t=this.model;if(t.uploading&&t.uploading._id===e)return t.uploading;for(var a=0;a<t.uploadedFiles.length;++a)if(t.uploadedFiles[a]._id===e)return t.uploadedFiles[a];for(var o=0;o<t.uploadQueue.length;++o)if(t.uploadQueue[o]._id===e)return t.uploadQueue[o];return null},showUploadNameEditor:function(e){var a=this,o=a.$id("uploads").find('[data-upload-id="'+e+'"]'),d=a.findUpload(e),i=t('<input type="text" class="form-control fap-addForm-upload-input">').val(d.name);function n(){i.remove(),a.$el.removeClass("fap-addForm-editing")}a.$el.addClass("fap-addForm-editing"),i.on("blur",function(){!function(){var e=i.val().trim();if(!e.length)return;d.name=e,o.find(".fap-addForm-upload-name").text(e)}(),n()}),i.on("keydown",function(e){return"Escape"===e.key?(n(),!1):"Enter"===e.key?(e.target.blur(),!1):void 0}),i.appendTo(o).focus()},serializeForm:function(e){return e.files=this.model.uploadedFiles.map(function(e){return{_id:e.hash,name:e.name}}),e},getFailureText:function(){return this.t("FORM:ERROR:addFailure")}})});