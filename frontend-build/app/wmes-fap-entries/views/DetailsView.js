define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/idAndLabel","app/data/orgUnits","app/users/util/setUpUserSelect2","../dictionaries","../Entry","./ChatView","./ObserversView","./AttachmentsView","app/wmes-fap-entries/templates/details"],function(e,t,i,a,n,s,o,r,d,l,p,c,u,f){"use strict";return n.extend({template:f,events:{"click .fap-editable-toggle":function(e){var t=this.$(e.target).closest(".fap-prop");this.showEditor(t,t[0].dataset.prop)}},initialize:function(){var e=this.model;this.setView("#-chat",new p({model:e})),this.insertView("#-observersAndAttachments",new c({model:e})),this.insertView("#-observersAndAttachments",new u({model:e})),this.listenTo(e,"change",this.update),this.listenTo(e,"editor:show",this.showEditor),this.listenTo(e,"editor:hide",this.hideEditor),t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},getTemplateData:function(){return{model:this.model.serializeDetails()}},afterRender:function(){this.updateAuth(),this.updateUnseen()},update:function(){var e=this;e.isRendered()&&(Object.keys(e.model.changed).forEach(function(t){l.AUTH_PROPS[t]&&(cancelAnimationFrame(e.timers.auth),e.timers.auth=requestAnimationFrame(e.updateAuth.bind(e)));var i=e.resolveUpdater(t);i&&(cancelAnimationFrame(e.timers[t]),e.timers[t]=requestAnimationFrame(i.bind(e)))}),cancelAnimationFrame(e.timers.unseen),e.timers.unseen=requestAnimationFrame(e.updateUnseen.bind(e)))},resolveUpdater:function(e){switch(e){case"status":return this.updateMessage;case"why5":return this.updateWhy5;case"analysisNeed":case"analysisDone":return this.updateAnalysis;case"solver":return this.updateSolver;case"problem":case"solution":case"solutionSteps":return this.updateMultiline.bind(this,e);case"qtyTodo":case"qtyDone":return this.updateQty;case"orderNo":return this.updateOrderNo;case"analyzers":return this.updateAnalyzers;case"category":case"mrp":case"nc12":case"productName":case"divisions":case"lines":case"assessment":case"mainAnalyzer":case"subdivisionType":case"componentCode":case"componentName":return this.updateProp.bind(this,e)}},updateAuth:function(){var e=this;if(e.isRendered()){var t=e.model.serializeDetails();Object.keys(t.auth).forEach(function(i){var a=e.$('.fap-prop[data-prop="'+i+'"]');a.length&&(a.toggleClass("fap-is-editable",t.auth[i]),a.find(".fap-editable-toggle").length||a.find(".fap-prop-name").append('<i class="fa fa-edit fap-editable-toggle"></i>'))})}},updateUnseen:function(){var e=this,t=e.model.serializeDetails().observer.changes;e.$el.removeClass("fap-is-unseen").find(".fap-is-unseen").removeClass("fap-is-unseen"),t.any&&Object.keys(t).forEach(function(i){switch(i){case"any":break;case"all":e.$el.toggleClass("fap-is-unseen",t[i]);break;case"observers":case"subscribers":case"subscribers$added":case"subscribers$removed":e.$(".fap-observers").addClass("fap-is-unseen");break;case"attachments":e.$(".fap-attachments").addClass("fap-is-unseen");break;case"comment":e.$(".fap-chat").addClass("fap-is-unseen");break;case"status":e.$id("message").addClass("fap-is-unseen");break;default:e.$('.fap-prop[data-prop="'+i+'"]').addClass("fap-is-unseen")}})},updateText:function(e,i){var a=e instanceof t?e.find(".fap-prop-value")[0]:e;a.hasChildNodes()&&(a=a.childNodes[0].nodeType===Node.TEXT_NODE?a.childNodes[0]:a.insertBefore(document.createTextNode(i),a)),a.textContent=i},updateProp:function(e){var t=this.$('.fap-prop[data-prop="'+e+'"]');t.length&&this.updateText(t,this.model.serializeDetails()[e])},updateQty:function(){var e=this.$('.fap-prop[data-prop="qty"]'),t=this.model.serializeDetails();this.updateText(e.find('[data-prop="qtyDone"]')[0],t.qtyDone),this.updateText(e.find('[data-prop="qtyTodo"]')[0],t.qtyTodo)},updateOrderNo:function(){for(var e,t=this.$('.fap-prop[data-prop="orderNo"]').find(".fap-prop-value"),a=this.model.serializeDetails();t[0].firstChild&&"div"!==t[0].firstChild.nodeName;)t[0].removeChild(t[0].firstChild);e="-"===a.orderNo?"-":i.isAllowedTo("ORDERS:VIEW")?'<a href="#orders/'+a.orderNo+'">'+a.orderNo+"</a>":a.orderNo,t.prepend(e)},updateAnalyzers:function(){this.updateProp("mainAnalyzer"),this.updateProp("analyzers")},updateMessage:function(){var e=this.model.serializeDetails();this.$id("message").attr("class","message message-inline message-"+e.message.type).text(e.message.text)},updateMultiline:function(e){var t=this.model.serializeDetails(),i=this.$('.fap-prop[data-prop="'+e+'"]');i.toggleClass("fap-is-multiline",t.multiline[e]).toggleClass("fap-is-success",!1===t.empty[e]),this.updateText(i,t[e])},updateSolver:function(){var e=this.model.serializeDetails();this.$('.fap-prop[data-prop="solution"]').find(".fa-user").attr("title",e.solver)},updateWhy5:function(){var e=this,t=e.model.get("why5");e.$(".fap-analysis-why-value").each(function(i){e.updateText(this,t[i]||"")})},updateAnalysis:function(){this.updateProp("analysisNeed"),this.updateProp("analysisDone"),this.updateMessage()},showEditor:function(e,t){this.hideEditor(),this.editors[t]&&(e.addClass("fap-is-editing"),this.editors[t].call(this,e,t))},hideEditor:function(){var e=this,t=e.$(".fap-editor");t.find(".select2-container").each(function(){e.$(this.nextElementSibling).select2("destroy")}),t.remove(),e.$(".fap-is-editing").removeClass("fap-is-editing")},onKeyDown:function(e){"Escape"===e.originalEvent.key&&this.hideEditor()},editors:{textArea:function(e,i,a){var n=this,s=e[0].dataset.prop,o=n.model.get(s),r=t('<form class="fap-editor"></form>'),d=t('<textarea class="form-control"></textarea>').val(o).prop("required",i),l=t('<button class="btn btn-primary btn-lg"><i class="fa fa-check"></i></button>');d.on("keydown",function(e){if("Enter"===e.key&&e.shiftKey)return l.click(),!1}),r.on("submit",function(){var t=d.val().trim();return t!==o&&(a?n.model.multiChange(a(t,o,s,e)):n.model.change(s,t)),n.hideEditor(),!1}),r.append(d).append(l).appendTo(e.find(".fap-prop-value")),d.focus(),l[0].scrollIntoViewIfNeeded?l[0].scrollIntoViewIfNeeded():l[0].scrollIntoView()},select:function(i,a){var n=this,s=i[0].dataset.prop,o=n.model.get(s),r=t('<form class="fap-editor"></form>'),d=t('<select class="form-control"></select>'),l=t('<button class="btn btn-primary"><i class="fa fa-check"></i></button>');r.on("submit",function(){var e=d.val();return e!==o&&n.model.change(s,e),n.hideEditor(),!1}),d.html(a.map(function(t){return'<option value="'+t.id+'">'+e.escape(t.text)+"</option>"}).join("")),d.val(o),r.append(d).append(l).appendTo(i.find(".fap-prop-value")),d.focus()},problem:function(e){this.editors.textArea.call(this,e,!0)},solution:function(e){this.editors.textArea.call(this,e,!1,function(e){return{solution:e,solver:e.trim().length?i.getInfo():null}})},solutionSteps:function(e){this.editors.textArea.call(this,e,!1)},category:function(e){var t=this.model.get("category"),i=d.categories.filter(function(e){return e.id===t||e.get("active")}).map(function(e){return{id:e.id,text:e.getLabel()}});this.editors.select.call(this,e,i)},subdivisionType:function(e){var t=this,i=l.SUBDIVISION_TYPES.map(function(e){return{id:e,text:t.t("subdivisionType:"+e)}});t.editors.select.call(t,e,i)},lines:function(e){var i=this,a={divisions:[].concat(i.model.get("divisions")).sort(l),lines:[].concat(i.model.get("lines")).sort(l)},n=t('<form class="fap-editor"></form>'),r=t("<input>"),d=t('<button class="btn btn-primary"><i class="fa fa-check"></i></button>');function l(e,t){return e.localeCompare(t,void 0,{numeric:!0,ignorePunctuation:!0})}n.on("submit",function(){var e={divisions:[],lines:r.val().split(",").sort(l)};return e.lines.forEach(function(t){var i=o.getAllForProdLine(t).division;i&&-1===e.divisions.indexOf(i)&&e.divisions.push(i)}),e.divisions.sort(l),e.lines.length>0&&JSON.stringify(e)!==JSON.stringify(a)&&i.model.multiChange(e),i.hideEditor(),!1}),r.val(a.lines.join(",")),n.append(r).append(d).appendTo(e.find(".fap-prop-value")),r.select2({dropdownCssClass:"fap-editor-select2",width:"100%",multiple:!0,allowClear:!0,placeholder:" ",data:o.getActiveByType("prodLine").map(s)}),r.focus()},why5:function(e){var i=this,a=[].concat(i.model.get("why5"));e.find(".fap-analysis-why").each(function(n){var s=i.$(this),o=t('<form class="fap-editor"></form>'),r=t('<input class="form-control">').val(a[n]||""),d=t('<button class="btn btn-primary" tabindex="-1"><i class="fa fa-check"></i></button>');o.on("submit",function(){return function(){var t=e.find(".form-control").map(function(){return this.value.trim()}).get(),n=i.model.get("why5"),s=[],o=!1;t.forEach(function(e,t){e===(a[t]||"")?s.push(n[t]||""):(s.push(e),o=!0)}),o&&i.model.change("why5",s);i.hideEditor()}(),!1}),o.append(r).append(d).appendTo(s.find(".fap-analysis-why-value"))}),e.find(".form-control").first().focus()},assessment:function(e){var i=this,a=this.model.get("assessment"),n=t('<form class="fap-editor"></form>');["unspecified","effective","ineffective","repeatable"].forEach(function(e){t('<button type="button" class="btn btn-lg btn-default"></button>').toggleClass("active",a===e).val(e).text(i.t("assessment:"+e)).appendTo(n)}),n.on("click",".btn",function(e){var t=e.currentTarget.value;t!==a&&i.model.change("assessment",t),i.hideEditor()}),n.appendTo(e.find(".fap-prop-value"))},yesNo:function(e,i){var a=this,n=e[0].dataset.prop,s=this.model.get(n),o=t('<form class="fap-editor fap-editor-yesNo"></form>');["true","false"].forEach(function(e){t('<button type="button" class="btn btn-lg btn-default"></button>').toggleClass("active",String(s)===e).val(e).text(a.t("core","BOOL:"+e)).appendTo(o)}),o.on("click",".btn",function(t){var o="true"===t.currentTarget.value;o!==s&&(i?a.model.multiChange(i(o,s,n,e)):a.model.change(n,o)),a.hideEditor()}),o.appendTo(e.find(".fap-prop-value"))},analysisNeed:function(e){this.editors.yesNo.call(this,e,function(e){return{analysisNeed:e,analysisDone:!1,analysisStartedAt:e?new Date:null,analysisFinishedAt:null}})},analysisDone:function(e){this.editors.yesNo.call(this,e,function(e){return{analysisDone:e,analysisFinishedAt:e?new Date:null}})},attachment:function(i){var a=this,n=i[0].dataset.attachmentId,s=e.findWhere(a.model.get("attachments"),{_id:n}),o=i[0].getBoundingClientRect(),r=t('<form class="fap-editor fap-attachments-editor"></form>').css({top:i.offset().top+"px",left:o.left+"px",width:o.width+"px"}),d=t('<input class="form-control" type="text">').prop("id",this.idPrefix+"-attachmentEditor").val(s.name),l=t('<button class="btn btn-primary"><i class="fa fa-check"></i></button>');r.on("submit",function(){var e=JSON.parse(JSON.stringify(s));e.name=d.val().trim();var t=s.name.split(".").pop();return new RegExp("\\."+t+"$","i").test(e.name)||(e.name+="."+t),e.name!==s.name&&a.model.change("attachments",[e],[s]),a.hideEditor(),!1}),r.append(d).append(l).appendTo(this.el),d.focus()},orderNo:function(e){var i=this,n=i.model.get("orderNo"),s=t('<form class="fap-editor"></form>'),r=t('<input class="form-control" type="text" pattern="^[0-9]{9}$" maxlength="9">'),d=t('<button class="btn btn-primary"><i class="fa fa-check"></i></button>');r.on("input",function(){r[0].setCustomValidity("")}),s.on("submit",function(){var e=r.val();if(e===n)return i.hideEditor(),!1;if(""===e)return i.model.multiChange({orderNo:"",mrp:"",nc12:"",productName:"",qtyTodo:0,qtyDone:0,divisions:[],lines:[]}),i.hideEditor(),!1;r.prop("disabled",!0),d.prop("disabled",!0);var t=i.ajax({method:"POST",url:"/fap/entries;validate-order?order="+e});return t.fail(function(){"abort"!==t.statusText&&(r.prop("disabled",!1),d.prop("disabled",!1),404===t.status?(r[0].setCustomValidity(i.t("orderNo:404")),d.click()):a.msg.show({type:"error",time:2500,text:i.t("orderNo:failure")}))}),t.done(function(e){e.divisions=[],e.lines.forEach(function(t){var i=o.getAllForProdLine(t).division;i&&-1===e.divisions.indexOf(i)&&e.divisions.push(i)}),e.divisions.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0,ignorePunctuation:!0})}),i.model.multiChange(e),i.hideEditor()}),!1}),r.val(n),s.append(r).append(d).appendTo(e.find(".fap-prop-value")),r.focus()},analyzers:function(e){var i,a,n=this,s=n.$('.fap-prop[data-prop="mainAnalyzer"]'),o=n.$('.fap-prop[data-prop="analyzers"]'),d=[].concat(n.model.get("analyzers")),l=t('<form class="fap-editor"></form>').append("<input>").append('<button class="btn btn-primary"><i class="fa fa-check"></i></button>'),p=l.clone();function c(){if(a){var e=i?i.val():d;a.select2("enable",0!==e.length)}}function u(){s.removeClass("fap-is-editing"),o.removeClass("fap-is-editing");var e=[],t={},r=!0;if(i){var l=i.select2("data");l&&e.push({id:l.id,label:l.text})}else d.length?e.push(d[0]):r=!1;return e.length&&(t[e[0].id]=!0,a&&a.select2("data").forEach(function(i){t[i.id]||(e.push({id:i.id,label:i.text}),t[i.id]=!0)})),r&&function(e){var t=n.model.get("analyzers"),i=t.length?t[0].id:null,a=t.slice(1).map(function(e){return e.id}).sort().join(","),s=e.length?e[0].id:null,o=e.slice(1).map(function(e){return e.id}).sort().join(",");return s!==i||o!==a}(e)&&n.model.change("analyzers",e),n.hideEditor(),!1}s.hasClass("fap-is-editable")&&(s.addClass("fap-is-editing"),i=l.on("submit",u).appendTo(s.find(".fap-prop-value")).find("input").val(d.length?d[0].id:"").on("change",c),r(i,{view:n,dropdownCssClass:"fap-editor-select2",width:"100%",noPersonnelId:!0})),o.hasClass("fap-is-editable")&&(o.addClass("fap-is-editing"),a=p.on("submit",u).appendTo(o.find(".fap-prop-value")).find("input").val(d.length>1?d.slice(1).map(function(e){return e.id}).join(","):""),r(a,{view:n,dropdownCssClass:"fap-editor-select2",width:"100%",multiple:!0,noPersonnelId:!0})),c(),e.find(".select2-container").next().select2("focus")},mainAnalyzer:function(){this.editors.analyzers.apply(this,arguments)},componentCode:function(e){var i=this,n=i.model.get("componentCode"),s=t('<form class="fap-editor"></form>'),o=t('<input class="form-control" type="text" pattern="^[0-9]{1,12}$" maxlength="12">'),r=t('<button class="btn btn-primary"><i class="fa fa-check"></i></button>');o.on("input",function(){o[0].setCustomValidity("")}),s.on("submit",function(){var e=o.val();if(e===n)return i.hideEditor(),!1;if(""===e)return i.model.multiChange({componentCode:"",componentName:""}),i.hideEditor(),!1;o.prop("disabled",!0),r.prop("disabled",!0);var t=i.ajax({method:"POST",url:"/fap/entries;validate-component?nc12="+e});return t.fail(function(){"abort"!==t.statusText&&(o.prop("disabled",!1),r.prop("disabled",!1),404===t.status?(o[0].setCustomValidity(i.t("componentCode:404")),r.click()):a.msg.show({type:"error",time:2500,text:i.t("componentCode:failure")}))}),t.done(function(e){i.model.multiChange({componentCode:e._id,componentName:e.name}),i.hideEditor()}),!1}),o.val(n),s.append(o).append(r).appendTo(e.find(".fap-prop-value")),o.focus()}}})});