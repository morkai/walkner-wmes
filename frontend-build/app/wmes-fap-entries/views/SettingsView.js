define(["app/viewport","app/data/prodFunctions","app/core/Model","app/core/util/idAndLabel","app/core/util/uuid","app/core/templates/userInfo","app/settings/views/SettingsView","app/users/util/setUpUserSelect2","./QuickUsersFormView","app/wmes-fap-entries/templates/settings","app/wmes-fap-entries/templates/quickUsersTable"],function(t,e,s,i,n,a,u,c,r,l,d){"use strict";return u.extend({clientUrl:"#fap/settings",template:l,events:Object.assign({"change input[data-setting]":function(t){this.updateSetting(t.target.name,this.getValueFromSettingField(t.target))},"click #-addQuickUser":function(){this.showQuickUserDialog({_id:n(),label:"",funcs:[],users:[]})},'click .btn[data-action="editQuickUser"]':function(t){const e=this.$(t.target).closest("tr")[0].dataset.id,s=this.settings.getValue("quickUsers",[]).find(t=>t._id===e);s&&this.showQuickUserDialog(s)},'click .btn[data-action="removeQuickUser"]':function(t){const e=this.$(t.target).closest("tr"),s=e[0].dataset.id;e.fadeOut("fast",()=>e.remove()),this.updateSetting("fap.quickUsers",this.settings.getValue("quickUsers",[]).filter(t=>t._id!==s))}},u.prototype.events),afterRender:function(){u.prototype.afterRender.apply(this,arguments),this.setUpFunctions(),this.renderQuickUsers()},setUpFunctions:function(){this.$id("pendingFunctions").select2({width:"100%",allowClear:!0,multiple:!0,data:e.map(i)}),this.$id("categoryFunctions").select2({width:"100%",allowClear:!0,multiple:!0,data:e.map(i)}),this.updateSettingField(this.settings.get("fap.pendingFunctions")),this.updateSettingField(this.settings.get("fap.categoryFunctions"))},shouldAutoUpdateSettingField:function(t){return!/(Functions|quickUsers)$/i.test(t.id)},updateSettingField:function(t){t&&(/Functions$/i.test(t.id)&&this.$id(t.id.split(".")[1]).select2("data",(t.getValue()||[]).map(t=>{const s=e.get(t);return{id:t,text:s?s.getLabel():t}})),"fap.quickUsers"===t.id&&this.renderQuickUsers())},renderQuickUsers:function(){this.$id("quickUsers").replaceWith(this.renderPartialHtml(d,{quickUsers:this.settings.getValue("quickUsers",[]).map(t=>({_id:t._id,label:t.label,funcs:t.funcs.map(t=>e.getLabel(t)).join(", "),users:t.users.map(t=>a(t)).join(", ")}))}))},showQuickUserDialog:function(e){const i=new r({model:new s(e)});t.showDialog(i),this.listenTo(i,"save",e=>{t.closeDialog();const s=[].concat(this.settings.getValue("quickUsers",[])),i=s.findIndex(t=>t._id===e._id);-1===i?(e.funcs.length||e.users.length)&&s.push(e):e.funcs.length||e.users.length?s[i]=e:s.splice(i,1),this.updateSetting("fap.quickUsers",s),this.renderQuickUsers()})}})});