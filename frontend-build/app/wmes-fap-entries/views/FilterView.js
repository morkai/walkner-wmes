define(["underscore","app/time","app/user","app/core/views/FilterView","app/core/util/forms/dateTimeRange","app/core/util/idAndLabel","app/data/orgUnits","app/users/util/setUpUserSelect2","app/mrpControllers/util/setUpMrpSelect2","../dictionaries","../Entry","app/wmes-fap-entries/templates/filter","app/core/util/ExpandableSelect"],function(e,t,s,i,a,r,n,o,l,u,p,c){"use strict";return i.extend({filterList:["createdAt","order","mrp","category","subdivisionType","divisions","level","limit"],filterMap:{orderNo:"order",nc12:"order",productName:"search",problem:"search"},template:c,events:e.assign({"click a[data-date-time-range]":a.handleRangeEvent,'change input[name="userType"]':function(){this.toggleUserSelect2(!0)},'change input[name="statusType"]':"toggleStatus","click #-level .active":function(e){setTimeout(function(){e.currentTarget.classList.remove("active"),e.currentTarget.querySelector("input").checked=!1},1)}},i.prototype.events),defaultFormData:function(){return{userType:"others",statusType:"specific"}},termToForm:{createdAt:a.rqlToForm,orderNo:function(e,t,s){s.order=t.args[1]},nc12:"orderNo",search:function(e,t,s){s[e]=t.args[1]},level:"search","observers.user.id":function(e,t,i){t.args[1]===s.data._id?(i.userType="mine",i.user=s.data._id):"unseen"===t.args[1]?(i.userType="unseen",i.user=null):(i.userType="others",i.user=t.args[1])},"changes.user.id":function(e,t,s){s.userType="active",s.user=t.args[1]},status:function(e,t,s){s[e]="in"===t.name?t.args[1]:[t.args[1]]},divisions:"status",mrp:function(e,t,s){s[e]=Array.isArray(t.args[1])?t.args[1].join(","):""},category:"mrp",subCategory:"mrp",analysisNeed:function(e,t,s){s[e]=t.args[1],s.statusType=void 0===s.analysisNeed||void 0===s.analysisDone?"specific":"analysis"},analysisDone:"analysisNeed",subdivisionType:"divisions"},serializeTermToForm:function(e,t){if("or"===e.name){var s=[];return e.args.forEach(function(e){"in"!==e.name||"category"!==e.args[0]&&"subCategory"!==e.args[0]||(s=s.concat(e.args[1]))}),void(s.length&&(t.category=s.join(",")))}i.prototype.serializeTermToForm.apply(this,arguments)},serialize:function(){return e.assign(i.prototype.serialize.call(this),{statuses:["pending","started","finished"],divisions:n.getAllByType("division").filter(function(e){return e.isActive()&&"prod"===e.get("type")}).map(r),subdivisionTypes:u.subdivisionTypes})},serializeFormToQuery:function(t){var i=this.$('input[name="userType"]:checked').val(),r=this.$('input[name="statusType"]:checked').val(),n=this.$('input[name="level"]:checked').val(),o=(this.$id("status").val()||[]).filter(function(t){return!e.isEmpty(t)}),l=(this.$id("divisions").val()||[]).filter(function(t){return!e.isEmpty(t)}),p=(this.$id("subdivisionType").val()||[]).filter(function(t){return!e.isEmpty(t)}),c=this.$id("user").val(),d=this.$id("order").val().trim(),g=this.$id("mrp").val(),h=this.$id("category").val(),m=this.$id("search").val().trim();if(a.formToRql(this,t),"mine"===i?t.push({name:"eq",args:["observers.user.id",s.data._id]}):"unseen"===i?t.push({name:"eq",args:["observers.user.id",i]}):"active"===i?t.push({name:"eq",args:["changes.user.id",c]}):c&&t.push({name:"eq",args:["observers.user.id",c]}),9===d.length?t.push({name:"eq",args:["orderNo",d]}):d.length&&t.push({name:"eq",args:["nc12",d]}),"specific"===r&&o.length?t.push({name:"in",args:["status",o]}):"analysis"===r&&t.push({name:"eq",args:["analysisNeed",!0]},{name:"eq",args:["analysisDone",!1]}),n>=0&&t.push({name:"eq",args:["level",+n]}),g&&g.length&&t.push({name:"in",args:["mrp",g.split(",")]}),h&&h.length){var v=[],y=[];h.split(",").forEach(function(e){u.categories.get(e)?v.push(e):u.subCategories.get(e)&&y.push(e)}),v.length&&y.length?t.push({name:"or",args:[{name:"in",args:["category",v]},{name:"in",args:["subCategory",y]}]}):v.length?t.push({name:"in",args:["category",v]}):y.length&&t.push({name:"in",args:["subCategory",y]})}l.length&&t.push({name:"in",args:["divisions",l]}),p.length&&t.push({name:"in",args:["subdivisionType",p]}),m.length&&t.push({name:"eq",args:["search",m]})},afterRender:function(){i.prototype.afterRender.call(this),this.$id("limit").parent().attr("data-filter","limit"),this.$(".is-expandable").expandableSelect(),o(this.$id("user"),{view:this,width:"100%"}),l(this.$id("mrp"),{own:!0,view:this,width:"250px"}),this.setUpCategorySelect2(),this.toggleButtonGroup("level"),this.toggleUserSelect2(!1),this.toggleStatus()},destroy:function(){i.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},setUpCategorySelect2:function(){var e={};u.subCategories.forEach(function(t){if(t.get("active")){var s=t.get("parent");e[s]||(e[s]=[]),e[s].push(t)}}),this.$id("category").select2({width:"280px",multiple:!0,allowClear:!0,data:u.categories.filter(function(e){return e.get("active")}).map(function(t){var s=e[t.id];return{id:t.id,text:t.getLabel(),children:s?s.map(r):[]}})})},toggleUserSelect2:function(e){var t=this.$('input[name="userType"]:checked').val(),i=this.$id("user").select2("enable","others"===t||"active"===t);e&&i.val()===s.data._id&&i.select2("data",null)},toggleStatus:function(){var e=this.$('input[name="statusType"]:checked').val();this.$id("status").prop("disabled","specific"!==e)},filterHasValue:function(e){if("createdAt"===e){var t=this.$id("from-date"),s=this.$id("to-date");return t.val().length>0||s.val().length>0}return i.prototype.filterHasValue.apply(this,arguments)}})});