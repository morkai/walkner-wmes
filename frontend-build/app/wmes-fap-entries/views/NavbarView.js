define(["underscore","jquery","app/broker","app/user","app/notifications","app/core/View","../Entry","./AddFormView","app/wmes-fap-entries/templates/navbar"],function(e,n,t,i,s,d,a,r,o){"use strict";return d.extend({template:o,events:{"click #-add":function(){if(this.$(".fap-addForm").length)return this.hideAddForm();clearTimeout(this.timers.resetNewEntry),this.timers.resetNewEntry=null,this.toggleAddForm(!0);var e=new r({model:this.model});this.listenTo(e,"cancel",this.hideAddForm),this.setView("#-addForm",e).render()}},initialize:function(){var e=this;e.model=new a,e.listenTo(e.model,"sync",function(){e.hideAddForm(),e.timers.resetModel=setTimeout(e.resetEntry.bind(e),1)}),n(window).on("keydown."+e.idPrefix,e.onKeyDown.bind(e))},destroy:function(){n(window).off("."+this.idPrefix)},getTemplateData:function(){return{browseEntriesLinks:[{label:"all",rql:""},{label:"open",rql:"&status=in=(pending,started)"},{label:"pending",rql:"&status=in=(pending)"},{label:"started",rql:"&status=in=(started)"},{label:"finished",rql:"&status=in=(finished)"},{label:"analysis",rql:"&analysisNeed=true&analysisDone=false"}]}},afterRender:function(){this.setUpUnseen(),i.isLoggedIn()?this.$(".fap-addForm").length&&this.toggleAddForm(!0):this.$el.addClass("hidden")},setUpUnseen:function(){this.notifications&&this.notifications.cancel(),this.reloadUnseen(),i.isLoggedIn()&&(this.notifications=this.pubsub.subscribe("fap.entries.notifications."+i.data._id,this.onNotification.bind(this)))},reloadUnseen:function(){var e=this;e.unseenEntries=[],e.$(".fap-navbarBtn-unseen").addClass("disabled").text("?"),e.req&&(e.req.abort(),e.req=null),i.isLoggedIn()&&(e.req=e.ajax({url:"/fap/entries;unseen"}),e.req.done(function(n){e.unseenEntries=n,e.toggleUnseen()}),e.req.always(function(){e.req=null}))},toggleUnseen:function(){this.$(".fap-navbarBtn-unseen").toggleClass("disabled",0===this.unseenEntries.length).text(this.unseenEntries.length)},toggleAddForm:function(e){var n=this.$id("add").find(".fa");this.$el.toggleClass("fap-navbar-adding",e),this.$id("menu").prop("disabled",e),e?n.removeClass("fa-plus").addClass("fa-times"):n.removeClass("fa-times").addClass("fa-plus")},hideAddForm:function(){var e=this;e.$(".fap-addForm").length&&(e.removeView("#-addForm"),e.toggleAddForm(!1),e.timers.resetNewEntry=setTimeout(function(){e.model.clear()},3e5))},resetEntry:function(){var e=this.model;delete e.focusedInput,delete e.uploadQueue,delete e.uploading,delete e.uploadedFiles,delete e.validatedOrder,e.clear()},onKeyDown:function(e){"Escape"===e.originalEvent.key&&this.hideAddForm()},onNotification:function(e){e.added&&this.handleAddedEntry(e.added),e.changed&&this.handleChangedEntry(e.changed),e.removed&&this.handleRemovedEntries(e.removed),e.seen&&this.handleSeenEntries(e.seen)},handleAddedEntry:function(e){this.unseenEntries.push(e._id),this.toggleUnseen(),this.showAddedNotification(e)},handleChangedEntry:function(e){this.unseenEntries&&(-1===this.unseenEntries.indexOf(e._id)&&(this.unseenEntries.push(e._id),this.toggleUnseen()),e.comment&&!e.unsubscribed&&this.showChangedNotification(e))},handleRemovedEntries:function(e){this.handleSeenEntries(e)},handleSeenEntries:function(e){if(this.unseenEntries||this.unseenEntries.length){this.broker.publish("fap.entries.seen",{seenEntries:e});var n={};e.forEach(function(e){n[e]=!0,s.close(["wmes-fap",e])}),this.unseenEntries=this.unseenEntries.filter(function(e){return!n[e]}),this.toggleUnseen()}},showAddedNotification:function(n){s.show({tag:"wmes-fap "+n._id,title:this.t("notifications:added:title",{rid:n.rid,category:n.category}),body:n.owner+": "+n.problem,data:{onClick:{open:"/#fap/entries/"+n._id}},scoreClient:function(e){var n=e.focused?1:0;return e.url.includes("#fap/entries")?n+=1e4:e.url.includes("#fap")&&(n+=1e3),n}}).catch(e.noop)},showChangedNotification:function(n){s.show({tag:"wmes-fap "+n._id,title:this.t("notifications:changed:title",{rid:n.rid}),body:n.updater+": "+n.comment,actions:[{action:"reply",title:this.t("notifications:changed:reply"),type:"text",placeholder:this.t("notifications:changed:placeholder")}],data:{onClick:{open:"/#fap/entries/"+n._id},onAction:{reply:{act:{action:"wmesFapComment",data:{entryId:n._id}}}}},scoreClient:function(e){var t=e.focused?1:0;if(e.url.includes("#fap/entries/"+n._id)){if(e.focused)return-1;t+=1e5}else e.url.includes("#fap/entries")?t+=1e4:e.url.includes("#fap")&&(t+=1e3);return t}}).catch(e.noop)}},{setUp:function(){if(!window.MODULES||-1!==window.MODULES.indexOf("wmes-fap")){var e=this;t.subscribe("navbar.rendered",function(n){var t=n.view;if(!t.$el.find(".fap-navbar").length){var i=new e;t.insertView(".navbar-collapse",i).render()}})}}})});