define(["underscore","app/viewport","app/core/View","app/users/util/setUpUserSelect2","../dictionaries","app/wmes-fap-entries/templates/observers"],function(e,s,i,t,r,n){"use strict";return i.extend({template:n,events:{"change #-observer":function(){var e=this.$id("observer"),s=t.getUserInfo(e);e.select2("data",null),this.addObserver(s)},"click a[data-quick-add]":function(e){e.preventDefault();var s=e.currentTarget.dataset.quickAdd,i=r.settings.getValue("quickUsers",[]).find(function(e){return e._id===s});i.funcs.length?this.loadQuickUsers(i):i.users.length&&this.addQuickUsers(i.users)}},initialize:function(){this.once("afterRender",function(){this.listenTo(this.model,"change:observers",e.debounce(this.onObserversChanged.bind(this),1)),this.listenTo(this.model,"change:presence",this.onPresenceChanged),this.listenTo(this.model,"change:level",this.toggleMessage),this.listenTo(r.settings,"change:value",this.onSettingChanged)})},getTemplateData:function(){return{showMessage:this.isMessageVisible(),observers:this.model.serializeDetails().observers}},afterRender:function(){var e=this.$id("observer"),s=this.model.serializeDetails().auth.observers;t(e,{width:"100%",noPersonnelId:!0,placeholder:this.t("observers:placeholder"+(s?"":":auth"))}),s||(e.select2("enable",!1),this.$id("quickAdd").find(".btn").prop("disabled",!0)),this.updateQuickAdd()},loadQuickUsers:function(e){var i=this;s.msg.loading();var t=i.ajax({url:"/users?select(firstName,lastName,login)&prodFunction=in=("+e.funcs.join(",")+")&limit(100)"});t.fail(function(){s.msg.loadingFailed()}),t.done(function(t){s.msg.loaded();var r={};e.users.forEach(function(e){r[e.id]=e}),(t.collection||[]).forEach(function(e){r[e._id]={id:e._id,label:e.lastName||e.firstName?(e.lastName+" "+e.firstName).trim():e.name||e.login||e._id}}),i.addQuickUsers(Object.values(r))})},addQuickUsers:function(e){var s={};this.model.get("observers").forEach(function(e){s[e.user.id]=!0});var i={};e.forEach(function(e){s[e.id]||i[e.id]||(i[e.id]=e)}),(i=Object.values(i)).length&&this.model.change("subscribers",i,null)},addObserver:function(s){if(!e.some(this.model.get("observers"),function(e){return e.user.id===s.id})){var i=[s];this.model.change("subscribers",i,null)}this.timers.focus=setTimeout(this.focusObserver.bind(this,s.id),1)},focusObserver:function(e){var s=this,i=s.$('.fap-observer[data-observer-id="'+e+'"]');i.length&&(i[0].scrollIntoViewIfNeeded?i[0].scrollIntoViewIfNeeded():i[0].scrollIntoView(),s.$(".highlight").removeClass("highlight"),clearTimeout(this.timers.highlight),this.timers.highlight=setTimeout(function(){(i=s.$('.fap-observer[data-observer-id="'+e+'"]')).addClass("highlight"),s.timers.highlight=setTimeout(function(){i.removeClass("highlight")},1100)},100))},hideUserInfoPopover:function(){this.$(".userInfoPopover").prev().popover("destroy")},isMessageVisible:function(){var e=this.model.serializeDetails();return 0===e.level&&1===e.observers.length},toggleMessage:function(){this.$el.toggleClass("fap-details-panel-message-show",this.isMessageVisible())},updateQuickAdd:function(){var s={};this.model.serializeDetails().observers.forEach(function(e){s[e._id]=!0});var i="";r.settings.getValue("quickUsers",[]).forEach(function(s){i+='<li><a href="#" data-quick-add="'+s._id+'">'+e.escape(s.label)+"</a></li>"}),this.$id("quickAdd").find("ul").html(i),this.$id("quickAdd").find(".btn").prop("disabled",!i.length)},onObserversChanged:function(){var e=this.renderPartial(n,{showMessage:!1,observers:this.model.serializeObservers()}).find(".fap-details-panel-bd");this.$(".fap-details-panel-bd").replaceWith(e),e.on("scroll",this.hideUserInfoPopover.bind(this)),this.toggleMessage(),this.updateQuickAdd()},onPresenceChanged:function(e,s,i){this.$('.fap-observer[data-observer-id="'+i.userId+'"]').toggleClass("fap-is-online",i.online)},onSettingChanged:function(e){/quickUsers$/.test(e.id)&&this.updateQuickAdd()}})});