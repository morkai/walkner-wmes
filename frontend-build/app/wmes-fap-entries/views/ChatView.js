define(["underscore","jquery","getCaretCoordinates","app/user","app/core/View","app/core/util/transliterate","app/planning/util/contextMenu","app/wmes-fap-entries/templates/chat","app/wmes-fap-entries/templates/chatMessage"],function(e,t,a,s,i,n,r,l,o){"use strict";return i.extend({template:l,events:{"keydown #-send":function(e){var t=e.originalEvent.key;if("Tab"===t)return this.showUserAutocomplete(),!1;if(this.removeAutocompleteUser(t))return!1;var a="Enter"===t;return(!(a||" "===t)||""!==e.target.value.trim())&&(a&&!e.shiftKey?(this.send(),!1):void 0)},"keyup #-send":function(){var e=this.$id("messages"),t=this.$id("send"),a=t[0].offsetHeight,s=t.val().split("\n").length,i=!1;s>10&&(s=10,i=!0),t.attr("rows",s).toggleClass("fap-chat-send-scroll",i);var n=t[0].offsetHeight,r=n-a;e.css("height",563-n),r<0&&this.isScrolledToBottom()||(e[0].scrollTop+=n-a)},"click #-new":function(){var e=this.$id("messages");this.$id("new").addClass("hidden"),e.animate({scrollTop:e[0].scrollHeight},"fast")},"click .fap-chat-attachment":function(e){this.model.trigger("focusAttachment",e.currentTarget.dataset.attachmentId)}},initialize:function(){this.chatScrollTop=-1,this.listenTo(this.model,"change:changes",this.onChange)},getTemplateData:function(){return{model:this.model.serializeDetails(),renderMessage:o}},afterRender:function(){var e=this.$id("messages");e[0].scrollTop=-1===this.chatScrollTop?9999999:this.chatScrollTop,e.on("scroll",this.onScroll.bind(this))},send:function(){var e=this.$id("send"),t=e.val().trim(),a={};e.val(""),s.isLoggedIn()&&!this.model.isObserver()&&(a.subscribers=[null,[{id:s.data._id,label:s.getLabel()}]]),this.model.handleChange({date:new Date,user:s.getInfo(),data:a,comment:t}),this.model.update({comment:t})},onChange:function(){if(this.isRendered()){var t=e.last(this.model.get("changes"));t&&t.user&&this.handleChange(t)}},handleChange:function(e){e.data.attachments&&!e.data.attachments[1]&&this.removeAttachments(e.data.attachments[0]);var a=this.model.serializeChatMessage(e);if(a.lines.length){var i=this.$id("messages"),n=this.$(i[0].lastElementChild),r=this.isScrolledToBottom();if(n[0].dataset.userId===e.user.id){var l=n.find(".fap-chat-lines");a.lines.forEach(function(e){t('<div class="fap-chat-line"></div>').attr("title",e.time).html(e.text).appendTo(l)})}else this.renderPartial(o,{message:a}).appendTo(i);r?i[0].scrollTop=i[0].scrollHeight:s.data._id!==e.user.id&&this.$id("new").removeClass("hidden")}},removeAttachments:function(e){var t=this;e.forEach(function(e){t.$('.fap-chat-attachment[data-attachment-id="'+e._id+'"]').css("text-decoration","line-through")})},showUserAutocomplete:function(){for(var e=this,t=e.$id("send")[0],i=t.selectionEnd,l=i-1,o=/^[^a-zA-Z0-9]$/,c="Â ",h="";;){if((h=n(t.value.charAt(l)))===c)return;if(0===h.length){l=0;break}if("\udc64"!==h&&o.test(h))break;--l}for(;;){if((h=n(t.value.charAt(i)))===c)return;if(0===h.length){i=t.value.length;break}if(o.test(h))break;++i}var d=t.value.substring(0,l),u=t.value.substring(i),f=n(t.value.substring(l,i)).toUpperCase().replace(/[^A-Z0-9]+/g,"");d.length&&!/[<\[{(\s]$/.test(d.charAt(d.length-1))&&(d+=" "),u.length&&!/^[!?,.>\]})\s]/.test(n(u.charAt(0)))&&(u=" "+u);for(var g=[],m=0===f.length,p={},v=999,b=e.model.get("changes"),T=b.length-1;T>=0;--T){var $=b[T];$.comment&&(p[$.user.id]=v--)}if(e.model.get("observers").forEach(function(e){if(e.user.id!==s.data._id){var a=n(e.user.label).toUpperCase().replace(/[^A-Z0-9]+/g,""),i=m?-1:a.indexOf(f);(m||-1!==i)&&g.push({label:e.user.label,handler:function(e){var a=d+"ðŸ‘¤"+e.replace(/\s+/g,c);0===u.length&&(a+=" ");t.value=a+u,t.setSelectionRange(a.length,a.length)}.bind(null,e.user.label),score:(p[e.user.id]||0)+(m?0:0===i?100:0)})}}),0!==g.length)if(1!==g.length){g.sort(function(e,t){return e.score===t.score?e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}):t.score-e.score}),g.length>10&&(g=g.slice(0,10)).push({disabled:!0,label:"..."});var A=e.$(".fap-chat-form").position(),k=a(t,t.selectionEnd),C=A.top+k.top+k.height,w=A.left+k.left;r.show(e,C,w,{menu:g}),e.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){e.$id("send").focus()})}else g[0].handler()},removeAutocompleteUser:function(e){if("Backspace"!==e&&"Delete"!==e)return!1;var t=this.$id("send")[0],a=t.value,s=t.selectionStart,i=t.selectionEnd;s===i&&("Backspace"===e&&s>0?s-=1:"Delete"===e&&(i+=1));for(var r=/^[^a-zA-Z0-9\u00a0]$/,l=s;l>=0;--l){var o=n(a.charAt(l));if("\udc64"===o){s=l-1;break}if(r.test(o))break}for(var c=i;c>=0;--c){var h=n(a.charAt(c));if("\udc64"===h){for(;i<a.length;++i){var d=n(a.charAt(i));if("\udc64"!==d&&r.test(d))break}break}if(r.test(h))break}return t.value=a.substring(0,s)+a.substring(i),t.setSelectionRange(s,s),!0},isScrolledToBottom:function(){var e=this.$id("messages")[0];return Math.abs(e.scrollHeight-e.scrollTop-e.clientHeight)<5},onScroll:function(e){this.chatScrollTop=e.target.scrollTop,this.isScrolledToBottom()&&this.$id("new").addClass("hidden")}})});