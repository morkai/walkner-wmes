define(["underscore","jquery","getCaretCoordinates","app/user","app/core/View","app/core/util/transliterate","app/planning/util/contextMenu","app/wmes-fap-entries/templates/chat","app/wmes-fap-entries/templates/chatMessage"],function(e,t,s,a,i,n,r,l,o){"use strict";return i.extend({template:l,events:{"keydown #-send":function(e){var t=e.originalEvent.key;if("Tab"===t)return this.showUserAutocomplete(),!1;if(this.removeAutocompleteUser(t))return!1;var s="Enter"===t;return(!(s||" "===t)||""!==e.target.value.trim())&&(s&&!e.shiftKey?(this.send(),!1):void 0)},"keyup #-send":function(){var e=this.$id("messages"),t=this.$id("send"),s=t[0].offsetHeight,a=t.val().split("\n").length,i=!1;a>10&&(a=10,i=!0),t.attr("rows",a).toggleClass("fap-chat-send-scroll",i);var n=t[0].offsetHeight,r=n-s;e.css("height",563-n),r<0&&this.isScrolledToBottom()||(e[0].scrollTop+=n-s)},"click #-new":function(){var e=this.$id("messages");this.$id("new").addClass("hidden"),e.animate({scrollTop:e[0].scrollHeight},"fast")},"click .fap-chat-attachment":function(e){this.model.trigger("focusAttachment",e.currentTarget.dataset.attachmentId)}},initialize:function(){this.chatScrollTop=-1,this.listenTo(this.model,"change:changes",this.onChange)},getTemplateData:function(){return{model:this.model.serializeDetails(),renderMessage:o}},afterRender:function(){var e=this.$id("messages");e[0].scrollTop=-1===this.chatScrollTop?9999999:this.chatScrollTop,e.on("scroll",this.onScroll.bind(this))},send:function(){var e=this.$id("send"),t=e.val().trim(),s={};e.val(""),a.isLoggedIn()&&!this.model.isObserver()&&(s.subscribers=[null,[{id:a.data._id,label:a.getLabel()}]]),this.model.handleChange({date:new Date,user:a.getInfo(),data:s,comment:t}),this.model.update({comment:t})},onChange:function(){if(this.isRendered()){var t=e.last(this.model.get("changes"));t&&t.user&&this.handleChange(t)}},handleChange:function(e){var s=this.model.serializeChatMessage(e);if(s.lines.length){var i=this.$id("messages"),n=this.$(i[0].lastElementChild),r=this.isScrolledToBottom();if(n[0].dataset.userId===e.user.id){var l=n.find(".fap-chat-lines");s.lines.forEach(function(e){t('<div class="fap-chat-line"></div>').attr("title",e.time).html(e.text).appendTo(l)})}else this.renderPartial(o,{message:s}).appendTo(i);r?i[0].scrollTop=i[0].scrollHeight:a.data._id!==e.user.id&&this.$id("new").removeClass("hidden")}},showUserAutocomplete:function(){for(var e=this,t=e.$id("send")[0],i=t.selectionEnd,l=i-1,o=/^[^a-zA-Z0-9]$/,c="Â ",h="";;){if((h=n(t.value.charAt(l)))===c)return;if(0===h.length){l=0;break}if("\udc64"!==h&&o.test(h))break;--l}for(;;){if((h=n(t.value.charAt(i)))===c)return;if(0===h.length){i=t.value.length;break}if(o.test(h))break;++i}var d=t.value.substring(0,l),u=t.value.substring(i),g=n(t.value.substring(l,i)).toUpperCase().replace(/[^A-Z0-9]+/g,"");d.length&&!/[<\[{(\s]$/.test(d.charAt(d.length-1))&&(d+=" "),u.length&&!/^[!?,.>\]})\s]/.test(n(u.charAt(0)))&&(u=" "+u);for(var f=[],p=0===g.length,m={},v=999,b=e.model.get("changes"),T=b.length-1;T>=0;--T){var $=b[T];$.comment&&(m[$.user.id]=v--)}if(e.model.get("observers").forEach(function(e){if(e.user.id!==a.data._id){var s=n(e.user.label).toUpperCase().replace(/[^A-Z0-9]+/g,""),i=p?-1:s.indexOf(g);(p||-1!==i)&&f.push({label:e.user.label,handler:function(e){var s=d+"ðŸ‘¤"+e.replace(/\s+/g,c);0===u.length&&(s+=" ");t.value=s+u,t.setSelectionRange(s.length,s.length)}.bind(null,e.user.label),score:(m[e.user.id]||0)+(p?0:0===i?100:0)})}}),0!==f.length)if(1!==f.length){f.sort(function(e,t){return e.score===t.score?e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}):t.score-e.score}),f.length>10&&(f=f.slice(0,10)).push({disabled:!0,label:"..."});var k=e.$(".fap-chat-form").position(),A=s(t,t.selectionEnd),C=k.top+A.top+A.height,w=k.left+A.left;r.show(e,C,w,{menu:f}),e.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){e.$id("send").focus()})}else f[0].handler()},removeAutocompleteUser:function(e){if("Backspace"!==e&&"Delete"!==e)return!1;var t=this.$id("send")[0],s=t.value,a=t.selectionStart,i=t.selectionEnd;a===i&&("Backspace"===e&&a>0?a-=1:"Delete"===e&&(i+=1));for(var r=/^[^a-zA-Z0-9\u00a0]$/,l=a;l>=0;--l){var o=n(s.charAt(l));if("\udc64"===o){a=l-1;break}if(r.test(o))break}for(var c=i;c>=0;--c){var h=n(s.charAt(c));if("\udc64"===h){for(;i<s.length;++i){var d=n(s.charAt(i));if("\udc64"!==d&&r.test(d))break}break}if(r.test(h))break}return t.value=s.substring(0,a)+s.substring(i),t.setSelectionRange(a,a),!0},isScrolledToBottom:function(){var e=this.$id("messages")[0];return e.scrollHeight-e.scrollTop===e.clientHeight},onScroll:function(e){this.chatScrollTop=e.target.scrollTop,this.isScrolledToBottom()&&this.$id("new").addClass("hidden")}})});