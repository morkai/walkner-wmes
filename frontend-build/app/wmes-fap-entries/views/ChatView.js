define(["underscore","jquery","app/user","app/core/View","app/wmes-fap-entries/templates/chat","app/wmes-fap-entries/templates/chatMessage"],function(e,t,s,i,a,n){"use strict";return i.extend({template:a,events:{"keydown #-send":function(e){var t=e.originalEvent.key,s="Enter"===t;return(!(s||" "===t)||""!==e.target.value.trim())&&(s&&!e.shiftKey?(this.send(),!1):void 0)},"keyup #-send":function(){var e=this.$id("messages"),t=this.$id("send"),s=t[0].offsetHeight,i=t.val().split("\n").length,a=!1;i>10&&(i=10,a=!0),t.attr("rows",i).toggleClass("fap-chat-send-scroll",a);var n=t[0].offsetHeight,l=n-s;e.css("height",563-n),l<0&&this.isScrolledToBottom()||(e[0].scrollTop+=n-s)},"click #-new":function(){var e=this.$id("messages");this.$id("new").addClass("hidden"),e.animate({scrollTop:e[0].scrollHeight},"fast")},"click .fap-chat-attachment":function(e){this.model.trigger("focusAttachment",e.currentTarget.dataset.attachmentId)}},initialize:function(){this.chatScrollTop=-1,this.listenTo(this.model,"change:changes",this.onChange)},getTemplateData:function(){return{model:this.model.serializeDetails(),renderMessage:n}},afterRender:function(){var e=this.$id("messages");e[0].scrollTop=-1===this.chatScrollTop?9999999:this.chatScrollTop,e.on("scroll",this.onScroll.bind(this))},send:function(){var e=this.$id("send"),t=e.val().trim(),i={};e.val(""),s.isLoggedIn()&&!this.model.isObserver()&&(i.subscribers=[null,[{id:s.data._id,label:s.getLabel()}]]),this.model.handleChange({date:new Date,user:s.getInfo(),data:i,comment:t}),this.model.update({comment:t})},onChange:function(){if(this.isRendered()){var t=e.last(this.model.get("changes"));t&&t.user&&this.handleChange(t)}},handleChange:function(e){var i=this.model.serializeChatMessage(e);if(i.lines.length){var a=this.$id("messages"),l=this.$(a[0].lastElementChild),o=this.isScrolledToBottom();if(l[0].dataset.userId===e.user.id){var r=l.find(".fap-chat-lines");i.lines.forEach(function(e){t('<div class="fap-chat-line"></div>').attr("title",e.time).html(e.text).appendTo(r)})}else this.renderPartial(n,{message:i}).appendTo(a);o?a[0].scrollTop=a[0].scrollHeight:s.data._id!==e.user.id&&this.$id("new").removeClass("hidden")}},isScrolledToBottom:function(){var e=this.$id("messages")[0];return e.scrollHeight-e.scrollTop===e.clientHeight},onScroll:function(e){this.chatScrollTop=e.target.scrollTop,this.isScrolledToBottom()&&this.$id("new").addClass("hidden")}})});