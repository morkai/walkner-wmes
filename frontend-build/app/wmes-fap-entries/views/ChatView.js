define(["underscore","jquery","getCaretCoordinates","app/user","app/core/View","app/core/util/transliterate","app/planning/util/contextMenu","app/wmes-fap-entries/templates/chat","app/wmes-fap-entries/templates/chatMessage"],function(e,t,s,a,i,n,r,l,o){"use strict";return i.extend({template:l,events:{"keydown #-send":function(e){var t=e.originalEvent.key;if("Tab"===t)return this.showUserAutocomplete(),!1;if(this.removeAutocompleteUser(t))return!1;var s="Enter"===t;return(!(s||" "===t)||""!==e.target.value.trim())&&(s&&!e.shiftKey?(this.send(),!1):void 0)},"input #-send":function(){this.resizeSend()},"click #-new":function(){var e=this.$id("messages");this.$id("new").addClass("hidden"),e.animate({scrollTop:e[0].scrollHeight},"fast")},"click .fap-chat-attachment":function(e){this.model.trigger("focusAttachment",e.currentTarget.dataset.attachmentId)}},initialize:function(){this.chatScrollTop=-1,this.listenTo(this.model,"change:changes",this.onChange)},getTemplateData:function(){return{model:this.model.serializeDetails(),renderMessage:o}},afterRender:function(){var e=this.$id("messages");e.length&&(e[0].scrollTop=-1===this.chatScrollTop?9999999:this.chatScrollTop,e.on("scroll",this.onScroll.bind(this)))},send:function(){var e=this.$id("send"),t=e.val().trim(),s={};e.val(""),this.resizeSend(),a.isLoggedIn()&&!this.model.isObserver()&&(s.subscribers=[null,[{id:a.data._id,label:a.getLabel()}]]),this.model.handleChange({date:new Date,user:a.getInfo(),data:s,comment:t}),this.model.update({comment:t})},onChange:function(){if(this.isRendered()){var t=e.last(this.model.get("changes"));t&&t.user&&this.handleChange(t)}},handleChange:function(e){e.data.attachments&&!e.data.attachments[1]&&this.removeAttachments(e.data.attachments[0]);var s=this.model.serializeChatMessage(e);if(s.lines.length){var i=this.$id("messages"),n=this.$(i[0].lastElementChild),r=this.isScrolledToBottom();if(n[0].dataset.userId===e.user.id){var l=n.find(".fap-chat-lines");s.lines.forEach(function(e){t('<div class="fap-chat-line"></div>').attr("title",e.time).html(e.text).appendTo(l)})}else this.renderPartial(o,{message:s}).appendTo(i);r?i[0].scrollTop=i[0].scrollHeight:a.data._id!==e.user.id&&this.$id("new").removeClass("hidden")}},removeAttachments:function(e){var t=this;e.forEach(function(e){t.$('.fap-chat-attachment[data-attachment-id="'+e._id+'"]').css("text-decoration","line-through")})},showUserAutocomplete:function(){for(var e=this,t=e.$id("send")[0],i=t.selectionEnd,l=i-1,o=/^[^a-zA-Z0-9]$/,h="Â ",c="";;){if((c=n(t.value.charAt(l)))===h)return;if(0===c.length){l=0;break}if("\udc64"!==c&&o.test(c))break;--l}for(;;){if((c=n(t.value.charAt(i)))===h)return;if(0===c.length){i=t.value.length;break}if(o.test(c))break;++i}var d=t.value.substring(0,l),u=t.value.substring(i),g=n(t.value.substring(l,i)).toUpperCase().replace(/[^A-Z0-9]+/g,"");d.length&&!/[<\[{(\s]$/.test(d.charAt(d.length-1))&&(d+=" "),u.length&&!/^[!?,.>\]})\s]/.test(n(u.charAt(0)))&&(u=" "+u);for(var f=[],m=0===g.length,p={},v=999,b=e.model.get("changes"),T=b.length-1;T>=0;--T){var S=b[T];S.comment&&(p[S.user.id]=v--)}if(e.model.get("observers").forEach(function(s){if(s.user.id!==a.data._id){var i=n(s.user.label).toUpperCase().replace(/[^A-Z0-9]+/g,""),r=m?-1:i.indexOf(g);(m||-1!==r)&&f.push({label:s.user.label,handler:function(s){var a=d+"ðŸ‘¤"+s.replace(/\s+/g,h);0===u.length&&(a+=" ");t.value=a+u,t.setSelectionRange(a.length,a.length),e.resizeSend()}.bind(null,s.user.label),score:(p[s.user.id]||0)+(m?0:0===r?100:0)})}}),0!==f.length)if(1!==f.length){f.sort(function(e,t){return e.score===t.score?e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}):t.score-e.score}),f.length>10&&(f=f.slice(0,10)).push({disabled:!0,label:"..."});var $=e.$(".fap-chat-form").position(),A=s(t,t.selectionEnd),k=$.top+A.top+A.height,C=$.left+A.left;r.show(e,k,C,{menu:f}),e.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){e.$id("send").focus()})}else f[0].handler()},removeAutocompleteUser:function(e){if("Backspace"!==e&&"Delete"!==e)return!1;var t=this.$id("send")[0],s=t.value,a=t.selectionStart,i=t.selectionEnd;a===i&&("Backspace"===e&&a>0?a-=1:"Delete"===e&&(i+=1));for(var r=/^[^a-zA-Z0-9\u00a0]$/,l=a;l>=0;--l){var o=n(s.charAt(l));if("\udc64"===o){a=l-1;break}if(r.test(o))break}for(var h=i;h>=0;--h){var c=n(s.charAt(h));if("\udc64"===c){for(;i<s.length;++i){var d=n(s.charAt(i));if("\udc64"!==d&&r.test(d))break}break}if(r.test(c))break}return t.value=s.substring(0,a)+s.substring(i),t.setSelectionRange(a,a),this.resizeSend(),!0},isScrolledToBottom:function(){var e=this.$id("messages")[0];return Math.abs(e.scrollHeight-e.scrollTop-e.clientHeight)<5},resizeSend:function(){var e=this.$id("messages"),t=this.$id("send"),s=t[0].offsetHeight,a=parseInt(t.css("minHeight"),10);t.outerHeight(a);var i=!1,n=Math.max(a,t[0].scrollHeight);n>215&&(i=!0,n=215);var r=n-s;e.css("height",563-n),t.outerHeight(n).toggleClass("fap-chat-send-scroll",i),r<0&&this.isScrolledToBottom()||(e[0].scrollTop+=n-s)},onScroll:function(e){this.chatScrollTop=e.target.scrollTop,this.isScrolledToBottom()&&this.$id("new").addClass("hidden")},onResize:function(){this.resizeSend()}})});