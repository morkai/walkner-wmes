define(["underscore","jquery","getCaretCoordinates","app/user","app/core/View","app/core/util/transliterate","app/planning/util/contextMenu","app/wmes-fap-entries/templates/chat","app/wmes-fap-entries/templates/chatMessage"],function(e,t,i,s,n,a,r,l,o){"use strict";return n.extend({template:l,events:{"keydown #-send":function(e){var t=e.originalEvent.key;if("Tab"===t)return this.showUserAutocomplete(),!1;if(this.removeAutocompleteUser(t))return!1;var i="Enter"===t,s=i||" "===t,n=""===e.target.value.trim();return s&&n?(this.toggleMultiLine(),!1):this.multiLine||!i||!e.shiftKey||n?this.multiLine&&i&&e.shiftKey?(this.send(),!1):this.multiLine||!i||e.shiftKey?void 0:(this.send(),!1):void this.toggleMultiLine(!0)},"input #-send":function(){this.resizeSend()},"click #-new":function(){var e=this.$id("messages");this.$id("new").addClass("hidden"),e.animate({scrollTop:e[0].scrollHeight},"fast")},"click .fap-chat-attachment":function(e){this.model.trigger("focusAttachment",e.currentTarget.dataset.attachmentId)},"click #-submit":function(){this.send()}},initialize:function(){this.chatScrollTop=-1,this.multiLine=!1,this.listenTo(this.model,"change:changes",this.onChange)},getTemplateData:function(){return{model:this.model.serializeDetails(),renderMessage:o}},afterRender:function(){var e=this.$id("messages");e.length&&(e[0].scrollTop=-1===this.chatScrollTop?9999999:this.chatScrollTop,e.on("scroll",this.onScroll.bind(this))),this.toggleMultiLine(this.multiLine)},toggleMultiLine:function(e){this.multiLine="boolean"==typeof e?e:!this.multiLine,this.$el.toggleClass("fap-chat-multiLine",this.multiLine),this.multiLine&&(this.$id("submit")[0].style.marginLeft=this.$id("submit").outerWidth()/2*-1+"px")},send:function(){var e=this.$id("send"),t=e.val().trim(),i={};e.val(""),this.toggleMultiLine(!1),this.resizeSend(),s.isLoggedIn()&&!this.model.isObserver()&&(i.subscribers=[null,[{id:s.data._id,label:s.getLabel()}]]),this.model.handleChange({date:new Date,user:s.getInfo(),data:i,comment:t}),this.model.update({comment:t})},onChange:function(){if(this.isRendered()){var t=e.last(this.model.get("changes"));t&&t.user&&this.handleChange(t)}},handleChange:function(e){e.data.attachments&&!e.data.attachments[1]&&this.removeAttachments(e.data.attachments[0]);var i=this.model.serializeChatMessage(e);if(i.lines.length){var n=this.$id("messages"),a=this.$(n[0].lastElementChild),r=this.isScrolledToBottom();if(a[0].dataset.userId===e.user.id){var l=a.find(".fap-chat-lines");i.lines.forEach(function(e){t('<div class="fap-chat-line"></div>').attr("title",e.time).html(e.text).appendTo(l)})}else this.renderPartial(o,{message:i}).appendTo(n);r?n[0].scrollTop=n[0].scrollHeight:s.data._id!==e.user.id&&this.$id("new").removeClass("hidden")}},removeAttachments:function(e){var t=this;e.forEach(function(e){t.$('.fap-chat-attachment[data-attachment-id="'+e._id+'"]').css("text-decoration","line-through")})},showUserAutocomplete:function(){for(var e=this,t=e.$id("send")[0],n=t.selectionEnd,l=n-1,o=/^[^a-zA-Z0-9]$/,h="Â ",c="";;){if((c=a(t.value.charAt(l)))===h)return;if(0===c.length){l=0;break}if("\udc64"!==c&&o.test(c))break;--l}for(;;){if((c=a(t.value.charAt(n)))===h)return;if(0===c.length){n=t.value.length;break}if(o.test(c))break;++n}var d=t.value.substring(0,l),u=t.value.substring(n),g=a(t.value.substring(l,n)).toUpperCase().replace(/[^A-Z0-9]+/g,"");d.length&&!/[<\[{(\s]$/.test(d.charAt(d.length-1))&&(d+=" "),u.length&&!/^[!?,.>\]})\s]/.test(a(u.charAt(0)))&&(u=" "+u);for(var f=[],m=0===g.length,p={},v=999,b=e.model.get("changes"),$=b.length-1;$>=0;--$){var T=b[$];T.comment&&(p[T.user.id]=v--)}if(e.model.get("observers").forEach(function(i){if(i.user.id!==s.data._id){var n=a(i.user.label).toUpperCase().replace(/[^A-Z0-9]+/g,""),r=m?-1:n.indexOf(g);(m||-1!==r)&&f.push({label:i.user.label,handler:function(i){var s=d+"ðŸ‘¤"+i.replace(/\s+/g,h);0===u.length&&(s+=" ");t.value=s+u,t.setSelectionRange(s.length,s.length),e.resizeSend()}.bind(null,i.user.label),score:(p[i.user.id]||0)+(m?0:0===r?100:0)})}}),0!==f.length)if(1!==f.length){f.sort(function(e,t){return e.score===t.score?e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}):t.score-e.score}),f.length>10&&(f=f.slice(0,10)).push({disabled:!0,label:"..."});var L=e.$(".fap-chat-form").position(),S=i(t,t.selectionEnd),A=L.top+S.top+S.height,k=L.left+S.left;r.show(e,A,k,{menu:f}),e.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){e.$id("send").focus()})}else f[0].handler()},removeAutocompleteUser:function(e){if("Backspace"!==e&&"Delete"!==e)return!1;var t=this.$id("send")[0],i=t.value,s=t.selectionStart,n=t.selectionEnd;s===n&&("Backspace"===e&&s>0?s-=1:"Delete"===e&&(n+=1));for(var r=/^[^a-zA-Z0-9\u00a0]$/,l=s;l>=0;--l){var o=a(i.charAt(l));if("\udc64"===o){s=l-1;break}if(r.test(o))break}for(var h=n;h>=0;--h){var c=a(i.charAt(h));if("\udc64"===c){for(;n<i.length;++n){var d=a(i.charAt(n));if("\udc64"!==d&&r.test(d))break}break}if(r.test(c))break}return t.value=i.substring(0,s)+i.substring(n),t.setSelectionRange(s,s),this.resizeSend(),!0},isScrolledToBottom:function(){var e=this.$id("messages")[0];return Math.abs(e.scrollHeight-e.scrollTop-e.clientHeight)<5},resizeSend:function(){var e=this.$id("messages"),t=this.$id("send"),i=t[0].offsetHeight,s=parseInt(t.css("minHeight"),10);t.outerHeight(s);var n=!1,a=Math.max(s,t[0].scrollHeight);a>215&&(n=!0,a=215);var r=a-i;e.css("height",563-a),t.outerHeight(a).toggleClass("fap-chat-send-scroll",n),r<0&&this.isScrolledToBottom()||(e[0].scrollTop+=a-i)},onScroll:function(e){this.chatScrollTop=e.target.scrollTop,this.isScrolledToBottom()&&this.$id("new").addClass("hidden")},onResize:function(){this.resizeSend()}})});