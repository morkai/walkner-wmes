define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","../dictionaries","app/wmes-fap-entries/templates/historyItem","app/wmes-fap-entries/templates/history"],function(e,t,r,s,i,n,a,o,u,l,c){"use strict";var h={subdivisions:!0,unsubscribed:!0};return a.extend({template:c,getTemplateData:function(){return{items:this.serializeItems()}},serializeItems:function(){return this.model.get("changes").map(this.serializeItem,this).filter(function(e){return!!e.comment||!!e.changes.length})},serializeItem:function(t,r){var i,n,a=this;return t.data&&t.data.observer?(n=[],i=a.t("history:observer:"+t.data.observer[0])):(n=e.map(t.data,function(e,t){return h[t]?null:("subscribers"===(t=t.split("$")[0])&&(t="observers"),{label:a.t("PROPERTY:"+t),oldValue:a.serializeItemValue(t,e[0],!0,r),newValue:a.serializeItemValue(t,e[1],!1,r)})}).filter(function(e){return!!e}),i=t.comment.trim()),{time:s.toTagData(t.date),user:o({userInfo:t.user}),changes:n,comment:i}},serializeItemValue:function(t,r){if(null==r||""===r||Array.isArray(r)&&0===r.length)return"-";if(0===r)return 0;if(/At$/i.test(t))return s.format(r,"LLLL");if("boolean"==typeof r)return this.t("core","BOOL:"+r);switch("string"==typeof r&&(r=e.escape(r)),t){case"observers":case"analyzers":return(r=r.map(function(e){return(e.label||"").replace(/\s*\(.*?\)/,"")}).join(", ")).length<=43?r:{more:r,toString:function(){return r.substr(0,40)+"..."}};case"status":case"assessment":return this.t(t+":"+r);case"productName":case"componentName":case"problem":case"solution":return r.length<=43?r:{more:r,toString:function(){return r.substr(0,40)+"..."}};case"category":var i=u.categories.get(r);return i?i.getLabel():r;case"subCategory":var n=u.subCategories.get(r);return n?n.getLabel():r;case"why5":return(r=r.filter(function(e){return!!e})).length?"<ol><li>"+r.join("<li>")+"</ol>":"-";case"attachments":return"<ul><li>"+r.map(function(e){return e.name}).join("<li>")+"</ul>";default:return r||""}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.lastChangeCount=this.model.get("changes").length,this.listenTo(this.model,"change:changes",this.updateHistory),this.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",template:this.$el.popover.Constructor.DEFAULTS.template.replace('class="popover"','class="popover fap-entries-history-popover"'),title:function(){return t(this).closest("tr").children().first().text()}}),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4))},updateHistory:function(){for(var e=this.model.get("changes"),r="",s=this.lastChangeCount;s<e.length;++s)r+=l({item:this.serializeItem(e[s],s)});t(r).insertAfter(this.$(".fap-entries-history-item").last()).addClass("highlight"),this.lastChangeCount=e.length},updateTimes:function(){this.$(".fap-entries-history-time").each(function(){var e=s.toTagData(this.getAttribute("datetime"));this.textContent=e.daysAgo>5?e.long:e.human})}})});