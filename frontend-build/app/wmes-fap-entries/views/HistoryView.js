define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/wmes-fap-entries/templates/historyItem","app/wmes-fap-entries/templates/history"],function(e,t,s,i,r,a,n,o,l,u){"use strict";return n.extend({template:u,getTemplateData:function(){return{editUrl:this.model.genClientUrl("edit"),items:this.serializeItems()}},serializeItems:function(){return this.model.get("changes").map(this.serializeItem,this)},serializeItem:function(t,s){var r,a,n=this;return t.data&&t.data.observer?(a=[],r=n.t("history:observer:"+t.data.observer[0])):(a=e.map(t.data,function(e,t){return{label:n.t("PROPERTY:"+t),oldValue:n.serializeItemValue(t,e[0],!0,s),newValue:n.serializeItemValue(t,e[1],!1,s)}}),r=t.comment.trim()),{time:i.toTagData(t.date),user:o({userInfo:t.user}),changes:a,comment:r}},serializeItemValue:function(e,t){if(null==t||""===t)return"-";if(/At$/i.test(e))return i.format(t,"LLLL");switch(e){case"analyzers":return t.map(function(e){return(e.label||"").replace(/\s*\(.*?\)/,"")}).join(", ");case"status":case"assessment":return this.t(e+":"+t);case"moreAnalysis":case"analysisDone":return this.t("core","BOOL:"+t);case"problem":case"solution":return t.length<=43?t:{more:t,toString:function(){return t.substr(0,40)+"..."}};case"category":return t;case"why5":return JSON.stringify(t,null,2);default:return t||""}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.updateHistory)},afterRender:function(){this.lastChangeCount=this.model.get("changes").length,this.listenTo(this.model,"change:changes",this.updateHistory),this.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",template:this.$el.popover.Constructor.DEFAULTS.template.replace('class="popover"','class="popover fap-entries-history-popover"'),title:function(){return t(this).closest("tr").children().first().text()}}),this.timers.updateTimes||(this.timers.updateTimes=setInterval(this.updateTimes.bind(this),3e4))},updateHistory:function(){for(var e=this.model.get("changes"),s="",i=this.lastChangeCount;i<e.length;++i)s+=l({item:this.serializeItem(e[i],i)});t(s).insertAfter(this.$(".fap-entries-history-item").last()).addClass("highlight"),this.lastChangeCount=e.length},updateTimes:function(){this.$(".fap-entries-history-time").each(function(){var e=i.toTagData(this.getAttribute("datetime"));this.textContent=e.daysAgo>5?e.long:e.human})}})});