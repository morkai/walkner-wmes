define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(e,t,s,r,a){"use strict";var o={entry:"#666",analysis:"#ea0",pending:"#e00",started:"#0af",finished:"#00af00"},i=["count","duration","status","level","category","subCategory","subdivisionType","division","mrp","assessment","owner","solver"],n={owner:!0,solver:!0},l={category:"categories",subCategory:"subCategories"};return r.extend({urlRoot:"/fap/reports/count",nlsDomain:"wmes-fap-entries",defaults:function(){return{from:0,to:0,interval:"month",categories:[],subCategories:[],subdivisionTypes:[],divisions:[],mrps:[],levels:-1}},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.assign(t.data||{},e.pick(this.attributes,["from","to","interval","categories","subCategories","subdivisionTypes","divisions","mrps","levels"])),Object.keys(t.data).forEach(function(e){Array.isArray(t.data[e])&&(t.data[e]=t.data[e].join(","))}),r.prototype.fetch.call(this,t)},genClientUrl:function(){return"/fap/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&categories="+this.get("categories")+"&subCategories="+this.get("subCategories")+"&subdivisionTypes="+this.get("subdivisionTypes")+"&divisions="+this.get("divisions")+"&mrps="+this.get("mrps")+"&levels="+this.get("levels")},parse:function(s){var r=this,a=s.totals,l={count:{rows:[{id:"entry",abs:a.count,rel:1,color:o.entry},{id:"analysis",abs:a.analysisCount,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry},analysis:{data:[],color:o.analysis}}},duration:{rows:[{id:"entry",abs:a.duration,rel:1,color:o.entry},{id:"analysis",abs:a.analysisDuration,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry,tooltip:{valueSuffix:"h"}},analysis:{data:[],color:o.analysis,tooltip:{valueSuffix:"h"}}}}};return i.forEach(function(e){l[e]||(l[e]=n[e]?{categories:a[e].map(function(e){return s.users[e[0]]||e[0]}),series:[{id:"entry",name:t("wmes-fap-entries","report:series:entry"),color:o.entry,data:a[e].map(function(e){return e[1]})}]}:{rows:r.prepareRows(e,s),series:{}})}),e.forEach(s.groups,function(e){var t;"number"==typeof e?e={key:t=e,type:{}}:t=e.key;var s=l.count.series;s.entry.data.push({x:t,y:e.count||null}),s.analysis.data.push({x:t,y:e.analysisCount||null});var a=l.duration.series;a.entry.data.push({x:t,y:e.duration||null}),a.analysis.data.push({x:t,y:e.analysisDuration||null}),i.forEach(function(t){r.createSeriesFromRows(t,l,e)})}),l},prepareRows:function(e,s){var r=s.totals.count,i=[].concat(s.totals[e]),n="object"==typeof l[e]?l[e]:s[l[e]],u={id:"total",abs:0,rel:1,color:"#DDD",label:t("wmes-fap-entries","report:series:total")},c=i.map(function(s){var i=s[0],l=s[1];return u.abs+=l,{id:i,abs:l,rel:l/r,color:o[i]||a.getColor("wmes-fap/count/"+e,i),label:n?n[i]:t.has("wmes-fap-entries",e+":"+i)?t("wmes-fap-entries",e+":"+i):i}});return c.push(u),c},createSeriesFromRows:function(t,s,r){var a=s[t].series;e.forEach(s[t].rows,function(e){a[e.id]||(a[e.id]={name:e.label,data:[],color:e.color}),a[e.id].data.push({x:r.key,y:r[t]&&r[t][e.id]||null})})}},{TABLE_AND_CHART_METRICS:i,USERS_METRICS:n,fromQuery:function(t){void 0===t.from&&void 0===t.to&&(t.from=s.getMoment().startOf("week").subtract(10,"weeks").valueOf()),t.interval||(t.interval="week");var r={from:+t.from||void 0,to:+t.to||void 0,interval:t.interval||void 0,levels:null==t.levels?void 0:+t.levels};return["categories","subCategories","subdivisionTypes","divisions","mrps"].forEach(function(s){r[s]=e.isEmpty(t[s])?[]:t[s].split(",")}),new this(r)}})});