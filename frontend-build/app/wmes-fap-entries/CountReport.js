define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(s,e,t,i,r){"use strict";var o={entry:"#666",analysis:"#ea0",pending:"#e00",started:"#0af",finished:"#00af00"},a=["count","duration","status","level","category","subCategory","subdivisionType","division","mrp","assessment","owner","solver"],n={owner:!0,solver:!0},l={category:"categories",subCategory:"subCategories"};return i.extend({urlRoot:"/fap/reports/count",nlsDomain:"wmes-fap-entries",defaults:function(){return{from:0,to:0,interval:"month",categories:[],subdivisionTypes:[],divisions:[],mrps:[],levels:0}},fetch:function(e){return s.isObject(e)||(e={}),e.data=s.assign(e.data||{},s.pick(this.attributes,["from","to","interval","categories","subdivisionTypes","divisions","mrps","levels"])),e.data.categories=e.data.categories.join(","),e.data.subdivisionTypes=e.data.subdivisionTypes.join(","),e.data.divisions=e.data.divisions.join(","),e.data.mrps=e.data.mrps.join(","),i.prototype.fetch.call(this,e)},genClientUrl:function(){return"/fap/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&categories="+this.get("categories")+"&subdivisionTypes="+this.get("subdivisionTypes")+"&divisions="+this.get("divisions")+"&mrps="+this.get("mrps")+"&levels="+this.get("levels")},parse:function(t){var i=this,r=t.totals,l={count:{rows:[{id:"entry",abs:r.count,rel:1,color:o.entry},{id:"analysis",abs:r.analysisCount,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry},analysis:{data:[],color:o.analysis}}},duration:{rows:[{id:"entry",abs:r.duration,rel:1,color:o.entry},{id:"analysis",abs:r.analysisDuration,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry,tooltip:{valueSuffix:"h"}},analysis:{data:[],color:o.analysis,tooltip:{valueSuffix:"h"}}}}};return a.forEach(function(s){l[s]||(l[s]=n[s]?{categories:r[s].map(function(s){return t.users[s[0]]||s[0]}),series:[{id:"entry",name:e("wmes-fap-entries","report:series:entry"),color:o.entry,data:r[s].map(function(s){return s[1]})}]}:{rows:i.prepareRows(s,t),series:{}})}),s.forEach(t.groups,function(s){var e;"number"==typeof s?s={key:e=s,type:{}}:e=s.key;var t=l.count.series;t.entry.data.push({x:e,y:s.count||null}),t.analysis.data.push({x:e,y:s.analysisCount||null});var r=l.duration.series;r.entry.data.push({x:e,y:s.duration||null}),r.analysis.data.push({x:e,y:s.analysisDuration||null}),a.forEach(function(e){i.createSeriesFromRows(e,l,s)})}),l},prepareRows:function(s,t){var i=t.totals.count,a=[].concat(t.totals[s]),n="object"==typeof l[s]?l[s]:t[l[s]],u={id:"total",abs:0,rel:1,color:"#DDD",label:e("wmes-fap-entries","report:series:total")},d=a.map(function(t){var a=t[0],l=t[1];return u.abs+=l,{id:a,abs:l,rel:l/i,color:o[a]||r.getColor("wmes-fap/count/"+s,a),label:n?n[a]:e.has("wmes-fap-entries",s+":"+a)?e("wmes-fap-entries",s+":"+a):a}});return d.push(u),d},createSeriesFromRows:function(e,t,i){var r=t[e].series;s.forEach(t[e].rows,function(s){r[s.id]||(r[s.id]={name:s.label,data:[],color:s.color}),r[s.id].data.push({x:i.key,y:i[e]&&i[e][s.id]||null})})}},{TABLE_AND_CHART_METRICS:a,USERS_METRICS:n,fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=t.getMoment().startOf("week").subtract(10,"weeks").valueOf()),e.interval||(e.interval="week"),new this({from:+e.from||void 0,to:+e.to||void 0,interval:e.interval||void 0,categories:s.isEmpty(e.categories)?[]:e.categories.split(","),subdivisionTypes:s.isEmpty(e.subdivisionTypes)?[]:e.subdivisionTypes.split(","),divisions:s.isEmpty(e.divisions)?[]:e.divisions.split(","),mrps:s.isEmpty(e.mrps)?[]:e.mrps.split(","),levels:+e.levels||void 0})}})});