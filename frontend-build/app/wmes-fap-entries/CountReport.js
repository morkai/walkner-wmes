define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(t,e,r,s,a){"use strict";var o={entry:"#666",analysis:"#ea0",pending:"#e00",started:"#0af",finished:"#00af00"},i=["count","duration","status","category","division","mrp","assessment","owner","solver"],n={owner:!0,solver:!0},l={category:"categories"};return s.extend({urlRoot:"/fap/reports/count",nlsDomain:"wmes-fap-entries",defaults:function(){return{from:0,to:0,interval:"month",categories:[],divisions:[],mrps:[]}},fetch:function(e){return t.isObject(e)||(e={}),e.data=t.extend(e.data||{},t.pick(this.attributes,["from","to","interval","categories","divisions","mrps"])),e.data.categories=e.data.categories.join(","),e.data.divisions=e.data.divisions.join(","),e.data.mrps=e.data.mrps.join(","),s.prototype.fetch.call(this,e)},genClientUrl:function(){return"/fap/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&categories="+this.get("categories")+"&divisions="+this.get("divisions")+"&mrps="+this.get("mrps")},parse:function(r){var s=this,a=r.totals,l={count:{rows:[{id:"entry",abs:a.count,rel:1,color:o.entry},{id:"analysis",abs:a.analysisCount,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry},analysis:{data:[],color:o.analysis}}},duration:{rows:[{id:"entry",abs:a.duration,rel:1,color:o.entry},{id:"analysis",abs:a.analysisDuration,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry,tooltip:{valueSuffix:"h"}},analysis:{data:[],color:o.analysis,tooltip:{valueSuffix:"h"}}}}};return i.forEach(function(t){l[t]||(l[t]=n[t]?{categories:a[t].map(function(t){return r.users[t[0]]||t[0]}),series:[{id:"entry",name:e("wmes-fap-entries","report:series:entry"),color:o.entry,data:a[t].map(function(t){return t[1]})}]}:{rows:s.prepareRows(t,r),series:{}})}),t.forEach(r.groups,function(t){var e;"number"==typeof t?t={key:e=t,type:{}}:e=t.key;var r=l.count.series;r.entry.data.push({x:e,y:t.count||null}),r.analysis.data.push({x:e,y:t.analysisCount||null});var a=l.duration.series;a.entry.data.push({x:e,y:t.duration||null}),a.analysis.data.push({x:e,y:t.analysisDuration||null}),i.forEach(function(e){s.createSeriesFromRows(e,l,t)})}),l},prepareRows:function(t,r){var s=r.totals.count,i=[].concat(r.totals[t]),n="object"==typeof l[t]?l[t]:r[l[t]],c={id:"total",abs:0,rel:1,color:"#DDD",label:e("wmes-fap-entries","report:series:total")},u=i.map(function(r){var i=r[0],l=r[1];return c.abs+=l,{id:i,abs:l,rel:l/s,color:o[i]||a.getColor("wmes-fap/count/"+t,i),label:n?n[i]:e.has("wmes-fap-entries",t+":"+i)?e("wmes-fap-entries",t+":"+i):i}});return u.push(c),u},createSeriesFromRows:function(e,r,s){var a=r[e].series;t.forEach(r[e].rows,function(t){a[t.id]||(a[t.id]={name:t.label,data:[],color:t.color}),a[t.id].data.push({x:s.key,y:s[e]&&s[e][t.id]||null})})}},{TABLE_AND_CHART_METRICS:i,USERS_METRICS:n,fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=r.getMoment().startOf("week").subtract(10,"weeks").valueOf()),e.interval||(e.interval="week"),new this({from:+e.from||void 0,to:+e.to||void 0,interval:e.interval||void 0,categories:t.isEmpty(e.categories)?[]:e.categories.split(","),divisions:t.isEmpty(e.divisions)?[]:e.divisions.split(","),mrps:t.isEmpty(e.mrps)?[]:e.mrps.split(",")})}})});