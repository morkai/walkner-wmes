define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(e,t,s,r,i){"use strict";var a={entry:"#666",analysis:"#ea0",pending:"#e00",started:"#0af",finished:"#00af00"},o=["count","duration","shift","hour","status","level","category","subCategory","subdivisionType","division","mrp","assessment","owner","solver"],n={owner:!0,solver:!0},l={category:"categories",subCategory:"subCategories",shift:{1:"I",2:"II",3:"III"}};return r.extend({urlRoot:"/fap/reports/count",nlsDomain:"wmes-fap-entries",defaults:function(){return{from:0,to:0,interval:"month",categories:[],subCategories:[],subdivisionTypes:[],divisions:[],mrps:[],levels:-1}},getInterval:function(){return this.get("interval")},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.assign(t.data||{},e.pick(this.attributes,["from","to","interval","categories","subCategories","subdivisionTypes","divisions","mrps","levels"])),Object.keys(t.data).forEach(function(e){Array.isArray(t.data[e])&&(t.data[e]=t.data[e].join(","))}),r.prototype.fetch.call(this,t)},genClientUrl:function(){return"/fap/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&categories="+this.get("categories")+"&subCategories="+this.get("subCategories")+"&subdivisionTypes="+this.get("subdivisionTypes")+"&divisions="+this.get("divisions")+"&mrps="+this.get("mrps")+"&levels="+this.get("levels")},parse:function(s){var r=this,i=s.totals,l={count:{rows:[{id:"entry",abs:i.count,rel:1,color:a.entry},{id:"analysis",abs:i.analysisCount,rel:1,color:a.analysis}],series:{entry:{data:[],color:a.entry},analysis:{data:[],color:a.analysis}}},duration:{rows:[{id:"entry",abs:i.duration,rel:1,color:a.entry},{id:"analysis",abs:i.analysisDuration,rel:1,color:a.analysis}],series:{entry:{data:[],color:a.entry,tooltip:{valueSuffix:"h"}},analysis:{data:[],color:a.analysis,tooltip:{valueSuffix:"h"}}}}};return o.forEach(function(e){l[e]||(n[e]?i[e]?l[e]={categories:i[e].map(function(e){return s.users[e[0]]||e[0]}),series:[{id:"entry",name:t("wmes-fap-entries","report:series:entry"),color:a.entry,data:i[e].map(function(e){return e[1]})}]}:l[e]={categories:[],series:[]}:l[e]={rows:r.prepareRows(e,s),series:{}})}),e.forEach(s.groups,function(e){var t;"number"==typeof e?e={key:t=e,type:{}}:t=e.key;var s=l.count.series;s.entry.data.push({x:t,y:e.count||null}),s.analysis.data.push({x:t,y:e.analysisCount||null});var i=l.duration.series;i.entry.data.push({x:t,y:e.duration||null}),i.analysis.data.push({x:t,y:e.analysisDuration||null}),o.forEach(function(t){r.createSeriesFromRows(t,l,e)})}),l},prepareRows:function(e,s){var r=s.totals.count,o=[].concat(s.totals[e]),n="object"==typeof l[e]?l[e]:s[l[e]],u={id:"total",abs:0,rel:1,color:"#DDD",label:t("wmes-fap-entries","report:series:total")},c=o.map(function(s){var o=s[0],l=s[1];return u.abs+=l,{id:o,abs:l,rel:l/r,color:a[o]||i.getColor("wmes-fap/count/"+e,o),label:n?n[o]:t.has("wmes-fap-entries",e+":"+o)?t("wmes-fap-entries",e+":"+o):o}});return c.push(u),c},createSeriesFromRows:function(t,s,r){s[t]||(s[t]={rows:[],series:{}});const{rows:i,series:a}=s[t];Array.isArray(i)&&e.forEach(i,function(e){"total"!==e.id&&(a[e.id]||(a[e.id]={name:e.label,data:[],color:e.color}),a[e.id].data.push({x:r.key,y:r[t]&&r[t][e.id]||null}))})}},{TABLE_AND_CHART_METRICS:o,USERS_METRICS:n,fromQuery:function(t){void 0===t.from&&void 0===t.to&&(t.from=s.getMoment().startOf("week").subtract(10,"weeks").valueOf()),t.interval||(t.interval="week");var r={from:+t.from||void 0,to:+t.to||void 0,interval:t.interval||void 0,levels:null==t.levels?void 0:+t.levels};return["categories","subCategories","subdivisionTypes","divisions","mrps"].forEach(function(s){r[s]=e.isEmpty(t[s])?[]:t[s].split(",")}),new this(r)}})});