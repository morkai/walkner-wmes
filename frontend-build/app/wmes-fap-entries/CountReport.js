define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(s,t,i,e,r){"use strict";var o={entry:"#666",analysis:"#ea0",pending:"#e00",started:"#0af",finished:"#00af00"},a=["count","duration","status","category","subdivisionType","division","mrp","assessment","owner","solver"],n={owner:!0,solver:!0},l={category:"categories"};return e.extend({urlRoot:"/fap/reports/count",nlsDomain:"wmes-fap-entries",defaults:function(){return{from:0,to:0,interval:"month",categories:[],subdivisionTypes:[],divisions:[],mrps:[]}},fetch:function(t){return s.isObject(t)||(t={}),t.data=s.assign(t.data||{},s.pick(this.attributes,["from","to","interval","categories","subdivisionTypes","divisions","mrps"])),t.data.categories=t.data.categories.join(","),t.data.subdivisionTypes=t.data.subdivisionTypes.join(","),t.data.divisions=t.data.divisions.join(","),t.data.mrps=t.data.mrps.join(","),e.prototype.fetch.call(this,t)},genClientUrl:function(){return"/fap/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&categories="+this.get("categories")+"&subdivisionTypes="+this.get("subdivisionTypes")+"&divisions="+this.get("divisions")+"&mrps="+this.get("mrps")},parse:function(i){var e=this,r=i.totals,l={count:{rows:[{id:"entry",abs:r.count,rel:1,color:o.entry},{id:"analysis",abs:r.analysisCount,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry},analysis:{data:[],color:o.analysis}}},duration:{rows:[{id:"entry",abs:r.duration,rel:1,color:o.entry},{id:"analysis",abs:r.analysisDuration,rel:1,color:o.analysis}],series:{entry:{data:[],color:o.entry,tooltip:{valueSuffix:"h"}},analysis:{data:[],color:o.analysis,tooltip:{valueSuffix:"h"}}}}};return a.forEach(function(s){l[s]||(l[s]=n[s]?{categories:r[s].map(function(s){return i.users[s[0]]||s[0]}),series:[{id:"entry",name:t("wmes-fap-entries","report:series:entry"),color:o.entry,data:r[s].map(function(s){return s[1]})}]}:{rows:e.prepareRows(s,i),series:{}})}),s.forEach(i.groups,function(s){var t;"number"==typeof s?s={key:t=s,type:{}}:t=s.key;var i=l.count.series;i.entry.data.push({x:t,y:s.count||null}),i.analysis.data.push({x:t,y:s.analysisCount||null});var r=l.duration.series;r.entry.data.push({x:t,y:s.duration||null}),r.analysis.data.push({x:t,y:s.analysisDuration||null}),a.forEach(function(t){e.createSeriesFromRows(t,l,s)})}),l},prepareRows:function(s,i){var e=i.totals.count,a=[].concat(i.totals[s]),n="object"==typeof l[s]?l[s]:i[l[s]],u={id:"total",abs:0,rel:1,color:"#DDD",label:t("wmes-fap-entries","report:series:total")},d=a.map(function(i){var a=i[0],l=i[1];return u.abs+=l,{id:a,abs:l,rel:l/e,color:o[a]||r.getColor("wmes-fap/count/"+s,a),label:n?n[a]:t.has("wmes-fap-entries",s+":"+a)?t("wmes-fap-entries",s+":"+a):a}});return d.push(u),d},createSeriesFromRows:function(t,i,e){var r=i[t].series;s.forEach(i[t].rows,function(s){r[s.id]||(r[s.id]={name:s.label,data:[],color:s.color}),r[s.id].data.push({x:e.key,y:e[t]&&e[t][s.id]||null})})}},{TABLE_AND_CHART_METRICS:a,USERS_METRICS:n,fromQuery:function(t){return void 0===t.from&&void 0===t.to&&(t.from=i.getMoment().startOf("week").subtract(10,"weeks").valueOf()),t.interval||(t.interval="week"),new this({from:+t.from||void 0,to:+t.to||void 0,interval:t.interval||void 0,categories:s.isEmpty(t.categories)?[]:t.categories.split(","),subdivisionTypes:s.isEmpty(t.subdivisionTypes)?[]:t.subdivisionTypes.split(","),divisions:s.isEmpty(t.divisions)?[]:t.divisions.split(","),mrps:s.isEmpty(t.mrps)?[]:t.mrps.split(",")})}})});