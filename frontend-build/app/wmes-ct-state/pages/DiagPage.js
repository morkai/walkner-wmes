define(["underscore","jquery","app/time","app/core/View","app/core/util/bindLoadingMessage","../views/LineStateView","app/wmes-ct-state/templates/diagPage","app/wmes-ct-state/templates/diagRow"],function(t,o,i,r,s,e,n,a){"use strict";return r.extend({nlsDomain:"wmes-ct-state",template:n,breadcrumbs:function(){return[{href:"#ct",label:this.t("BREADCRUMBS:base")},this.t("BREADCRUMBS:diag")]},actions:function(){var t=this;return[{label:t.t("diag:clear"),icon:"eraser",callback:function(){t.todos=[],t.$("tbody").html("")}}]},remoteTopics:{"ct.todos.saved":function(t){this.addTodo(t)},"ct.todos.ignored":function(t){this.addTodo(t)}},initialize:function(){this.scrollY=0,this.scrollLock=!0,this.todos=[],o(window).on("scroll."+this.idPrefix,this.onWindowScroll.bind(this))},destroy:function(){o(window).off("."+this.idPrefix)},afterRender:function(){var t=this;if(t.todos.length){var o=t.scrollLock,i=t.scrollY;t.scrollLock=!1,t.todos.forEach(function(o){t.renderTodo(o,!1)}),t.scrollLock=o,window.scrollTo({top:i,left:0,behavior:"auto"})}else t.scrollY=window.scrollY},onWindowScroll:function(){window.scrollY<this.scrollY?this.scrollLock=!1:window.scrollY>this.scrollY&&!this.scrollLock&&(this.scrollLock=this.isScrolledToBottom()),this.scrollY=window.scrollY},addTodo:function(t){this.todos.push(t),this.renderTodo(t,!0)},renderTodo:function(t,o){this.$("tbody").append(this.renderPartialHtml(a,{row:{isNew:!!o,time:i.format(t.time,"YYYY-MM-DD, HH:mm:ss.SSS"),line:t.line,station:t.station?t.station.toString():"",action:this.t("todo:action:"+t.action),data:this.serializeData(t)}})),this.scrollLock&&this.scrollToBottom()},scrollToBottom:function(){window.scrollTo({top:document.body.scrollHeight,left:0,behavior:"smooth"})},isScrolledToBottom:function(){return document.body.scrollHeight-window.scrollY-window.innerHeight<5},serializeData:function(o){if(t.isEmpty(o.data))return"";var i=this.dataSerializers[o.action];return i?i(o):"<pre>"+JSON.stringify(o.data,null,2)+"</pre>"},dataSerializers:{cart:function(t){return t.data.cart||"?"},input:function(t){return!0===t.data.state?"1":!1===t.data.state?"0":"?"},sn:function(t){return'<a href="#prodShiftOrders/'+t.data.prodShiftOrder+'">'+t.data.serialNo+"</a>"}}})});