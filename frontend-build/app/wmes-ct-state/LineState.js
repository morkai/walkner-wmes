define(["underscore","../i18n","../time","../user","../core/Model"],function(t,r,o,i,a){"use strict";return a.extend({urlRoot:"/ct/state",clientUrlRoot:"#ct/state",topicPrefix:"ct.state",privilegePrefix:"PROD_DATA",nlsDomain:"wmes-ct-state",serialize:function(){var r=this,o=r.toJSON();return o.stations=t.map(o.stations,function(t){return r.serializeStation(t)}),o},serializeStation:function(t){var i={total:{short:this.formatShortDuration(t.durations.total),full:this.formatFullDuration(t.durations.total)},work:{short:this.formatShortDuration(t.durations.work),full:this.formatFullDuration(t.durations.work)},downtime:{short:this.formatShortDuration(t.durations.downtime),full:this.formatFullDuration(t.durations.downtime)},scheduled:{short:this.formatShortDuration(t.durations.scheduled),full:this.formatFullDuration(t.durations.scheduled)}},a={title:"",order:{short:t.order.sapTaktTime||"-",full:t.order.sapTaktTime?this.formatFullDuration(1e3*t.order.sapTaktTime):"-"},target:{short:"-",full:"-"},actual:{short:"-",full:"-"}};if(t.order.sapTaktTime&&t.order.workerCount){var e=Math.ceil(t.order.sapTaktTime/t.order.workerCount);a.target.short=e,a.target.full=this.formatFullDuration(1e3*e)}if(t.durations.work&&t.qtyDone){var n=Math.ceil(t.durations.work/1e3/t.qtyDone);a.actual.short=n,a.actual.full=this.formatFullDuration(1e3*n)}return a.title=[r(this.nlsDomain,"PROPERTY:taktTime:actual"),"  "+a.actual.full,r(this.nlsDomain,"PROPERTY:taktTime:target"),"  "+a.target.full,r(this.nlsDomain,"PROPERTY:taktTime:order"),"  "+a.order.full].join("\n"),{_id:t._id,lamp:t.lamp,order:{_id:t.order._id||"---------",nc12:t.order.nc12||"------------",name:t.order.name,qty:t.order.qty||0,workerCount:t.order.workerCount||0},qtyTodo:t.qtyTodo,qtyDone:t.qtyDone,times:{orderStartedAt:{short:this.formatShortTime(t.orderStartedAt),full:this.formatFullTime(t.orderStartedAt)},pceStartedAt:{short:this.formatShortTime(t.pceStartedAt),full:this.formatFullTime(t.pceStartedAt)},pceFinishedAt:{short:this.formatShortTime(t.pceFinishedAt),full:this.formatFullTime(t.pceFinishedAt)}},duration:{value:t.durations.total?o.toString(t.durations.total/1e3,!1,!1):"-",title:[r(this.nlsDomain,"PROPERTY:durations:total"),"  "+i.total.full,r(this.nlsDomain,"PROPERTY:durations:work"),"  "+i.work.full,r(this.nlsDomain,"PROPERTY:durations:downtime"),"  "+i.downtime.full,r(this.nlsDomain,"PROPERTY:durations:scheduled"),"  "+i.scheduled.full].join("\n")},durations:i,taktTime:a}},formatShortTime:function(t){return t?o.format(t,"HH:mm:ss"):"--:--:--"},formatFullTime:function(t){return t?o.format(t,"LL LTS"):"--:--:--"},formatShortDuration:function(t){return o.toString(t/1e3,!0,!1)},formatFullDuration:function(t){return o.toString(t/1e3,!1,!1)},update:function(r){var o=this;if(!(o.get("updatedAt")>=r.updatedAt)){var i={updatedAt:r.updatedAt,stations:{}};r.reset?i.stations=r.stations:t.forEach(o.get("stations"),function(o){i.stations[o._id]=t.assign({},o,r.stations[o._id])}),o.set(i),t.forEach(r.stations,function(t){o.trigger("change:station",o.attributes.stations[t._id])})}}})});