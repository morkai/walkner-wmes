define(["underscore","../i18n","../time","../user","../core/Model"],function(t,o,r,i,a){"use strict";return a.extend({urlRoot:"/ct/state",clientUrlRoot:"#ct/state",topicPrefix:"ct.state",privilegePrefix:"PROD_DATA",nlsDomain:"wmes-ct-state",serialize:function(){var o=this,r=o.toJSON();return r.stations=t.map(r.stations,function(t){return o.serializeStation(t)}),r},serializeStation:function(t){var i={total:{short:this.formatShortDuration(t.durations.total),full:this.formatFullDuration(t.durations.total)},work:{short:this.formatShortDuration(t.durations.work),full:this.formatFullDuration(t.durations.work)},downtime:{short:this.formatShortDuration(t.durations.downtime),full:this.formatFullDuration(t.durations.downtime)},scheduled:{short:this.formatShortDuration(t.durations.scheduled),full:this.formatFullDuration(t.durations.scheduled)}},a={title:"",order:{short:t.order.sapTaktTime||"-",full:t.order.sapTaktTime?this.formatFullDuration(1e3*t.order.sapTaktTime):"-"},actual:{short:"-",full:"-"}};if(t.durations.work&&t.qtyDone){var e=Math.ceil(t.durations.work/1e3/t.qtyDone);a.actual.short=e,a.actual.full=this.formatFullDuration(1e3*e)}return a.title=[o(this.nlsDomain,"PROPERTY:taktTime:actual"),"  "+a.actual.full,o(this.nlsDomain,"PROPERTY:taktTime:order"),"  "+a.order.full].join("\n"),{_id:t._id,lamp:t.lamp,order:{_id:t.order._id||"---------",nc12:t.order.nc12||"------------",name:t.order.name,qty:t.order.qty||0,workerCount:t.order.workerCount||0},qtyTodo:t.qtyTodo,qtyDone:t.qtyDone,times:{orderStartedAt:{short:this.formatShortTime(t.orderStartedAt),full:this.formatFullTime(t.orderStartedAt)},pceStartedAt:{short:this.formatShortTime(t.pceStartedAt),full:this.formatFullTime(t.pceStartedAt)},pceFinishedAt:{short:this.formatShortTime(t.pceFinishedAt),full:this.formatFullTime(t.pceFinishedAt)}},duration:{value:t.durations.total?r.toString(t.durations.total/1e3,!1,!1):"-",title:[o(this.nlsDomain,"PROPERTY:durations:total"),"  "+i.total.full,o(this.nlsDomain,"PROPERTY:durations:work"),"  "+i.work.full,o(this.nlsDomain,"PROPERTY:durations:downtime"),"  "+i.downtime.full,o(this.nlsDomain,"PROPERTY:durations:scheduled"),"  "+i.scheduled.full].join("\n")},durations:i,taktTime:a}},formatShortTime:function(t){return t?r.format(t,"HH:mm:ss"):"--:--:--"},formatFullTime:function(t){return t?r.format(t,"LL LTS"):"--:--:--"},formatShortDuration:function(t){return r.toString(t/1e3,!0,!1)},formatFullDuration:function(t){return r.toString(t/1e3,!1,!1)},update:function(o){var r=this;if(!(r.get("updatedAt")>=o.updatedAt)){var i={updatedAt:o.updatedAt,stations:{}};o.reset?i.stations=o.stations:t.forEach(r.get("stations"),function(r){i.stations[r._id]=t.assign({},r,o.stations[r._id])}),r.set(i),t.forEach(o.stations,function(t){r.trigger("change:station",r.attributes.stations[t._id])})}}})});