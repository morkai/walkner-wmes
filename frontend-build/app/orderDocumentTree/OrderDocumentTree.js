// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../user","../core/Model","./OrderDocumentFolder","./OrderDocumentFolderCollection","./OrderDocumentFileCollection","./OrderDocumentUploadCollection"],function(e,t,r,l,d,i,s,o){"use strict";var n="DOCS_DISPLAY_MODE",a={TILES:"tiles",LIST:"list"};return l.extend({defaults:function(){return{cutFolder:null,selectedFile:null,selectedFolder:null,expandedFolders:{},searchPhrase:"",displayMode:localStorage[n]||a.TILES}},initialize:function(e,t){this.folders=new i(null,{paginate:!1}),this.files=new s(null,{paginate:!1,parentFolderId:this.get("selectedFolder"),searchPhrase:this.get("searchPhrase")}),this.uploads=t.uploads||new o(null,{paginate:!1}),this.folders.once("sync",this.expandSelectedFolder.bind(this))},subscribe:function(e){e.subscribe("orderDocuments.tree.**",this.onMessage.bind(this))},getDisplayMode:function(){return this.get("displayMode")},setDisplayMode:function(e){this.set("displayMode",localStorage[n]=e)},hasSearchPhrase:function(){return this.get("searchPhrase").length>=4},getSearchPhrase:function(){return this.hasSearchPhrase()?this.get("searchPhrase"):""},setSearchPhrase:function(t,r){r=e.defaults({},r,{reset:!1}),t=t.trim().replace(/\*{2,}/g,"*").replace(/[^0-9#*]+/g,""),(t.length<4||-1===t.indexOf("*")&&15!==t.length)&&(t=""),t!==this.get("searchPhrase")&&(this.files.setSearchPhrase(t),r.reset!==!1&&this.files.reset([]),this.set("searchPhrase",t,r))},hasSelectedFolder:function(){return!!this.get("selectedFolder")},getSelectedFolder:function(){return this.folders.get(this.get("selectedFolder"))||null},setSelectedFolder:function(t,r){r=e.defaults({},r,{scroll:!1,keepFile:!1}),this.get("selectedFolder")!==t&&(this.setSearchPhrase("",{reset:!1,silent:!0}),this.files.setParentFolderId(t),this.files.reset([]),r.keepFile||this.set("selectedFile",null),this.set("selectedFolder",t,r))},hasSelectedFile:function(){return!!this.get("selectedFile")},getSelectedFile:function(){return this.files.get(this.get("selectedFile"))||null},setSelectedFile:function(e,t){this.get("selectedFile")!==e&&this.set("selectedFile",e,{scroll:t})},getRootFolders:function(){var e=this.folders.filter(function(e){return e.isRoot()&&"__TRASH__"!==e.id});return this.canSeeTrash()&&this.folders.get("__TRASH__")&&e.push(this.folders.get("__TRASH__")),e},getChildFolders:function(e){var t=this;return e?e.get("children").map(function(e){return t.folders.get(e)}).filter(function(e){return!!e}).sort(function(e,t){return e.getLabel().localeCompare(t.getLabel())}):this.getRootFolders()},isFolderCut:function(e){return this.attributes.cutFolder===e},isFolderSelected:function(e){return this.attributes.selectedFolder===e},isFolderExpanded:function(e){return this.attributes.expandedFolders[e]},toggleFolder:function(e,t){var r=this.attributes.expandedFolders;if(null===e)return this.folders.forEach(function(e){r[e.id]=t}),void this.trigger("change:expandedFolders",e,t);var l=!!r[e],d=void 0===t?!l:t;d!==l&&(r[e]=d,this.trigger("change:expandedFolders",e,d))},getRoot:function(e){return this.getPath(e)[0]},getPath:function(e){var t=[];if(e||(e=this.getSelectedFolder()),!e)return t;for(;e;)t.unshift(e),e=this.folders.get(e.get("parent"));return t},isInTrash:function(e){return"__TRASH__"===this.getRoot(e).id},canSeeTrash:function(){return r.isAllowedTo("DOCUMENTS:MANAGE")},canMoveFolder:function(e,t){if(t&&t.id===e.id)return!1;var r=this.folders.get(e.get("parent"))||null;if(t===r)return!1;for(var l=this.getPath(t),d=0;d<l.length;++d)if(l[d]===e)return!1;return!0},removeFolder:function(e){return this.setSelectedFolder(e.get("parent"),{scroll:!0}),this.act("removeFolder",{folderId:e.id})},moveFolder:function(e,t){var r=this,l=r.getSelectedFolder(),d=e.get("parent"),i=r.get("cutFolder");r.set("cutFolder",null),r.folders.handleFolderMoved(e.id,t?t.id:null),r.setSelectedFolder(e.id,{scroll:!0});var s=r.act("moveFolder",{folderId:e.id,parentId:t?t.id:null});return s.fail(function(){r.folders.handleFolderMoved(e.id,d),r.setSelectedFolder(l?l.id:null,{scroll:!0}),r.set("cutFolder",i)}),s},addFolder:function(e){var t=this,r=t.getSelectedFolder();t.folders.handleFolderAdded(e),t.setSelectedFolder(e.id,{scroll:!0});var l=t.act("addFolder",{folder:e.toJSON()});return l.fail(function(){t.folders.handleFolderPurged(e.id),t.setSelectedFolder(r?r.id:null,{scroll:!0})}),l},renameFolder:function(e,t){var r=this,l=e.get("name");r.folders.handleFolderRenamed(e.id,t);var d=r.act("renameFolder",{folderId:e.id,name:t});return d.fail(function(){r.folders.handleFolderRenamed(e.id,l)}),d},recoverFolder:function(e){var t=this;t.folders.handleFolderRecovered(e.id);var r=this.act("recoverFolder",{folderId:e.id});return r.fail(function(){t.folders.handleFolderRemoved(e.id)}),r},addFiles:function(){return this.act("addFiles",{files:this.uploads.serializeFiles()})},editFile:function(e,t){return this.act("editFile",{fileId:e.id,changes:t})},removeFile:function(e){return this.act("removeFile",{fileId:e.id})},recoverFile:function(e){return this.act("recoverFile",{fileId:e.id})},unlinkFile:function(e,t){return this.act("unlinkFile",{fileId:e.id,folderId:t.id})},act:function(e,r){return t.ajax({type:"POST",url:"/orderDocuments/tree",data:JSON.stringify({action:e,params:r})})},expandSelectedFolder:function(){var e=this.getSelectedFolder();if(e){var t=this.attributes.expandedFolders,r=e.get("parent");for(t[e.id]=!0;r;){t[r]=!0;var l=this.folders.get(r);if(!l)break;r=l.get("parent")}}},onMessage:function(e,t){var r=t.split(".");switch(r[2]){case"fileAdded":this.files.handleFileAdded(e.file),this.uploads.remove(e.uploadId);break;case"fileEdited":this.files.handleFileEdited(e.file,this.get("selectedFolder")),this.uploads.remove(e.uploadId);break;case"fileUnlinked":this.files.handleFileUnlinked(e.file._id,e.folderId);break;case"fileRemoved":this.files.handleFileRemoved(e.file._id);break;case"fileRecovered":this.files.handleFileRecovered(e.file._id);break;case"filePurged":this.files.handleFilePurged(e.file);break;case"folderAdded":this.folders.handleFolderAdded(new d(e.folder));break;case"folderRenamed":this.folders.handleFolderRenamed(e.folder._id,e.folder.name);break;case"folderMoved":this.folders.handleFolderMoved(e.folder._id,e.folder.parent);break;case"folderRemoved":this.folders.handleFolderRemoved(e.folder._id);break;case"folderRecovered":this.folders.handleFolderRecovered(e.folder._id);break;case"folderPurged":this.folders.handleFolderPurged(e.folder._id)}}},{DISPLAY_MODE:a})});