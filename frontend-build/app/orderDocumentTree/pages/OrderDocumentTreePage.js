// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/orderDocumentTree/OrderDocumentFolder","app/orderDocumentTree/views/PathView","app/orderDocumentTree/views/FoldersView","app/orderDocumentTree/views/FilesView","app/orderDocumentTree/views/UploadsView","app/orderDocumentTree/views/ToolbarView","app/orderDocumentTree/templates/page"],function(e,i,t,o,s,l,r,n,d,a,c,h,u,f){"use strict";return l.extend({template:f,layoutName:"page",events:{"scroll #-folders":function(){return!1}},actions:function(){return[{label:t.bound("orderDocumentTree","PAGE_ACTION:settings"),icon:"cogs",privileges:"DOCUMENTS:MANAGE",href:"#orders;settings?tab=documents"}]},breadcrumbs:function(){return[t("orderDocumentTree","BREADCRUMBS:base"),t("orderDocumentTree","BREADCRUMBS:root")]},initialize:function(){var t=this,o=t.model;t.onResize=e.debounce(t.resize.bind(t),20),t.$els={foldersContainer:null,folders:null,filesContainer:null,files:null,uploadContainer:null},t.pathView=new d({model:o}),t.foldersView=new a({model:o}),t.toolbarView=new u({model:o}),t.filesView=new c({model:o}),t.uploadsView=new h({model:o});var s="#"+t.idPrefix+"-";t.setView(s+"path",t.pathView),t.setView(s+"folders",t.foldersView),t.setView(s+"toolbar",t.toolbarView),t.setView(s+"files",t.filesView),t.setView(s+"uploadContainer",t.uploadsView),r(o.folders,t,"MSG:LOADING_FAILURE:folders"),r(o.files,t,"MSG:LOADING_FAILURE:files"),o.subscribe(t.pubsub),t.listenTo(o,"change:selectedFolder change:searchPhrase",t.onSelectedChange.bind(t,!0)),t.listenTo(o,"change:selectedFile change:dateFilter",t.onSelectedChange.bind(t,!1)),t.listenTo(o.files,"remove",t.onFileRemove),t.listenTo(o.uploads,"add remove",t.onUploadChange),i(window).on("resize."+t.idPrefix,t.onResize).on("scroll."+t.idPrefix,t.resize.bind(t))},destroy:function(){i(window).off("."+this.idPrefix),this.$els=null},load:function(e){var o=this.model;if(!o.hasSelectedFile()||o.hasSelectedFolder())return e(o.folders.fetch({reset:!0}),o.files.fetch({reset:!0}));var l=i.Deferred(),r=function(){i.when(o.folders.fetch({reset:!0}),o.files.fetch({reset:!0})).fail(function(){l.reject()}).done(function(){l.resolve()})};return this.ajax({url:"/orderDocuments/files/"+o.get("selectedFile")}).fail(function(){s.msg.show({type:"warning",time:3e3,text:t("orderDocumentTree","MSG:fileNotFound",{nc15:o.get("selectedFile")})})}).done(function(e){o.setSelectedFolder(e.folders[0],{keepFile:!0})}).always(r),e(l.promise())},serialize:function(){return{idPrefix:this.idPrefix,uploading:this.model.uploads.length>0}},afterRender:function(){var i=this;e.forEach(i.$els,function(e,t){i.$els[t]=i.$id(t)}),i.$els.folders.on("wheel",function(e){return!i.foldersView.isContextMenuVisible()&&(!(e.originalEvent.deltaY<0&&0===this.scrollTop)&&(!(e.originalEvent.deltaY>0&&this.scrollTop>=this.scrollHeight-this.offsetHeight)&&void 0))}),i.$els.folders.on("scroll",function(){this.scrollLeft=0}),this.resize()},resize:function(){var e=Math.max(15,this.$els.filesContainer[0].offsetTop-window.scrollY),i=window.innerHeight-17-e;this.$els.uploadContainer.css("top",e+"px").css("height",i+"px"),this.$els.foldersContainer.css("top",e+"px"),this.$els.folders.css("height",i+"px"),this.foldersView.hideContextMenu()},updateUrl:function(e){var i="/orderDocuments/tree?";this.model.hasSelectedFolder()&&(i+="folder="+this.model.get("selectedFolder")+"&"),this.model.hasSelectedFile()&&(i+="file="+this.model.get("selectedFile")+"&"),this.model.hasSearchPhrase()&&(i+="search="+encodeURIComponent(this.model.get("searchPhrase"))+"&"),this.model.hasDateFilter()&&(i+="date="+this.model.getDateFilter()+"&"),this.broker.publish("router.navigate",{url:i,replace:e,trigger:!1})},onSelectedChange:function(e,i,t,o){this.updateUrl(!(o&&o.updateUrl)),e&&this.promised(this.model.files.fetch({reset:!0}))},onFileRemove:function(e){e.id===this.model.get("selectedFile")&&this.model.setSelectedFile(null)},onUploadChange:function(){this.$el.toggleClass("is-uploading",this.model.uploads.length>0),this.pathView.positionFolderSelector(),this.foldersView.hideContextMenu(),this.filesView.positionPreview()}})});