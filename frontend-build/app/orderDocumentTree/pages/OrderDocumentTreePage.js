// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/orderDocumentTree/views/PathView","app/orderDocumentTree/views/FoldersView","app/orderDocumentTree/views/FilesView","app/orderDocumentTree/views/UploadsView","app/orderDocumentTree/templates/page","app/orderDocumentTree/templates/searchAction","app/orderDocumentTree/templates/displayModeAction"],function(e,i,t,o,s,r,n,l,d,a,c,h,f,u){"use strict";return r.extend({template:h,layoutName:"page",events:{"scroll #-folders":function(){return!1}},actions:function(){var e=this;return[{template:function(){return f({idPrefix:e.idPrefix})},afterRender:function(i){i.find("form").on("submit",e.onSearchFormSubmit.bind(e)).find('input[name="searchPhrase"]').val(e.model.get("searchPhrase")).on("keydown",e.onSearchPhraseKeyDown.bind(e))}},{template:function(){return u({displayMode:e.model.getDisplayMode()})},afterRender:function(i){i.on("change",".btn",function(){e.model.setDisplayMode(i.find("input:checked").val())})}},{label:t.bound("orderDocumentTree","PAGE_ACTION:settings"),icon:"cogs",privileges:"DOCUMENTS:MANAGE",href:"#orders;settings?tab=documents"}]},breadcrumbs:function(){return[t("orderDocumentTree","BREADCRUMBS:base"),t("orderDocumentTree","BREADCRUMBS:root")]},initialize:function(){var t=this,o=t.model;t.onResize=e.debounce(t.resize.bind(t),20),t.$els={foldersContainer:null,folders:null,filesContainer:null,files:null,uploadContainer:null},t.pathView=new l({model:o}),t.foldersView=new d({model:o}),t.filesView=new a({model:o}),t.uploadsView=new c({model:o}),t.setView("#"+t.idPrefix+"-path",t.pathView),t.setView("#"+t.idPrefix+"-folders",t.foldersView),t.setView("#"+t.idPrefix+"-files",t.filesView),t.setView("#"+t.idPrefix+"-uploadContainer",t.uploadsView),n(o.folders,t,"MSG:LOADING_FAILURE:folders"),n(o.files,t,"MSG:LOADING_FAILURE:files"),o.subscribe(t.pubsub),t.listenTo(o,"change:selectedFolder change:searchPhrase",t.onSelectedChange.bind(t,!0)),t.listenTo(o,"change:selectedFile",t.onSelectedChange.bind(t,!1)),t.listenTo(o.files,"remove",t.onFileRemove),t.listenTo(o.uploads,"add remove",t.onUploadChange),i(window).on("resize."+t.idPrefix,t.onResize).on("scroll."+t.idPrefix,t.resize.bind(t))},destroy:function(){i(window).off("."+this.idPrefix),this.$els=null},load:function(e){var o=this.model;if(!o.hasSelectedFile()||o.hasSelectedFolder())return e(o.folders.fetch({reset:!0}),o.files.fetch({reset:!0}));var r=i.Deferred(),n=function(){i.when(o.folders.fetch({reset:!0}),o.files.fetch({reset:!0})).fail(function(){r.reject()}).done(function(){r.resolve()})};return this.ajax({url:"/orderDocuments/files/"+o.get("selectedFile")}).fail(function(){s.msg.show({type:"warning",time:3e3,text:t("orderDocumentTree","MSG:fileNotFound",{nc15:o.get("selectedFile")})})}).done(function(e){o.setSelectedFolder(e.folders[0],{keepFile:!0})}).always(n),e(r.promise())},serialize:function(){return{idPrefix:this.idPrefix,uploading:this.model.uploads.length>0}},afterRender:function(){var i=this;e.forEach(i.$els,function(e,t){i.$els[t]=i.$id(t)}),i.$els.folders.on("wheel",function(e){return i.foldersView.isContextMenuVisible()?!1:e.originalEvent.deltaY<0&&0===this.scrollTop?!1:e.originalEvent.deltaY>0&&this.scrollTop>=this.scrollHeight-this.offsetHeight?!1:void 0}),i.$els.folders.on("scroll",function(){this.scrollLeft=0}),this.resize()},resize:function(){var e=Math.max(15,this.$els.filesContainer[0].offsetTop-window.scrollY),i=window.innerHeight-17-e;this.$els.uploadContainer.css("top",e+"px").css("height",i+"px"),this.$els.foldersContainer.css("top",e+"px"),this.$els.folders.css("height",i+"px"),this.foldersView.hideContextMenu()},updateUrl:function(){var e="/orderDocuments/tree?";this.model.hasSelectedFolder()&&(e+="folder="+this.model.get("selectedFolder")+"&"),this.model.hasSelectedFile()&&(e+="file="+this.model.get("selectedFile")+"&"),this.model.hasSearchPhrase()&&(e+="search="+encodeURIComponent(this.model.get("searchPhrase"))+"&"),this.broker.publish("router.navigate",{url:e,replace:!0,trigger:!1})},onSelectedChange:function(e){this.updateUrl(),this.$id("searchPhrase").val(this.model.get("searchPhrase")),e&&this.promised(this.model.files.fetch({reset:!0}))},onFileRemove:function(e){e.id===this.model.get("selectedFile")&&this.model.setSelectedFile(null)},onUploadChange:function(){this.$el.toggleClass("is-uploading",this.model.uploads.length>0),this.pathView.positionFolderSelector(),this.foldersView.hideContextMenu(),this.filesView.positionPreview()},onSearchFormSubmit:function(){return this.model.setSearchPhrase(this.$id("searchPhrase").val()),!1},onSearchPhraseKeyDown:function(e){return 27===e.keyCode?(this.model.setSearchPhrase(""),!1):void 0}})});