define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/orderDocumentTree/OrderDocumentFolder","app/orderDocumentTree/views/PathView","app/orderDocumentTree/views/FoldersView","app/orderDocumentTree/views/FilesView","app/orderDocumentTree/views/UploadsView","app/orderDocumentTree/views/ToolbarView","app/orderDocumentTree/templates/page"],function(e,i,t,s,o,l,r,n,d,h,a,c,u,f){"use strict";return l.extend({template:f,layoutName:"page",events:{"scroll #-folders":function(){return!1}},actions:function(){return[{label:t.bound("orderDocumentTree","PAGE_ACTION:settings"),icon:"cogs",privileges:"DOCUMENTS:MANAGE",href:"#orders;settings?tab=documents"}]},breadcrumbs:function(){return[t("orderDocumentTree","BREADCRUMBS:base"),t("orderDocumentTree","BREADCRUMBS:root")]},initialize:function(){var t=this.model;this.onResize=e.debounce(this.resize.bind(this),20),this.$els={foldersContainer:null,folders:null,filesContainer:null,files:null,uploadContainer:null},this.pathView=new d({model:t}),this.foldersView=new h({model:t}),this.toolbarView=new u({model:t}),this.filesView=new a({model:t}),this.uploadsView=new c({model:t});var s="#"+this.idPrefix+"-";this.setView(s+"path",this.pathView),this.setView(s+"folders",this.foldersView),this.setView(s+"toolbar",this.toolbarView),this.setView(s+"files",this.filesView),this.setView(s+"uploadContainer",this.uploadsView),r(t.folders,this,"MSG:LOADING_FAILURE:folders"),r(t.files,this,"MSG:LOADING_FAILURE:files"),t.subscribe(this.pubsub),this.listenTo(t,"change:selectedFolder change:searchPhrase",this.onSelectedChange.bind(this,!0)),this.listenTo(t,"change:selectedFile change:dateFilter",this.onSelectedChange.bind(this,!1)),this.listenTo(t.files,"remove",this.onFileRemove),this.listenTo(t.uploads,"add remove",this.onUploadChange),i(window).on("resize."+this.idPrefix,this.onResize).on("scroll."+this.idPrefix,this.resize.bind(this))},destroy:function(){i(window).off("."+this.idPrefix),this.$els=null},load:function(e){var s=this.model;if(!s.hasSelectedFile()||s.hasSelectedFolder())return e(s.folders.fetch({reset:!0}),s.files.fetch({reset:!0}));var l=i.Deferred();return this.ajax({url:"/orderDocuments/files/"+s.get("selectedFile")}).fail(function(){o.msg.show({type:"warning",time:3e3,text:t("orderDocumentTree","MSG:fileNotFound",{nc15:s.get("selectedFile")})})}).done(function(e){s.setSelectedFolder(e.folders[0],{keepFile:!0})}).always(function(){i.when(s.folders.fetch({reset:!0}),s.files.fetch({reset:!0})).fail(function(){l.reject()}).done(function(){l.resolve()})}),e(l.promise())},serialize:function(){return{idPrefix:this.idPrefix,uploading:this.model.uploads.length>0}},afterRender:function(){var i=this;e.forEach(i.$els,function(e,t){i.$els[t]=i.$id(t)}),i.$els.folders.on("wheel",function(e){return!i.foldersView.isContextMenuVisible()&&(!(e.originalEvent.deltaY<0&&0===this.scrollTop)&&(!(e.originalEvent.deltaY>0&&this.scrollTop>=this.scrollHeight-this.offsetHeight)&&void 0))}),i.$els.folders.on("scroll",function(){this.scrollLeft=0}),this.resize()},resize:function(){var e=this.$els.filesContainer;if(e&&e.length){var i=Math.max(15,e[0].offsetTop-window.scrollY),t=window.innerHeight-17-i;this.$els.uploadContainer.css("top",i+"px").css("height",t+"px"),this.$els.foldersContainer.css("top",i+"px"),this.$els.folders.css("height",t+"px"),this.foldersView.hideContextMenu()}},updateUrl:function(e){var i="/orderDocuments/tree?";this.model.hasSelectedFolder()&&(i+="folder="+this.model.get("selectedFolder")+"&"),this.model.hasSelectedFile()&&(i+="file="+this.model.get("selectedFile")+"&"),this.model.hasSearchPhrase()&&(i+="search="+encodeURIComponent(this.model.get("searchPhrase"))+"&"),this.model.hasDateFilter()&&(i+="date="+this.model.getDateFilter()+"&"),this.broker.publish("router.navigate",{url:i,replace:e,trigger:!1})},onSelectedChange:function(e,i,t,s){this.updateUrl(!(s&&s.updateUrl)),e&&this.promised(this.model.files.fetch({reset:!0}))},onFileRemove:function(e){e.id===this.model.get("selectedFile")&&this.model.setSelectedFile(null)},onUploadChange:function(){this.$el.toggleClass("is-uploading",this.model.uploads.length>0),this.pathView.positionFolderSelector(),this.foldersView.hideContextMenu(),this.filesView.positionPreview()}})});