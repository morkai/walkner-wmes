define(["underscore","jquery","../i18n","../time","../core/Model","../core/util/uuid","./allowedTypes"],function(e,t,r,s,n,a,i){"use strict";return n.extend({defaults:{folder:null,nc15:"",date:"",name:"",file:null,hash:"",retries:0,progress:-1,error:null},initialize:function(e,t){this.xhr=null,this.nameChanged=!(!t||!t.nameChanged),this.once("change:name",function(){this.nameChanged=!0},this)},needsRealName:function(){return!this.nameChanged&&15===this.get("nc15").length},isUploadable:function(){return!this.xhr&&!this.isUploaded()&&!!this.get("file")&&this.get("retries")<5&&!!i[this.get("file").type]},isReuploadable:function(){return this.isUploadable()&&null!==this.get("error")},isUploaded:function(){return 32===this.get("hash").length},isError:function(){return!!this.get("error")},getStatusClassName:function(){if(this.get("error"))return"danger";var e=this.get("progress");return 100===e?"success":-1===e?"primary":"warning"},getProgress:function(){return this.get("error")?100:Math.floor(Math.max(0,this.get("progress")))},getMessage:function(){var e=this.get("error");return e?r.has("orderDocumentTree","uploads:error:"+e)?r("orderDocumentTree","uploads:error:"+e):e:""},serializeDetails:function(){return{id:this.id,nc15:this.get("nc15"),date:this.get("date"),name:this.get("name"),statusClassName:this.getStatusClassName(),virtual:!this.get("file"),progress:this.getProgress(),message:this.getMessage()}},serializeFile:function(){return{upload:this.id,folder:this.get("folder").id,nc15:this.get("nc15"),hash:this.get("hash"),date:this.get("date"),name:this.get("name"),type:this.get("type")}},start:function(){var e=this;if(!e.xhr){var r=function(t){t.lengthComputable&&e.set("progress",Math.min(Math.floor(t.loaded/t.total*100),99))},s=new FormData;s.append("file",this.get("file")),e.xhr=t.ajax({type:"POST",url:"/orderDocuments/uploads",data:s,dataType:"text",processData:!1,contentType:!1,xhr:function(){var e=new XMLHttpRequest;return e.upload&&e.upload.addEventListener("progress",r),e}}),e.xhr.done(function(){/^[a-f0-9]{32}$/.test(e.xhr.responseText)?e.set({hash:e.xhr.responseText,progress:100}):e.set("error","INVALID_RESPONSE")}),e.xhr.fail(function(){e.set("error",e.xhr.responseText||"UNKNOWN_ERROR")}),e.xhr.always(function(){e.xhr=null,e.trigger("upload:done")}),e.set({progress:0,retries:e.get("retries")+1}),e.trigger("upload:start",e,e.xhr)}},stop:function(){this.xhr&&this.xhr.abort()}},{fromDocument:function(t,r,n){var i=t.get("files"),o=n?e.find(i,function(e){return e.hash===n}):i[0];return new this({_id:a(),folder:r,nc15:t.id,date:s.utc.format(o.date,"YYYY-MM-DD"),name:t.get("name"),type:o.type,hash:o.hash,progress:100},{nameChanged:!0})},fromFile:function(e,t){var r=this.resolveNc15(e.name),n=s.format(Date.now(),"YYYY-MM-DD"),o=this.resolveName(e.name,r),h=i[e.type],l=e.name.split(".").pop().toLowerCase(),u=null;return h?l!==h&&(u="INVALID_EXT"):u="INVALID_TYPE",new this({_id:a(),folder:t,nc15:r,date:n,name:o,type:e.type,file:e,error:u})},resolveNc15:function(e){var t=e.match(/([0-9]{15})/);return t?t[1]:""},resolveName:function(e,t){var r=e.replace(/\.pdf/i,"");return t&&(r=r.replace(t,"")),""===(r=r.replace(/^[^A-Za-z0-9ęóąśłżźćńĘÓĄŚŁŻŹĆŃ]+/,"").replace(/[^A-Za-z0-9ęóąśłżźćńĘÓĄŚŁŻŹĆŃ]+$/,""))?t:r}})});