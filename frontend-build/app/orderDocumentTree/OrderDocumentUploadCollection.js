define(["underscore","jquery","../time","../core/Collection","./OrderDocumentUpload"],function(n,t,e,i,r){"use strict";return i.extend({model:r,initialize:function(){this.upload={active:!1,current:null},this.on("remove",function(n){n.stop()})},addFromFile:function(n,t){this.add(r.fromFile(n,t))},addFromDocument:function(n,t,e){var i=r.fromDocument(n,t,e),o=this.find(function(n){return n.get("hash")===i.get("hash")});o?o.trigger("focus",o):this.add(i)},serializeFiles:function(){return this.filter(function(n){return n.isUploaded()}).map(function(n){return n.serializeFile()})},setDate:function(n){var t=e.getMoment(n,"YYYY-MM-DD");if(t.isValid()){var i=t.format("YYYY-MM-DD");this.forEach(function(n){n.set("date",i)})}},startUploading:function(){var n=this,t=n.upload;t.active||(t.current=n.find(function(n){return n.isUploadable()}),t.current&&(t.active=!0,t.current.once("upload:done",function(){t.current=null,t.active&&(t.active=!1,n.startUploading())}),t.current.start()))},stopUploading:function(){var n=this.upload;n.current&&n.current.stop(),n.active=!1},fillNames:function(){var e=this,i=e.filter(function(n){return n.needsRealName()}).map(function(n){return n.get("nc15")});return i.length?t.ajax({url:"/orderDocuments/names?_id=in=("+i+")"}).done(function(t){var i={};n.forEach(t.collection,function(n){i[n._id]=n.name}),e.forEach(function(n){var t=i[n.get("nc15")];n.needsRealName()&&t&&n.set("name",t)})}):null}})});