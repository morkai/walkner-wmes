define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/views/FormView","app/core/util/padString","app/orderDocumentTree/util/pasteDateEvents","app/orderDocumentTree/templates/editFileDialog"],function(e,t,n,i,o,r,s,a,c){"use strict";return r.extend({template:c,events:e.assign({'change input[name="folders[]"]':function(){var e=this.$('input[name="folders[]"]');e.first().prop("required",0===e.filter(":checked").length)},"click #-components-addByName-toggle":function(){return this.toggleAddByName(!0),!1},"click #-components-addByName button":function(){return this.submitAddByName(),!1},"keydown #-components-addByName":function(e){return"Escape"===e.key?(this.toggleAddByName(!1),!1):"Enter"===e.key?(this.submitAddByName(),!1):void 0}},a,r.prototype.events),initialize:function(e){if(r.prototype.initialize.apply(this,arguments),this.tree=e.tree,!this.tree)throw new Error("The `tree` option is required!")},getTemplateData:function(){var t=this.tree;return{folders:e.map(this.model.get("folders"),function(e){return{id:e,path:t.getPath(t.folders.get(e)).map(function(e){return e.getLabel()}).join(" > ")}}).filter(function(e){return e.path.length>0})}},serializeToForm:function(){var e=this.model.toJSON();return e.components="",e.files=e.files.map(function(e){return{hash:e.hash,type:e.type,date:i.utc.format(e.date,"YYYY-MM-DD")}}),e},serializeForm:function(e){return e.components=this.$id("components").select2("data").map(function(e){return{nc12:/^0{10,}/.test(e.id)?"000000000000":e.id,name:e.text,searchName:e.text.toUpperCase().replace(/[^A-Z0-9]+/g,"")}}),e},request:function(e){return this.promised(this.tree.editFile(this.model,e))},getFailureText:function(){return this.t("editFile:msg:failure")},handleSuccess:function(){e.isFunction(this.closeDialog)&&this.closeDialog(),o.msg.show({type:"success",time:2500,text:this.t("editFile:msg:success")})},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e)},afterRender:function(){r.prototype.afterRender.apply(this,arguments);var t=0;this.$id("components").select2({width:"100%",placeholder:"12NC...",allowClear:!0,multiple:!0,minimumInputLength:8,ajax:{cache:!0,quietMillis:300,url:function(e){return"/orders/components?limit(100)&_id=regex="+encodeURIComponent("^"+e)},results:function(e){return{results:(e.collection||[]).map(function(e){return{id:e._id,text:e.name.trim()}})}}},formatSelection:function(t){return e.escape(/^0{10,}/.test(t.id)?t.text:t.id)},formatResult:function(t){var n=['<span class="text-mono">',e.escape(s.start(t.id,12,"0")),"</span>"];return t.text&&n.push('<span class="text-small">:',e.escape(t.text)+"</span>"),n.join("")}}).select2("data",(this.model.get("components")||[]).map(function(e){var n=e.nc12;return"000000000000"===n&&(t+=1,n=s.start(t.toString(),12,"0")),{id:n,text:e.name}}))},toggleAddByName:function(e){var t=this.$id("components-addByName").toggleClass("hidden",!e);e&&t.find("input").val("").focus()},submitAddByName:function(){this.toggleAddByName(!1);var e=this.$id("components-addByName").find("input").val().trim();if(""!==e.toUpperCase().replace(/[^A-Z0-9]+/g,"")){var t=this.$id("components"),n=t.select2("data"),i=0;n.forEach(function(e){/^0{10,}/.test(e.id)&&(i=Math.max(+e.id,i))}),n.push({id:s.start((i+1).toString(),12,"0"),text:e}),t.select2("data",n)}}})});