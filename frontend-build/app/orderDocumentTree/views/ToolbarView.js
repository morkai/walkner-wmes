define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","./UnlinkFilesDialogView","./RemoveFilesDialogView","./RecoverFilesDialogView","app/orderDocumentTree/templates/toolbar"],function(e,t,i,o,s,n,r,a,l,d){"use strict";return n.extend({template:d,events:{'change input[name="displayMode"]':function(){this.model.setDisplayMode(this.$('input[name="displayMode"]:checked').val())},"change #-date":function(){this.model.setDateFilter(this.$id("date").val())},"submit #-searchForm":function(){return this.model.setSearchPhrase(this.$id("searchPhrase").val()),!1},"keydown #-searchPhrase":function(e){if("Escape"===e.key)return this.model.setSearchPhrase(""),!1},"mousedown #-copyToClipboard":function(){this.captureCopy=!0,document.execCommand("copy")},"click #-unlinkMarkedFiles":function(e){e.currentTarget.disabled=!0;var t=this.model,o=new r({model:{tree:t,files:t.getMarkedFiles(),folder:t.getSelectedFolder()}});o.once("dialog:hidden",this.toggleMarkedButtons.bind(this)),s.showDialog(o,i("orderDocumentTree","unlinkFiles:title"))},"click #-removeMarkedFiles":function(e){e.currentTarget.disabled=!0;var t=this.model,o=new a({model:{tree:t,files:t.getMarkedFiles(),folder:t.getSelectedFolder(),purge:t.isInTrash(this.model.getSelectedFolder())}});o.once("dialog:hidden",this.toggleMarkedButtons.bind(this)),s.showDialog(o,i("orderDocumentTree","removeFiles:title"))},"click #-recoverMarkedFiles":function(e){e.currentTarget.disabled=!0;var t=new l({model:{tree:this.model,files:this.model.getMarkedFiles()}});t.once("dialog:hidden",this.toggleMarkedButtons.bind(this)),s.showDialog(t,i("orderDocumentTree","recoverFiles:title"))},"click #-editMarkedFiles":function(){var e=this.model;e.getMarkedFiles().forEach(function(t){var i=t.get("files")[0];i&&e.addUpload(t.id,i.hash)})},"focus #-searchPhrase":function(){var e=this,i=e.$id("searchForm").css({position:"relative"}),o=e.$id("searchPhrase"),s=i.find("textarea");function n(t){var i=e.$id("searchPhrase"),o=e.$id("searchForm").css({position:""}),s=o.find("textarea"),n=s.val().trim(),r="";/^[0-9]{3,14}$/.test(n)&&(n="*"+n+"*");var a=n.split(/\s+/).filter(function(e){return!!/^[0-9]{15}$/.test(e)||(/[0-9]{3,}/.test(e)&&/[#*]/.test(e)&&(r=e),!1)});s.remove(),i.val(r||a.join(" ")),t?o.submit():o.find(".btn").focus()}s.length||(s=t('<textarea class="form-control" rows="4"></textarea>').css({position:"absolute",top:0,left:0,zIndex:3}).appendTo(i).on("blur",function(){n(!1)}).on("keydown",function(e){if("Escape"===e.key)return s.val(""),n(!0),!1;if("Enter"===e.key){if(e.ctrlKey||e.timeStamp-s.data("lastEnterTs")<=200)return n(!0),!1;s.data("lastEnterTs",e.timeStamp)}})),s.val(o.val().split(/\s+/).join("\n")),setTimeout(function(){s.focus()},1)}},initialize:function(){var e=this.model;this.captureCopy=!1,this.loadingFiles=!1,this.listenTo(e,"change:searchPhrase change:selectedFolder",this.onFolderChange),this.listenTo(e,"change:markedFiles",this.onMarkedFilesChange),this.listenTo(e.folders,"reset add remove change:parent",this.updateFolderCount),this.listenTo(e.files,"request",this.onFilesRequest),this.listenTo(e.files,"sync",this.onFilesSync),this.listenTo(e.files,"reset add remove change:folders",this.updateFileCount),t(document).on("copy."+this.idPrefix,this.onCopy.bind(this))},destroy:function(){t(document).off("."+this.idPrefix)},afterRender:function(){this.toggleMarkedButtons()},getTemplateData:function(){return{displayMode:this.model.getDisplayMode(),searchPhrase:this.model.getSearchPhrase(),dateFilter:this.model.getDateFilter(),folderCount:this.serializeFolderCount(),fileCount:this.serializeFileCount(),markedFileCount:this.model.getMarkedFileCount()}},serializeFolderCount:function(){var e=this.model;if(e.hasSearchPhrase())return 0;var t=e.getSelectedFolder();return e.hasSelectedFolder()?t?t.get("children").length:0:e.getRootFolders().length},serializeFileCount:function(){var e=this.model;return e.files.length?e.files.totalCount:this.loadingFiles?"?":0},onFolderChange:function(){this.updateFolderCount(),this.updateFileCount(),this.updateSearchPhrase(),this.toggleMarkedButtons()},updateSearchPhrase:function(){this.$id("searchPhrase").val(this.model.getSearchPhrase())},updateFolderCount:function(){this.$id("folderCount").text(this.serializeFolderCount())},updateFileCount:function(){this.$id("fileCount").text(this.serializeFileCount())},updateMarkedFileCount:function(){this.$id("markedFileCount").text(this.model.getMarkedFileCount())},toggleMarkedButtons:function(){var e=this.model,t=e.getSelectedFolder(),i=!e.getMarkedFileCount()||e.hasSearchPhrase(),o=t&&"__TRASH__"===t.id;this.$id("recoverMarkedFiles").prop("disabled",i).toggleClass("hidden",!o),this.$id("unlinkMarkedFiles").prop("disabled",i).toggleClass("hidden",e.isInTrash(t)),this.$id("removeMarkedFiles").prop("disabled",i),this.$id("editMarkedFiles").prop("disabled",i)},onFilesRequest:function(){this.loadingFiles=!0,this.updateFileCount()},onFilesSync:function(){this.loadingFiles=!1,this.updateFileCount()},onMarkedFilesChange:function(){this.toggleMarkedButtons(),this.updateMarkedFileCount()},onCopy:function(e){if(this.captureCopy){this.captureCopy=!1,e.preventDefault();var t=[];if(this.model.files.forEach(function(e){var i=[e.id,e.getLabel()];e.get("files").forEach(function(e){i.push(o.utc.format(e.date,"L"))}),t.push(i)}),t.length){e.originalEvent.clipboardData.setData("text/plain",t.map(function(e){return e.join("\t")}).join("\r\n"));var n="<table><tr>";t.forEach(function(e){n+="<tr>",e.forEach(function(e,t){n+="<td>"+(t<2?"'":"")+e+"</td>"}),n+="</tr>"}),n+="</table>",e.originalEvent.clipboardData.setData("text/html",n),s.msg.show({type:"info",time:2e3,text:i("orderDocumentTree","toolbar:copyToClipboard:success",{rows:t.length})})}}}})});