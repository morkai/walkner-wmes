// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","./UnlinkFilesDialogView","./RemoveFilesDialogView","./RecoverFilesDialogView","app/orderDocumentTree/templates/toolbar"],function(e,t,i,o,n,r,l,s,a,d){"use strict";return r.extend({template:d,events:{'change input[name="displayMode"]':function(){this.model.setDisplayMode(this.$('input[name="displayMode"]:checked').val())},"submit #-searchForm":function(){return this.model.setSearchPhrase(this.$id("searchPhrase").val()),!1},"keydown #-searchPhrase":function(e){if(27===e.keyCode)return this.model.setSearchPhrase(""),!1},"mousedown #-copyToClipboard":function(){this.captureCopy=!0,document.execCommand("copy")},"click #-unlinkMarkedFiles":function(e){e.currentTarget.disabled=!0;var t=this.model,o=new l({model:{tree:t,files:t.getMarkedFiles(),folder:t.getSelectedFolder()}});o.once("dialog:hidden",this.toggleMarkedButtons.bind(this)),n.showDialog(o,i("orderDocumentTree","unlinkFiles:title"))},"click #-removeMarkedFiles":function(e){e.currentTarget.disabled=!0;var t=this.model,o=new s({model:{tree:t,files:t.getMarkedFiles(),folder:t.getSelectedFolder(),purge:t.isInTrash(this.model.getSelectedFolder())}});o.once("dialog:hidden",this.toggleMarkedButtons.bind(this)),n.showDialog(o,i("orderDocumentTree","removeFiles:title"))},"click #-recoverMarkedFiles":function(e){e.currentTarget.disabled=!0;var t=new a({model:{tree:this.model,files:this.model.getMarkedFiles()}});t.once("dialog:hidden",this.toggleMarkedButtons.bind(this)),n.showDialog(t,i("orderDocumentTree","recoverFiles:title"))}},initialize:function(){var e=this,i=e.model;e.captureCopy=!1,e.loadingFiles=!1,e.listenTo(i,"change:searchPhrase change:selectedFolder",e.onFolderChange),e.listenTo(i,"change:markedFiles",e.onMarkedFilesChange),e.listenTo(i.folders,"reset add remove change:parent",e.updateFolderCount),e.listenTo(i.files,"request",e.onFilesRequest),e.listenTo(i.files,"sync",e.onFilesSync),e.listenTo(i.files,"reset add remove change:folders",e.updateFileCount),t(document).on("copy."+e.idPrefix,e.onCopy.bind(e))},destroy:function(){t(document).off("."+this.idPrefix)},afterRender:function(){this.toggleMarkedButtons()},serialize:function(){return e.assign(r.prototype.serialize.apply(this,arguments),{displayMode:this.model.getDisplayMode(),searchPhrase:this.model.getSearchPhrase(),folderCount:this.serializeFolderCount(),fileCount:this.serializeFileCount(),markedFileCount:this.model.getMarkedFileCount()})},serializeFolderCount:function(){var e=this.model;if(e.hasSearchPhrase())return 0;var t=e.getSelectedFolder();return e.hasSelectedFolder()?t?t.get("children").length:0:e.getRootFolders().length},serializeFileCount:function(){var e=this.model;return e.files.length?e.files.totalCount:this.loadingFiles?"?":0},onFolderChange:function(){this.updateFolderCount(),this.updateFileCount(),this.updateSearchPhrase(),this.toggleMarkedButtons()},updateSearchPhrase:function(){this.$id("searchPhrase").val(this.model.getSearchPhrase())},updateFolderCount:function(){this.$id("folderCount").text(this.serializeFolderCount())},updateFileCount:function(){this.$id("fileCount").text(this.serializeFileCount())},updateMarkedFileCount:function(){this.$id("markedFileCount").text(this.model.getMarkedFileCount())},toggleMarkedButtons:function(){var e=this.model,t=e.getSelectedFolder(),i=!e.getMarkedFileCount()||e.hasSearchPhrase(),o=t&&"__TRASH__"===t.id;this.$id("recoverMarkedFiles").prop("disabled",i).toggleClass("hidden",!o),this.$id("unlinkMarkedFiles").prop("disabled",i).toggleClass("hidden",e.isInTrash(t)),this.$id("removeMarkedFiles").prop("disabled",i)},onFilesRequest:function(){this.loadingFiles=!0,this.updateFileCount()},onFilesSync:function(){this.loadingFiles=!1,this.updateFileCount()},onMarkedFilesChange:function(){this.toggleMarkedButtons(),this.updateMarkedFileCount()},onCopy:function(e){if(this.captureCopy){this.captureCopy=!1,e.preventDefault();var t=[];if(this.model.files.forEach(function(e){var i=[e.id,e.getLabel()];e.get("files").forEach(function(e){i.push(o.utc.format(e.date,"L"))}),t.push(i)}),t.length){e.originalEvent.clipboardData.setData("text/plain",t.map(function(e){return e.join("\t")}).join("\r\n"));var r="<table><tr>";t.forEach(function(e){r+="<tr>",e.forEach(function(e,t){r+="<td>"+(t<2?"'":"")+e+"</td>"}),r+="</tr>"}),r+="</table>",e.originalEvent.clipboardData.setData("text/html",r),n.msg.show({type:"info",time:2e3,text:i("orderDocumentTree","toolbar:copyToClipboard:success",{rows:t.length})})}}}})});