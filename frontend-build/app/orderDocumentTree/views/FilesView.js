// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/views/DialogView","app/orderDocumentTree/OrderDocumentTree","app/orderDocumentTree/views/EditFileDialogView","app/orderDocumentTree/templates/files","app/orderDocumentTree/templates/filesFile","app/orderDocumentTree/templates/filesFolder","app/orderDocumentTree/templates/removeFileDialog","app/orderDocumentTree/templates/recoverFileDialog"],function(e,i,t,l,s,r,o,n,d,a,h,c,f,u){"use strict";return r.extend({template:a,events:{"click .orderDocumentTree-files-folder":function(e){if(""!==window.getSelection().toString())return!1;this.model.setSelectedFolder(e.currentTarget.dataset.id,{scroll:!0,keepFile:!1})},"mouseup a[data-hash]":function(e){if(e.altKey)return this.addUpload(e.currentTarget.dataset.fileId,e.currentTarget.dataset.hash),e.target.blur(),!1},"click a[data-hash]":function(e){if(e.altKey)return!1},"click .orderDocumentTree-files-file":function(e){if("A"!==e.target.tagName&&""===window.getSelection().toString()){var i=this.model,t=i.files.get(e.currentTarget.dataset.id);return e.altKey?(this.addUpload(t.id,null),!1):e.ctrlKey?void this.toggleMarkFile(t):(this.lastClickEvent=e,i.setSelectedFile(t.id),!1)}},"click #-closePreview":function(){this.model.setSelectedFile(null)},"dblclick #-preview":function(e){this.$(e.target).closest(".btn").length||this.model.setSelectedFile(null)},"click a[data-folder-id]":function(e){return this.model.setSelectedFolder(e.target.dataset.folderId,{scroll:!0,keepFile:!0}),!1},"click #-editFile":function(){var e=new d({model:this.model.getSelectedFile(),tree:this.model,done:function(){s.closeDialog()}});s.showDialog(e,t("orderDocumentTree","editFile:title"))},"click #-removeFile":function(){var e=this.model,i=e.getSelectedFolder(),l=e.getSelectedFile(),r=e.isInTrash(i),n=new o({template:f,autoHide:!1,model:{nc15:l.id,multiple:l.get("folders").length>1,purge:r}});this.listenTo(n,"answered",function(r){var o="purge"===r?e.purgeFile(l):"remove"===r?e.removeFile(l):e.unlinkFile(l,i);o.fail(function(){n.enableAnswers(),s.msg.show({type:"error",time:3e3,text:t("orderDocumentTree","removeFile:msg:failure")})}),o.done(function(){n.closeDialog(),s.msg.show({type:"success",time:3e3,text:t("orderDocumentTree","removeFile:msg:success")})})}),s.showDialog(n,t("orderDocumentTree","removeFile:title"))},"click #-recoverFile":function(){var e=this.model.getSelectedFile(),i=new o({template:u,autoHide:!1,model:{nc15:e.id}});this.listenTo(i,"answered",function(l){if("yes"!==l)return void i.closeDialog();var r=this.model.recoverFile(e);r.fail(function(){i.enableAnswers(),s.msg.show({type:"error",time:3e3,text:t("orderDocumentTree","recoverFile:msg:failure")})}),r.done(function(){i.closeDialog(),s.msg.show({type:"success",time:3e3,text:t("orderDocumentTree","recoverFile:msg:success")})})}),s.showDialog(i,t("orderDocumentTree","recoverFile:title"))}},initialize:function(){var e=this,t=e.model;e.serializeFolder=e.serializeFolder.bind(e),e.serializeFile=e.serializeFile.bind(e),e.listenTo(t,"change:displayMode",e.onDisplayModeChange),e.listenTo(t,"change:selectedFolder change:searchPhrase",e.render),e.listenTo(t,"change:selectedFile",e.onSelectedFileChange),e.listenTo(t,"change:markedFiles",e.onMarkedFilesChange),e.listenTo(t,"change:dateFilter",e.onDateFilterChange),e.listenTo(t.files,"request",e.onFilesRequest),e.listenTo(t.files,"error",e.onFilesError),e.listenTo(t.files,"reset",e.onFilesReset),e.listenTo(t.files,"remove",e.onFilesRemove),e.listenTo(t.files,"add",e.onFilesAdd),e.listenTo(t.files,"change",e.onFilesChange),e.listenTo(t.files,"focus",e.onFilesFocus),e.listenTo(t.folders,"add",e.onFoldersAdd),e.listenTo(t.folders,"remove",e.onFoldersRemove),e.listenTo(t.folders,"change:parent",e.onParentChange),i(window).on("resize."+e.idPrefix,e.positionPreview.bind(e)),i("body").on("keydown."+e.idPrefix,function(e){27===e.keyCode&&t.setSelectedFile(null)})},destroy:function(){i(window).off("."+this.idPrefix),i("body").off("."+this.idPrefix)},serialize:function(){return e.extend(r.prototype.serialize.apply(this,arguments),{displayMode:this.model.getDisplayMode(),searchPhrase:this.model.getSearchPhrase(),folders:this.serializeFolders(),files:this.serializeFiles()})},serializeMoreFiles:function(){var e=this.model.files;return e.length>0&&e.totalCount>e.length?e.totalCount-e.length:0},serializeFolders:function(){return this.model.hasSearchPhrase()?[]:this.model.getChildFolders(this.model.getSelectedFolder()).map(this.serializeFolder)},serializeFolder:function(e){return{id:e.id,label:e.getLabel().replace(/_/g," "),icon:"__TRASH__"===e.id?"fa-trash-o":"fa-folder-o"}},serializeFiles:function(){var e=this.model.getDateFilter(),i=function(){return!0};e&&(e+="T00:00:00.000Z",i=function(i){for(var t=i.get("files"),l=0;l<t.length;++l)if(t[l].date===e)return!0;return!1});var t=this.model.files.filter(i).map(this.serializeFile),l=this.serializeMoreFiles();return l&&t.push({id:null,text:"+"+l,smallText:"",selected:!1,icon:"fa-files-o"}),t},serializeFile:function(e){var i=e.getLabel();i===e.id&&(i="");var t=this.model.isMarkedFile(e);return{id:e.id,text:e.id,smallText:i.replace(/_/g," "),selected:e.id===this.model.get("selectedFile"),marked:t,icon:"fa-file-o",files:e.get("files")}},afterRender:function(){this.showPreviewIfNeeded()},addUpload:function(e,i){var t=this.model,l=t.getSelectedFolder();if(!t.isInTrash(l)){var s=t.files.get(e),r=t.hasSearchPhrase()?t.folders.get(s.get("folders")[0]):l;this.model.uploads.addFromDocument(s,r,i)}},toggleMarkFile:function(e){if(!this.model.hasSearchPhrase()||1===e.get("folders").length)return void this.model.toggleMarkFile(e);s.msg.show({type:"warning",time:3e3,text:t("orderDocumentTree","MSG:canNotMarkSearchResult")})},showPreviewIfNeeded:function(){var e=this.$(".is-selected")[0];e?(e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():e.scrollIntoView(),this.showPreview()):this.hidePreview()},showPreview:function(){var i=this.$id("preview"),t=this.serializePreview();e.forEach(t,function(e,t){i.find('dd[data-prop="'+t+'"]').html(e)});var l=this.model,s=l.getSelectedFolder(),r=s&&"__TRASH__"===s.id,o=l.isInTrash(s);i.css({top:"-1000px",left:"-1000px"}).toggleClass("is-trash",r).toggleClass("is-in-trash",o).removeClass("hidden"),this.positionPreview()},serializePreview:function(){var i=this.model.getSelectedFile();return{nc15:e.escape(i.id),name:e.escape(i.getLabel()),folders:this.serializePreviewFolders(),files:this.serializePreviewFiles()}},serializePreviewFolders:function(){var i=this.model,t=i.getSelectedFolder(),l=i.getSelectedFile(),s="",r=i.canSeeTrash();return e.forEach(l.get("folders"),function(o){var n=i.folders.get(o);if(n){var d=i.getPath(n),a=d[0],h="__TRASH__"===a.id;h&&!r||(d=d.map(function(e){return e.getLabel()}).join(" > "),s+='<li title="'+e.escape(d)+'">',s+=n===t?'<span style="text-decoration: '+(h?"line-through":"none")+'">'+e.escape(n.getLabel())+"</span>":'<a href="#orderDocuments/tree?folder='+n.id+"&file="+l.id+'" data-folder-id="'+n.id+'" style="text-decoration: '+(h?"line-through":"none")+'">'+e.escape(n.getLabel())+"</a>")}}),s?"<ul>"+s+"</ul>":"-"},serializePreviewFiles:function(){var i=this.model.getSelectedFile(),s="";return e.forEach(i.get("files"),function(e){s+='<li><a href="/orderDocuments/'+i.id+"?pdf=1&hash="+e.hash+'" target="_blank" data-file-id="'+i.id+'" data-hash="'+e.hash+'">'+t("orderDocumentTree","files:files:date",{date:l.utc.format(e.date,"LL")})+"</a>"}),s?"<ul>"+s+"</ul>":"-"},positionPreview:function(){var e=this.$(".is-selected");if(e.length){var i,t,l=this.$id("preview").css({top:"-1000px",left:"-1000px"}),s=l.outerWidth(),r=l.outerHeight(),o=this.model.getDisplayMode()===n.DISPLAY_MODE.LIST;if(o&&this.lastClickEvent)i=this.lastClickEvent.pageY,t=this.lastClickEvent.pageX,t+s+15>=window.innerWidth&&(t=window.innerWidth-s-30),this.lastClickEvent.clientY+r+15>=window.innerHeight&&(i-=r);else{var d=e.offset(),a=d.left+s+15>window.innerWidth,h=d.left+200;t=a?h-s:d.left,i=d.top,o&&(i+=14,t+=14)}this.$id("preview").css({top:i+"px",left:t+"px"})}},hidePreview:function(){this.$id("preview").addClass("hidden")},showEmptyIfNeeded:function(){this.$id("folders").children().length||this.$id("files").children().length||this.$id("files").html("<p>"+t("orderDocumentTree","files:"+(this.model.hasSearchPhrase()?"noResults":"empty"))+"</p>")},addFile:function(e){this.model.hasSearchPhrase()||(this.$id("files").find("> p").remove(),this.$id("files").append(h({file:this.serializeFile(e)})))},removeFile:function(e){var i=this.$file(e.id);i.length&&(i.hasClass("is-selected")&&this.hidePreview(),i.remove(),this.showEmptyIfNeeded())},updateFile:function(e){var i=this.$file(e.id);if(!i.length)return void this.addFile(e);i.replaceWith(h({file:this.serializeFile(e)})),e===this.model.getSelectedFile()&&this.showPreview()},$folder:function(e){return this.$id("folders").find('.orderDocumentTree-files-item[data-id="'+e+'"]')},$file:function(e){return this.$id("files").find('.orderDocumentTree-files-item[data-id="'+e+'"]')},onSelectedFileChange:function(){var e=this.model.getSelectedFile();this.$id("files").find(".is-selected").removeClass("is-selected"),e?(this.$id("files").find('.orderDocumentTree-files-item[data-id="'+e.id+'"]').addClass("is-selected"),this.showPreview()):this.hidePreview()},onMarkedFilesChange:function(e,i,t){this.$file(i.id).toggleClass("is-marked",t)},onDateFilterChange:function(){this.render()},onFilesRequest:function(){this.hidePreview(),0===this.$(".orderDocumentTree-files-folder").length&&this.$id("files").html('<p><i class="fa fa-spinner fa-spin fa-3x"></i></p>')},onFilesError:function(){this.$id("files").find(".fa").css("color","red")},onFilesReset:function(){var e="",i=this.serializeFiles();0===i.length&&0===this.$(".orderDocumentTree-files-folder").length?e="<p>"+t("orderDocumentTree","files:"+(this.model.hasSearchPhrase()?"noResults":"empty"))+"</p>":i.forEach(function(i){e+=h({file:i})}),this.$id("files").html(e),this.showPreviewIfNeeded()},onFilesAdd:function(e){this.addFile(e)},onFilesRemove:function(e){this.removeFile(e)},onFilesChange:function(e){e.isInFolder(this.model.get("selectedFolder"))?this.updateFile(e):this.$file(e.id).length&&this.removeFile(e)},onFilesFocus:function(e,i){var t='a[data-hash="'+i+'"]';if(this.model.getSelectedFile()===e)return void this.$id("preview").find(t).focus();var l=this.$file(e.id).find(t);if(l.length)return void l.focus();this.model.setSelectedFile(e.id),this.$id("preview").find(t).focus()},onFoldersAdd:function(e){this.model.hasSearchPhrase()||this.$id("folders").append(c({folder:this.serializeFolder(e)}))},onFoldersRemove:function(e){this.$folder(e.id).remove(),this.showEmptyIfNeeded()},onParentChange:function(e){var i=this.$folder(e.id);i.length&&e.get("parent")!==this.model.get("selectedFolder")&&i.remove()},onDisplayModeChange:function(){this.$el.removeClass(e.values(n.DISPLAY_MODE).map(function(e){return"is-"+e}).join(" ")).addClass("is-"+this.model.getDisplayMode()),this.positionPreview()}})});