define(["underscore","jquery","app/i18n","app/time","app/viewport","app/user","app/core/View","app/core/views/DialogView","app/core/util/padString","app/core/util/fileIcons","app/data/clipboard","app/planning/util/contextMenu","../OrderDocumentTree","./EditFileDialogView","./FileChangesView","app/orderDocumentTree/templates/files","app/orderDocumentTree/templates/filesFile","app/orderDocumentTree/templates/filesFolder","app/orderDocumentTree/templates/removeFileDialog","app/orderDocumentTree/templates/recoverFileDialog"],function(e,i,t,l,s,o,r,n,a,d,h,c,f,u,g,p,m,F,v,w){"use strict";return r.extend({template:p,events:{"click .orderDocumentTree-files-folder":function(e){if(""!==window.getSelection().toString())return!1;this.model.setSelectedFolder(e.currentTarget.dataset.id,{scroll:!0,keepFile:!1})},"mouseup a[data-hash]":function(e){if(e.altKey)return this.model.addUpload(e.currentTarget.dataset.fileId,e.currentTarget.dataset.hash),e.target.blur(),!1},"click a[data-hash]":function(e){if(e.altKey)return!1},"click .orderDocumentTree-files-file":function(e){if("A"!==e.target.tagName&&""===window.getSelection().toString()){var i=this.model,t=i.files.get(e.currentTarget.dataset.id);if(t){if(e.altKey)return i.addUpload(t.id,null),!1;if(!e.ctrlKey)return this.lastClickEvent=e,i.setSelectedFile(t.id),!1;this.toggleMarkFile(t)}}},"click #-closePreview":function(){this.model.setSelectedFile(null)},"dblclick #-preview":function(e){this.$(e.target).closest(".btn").length||this.model.setSelectedFile(null)},"click a[data-folder-id]":function(e){return this.model.setSelectedFolder(e.target.dataset.folderId,{scroll:!0,keepFile:!0}),!1},'click dd[data-prop="nc15"]':function(e){var i=this,t=i.model.getSelectedFile();if(t){if(e.ctrlKey){var l=i.model.uploads.find(function(e){return""===e.get("nc15")});return l&&l.set("nc15",t.id,{source:"preview"}),!1}return h.copy(function(l){l.setData("text/plain",t.id),h.showTooltip(i,e.currentTarget,e.pageX,e.pageY,{title:i.t("files:msg:nc15:copied")})}),!1}},"click #-editFile":function(){this.showEditFileDialog(this.model.getSelectedFile())},"click #-removeFile":function(){this.showRemoveFileDialog(this.model.getSelectedFolder(),this.model.getSelectedFile())},"click #-recoverFile":function(){this.showRecoverFileDialog(this.model.getSelectedFile())},"click #-subFile":function(){var e=this,t=e.model.get("selectedFile"),l=i.ajax({method:"POST",url:"/subscriptions/orderDocumentTree/"+t});e.$id("subFile").prop("disabled",!0).attr("title","").find(".fa").attr("class","fa fa-spinner fa-spin"),l.fail(function(){s.msg.show({type:"error",time:2500,text:e.t("files:sub:failure")}),t===e.model.get("selectedFile")&&e.resolveFileSub()})},"click #-showChanges":function(){this.showFileChangesDialog(this.model.getSelectedFile())},"contextmenu .orderDocumentTree-files-file":function(e){e.preventDefault();var i=this,t=i.model,l=t.files.get(e.currentTarget.dataset.id),s=[l.id];if(o.isAllowedTo("DOCUMENTS:VIEW")&&s.push({icon:"fa-calendar",label:i.t("files:changes"),handler:function(){i.showFileChangesDialog(l)}}),o.isAllowedTo("DOCUMENTS:MANAGE")){t.isTrash()&&s.push({icon:"fa-undo",label:i.t("files:recover"),handler:function(){i.showRecoverFileDialog(l)}}),s.push({icon:"fa-edit",label:i.t("files:edit"),handler:function(){i.showEditFileDialog(l)}});var r=l.get("files");r.length&&r[0].hash!==e.target.dataset.hash&&s.push({label:i.t("files:edit:latestFile"),handler:function(){t.addUpload(l.id,r[0].hash)}}),e.target.dataset.hash&&s.push({label:i.t("files:edit:specificFile",{date:e.target.textContent.trim()}),handler:function(){t.addUpload(l.id,e.target.dataset.hash)}}),s.push({icon:"fa-trash-o",label:i.t("files:remove"),handler:function(){i.showRemoveFileDialog(t.getSelectedFolder(),l)}})}c.show(i,e.pageY,e.pageX,s)}},remoteTopics:{"subscriptions.*":function(e,i){var t=e.model;"orderDocumentTree"===t.type&&t.user===o.data._id&&(/added|edited/.test(i)?this.toggleFileSub(t.target,t):/deleted/.test(i)&&this.toggleFileSub(t.target,null))}},initialize:function(){var e=this.model;this.serializeFolder=this.serializeFolder.bind(this),this.serializeFile=this.serializeFile.bind(this),this.listenTo(e,"change:displayMode",this.onDisplayModeChange),this.listenTo(e,"change:selectedFolder change:searchPhrase",this.render),this.listenTo(e,"change:selectedFile",this.onSelectedFileChange),this.listenTo(e,"change:markedFiles",this.onMarkedFilesChange),this.listenTo(e,"change:dateFilter",this.onDateFilterChange),this.listenTo(e.files,"request",this.onFilesRequest),this.listenTo(e.files,"error",this.onFilesError),this.listenTo(e.files,"reset",this.onFilesReset),this.listenTo(e.files,"remove",this.onFilesRemove),this.listenTo(e.files,"add",this.onFilesAdd),this.listenTo(e.files,"change",this.onFilesChange),this.listenTo(e.files,"focus",this.onFilesFocus),this.listenTo(e.folders,"add",this.onFoldersAdd),this.listenTo(e.folders,"remove",this.onFoldersRemove),this.listenTo(e.folders,"change:parent",this.onParentChange),i(window).on("resize."+this.idPrefix,this.positionPreview.bind(this)),i("body").on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){i(window).off("."+this.idPrefix),i("body").off("."+this.idPrefix)},getTemplateData:function(){return{displayMode:this.model.getDisplayMode(),searchPhrase:this.model.getSearchPhrase(),folders:this.serializeFolders(),files:this.serializeFiles()}},serializeMoreFiles:function(){var e=this.model.files;return e.length>0&&e.totalCount>e.length?e.totalCount-e.length:0},serializeFolders:function(){return this.model.hasSearchPhrase()?[]:this.model.getChildFolders(this.model.getSelectedFolder()).map(this.serializeFolder)},serializeFolder:function(e){return{id:e.id,label:e.getLabel().replace(/_/g," "),icon:"__TRASH__"===e.id?"fa-trash-o":"fa-folder-o"}},serializeFiles:function(){var e=this.model.getDateFilter(),i=function(){return!0};e&&(e+="T00:00:00.000Z",i=function(i){for(var t=i.get("files"),l=0;l<t.length;++l)if(t[l].date===e)return!0;return!1});var t=this.model.files.filter(i).map(this.serializeFile),l=this.serializeMoreFiles();return l&&t.push({id:null,text:"+"+l,smallText:"",selected:!1,icon:"fa-files-o"}),t},serializeFile:function(e){var i=e.getLabel();i===e.id&&(i="");var t=this.model.isMarkedFile(e),s=e.get("files"),o=e.id;return/^000/.test(o)&&(o=o.replace(/^(0+)([0-9]+)$/,'<span class="orderDocumentTree-files-label-prefix">$1</span>$2')),{id:e.id,text:o,smallText:i.replace(/_/g," "),selected:e.id===this.model.get("selectedFile"),marked:t,icon:d.getByMime(s.length?s[0].type:null),files:s.map(function(e){return{hash:e.hash,date:l.format(e.date,"L"),title:e.updatedAt&&e.updater?e.updater.label+"\n"+l.format(e.updatedAt,"LLL"):""}})}},beforeRender:function(){this.lastClickEvent=null},afterRender:function(){this.showPreviewIfNeeded()},showEditFileDialog:function(e){var i=new u({model:e,tree:this.model,done:function(){s.closeDialog()}});s.showDialog(i,this.t("editFile:title"))},showFileChangesDialog:function(e){var i=new g({nc15:e.id,model:this.model});s.showDialog(i,e.id+": "+e.getLabel())},showRecoverFileDialog:function(e){var i=this,t=new n({template:w,autoHide:!1,model:{nc15:e.id}});i.listenTo(t,"answered",function(l){if("yes"===l){var o=this.model.recoverFile(e);o.fail(function(){t.enableAnswers(),s.msg.show({type:"error",time:3e3,text:i.t("recoverFile:msg:failure")})}),o.done(function(){t.closeDialog(),s.msg.show({type:"success",time:3e3,text:i.t("recoverFile:msg:success")})})}else t.closeDialog()}),s.showDialog(t,i.t("recoverFile:title"))},showRemoveFileDialog:function(e,i){var t=this,l=t.model,o=l.isInTrash(e),r=new n({template:v,autoHide:!1,model:{nc15:i.id,multiple:i.get("folders").length>1,purge:o}});t.listenTo(r,"answered",function(o){var n="purge"===o?l.purgeFile(i):"remove"===o?l.removeFile(i):l.unlinkFile(i,e);n.fail(function(){r.enableAnswers(),s.msg.show({type:"error",time:3e3,text:t.t("removeFile:msg:failure")})}),n.done(function(){r.closeDialog(),s.msg.show({type:"success",time:3e3,text:t.t("removeFile:msg:success")})})}),s.showDialog(r,t.t("removeFile:title"))},toggleMarkFile:function(e){this.model.hasSearchPhrase()&&1!==e.get("folders").length?s.msg.show({type:"warning",time:3e3,text:this.t("MSG:canNotMarkSearchResult")}):this.model.toggleMarkFile(e)},showPreviewIfNeeded:function(){var e=this.$(".is-selected")[0];e?(e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():e.scrollIntoView(),this.showPreview()):this.hidePreview()},showPreview:function(){var i=this.$id("preview"),t=this.serializePreview();this.$id("previewIcon").attr("class","fa fa-3x "+t.icon),e.forEach(t,function(e,t){i.find('dd[data-prop="'+t+'"]').html(e).toggleClass("hidden",!e.length).prev().toggleClass("hidden",!e.length)});var l=this.model,s=l.getSelectedFolder(),o=l.isTrash(),r=l.isInTrash(s);i.css({top:"-1000px",left:"-1000px"}).toggleClass("is-trash",o).toggleClass("is-in-trash",r).removeClass("hidden"),this.$id("subFile").prop("disabled",!0).removeClass("hidden").attr("title","").find(".fa").attr("class","fa fa-spinner fa-spin"),this.resolveFileSub(),this.positionPreview()},serializePreview:function(){var i=this.model.getSelectedFile(),t=i.get("files");return{icon:d.getByMime(t.length?t[0].type:null),nc15:this.serializePreviewNc15(),name:e.escape(i.getLabel()),folders:this.serializePreviewFolders(),files:this.serializePreviewFiles(),components:this.serializePreviewComponents(),stations:i.get("stations").join(", "),updatedAt:this.serializePreviewUpdatedAt()}},serializePreviewNc15:function(){return this.model.getSelectedFile().id.replace(/^(0{3,15})([0-9]{1,15})$/,'<span class="orderDocumentTree-files-label-prefix">$1</span>$2')+' <a href="javascript:void(0)"><i class="fa fa-copy"></i></a>'},serializePreviewFolders:function(){var i=this.model,t=i.getSelectedFolder(),l=i.getSelectedFile(),s="",o=i.canSeeTrash();return e.forEach(l.get("folders"),function(r){var n=i.folders.get(r);if(n){var a=i.getPath(n),d="__TRASH__"===a[0].id;d&&!o||(a=a.map(function(e){return e.getLabel()}).join(" > "),s+='<li title="'+e.escape(a)+'">',s+=n===t?'<span style="text-decoration: '+(d?"line-through":"none")+'">'+e.escape(n.getLabel())+"</span>":'<a href="#orderDocuments/tree?folder='+n.id+"&file="+l.id+'" data-folder-id="'+n.id+'" style="text-decoration: '+(d?"line-through":"none")+'">'+e.escape(n.getLabel())+"</a>")}}),s?"<ul>"+s+"</ul>":""},serializePreviewFiles:function(){var i=this,t=i.model.getSelectedFile(),s="";return e.forEach(t.get("files"),function(o){var r="";o.updatedAt&&o.updater&&(r=e.escape(o.updater.label)+"\n"+l.format(o.updatedAt,"LLL")),s+='<li><a target="_blank" href="/orderDocuments/'+t.id+"?original=1&hash="+o.hash+'" data-file-id="'+t.id+'" data-hash="'+o.hash+'" title="'+r+'">'+i.t("files:files:date",{date:l.utc.format(o.date,"LL")})+"</a>"}),s?"<ul>"+s+"</ul>":""},serializePreviewComponents:function(){var i=this.model.getSelectedFile().get("components")||[];if(0===i.length)return"";for(var t="",l=0,s=Math.min(2,i.length);l<s;++l){var o=i[l],r=o.name,n=a.start(o.nc12,12,"0");"000000000000"===o.nc12&&(n=r,r=""),t+='<li title="'+e.escape(r)+'">'+e.escape(n)}return i.length>2&&(t+=" +"+(i.length-2)),t?"<ul>"+t+"</ul>":""},serializePreviewUpdatedAt:function(){var i=this.model.getSelectedFile(),t=i.get("updatedAt"),s=i.get("updater");return this.t("files:updatedAt:value",{date:t?l.format(t,"LLL"):"?",user:s?e.escape(s.label):"?"})},positionPreview:function(){var e=this.$(".is-selected");if(e.length){var i,t,l=this.$id("preview").css({top:"-1000px",left:"-1000px"}),s=l.outerWidth(),o=l.outerHeight(),r=this.model.getDisplayMode()===f.DISPLAY_MODE.LIST;if(r&&this.lastClickEvent)i=this.lastClickEvent.pageY,(t=this.lastClickEvent.pageX)+s+15>=window.innerWidth&&(t=window.innerWidth-s-30),this.lastClickEvent.clientY+o+15>=window.innerHeight&&(i-=o);else{var n=e.offset(),a=n.left+s+15>window.innerWidth,d=n.left+200;t=a?d-s:n.left,i=n.top,r&&(i+=14,t+=14)}this.$id("preview").css({top:i+"px",left:t+"px"})}},hidePreview:function(){this.$id("preview").addClass("hidden"),this.fileSubReq&&(this.fileSubReq.abort(),this.fileSubReq=null)},resolveFileSub:function(){var e=this,i=e.model.getSelectedFile();if(i){var t=i.id,l=e.fileSubReq=e.ajax({method:"GET",url:"/subscriptions/orderDocumentTree/"+t});l.fail(function(){var i=e.model.getSelectedFile();i&&t===i.id&&e.$id("subFile").addClass("hidden")}),l.done(function(i){e.toggleFileSub(t,i.subscription)}),l.always(function(){e.fileSubReq=null})}},toggleFileSub:function(e,i){var t=this.model.getSelectedFile();if(t&&e===t.id){var l=!1;if(i){if(e!==i.target)return;l=!0}this.$id("subFile").prop("disabled",!1).removeClass("hidden").toggleClass("active",l).attr("title",this.t("files:sub:"+l)).find(".fa").attr("class","fa fa-eye")}},showEmptyIfNeeded:function(){this.$id("folders").children().length||this.$id("files").children().length||this.$id("files").html("<p>"+this.t("files:"+(this.model.hasSearchPhrase()?"noResults":"empty"))+"</p>")},addFile:function(e){this.model.hasSearchPhrase()||(this.$id("files").find("> p").remove(),this.$id("files").append(this.renderPartialHtml(m,{file:this.serializeFile(e)})))},removeFile:function(e){var i=this.$file(e.id);i.length&&(i.hasClass("is-selected")&&this.hidePreview(),i.remove(),this.showEmptyIfNeeded())},updateFile:function(e){var i=this.$file(e.id);i.length?(i.replaceWith(this.renderPartialHtml(m,{file:this.serializeFile(e)})),e===this.model.getSelectedFile()&&this.showPreview()):this.addFile(e)},$folder:function(e){return this.$id("folders").find('.orderDocumentTree-files-item[data-id="'+e+'"]')},$file:function(e){return this.$id("files").find('.orderDocumentTree-files-item[data-id="'+e+'"]')},onSelectedFileChange:function(){var e=this.model.getSelectedFile();this.$id("files").find(".is-selected").removeClass("is-selected"),e?(this.$id("files").find('.orderDocumentTree-files-item[data-id="'+e.id+'"]').addClass("is-selected"),this.showPreview()):this.hidePreview()},onMarkedFilesChange:function(e,i,t){this.$file(i.id).toggleClass("is-marked",t)},onDateFilterChange:function(){this.render()},onFilesRequest:function(){this.hidePreview(),0===this.$(".orderDocumentTree-files-folder").length&&this.$id("files").html('<p><i class="fa fa-spinner fa-spin fa-3x"></i></p>')},onFilesError:function(){this.$id("files").find(".fa").css("color","red")},onFilesReset:function(){var e=this,i="",t=e.serializeFiles();0===t.length&&0===e.$(".orderDocumentTree-files-folder").length?i="<p>"+e.t("files:"+(this.model.hasSearchPhrase()?"noResults":"empty"))+"</p>":t.forEach(function(t){i+=e.renderPartialHtml(m,{file:t})}),e.$id("files").html(i),e.showPreviewIfNeeded()},onFilesAdd:function(e){this.addFile(e)},onFilesRemove:function(e){this.removeFile(e)},onFilesChange:function(e){e.isInFolder(this.model.get("selectedFolder"))?this.updateFile(e):this.$file(e.id).length&&this.removeFile(e)},onFilesFocus:function(e,i){var t='a[data-hash="'+i+'"]';if(this.model.getSelectedFile()!==e){var l=this.$file(e.id).find(t);l.length?l.focus():(this.model.setSelectedFile(e.id),this.$id("preview").find(t).focus())}else this.$id("preview").find(t).focus()},onFoldersAdd:function(e){this.model.hasSearchPhrase()||this.$id("folders").append(this.renderPartialHtml(F,{folder:this.serializeFolder(e)}))},onFoldersRemove:function(e){this.$folder(e.id).remove(),this.showEmptyIfNeeded()},onParentChange:function(e){var i=this.$folder(e.id);i.length&&e.get("parent")!==this.model.get("selectedFolder")&&i.remove()},onDisplayModeChange:function(){this.$el.removeClass(e.values(f.DISPLAY_MODE).map(function(e){return"is-"+e}).join(" ")).addClass("is-"+this.model.getDisplayMode()),this.positionPreview()},onKeyDown:function(e){switch(e.key&&e.key.toUpperCase()){case"ESCAPE":c.isVisible(this)?c.hide(this):this.model.hasSelectedFile()?this.model.setSelectedFile(null):this.model.getMarkedFileCount()&&this.model.unmarkAllFiles();break;case"A":var i=(document.activeElement||document.body).tagName;e.ctrlKey&&!document.getSelection().toString().length&&"INPUT"!==i&&"TEXTAREA"!==i&&(this.model.markAllFiles(),e.preventDefault())}}})});