// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/views/DialogView","app/orderDocumentTree/OrderDocumentTree","app/orderDocumentTree/views/EditFileDialogView","app/orderDocumentTree/templates/files","app/orderDocumentTree/templates/filesFile","app/orderDocumentTree/templates/filesFolder","app/orderDocumentTree/templates/removeFileDialog","app/orderDocumentTree/templates/recoverFileDialog"],function(e,i,t,l,s,o,r,d,n,a,c,h,f,u){"use strict";return o.extend({template:a,events:{"click .orderDocumentTree-files-folder":function(e){return""!==window.getSelection().toString()?!1:void this.model.setSelectedFolder(e.currentTarget.dataset.id,{scroll:!0,keepFile:!1})},"click a[data-hash]":function(e){return e.altKey?(this.addUpload(e.currentTarget.dataset.fileId,e.currentTarget.dataset.hash),e.target.blur(),!1):void 0},"click .orderDocumentTree-files-file":function(e){if("A"!==e.target.tagName&&""===window.getSelection().toString()){var i=this.model,t=i.files.get(e.currentTarget.dataset.id);return e.altKey?(this.addUpload(t.id,null),!1):(this.lastClickEvent=e,i.setSelectedFile(t.id),!1)}},"click #-closePreview":function(){this.model.setSelectedFile(null)},"dblclick #-preview":function(e){this.$(e.target).closest(".btn").length||this.model.setSelectedFile(null)},"click a[data-folder-id]":function(e){return this.model.setSelectedFolder(e.target.dataset.folderId,{scroll:!0,keepFile:!0}),!1},"click #-editFile":function(){var e=new n({model:this.model.getSelectedFile(),tree:this.model,done:function(){s.closeDialog()}});s.showDialog(e,t("orderDocumentTree","editFile:title"))},"click #-removeFile":function(){var e=this.model.getSelectedFile(),i=new r({template:f,autoHide:!1,model:{nc15:e.id,multiple:e.get("folders").length>1}});this.listenTo(i,"answered",function(l){var o="remove"===l?this.model.removeFile(e):this.model.unlinkFile(e,this.model.getSelectedFolder());o.fail(function(){i.enableAnswers(),s.msg.show({type:"error",time:3e3,text:t("orderDocumentTree","removeFile:msg:failure")})}),o.done(function(){i.closeDialog(),s.msg.show({type:"success",time:3e3,text:t("orderDocumentTree","removeFile:msg:success")})})}),s.showDialog(i,t("orderDocumentTree","removeFile:title"))},"click #-recoverFile":function(){var e=this.model.getSelectedFile(),i=new r({template:u,autoHide:!1,model:{nc15:e.id}});this.listenTo(i,"answered",function(l){if("yes"!==l)return void i.closeDialog();var o=this.model.recoverFile(e);o.fail(function(){i.enableAnswers(),s.msg.show({type:"error",time:3e3,text:t("orderDocumentTree","recoverFile:msg:failure")})}),o.done(function(){i.closeDialog(),s.msg.show({type:"success",time:3e3,text:t("orderDocumentTree","recoverFile:msg:success")})})}),s.showDialog(i,t("orderDocumentTree","recoverFile:title"))}},initialize:function(){var e=this,t=e.model;e.serializeFolder=e.serializeFolder.bind(e),e.serializeFile=e.serializeFile.bind(e),e.listenTo(t,"change:displayMode",e.onDisplayModeChange),e.listenTo(t,"change:selectedFolder change:searchPhrase",e.render),e.listenTo(t,"change:selectedFile",e.onSelectedFileChange),e.listenTo(t.files,"request",e.onFilesRequest),e.listenTo(t.files,"error",e.onFilesError),e.listenTo(t.files,"reset",e.onFilesReset),e.listenTo(t.files,"remove",e.onFilesRemove),e.listenTo(t.files,"add",e.onFilesAdd),e.listenTo(t.files,"change",e.onFilesChange),e.listenTo(t.files,"focus",e.onFilesFocus),e.listenTo(t.folders,"add",e.onFoldersAdd),e.listenTo(t.folders,"remove",e.onFoldersRemove),e.listenTo(t.folders,"change:parent",e.onParentChange),i(window).on("resize."+e.idPrefix,e.positionPreview.bind(e)),i("body").on("keydown."+e.idPrefix,function(e){27===e.keyCode&&t.setSelectedFile(null)})},destroy:function(){i(window).off("."+this.idPrefix),i("body").off("."+this.idPrefix)},serialize:function(){return e.extend(o.prototype.serialize.apply(this,arguments),{displayMode:this.model.getDisplayMode(),searchPhrase:this.model.getSearchPhrase(),folders:this.serializeFolders(),files:this.serializeFiles()})},serializeMoreFiles:function(){var e=this.model.files;return e.length>0&&e.totalCount>e.length?e.totalCount-e.length:0},serializeFolders:function(){return this.model.hasSearchPhrase()?[]:this.model.getChildFolders(this.model.getSelectedFolder()).map(this.serializeFolder)},serializeFolder:function(e){return{id:e.id,label:e.getLabel().replace(/_/g," "),icon:"__TRASH__"===e.id?"fa-trash":"fa-folder-o"}},serializeFiles:function(){var e=this.model.files.map(this.serializeFile),i=this.serializeMoreFiles();return i&&e.push({id:null,text:"+"+i,smallText:"",selected:!1,icon:"fa-files-o"}),e},serializeFile:function(e){var i=e.getLabel();return i===e.id&&(i=""),{id:e.id,text:e.id,smallText:i.replace(/_/g," "),selected:e.id===this.model.get("selectedFile"),icon:"fa-file-o",files:e.get("files")}},afterRender:function(){this.showPreviewIfNeeded()},addUpload:function(e,i){var t=this.model,l=t.files.get(e),s=t.hasSearchPhrase()?t.folders.get(l.get("folders")[0]):t.getSelectedFolder();this.model.uploads.addFromDocument(l,s,i)},showPreviewIfNeeded:function(){var e=this.$(".is-selected")[0];e?(e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():e.scrollIntoView(),this.showPreview()):this.hidePreview()},showPreview:function(){var i=this.$id("preview"),t=this.serializePreview();e.forEach(t,function(e,t){i.find('dd[data-prop="'+t+'"]').html(e)}),i.css({top:"-1000px",left:"-1000px"}).toggleClass("is-trash",this.model.getSelectedFile().isInTrash()).removeClass("hidden"),this.positionPreview()},serializePreview:function(){var i=this.model.getSelectedFile();return{nc15:e.escape(i.id),name:e.escape(i.getLabel()),folders:this.serializePreviewFolders(),files:this.serializePreviewFiles()}},serializePreviewFolders:function(){var i=this.model,t=i.getSelectedFolder(),l=i.getSelectedFile(),s="",o=i.canSeeTrash();return e.forEach(l.get("folders"),function(r){var d=i.folders.get(r);if(d){var n=i.getPath(d),a=n[0],c="__TRASH__"===a.id;(!c||o)&&(n=n.map(function(e){return e.getLabel()}).join(" > "),s+='<li title="'+e.escape(n)+'">',s+=d===t?'<span style="text-decoration: '+(c?"line-through":"none")+'">'+e.escape(d.getLabel())+"</span>":'<a href="#orderDocuments/tree?folder='+d.id+"&file="+l.id+'" data-folder-id="'+d.id+'" style="text-decoration: '+(c?"line-through":"none")+'">'+e.escape(d.getLabel())+"</a>")}}),s?"<ul>"+s+"</ul>":"-"},serializePreviewFiles:function(){var i=this.model.getSelectedFile(),s="";return e.forEach(i.get("files"),function(e){s+='<li><a href="/orderDocuments/'+i.id+"?pdf=1&hash="+e.hash+'" target="_blank" data-file-id="'+i.id+'" data-hash="'+e.hash+'">'+t("orderDocumentTree","files:files:date",{date:l.utc.format(e.date,"LL")})+"</a>"}),s?"<ul>"+s+"</ul>":"-"},positionPreview:function(){var e=this.$(".is-selected");if(e.length){var i,t,l=this.$id("preview").css({top:"-1000px",left:"-1000px"}),s=l.outerWidth(),o=l.outerHeight(),r=this.model.getDisplayMode()===d.DISPLAY_MODE.LIST;if(r&&this.lastClickEvent)i=this.lastClickEvent.pageY,t=this.lastClickEvent.pageX,t+s+15>=window.innerWidth&&(t=window.innerWidth-s-30),this.lastClickEvent.clientY+o+15>=window.innerHeight&&(i-=o);else{var n=e.offset(),a=200,c=n.left+s+15>window.innerWidth,h=n.left+a;t=c?h-s:n.left,i=n.top,r&&(i+=14,t+=14)}this.$id("preview").css({top:i+"px",left:t+"px"})}},hidePreview:function(){this.$id("preview").addClass("hidden")},addFile:function(e){this.model.hasSearchPhrase()||(this.$id("files").find("> p").remove(),this.$id("files").append(c({file:this.serializeFile(e)})))},removeFile:function(e){var i=this.$file(e.id);i.length&&(i.hasClass("is-selected")&&this.hidePreview(),i.remove(),this.$id("folders").children().length||this.$id("files").children().length||this.$id("files").html("<p>"+t("orderDocumentTree","files:"+(this.model.hasSearchPhrase()?"noResults":"empty"))+"</p>"))},updateFile:function(e){var i=this.$file(e.id);return i.length?(i.replaceWith(c({file:this.serializeFile(e)})),void(e===this.model.getSelectedFile()&&this.showPreview())):void this.addFile(e)},$folder:function(e){return this.$id("folders").find('.orderDocumentTree-files-item[data-id="'+e+'"]')},$file:function(e){return this.$id("files").find('.orderDocumentTree-files-item[data-id="'+e+'"]')},onSelectedFileChange:function(){var e=this.model.getSelectedFile();this.$id("files").find(".is-selected").removeClass("is-selected"),e?(this.$id("files").find('.orderDocumentTree-files-item[data-id="'+e.id+'"]').addClass("is-selected"),this.showPreview()):this.hidePreview()},onFilesRequest:function(){this.hidePreview(),0===this.$(".orderDocumentTree-files-folder").length&&this.$id("files").html('<i class="fa fa-spinner fa-spin fa-3x"></i>')},onFilesError:function(){this.$id("files").find(".fa").css("color","red")},onFilesReset:function(){var e="";0===this.model.files.length&&0===this.$(".orderDocumentTree-files-folder").length?e="<p>"+t("orderDocumentTree","files:"+(this.model.hasSearchPhrase()?"noResults":"empty"))+"</p>":this.serializeFiles().forEach(function(i){e+=c({file:i})}),this.$id("files").html(e),this.showPreviewIfNeeded()},onFilesAdd:function(e){this.addFile(e)},onFilesRemove:function(e){this.removeFile(e)},onFilesChange:function(e){e.isInFolder(this.model.getSelectedFolder().id)?this.updateFile(e):this.$file(e.id).length&&this.removeFile(e)},onFilesFocus:function(e,i){var t='a[data-hash="'+i+'"]';if(this.model.getSelectedFile()===e)return void this.$id("preview").find(t).focus();var l=this.$file(e.id).find(t);return l.length?void l.focus():(this.model.setSelectedFile(e.id),void this.$id("preview").find(t).focus())},onFoldersAdd:function(e){this.model.hasSearchPhrase()||this.$id("folders").append(h({folder:this.serializeFolder(e)}))},onFoldersRemove:function(e){this.$folder(e.id).remove()},onParentChange:function(e){var i=this.$folder(e.id);i.length&&e.get("parent")!==this.model.get("selectedFolder")&&i.remove()},onDisplayModeChange:function(){this.$el.removeClass(e.values(d.DISPLAY_MODE).map(function(e){return"is-"+e}).join(" ")).addClass("is-"+this.model.getDisplayMode()),this.positionPreview()}})});