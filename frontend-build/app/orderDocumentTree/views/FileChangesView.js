define(["underscore","app/time","app/core/View","app/core/util/padString","app/core/templates/userInfo","../OrderDocumentChangeCollection","app/orderDocumentTree/templates/fileChanges"],function(e,t,r,s,n,i,a){"use strict";return r.extend({dialogClassName:"orderDocumentTree-changes-dialog",template:a,initialize:function(){this.state="loading",this.changes=new i(null,{paginate:!1,rqlQuery:"sort(time)&limit(0)&nc15="+this.options.nc15}),this.listenTo(this.changes,"request",this.updateState.bind(this,"loading")),this.listenTo(this.changes,"error",this.updateState.bind(this,"error")),this.listenTo(this.changes,"sync",this.updateState.bind(this,"loaded")),this.promised(this.changes.fetch({reset:!0}))},updateState:function(e){this.state=e,this.render()},getTemplateData:function(){var e=this,r={name:"",folders:"",files:"",components:""};return{state:e.state,changes:e.changes.map(function(s){var i=s.get("data"),a="";return i&&i.name&&i.name!==r.name&&(a=r.name=i.name),{time:t.format(s.get("time"),"L, HH:mm:ss"),user:n({userInfo:s.get("user")}),type:e.t("fileChanges:type:"+s.get("type")),name:a,folders:e.serializeFolders(i,r),files:e.serializeFiles(i,r),components:e.serializeComponents(i,r)}})}},serializeFolders:function(t,r){if(!t||!Array.isArray(t.folders))return"";var s=JSON.stringify(t.folders);if(s===r.folders)return"";r.folders=s;var n=this.model;return'<ul class="orderDocumentTree-changes-list">'+t.folders.map(function(t){var r=n.folders.get(t);if(!r)return"<li>"+t;var s=n.getPath(r).map(function(e){return e.getLabel()}).join(" > ");return'<li title="'+e.escape(s)+'">'+e.escape(r.getLabel())}).join("")+"</ul>"},serializeFiles:function(e,r){if(!e||!Array.isArray(e.files))return"";var s=JSON.stringify(e.files);if(s===r.files)return"";r.files=s;var n=this,i="";return e.files.forEach(function(r){i+='<li><a target="_blank" href="/orderDocuments/'+e._id+"?pdf=1&hash="+r.hash+'">'+n.t("files:files:date",{date:t.utc.format(r.date,"LL")})+"</a>"}),i?'<ul class="orderDocumentTree-changes-list">'+i+"</ul>":""},serializeComponents:function(t,r){if(!t||!Array.isArray(t.components))return"";var n=JSON.stringify(t.components);if(n===r.components)return"";r.components=n;var i="";return t.components.forEach(function(t){var r=t.name,n=s.start(t.nc12,12,"0");"000000000000"===t.nc12&&(n=r,r=""),i+='<li title="'+e.escape(r)+'">'+e.escape(n)}),i?'<ul class="orderDocumentTree-changes-list">'+i+"</ul>":""}})});