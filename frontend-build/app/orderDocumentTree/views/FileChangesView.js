define(["underscore","app/time","app/core/View","app/core/templates/userInfo","../OrderDocumentChangeCollection","app/orderDocumentTree/templates/fileChanges"],function(e,t,i,r,s,a){"use strict";return i.extend({dialogClassName:"orderDocumentTree-changes-dialog",template:a,initialize:function(){this.state="loading",this.changes=new s(null,{paginate:!1,rqlQuery:"sort(time)&limit(0)&nc15="+this.options.nc15}),this.listenTo(this.changes,"request",this.updateState.bind(this,"loading")),this.listenTo(this.changes,"error",this.updateState.bind(this,"error")),this.listenTo(this.changes,"sync",this.updateState.bind(this,"loaded")),this.promised(this.changes.fetch({reset:!0}))},updateState:function(e){this.state=e,this.render()},getTemplateData:function(){var e=this,i={name:"",folders:"",files:""};return{state:e.state,changes:e.changes.map(function(s){var a=s.get("data"),n="";return a&&a.name&&a.name!==i.name&&(n=i.name=a.name),{time:t.format(s.get("time"),"L, HH:mm:ss"),user:r({userInfo:s.get("user")}),type:e.t("fileChanges:type:"+s.get("type")),name:n,folders:e.serializeFolders(a,i),files:e.serializeFiles(a,i)}})}},serializeFolders:function(t,i){if(!t||!Array.isArray(t.folders))return"";var r=JSON.stringify(t.folders);if(r===i.folders)return"";i.folders=r;var s=this.model;return'<ul class="orderDocumentTree-changes-list">'+t.folders.map(function(t){var i=s.folders.get(t);if(!i)return"<li>"+t;var r=s.getPath(i).map(function(e){return e.getLabel()}).join(" > ");return'<li title="'+e.escape(r)+'">'+e.escape(i.getLabel())}).join("")+"</ul>"},serializeFiles:function(e,i){if(!e||!Array.isArray(e.files))return"";var r=JSON.stringify(e.files);if(r===i.files)return"";i.files=r;var s=this,a="";return e.files.forEach(function(i){a+='<li><a target="_blank" href="/orderDocuments/'+e._id+"?pdf=1&hash="+i.hash+'">'+s.t("files:files:date",{date:t.utc.format(i.date,"LL")})+"</a>"}),a?"<ul>"+a+"</ul>":""}})});