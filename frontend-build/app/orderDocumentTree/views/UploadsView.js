// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","form2js","app/i18n","app/user","app/viewport","app/core/View","app/orderDocumentTree/util/pasteDateEvents","app/orderDocumentTree/templates/uploads","app/orderDocumentTree/templates/upload"],function(e,t,o,a,i,s,n,r,d,l){"use strict";return n.extend({template:d,events:e.assign({'click button[data-action="remove"]':function(e){var t=this.model.uploads.get(this.$upload(e.target).attr("data-id"));t&&this.model.uploads.remove(t)},"change .orderDocumentTree-uploads-field":function(e){var t=this.model.uploads.get(this.$upload(e.target).attr("data-id"));t&&t.set(e.target.name,e.target.value,{source:"user"})},"click #-setDate":function(){this.model.uploads.setDate(this.$id("date").val())},"click .orderDocumentTree-uploads-nc15[readonly]":function(e){var t=this.model.files.get(e.currentTarget.value);if(t){var o=this.$upload(e.target)[0].dataset.id,a=this.model.uploads.get(o);t.trigger("focus",t,a.get("hash"))}},submit:function(e){e.preventDefault();var t=this.$id("setDate").prop("disabled",!0),o=this.$id("submit").prop("disabled",!0),a=this.model.addFiles();s.msg.saving(),a.fail(function(){s.msg.savingFailed()}),a.done(function(){s.msg.saved()}),a.always(function(){t.prop("disabled",!1),o.prop("disabled",!1)})}},r),initialize:function(){var e=this,o=e.model,a=e.onDrag.bind(e);e.uploadIndex=this.model.uploads.length,e.listenTo(o.uploads,"add",this.onAdd),e.listenTo(o.uploads,"remove",this.onRemove),e.listenTo(o.uploads,"focus",this.onFocus),e.listenTo(o.uploads,"upload:start",this.onUploadStart),e.listenTo(o.uploads,"change:date",this.onDateChange),e.listenTo(o.uploads,"change:name",this.onNameChange),e.listenTo(o.uploads,"change:error change:progress",this.onProgressChange),t(document).on("dragenter."+e.idPrefix,a).on("dragleave."+e.idPrefix,a).on("dragover."+e.idPrefix,a).on("drop."+e.idPrefix,e.onDrop.bind(e))},destroy:function(){t(document).off("."+this.idPrefix),this.model.uploads.stopUploading()},serialize:function(){return e.extend(n.prototype.serialize.apply(this,arguments),{uploads:this.model.uploads.invoke("serializeDetails"),renderUpload:l})},$upload:function(e){return"string"==typeof e?this.$('.orderDocumentTree-uploads-upload[data-id="'+e+'"]'):this.$(e).closest(".orderDocumentTree-uploads-upload")},onDrag:function(e){e.preventDefault(),e.stopPropagation()},onDrop:function(e){if(e=e.originalEvent,e.dataTransfer.files.length){if(e.preventDefault(),e.stopPropagation(),!i.isAllowedTo("DOCUMENTS:MANAGE"))return void s.msg.show({type:"warning",time:3e3,text:a("orderDocumentTree","uploads:msg:notAllowed")});var t=this.model,o=t.getSelectedFolder();if(!o)return void s.msg.show({type:"warning",time:3e3,text:a("orderDocumentTree","uploads:msg:noFolder")});if(t.isInTrash(o))return void s.msg.show({type:"warning",time:3e3,text:a("orderDocumentTree","uploads:msg:folderIsTrash")});var n=t.uploads,r=e.dataTransfer.files;n.remove(n.filter(function(e){return e.isError()}),{animate:!1});for(var d=0;d<r.length;++d)n.addFromFile(r[d],o)}},onAdd:function(e){this.$id("uploads").append(l({upload:e.serializeDetails(),i:this.uploadIndex++})),this.model.uploads.startUploading(this.promised.bind(this)),clearTimeout(this.timers.fillNames),this.timers.fillNames=setTimeout(this.fillNames.bind(this),1)},fillNames:function(){this.promised(this.model.uploads.fillNames())},onRemove:function(e,o,a){a&&a.animate===!1?this.$upload(e.id).remove():this.$upload(e.id).fadeOut("fast",function(){t(this).remove()})},onFocus:function(e){this.$upload(e.id).find('input[name="date"]').focus()},onDateChange:function(e,t,o){o&&"user"!==o.source&&this.$upload(e.id).find('input[name="date"]').val(e.get("date"))},onNameChange:function(e,t,o){o&&"user"!==o.source&&this.$upload(e.id).find('input[name="name"]').val(e.get("name"))},onProgressChange:function(e){var t=this.$upload(e.id);t.toggleClass("is-reuploadable",e.isReuploadable()).find(".progress-bar").prop("className","progress-bar progress-bar-"+e.getStatusClassName()).css("width",e.getProgress()+"%").text(e.getMessage())},onUploadStart:function(e,t){this.promised(t)}})});