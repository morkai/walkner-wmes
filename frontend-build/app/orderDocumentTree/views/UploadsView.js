define(["underscore","jquery","form2js","app/i18n","app/user","app/viewport","app/core/View","app/orderDocumentTree/util/pasteDateEvents","app/orderDocumentTree/templates/uploads","app/orderDocumentTree/templates/upload"],function(e,t,s,o,i,a,n,r,d,l){"use strict";return n.extend({template:d,events:e.assign({'click button[data-action="remove"]':function(e){var t=this.model.uploads.get(this.$upload(e.target).attr("data-id"));t&&this.model.uploads.remove(t)},"change .orderDocumentTree-uploads-field":function(e){var t=this.model.uploads.get(this.$upload(e.target).attr("data-id"));t&&t.set(e.target.name,e.target.value,{source:"user"})},"click #-setDate":function(){this.model.uploads.setDate(this.$id("date").val())},"click .orderDocumentTree-uploads-nc15[readonly]":function(e){var t=this.model.files.get(e.currentTarget.value);if(t){var s=this.$upload(e.target)[0].dataset.id,o=this.model.uploads.get(s);t.trigger("focus",t,o.get("hash"))}},submit:function(e){e.preventDefault();var t=this.$id("setDate").prop("disabled",!0),s=this.$id("submit").prop("disabled",!0),o=this.model.addFiles();a.msg.saving(),o.fail(function(){a.msg.savingFailed()}),o.done(function(){a.msg.saved()}),o.always(function(){t.prop("disabled",!1),s.prop("disabled",!1)})}},r),initialize:function(){var e=this.model,s=this.onDrag.bind(this);this.uploadIndex=this.model.uploads.length,this.listenTo(e.uploads,"add",this.onAdd),this.listenTo(e.uploads,"remove",this.onRemove),this.listenTo(e.uploads,"focus",this.onFocus),this.listenTo(e.uploads,"upload:start",this.onUploadStart),this.listenTo(e.uploads,"change:date",this.onDateChange),this.listenTo(e.uploads,"change:name",this.onNameChange),this.listenTo(e.uploads,"change:error change:progress",this.onProgressChange),t(document).on("dragenter."+this.idPrefix,s).on("dragleave."+this.idPrefix,s).on("dragover."+this.idPrefix,s).on("drop."+this.idPrefix,this.onDrop.bind(this))},destroy:function(){t(document).off("."+this.idPrefix),this.model.uploads.stopUploading()},serialize:function(){return e.assign(n.prototype.serialize.apply(this,arguments),{uploads:this.model.uploads.invoke("serializeDetails"),renderUpload:l})},$upload:function(e){return"string"==typeof e?this.$('.orderDocumentTree-uploads-upload[data-id="'+e+'"]'):this.$(e).closest(".orderDocumentTree-uploads-upload")},onDrag:function(e){e.preventDefault(),e.stopPropagation()},onDrop:function(e){if((e=e.originalEvent).dataTransfer.files.length)if(e.preventDefault(),e.stopPropagation(),i.isAllowedTo("DOCUMENTS:MANAGE")){var t=this.model,s=t.getSelectedFolder();if(s)if(t.isInTrash(s))a.msg.show({type:"warning",time:3e3,text:o("orderDocumentTree","uploads:msg:folderIsTrash")});else{var n=t.uploads,r=e.dataTransfer.files;n.remove(n.filter(function(e){return e.isError()}),{animate:!1});for(var d=0;d<r.length;++d)n.addFromFile(r[d],s)}else a.msg.show({type:"warning",time:3e3,text:o("orderDocumentTree","uploads:msg:noFolder")})}else a.msg.show({type:"warning",time:3e3,text:o("orderDocumentTree","uploads:msg:notAllowed")})},onAdd:function(e){this.$id("uploads").append(l({upload:e.serializeDetails(),i:this.uploadIndex++})),this.model.uploads.startUploading(this.promised.bind(this)),clearTimeout(this.timers.fillNames),this.timers.fillNames=setTimeout(this.fillNames.bind(this),1),this.onFocus(e)},fillNames:function(){this.promised(this.model.uploads.fillNames())},onRemove:function(e,s,o){o&&!1===o.animate?this.$upload(e.id).remove():this.$upload(e.id).fadeOut("fast",function(){t(this).remove()})},onFocus:function(e){this.$upload(e.id).find('input[name="date"]').focus()},onDateChange:function(e,t,s){s&&"user"!==s.source&&this.$upload(e.id).find('input[name="date"]').val(e.get("date"))},onNameChange:function(e,t,s){s&&"user"!==s.source&&this.$upload(e.id).find('input[name="name"]').val(e.get("name"))},onProgressChange:function(e){this.$upload(e.id).toggleClass("is-reuploadable",e.isReuploadable()).find(".progress-bar").prop("className","progress-bar progress-bar-"+e.getStatusClassName()).css("width",e.getProgress()+"%").text(e.getMessage())},onUploadStart:function(e,t){this.promised(t)}})});