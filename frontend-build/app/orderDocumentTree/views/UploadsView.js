define(["underscore","jquery","form2js","app/i18n","app/user","app/viewport","app/core/View","app/core/util/padString","../util/pasteDateEvents","app/orderDocumentTree/templates/uploads","app/orderDocumentTree/templates/upload"],function(e,t,s,o,i,a,n,r,d,l,u){"use strict";return n.extend({template:l,events:e.assign({'click button[data-action="remove"]':function(e){var t=this.model.uploads.get(this.$upload(e.target).attr("data-id"));t&&this.model.uploads.remove(t)},"change .orderDocumentTree-uploads-field":function(e){var t=this.model.uploads.get(this.$upload(e.target).attr("data-id")),s=e.target.name,o=e.target.value;"nc15"===s&&/^[0-9]{1,12}$/.test(o)&&(o=e.target.value=r.start(o,15,"0")),"nc15"===s&&"INVALID_DYNAMIC_NC15"===t.get("error")&&t.set("error",null),t&&t.set(s,o,{source:"user"})},'input input[name="nc15"]':function(e){var t=this.model.uploads.get(this.$upload(e.target).attr("data-id"));t&&"INVALID_DYNAMIC_NC15"===t.get("error")&&t.set("error",null)},"click #-setDate":function(){this.model.uploads.setDate(this.$id("date").val())},"click #-clear":function(){this.model.uploads.reset()},'click input[name="nc15"][readonly]':function(e){var t=this.model.files.get(e.currentTarget.value);if(t){var s=this.$upload(e.target)[0].dataset.id,o=this.model.uploads.get(s);t.trigger("focus",t,o.get("hash"))}},submit:function(e){e.preventDefault();var t=this,s=t.$id("setDate").prop("disabled",!0),o=t.$id("submit").prop("disabled",!0),i=t.model.addFiles();a.msg.saving(),i.fail(function(){var e=i.responseJSON&&i.responseJSON.error||{};"INVALID_NC15"===e.code?(a.msg.saved(),e.invalidIds.forEach(function(e){var s=t.model.uploads.findWhere({nc15:e});s&&s.set("error","INVALID_DYNAMIC_NC15")})):a.msg.savingFailed()}),i.done(function(){a.msg.saved()}),i.always(function(){s.prop("disabled",!1),o.prop("disabled",!1)})}},d),initialize:function(){var e=this.model,s=this.onDrag.bind(this);this.uploadIndex=this.model.uploads.length,this.listenTo(e.uploads,"reset",this.onReset),this.listenTo(e.uploads,"add",this.onAdd),this.listenTo(e.uploads,"remove",this.onRemove),this.listenTo(e.uploads,"focus",this.onFocus),this.listenTo(e.uploads,"upload:start",this.onUploadStart),this.listenTo(e.uploads,"change:nc15",this.onPropChange.bind(this,"nc15")),this.listenTo(e.uploads,"change:date",this.onPropChange.bind(this,"date")),this.listenTo(e.uploads,"change:name",this.onPropChange.bind(this,"name")),this.listenTo(e.uploads,"change:error change:progress",this.onProgressChange),t(document).on("dragenter."+this.idPrefix,s).on("dragleave."+this.idPrefix,s).on("dragover."+this.idPrefix,s).on("drop."+this.idPrefix,this.onDrop.bind(this))},destroy:function(){t(document).off("."+this.idPrefix),this.model.uploads.stopUploading()},getTemplateData:function(){return{uploads:this.model.uploads.invoke("serializeDetails"),renderUpload:this.renderPartialHtml.bind(u)}},$upload:function(e){return"string"==typeof e?this.$('.orderDocumentTree-uploads-upload[data-id="'+e+'"]'):this.$(e).closest(".orderDocumentTree-uploads-upload")},onDrag:function(e){e.preventDefault(),e.stopPropagation()},onDrop:function(e){if((e=e.originalEvent).dataTransfer.files.length)if(e.preventDefault(),e.stopPropagation(),i.isAllowedTo("DOCUMENTS:MANAGE")){var t=this.model,s=t.getSelectedFolder();if(s)if(t.isInTrash(s))a.msg.show({type:"warning",time:3e3,text:this.t("uploads:msg:folderIsTrash")});else{var o=t.uploads,n=e.dataTransfer.files;o.remove(o.filter(function(e){return e.isError()}),{animate:!1});for(var r=0;r<n.length;++r)o.addFromFile(n[r],s)}else a.msg.show({type:"warning",time:3e3,text:this.t("uploads:msg:noFolder")})}else a.msg.show({type:"warning",time:3e3,text:this.t("uploads:msg:notAllowed")})},onReset:function(){var e=this;e.model.uploads.stopUploading(),e.$id("uploads").html(""),e.model.uploads.forEach(function(t){e.addUpload(t)})},onAdd:function(e){this.$id("uploads").append(this.renderPartialHtml(u,{upload:e.serializeDetails(),i:this.uploadIndex++})),this.model.uploads.startUploading(this.promised.bind(this)),clearTimeout(this.timers.fillNames),this.timers.fillNames=setTimeout(this.fillNames.bind(this),1),this.onFocus(e)},fillNames:function(){this.promised(this.model.uploads.fillNames())},onRemove:function(e,s,o){o&&!1===o.animate?this.$upload(e.id).remove():this.$upload(e.id).fadeOut("fast",function(){t(this).remove()})},onFocus:function(e){this.$upload(e.id).find('input[name="date"]').focus()},onPropChange:function(e,t,s,o){o&&"user"!==o.source&&this.$upload(t.id).find('input[name="'+e+'"]').val(t.get(e)).trigger("change")},onProgressChange:function(e){this.$upload(e.id).toggleClass("is-reuploadable",e.isReuploadable()).find(".progress-bar").prop("className","progress-bar progress-bar-"+e.getStatusClassName()).css("width",e.getProgress()+"%").text(e.getMessage())},onUploadStart:function(e,t){this.promised(t)}})});