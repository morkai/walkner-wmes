// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/core/util/uuid","app/orderDocumentTree/OrderDocumentFolder","app/orderDocumentTree/templates/folders","app/orderDocumentTree/templates/folder","app/orderDocumentTree/templates/foldersContextMenu"],function(e,o,r,t,d,l,n,i,s,a,c){"use strict";return l.extend({template:s,events:{"click .orderDocumentTree-folders-toggle":function(e){return this.model.toggleFolder(this.$(e.target).closest(".orderDocumentTree-folders-folder")[0].dataset.folderId),!1},"dblclick .orderDocumentTree-folders-toggle":function(){return!1},"click .orderDocumentTree-folders-item":function(e){var o=this.$(e.target).closest(".orderDocumentTree-folders-folder");o.hasClass("is-editing")||this.model.setSelectedFolder(o[0].dataset.folderId)},"dblclick .orderDocumentTree-folders-item":function(e){this.model.toggleFolder(this.$(e.target).closest(".orderDocumentTree-folders-folder")[0].dataset.folderId)},contextmenu:function(e){var o=this.$(e.target),r=this.$(e.target).closest(".orderDocumentTree-folders-folder");if(r.hasClass("is-editing"))return!1;var t=o.hasClass("orderDocumentTree-folders-label")||o.parent().hasClass("orderDocumentTree-folders-label"),d=r.hasClass("is-selected"),l=r.length&&(t||d)?r[0].dataset.folderId:null;return l&&this.model.setSelectedFolder(l),this.showContextMenu(l,e.clientX,e.clientY),!1}},initialize:function(){var e=this,r=e.model;e.renderFolder=e.renderFolder.bind(e),e.listenTo(r,"change:selectedFolder",this.onSelectedChange),e.listenTo(r,"change:expandedFolders",this.onExpandedChange),e.listenTo(r,"change:cutFolder",this.onCutChange),e.listenTo(r.folders,"add",this.onAdd),e.listenTo(r.folders,"remove",this.onRemove),e.listenTo(r.folders,"change:parent",this.onParentChange),e.listenTo(r.folders,"change:name",this.onNameChange),o(window).on("mousedown."+e.idPrefix,e.hideContextMenu.bind(e)),o("body").on("keydown."+e.idPrefix,function(o){27===o.keyCode&&(e.model.set("cutFolder",null),e.hideContextMenu())})},destroy:function(){o(window).off("."+this.idPrefix),o("body").off("."+this.idPrefix)},serialize:function(){return e.extend(l.prototype.serialize.apply(this,arguments),{rootFolders:this.model.getRootFolders(),renderFolder:this.renderFolder})},renderFolder:function(e,o){var r=this.model;return a({id:e.id,label:e.getLabel(),children:r.getChildFolders(e),expanded:r.isFolderExpanded(e.id),selected:r.isFolderSelected(e.id),cut:r.isFolderCut(e.id),isEditing:o&&o.isEditing,isNew:o&&o.isNew,renderFolder:this.renderFolder})},afterRender:function(){this.scrollIntoView()},$folder:function(e){return this.$('.orderDocumentTree-folders-folder[data-folder-id="'+e+'"]')},$children:function(e){return this.$folder(e).find("> .orderDocumentTree-folders-children")},scrollIntoView:function(){var e=this.$(".is-selected > .orderDocumentTree-folders-item")[0];e&&(e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():e.scrollIntoView())},isContextMenuVisible:function(){var e=this.$id("contextMenu");return 1===e.length&&!e.hasClass("hidden")},showContextMenu:function(e,r,d){var l=this.$id("contextMenu");l.length||(l=o("<div></div>").attr("id",this.idPrefix+"-contextMenu").addClass("orderDocumentTree-contextMenu hidden").appendTo(document.body).on("mousedown",function(e){e.stopPropagation()}).on("click",".orderDocumentTree-contextMenu-item",this.onContextMenuItemClick.bind(this)));var n=this.model,i=n.folders.get(e)||null,s=n.folders.get(this.model.get("cutFolder"))||null;l.html(c({canManage:t.isAllowedTo("DOCUMENTS:MANAGE"),isTrash:i&&"__TRASH__"===i.id,isInTrash:i&&"__TRASH__"===n.getRoot(i).id,isRecoverable:i&&i.isInTrash(),sourceFolder:i?{id:i.id,label:i.getLabel(),expanded:n.isFolderExpanded(i.id)}:null,cutFolder:s&&n.canMoveFolder(s,i)?{id:s.id,label:s.getLabel()}:null})),l.css({top:"-1000px",left:r+"px"}),l.removeClass("hidden");var a=l.outerHeight();d+a+15>window.innerHeight&&(d-=a),l.css("top",d+"px")},hideContextMenu:function(){this.$id("contextMenu").addClass("hidden")},toggleChildren:function(e){var o=this.$folder(e);if(o.length){var r=this.$children(e);o.removeClass("has-no-children has-children").addClass(r.children().length?"has-children":"has-no-children")}},$lastNonTrashFolder:function(){var e=this.$id("root").children().last();return"__TRASH__"===e.attr("data-folder-id")?e.prev():e},onSelectedChange:function(e,o,r){var t=this,d=t.model.getSelectedFolder();t.$(".is-selected").removeClass("is-selected"),d&&(t.$folder(d.id).addClass("is-selected"),r&&r.scroll&&(t.model.getPath().forEach(function(e){t.model.toggleFolder(e.id,!0)}),t.scrollIntoView()))},onExpandedChange:function(e,o){null===e?this.$(".orderDocumentTree-folders-folder").toggleClass("is-expanded",o):this.$folder(e).toggleClass("is-expanded",o)},onCutChange:function(){this.$(".is-cut").removeClass("is-cut");var e=this.model.get("cutFolder");e&&this.$folder(e).addClass("is-cut")},onAdd:function(e){if(!this.$folder(e.id).length){var r=o(this.renderFolder(e));if(e.isRoot()){var t=this.$lastNonTrashFolder();t.length?r.insertAfter(t):this.$id("root").prepend(r)}else this.$children(e.get("parent")).append(r),this.toggleChildren(e.get("parent"))}},onRemove:function(e){this.$folder(e.id).remove(),this.toggleChildren(e.get("parent"))},onParentChange:function(e,o,r){var t=this.model,d=this.$folder(e.id).detach();if(t.isInTrash(e)&&!t.canSeeTrash())return d.remove(),this.toggleChildren(e.get("parent")),void(r.oldParentId&&this.toggleChildren(r.oldParentId));if(e.isRoot()){var l=this.$lastNonTrashFolder();l.length?d.insertAfter(l):this.$id("root").prepend(d)}else this.$children(e.get("parent")).append(d),this.toggleChildren(e.get("parent"));r.oldParentId&&this.toggleChildren(r.oldParentId),e===t.getSelectedFolder()&&this.onSelectedChange(t,e.id,{scroll:!0})},onNameChange:function(e){var o=this.$folder(e.id);o.length&&o.find("> .orderDocumentTree-folders-item > .orderDocumentTree-folders-label > span").text(e.getLabel())},onContextMenuItemClick:function(e){this.hideContextMenu();var o=this.model,r=e.currentTarget.dataset;switch(r.action){case"expandFolder":o.toggleFolder(r.folderId,!0);break;case"collapseFolder":o.toggleFolder(r.folderId,!1);break;case"expandFolders":this.handleToggleFolders(r.folderId,!0);break;case"collapseFolders":this.handleToggleFolders(r.folderId,!1);break;case"newFolder":this.handleNewFolder(r.folderId);break;case"cutFolder":o.set("cutFolder",r.folderId);break;case"moveFolder":this.handleMoveFolder(r.fromFolderId,r.toFolderId);break;case"removeFolder":this.handleRemoveFolder(r.folderId);break;case"renameFolder":this.handleRenameFolder(r.folderId);break;case"recoverFolder":this.handleRecoverFolder(r.folderId)}},handleToggleFolders:function(e,o){var r=this.model;if(!e)return void r.toggleFolder(null,o);var t=this.$folder(e);r.toggleFolder(e,o),t.find(".has-children").each(function(){r.toggleFolder(this.dataset.folderId,o)})},handleNewFolder:function(e){function t(){h.remove()}function l(){var e=f.val().trim();t(),e.length&&(c.set("name",e),s.addFolder(c).fail(function(){d.msg.show({type:"error",time:3e3,text:r("orderDocumentTree","folders:msg:addFolder:failure")})}))}var s=this.model,a=this.$folder(e),c=new i({_id:n(),name:"",parent:e,children:[],oldParent:null}),h=o(this.renderFolder(c,{isEditing:!0,isNew:!0}));a.length?(a.removeClass("has-no-children").addClass("has-children").children(".orderDocumentTree-folders-children").append(h),this.model.toggleFolder(e,!0)):this.$id("root").append(h);var f=h.find(".orderDocumentTree-folders-editor");f.select().on("blur",l).on("keyup",function(e){return 27===e.keyCode?t():13===e.keyCode?l():void 0}),f[0].scrollIntoViewIfNeeded?f[0].scrollIntoViewIfNeeded():f[0].scrollIntoView()},handleMoveFolder:function(e,o){var t=this.model,l=t.folders.get(e),n=t.folders.get(o)||null;t.moveFolder(l,n).fail(function(){d.msg.show({type:"error",time:3e3,text:r("orderDocumentTree","folders:msg:moveFolder:failure")})})},handleRemoveFolder:function(e){var o=this.$folder(e).addClass("is-removed");this.model.removeFolder(this.model.folders.get(e)).fail(function(){d.msg.show({type:"error",time:3e3,text:r("orderDocumentTree","folders:msg:removeFolder:failure")})}).always(function(){o.removeClass("is-removed")})},handleRecoverFolder:function(e){var o=this.model;o.recoverFolder(o.folders.get(e)).fail(function(){d.msg.show({type:"error",time:3e3,text:r("orderDocumentTree","folders:msg:recoverFolder:failure")})})},handleRenameFolder:function(e){function t(){c.replaceWith(n.renderFolder(s))}function l(){t();var e=h.val().trim();e.length&&i.renameFolder(s,e).fail(function(){d.msg.show({type:"error",time:3e3,text:r("orderDocumentTree","folders:msg:renameFolder:failure")})})}var n=this,i=n.model,s=i.folders.get(e),a=n.$folder(e),c=o(n.renderFolder(s,{isEditing:!0,isNew:!1}));a.replaceWith(c);var h=c.find(".orderDocumentTree-folders-editor");h.select().on("blur",l).on("keyup",function(e){return 27===e.keyCode?t():13===e.keyCode?l():void 0})}})});