define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/core/views/DialogView","app/core/util/uuid","app/orderDocumentTree/OrderDocumentFolder","app/orderDocumentTree/templates/folders","app/orderDocumentTree/templates/folder","app/orderDocumentTree/templates/foldersContextMenu","app/orderDocumentTree/templates/purgeFolderDialog"],function(e,r,o,t,d,l,n,i,s,a,c,h,u){"use strict";return l.extend({template:a,events:{"click .orderDocumentTree-folders-toggle":function(e){return this.model.toggleFolder(this.$(e.target).closest(".orderDocumentTree-folders-folder")[0].dataset.folderId),!1},"dblclick .orderDocumentTree-folders-toggle":function(){return!1},"click .orderDocumentTree-folders-item":function(e){var r=this.$(e.target).closest(".orderDocumentTree-folders-folder");if(!r.hasClass("is-editing")){var o=r[0].dataset.folderId;e.ctrlKey?window.open("/#orderDocuments/tree?folder="+o):this.model.setSelectedFolder(o)}},"dblclick .orderDocumentTree-folders-item":function(e){this.model.toggleFolder(this.$(e.target).closest(".orderDocumentTree-folders-folder")[0].dataset.folderId)},contextmenu:function(e){var r=this.$(e.target),o=this.$(e.target).closest(".orderDocumentTree-folders-folder");if(o.hasClass("is-editing"))return!1;var t=r.hasClass("orderDocumentTree-folders-label")||r.parent().hasClass("orderDocumentTree-folders-label"),d=o.hasClass("is-selected"),l=o.length&&(t||d)?o[0].dataset.folderId:null;return l&&this.model.setSelectedFolder(l),this.showContextMenu(l,e.clientX,e.clientY),!1}},initialize:function(){var e=this,o=e.model;e.renderFolder=e.renderFolder.bind(e),e.listenTo(o,"change:selectedFolder",this.onSelectedChange),e.listenTo(o,"change:expandedFolders",this.onExpandedChange),e.listenTo(o,"change:cutFolder",this.onCutChange),e.listenTo(o.folders,"add",this.onAdd),e.listenTo(o.folders,"remove",this.onRemove),e.listenTo(o.folders,"change:parent",this.onParentChange),e.listenTo(o.folders,"change:name",this.onNameChange),r(window).on("mousedown."+e.idPrefix,e.hideContextMenu.bind(e)),r("body").on("keydown."+e.idPrefix,function(r){27===r.keyCode&&(e.model.set("cutFolder",null),e.hideContextMenu())})},destroy:function(){r(window).off("."+this.idPrefix),r("body").off("."+this.idPrefix)},serialize:function(){return e.assign(l.prototype.serialize.apply(this,arguments),{rootFolders:this.model.getRootFolders(),renderFolder:this.renderFolder})},renderFolder:function(e,r){var o=this.model;return c({id:e.id,label:e.getLabel(),children:o.getChildFolders(e),expanded:o.isFolderExpanded(e.id),selected:o.isFolderSelected(e.id),cut:o.isFolderCut(e.id),isEditing:r&&r.isEditing,isNew:r&&r.isNew,renderFolder:this.renderFolder})},afterRender:function(){this.scrollIntoView()},$folder:function(e){return this.$('.orderDocumentTree-folders-folder[data-folder-id="'+e+'"]')},$children:function(e){return this.$folder(e).find("> .orderDocumentTree-folders-children")},scrollIntoView:function(){var e=this.$(".is-selected > .orderDocumentTree-folders-item")[0];e&&(e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():e.scrollIntoView())},isContextMenuVisible:function(){var e=this.$id("contextMenu");return 1===e.length&&!e.hasClass("hidden")},showContextMenu:function(e,o,d){var l=this.$id("contextMenu");l.length||(l=r("<div></div>").attr("id",this.idPrefix+"-contextMenu").addClass("orderDocumentTree-contextMenu hidden").appendTo(document.body).on("mousedown",function(e){e.stopPropagation()}).on("click",".orderDocumentTree-contextMenu-item",this.onContextMenuItemClick.bind(this)));var n=this.model,i=n.folders.get(e)||null,s=n.folders.get(this.model.get("cutFolder"))||null;l.html(h({canManage:t.isAllowedTo("DOCUMENTS:MANAGE"),isTrash:i&&"__TRASH__"===i.id,isInTrash:i&&"__TRASH__"===n.getRoot(i).id,isRecoverable:i&&i.isInTrash(),sourceFolder:i?{id:i.id,label:i.getLabel(),expanded:n.isFolderExpanded(i.id)}:null,cutFolder:s&&n.canMoveFolder(s,i)?{id:s.id,label:s.getLabel()}:null})),l.css({top:"-1000px",left:o+"px"}),l.removeClass("hidden");var a=l.outerHeight();d+a+15>window.innerHeight&&(d-=a),l.css("top",d+"px")},hideContextMenu:function(){this.$id("contextMenu").addClass("hidden")},toggleChildren:function(e){var r=this.$folder(e);if(r.length){var o=this.$children(e);r.removeClass("has-no-children has-children").addClass(o.children().length?"has-children":"has-no-children")}},$lastNonTrashFolder:function(){var e=this.$id("root").children().last();return"__TRASH__"===e.attr("data-folder-id")?e.prev():e},onSelectedChange:function(e,r,o){var t=this,d=t.model.getSelectedFolder();t.$(".is-selected").removeClass("is-selected"),d&&(t.$folder(d.id).addClass("is-selected"),o&&o.scroll&&(t.model.getPath().forEach(function(e){t.model.toggleFolder(e.id,!0)}),t.scrollIntoView()))},onExpandedChange:function(e,r){null===e?this.$(".orderDocumentTree-folders-folder").toggleClass("is-expanded",r):this.$folder(e).toggleClass("is-expanded",r)},onCutChange:function(){this.$(".is-cut").removeClass("is-cut");var e=this.model.get("cutFolder");e&&this.$folder(e).addClass("is-cut")},onAdd:function(e){if(!this.$folder(e.id).length){var o=r(this.renderFolder(e));if(e.isRoot()){var t=this.$lastNonTrashFolder();t.length?o.insertAfter(t):this.$id("root").prepend(o)}else this.$children(e.get("parent")).append(o),this.toggleChildren(e.get("parent"))}},onRemove:function(e){this.$folder(e.id).remove(),this.toggleChildren(e.get("parent"))},onParentChange:function(e,r,o){var t=this.model,d=this.$folder(e.id).detach();if(t.isInTrash(e)&&!t.canSeeTrash())return d.remove(),this.toggleChildren(e.get("parent")),void(o.oldParentId&&this.toggleChildren(o.oldParentId));if(e.isRoot()){var l=this.$lastNonTrashFolder();l.length?d.insertAfter(l):this.$id("root").prepend(d)}else this.$children(e.get("parent")).append(d),this.toggleChildren(e.get("parent"));o.oldParentId&&this.toggleChildren(o.oldParentId),e===t.getSelectedFolder()&&this.onSelectedChange(t,e.id,{scroll:!0})},onNameChange:function(e){var r=this.$folder(e.id);r.length&&r.find("> .orderDocumentTree-folders-item > .orderDocumentTree-folders-label > span").text(e.getLabel())},onContextMenuItemClick:function(e){this.hideContextMenu();var r=this.model,o=e.currentTarget.dataset;switch(o.action){case"expandFolder":r.toggleFolder(o.folderId,!0);break;case"collapseFolder":r.toggleFolder(o.folderId,!1);break;case"expandFolders":this.handleToggleFolders(o.folderId,!0);break;case"collapseFolders":this.handleToggleFolders(o.folderId,!1);break;case"newFolder":this.handleNewFolder(o.folderId);break;case"cutFolder":r.set("cutFolder",o.folderId);break;case"moveFolder":this.handleMoveFolder(o.fromFolderId,o.toFolderId);break;case"removeFolder":this.handleRemoveFolder(o.folderId);break;case"renameFolder":this.handleRenameFolder(o.folderId);break;case"recoverFolder":this.handleRecoverFolder(o.folderId);break;default:console.log(e.currentTarget.dataset)}},handleToggleFolders:function(e,r){var o=this.model;if(e){var t=this.$folder(e);o.toggleFolder(e,r),t.find(".has-children").each(function(){o.toggleFolder(this.dataset.folderId,r)})}else o.toggleFolder(null,r)},handleNewFolder:function(e){var t=this.model,l=this.$folder(e),n=new s({_id:i(),name:"",parent:e,children:[],oldParent:null}),a=r(this.renderFolder(n,{isEditing:!0,isNew:!0}));l.length?(l.removeClass("has-no-children").addClass("has-children").children(".orderDocumentTree-folders-children").append(a),this.model.toggleFolder(e,!0)):this.$id("root").append(a);var c=a.find(".orderDocumentTree-folders-editor");function h(){a.remove()}function u(){var e=c.val().trim();h(),e.length&&(n.set("name",e),t.addFolder(n).fail(function(){d.msg.show({type:"error",time:3e3,text:o("orderDocumentTree","folders:msg:addFolder:failure")})}))}c.select().on("blur",u).on("keyup",function(e){return 27===e.keyCode?h():13===e.keyCode?u():void 0}),c[0].scrollIntoViewIfNeeded?c[0].scrollIntoViewIfNeeded():c[0].scrollIntoView()},handleMoveFolder:function(e,r){var t=this.model,l=t.folders.get(e),n=t.folders.get(r)||null;t.moveFolder(l,n).fail(function(){d.msg.show({type:"error",time:3e3,text:o("orderDocumentTree","folders:msg:moveFolder:failure")})})},handleRemoveFolder:function(e){var r=this.model,t=r.folders.get(e);if(t)if(r.isInTrash(t))this.handlePurgeFolder(t);else{var l=this.$folder(t.id).addClass("is-removed");this.model.removeFolder(t).fail(function(){d.msg.show({type:"error",time:3e3,text:o("orderDocumentTree","folders:msg:removeFolder:failure")})}).always(function(){l.removeClass("is-removed")})}},handlePurgeFolder:function(e){var r=this.model,t="__TRASH__"===e.id,l=new n({template:u,autoHide:!1,model:{isTrash:t,label:e.getLabel()}});this.listenTo(l,"answered",function(){var n=r.purgeFolder(e);n.fail(function(){l.enableAnswers(),d.msg.show({type:"error",time:3e3,text:o("orderDocumentTree","purgeFolder:msg:failure"+(t?":trash":""))})}),n.done(function(){l.closeDialog(),d.msg.show({type:"success",time:2e3,text:o("orderDocumentTree","purgeFolder:msg:success"+(t?":trash":""))})})}),d.showDialog(l,o("orderDocumentTree","purgeFolder:title"+(t?":trash":"")))},handleRecoverFolder:function(e){var r=this.model;r.recoverFolder(r.folders.get(e)).fail(function(){d.msg.show({type:"error",time:3e3,text:o("orderDocumentTree","folders:msg:recoverFolder:failure")})})},handleRenameFolder:function(e){var t=this,l=t.model,n=l.folders.get(e),i=t.$folder(e),s=r(t.renderFolder(n,{isEditing:!0,isNew:!1}));i.replaceWith(s);var a=s.find(".orderDocumentTree-folders-editor");function c(){s.replaceWith(t.renderFolder(n))}function h(){c();var e=a.val().trim();e.length&&l.renameFolder(n,e).fail(function(){d.msg.show({type:"error",time:3e3,text:o("orderDocumentTree","folders:msg:renameFolder:failure")})})}a.select().on("blur",h).on("keyup",function(e){return 27===e.keyCode?c():13===e.keyCode?h():void 0})}})});