// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/core/util/fixTimeRange","app/core/views/FilterView","app/users/util/setUpUserSelect2","app/events/templates/filter"],function(e,t,i,r){return t.extend({template:r,defaultFormData:function(){return{type:"",user:"",severity:[]}},termToForm:{time:function(t,i,r){e.toFormData(r,i,"date+time")},type:function(e,t,i){i.type=t.args[1]},"user._id":function(e,t,i){i.user=null===t.args[1]?"$SYSTEM":t.args[1]},severity:function(e,t,i){i.severity="eq"===t.name?[t.args[1]]:t.args[1]}},afterRender:function(){t.prototype.afterRender.call(this),this.toggleSeverity(this.formData.severity),this.$id("type").select2({width:300,allowClear:!0,data:this.model.eventTypes.map(function(e){return e.toSelect2Option()})}),i(this.$id("user"),{width:300})},serializeFormToQuery:function(t){var i=e.fromView(this),r=this.$id("type").val().trim(),a=this.$id("user").select2("data"),s=this.fixSeverity();""!==r&&t.push({name:"eq",args:["type",r]}),a&&t.push({name:"eq",args:["user._id","$SYSTEM"===a.id?null:a.id]}),i.from&&t.push({name:"ge",args:["time",i.from]}),i.to&&t.push({name:"le",args:["time",i.to]}),1===s.length?t.push({name:"eq",args:["severity",s[0]]}):s.length>1&&t.push({name:"in",args:["severity",s]})},fixSeverity:function(){var e=this.$id("severity").find(".btn"),t=e.filter(".active");0===t.length&&e.addClass("active");var i=t.map(function(){return this.value}).get();return i.length===e.length?[]:i},toggleSeverity:function(e){var t=this.$id("severity").find(".btn");0===e.length?t.addClass("active"):e.forEach(function(e){t.filter("[value="+e+"]").addClass("active")})}})});