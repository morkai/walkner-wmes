define(["underscore","moment","js2form","reltime","app/i18n","app/core/View","app/core/util/fixTimeRange","app/events/templates/filter","select2"],function(e,t,i,r,s,n,a,l){return n.extend({template:l,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("eventFilter")},serialize:function(){return{idPrefix:this.idPrefix,types:this.model.eventTypes.toJSON()}},afterRender:function(){var e=this.serializeRqlQuery();i(this.el.querySelector(".filter-form"),e),this.toggleSeverity(e.severity),this.$id("type").select2({width:"resolve",allowClear:!0}),this.$id("user").select2({width:"200px",allowClear:!0,minimumInputLength:3,ajax:{cache:!0,quietMillis:500,url:function(e){return e=encodeURIComponent(e),"/users?select(login)&sort(login)&limit(20)&regex(login,string:"+e+")"},results:function(e,t){var i=[{id:"$SYSTEM",text:s("events","FILTER_USER_SYSTEM")},{id:"root",text:"root"}].filter(function(e){return-1!==e.text.indexOf(t.term)});return{results:i.concat((e.collection||[]).map(function(e){return{id:e.login,text:e.login}}))}}}})},serializeRqlQuery:function(){var e=this.model.rqlQuery,t={type:"",user:"",limit:e.limit<5?5:e.limit>100?100:e.limit,severity:[]};return e.selector.args.forEach(function(e){var i=e.args[0];switch(i){case"time":a.toFormData(t,e,"date+time");break;case"type":t.type=e.args[1];break;case"user":t.user=null===e.args[1]?"$SYSTEM":e.args[1];break;case"severity":t.severity="eq"===e.name?[e.args[1]]:e.args[1]}}),t},changeFilter:function(){var e=this.model.rqlQuery,t=a.fromView(this),i=[],r=this.$id("type").val().trim(),s=this.$id("user").val().trim(),n=this.fixSeverity();""!==r&&i.push({name:"eq",args:["type",r]}),"$SYSTEM"===s?i.push({name:"eq",args:["user",null]}):""!==s&&i.push({name:"eq",args:["user.login",s]}),t.from&&i.push({name:"ge",args:["time",t.from]}),t.to&&i.push({name:"le",args:["time",t.to]}),1===n.length?i.push({name:"eq",args:["severity",n[0]]}):n.length>1&&i.push({name:"in",args:["severity",n]}),e.selector={name:"and",args:i},e.limit=parseInt(this.$id("limit").val(),10),e.skip=0,this.trigger("filterChanged",e)},fixSeverity:function(){var e=this.$(".events-filter-form-severity"),t=e.filter(".active");0===t.length&&e.addClass("active");var i=t.map(function(){return this.value}).get();return i.length===e.length?[]:i},toggleSeverity:function(e){var t=this.$(".events-filter-form-severity");0===e.length?t.addClass("active"):e.forEach(function(e){t.filter('[title="'+e.toUpperCase()+'"]').addClass("active")})}})});