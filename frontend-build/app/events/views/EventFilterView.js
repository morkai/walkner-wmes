define(["underscore","moment","js2form","reltime","app/i18n","app/core/View","app/core/util/fixTimeRange","app/events/templates/filter","i18n!app/nls/events","select2"],function(e,t,i,n,r,o,s,a){return o.extend({template:a,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("eventFilter")},serialize:function(){return{idPrefix:this.idPrefix,types:this.model.eventTypes.toJSON()}},afterRender:function(){var e=this.serializeRqlQuery();i(this.el.querySelector(".filter-form"),e),this.toggleSeverity(e.severity),this.$id("type").select2({width:"resolve",allowClear:!0}),this.$id("user").select2({width:"200px",allowClear:!0,minimumInputLength:3,ajax:{cache:!0,quietMillis:500,url:function(e){return e=encodeURIComponent(e),"/users?select(login)&sort(login)&limit(20)&regex(login,string:"+e+")"},results:function(e,t){var i=[{id:"$SYSTEM",text:r("events","FILTER_USER_SYSTEM")},{id:"root",text:"root"}].filter(function(e){return-1!==e.text.indexOf(t.term)});return{results:i.concat((e.collection||[]).map(function(e){return{id:e.login,text:e.login}}))}}}})},serializeRqlQuery:function(){var e=this.model.rqlQuery,i={type:"",user:"",limit:e.limit<5?5:e.limit>100?100:e.limit,severity:[]};return e.selector.args.forEach(function(e){var n=e.args[0];switch(n){case"time":i["ge"===e.name?"from":"to"]=t(e.args[1]).format("YYYY-MM-DD HH:mm:ss");break;case"type":i.type=e.args[1];break;case"user":i.user=null===e.args[1]?"$SYSTEM":e.args[1];break;case"severity":i.severity="eq"===e.name?[e.args[1]]:e.args[1]}}),i},changeFilter:function(){var e=this.model.rqlQuery,t=s(this.$id("from"),this.$id("to"),"YYYY-MM-DD HH:mm:ss"),i=[],n=this.$id("type").val().trim(),r=this.$id("user").val().trim(),o=this.fixSeverity();""!==n&&i.push({name:"eq",args:["type",n]}),"$SYSTEM"===r?i.push({name:"eq",args:["user",null]}):""!==r&&i.push({name:"eq",args:["user.login",r]}),-1!==t.from&&i.push({name:"ge",args:["time",t.from]}),-1!==t.to&&i.push({name:"le",args:["time",t.to]}),1===o.length?i.push({name:"eq",args:["severity",o[0]]}):o.length>1&&i.push({name:"in",args:["severity",o]}),e.selector={name:"and",args:i},e.limit=parseInt(this.$id("limit").val(),10),e.skip=0,this.trigger("filterChanged",e)},fixSeverity:function(){var e=this.$(".events-filter-form-severity"),t=e.filter(".active");0===t.length&&e.addClass("active");var i=t.map(function(){return this.value}).get();return i.length===e.length?[]:i},toggleSeverity:function(e){var t=this.$(".events-filter-form-severity");0===e.length?t.addClass("active"):e.forEach(function(e){t.filter('[title="'+e.toUpperCase()+'"]').addClass("active")})}})});