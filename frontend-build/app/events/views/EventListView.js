define(["underscore","moment","app/i18n","app/data/divisions","app/data/subdivisions","app/data/views/renderOrgUnitPath","app/core/views/ListView","app/events/templates/list","i18n!app/nls/events"],function(e,t,i,n,r,o,s,a){return s.extend({template:a,remoteTopics:{"events.saved":"refreshCollection"},serialize:function(){var e=this;return{events:this.collection.map(function(n){var r=n.get("type"),o=e.prepareData(r,n.get("data"));return{severity:n.getSeverityClassName(),time:t(n.get("time")).format("lll"),user:n.get("user"),type:i("events","TYPE:"+r),text:i("events","TEXT:"+r,e.flatten(o))}})}},refreshCollection:function(e,t){return"function"!=typeof this.options.filter||!Array.isArray(e)||e.some(this.options.filter)?s.prototype.refreshCollection.call(this,e,t):void 0},prepareData:function(e,i){if(i.$prepared)return i;switch(i.$prepared=!0,e){case"fte.leader.created":case"fte.leader.locked":case"fte.master.created":case"fte.master.locked":var s=r.get(i.model.subdivision);i.model.subdivision=s?o(s,!1,!1):"?",i.model.date=t(i.model.date).format("YYYY-MM-DD");break;case"hourlyPlans.created":case"hourlyPlans.locked":var a=n.get(i.model.division);i.model.division=a?o(a,!1,!1):"?",i.model.date=t(i.model.date).format("YYYY-MM-DD")}return i},flatten:function(t){var i={};if(null==t)return i;for(var n=Object.keys(t),r=0,o=n.length;o>r;++r){var s=n[r],a=t[s];if(null!==a&&"object"==typeof a)for(var l=this.flatten(a),c=Object.keys(l),u=0,d=c.length;d>u;++u)i[s+"->"+c[u]]=String(l[c[u]]);else i[s]=e.escape(String(a))}return i}})});