define(["underscore","moment","app/i18n","app/data/divisions","app/data/subdivisions","app/data/views/renderOrgUnitPath","app/core/views/ListView","app/events/templates/list","i18n!app/nls/events"],function(e,t,r,a,i,n,s,o){return s.extend({template:o,remoteTopics:{"events.saved":"refreshCollection"},serialize:function(){var e=this;return{events:this.collection.map(function(a){var i=a.get("type"),n=e.prepareData(i,a.get("data"));return{severity:a.getSeverityClassName(),time:t(a.get("time")).format("lll"),user:a.get("user"),type:r("events","TYPE:"+i),text:r("events","TEXT:"+i,e.flatten(n))}})}},refreshCollection:function(e,t){return"function"!=typeof this.options.filter||!Array.isArray(e)||e.some(this.options.filter)?s.prototype.refreshCollection.call(this,e,t):void 0},prepareData:function(e,r){if(r.$prepared)return r;switch(r.$prepared=!0,e){case"fte.leader.created":case"fte.leader.locked":case"fte.master.created":case"fte.master.locked":var s=i.get(r.model.subdivision);r.model.subdivision=s?n(s,!1,!1):"?",r.model.date=t(r.model.date).format("YYYY-MM-DD");break;case"hourlyPlans.created":case"hourlyPlans.locked":var o=a.get(r.model.division);r.model.division=o?n(o,!1,!1):"?",r.model.date=t(r.model.date).format("YYYY-MM-DD")}return r},flatten:function(t){var r={};if(null==t)return r;for(var a=Object.keys(t),i=0,n=a.length;n>i;++i){var s=a[i],o=t[s];if(null!==o&&"object"==typeof o)for(var l=this.flatten(o),d=Object.keys(l),p=0,c=d.length;c>p;++p)r[s+"->"+d[p]]=String(l[d[p]]);else r[s]=e.escape(String(o))}return r}})});