define(["underscore","moment","app/i18n","app/data/divisions","app/data/subdivisions","app/data/views/renderOrgUnitPath","app/core/views/ListView","app/events/templates/list"],function(e,t,r,a,i,s,n,o){return n.extend({template:o,remoteTopics:{"events.saved":"refreshCollection"},serialize:function(){var e=this;return{events:this.collection.map(function(a){var i=a.get("type"),s=e.prepareData(i,a.get("data"));return{severity:a.getSeverityClassName(),time:t(a.get("time")).format("lll"),user:a.get("user"),type:r("events","TYPE:"+i),text:r("events","TEXT:"+i,e.flatten(s))}})}},refreshCollection:function(e,t){return"function"!=typeof this.options.filter||!Array.isArray(e)||e.some(this.options.filter)?n.prototype.refreshCollection.call(this,e,t):void 0},prepareData:function(e,r){if(r.$prepared)return r;switch(r.$prepared=!0,e){case"fte.leader.created":case"fte.leader.locked":case"fte.master.created":case"fte.master.locked":var n=i.get(r.model.subdivision);r.model.subdivision=n?s(n,!1,!1):"?",r.model.date=t(r.model.date).format("YYYY-MM-DD");break;case"hourlyPlans.created":case"hourlyPlans.locked":var o=a.get(r.model.division);r.model.division=o?s(o,!1,!1):"?",r.model.date=t(r.model.date).format("YYYY-MM-DD")}return r},flatten:function(t){var r={};if(null==t)return r;for(var a=Object.keys(t),i=0,s=a.length;s>i;++i){var n=a[i],o=t[n];if(null!==o&&"object"==typeof o)for(var l=this.flatten(o),d=Object.keys(l),c=0,p=d.length;p>c;++c)r[n+"->"+d[c]]=String(l[d[c]]);else r[n]=e.escape(String(o))}return r}})});