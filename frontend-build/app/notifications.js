define(["underscore","jquery","app/broker","app/i18n"],function(e,n,t,i){"use strict";var o=null,r=window.Notification,s=window.SERVICE_WORKER?window.navigator.serviceWorker:null,a={},c={userAction:function(e){a[e.userAction]&&a[e.userAction](e)}};function u(){d({action:"getClientId"},function(e,n){if(e)return/No active/.test(e.message)?setTimeout(l,3e3):setTimeout(u,3e3),console.error("Failed to get the client ID: %s",e.message);o=n.clientId})}function l(){window.navigator.serviceWorker.register(window.SERVICE_WORKER).then(function(){console.log("[sw] Registered!"),setTimeout(u,100)}).catch(function(e){console.error("[sw] Failed to register:",e),setTimeout(l,5e3)})}function d(e,n){var t=setTimeout(i.bind(null,new Error("Timeout.")),e.timeout||1e3);function i(e,i){null!==t&&(clearTimeout(t),t=null,n(e,i))}s.ready.then(function(n){if(!n.active)return"development"===window.ENV&&console.log("[sw] Inactive registration:",n),i(new Error("No active registration!"));var t=new MessageChannel;t.port1.onmessage=function(e){i(e.data.error,e.data.result)},n.active.postMessage(e,[t.port2])})}return r&&s&&(s.addEventListener("message",function(e){var n=e.data&&e.data.action&&e.data.action.split(".")||[];"notifications"===n[0]&&c[n[1]]&&c[n[1]](e.data)}),u()),window.notifications={messageHandlers:c,userActions:a,renderRequest:function(){s&&r&&"granted"!==r.permission&&"denied"!==r.permission&&s.ready.then(function(){var e=n('<div class="message message-inline message-warning notifications-request"></div>').append("<p>"+i("core","notifications:request:message")+"</p>");e.on("click",function(){"default"===r.permission?r.requestPermission().then(function(n){"granted"===n?window.location.reload():"default"!==n&&e.remove()}):e.remove()}),n(".bd").prepend(e)})},show:function(e){return r&&"granted"===r.permission?(e.data||(e.data={}),new Promise(function(n,t){if(!e.scoreClient)return i();function i(){s.ready.then(function(i){if(!i.active)return t(new Error("No active SW."));i.showNotification(e.title,e).then(n,t)}).catch(t)}d({action:"getClients",filter:null},function(r,s){if(r)return t(r);if(!s.length)return i();var a=s.map(function(n){return{clientId:n._id,score:e.scoreClient(n)}});return a.sort(function(e,n){return n.score-e.score}),a[a.length-1].score<0?n(null):a[0].clientId!==o?n(null):(e.data.bestClientId=a[0].clientId,void i())})})):Promise.reject(new Error("Unsupported or disabled."))},close:function(n){if(!s)return Promise.reject(new Error("Unsupported."));s.ready.then(function(e){return e.getNotifications()}).then(function(t){t.forEach(function(t){if(Array.isArray(n)&&n.length){if(t.tag){var i=t.tag.split(" ");e.every(n,function(e){return i.includes(e)})&&t.close()}}else t.close()})}).catch(function(e){console.error("[notifications] Failed to close.",{tags:n,error:e})})}}});