define(["underscore","jquery","app/broker","app/i18n"],function(e,n,t,i){"use strict";var r=null,o=window.Notification,a=window.navigator.serviceWorker,s={},c={userAction:function(e){s[e.userAction]&&s[e.userAction](e)}};function u(e,n){var t=setTimeout(i.bind(null,new Error("Timeout.")),e.timeout||1e3);function i(e,i){null!==t&&(clearTimeout(t),t=null,n(e,i))}a.ready.then(function(n){if(!n.active)return i(new Error("No active registration!"));var t=new MessageChannel;t.port1.onmessage=function(e){i(e.data.error,e.data.result)},n.active.postMessage(e,[t.port2])})}return a&&(a.addEventListener("message",function(e){var n=e.data&&e.data.action&&e.data.action.split(".")||[];"notifications"===n[0]&&c[n[1]]&&c[n[1]](e.data)}),u({action:"getClientId"},function(e,n){e||(r=n.clientId)})),window.notifications={messageHandlers:c,userActions:s,renderRequest:function(){a&&o&&"granted"!==o.permission&&"denied"!==o.permission&&a.ready.then(function(){var e=n('<div class="message message-inline message-warning notifications-request"></div>').append("<p>"+i("core","notifications:request:message")+"</p>");e.on("click",function(){"default"===o.permission?o.requestPermission().then(function(n){"granted"===n?window.location.reload():"default"!==n&&e.remove()}):e.remove()}),n(".bd").prepend(e)})},show:function(e){return o&&"granted"===o.permission?(e.data||(e.data={}),new Promise(function(n,t){if(!e.scoreClient)return i();function i(){a.ready.then(function(i){if(!i.active)return t(new Error("No active SW."));i.showNotification(e.title,e).then(n,t)}).catch(t)}u({action:"getClients",filter:null},function(o,a){if(o)return t(o);if(!a.length)return i();var s=a.map(function(n){return{clientId:n._id,score:e.scoreClient(n)}});return s.sort(function(e,n){return n.score-e.score}),s[s.length-1].score<0?n(null):s[0].clientId!==r?n(null):(e.data.bestClientId=s[0].clientId,void i())})})):Promise.reject(new Error("Unsupported or disabled."))},close:function(e){if(!a)return Promise.reject(new Error("Unsupported."));a.ready.then(function(e){return e.getNotifications()}).then(function(n){n.forEach(function(n){if(!Array.isArray(e)||!e.length)return void n.close();if(!n.tag)return;const t=n.tag.split(" ");e.every(e=>t.includes(e))&&n.close()})}).catch(function(e){})}}});