define(["underscore","jquery","app/broker","app/i18n"],function(e,n,t,i){"use strict";var r=null,o=window.Notification,s=window.SERVICE_WORKER?window.navigator.serviceWorker:null,a={},c={userAction:function(e){a[e.userAction]&&a[e.userAction](e)}};function u(e,n){var t=setTimeout(i.bind(null,new Error("Timeout.")),e.timeout||1e3);function i(e,i){null!==t&&(clearTimeout(t),t=null,n(e,i))}s.ready.then(function(n){if(!n.active)return i(new Error("No active registration!"));var t=new MessageChannel;t.port1.onmessage=function(e){i(e.data.error,e.data.result)},n.active.postMessage(e,[t.port2])})}return o&&s&&(s.addEventListener("message",function(e){var n=e.data&&e.data.action&&e.data.action.split(".")||[];"notifications"===n[0]&&c[n[1]]&&c[n[1]](e.data)}),function e(){u({action:"getClientId"},function(n,t){if(n)return setTimeout(e,3e3),console.error("Failed to get the client ID: %s",n.message);r=t.clientId})}()),window.notifications={messageHandlers:c,userActions:a,renderRequest:function(){s&&o&&"granted"!==o.permission&&"denied"!==o.permission&&s.ready.then(function(){var e=n('<div class="message message-inline message-warning notifications-request"></div>').append("<p>"+i("core","notifications:request:message")+"</p>");e.on("click",function(){"default"===o.permission?o.requestPermission().then(function(n){"granted"===n?window.location.reload():"default"!==n&&e.remove()}):e.remove()}),n(".bd").prepend(e)})},show:function(e){return o&&"granted"===o.permission?(e.data||(e.data={}),new Promise(function(n,t){if(!e.scoreClient)return i();function i(){s.ready.then(function(i){if(!i.active)return t(new Error("No active SW."));i.showNotification(e.title,e).then(n,t)}).catch(t)}u({action:"getClients",filter:null},function(o,s){if(o)return t(o);if(!s.length)return i();var a=s.map(function(n){return{clientId:n._id,score:e.scoreClient(n)}});return a.sort(function(e,n){return n.score-e.score}),a[a.length-1].score<0?n(null):a[0].clientId!==r?n(null):(e.data.bestClientId=a[0].clientId,void i())})})):Promise.reject(new Error("Unsupported or disabled."))},close:function(n){if(!s)return Promise.reject(new Error("Unsupported."));s.ready.then(function(e){return e.getNotifications()}).then(function(t){t.forEach(function(t){if(Array.isArray(n)&&n.length){if(t.tag){var i=t.tag.split(" ");e.every(n,function(e){return i.includes(e)})&&t.close()}}else t.close()})}).catch(function(e){console.error("[notifications] Failed to close.",{tags:n,error:e})})}}});