define(["underscore","jquery","app/time","app/viewport","app/data/clipboard","app/core/views/FormView","app/core/util/sortByProps","app/planning/util/contextMenu","app/wmes-osh-common/dictionaries","app/wmes-osh-targets/templates/form","jquery.stickytableheaders"],function(t,e,i,a,o,s,n,r,l,p){"use strict";return s.extend({template:p,events:Object.assign({"change #-month":"loadExisting","change #-blur":"loadExistingNow",'change input[type="number"]':function(t){t.currentTarget.value>0||(t.currentTarget.value=0)},"keydown input":function(t){if("Enter"===t.key||"Space"===t.key)return!1},"contextmenu td":function(t){t.preventDefault(),this.showContextMenu(t.currentTarget,t.pageY,t.pageX)}},s.prototype.events),initialize:function(){s.prototype.initialize.apply(this,arguments),this.setUpStickyTable()},getTemplateData:function(){const t=new Set,e=new Set,i=new Set,a=this.model.serializeOrgUnits();return a.forEach(a=>{t.add(a.division),e.add(a.workplace),i.add(a.department)}),0===a.length&&a.push(o("overall",0,0,0)),l.departments.forEach(s=>{if(i.has(s.id)||!s.get("active"))return;const n=l.workplaces.get(s.get("workplace"));if(!n||!n.get("active"))return;const r=l.divisions.get(n.get("division"));r&&r.get("active")&&(t.has(r.id)||(a.push(o("division",r.id,0,0)),t.add(r.id)),e.has(n.id)||(a.push(o("workplace",r.id,n.id,0)),e.add(n.id)),a.push(o("department",r.id,n.id,s.id)))}),a.sort(n(["divisionLabel","workplaceLabel","departmentLabel"])),this.orgUnits={},a.forEach(t=>{this.orgUnits[t.key]={division:t.division,workplace:t.workplace,department:t.department,targets:t.targets}}),{orgUnits:a};function o(t,e,i,a){return{type:t,key:`d${e}w${i}d${a}`,division:e,divisionLabel:l.getLabel("divisions",e),workplace:i,workplaceLabel:l.getLabel("workplaces",i),department:a,departmentLabel:l.getLabel("departments",a),targets:{minActiveUsers:0,minObservers:0,minObsCardsPerObserver:0,minSafeObs:0,maxSafeObs:0,ipr:0,ips:0,trc:0,contact:0}}}},serializeToForm:function(){return{month:this.options.editMode?i.utc.format(this.model.id,"YYYY-MM"):this.month||"",orgUnits:this.orgUnits}},serializeForm:function(t){return this.options.editMode||(t._id=t.month+"-01T00:00:00Z"),delete t.month,t.orgUnits=Object.values(t.orgUnits||{}),t.orgUnits.forEach(t=>{t.division=+t.division,t.workplace=+t.workplace,t.department=+t.department,Object.keys(t.targets).forEach(e=>{t.targets[e]=Math.round(100*parseFloat(t.targets[e]))/100})}),t},setUpStickyTable:function(){this.on("afterRender",()=>{this.$(".table").stickyTableHeaders({fixedOffset:e(".navbar-fixed-top"),scrollableAreaX:this.$(".table-responsive")})}),this.on("beforeRender remove",()=>{this.$(".table").stickyTableHeaders("destroy")})},loadExisting:function(){clearTimeout(this.timers.loadExisting),this.timers.loadExisting=setTimeout(this.loadExistingNow.bind(this),333)},loadExistingNow:function(){clearTimeout(this.timers.loadExisting);const t=this.$id("month").val();if(!t)return;const e=i.utc.getMoment(`${t}-01`,"YYYY-MM-DD");if(!e.isValid())return;a.msg.loading();const o=this.ajax({url:`/osh/targets?_id<=${e.valueOf()}&sort(-_id)&limit(1)`});o.fail(()=>{a.msg.loadingFailed()}),o.done(t=>{if(a.msg.loaded(),!t.totalCount)return;const i=t.collection&&t.collection[0]||{};i._id!==e.toISOString()&&(i._id=void 0),this.month=e.format("YYYY-MM"),this.model.set(i,{silent:!0}),this.render()})},showContextMenu:function(t,e,i){const a=t.parentNode,o=t.querySelector('input[type="number"]'),s=[this.t(`FORM:copy:${o?"specific":"all"}`)];if(a.dataset.workplace>0&&s.push({label:this.t("FORM:copy:workplace"),handler:()=>this.copyValue(t,"workplace")}),a.dataset.division>0&&s.push({label:this.t("FORM:copy:division"),handler:()=>this.copyValue(t,"division")}),s.push({label:this.t("FORM:copy:overall"),handler:()=>this.copyValue(t,"overall")}),s.push({label:this.t("FORM:copy:clipboard"),handler:()=>this.copyValue(t,"clipboard")}),this.clipboardData){const e=this.clipboardData.startsWith("OSH_TARGETS");(o||!o&&e)&&(s.push(this.t(`FORM:paste:${o?"single":"multi"}`)),a.dataset.department>0&&s.push({label:this.t("FORM:copy:department"),handler:()=>this.copyValue(t,"department",!0)}),a.dataset.workplace>0&&s.push({label:this.t("FORM:copy:workplace"),handler:()=>this.copyValue(t,"workplace",!0)}),a.dataset.division>0&&s.push({label:this.t("FORM:copy:division"),handler:()=>this.copyValue(t,"division",!0)}),s.push({label:this.t("FORM:copy:overall"),handler:()=>this.copyValue(t,"overall",!0)}))}r.show(this,e,i,s)},copyValue:function(t,e,i){const a=t.querySelector('input[type="number"]');if("clipboard"!==e){if(a){const o=a.name.split(".").pop(),s=("overall"===e?"":`tr[data-${e}="${t.parentNode.dataset[e]}"] `)+`input[name$="${o}"]`;let n=a.value;i&&(n=this.clipboardData.startsWith("OSH_TARGETS")?this.clipboardData.split(" ").find(t=>t.startsWith(`${o}=`)).split("=")[1]:this.clipboardData),this.$(s).val(n)}else{const i=this.$(t).closest("tr").find('input[type="number"]'),a="overall"===e?"tr":`tr[data-${e}="${t.parentNode.dataset[e]}"]`;this.$("tbody").find(a).each((t,e)=>{const a=this.$(e).find('input[type="number"]');i.each((t,e)=>{a[t].value=e.value})})}i||o.showTooltip({el:t,offsetTop:-30})}else o.copy(e=>{if(a)e.setData("text/plain",a.value.toLocaleString()),this.clipboardData=a.value.toLocaleString();else{const i=["OSH_TARGETS"];for(const e of t.parentNode.querySelectorAll('input[type="number"]'))i.push(`${e.name.split(".").pop()}=${e.value.toLocaleString()}`);this.clipboardData=i.join(" "),e.setData("text/plain",this.clipboardData)}o.showTooltip({el:t,offsetTop:-30})})}})});