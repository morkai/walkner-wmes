define(["underscore","h5.pubsub/MessageBroker","app/broker","app/socket"],function(e,u,s,n){"use strict";var i=new u,b={},t=[],o=null,p=null;function c(u,n,i){if(n)s.publish("pubsub.subscribeFailed",{err:n,topics:u});else{i.length>0&&s.publish("pubsub.subscribeNotAllowed",{topics:i});var b=e.difference(u,i);b.length>0&&s.publish("pubsub.subscribed",{topics:b})}}function l(){n.isConnected()&&n.emit("pubsub.subscribe",t,c.bind(null,t)),t=[],o=null}function r(){var e=Object.keys(b);n.isConnected()&&n.emit("pubsub.unsubscribe",e),b={},p=null,s.publish("pubsub.unsubscribed",{topics:e})}return i.on("new topic",function(e){void 0!==b[e]&&delete b[e],n.isConnected()&&(t.push(e),null===o&&(o=setTimeout(l,0)))}),i.on("empty topic",function(e){n.isConnected()&&(b[e]=!0,null===p&&(p=setTimeout(r,0)))}),i.on("message",function(e,u,i){!0!==i.remote&&n.emit("pubsub.publish",e,u,i,function(n){n?s.publish("pubsub.publishFailed",{err:n,topic:e,message:u,meta:i}):s.publish("pubsub.published",{topic:e,message:u,meta:i})})}),n.on("connect",function(){var e=Object.keys(i.count());e.length&&n.emit("pubsub.subscribe",e,c.bind(null,e))}),n.on("pubsub.message",function(e,u,s){s.remote=!0,s.json&&"string"==typeof u&&(u=JSON.parse(u)),i.publish(e,u,s)}),window.pubsub=i,i});