define(["underscore","h5.pubsub/MessageBroker","app/broker","app/socket"],function(e,t,n,r){function i(t,r,i){if(r)return n.publish("pubsub.subscribeFailed",{err:r,topics:t}),void 0;i.length>0&&n.publish("pubsub.subscribeNotAllowed",{topics:i});var o=e.difference(t,i);o.length>0&&n.publish("pubsub.subscribed",{topics:o})}function o(){r.isConnected()&&r.emit("pubsub.subscribe",d,i.bind(null,d)),d=[],u=null}function a(){var e=Object.keys(l);r.isConnected()&&r.emit("pubsub.unsubscribe",e),l={},c=null,n.publish("pubsub.unsubscribed",{topics:e})}var s=new t,l={},d=[],u=null,c=null;return s.on("new topic",function(e){"undefined"!=typeof l[e]&&delete l[e],r.isConnected()&&(d.push(e),null===u&&(u=setTimeout(o,0)))}),s.on("empty topic",function(e){r.isConnected()&&(l[e]=!0,null===c&&(c=setTimeout(a,0)))}),s.on("message",function(e,t,i){i.remote!==!0&&r.emit("pubsub.publish",e,t,i,function(r){r?n.publish("pubsub.publishFailed",{err:r,topic:e,message:t,meta:i}):n.publish("pubsub.published",{topic:e,message:t,meta:i})})}),r.on("connect",function(){var e=Object.keys(s.count());e.length&&r.emit("pubsub.subscribe",e,i.bind(null,e))}),r.on("pubsub.message",function(e,t){s.publish(e,t,{remote:!0})}),window.pubsub=s,s});