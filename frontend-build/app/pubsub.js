define(["underscore","utf8","h5.pubsub/MessageBroker","app/broker","app/socket"],function(e,u,s,n,i){"use strict";var t=new s,b={},o=[],r=null,c=null;function p(u,s,i){if(s)n.publish("pubsub.subscribeFailed",{err:s,topics:u});else{i.length>0&&n.publish("pubsub.subscribeNotAllowed",{topics:i});var t=e.difference(u,i);t.length>0&&n.publish("pubsub.subscribed",{topics:t})}}function l(){i.isConnected()&&i.emit("pubsub.subscribe",o,p.bind(null,o)),o=[],r=null}function a(){var e=Object.keys(b);i.isConnected()&&i.emit("pubsub.unsubscribe",e),b={},c=null,n.publish("pubsub.unsubscribed",{topics:e})}return t.on("new topic",function(e){void 0!==b[e]&&delete b[e],i.isConnected()&&(o.push(e),null===r&&(r=setTimeout(l,0)))}),t.on("empty topic",function(e){i.isConnected()&&(b[e]=!0,null===c&&(c=setTimeout(a,0)))}),t.on("message",function(e,u,s){!0!==s.remote&&i.emit("pubsub.publish",e,u,s,function(i){i?n.publish("pubsub.publishFailed",{err:i,topic:e,message:u,meta:s}):n.publish("pubsub.published",{topic:e,message:u,meta:s})})}),i.on("connect",function(){var e=Object.keys(t.count());e.length&&i.emit("pubsub.subscribe",e,p.bind(null,e))}),i.on("pubsub.message",function(e){try{e instanceof ArrayBuffer&&(e=u.decode(String.fromCharCode.apply(null,new Uint8Array(e)))),"string"==typeof e&&(e=JSON.parse(e)),e[2].remote=!0}catch(u){return console.error("[pubsub] Failed to parse remote message:",{message:e})}t.publish(e[0],e[1],e[2])}),window.pubsub=t,t});