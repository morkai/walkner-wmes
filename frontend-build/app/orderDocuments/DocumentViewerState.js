define(["underscore","../i18n","../core/Model","../data/localStorage"],function(e,t,n,r){"use strict";return n.extend({nlsDomain:"orderDocuments",defaults:function(){return{prodLine:{_id:null,name:""},station:0,prefixFilterMode:"exclusive",prefixFilter:"161 165 198",spigotCheck:!1,localOrder:{no:null,nc12:"",name:"",documents:{},confirmations:{},nc15:null,notes:[]},remoteOrder:{no:null,nc12:"",name:"",documents:{},confirmations:{},nc15:null,notes:[]},localFile:null,fileSource:null,bom:null}},initialize:function(){this.on("change:prefixFilterMode change:prefixFilter",function(){var e,t,n;this.filterNc15=(e=this.get("prefixFilterMode"),t=this.get("prefixFilter"),n=new RegExp("^("+t.replace(/ /g,"|")+")"),function(r){if(""===t)return!0;var o=n.test(r);return"inclusive"===e&&o||"exclusive"===e&&!o})}),this.on("change:prodLine",function(){window.WMES_LINE_ID=(this.get("prodLine")||{_id:null})._id}),this.on("change:station",function(){window.WMES_STATION=this.get("station")})},load:function(){var t=e.assign(this.defaults(),JSON.parse(r.getItem("WMES:DOCS")||"{}"));t.remoteOrder.confirmations||(t.remoteOrder.confirmations={}),t.localOrder.confirmations||(t.localOrder.confirmations={});var n=window.WMES_CLIENT;n&&(t.prodLine._id=n.config.line,t.prodLine.name=n.config.line.replace(/[_\s]+/g," ").replace(/~.*?$/,"").trim(),t.station=n.config.station),this.set(t)},save:function(){var e={prodLine:this.get("prodLine"),station:this.get("station"),localOrder:this.get("localOrder"),remoteOrder:this.get("remoteOrder"),prefixFilterMode:this.get("prefixFilterMode"),prefixFilter:this.get("prefixFilter"),spigotCheck:this.get("spigotCheck")};r.setItem("WMES:DOCS",JSON.stringify(e)),this.trigger("save")},filterNc15:function(){return!0},selectDocument:function(t,n){var r=this.get("localOrder"),o=this.get("remoteOrder"),i=r.no?"localOrder":"remoteOrder",c=r.no?r:o,s={localFile:null};c.documents[t]||e.isEmpty(n)||(c.documents[t]=n+"$__EXTERNAL__"),s[i]=e.defaults({nc15:t},c),this.set(s),this.save()},removeDocument:function(t){var n=this.get("localOrder"),r=this.get("remoteOrder"),o=n.no?"localOrder":"remoteOrder",i=e.defaults({},n.no?n:r),c={};i.nc15===t&&(i.nc15=null),delete i.documents[t],c[o]=i,this.set(c),this.save()},getSettings:function(){var e=this.get("prodLine");return{prodLineId:e._id,prodLineName:e.name,station:this.get("station"),prefixFilterMode:this.get("prefixFilterMode"),prefixFilter:this.get("prefixFilter"),spigotCheck:this.get("spigotCheck")}},isExternalDocument:function(){var e=this.getCurrentOrder();return!!e.nc15&&void 0===e.documents[e.nc15]},getCurrentOrder:function(){var e=this.get("localOrder");return e.no?e:this.get("remoteOrder")},getCurrentOrderInfo:function(){var e={fileSource:this.get("fileSource"),orderNo:null,orderNc12:null,orderName:null,documentNc15:null,documentName:null},n=this.getCurrentOrder(),r=this.get("localFile");if(n.no?(e.orderNo=n.no,e.orderNc12=n.nc12,e.orderName=n.name):(e.orderNo=t("orderDocuments","controls:emptyOrderNo"),e.orderName=t("orderDocuments","controls:emptyOrderName")),r){var o=r.name.replace(/_/g," ").replace(/\s+/g," ").trim().match(/^([0-9]+)?(.*?)?\.pdf$/i),i=(o[1]||"").trim(),c=(o[2]||"").trim();e.documentNc15=i||t("orderDocuments","controls:localDocumentNc15"),e.documentName=c||t("orderDocuments","controls:localDocumentName")}else{var s=n.documents[n.nc15];"ORDER"===n.nc15?(e.documentNc15=s,e.documentName=""):s?(e.documentNc15=n.nc15,e.documentName=s):n.nc15?(e.documentNc15=n.nc15,e.documentName=t("orderDocuments","controls:externalDocumentName")):(e.documentNc15=t("orderDocuments","controls:emptyDocumentNc15"),e.documentName=t("orderDocuments","controls:emptyDocumentName"))}return e},getRemoteFileUrl:function(e){return window.location.origin+"/orderDocuments/"+e},setRemoteOrder:function(e){this.setOrder("remoteOrder",e)},setLocalOrder:function(e){this.setOrder("localOrder",e)},resetLocalOrder:function(){this.set("localOrder",{no:null,nc12:"",name:"",documents:{},confirmations:{},nc15:null,notes:[]}),this.save()},resetExternalDocument:function(){this.isExternalDocument()&&this.selectDocument(null)},setLocalFile:function(e,t){this.set({nc15:null,localFile:{name:e,file:t}}),this.save()},resetLocalFile:function(){this.set("localFile",null),this.save()},setFileSource:function(e){this.set("fileSource",e),this.save()},setOrder:function(n,r){var o=this.get(n),i={no:r.no,nc12:r.nc12,name:r.name,documents:{},confirmations:{},nc15:null,notes:r.notes||[]};i.documents.ORDER=t("orderDocuments","order"),r.hasBom&&(i.documents.BOM=t("orderDocuments","bom")),r.hasEto&&(i.documents.ETO=t("orderDocuments","eto")),delete r.documents.ETO,delete r.documents.BOM,delete r.documents.ORDER,e.assign(i.documents,r.documents),e.forEach(o.documents,function(e,t){/\$__.*?__$/.test(e)&&!i.documents[t]&&(i.documents[t]=e)});var c=this.get("station");if(e.forEach(r.confirmations,function(e,t){var n=e[c];i.confirmations[t]=void 0===n?"unknown":n}),i.no===o.no&&i.documents[o.nc15])i.nc15=o.nc15;else{var s=Object.keys(i.documents).filter(this.filterNc15);s.length&&(i.nc15=s[0])}this.set(n,i),o.no!==i.no&&this.trigger("change:"+n+":no",o.no,i.no)},checkEtoExistence:function(e){var t=!!this.get("localOrder").no,n=this.checkEtoInOrder(e,this.get("localOrder")),r=this.checkEtoInOrder(e,this.get("remoteOrder"));(n||r&&!t)&&this.trigger("change:documents")},checkEtoInOrder:function(n,r){if(r.nc12!==n)return!1;if(r.documents.ETO)return!1;var o=Object.keys(r.documents),i={};return r.documents.ORDER&&(i.ORDER=r.documents.ORDER,o.shift()),r.documents.BOM&&(i.BOM=r.documents.BOM,o.shift()),i.ETO=t("orderDocuments","eto"),e.forEach(o,function(e){i[e]=r.documents[e]}),r.documents=i,!0},isBomActive:function(){var e=this.get("bom");if(!e||!e.active)return!1;var t=this.getCurrentOrder();return!!t.no&&t.no===e.orderNo},isBomAvailable:function(){var e=this.get("bom");if(!e)return!1;var t=this.getCurrentOrder();return!!t.no&&t.no===e.orderNo},getOverallConfirmationStatus:function(){var e=this.getCurrentOrder().confirmations,t=Object.keys(e);if(!t.length)return"confirmed";for(var n=0;n<t.length;++n){var r=e[t[n]];if("unknown"===r||"unconfirmed"===r)return r}return"confirmed"},isConfirmableDocumentSelected:function(){return this.isConfirmableDocument(this.getCurrentOrder().nc15)},isConfirmedDocumentSelected:function(){var e=this.getCurrentOrder();return"confirmed"===e.confirmations[e.nc15]},isConfirmableDocument:function(e){var t=this.getCurrentOrder().confirmations[e];return void 0!==t&&"ignored"!==t},isDocumentConfirmed:function(e){return"confirmed"===this.getCurrentOrder().confirmations[e]},getFirstUnconfirmedDocument:function(){for(var e=this.getCurrentOrder().confirmations,t=Object.keys(e),n=0;n<t.length;++n){var r=t[n],o=e[r];if("unknown"===o||"unconfirmed"===o)return r}return null},setDocumentConfirmations:function(t,n){var r=!1;[this.get("localOrder"),this.get("remoteOrder")].forEach(function(o){o.no!==t||e.isEqual(o.confirmations,n)||(o.confirmations=n,r=!0)}),r&&(this.trigger("change:confirmations"),this.save())},handleConfirmation:function(t){var n=!1;[this.get("localOrder"),this.get("remoteOrder")].forEach(function(r){if(r.no===t.orderNo){var o=r.confirmations;if(void 0!==o[t.nc15]){var i=e.clone(o);i[t.nc15]="confirmed",e.isEqual(o,i)||(r.confirmations=i,n=!0)}}}),n&&(this.trigger("change:confirmations"),this.save())},isIgnored:function(e){return"ignored"===this.getCurrentOrder().confirmations[e]}})});