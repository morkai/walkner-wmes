// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","js2form","form2js","app/i18n","app/viewport","app/core/View","app/orderDocuments/templates/localOrderPicker"],function(e,r,t,s,n,i,o,a){"use strict";return o.extend({template:a,events:{submit:function(){return this.submitForm(),!1},"click #-numpad > .btn":function(e){this.pressNumpadKey(e.currentTarget.dataset.key)},"click #-lastOrders > .btn":function(e){this.selectOrderNo(e.currentTarget.dataset.order)}},initialize:function(){this.collection&&this.listenTo(this.collection,"sync",this.renderLastOrders)},afterRender:function(){t(this.el,{orderNo:""}),this.collection?this.collection.fetch({reset:!0}):this.$id("lastOrders").html("")},renderLastOrders:function(){var e={},r=0,t=[];this.collection.forEach(function(s){var n=s.get("orderId");e[n]||5===r||(e[n]=!0,r+=1,t.push('<button type="button" class="btn btn-default btn-block" tabindex="-1" data-order="',n,'">',n,"</button>"))}),this.$id("lastOrders").html(t.join(""))},submitForm:function(){var e=this,r=this.$id("submit").prop("disabled",!0);r.find(".fa").removeClass("fa-search").addClass("fa-spin fa-spinner");var t=this.$id("orderNo").val(),s=this.ajax({type:"GET",url:window.location.origin+"/orders/"+t+"/documents"});s.fail(function(e){var r=((e.responseJSON||{}).error||{}).message,t=n.has("orderDocuments","localOrderPicker:error:"+r)?n("orderDocuments","localOrderPicker:error:"+r):n("orderDocuments","localOrderPicker:error:failure");i.msg.show({type:"error",time:3e3,text:t})}),s.done(function(r){e.trigger("localOrder",r)}),s.always(function(){r.prop("disabled",!1).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-search")})},checkLocalServer:function(){var e=this,r=this.ajax({type:"GET",url:"http://127.0.0.1:1335/hello"}),t=e.$(".message-warning").removeClass("hidden"),s=e.$(".message-success").addClass("hidden"),n=e.$(".message-error").addClass("hidden");r.always(function(){t.addClass("hidden")}),r.done(function(){s.removeClass("hidden")}),r.fail(function(){n.removeClass("hidden")})},pressNumpadKey:function(e){var r=this.$id("orderNo")[0],t=r.value,s=r.selectionStart,n=r.selectionEnd;"BACKSPACE"===e?(s-=1,t=t.substring(0,s)+t.substring(n)):"LEFT"===e?s-=1:"RIGHT"===e?s+=1:t.length<r.maxLength&&(t=t.substring(0,s)+e+t.substring(n),s+=1),r.value=t,r.focus(),r.setSelectionRange(s,s)},selectOrderNo:function(e){var r=this.$id("orderNo")[0];r.value=e,r.focus(),r.setSelectionRange(e.length,e.length)}})});