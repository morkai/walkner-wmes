define(["underscore","jquery","js2form","form2js","app/i18n","app/time","app/viewport","app/core/View","app/core/util/embedded","app/prodShiftOrders/ProdShiftOrderCollection","app/orderDocuments/templates/localOrderPicker"],function(e,r,t,n,o,i,s,d,a,l,u){"use strict";return d.extend({dialogClassName:"orderDocuments-localOrderPicker-dialog",template:u,events:{submit:function(){return this.submitForm(),!1},"click #-numpad > .btn":function(e){this.pressNumpadKey(e.currentTarget.dataset.key),this.toggleSubmit()},"click #-plannedOrders > .btn":function(e){this.selectOrderNo(e.currentTarget.dataset.order),this.toggleSubmit()},"click #-lastOrders > .btn":function(e){this.selectOrderNo(e.currentTarget.dataset.order),this.toggleSubmit()},"input #-orderNo":"toggleSubmit"},initialize:function(){this.plannedOrders=null,this.lastOrders=new l(null,{rqlQuery:"select(orderId)&sort(-startedAt)&limit(10)&prodLine="+this.model.get("prodLine")._id}),this.listenTo(this.lastOrders,"sync",this.renderLastOrders)},getTemplateData:function(){return{touch:a.isEnabled()}},afterRender:function(){t(this.el,{orderNo:""}),this.lastOrders.fetch({reset:!0}),this.fetchPlannedOrders()},fetchPlannedOrders:function(){var e=this,t=r.ajax({url:"/production/orderQueue/"+e.model.get("prodLine")._id});t.fail(function(){e.plannedOrders=[]}),t.done(function(r){e.plannedOrders=r.map(function(e){return e.order.no})}),t.always(e.renderPlannedOrders.bind(e))},renderLastOrders:function(){var e={},r=0,t=[];this.lastOrders.forEach(function(n){var o=n.get("orderId");e[o]||5===r||(e[o]=!0,r+=1,t.push('<button type="button" class="btn btn-default btn-block" tabindex="-1" data-order="',o,'">',o,"</button>"))}),this.$id("lastOrders").find(".fa-spinner").replaceWith(t.join(""))},renderPlannedOrders:function(){var e=[];this.plannedOrders.forEach(function(r){e.push('<button type="button" class="btn btn-default btn-block" tabindex="-1" data-order="',r,'">',r,"</button>")}),this.$id("plannedOrders").find(".fa-spinner").replaceWith(e.join(""))},submitForm:function(){var e=this,r=e.$id("submit").prop("disabled",!0);r.find(".fa").removeClass("fa-search").addClass("fa-spin fa-spinner");var t=e.$id("orderNo").val(),n=15===t.length?"document":"order",o=e["document"===n?"findDocument":"findOrder"](t);o.fail(function(r){var t=r.getResponseHeader("X-Error-Code")||"",o=e.t("localOrderPicker:error:failure:"+n),d=2500;if(t)if(e.t.has("localOrderPicker:error:"+t+":"+n)){var a={};"DATE_NOT_FOUND"===t&&(d=6e3,a.required=i.format(+r.getResponseHeader("X-Error-Required"),"L"),a.actual=r.getResponseHeader("X-Error-Actual").split(", ").map(function(e){return i.format(+e,"L")}).join(", ")),o=e.t("localOrderPicker:error:"+t+":"+n,a)}else e.t.has("localOrderPicker:error:"+t)&&(o=e.t("localOrderPicker:error:"+t));s.msg.show({type:"error",time:d,text:o,className:"text-left"})}),o.always(function(){r.prop("disabled",!1).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-search")})},findOrder:function(e){var r=this,t=r.ajax({type:"GET",url:"/orders/"+e+"/documents",data:{line:r.model.get("prodLine")._id,station:r.model.get("station")}});return t.done(function(e){r.trigger("localOrder",e)}),t},findDocument:function(e){var r=this,t=r.ajax({type:"HEAD",url:"/orderDocuments/"+e+"?name=1&order="+this.model.getCurrentOrder().no});return t.done(function(){r.trigger("document",{nc15:e,name:t.getResponseHeader("X-Document-Name"),source:t.getResponseHeader("X-Document-Source")})}),t},pressNumpadKey:function(e){var r=this.$id("orderNo")[0],t=r.value,n=r.selectionStart,o=r.selectionEnd;"CLEAR"===e?(n=0,t=""):"BACKSPACE"===e?(n-=1,t=t.substring(0,n)+t.substring(o)):"LEFT"===e?n-=1:"RIGHT"===e?n+=1:t.length<r.maxLength&&(t=t.substring(0,n)+e+t.substring(o),n+=1),r.value=t,r.focus(),r.setSelectionRange(n,n)},selectOrderNo:function(e){var r=this.$id("orderNo")[0];r.value=e,r.focus(),r.setSelectionRange(e.length,e.length)},toggleSubmit:function(){var e=this.$id("orderNo").val().replace(/[^0-9]+/,"").length,r="localOrderPicker:submit";15===e?r+=":document":9===e&&(r+=":order"),this.$id("submit").find("span").text(o("orderDocuments",r))}})});