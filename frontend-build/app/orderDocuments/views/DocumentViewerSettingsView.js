// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","js2form","form2js","app/i18n","app/viewport","app/core/View","app/orderDocuments/templates/settings"],function(e,r,i,t,s,a,n,o){"use strict";return n.extend({template:o,events:{submit:function(){return this.submitForm(),!1},"change #-prodLineId":function(e){var r=e.target.value.replace(/_/g," ").replace(/\s+/," ").replace(/~.*?$/,"").trim();this.$id("prodLineName").val(r)},"change #-prefixFilter":function(e){var r={};e.target.value.split(/[^0-9]/).forEach(function(e){/^[0-9]+$/.test(e)&&(r[e]=!0)}),e.target.value=Object.keys(r).sort().join(" ")},"click .message-success, .message-error":"checkLocalServer"},afterRender:function(){var e=this.model,r=e.get("prodLine");i(this.el,{prodLineId:r._id,prodLineName:r.name,prefixFilterMode:e.get("prefixFilterMode"),prefixFilter:e.get("prefixFilter"),localServerUrl:e.get("localServerUrl"),localServerPath:e.get("localServerPath")}),this.checkLocalServer()},submitForm:function(){var r=this,i=this.$id("submit").prop("disabled",!0);i.find(".fa").removeClass("fa-save").addClass("fa-spin fa-spinner");var n=e.defaults(t(this.el),{prefixFilterMode:"inclusive",prefixFilter:"",localServerUrl:"",localServerPath:""}),o=this.ajax({type:"POST",url:window.location.href,data:JSON.stringify(n)});o.fail(function(e){var r=((e.responseJSON||{}).error||{}).message,i=s.has("orderDocuments","settings:error:"+r)?s("orderDocuments","settings:error:"+r):s("orderDocuments","settings:error:failure");a.msg.show({type:"error",time:3e3,text:i})}),o.done(function(){r.trigger("settings",{prodLine:{_id:n.prodLineId,name:n.prodLineName},prefixFilterMode:n.prefixFilterMode,prefixFilter:n.prefixFilter})}),o.always(function(){i.prop("disabled",!1).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-save")})},checkLocalServer:function(){var e=this,r=this.ajax({type:"GET",url:"http://127.0.0.1:1335/hello"}),i=e.$(".message-warning").removeClass("hidden"),t=e.$(".message-success").addClass("hidden"),s=e.$(".message-error").addClass("hidden");r.always(function(){i.addClass("hidden")}),r.done(function(){t.removeClass("hidden")}),r.fail(function(){s.removeClass("hidden")})}})});