// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","js2form","form2js","app/i18n","app/viewport","app/core/View","app/prodLines/ProdLineCollection","app/orderDocuments/templates/settings"],function(e,r,i,t,s,n,a,o,d){"use strict";return a.extend({template:d,events:{submit:function(){return this.submitForm(),!1},"change #-prodLineId":function(e){this.$id("prodLineName").val(this.prepareProdLineName(e.target.value))},"change #-prefixFilter":function(e){var r={};e.target.value.split(/[^0-9]/).forEach(function(e){/^[0-9]+$/.test(e)&&(r[e]=!0)}),e.target.value=Object.keys(r).sort().join(" ")},"click .message-success, .message-error":"checkLocalServer"},afterRender:function(){i(this.el,this.serializeFormData()),this.checkLocalServer(),this.setUpProdLineSelect2()},serializeFormData:function(){var e=this.model,r=e.get("prodLine"),i={prodLineId:r._id,prodLineName:r.name,prefixFilterMode:e.get("prefixFilterMode"),prefixFilter:e.get("prefixFilter"),localServerUrl:e.get("localServerUrl"),localServerPath:e.get("localServerPath")};if(!i.prodLineId){var t=this.model.id.indexOf("-");-1!==t&&(i.prodLineId=this.model.id.substring(t+1),i.prodLineName=this.prepareProdLineName(i.prodLineId))}return i},submitForm:function(){var r=this,i=this.$id("submit").prop("disabled",!0);i.find(".fa").removeClass("fa-save").addClass("fa-spin fa-spinner");var a=e.defaults(t(this.el),{prefixFilterMode:"inclusive",prefixFilter:"",localServerUrl:"",localServerPath:""}),o=this.ajax({type:"POST",url:window.location.href,data:JSON.stringify(a)});o.fail(function(e){var r=((e.responseJSON||{}).error||{}).message,i=s.has("orderDocuments","settings:error:"+r)?s("orderDocuments","settings:error:"+r):s("orderDocuments","settings:error:failure");n.msg.show({type:"error",time:3e3,text:i})}),o.done(function(){r.trigger("settings",{prodLine:{_id:a.prodLineId,name:a.prodLineName},prefixFilterMode:a.prefixFilterMode,prefixFilter:a.prefixFilter})}),o.always(function(){i.prop("disabled",!1).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-save")})},checkLocalServer:function(){var e=this,r=this.ajax({type:"GET",url:"http://127.0.0.1:1335/hello"}),i=e.$(".message-warning").removeClass("hidden"),t=e.$(".message-success").addClass("hidden"),s=e.$(".message-error").addClass("hidden");r.always(function(){i.addClass("hidden")}),r.done(function(){t.removeClass("hidden")}),r.fail(function(){s.removeClass("hidden")})},setUpProdLineSelect2:function(){var r=this,i=new o(null,{rqlQuery:"deactivatedAt=null&sort(_id)"});i.once("reset",function(){var t=r.$id("prodLineId");t.length&&(t.parent().addClass("has-required-select2"),t.removeClass("form-control").select2({data:i.map(function(e){return{id:e.id,text:e.id,description:e.get("description")}}),matcher:function(e,r,i){return e=e.toUpperCase(),-1!==r.toUpperCase().indexOf(e)||-1!==i.description.toUpperCase().indexOf(e)},formatResult:function(r){var i='<div class="kaizenOrders-select2">';return i+="<p><strong>"+e.escape(r.id)+"</strong><br>",i+=e.escape(r.description)+"</p>",i+="</div>"}}))}),this.promised(i.fetch({reset:!0}))},prepareProdLineName:function(e){return e.replace(/_/g," ").replace(/\s+/," ").replace(/~.*?$/,"").trim()},onDialogShown:function(){this.$id("prodLineId").focus()}})});