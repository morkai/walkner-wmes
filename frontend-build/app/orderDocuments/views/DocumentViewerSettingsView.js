define(["underscore","jquery","js2form","form2js","app/i18n","app/viewport","app/core/View","app/prodLines/ProdLineCollection","app/orderDocuments/templates/settings"],function(e,i,r,t,n,s,o,a,d){"use strict";return o.extend({template:d,events:{submit:function(){return this.submitForm(),!1},"change #-prodLineId":function(e){this.$id("prodLineName").val(this.prepareProdLineName(e.target.value))},"change #-prefixFilter":function(e){var i={};e.target.value.split(/[^0-9]/).forEach(function(e){/^[0-9]+$/.test(e)&&(i[e]=!0)}),e.target.value=Object.keys(i).sort().join(" ")}},afterRender:function(){r(this.el,this.serializeFormData()),this.setUpProdLineSelect2()},serializeFormData:function(){var e=this.model,i=e.get("prodLine"),r={prodLineId:i._id,prodLineName:i.name,station:e.get("station"),prefixFilterMode:e.get("prefixFilterMode"),prefixFilter:e.get("prefixFilter"),spigotCheck:e.get("spigotCheck")};if(!r.prodLineId){var t=this.model.id.indexOf("-");-1!==t&&(r.prodLineId=this.model.id.substring(t+1),r.prodLineName=this.prepareProdLineName(r.prodLineId))}return r},submitForm:function(){var i=this,r=i.$id("submit").prop("disabled",!0);r.find(".fa").removeClass("fa-save").addClass("fa-spin fa-spinner");var o=e.defaults(t(i.el),{prefixFilterMode:"inclusive",prefixFilter:"",spigotCheck:!1});o.station=parseInt(o.station,10)||0,o.apiKey=this.options.apiKey;var a=i.ajax({type:"POST",url:window.location.href,data:JSON.stringify(o)});a.fail(function(e){var r=((e.responseJSON||{}).error||{}).message,t=n.has("orderDocuments","settings:error:"+r)?i.t("settings:error:"+r):i.t("settings:error:failure");s.msg.show({type:"error",time:3e3,text:t})}),a.done(function(){i.trigger("settings",{prodLine:{_id:o.prodLineId,name:o.prodLineName},station:o.station,prefixFilterMode:o.prefixFilterMode,prefixFilter:o.prefixFilter,spigotCheck:o.spigotCheck})}),a.always(function(){r.prop("disabled",!1).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-save")})},setUpProdLineSelect2:function(){var i=this;if(window.WMES_CLIENT)return this.$id("prodLineId").prop("readOnly",!0).addClass("form-control"),this.$id("prodLineName").prop("readOnly",!0),void this.$id("station").prop("readOnly",!0);var r=new a(null,{rqlQuery:"deactivatedAt=null&sort(_id)"});r.once("reset",function(){var t=i.$id("prodLineId");t.length&&(t.parent().addClass("has-required-select2"),t.removeClass("form-control").select2({data:r.map(function(e){return{id:e.id,text:e.id,description:e.get("description")}}),matcher:function(e,i,r){return e=e.toUpperCase(),-1!==i.toUpperCase().indexOf(e)||-1!==r.description.toUpperCase().indexOf(e)},formatResult:function(i){var r='<div class="kaizenOrders-select2">';return r+="<p><strong>"+e.escape(i.id)+"</strong><br>",r+=e.escape(i.description)+"</p>",r+="</div>"}}))}),this.promised(r.fetch({reset:!0}))},prepareProdLineName:function(e){return e.replace(/_/g," ").replace(/\s+/," ").replace(/~.*?$/,"").trim()}})});