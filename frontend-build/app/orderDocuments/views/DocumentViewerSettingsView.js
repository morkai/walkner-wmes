define(["underscore","jquery","js2form","form2js","app/i18n","app/viewport","app/core/View","app/prodLines/ProdLineCollection","app/orderDocuments/templates/settings"],function(e,t,i,r,n,s,o,a,d){"use strict";return o.extend({template:d,events:{submit:function(){return this.submitForm(),!1},"change #-prodLineId":function(e){this.$id("prodLineName").val(this.prepareProdLineName(e.target.value))},"change #-prefixFilter":function(e){var t={};e.target.value.split(/[^0-9]/).forEach(function(e){/^[0-9]+$/.test(e)&&(t[e]=!0)}),e.target.value=Object.keys(t).sort().join(" ")}},afterRender:function(){i(this.el,this.serializeFormData()),this.setUpProdLineSelect2()},serializeFormData:function(){var e=this.model,t=e.get("prodLine"),i={prodLineId:t._id,prodLineName:t.name,station:e.get("station"),prefixFilterMode:e.get("prefixFilterMode"),prefixFilter:e.get("prefixFilter"),spigotCheck:e.get("spigotCheck")};if(!i.prodLineId){var r=this.model.id.indexOf("-");-1!==r&&(i.prodLineId=this.model.id.substring(r+1),i.prodLineName=this.prepareProdLineName(i.prodLineId))}return i},submitForm:function(){var t=this,i=t.$id("submit").prop("disabled",!0);i.find(".fa").removeClass("fa-save").addClass("fa-spin fa-spinner");var o=e.defaults(r(t.el),{prefixFilterMode:"inclusive",prefixFilter:"",spigotCheck:!1});o.station=parseInt(o.station,10)||0;var a=t.ajax({type:"POST",url:window.location.href,data:JSON.stringify(o)});a.fail(function(e){var i=((e.responseJSON||{}).error||{}).message,r=n.has("orderDocuments","settings:error:"+i)?t.t("settings:error:"+i):t.t("settings:error:failure");s.msg.show({type:"error",time:3e3,text:r})}),a.done(function(){t.trigger("settings",{prodLine:{_id:o.prodLineId,name:o.prodLineName},station:o.station,prefixFilterMode:o.prefixFilterMode,prefixFilter:o.prefixFilter,spigotCheck:o.spigotCheck})}),a.always(function(){i.prop("disabled",!1).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-save")})},setUpProdLineSelect2:function(){var t=this,i=new a(null,{rqlQuery:"deactivatedAt=null&sort(_id)"});i.once("reset",function(){var r=t.$id("prodLineId");r.length&&(r.parent().addClass("has-required-select2"),r.removeClass("form-control").select2({data:i.map(function(e){return{id:e.id,text:e.id,description:e.get("description")}}),matcher:function(e,t,i){return e=e.toUpperCase(),-1!==t.toUpperCase().indexOf(e)||-1!==i.description.toUpperCase().indexOf(e)},formatResult:function(t){var i='<div class="kaizenOrders-select2">';return i+="<p><strong>"+e.escape(t.id)+"</strong><br>",i+=e.escape(t.description)+"</p>",i+="</div>"}}))}),this.promised(i.fetch({reset:!0}))},prepareProdLineName:function(e){return e.replace(/_/g," ").replace(/\s+/," ").replace(/~.*?$/,"").trim()},onDialogShown:function(){this.$id("prodLineId").focus()}})});