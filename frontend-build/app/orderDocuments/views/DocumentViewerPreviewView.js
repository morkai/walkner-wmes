define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/core/util/embedded","app/orderDocuments/templates/preview","app/orderDocuments/templates/documentWindow"],function(e,t,i,o,r,n,s,a){"use strict";return r.extend({template:s,initialize:function(){this.showMarksCounter=0,this.$iframe=null,this.listenTo(this.model,"change:localFile change:localOrder change:remoteOrder",e.debounce(this.onOrderChange.bind(this),1,!0)),this.listenTo(this.model,"marksRequested",this.onMarksRequested),this.timers.blurIframe=setInterval(this.blurIframe.bind(this),333)},destroy:function(){this.$iframe.remove(),this.$iframe=null},afterRender:function(){this.$iframe=this.$id("iframe"),this.resize(null,window.innerHeight),this.loadDocument()},openDocumentWindow:function(){var e=this.model.getCurrentOrderInfo(),t=.95*window.innerWidth,r=.95*window.innerHeight,n=Math.floor((window.innerWidth-t)/2),s="resizable,scrollbars,location=no,top="+Math.floor((window.innerHeight-r)/2)+",left="+n+",width="+Math.floor(t)+",height="+Math.floor(r),l=window.open("",e.documentNc15,s);l?(l.document.write(a({title:e.documentName,src:this.$iframe.attr("src")})),l.document.close()):o.msg.show({type:"error",time:3e3,text:i("orderDocuments","popup:document")})},loadDocument:function(){if(this.$iframe){var e=this.$id("loading").removeClass("hidden is-failure");this.$iframe.prop("src","");var t=this.model.get("localFile");if(t)return this.model.setFileSource("local"),this.setLoadingMessage("localFile"),void this.loadFile(URL.createObjectURL(t.file));var i=this.model.getCurrentOrder();if(!i.nc15)return this.model.setFileSource(null),void e.addClass("hidden");this.tryLoadRemoteDocument(i.nc15)}},resize:function(e,t){null!==this.$iframe&&(null!==e&&this.$iframe.prop("width",e+"px"),null!==t&&this.$iframe.prop("height",t+"px"))},blurIframe:function(){this.$iframe&&document.activeElement===this.$iframe[0]&&this.$iframe.blur()},onOrderChange:function(){this.loadDocument()},loadFile:function(e){var t=this;this.$iframe.one("load",function(){t.$id("loading").addClass("hidden"),t.trigger("loadDocument:success",e)}),this.$iframe.prop("src",e)},tryLoadRemoteDocument:function(e){var t=this;if(t.model.setFileSource("remote"),t.setLoadingMessage("remoteServer"),"ORDER"===e)return t.loadFile(window.location.pathname+window.location.search+"#orders/"+t.model.getCurrentOrder().no);var i=t.model.getRemoteFileUrl(e)+"?"+t.getRemoteFileUrlQuery();t.req&&t.req.abort(),t.req=this.ajax({type:"HEAD",url:i}),t.req.fail(function(){t.req=null,t.$id("loading").addClass("is-failure"),t.model.setFileSource(null),t.trigger("loadDocument:failure")}),t.req.done(function(e,o,r){var n=r.getResponseHeader("X-Document-Source");n&&t.model.setFileSource(n),t.req=null,t.loadFile(i)})},setLoadingMessage:function(e){this.$id("message").text(i("orderDocuments","preview:msg:loading:"+e))},getRemoteFileUrlQuery:function(){var e="order="+(this.model.getCurrentOrder().no||"")+"&w="+this.$iframe.width()+"&h="+this.$iframe.height();return n.isEnabled()||(e+="&pdf=1"),e},onMarksRequested:function(e){var t=this.model.getCurrentOrder();e.nc15!==t.nc15?(this.model.selectDocument(e.nc15),this.showMarksAfterLoad(e.page,e.marks)):this.showMarks(e.page,e.marks)},showMarks:function(e,t){if(this.$iframe){var i=this.$iframe[0].contentWindow;i.showMarks&&i.showMarks(t,e)}},showMarksAfterLoad:function(e,t){var i=this,o=++i.showMarksCounter;function r(){s(),i.showMarksCounter===o&&i.showMarks(e,t)}function n(){s()}function s(){i.off("loadDocument:success",r),i.off("loadDocument:failure",n)}i.on("loadDocument:success",r),i.on("loadDocument:failure",n)}})});