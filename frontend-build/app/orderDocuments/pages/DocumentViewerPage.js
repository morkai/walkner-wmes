// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/user","app/core/View","../views/DocumentViewerControlsView","../views/DocumentViewerPreviewView","app/orderDocuments/templates/page"],function(e,i,o,t,n,s,r){"use strict";return t.extend({template:r,layoutName:"blank",localTopics:{"socket.connected":"onConnectionStatusChange","socket.disconnected":"onConnectionStatusChange"},initialize:function(){this.$els={controls:null,viewer:null},this.controlsView=new n({model:this.model}),this.previewView=new s({model:this.model}),this.setView(".orderDocuments-page-controls",this.controlsView),this.setView(".orderDocuments-page-preview",this.previewView),i(window).on("resize."+this.idPrefix,e.debounce(this.resize.bind(this),1)),i(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)),this.listenTo(this.model,"change:prodLine",this.joinProdLine),this.listenTo(this.controlsView,"documentReloadRequested",this.previewView.loadDocument.bind(this.previewView)),this.socket.on("orderDocuments.remoteOrderUpdated",this.onRemoteOrderUpdated.bind(this))},destroy:function(){i("body").removeClass("no-overflow orderDocuments"),i(window).off("."+this.idPrefix)},load:function(e){return this.model.load(),e()},afterRender:function(){this.$els.controls=this.$id("controls"),this.$els.viewport=this.$id("viewport"),i("body").addClass("no-overflow orderDocuments"),this.toggleConnectionStatus(),this.resize()},resize:function(){this.controlsView.resize(null,window.innerHeight),this.previewView.resize(null,window.innerHeight)},toggleConnectionStatus:function(){this.$el.removeClass("is-connected is-disconnected").addClass(this.socket.isConnected()?"is-connected":"is-disconnected")},joinProdLine:function(){if(this.socket.isConnected()){var e=this.model.get("prodLine");e._id&&this.socket.emit("orderDocuments.join",{clientId:this.model.id,prodLineId:e._id})}},onKeyDown:function(e){return e.ctrlKey&&70===e.keyCode?(this.controlsView.focusFilter(),!1):void(27===e.keyCode&&(this.controlsView.clearFilter(),this.controlsView.scrollIntoView()))},onConnectionStatusChange:function(){this.toggleConnectionStatus(),this.joinProdLine()},onRemoteOrderUpdated:function(e){this.model.setRemoteOrder(e),this.model.save()}})});