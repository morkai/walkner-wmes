define(["underscore","jquery","app/i18n","app/user","app/core/View","app/core/util/embedded","app/production/snManager","../views/DocumentViewerControlsView","../views/DocumentViewerPreviewView","../views/BomView","app/orderDocuments/templates/page"],function(e,o,i,t,n,s,d,r,c,l,h){"use strict";var u=window.navigator.userAgent.match(/(Chrome)\/([0-9]+)/)||["Unknown/0","Unknown",0];return n.extend({template:h,layoutName:"blank",localTopics:{"socket.connected":"onConnectionStatusChange","socket.disconnected":"onConnectionStatusChange"},remoteTopics:{"orderDocuments.remoteChecked.*":"onRemoteDocumentChecked","orderDocuments.eto.synced":"onEtoSynced","compRel.orders.updated.*":"onCompRelOrderUpdated"},initialize:function(){this.loadedFilesCount=0,this.$els={controls:null,viewer:null},this.defineViews(),this.defineBindings(),d.bind(this),this.setView("#-controls",this.controlsView),this.setView("#-preview",this.previewView),this.setView("#-bom",this.bomView)},defineViews:function(){this.controlsView=new r({model:this.model}),this.previewView=new c({model:this.model}),this.bomView=new l({model:this.model})},defineBindings:function(){var i=this,t=e.debounce(i.updateClientState.bind(i),1e3),n=e.debounce(i.joinProdLine.bind(i),1);i.listenTo(i.model,"change:prodLine change:station",n),i.listenTo(i.model,"change:prodLine",i.onProdLineChanged),i.listenTo(i.model,"change:spigotCheck",i.defineSpigotBindings),i.listenTo(i.model,"change:bom",i.onBomChanged),i.listenTo(i.model,"save",function(){t(),i.model.isBomActive()&&!i.model.isConfirmableDocumentSelected()||i.model.set("bom",null)}),i.listenTo(i.controlsView,"documentReloadRequested",i.previewView.loadDocument.bind(i.previewView)),i.listenTo(i.controlsView,"documentWindowRequested",setTimeout.bind(window,i.previewView.openDocumentWindow.bind(i.previewView),1)),i.listenTo(i.previewView,"loadDocument:success",i.onFileLoaded),i.socket.on("orderDocuments.remoteOrderUpdated",i.onRemoteOrderUpdated.bind(i)),i.defineSpigotBindings(),o(window).on("resize."+i.idPrefix,e.debounce(i.resize.bind(i),1)),o(window).on("keydown."+i.idPrefix,i.onKeyDown.bind(i)),s.isEnabled()&&(o(window).on("contextmenu."+i.idPrefix,function(e){e.preventDefault()}),i.cancelPinchZoom=function(e){e.touches&&e.touches.length>1&&e.preventDefault()},window.addEventListener("touchstart",i.cancelPinchZoom,{passive:!1}))},defineSpigotBindings:function(){var e=this.model.get("prodLine")._id;if(e&&this.model.get("spigotCheck")){if(this.spigotCheckSub){if(this.spigotCheckSub.prodLineId===e)return;this.spigotCheckSub.cancel()}this.spigotCheckSub=this.pubsub.subscribe("production.spigotCheck.*."+e,this.onSpigotMessage.bind(this)),this.spigotCheckSub.prodLineId=e}else this.spigotCheckSub&&(this.spigotCheckSub.cancel(),this.spigotCheckSub=null)},destroy:function(){o("body").removeClass("no-overflow orderDocuments"),o(window).off("."+this.idPrefix),this.cancelPinchZoom&&window.removeEventListener("touchstart",this.cancelPinchZoom)},load:function(e){return e(this.model.load())},afterRender:function(){this.$els.controls=this.$id("controls"),this.$els.viewport=this.$id("viewport"),o("body").addClass("no-overflow orderDocuments"),this.toggleConnectionStatus(),this.resize(),this.checkInitialConfig(),s.isEnabled()&&(window.WMES_DOCS_BOM_TOGGLE=this.toggleBom.bind(this),window.WMES_DOCS_BOM_ACTIVE=this.model.isBomActive.bind(this.model),window.WMES_DOCS_BOM_MARKS=this.getBomMarks.bind(this),this.onBomChanged(),window.parent.postMessage({type:"ready",app:"documents"},"*"))},resize:function(){this.controlsView.resize(null,window.innerHeight),this.previewView.resize(null,window.innerHeight),this.resizeBom()},resizeBom:function(){var e=this.controlsView.$id("filterForm")[0],o=e?e.offsetTop:0;this.$id("bom").css("height",window.innerHeight-o+1+"px")},toggleConnectionStatus:function(){this.$el.removeClass("is-connected is-disconnected").addClass(this.socket.isConnected()?"is-connected":"is-disconnected")},joinProdLine:function(){if(this.socket.isConnected()){var e=this.model,o=e.get("prodLine");o._id&&(this.socket.emit("orderDocuments.join",{clientId:e.id,prodLineId:o._id,station:e.get("station"),settings:e.getSettings(),orderInfo:e.getCurrentOrderInfo()}),this.defineSpigotBindings())}},updateClientState:function(){this.socket.isConnected()&&this.socket.emit("orderDocuments.update",{clientId:this.model.id,settings:this.model.getSettings(),orderInfo:this.model.getCurrentOrderInfo()})},checkInitialConfig:function(){this.model.get("prodLine")._id||this.controlsView.openSettingsDialog()},onSpigotMessage:function(e,o){switch(o.split(".")[2]){case"requested":this.onSpigotRequested(e);break;case"failure":this.onSpigotFailure(e);break;case"success":this.onSpigotSuccess(e);break;case"aborted":this.onSpigotAborted()}},scheduleSpigotMessageHideTimer:function(){var e=this;clearTimeout(e.timers.hideSpigotMessage),e.timers.hideSpigotMessage=setTimeout(function(){e.skipNextSpigotRequest=!1,e.onSnScanned=null,d.hideMessage()},7500)},onSpigotAborted:function(){clearTimeout(this.timers.hideSpigotMessage),this.skipNextSpigotRequest=!1,this.onSnScanned=null,d.hideMessage()},onSpigotRequested:function(e){this.onSnScanned=this.onSpigotScanned.bind(this),this.skipNextSpigotRequest?this.skipNextSpigotRequest=!1:d.showMessage({_id:"",orderNo:e.orderNo},"warning",function(){return i("orderDocuments","spigot:request",{component:e.component?e.component.name:"?"})},15e3),this.scheduleSpigotMessageHideTimer()},onSpigotFailure:function(e){this.skipNextSpigotRequest=!0,d.showMessage({_id:e.input,orderNo:e.orderNo},"error",function(){return i("orderDocuments","spigot:failure")},15e3),this.scheduleSpigotMessageHideTimer()},onSpigotSuccess:function(e){this.skipNextSpigotRequest=!0,d.showMessage({_id:e.input,orderNo:e.orderNo},"success",function(){return i("orderDocuments","spigot:success")},"spigotChecker"===e.source?3e3:15e3),this.scheduleSpigotMessageHideTimer()},onSpigotScanned:function(e){this.skipNextSpigotRequest=!0,d.showMessage({_id:e._id},"warning",function(){return i("orderDocuments","spigot:checking")},15e3),this.pubsub.publish("production.spigotCheck.scanned."+this.model.get("prodLine")._id,{nc12:e._id}),this.scheduleSpigotMessageHideTimer()},onKeyDown:function(e){if(!s.isEnabled())return e.ctrlKey&&70===e.keyCode?(this.controlsView.focusFilter(),!1):void(27===e.keyCode&&(this.controlsView.clearFilter(),this.controlsView.scrollIntoView()))},onConnectionStatusChange:function(){this.toggleConnectionStatus(),this.joinProdLine()},onRemoteOrderUpdated:function(e){null!==e.no&&(this.model.setRemoteOrder(e),this.model.save())},onRemoteDocumentChecked:function(e){null===this.model.get("localFile")&&(this.model.getCurrentOrder().nc15===e.nc15&&this.previewView.loadDocument())},onEtoSynced:function(e){var o=this.model.getCurrentOrder();"ETO"!==o.nc15||o.nc12!==e.nc12?this.model.checkEtoExistence(e.nc12):this.previewView.loadDocument()},onFileLoaded:function(){this.controlsView.checkNotes(),"Chrome"!==u[1]||u[2]>=49||(this.loadedFilesCount+=1,6===this.loadedFilesCount&&this.listenTo(this.model,"change:localFile change:localOrder change:remoteOrder",function(){var e=this.model.get("fileSource");if("remote"===e||"local"===e)return setTimeout(window.location.reload.bind(window.location),10)}))},getBomMarks:function(e){var o=this;o.loadBom(function(i){if(i)return e(i,[]);var t=o.model.get("bom"),n=o.model.getCurrentDocumentNc15(),s=[];t.components.forEach(function(e){var o=e.marks[n];o&&o.forEach(function(o){s.push(Object.assign({label:e.name,code:e.nc12},o))})}),e(null,s)})},toggleBom:function(e,o){if(!this.model.getCurrentOrder().no)return o(!0);this.model.isConfirmableDocumentSelected()?e=!1:null===e&&(e=!this.model.isBomActive()),e?this.showBom(o):this.hideBom(o)},loadBom:function(e){var o=this;if(o.model.isBomAvailable())e&&e();else{var i=o.model.getCurrentOrder(),t=o.ajax({url:"/orders/"+i.no+"/documentContents?result=bom"});t.fail(function(){e&&e(!0)}),t.done(function(t){t.active=!1,t.orderNo=i.no,o.model.set("bom",t),e&&e()})}},hideBom:function(o){var i=this.model.get("bom");i&&i.active&&(i=e.defaults({active:!1},i),this.model.set("bom",i)),o&&o()},showBom:function(o){var i=this;if(i.model.isBomActive())o&&o();else{if(i.model.isBomAvailable()){var t=e.defaults({active:!0},this.model.get("bom"));return i.model.set("bom",t),void(o&&o())}i.loadBom(function(e){e?i.hideBom(o):i.showBom(o)})}},onBomChanged:function(){var e=this.model.isBomActive(),o=this.previewView.$iframe;o&&o.length&&o[0].contentWindow.toggleBom&&o[0].contentWindow.toggleBom(e),e&&(this.resizeBom(),this.bomView.render()),this.$id("bom").toggleClass("hidden",!e)},onProdLineChanged:function(){this.setUpConfirmedSub()},setUpConfirmedSub:function(){this.confirmedSub&&(this.confirmedSub.cancel(),this.confirmedSub=null);var e=this.model.get("prodLine")._id;e&&(this.confirmedSub=this.pubsub.subscribe("orderDocuments.confirmed."+e,this.onDocumentConfirmed.bind(this)))},onDocumentConfirmed:function(e){this.model.handleConfirmation(e)},onCompRelOrderUpdated:function(e){[this.model.get("localOrder"),this.model.get("remoteOrder")].forEach(function(o){o.no===e.orderNo&&(o.compRels=e.compRels)});var o=this.model.getCurrentOrderInfo();o.orderNo!==e.orderNo||"BOM"!==o.documentNc15&&o.documentNc15!==i(this.nlsDomain,"compRel")||this.previewView.loadDocument()}})});