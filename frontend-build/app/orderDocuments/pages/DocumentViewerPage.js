// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","hammer","app/user","app/core/View","../views/DocumentViewerControlsView","../views/DocumentViewerPreviewView","app/orderDocuments/templates/page"],function(e,t,i,o,n,s,d,r){"use strict";var c=window.navigator.userAgent.match(/(Chrome)\/([0-9]+)/)||["Unknown/0","Unknown",0];return n.extend({template:r,layoutName:"blank",localTopics:{"socket.connected":"onConnectionStatusChange","socket.disconnected":"onConnectionStatusChange"},remoteTopics:{"orderDocuments.remoteChecked.*":"onRemoteDocumentChecked","orderDocuments.eto.synced":"onEtoSynced"},initialize:function(){this.loadedFilesCount=0,this.hammer=null,this.$els={controls:null,viewer:null},this.controlsView=new s({model:this.model}),this.previewView=new d({model:this.model}),this.setView("#"+this.idPrefix+"-controls",this.controlsView),this.setView("#"+this.idPrefix+"-preview",this.previewView),t(window).on("resize."+this.idPrefix,e.debounce(this.resize.bind(this),1)),t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)),window.parent!==window&&t(window).on("contextmenu."+this.idPrefix,function(e){e.preventDefault()}),this.listenTo(this.model,"change:prodLine",this.joinProdLine),this.listenTo(this.model,"save",e.debounce(this.updateClientState.bind(this),1e3)),this.listenTo(this.controlsView,"documentReloadRequested",this.previewView.loadDocument.bind(this.previewView)),this.listenTo(this.controlsView,"documentWindowRequested",setTimeout.bind(window,this.previewView.openDocumentWindow.bind(this.previewView),1)),this.listenTo(this.previewView,"fileLoaded",this.onFileLoaded),this.socket.on("orderDocuments.remoteOrderUpdated",this.onRemoteOrderUpdated.bind(this))},destroy:function(){t("body").removeClass("no-overflow orderDocuments"),t(window).off("."+this.idPrefix),this.hammer&&(this.hammer.destroy(),this.hammer=null)},load:function(e){return this.model.load(),e()},beforeRender:function(){this.hammer&&(this.hammer.destroy(),this.hammer=null)},afterRender:function(){this.$els.controls=this.$id("controls"),this.$els.viewport=this.$id("viewport"),t("body").addClass("no-overflow orderDocuments"),this.toggleConnectionStatus(),this.resize(),this.checkInitialConfig(),window.parent!==window&&(this.hammer=new i(document.body),this.hammer.on("swipe",function(e){e.deltaX>0&&window.parent.postMessage({type:"switch",app:"documents"},"*")}),window.parent.postMessage({type:"ready",app:"documents"},"*"))},resize:function(){this.controlsView.resize(null,window.innerHeight),this.previewView.resize(null,window.innerHeight)},toggleConnectionStatus:function(){this.$el.removeClass("is-connected is-disconnected").addClass(this.socket.isConnected()?"is-connected":"is-disconnected")},joinProdLine:function(){if(this.socket.isConnected()){var e=this.model,t=e.get("prodLine");t._id&&this.socket.emit("orderDocuments.join",{clientId:e.id,prodLineId:t._id,settings:e.getSettings(),orderInfo:e.getCurrentOrderInfo()})}},updateClientState:function(){this.socket.isConnected()&&this.socket.emit("orderDocuments.update",{clientId:this.model.id,settings:this.model.getSettings(),orderInfo:this.model.getCurrentOrderInfo()})},checkInitialConfig:function(){this.model.get("prodLine")._id||this.controlsView.openSettingsDialog()},onKeyDown:function(e){if(e.ctrlKey&&70===e.keyCode)return this.controlsView.focusFilter(),!1;27===e.keyCode&&(this.controlsView.clearFilter(),this.controlsView.scrollIntoView())},onConnectionStatusChange:function(){this.toggleConnectionStatus(),this.joinProdLine()},onRemoteOrderUpdated:function(e){null!==e.no&&(this.model.setRemoteOrder(e),this.model.save())},onRemoteDocumentChecked:function(e){if(null===this.model.get("localFile")){this.model.getCurrentOrder().nc15===e.nc15&&this.previewView.loadDocument()}},onEtoSynced:function(e){var t=this.model.getCurrentOrder();if("ETO"===t.nc15&&t.nc12===e.nc12)return void this.previewView.loadDocument();this.model.checkEtoExistence(e.nc12)},onFileLoaded:function(){"Chrome"!==c[1]||c[2]>=49||(this.loadedFilesCount+=1,6===this.loadedFilesCount&&this.listenTo(this.model,"change:localFile change:localOrder change:remoteOrder",function(){var e=this.model.get("fileSource");if("remote"===e||"local"===e)return setTimeout(window.location.reload.bind(window.location),10)}))}})});