define(["underscore","jquery","app/user","app/core/View","app/core/util/embedded","app/production/snManager","../views/DocumentViewerControlsView","../views/DocumentViewerPreviewView","../views/BomView","app/orderDocuments/templates/page"],function(e,o,i,t,n,s,d,r,l,c){"use strict";var m=window.navigator.userAgent.match(/(Chrome)\/([0-9]+)/)||["Unknown/0","Unknown",0];return t.extend({template:c,layoutName:"blank",localTopics:{"socket.connected":"onConnectionStatusChange","socket.disconnected":"onConnectionStatusChange"},remoteTopics:{"orderDocuments.remoteChecked.*":"onRemoteDocumentChecked","orderDocuments.eto.synced":"onEtoSynced"},initialize:function(){this.loadedFilesCount=0,this.$els={controls:null,viewer:null},this.defineViews(),this.defineBindings(),s.bind(this),this.setView("#-controls",this.controlsView),this.setView("#-preview",this.previewView),this.setView("#-bom",this.bomView)},defineViews:function(){this.controlsView=new d({model:this.model}),this.previewView=new r({model:this.model}),this.bomView=new l({model:this.model})},defineBindings:function(){var i=this,t=e.debounce(i.updateClientState.bind(i),1e3);i.listenTo(i.model,"change:prodLine",i.joinProdLine),i.listenTo(i.model,"change:bom",i.onBomChanged),i.listenTo(i.model,"save",function(){t(),i.model.isBomActive()||i.model.set("bom",null)}),i.listenTo(i.controlsView,"documentReloadRequested",i.previewView.loadDocument.bind(i.previewView)),i.listenTo(i.controlsView,"documentWindowRequested",setTimeout.bind(window,i.previewView.openDocumentWindow.bind(i.previewView),1)),i.listenTo(i.previewView,"loadDocument:success",i.onFileLoaded),i.socket.on("orderDocuments.remoteOrderUpdated",i.onRemoteOrderUpdated.bind(i)),o(window).on("resize."+i.idPrefix,e.debounce(i.resize.bind(i),1)),o(window).on("keydown."+i.idPrefix,i.onKeyDown.bind(i)),n.isEnabled()&&o(window).on("contextmenu."+i.idPrefix,function(e){e.preventDefault()})},destroy:function(){o("body").removeClass("no-overflow orderDocuments"),o(window).off("."+this.idPrefix)},load:function(e){return this.model.load(),e()},afterRender:function(){this.$els.controls=this.$id("controls"),this.$els.viewport=this.$id("viewport"),o("body").addClass("no-overflow orderDocuments"),this.toggleConnectionStatus(),this.resize(),this.checkInitialConfig(),n.isEnabled()&&(window.WMES_DOCS_BOM_TOGGLE=this.toggleBom.bind(this),window.WMES_DOCS_BOM_ACTIVE=this.model.isBomActive.bind(this.model),this.onBomChanged(),window.parent.postMessage({type:"ready",app:"documents"},"*"))},resize:function(){this.controlsView.resize(null,window.innerHeight),this.previewView.resize(null,window.innerHeight),this.resizeBom()},resizeBom:function(){var e=this.controlsView.$id("filterForm")[0],o=e?e.offsetTop:0;this.$id("bom").css("height",window.innerHeight-o+1+"px")},toggleConnectionStatus:function(){this.$el.removeClass("is-connected is-disconnected").addClass(this.socket.isConnected()?"is-connected":"is-disconnected")},joinProdLine:function(){if(this.socket.isConnected()){var e=this.model,o=e.get("prodLine");o._id&&this.socket.emit("orderDocuments.join",{clientId:e.id,prodLineId:o._id,settings:e.getSettings(),orderInfo:e.getCurrentOrderInfo()})}},updateClientState:function(){this.socket.isConnected()&&this.socket.emit("orderDocuments.update",{clientId:this.model.id,settings:this.model.getSettings(),orderInfo:this.model.getCurrentOrderInfo()})},checkInitialConfig:function(){this.model.get("prodLine")._id||this.controlsView.openSettingsDialog()},onKeyDown:function(e){if(e.ctrlKey&&70===e.keyCode)return this.controlsView.focusFilter(),!1;27===e.keyCode&&(this.controlsView.clearFilter(),this.controlsView.scrollIntoView())},onConnectionStatusChange:function(){this.toggleConnectionStatus(),this.joinProdLine()},onRemoteOrderUpdated:function(e){null!==e.no&&(this.model.setRemoteOrder(e),this.model.save())},onRemoteDocumentChecked:function(e){null===this.model.get("localFile")&&(this.model.getCurrentOrder().nc15===e.nc15&&this.previewView.loadDocument())},onEtoSynced:function(e){var o=this.model.getCurrentOrder();"ETO"!==o.nc15||o.nc12!==e.nc12?this.model.checkEtoExistence(e.nc12):this.previewView.loadDocument()},onFileLoaded:function(){"Chrome"!==m[1]||m[2]>=49||(this.loadedFilesCount+=1,6===this.loadedFilesCount&&this.listenTo(this.model,"change:localFile change:localOrder change:remoteOrder",function(){var e=this.model.get("fileSource");if("remote"===e||"local"===e)return setTimeout(window.location.reload.bind(window.location),10)}))},toggleBom:function(e,o){if(!this.model.getCurrentOrder().no)return o(!0);null===e&&(e=!this.model.isBomActive()),e?this.showBom(o):this.hideBom(o)},hideBom:function(o){var i=this.model.get("bom");i&&i.active&&(i=e.defaults({active:!1},i),this.model.set("bom",i)),o&&o()},showBom:function(o){var i=this;if(i.model.isBomActive())o&&o();else{if(i.model.isBomAvailable()){var t=e.defaults({active:!0},this.model.get("bom"));return i.model.set("bom",t),void(o&&o())}var n=i.model.getCurrentOrder(),s=i.ajax({url:"/orders/"+n.no+"/documentContents?result=bom"});s.fail(function(){i.hideBom(function(){o&&o(!0)})}),s.done(function(e){e.active=!0,e.orderNo=n.no,i.model.set("bom",e),o&&o()})}},onBomChanged:function(){var e=this.model.isBomActive(),o=this.previewView.$iframe;o&&o.length&&o[0].contentWindow.toggleBom&&o[0].contentWindow.toggleBom(e),e&&(this.resizeBom(),this.bomView.render()),this.$id("bom").toggleClass("hidden",!e)}})});