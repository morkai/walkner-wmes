// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user","app/core/util/bindLoadingMessage","app/core/View","app/orders/Order","app/orders/views/OrderDetailsView","app/delayReasons/storage","../views/XiconfOrderDetailsView","app/xiconfOrders/templates/detailsPage"],function(e,r,i,s,t,n,d,o,a,l){"use strict";return t.extend({template:l,layoutName:"page",remoteTopics:function(){function r(){this.promised(this.model.fetch())}var i={},s=e.debounce(r.bind(this),1e3);return i["xiconf.orders.synced"]=s,i["xiconf.orders."+this.model.id+".*"]=s,i},breadcrumbs:function(){return[r.bound("xiconfOrders","BREADCRUMBS:base"),{label:r.bound("xiconfOrders","BREADCRUMBS:browse"),href:this.model.genClientUrl("base")},this.model.id]},initialize:function(){this.parentOrder=new n(this.model.id),this.order=s(this.model,this),this.delayReasons=s(o.acquire(),this),this.parentOrderDetailsView=new d({panelTitle:r("xiconfOrders","PANEL:TITLE:details:parentOrder"),linkOrderNo:i.isAllowedTo("ORDERS:VIEW"),model:this.parentOrder,delayReasons:this.delayReasons}),this.orderDetailsView=new a({model:this.model}),this.setView(".xiconfOrders-parentOrderDetailsContainer",this.parentOrderDetailsView),this.setView(".xiconfOrders-orderDetailsContainer",this.orderDetailsView)},destroy:function(){o.release()},load:function(e){var r=this,i=this.order.fetch({url:this.order.url()+"?exclude(items.serialNumbers)"});return i.done(function(){r.parentOrder.set(r.order.get("parentOrder"))}),e(i,this.delayReasons.isEmpty()?this.delayReasons.fetch({reset:!0}):null)},afterRender:function(){o.acquire()}})});