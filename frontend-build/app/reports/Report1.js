// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../data/aors","../data/downtimeReasons","../core/Model"],function(e,t,o,r,n){return n.extend({urlRoot:"/reports/1",defaults:function(){return{orgUnitType:null,orgUnit:null,coeffs:{quantityDone:[],downtime:[],efficiency:[],productivity:[]},downtimesByAor:[],downtimesByReason:[]}},initialize:function(e,t){if(!t.query)throw new Error("query option is required!");this.query=t.query},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.extend(t.data||{},this.query.serializeToObject(this.get("orgUnitType"),this.get("orgUnit"))),n.prototype.fetch.call(this,t)},parse:function(e){return{coeffs:this.parseCoeffs(e.coeffs),downtimesByAor:this.parseDowntimesByAor(e.downtimes.byAor).sort(this.sortByValueDesc),downtimesByReason:this.parseDowntimesByReason(e.downtimes.byReason).sort(this.sortByValueDesc)}},parseCoeffs:function(e){var t={quantityDone:[],downtime:[],efficiency:[],productivity:[]};return e.forEach(function(e){var o=Date.parse(e.key);t.quantityDone.push({x:o,y:e.quantityDone||0}),t.downtime.push({x:o,y:Math.round(100*(e.downtime||0))}),t.efficiency.push({x:o,y:Math.round(100*(e.efficiency||0))}),t.productivity.push({x:o,y:Math.round(100*(e.productivity||0))})}),t},parseDowntimesByAor:function(e){var r=[];return e&&Object.keys(e).forEach(function(n){var i,s;if("null"===n)i=t("reports","downtimesByAor:press:longText"),s=t("reports","downtimesByAor:press:shortText");else{var u=o.get(n);i=u?u.getLabel():n;var a=i.indexOf("-");s=-1===a?i>13?i.substr(0,10).trim()+"...":i:i.substr(0,a).trim()}r.push({key:n,longText:i,shortText:s,value:Math.round(100*e[n])/100})}),r},parseDowntimesByReason:function(e){var t=[];return e&&Object.keys(e).forEach(function(o){var n=r.get(o);t.push({key:o,longText:n?n.getLabel():o,shortText:o,value:Math.round(100*e[o])/100})}),t},sortByValueDesc:function(e,t){return t.value-e.value}})});