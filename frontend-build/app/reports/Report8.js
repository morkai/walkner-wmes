// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../time","../data/companies","../data/prodFunctions","../data/aors","../data/colorFactory","../core/Model"],function(r,e,t,n,o,i,a){"use strict";return a.extend({urlRoot:"/reports/8",initialize:function(r,e){if(!e.query)throw new Error("query option is required!");this.query=e.query},fetch:function(e){return r.isObject(e)||(e={}),e.data=r.extend(e.data||{},this.query.serializeToObject()),a.prototype.fetch.call(this,e)},parse:function(r){return r.groups=this.parseGroups(r.groups,Object.keys(r.summary.downtimeByAor)),r},parseGroups:function(e,t){var n={totalVolumeProduced:[],prodBasedPlanners:[],prodQualityInspection:[],prodOperators:[],prodSetters:[],masters:[],leaders:[],prodMaterialHandling:[],kitters:[],prodTransport:[],cycleCounting:[],otherWarehousing:[],materialQualityInspection:[],maintenance:[],timeAvailablePerShift:[],routingTimeForLine:[],routingTimeForLabour:[],heijunkaTimeForLine:[],breaks:[],fap0:[],startup:[],shutdown:[],meetings:[],sixS:[],tpm:[],trainings:[],coTime:[],downtime:[],plan:[],efficiency:[]},o={totalVolumeProduced:[],averageRoutingTime:[],prodBasedPlanners:[],prodQualityInspection:[],prodOperators:[],prodSetters:[],masters:[],leaders:[],prodMaterialHandling:[],kitters:[],prodTransport:[],cycleCounting:[],otherWarehousing:[],materialQualityInspection:[],maintenance:[],timeAvailablePerShift:[],routingTimeForLine:[],routingTimeForLabour:[],breaks:[],fap0:[],startup:[],shutdown:[],meetings:[],sixS:[],tpm:[],trainings:[],coTime:[],downtime:[],plan:[],efficiency:[]},i=Object.keys(n),a=Object.keys(o);return r.forEach(t,function(r){o[r]=[]}),r.forEach(e,function(e){var u=e.key;r.forEach(i,function(r){var t=e[r];n[r].push({x:u,y:"number"==typeof t?t:t[0]})}),r.forEach(a,function(r){var t=e[r];o[r].push({x:u,y:"number"==typeof t?t:t[1]})}),r.forEach(t,function(r){var t=e.downtimeByAor[r];o[r].push({x:u,y:t||0})})}),{plan:n,real:o}},getColor:function(r,e){return i.getColor("lean:"+r,e)},serializeToCsv:function(){function t(r){return r?(Math.round(1e3*r)/1e3).toLocaleString().replace(/\s+/g,""):"0"}function n(){return i.map(function(r){return r.join(";")}).join("\r\n")}var i=[],a=["date"].concat(this.query.constructor.SERIES),u=this.get("summary"),s=this.get("groups");if(i.push(a),!u)return n();var c=[];r.forEach(u.downtimeByAor,function(r,e){c.push(e),i[0].push('"'+o.get(e).getLabel()+'"')});var p=r.map(this.query.constructor.SERIES,function(r){var e=r.split(":");return{id:e[0],kind:e[1]}}),d=[""];return r.forEach(p,function(r){var e=u[r.id];"number"!=typeof e&&(e=e["plan"===r.kind?0:1]),d.push(t(e))}),r.forEach(c,function(r){d.push(t(u.downtimeByAor[r]))}),i.push([],d,[]),r.forEach(s.plan.totalVolumeProduced,function(n,o){var a=[e.format(n.x,"YYYY-MM-DD HH:mm:ss")];r.forEach(p,function(r){a.push(t(s[r.kind][r.id][o].y))}),r.forEach(c,function(r){a.push(t(s.real[r][o].y))}),i.push(a)}),n()}})});