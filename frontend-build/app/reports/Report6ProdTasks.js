// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../data/orgUnits","../prodTasks/ProdTaskCollection"],function(t,e,n,i){"use strict";var r={exTransactions:"qty",inTransactions:"qty",coopComp:"qty",exStorage:"qty",fifo:"fte"};return i.extend({initialize:function(t,e){if(!e.settings)throw new Error("settings option is required!");this.settings=e.settings},parse:function(e){var i=n.getByTypeAndId("subdivision",this.settings.getValue("wh.comp.id")),r=n.getByTypeAndId("subdivision",this.settings.getValue("wh.finGoods.id")),s=(i?i.get("prodTaskTags"):null)||[],o=(r?r.get("prodTaskTags"):null)||[];return e.collection.map(function(e){return e.inComp=t.intersection(e.tags,s).length>0,e.inFinGoods=t.intersection(e.tags,o).length>0,e}).filter(function(t){return t.inComp||t.inFinGoods})},createChartsConfiguration:function(){var e=[],n=this.prepareSpecialTasks();this.sort();for(var i=0;i<this.length;++i){var r=this.models[i];r.get("parent")||this.handleProdTask(e,n,r)}for(var s={},o=0;o<e.length;++o){var a=e[o],d=a[0].child;void 0===s[d]?s[d]=[a]:s[d].push(a)}return e=[[{kind:"totalAndAbsence",type:"total"},{kind:"category",type:"totalAbsence",unit:"fte"}],[{kind:"totalAndAbsence",type:"comp",parent:"comp"},{kind:"category",type:"compAbsence",unit:"fte"}],[{kind:"totalAndAbsence",type:"finGoods",parent:"finGoods"},{kind:"category",type:"finGoodsAbsence",unit:"fte"}]],t.forEach(s,function(t){t.sort(function(t,e){return t[0].parent?-1:e[0].parent?1:0});var n=-1,i=0,r=t.length-1;do{var s=n+1;for(n=-1;r>s;++s)if(t[s].length<2){n=s;break}if(-1===n)break;for(var o=r;o>n&&(1!==t[o].length||t[o][0].parent);)--o;o=t[o],o&&1===o.length&&!o[0].parent&&t[n].push(o.shift())}while(++i<100);e.push.apply(e,t)}),e.filter(function(t){return t.length>0})},prepareSpecialTasks:function(){var t={};return this.settings.forEach(function(e){var n=e.id.match(/^reports\.wh\.(.*?)\.prodTask$/);if(n){var i=e.getValue(),r=n[1];if(/Absence$/.test(n[1]))r="absence";else if("fifo"===r){var s=this.get(i);if(s){var o=this.get(s.get("parent"));o&&(t[o.id]="inTransactions")}}else if("inComp"===r){var a=this.get(i);if(a){var d=this.get(a.get("parent"));d&&(t[d.id]="exTransactions")}}t[i]=r}},this),t},handleProdTask:function(t,e,n){var i=e[n.id];"absence"!==i&&(n.get("inComp")&&t.push(this.createChartRows("comp",i,n)),n.get("inFinGoods")&&t.push(this.createChartRows("finGoods",i,n)),n.children.forEach(this.handleProdTask.bind(this,t,e)))},createChartRows:function(t,e,n){var i=n.get("parent"),s=[];return s.push({kind:"effAndFte",type:e||t+"-"+n.id,child:i||t,parent:n.children.length?n.id:null}),e&&r[e]&&s.push({kind:"category",type:e,unit:r[e]}),s}})});