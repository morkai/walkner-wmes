// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/highcharts","app/i18n","app/data/prodFunctions","app/core/View","../util/wordwrapTooltip"],function(i,e,t,s,r,o){"use strict";var n="#eeee00",a={absenceRef:!0,direct:!0,directRef:!0,indirect:!0,indirectRef:!0,warehouse:!0,warehouseRef:!0};return r.extend({className:function(){return"reports-chart reports-2-dirIndir"},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.series={dirIndir:null,reference:null,productivity:null,productivityNoWh:null,quantityDone:null},this.isLoading=!1,this.isFullscreen=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:dirIndir change:prodTasks change:prodFunctions",i.debounce(this.render,1)),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.listenTo(this.displayOptions,"change",i.debounce(this.onDisplayOptionsChange,1))},destroy:function(){this.series=null,null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},isReferenceVisible:function(i){return this.displayOptions.isSeriesVisible(i)&&this.displayOptions.isReferenceVisible(i)},updateChart:function(e,t){var s=this.serializeChartData(),r=this.series,o=this.displayOptions;if(this.chart.xAxis[0].setCategories(s.categories,!1),t!==!1&&this.updateExtremes(!1),Object.keys(r).forEach(function(i){r[i].setData(s[i],!1,!1,!1)},this),this.isFullscreen)r.reference.setVisible(!1,!1),r.productivity.setVisible(!1,!1),r.productivityNoWh.setVisible(!1,!1),r.quantityDone.setVisible(o.isSeriesVisible("quantityDone"),!1);else{var n=this.isReferenceVisible("direct")||this.isReferenceVisible("indirect")||this.isReferenceVisible("warehouse");n&&(n=i.any(s.reference,function(i){return i.y>0})),r.reference.setVisible(n,!1),r.productivity.setVisible(o.isSeriesVisible("productivity"),!1),r.productivityNoWh.setVisible(o.isSeriesVisible("productivityNoWh"),!1),r.quantityDone.setVisible(!1,!1)}e!==!1&&this.chart.redraw(!1)},updateExtremes:function(i){var e=!(this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes")),t=null,s=null;if(e){var r=this.displayOptions,o=r.isSeriesVisible("direct")||r.isSeriesVisible("indirect")||r.isSeriesVisible("warehouse"),n=r.isSeriesVisible("productivity")||r.isSeriesVisible("productivityNoWh");t=o?r.get("maxDirIndirFte"):null,s=n?r.get("maxDirIndirPercent"):null}this.chart.yAxis[0].setExtremes(0,t,!1,!1),this.chart.yAxis[1].setExtremes(0,s,i,!1)},onSettingsUpdate:function(i){a[i.getMetricName()]&&this.updateChart()},onDisplayOptionsChange:function(){var e=this.displayOptions.changedAttributes(),t=this.displayOptions.previousAttributes(),s=!1;(void 0!==e.maxDirIndirFte||void 0!==e.maxDirIndirPercent)&&(this.updateExtremes(!1),s=!0);var r=["direct","indirect","warehouse","productivity","productivityNoWh"],o=e.series&&i.any(r,function(i){return e.series[i]!==t.series[i]}),n=["direct","indirect","warehouse"],a=e.references&&i.any(n,function(i){return e.references[i]!==t.references[i]});(o||a||this.isFullscreen&&(e.prodTasks||e.prodFunctions))&&(this.updateChart(!0,!1),s=!1),s&&this.chart.redraw(!1)},serializeChartData:function(){function i(){n&&s.productivity.push(t.productivity),a&&s.productivityNoWh.push(t.productivityNoWh)}var e=this.model,t=e.get("dirIndir"),s={quantityDone:[],productivity:[],productivityNoWh:[],categories:[],dirIndir:[],reference:[]};if(0===t.productivity&&0===t.productivityNoWh&&0===t.direct&&0===t.indirect&&0===t.storage)return s;if(this.isFullscreen)return this.serializeChartDataByProdFunction(s);var r=this.settings,o=this.displayOptions,n=o.isSeriesVisible("productivity"),a=o.isSeriesVisible("productivityNoWh");if(o.isSeriesVisible("direct")&&(s.categories.push("DIRECT"),s.dirIndir.push({y:t.direct,color:r.getColor("direct")}),s.reference.push({y:o.isReferenceVisible("direct")?Math.round(10*e.getDirectRef(r.getCoeff("directRef")))/10:null,color:r.getColor("directRef")}),i()),o.isSeriesVisible("indirect")){var d=r.getValue("absenceRef.prodTask"),c=r.getCoeff("indirectRef");s.categories.push("INDIRECT"),s.dirIndir.push({y:Math.round(10*t.indirect)/10,color:r.getColor("indirect")}),s.reference.push({y:o.isReferenceVisible("indirect")?Math.round(10*e.getIndirectRef(d,c))/10:null,color:r.getColor("indirectRef")}),i()}return o.isSeriesVisible("warehouse")&&(s.categories.push("WAREHOUSE"),s.dirIndir.push({y:Math.round(100*t.storage)/100,color:r.getColor("warehouse")}),s.reference.push({y:o.isReferenceVisible("warehouse")?Math.round(10*this.model.getWarehouseRef(r.getCoeff("warehouseRef")))/10:null,color:r.getColor("warehouseRef")}),i()),s},serializeChartDataByProdFunction:function(i){var e=this.displayOptions,t=this.model,s=t.get("prodTasks"),r=t.get("dirIndir"),a=[];if(e.isSeriesVisible("direct")&&this.pushByProdFunction(a,r.directByProdFunction," (DIR)",this.settings.getColor("direct")),e.isSeriesVisible("indirect")&&this.pushByProdFunction(a,r.indirectByProdFunction," (INDIR)",this.settings.getColor("indirect")),e.isSeriesVisible("warehouse")){var d=e.get("prodTasks");Object.keys(r.storageByProdTasks).forEach(function(i){if(d[i]){var e=s[i];a.push({categoryName:e?e.label:i,name:o(e?e.label:i),y:r.storageByProdTasks[i],color:e?e.color:n})}})}return a.sort(function(i,e){return e.y-i.y}).forEach(function(e){i.categories.push(e.categoryName),i.dirIndir.push(e),i.quantityDone.push(r.quantityDone)}),i},pushByProdFunction:function(i,e,t,r){var o=this.displayOptions.get("prodFunctions");Object.keys(e).forEach(function(n){if(o[n]){var a=s.get(n),d=a?a.getLabel():n;i.push({categoryName:d,name:d+t,y:e[n],color:r})}})},onFullscreen:function(i){this.isFullscreen=i,this.updateChart(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){var i=this.displayOptions,s=i.isSeriesVisible("direct")||i.isSeriesVisible("indirect")||i.isSeriesVisible("warehouse");this.chart=new e.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:t.bound("reports","filenames:2:dirIndir")},title:{text:t.bound("reports","dirIndir:title")},noData:{},tooltip:{shared:!0,valueDecimals:1},legend:{enabled:!1},plotOptions:{line:{marker:{radius:0,states:{hover:{radius:3}}}}},xAxis:{categories:[]},yAxis:[{id:"dirIndirAxis",title:!1,min:0,tickPixelInterval:50},{id:"percentAxis",title:!1,opposite:!0,labels:{format:"{value}%"},showEmpty:!1,min:0,tickPixelInterval:50},{id:"qtyAxis",title:!1,opposite:!0,showEmpty:!1,min:0,tickPixelInterval:50}],series:[{id:"dirIndir",name:t.bound("reports","dirIndir:seriesName"),type:"column",data:[],yAxis:0,visible:s},{id:"reference",name:t.bound("reports","referenceValue"),type:"column",data:[],yAxis:0,visible:s},{id:"productivity",name:t.bound("reports","coeffs:productivity"),color:this.settings.getColor("productivity"),type:"line",yAxis:1,data:[],tooltip:{valueSuffix:"%",valueDecimals:0},visible:i.isSeriesVisible("productivity")},{id:"productivityNoWh",name:t.bound("reports","coeffs:productivityNoWh"),color:this.settings.getColor("productivityNoWh"),type:"line",yAxis:1,data:[],tooltip:{valueSuffix:"%",valueDecimals:0},visible:i.isSeriesVisible("productivityNoWh")},{id:"quantityDone",name:t.bound("reports","coeffs:quantityDone"),color:this.settings.getColor("quantityDone"),type:"line",yAxis:2,data:[],tooltip:{valueSuffix:t.bound("reports","quantitySuffix"),valueDecimals:0},visible:i.isSeriesVisible("quantityDone")}]}),Object.keys(this.series).forEach(function(i){this.series[i]=this.chart.get(i)},this)}})});