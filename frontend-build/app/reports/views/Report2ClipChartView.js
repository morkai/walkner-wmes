// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/time","app/i18n","app/core/View","app/data/views/renderOrgUnitPath","app/highcharts"],function(t,e,i,s,r,o){return s.extend({className:"reports-chart reports-drillingChart reports-2-clip",initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:clip",this.render),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.listenTo(this.displayOptions,"change",t.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},updateChart:function(){var t=this.serializeChartData();this.updateExtremes(!1);var e=this.getMarkerStyles(t.orderCount.length);this.chart.series[0].update({marker:e},!1),this.chart.series[1].update({marker:e},!1),this.chart.series[2].update({marker:e},!1),this.chart.series[0].setData(t.orderCount,!1),this.chart.series[1].setData(t.production,!1),this.chart.series[2].setData(t.endToEnd,!0)},serializeChartData:function(){return this.model.get("clip")},formatTooltipHeader:function(t){var s,r=e.getMoment(t.x),o=this.model.query.get("interval");return"shift"===o&&(s={shift:i("core","SHIFT:"+(6===r.hours()?1:14===r.hours()?2:3))}),r.format(i("reports","tooltipHeaderFormat:"+o,s))},getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},getTitle:function(){var t=this.model.get("orgUnitType");if(!t)return i("reports","charts:title:overall");var e=this.model.get("orgUnit");return"subdivision"===t?r(e,!1,!1):e.getLabel()},updateExtremes:function(t){var e=this.displayOptions,i=!(this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes")),s=null,r=null;if(i){var o=e.isSeriesVisible("clipProduction"),a=e.isSeriesVisible("clipEndToEnd");s=e.isSeriesVisible("clipOrderCount")?e.get("maxClipOrderCount"):null,r=o||a?e.get("maxClipPercent"):null}this.chart.yAxis[0].setExtremes(0,s,!1,!1),this.chart.yAxis[1].setExtremes(0,r,t,!1)},updateColor:function(t,e){var i=this.chart.get(t);i&&i.update({color:e},!0)},onSettingsUpdate:function(t){switch(t.getType()){case"color":return this.updateColor(t.getMetricName(),t.getValue())}},onDisplayOptionsChange:function(){var t=this.displayOptions.changedAttributes(),e=!1;if(t.series){var i=this.displayOptions.get("series");this.chart.series.forEach(function(t){var s=!!i[t.options.id];t.visible!==s&&(t.setVisible(s,!1),e=!0)})}(void 0!==t.maxClipOrderCount||void 0!==t.maxClipPercent)&&(this.updateExtremes(!1),e=!0),e&&this.chart.redraw(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){var t=this.serializeChartData(),e=this.getMarkerStyles(t.orderCount.length);this.chart=new o.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:i("reports","filenames:2:clip")},title:{text:this.getTitle()},noData:{},tooltip:{shared:!0,headerFormatter:this.formatTooltipHeader.bind(this),valueDecimals:0},legend:{enabled:!1},plotOptions:{area:{lineWidth:0,marker:e},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:e}},xAxis:{type:"datetime"},yAxis:[{title:!1},{title:!1,opposite:!0,labels:{format:"{value}%"}}],series:[{id:"clipOrderCount",name:i("reports","metrics:clip:orderCount"),color:this.settings.getColor("clipOrderCount"),type:"area",yAxis:0,data:t.orderCount,visible:this.displayOptions.isSeriesVisible("clipOrderCount")},{id:"clipProduction",name:i("reports","metrics:clip:production"),color:this.settings.getColor("clipProduction"),type:"line",yAxis:1,data:t.production,tooltip:{valueSuffix:"%"},visible:this.displayOptions.isSeriesVisible("clipProduction")},{id:"clipEndToEnd",name:i("reports","metrics:clip:endToEnd"),color:this.settings.getColor("clipEndToEnd"),type:"line",yAxis:1,data:t.endToEnd,tooltip:{valueSuffix:"%"},visible:this.displayOptions.isSeriesVisible("clipEndToEnd")}]})}})});