define(["underscore","jquery","app/time","app/i18n","app/viewport","app/core/View","app/data/orgUnits","app/data/views/renderOrgUnitPath","app/highcharts"],function(t,e,i,r,s,o,n,a,h){return o.extend({className:function(){return"reports-chart reports-drillingChart reports-2-clip"},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.loading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:clip",this.render),this.metricRefs&&(this.listenTo(this.metricRefs,"add",this.onMetricRefUpdate),this.listenTo(this.metricRefs,"change",this.onMetricRefUpdate))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.loading&&this.chart.showLoading()),this.shouldRenderChart=!0},createChart:function(){var t=this.serializeChartData(),i=this.formatTooltipHeader.bind(this),s=this.getMarkerStyles(t.orderCount.length),o=this;this.chart=new h.Chart({chart:{renderTo:this.el,zoomType:"x",resetZoomButton:{relativeTo:"chart",position:{y:5}},events:{selection:function(t){t.resetSelection&&(o.timers.resetExtremes=setTimeout(this.yAxis[1].setExtremes.bind(this.yAxis[1],0,null,!0,!1),1))}}},title:{useHTML:!0,text:this.getTitle()},noData:{},xAxis:{type:"datetime"},yAxis:[{title:!1},{title:!1,opposite:!0,gridLineWidth:0,labels:{format:"{value}%"}}],tooltip:{borderColor:"#999999",shared:!0,useHTML:!0,formatter:function(){var t="<b>"+i(this.x)+"</b><table>";return e.each(this.points,function(e,i){t+='<tr><td style="color: '+i.series.color+'">'+i.series.name+":</td><td>"+i.y+(i.series.tooltipOptions.valueSuffix||"")+"</td></tr>"}),t+="</table>"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom",backgroundColor:"#FFFFFF",itemStyle:{fontSize:"10px"}},plotOptions:{area:{lineWidth:0,marker:s},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:s}},series:[{name:r("reports","metrics:clip:orderCount"),color:"#00aaff",type:"area",yAxis:0,data:t.orderCount},{name:r("reports","metrics:clip:production"),color:"#aa00ff",type:"line",yAxis:1,data:t.production,tooltip:{valueSuffix:"%"},events:{show:this.updateProductionRef.bind(this),hide:this.updateProductionRef.bind(this)}},{name:r("reports","metrics:clip:endToEnd"),color:"#FF007F",type:"line",yAxis:1,data:t.endToEnd,tooltip:{valueSuffix:"%"},events:{show:this.updateEndToEndRef.bind(this),hide:this.updateEndToEndRef.bind(this)}}]})},updateChart:function(){var t=this.serializeChartData(),e=0;t.orderCount.length||(e=null),this.chart.yAxis[1].setExtremes(e,null,!1);var i=this.getMarkerStyles(t.orderCount.length);this.chart.series[0].update({marker:i},!1),this.chart.series[1].update({marker:i},!1),this.chart.series[2].update({marker:i},!1),this.chart.series[0].setData(t.orderCount,!1),this.chart.series[1].setData(t.production,!1),this.chart.series[2].setData(t.endToEnd,!0),this.updatePlotLines()},updatePlotLines:function(){this.metricRefs&&(this.updateProductionRef(),this.updateEndToEndRef())},updatePlotLine:function(t,e,i,r,s){if(e.removePlotLine(t),i.visible){var o=this.getMetricRef(t);o&&e.addPlotLine({id:t,color:r,dashStyle:s,value:o,width:2,zIndex:4})}},updateProductionRef:function(){this.chart&&this.updatePlotLine("production",this.chart.yAxis[1],this.chart.series[1],"#aa00ff","dash")},updateEndToEndRef:function(){this.chart&&this.updatePlotLine("endToEnd",this.chart.yAxis[1],this.chart.series[2],"#FF007F","dash")},getMetricRef:function(t){return this.metricRefs.getValue(t,this.getMetricRefOrgUnitId())},getMetricRefOrgUnitId:function(){var t=this.model.get("orgUnitType"),e=this.model.get("orgUnit"),i=this.model.query.get("subdivisionType");if(null===t)return"overall"+(i?"."+i:"");if("division"===t)return this.getMetricRefOrgUnitIdByDivision(i,e);if("subdivision"===t)return e.id;var r=n.getSubdivisionFor(e);return r?r.id:null},getMetricRefOrgUnitIdByDivision:function(t,e){if(null===t)return e.id;"prod"===t&&(t="assembly");var i=n.getChildren(e).filter(function(e){return e.get("type")===t});return i.length?i[0].id:null},serializeChartData:function(){return this.model.get("clip")},formatTooltipHeader:function(t){var e,s=i.getMoment(t),o=this.model.query.get("interval");return"shift"===o&&(e={shift:r("core","SHIFT:"+(6===s.hours()?1:14===s.hours()?2:3))}),s.format(r("reports","tooltipHeaderFormat:"+o,e))},getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},getTitle:function(){var t=this.model.get("orgUnitType");if(!t)return r("reports","charts:title:overall");var e=this.model.get("orgUnit");return"subdivision"===t?a(e,!1,!1):e.getLabel()},onModelLoading:function(){this.loading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.loading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.loading=!1,this.chart&&this.chart.hideLoading()},onMetricRefUpdate:function(t){var e=this.metricRefs.parseSettingId(t.id);("production"===e.metric||"endToEnd"===e.metric)&&e.orgUnit===this.getMetricRefOrgUnitId()&&("production"===e.metric?this.updateEfficiencyRef():this.updateProductivityRef())}})});