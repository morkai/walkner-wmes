// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/highcharts","app/i18n","app/core/View","app/data/colorFactory","./wordwrapTooltip"],function(t,e,i,a,o){return i.extend({className:function(){return"reports-chart reports-1-"+this.options.attrName},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.loading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:"+this.options.attrName,this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.loading&&this.chart.showLoading()),this.shouldRenderChart=!0},createChart:function(){var i=this.serializeChartData();this.chart=new t.Chart({chart:{renderTo:this.el},exporting:{filename:e("reports","filenames:1:"+this.options.attrName)},title:{text:e("reports",this.options.attrName+":title"),style:{fontSize:"12px",color:"#4D759E"}},noData:{},xAxis:{categories:i.categories},yAxis:{title:!1},legend:!1,series:[{name:e("reports",this.options.attrName+":seriesName"),color:"#ff0000",type:"column",data:i.data,tooltip:{valueSuffix:" FTE"}}]})},updateChart:function(){var t=this.serializeChartData();this.chart.xAxis[0].setCategories(t.categories,!1),this.chart.series[0].setData(t.data,!0)},serializeChartData:function(){var t={categories:[],data:[]},e=this.options.attrName,i=this.model.get(e);if(!i||!i.length)return t;var r=0;return i.forEach(function(t){t.value>r&&(r=t.value)}),i.forEach(function(i){100*i.value/r>.5&&(t.categories.push(i.shortText),t.data.push({name:o(i.longText),y:i.value,color:a.getColor(e,i.key)}))}),t},onModelLoading:function(){this.loading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.loading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.loading=!1,this.chart&&this.chart.hideLoading()}})});