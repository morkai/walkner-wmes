define(["jquery","app/time","app/i18n","app/core/View","app/highcharts"],function(t,e,i,r,a){return r.extend({className:"reports-4-effAndProd",initialize:function(){this.chart=null,this.loading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:effAndProd",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdateChart&&clearTimeout(this.timers.createOrUpdateChart),this.timers.createOrUpdateChart=setTimeout(this.createOrUpdateChart.bind(this),1)},createOrUpdateChart:function(){this.timers.createOrUpdateChart=null,this.chart?this.updateChart():(this.createChart(),this.loading&&this.chart.showLoading())},createChart:function(){var e=this.serializeChartData(),r=this.formatTooltipHeader.bind(this),o=[{name:i("reports","operator:productivity"),color:"#ffaa00",type:"line",data:e.productivity},{name:i("reports","operator:efficiency"),color:"#00ee00",type:"line",data:e.efficiency}];Object.keys(e.byDivision).forEach(function(t){o.push({name:i("reports","operator:efficiency:byDivision",{division:t}),type:"line",data:e.byDivision[t],id:"division-"+t,visible:!1})}),this.chart=new a.Chart({chart:{renderTo:this.el,zoomType:"x",plotBorderWidth:1,resetZoomButton:{relativeTo:"chart",position:{y:5}}},title:{text:i("reports","operator:effAndProd:title")},noData:{},xAxis:{type:"datetime"},yAxis:{title:!1,labels:{format:"{value}%"},min:0},tooltip:{shared:!0,useHTML:!0,formatter:function(){var e="<b>"+r(this.x)+"</b><table>";return t.each(this.points,function(t,i){var r=i.y.toLocaleString?i.y.toLocaleString():i.y;e+='<tr><td style="color: '+i.series.color+'">'+i.series.name+":</td><td>"+r+i.series.tooltipOptions.valueSuffix+"</td></tr>"}),e+="</table>"},valueSuffix:"%"},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"},plotOptions:{line:{lineWidth:2,states:{hover:{lineWidth:4}},marker:this.getMarkerStyles(e.efficiency.length)}},series:o})},updateChart:function(){var t=this.serializeChartData(),e=this.getMarkerStyles(t.efficiency.length),i=this.chart,r=i.series;r.forEach(function(t){t.update({marker:e},!1)}),Object.keys(t.byDivision).forEach(function(e){var r=i.get("division-"+e);r&&r.setData(t.byDivision[e],!1)}),r[0].setData(t.productivity,!1),r[1].setData(t.efficiency,!0)},serializeChartData:function(){return this.model.get("effAndProd")},formatTooltipHeader:function(t){var r=e.getMoment(t),a=this.model.query.get("interval")||"day";return r.format(i("reports","tooltipHeaderFormat:"+a,{}))},getMarkerStyles:function(t){return{symbol:"circle",radius:t>1?0:4,states:{hover:{radius:t>1?4:8}}}},onModelLoading:function(){this.loading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.loading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.loading=!1,this.chart&&this.chart.hideLoading()}})});