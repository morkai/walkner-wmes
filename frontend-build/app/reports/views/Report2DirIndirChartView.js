define(["underscore","screenfull","app/highcharts","app/i18n","app/data/prodFunctions","app/core/View","./wordwrapTooltip"],function(t,e,i,r,o,n,a){var s="#00ee00",h="#ffaa00",d="#ffaa00",c="#eeee00",l="#eeee00",u="#ffaa00",p="#00aaff";return n.extend({className:function(){return"reports-chart reports-2-dirIndir"},events:{dblclick:function(){e.enabled&&e.request(this.el)}},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.loading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:dirIndir change:prodTasks",t.debounce(this.render,1)),this.onFullscreenChange=this.onFullscreenChange.bind(this),this.el.ownerDocument.addEventListener(e.raw.fullscreenchange,this.onFullscreenChange)},destroy:function(){this.el.ownerDocument.removeEventListener(e.raw.fullscreenchange,this.onFullscreenChange),null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.loading&&this.chart.showLoading()),this.shouldRenderChart=!0},onFullscreenChange:function(t){t.target===this.el&&this.updateChart()},createChart:function(){this.chart=new i.Chart({chart:{renderTo:this.el},title:{text:r("reports","dirIndir:title"),style:{fontSize:"12px",color:"#4D759E"}},noData:{},tooltip:{borderColor:"#999999",shared:!0},xAxis:{categories:[]},yAxis:[{title:!1},{title:!1,opposite:!0,gridLineWidth:0,min:0,labels:{format:"{value}%"},showEmpty:!1},{title:!1,opposite:!0,gridLineWidth:0,min:0,showEmpty:!1}],legend:!1,series:[{name:r("reports","dirIndir:seriesName"),type:"column",data:[],dataLabels:{enabled:!0},yAxis:0},{name:r("reports","coeffs:productivity"),color:u,type:"line",yAxis:1,data:[],tooltip:{valueSuffix:"%"}},{name:r("reports","coeffs:quantityDone"),color:p,type:"line",yAxis:2,data:[],tooltip:{valueSuffix:r("reports","quantityDoneSuffix")}}]})},updateChart:function(){var t=this.serializeChartData();this.chart.xAxis[0].setCategories(t.categories,!1),this.chart.series[0].setData(t.data,!1),this.chart.series[1].setData(t.productivity,!1),this.chart.series[2].setData(t.quantityDone,!0)},serializeChartData:function(){var t=this.model.get("dirIndir"),i={quantityDone:[],productivity:[],categories:[],data:[]};if(0===t.productivity&&0===t.direct&&0===t.indirect)return i;if(e.isFullscreen)return this.serializeChartDataByProdFunction(i);var r=t.indirect;return this.model.get("orgUnitType")||(r-=t.storage),i.productivity.push(t.productivity,t.productivity,t.productivity),i.categories.push("DIRECT","INDIRECT","WAREHOUSE"),i.data.push({y:t.direct,color:s},{y:Math.round(10*r)/10,color:h},{y:t.storage,color:l}),i},serializeChartDataByProdFunction:function(t){var e=this.model.get("prodTasks"),i=this.model.get("dirIndir"),r=[];return this.pushByProdFunction(r,i.quantityDone,i.directByProdFunction," (DIR)",s),this.pushByProdFunction(r,i.quantityDone,i.indirectByProdFunction," (INDIR)",d),Object.keys(i.storageByProdTasks).forEach(function(t){var o=e[t];r.push({categoryName:o?o.label:t,name:a(o?o.label:t),y:i.storageByProdTasks[t],color:o?o.color:c})}),r.sort(function(t,e){return e.y-t.y}).forEach(function(e){t.categories.push(e.categoryName),t.data.push(e),t.quantityDone.push(i.quantityDone)}),t},pushByProdFunction:function(t,e,i,r,n){Object.keys(i).forEach(function(e){var a=o.get(e),s=a?a.getLabel():e;t.push({categoryName:s,name:s+r,y:i[e],color:n})})},onModelLoading:function(){this.loading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.loading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.loading=!1,this.chart&&this.chart.hideLoading()}})});