// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/core/View","app/reports/templates/report9Table"],function(i,t,e,s,n){"use strict";function d(i){return i[0].getClientRects()[0].width+"px"}return s.extend({template:n,events:{"mouseenter tbody > tr":function(i){var t=i.currentTarget,e=+t.dataset.index;e!==this.highlightedIndex&&(this.$(".is-highlighted").removeClass("is-highlighted"),this.$('tr[data-index="'+e+'"]').addClass("is-highlighted"),this.highlightedIndex=e)},"mouseleave tbody > tr":function(){this.$(".is-highlighted").removeClass("is-highlighted"),this.highlightedIndex=-1}},initialize:function(){this.highlightedIndex=-1,t(window).on("resize."+this.idPrefix,this.onResize.bind(this)).on("scroll."+this.idPrefix,this.onScroll.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},serialize:function(){var i=this.model;return{idPrefix:this.idPrefix,cags:i.get("cags"),lines:i.get("lines"),months:i.get("months")}},afterRender:function(){this.setUpStickyHeaders(),this.onResize()},setUpStickyHeaders:function(){this.$(".is-sticky").remove();var t={cags:this.$id("cags").find("thead"),lines:this.$id("lines").find("thead"),summary:this.$id("summary").find("thead:nth-child(2)"),months:this.$id("months").find("thead:nth-child(2)")};i.forEach(t,this.buildStickyHeader,this),this.tableTopPosition=t.cags.position().top},buildStickyHeader:function(i,e){var s=i.clone(),n=t("<table></table>").attr("class",i.parent().attr("class")).append(s),a=i.parent().parent(),h=i.find("th"),r=s.find("th");h.each(function(i){var t=d(h.eq(i)),e=r[i].style;e.maxWidth=t,e.minWidth=t}),"lines"===e?this.setUpStickyLinesHeader(a,n,i):n.addClass("is-sticky").append(s).appendTo(a)},setUpStickyLinesHeader:function(i,e){var s=this.$(".reports-9-table-lines"),n=t("<div></div>"),a=d(i);n.append(e),n.css({width:a,overflow:"hidden"}),n.addClass("is-sticky").appendTo(i),s.on("scroll",function(i){n.prop("scrollLeft",i.target.scrollLeft)}),this.stickyLinesHeader={$lines:s,$header:this.$(".reports-9-table-lines-header").css("width",a),$wrapper:n,$container:i}},adjustStickyLinesHeader:function(){var i=this.stickyLinesHeader;if(i){var t=d(i.$container);i.$wrapper.css("width",t).prop("scrollLeft",i.$lines.prop("scrollLeft")),i.$header.css("width",t)}},onResize:function(){this.adjustStickyLinesHeader(),this.tableTopPosition=this.$id("cags").find("table").position().top},onScroll:function(){var i=window.pageYOffset>this.tableTopPosition,t=this.$el.hasClass("reports-9-sticky");this.$el.toggleClass("reports-9-sticky",i),!t&&i&&this.adjustStickyLinesHeader()}})});