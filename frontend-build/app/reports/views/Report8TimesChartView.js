// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/highcharts","app/core/View","app/data/colorFactory","app/data/aors","app/reports/util/formatTooltipHeader"],function(t,e,i,r,n,o,s,a){"use strict";return n.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups",this.render),this.listenTo(this.model.query,"change:visibleSeries",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this.serializeSeries(),i=this.serializeYAxis(t);this.chart=new r.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:450},exporting:{filename:e.bound("reports","8:filename:dirIndir"),chartOptions:{title:!1}},title:!1,noData:{},xAxis:{type:"datetime"},yAxis:i,tooltip:{shared:!0,valueDecimals:2,headerFormatter:a.bind(this)},legend:{enabled:!0,itemStyle:{fontSize:"12px",lineHeight:"14px"}},series:t})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeYAxis:function(e){var i=[],r={},n={percent:{id:"percent",title:!1,min:0,decimals:2,opposite:!1,labels:{format:"{value}%"}},pce:{id:"pce",title:!1,min:0,decimals:0,opposite:!1},time:{id:"time",title:!1,min:0,decimals:2,opposite:!1}},o=-1;return t.forEach(e,function(t){void 0===r[t.yAxis]&&(r[t.yAxis]=++o)}),t.forEach(r,function(t,e){i.push(n[e])}),i.length>1&&t.forEach(i,function(t){t.opposite="time"!==t.id}),i},serializeSeries:function(){function i(t,i,n,l){i.data=o[t][n],i.data&&(i.id=n+":"+t,r.query.isVisibleSeries(i.id)&&(i.metricLabel=l?s.get(n).getLabel():e("reports","8:times:"+n),i.name=i.metricLabel+" "+e("reports","8:suffix:"+t),i.color=r.getColor("times",i.id),a.push(i)))}var r=this.model,n=e("reports","8:times:unit:"+r.query.get("unit")),o=r.get("groups"),a=[],l={timeAvailablePerShift:null,routingTimeForLine:null,routingTimeForLabour:null,heijunkaTimeForLine:null,breaks:null,fap0:null,startup:null,shutdown:null,meetings:null,sixS:null,tpm:null,trainings:null,coTime:null,downtime:null,plan:{type:"line",yAxis:"pce",zIndex:3,tooltip:{valueSuffix:e("reports","quantitySuffix")}},efficiency:{type:"line",yAxis:"percent",zIndex:3,tooltip:{valueSuffix:"%"}}};return t.forEach(r.get("summary").downtimeByAor,function(t,e){l[e]=null}),t.forEach(l,function(e,r){null===e&&(e={type:"column",yAxis:"time",tooltip:{valueSuffix:n}});var o=/^[a-f0-9]{24}$/.test(r);o||i("plan",t.clone(e),r),i("real",t.clone(e),r,o)}),a},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});