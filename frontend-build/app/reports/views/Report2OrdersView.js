// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","js2form","form2js","app/user","app/time","app/core/View","app/core/views/PaginationView","app/orders/views/OrderChangesView","app/reports/templates/report2Orders","app/reports/templates/report2OrderRow"],function(e,t,i,s,r,n,o,a,l,h){"use strict";return n.extend({template:l,events:{"submit #-filter":function(){return this.filter(),!1},"click tr[data-id]":function(e){"A"!==e.target.tagName&&this.showOrderChanges(e.currentTarget.dataset.id)},'change input[name="filter"]':function(){this.$('input[name="statuses[]"]').prop("disabled","red"===this.$('input[name="filter"]:checked').val())}},initialize:function(){this.orderChangesView=null,this.paginationView=new o({replaceUrl:!0,model:this.collection.paginationData}),this.setView(".pagination-container",this.paginationView),this.listenTo(this.collection.paginationData,"change:page",this.scrollTop),this.listenTo(this.collection.query,"change",this.setFilterFieldValues),this.listenTo(this.collection,"change:delayReason",this.onDelayReasonChange),this.listenTo(this.collection,"push:change",this.onChangePush)},destroy:function(){this.hideOrderChanges()},serialize:function(){return{idPrefix:this.idPrefix,renderOrderRow:h,canViewOrders:s.isAllowedTo("ORDERS:VIEW"),orders:this.collection.map(this.serializeOrder,this)}},serializeOrder:function(e){var t,i,s,n,o,a,l=e.get("statusesSetAt");l.CNF?(t="CNF",i="full",s=l.CNF):l.PCNF?(t="PCNF",i="partial",s=l.PCNF):(t="-",i="none"),l.DLV?(n="DLV",o="full",a=l.DLV):l.PDLV?(n="PDLV",o="partial",a=l.PDLV):(n="-",o="none");var h=this.delayReasons.get(e.get("delayReason")),d=e.get("startDate");return{className:"none"===i||"none"===o?"danger":"partial"===i||"partial"===o?"warning":"success",no:e.id,name:e.get("name"),mrp:e.get("mrp"),qty:(e.get("qty")||0).toLocaleString(),finishDate:d?r.format(d,"LL"):"-",cnfStatus:t,cnfClassName:i,cnfTime:s?r.format(s,"LLL"):"-",dlvStatus:n,dlvClassName:o,dlvTime:a?r.format(a,"LLL"):"-",delayReason:h?h.getLabel():"-"}},beforeRender:function(){this.stopListening(this.collection,"request"),this.stopListening(this.collection,"sync")},afterRender:function(){this.listenTo(this.collection,"request",this.onCollectionRequest),this.listenTo(this.collection,"sync",this.onCollectionSync),this.setFilterFieldValues()},renderOrderRows:function(){for(var e="",t=s.isAllowedTo("ORDERS:VIEW"),i=0,r=this.collection.length;r>i;++i)e+=h({canViewOrders:t,order:this.serializeOrder(this.collection.at(i))});this.hideOrderChanges(),this.$id("orders").html(e)},scrollTop:function(){var t=this.$el.offset().top-14,i=e(".navbar-fixed-top");i.length&&(t-=i.outerHeight()),window.scrollY>t&&e("html, body").stop(!0,!1).animate({scrollTop:t},"fast")},setFilterFieldValues:function(){var e=this.collection.query;t(this.$id("filter")[0],{orderNo:e.get("orderNo"),hourMode:e.get("hourMode"),hour:e.get("hour"),filter:e.get("filter"),statuses:e.get("statuses").split(","),limit:e.get("limit")})},filter:function(){var e=i(this.$id("filter")[0]);e.orderNo=(e.orderNo||"").length<6?"":e.orderNo,e.hour=e.hour||"",e.statuses=Array.isArray(e.statuses)?e.statuses.join(","):"",e.skip=0,this.collection.query.set(e,{refreshCharts:!1})},showOrderChanges:function(t){var i=this.$('tr[data-id="'+t+'"]'),s=i.next(".reports-2-changes").length;if(this.hideOrderChanges(),!s){var r=e('<tr class="reports-2-changes hidden"><td colspan="10"></td></tr>'),n=r.find("td");this.orderChangesView=new a({model:this.collection.get(t),delayReasons:this.delayReasons,showPanel:!1}),this.orderChangesView.render(),n.append(this.orderChangesView.el),r.insertAfter(i).removeClass("hidden")}},hideOrderChanges:function(){if(null!==this.orderChangesView){var e=this.orderChangesView.$el.closest(".reports-2-changes");this.orderChangesView.remove(),e.remove(),this.orderChangesView=null}},onCollectionRequest:function(){this.$id("empty").addClass("hidden")},onCollectionSync:function(){this.$id("empty").toggleClass("hidden",0!==this.collection.length),this.$id("orders").toggleClass("hidden",0===this.collection.length),this.renderOrderRows(),this.paginationView.render()},onDelayReasonChange:function(e){var t=this.delayReasons.get(e.get("delayReason"));this.$id("orders").find('tr[data-id="'+e.id+'"]').find(".reports-2-orders-delayReason").text(t?t.getLabel():"-")}})});