// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","form2js","app/i18n","app/time","app/viewport","app/data/orgUnits","app/core/views/FilterView","app/core/util/idAndLabel","app/reports/Report8Query","app/reports/templates/8/filter"],function(e,t,i,r,o,s,n,a,p,l){"use strict";return n.extend({template:l,events:e.extend({},n.prototype.events),serialize:function(){return e.extend(n.prototype.serialize.call(this),{numericProps:p.NUMERIC_PROPS,divisions:s.getAllByType("division").filter(function(e){return"prod"===e.get("type")}).map(a)})},afterRender:function(){n.prototype.afterRender.call(this),this.$id("prodLines").select2({width:322,multiple:!0,data:s.getAllByType("prodLine").map(a)})},serializeQueryToForm:function(){var t=this.model.toJSON();return t.from=r.format(t.from,"YYYY-MM-DD"),t.to=r.format(t.to,"YYYY-MM-DD"),["days","shifts","divisions","subdivisionTypes"].forEach(this.applyAllOptionsIfEmpty.bind(this,t)),t.prodLines=e.isArray(t.prodLines)?t.prodLines.join(","):"",t},applyAllOptionsIfEmpty:function(t,i){e.isEmpty(t[i])&&(t[i]=this.$('input[name="'+i+'[]"]').map(function(){return this.value}).get())},changeFilter:function(){this.model.set(this.serializeFormToQuery(),{reset:!0})},serializeFormToQuery:function(){var i=e.extend(e.result(this.model,"defaults"),t(this.el),{_rnd:Math.random()}),o=r.getMoment(i.from,"YYYY-MM-DD").startOf(i.interval).valueOf(),s=r.getMoment(i.to,"YYYY-MM-DD").startOf(i.interval);return o===s.valueOf()&&s.add(1,i.interval),i.from=o,i.to=s.valueOf(),this.$id("from").val(r.format(i.from,"YYYY-MM-DD")),this.$id("to").val(r.format(i.to,"YYYY-MM-DD")),["days","shifts","divisions","subdivisionTypes"].forEach(this.applyAllOptionsIfEmpty.bind(this,i)),delete i.visibleSeries,i}})});