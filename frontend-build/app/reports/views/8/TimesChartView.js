// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/highcharts","app/core/View","app/data/colorFactory","app/data/aors","app/reports/util/formatTooltipHeader"],function(e,t,i,l,a,r,n,o){"use strict";return a.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups",this.render),this.listenTo(this.model.query,"change:visibleSeries",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var e=this.serializeSeriesAndCategories(),i=e.series,a=e.categories,r=this.serializeYAxis(i),n={filename:t.bound("reports","8:filename:times"),chartOptions:{title:!1,spacing:[0,0,0,0]},sourceWidth:1315.5,sourceHeight:930};a.length&&(n.chartOptions.title={text:this.serializeSingleChartTitle(),style:{fontSize:"24px"}},n.chartOptions.plotOptions={column:{dataLabels:{style:{fontSize:"14px"}}}},n.chartOptions.xAxis=[{type:a.length?"category":"datetime",categories:a.length?a:void 0,labels:{style:{fontSize:"16px"}}}],n.sourceWidth=1315.5,n.sourceHeight=930),this.chart=new l.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:450},exporting:n,title:!1,noData:{},xAxis:{type:a.length?"category":"datetime",categories:a.length?a:void 0},yAxis:r,tooltip:{shared:!0,valueDecimals:2,headerFormatter:a.length?void 0:o.bind(this)},legend:{enabled:!a.length,itemStyle:{fontSize:"12px",lineHeight:"14px"}},plotOptions:{column:{dataLabels:{enabled:!!a.length,formatter:function(){return 0===this.y?"":l.numberFormat(this.y,1).replace(/.0$/,"")},style:{color:"#000",fontSize:"12px",fontWeight:"normal",textShadow:"none"}}}},series:i})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeYAxis:function(t){var i=[],l={},a={percent:{id:"percent",title:!1,min:0,decimals:2,opposite:!1,labels:{format:"{value}%"}},pce:{id:"pce",title:!1,min:0,decimals:0,opposite:!1},time:{id:"time",title:!1,min:0,decimals:2,opposite:!1}},r=-1;return e.forEach(t,function(e){void 0===l[e.yAxis]&&(l[e.yAxis]=++r)}),e.forEach(l,function(e,t){i.push(a[t])}),i.length>1&&e.forEach(i,function(e){e.opposite="time"!==e.id}),i},serializeSeriesAndCategories:function(){function i(e,i,a,r){o&&(i.data=o[e][a],i.data&&(i.id=a+":"+e,l.query.isVisibleSeries(i.id)&&(i.metricId=a,i.planReal=e,i.metricLabel=r?n.get(a).getLabel():t("reports","8:times:"+a),i.name=i.metricLabel+" "+t("reports","8:suffix:"+e),i.color=l.getColor("times",i.id),i.groupPadding=s?0:.2,u[i.yAxis]=!0,h.push(i))))}var l=this.model,a=t("reports","8:times:unit:"+l.query.get("unit")),r=l.get("summary"),o=l.get("groups"),s=o&&1===o.plan.totalVolumeProduced.length,u={},h=[],c={timeAvailablePerShift:null,routingTimeForLine:null,routingTimeForLabour:null,heijunkaTimeForLine:null,breaks:null,fap0:null,startup:null,shutdown:null,meetings:null,sixS:null,tpm:null,trainings:null,coTime:null,downtime:null,plan:{type:s?"column":"line",yAxis:"pce",zIndex:3,tooltip:{valueSuffix:t("reports","quantitySuffix")}},efficiency:{type:s?"column":"line",yAxis:"percent",zIndex:3,tooltip:{valueSuffix:"%"}}};return e.forEach(r?r.downtimeByAor:null,function(e,t){c[t]=null}),e.forEach(c,function(t,l){null===t&&(t={type:"column",yAxis:"time",tooltip:{valueSuffix:a}});var r=/^[a-f0-9]{24}$/.test(l);r||i("plan",e.clone(t),l),i("real",e.clone(t),l,r)}),u=Object.keys(u),s&&u.length&&h.length?this.serializeSingleSeriesAndCategories(h,u[0]):{categories:[],series:h}},serializeSingleSeriesAndCategories:function(i,a){var r=function(){var e=null===this.point.realY?this.y:this.point.realY;return null==e||0===e?"":l.numberFormat(Math.round(100*e)/100,-1)},n={valueSuffix:function(e){return e.valueSuffix},valueFormatter:function(e){return null===e.realY?e.y:e.realY}},o={},s=[{id:"plan",type:"column",name:t("reports","8:column:plan"),yAxis:a,data:[],tooltip:n,grouping:!1,borderWidth:0,groupPadding:0,color:"rgba(0, 170, 255, 0.5)"},{id:"real",type:"column",name:t("reports","8:column:real"),yAxis:a,data:[],tooltip:n,grouping:!1,borderWidth:0,color:"rgba(0, 170, 255, 1)"}],u=-1;return e.forEach(i,function(e){o[e.metricId]||(o[e.metricId]={label:e.metricLabel,plan:null,real:null,realPlan:null,realReal:null,valueSuffix:e.tooltip.valueSuffix});var t=e.data[0].y;"plan"!==e.metricId&&"efficiency"!==e.metricId&&(u=Math.max(u,t)),o[e.metricId][e.planReal]=t}),-1!==u&&(o.plan&&this.calculateFakeValues(o.plan,u),o.efficiency&&this.calculateFakeValues(o.efficiency,u)),e.forEach(o,function(e,t){var i,l=Math.round(100*e.plan)/100<Math.round(100*e.real)/100;null!==e.plan&&(i="plan"===t||"efficiency"===t?l?"#5cb85c":"#d9534f":l?"#d9534f":"#5cb85c"),s[0].data.push({y:e.plan,realY:e.realPlan,metricId:t,dataLabels:{inside:l,formatter:r},valueSuffix:e.valueSuffix}),s[1].data.push({y:e.real,realY:e.realReal,metricId:t,dataLabels:{inside:!l,style:{fontStyle:"oblique"},formatter:r},color:i,valueSuffix:e.valueSuffix})}),{categories:e.map(o,function(e){return e.label}),series:s}},calculateFakeValues:function(e,t){var i=e.plan,l=e.real,a=null!==i,r=null!==l;a&&(e.realPlan=Math.round(i),e.plan=t),r&&(e.realReal=Math.round(l),e.real=t),a&&r&&(l>i?(e.real=t,e.plan=t*(e.realPlan/e.realReal)):i>l?(e.plan=t,e.real=t*(e.realReal/e.realPlan)):(e.plan=t,e.real=t))},serializeSingleChartTitle:function(){var e=this.model,i=e.query,l=i.get("shifts"),a=i.get("divisions"),r=i.get("subdivisionTypes"),n=i.get("prodLines"),s=e.get("groups").plan.totalVolumeProduced,u=[];return n.length?u.push(t("reports","8:title:line"+(1===n.length?"":"s"),{line:n.join(", ")})):i.hasAllDivisionsSelected()?1===r.length?u.push(t("reports","filter:subdivisionType:"+r[0])):u.push(t("reports","charts:title:overall")):(u.push(a.join(", ")),1===r.length&&u.push(t("reports","filter:subdivisionType:"+r[0]))),s.length&&u.push(o.call(this,s[0].x)),u.push(t("reports","8:title:shift:"+(l.length||3),{s1:t("core","SHIFT:"+l[0]),s2:t("core","SHIFT:"+l[1]),s3:t("core","SHIFT:"+l[2])})),u.join(" - ")},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});