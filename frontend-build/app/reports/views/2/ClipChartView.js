// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/highcharts","app/core/View","app/data/views/renderOrgUnitPath","app/reports/util/formatTooltipHeader"],function(t,i,e,s,r,o,n){"use strict";return r.extend({className:"reports-chart reports-drillingChart reports-2-clip",initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:clip",this.render),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.displayOptions&&this.listenTo(this.displayOptions,"change",t.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading?this.chart.showLoading():this.displayOptions||this.updateExtremes()),this.shouldRenderChart=!0},updateChart:function(){var t=this.serializeChartData();this.updateExtremes(!1);for(var i=this.getMarkerStyles(t.orderCount.length),e=this.chart.series,s=0;s<e.length;++s)e[s].update({marker:i},!1);this.chart.series[0].setData(t.orderCount,!1),this.chart.series[1].setData(t.productionCount,!1),this.chart.series[2].setData(t.endToEndCount,!1),this.chart.series[3].setData(t.production,!1),this.chart.series[4].setData(t.endToEnd,!0)},serializeChartData:function(){return this.model.get("clip")},formatTooltipHeader:n,getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},getTitle:function(){var t=this.model.get("orgUnitType");if(!t)return e("reports","charts:title:overall");var i=this.model.get("orgUnit");return"subdivision"===t?o(i,!1,!1):i.getLabel()},updateExtremes:function(t){var i=this.displayOptions;if(!i)return this.chart.yAxis[0].setExtremes(0,null,!1,!1),void this.chart.yAxis[1].setExtremes(0,null,t,!1);var e=!(this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes")),s=null,r=null;if(e){var o=i.isSeriesVisible("clipProduction"),n=i.isSeriesVisible("clipEndToEnd");s=i.isSeriesVisible("clipOrderCount")?i.get("maxClipOrderCount"):null,r=o||n?i.get("maxClipPercent"):null}this.chart.yAxis[0].setExtremes(0,s,!1,!1),this.chart.yAxis[1].setExtremes(0,r,t,!1)},updateColor:function(t,i){var e=this.chart.get(t);e&&e.update({color:i},!0)},onSettingsUpdate:function(t){switch(t.getType()){case"color":return this.updateColor(t.getMetricName(),t.getValue())}},onDisplayOptionsChange:function(){var t=this.displayOptions.changedAttributes(),i=!1;if(t.series){var e=this.displayOptions.get("series");this.chart.series.forEach(function(t){var s=!!e[t.options.id];t.visible!==s&&(t.setVisible(s,!1),i=!0)})}void 0===t.maxClipOrderCount&&void 0===t.maxClipPercent||(this.updateExtremes(!1),i=!0),i&&this.chart.redraw(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){var t=this.serializeChartData(),i=this.getMarkerStyles(t.orderCount.length),r=this.displayOptions;this.chart=new s.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:e("reports","filenames:2:clip")},title:{text:this.getTitle()},noData:{},tooltip:{shared:!0,headerFormatter:this.formatTooltipHeader.bind(this),valueDecimals:0},legend:{enabled:!1},plotOptions:{area:{lineWidth:0,marker:i},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:i}},xAxis:{type:"datetime"},yAxis:[{title:!1},{title:!1,opposite:!0,labels:{format:"{value}%"}}],series:[{id:"clipOrderCount",name:e("reports","metrics:clip:orderCount"),color:this.settings.getColor("clipOrderCount"),type:"area",yAxis:0,data:t.orderCount,visible:!r||r.isSeriesVisible("clipOrderCount")},{id:"clipProductionCount",name:e("reports","metrics:clip:productionCount"),color:this.settings.getColor("clipProduction"),type:"line",dashStyle:"LongDash",yAxis:0,data:t.productionCount,visible:!r||r.isSeriesVisible("clipOrderCount")},{id:"clipEndToEndCount",name:e("reports","metrics:clip:endToEndCount"),color:this.settings.getColor("clipEndToEnd"),type:"line",dashStyle:"LongDash",yAxis:0,data:t.endToEndCount,visible:!r||r.isSeriesVisible("clipOrderCount")},{id:"clipProduction",name:e("reports","metrics:clip:production"),color:this.settings.getColor("clipProduction"),type:"line",yAxis:1,data:t.production,tooltip:{valueSuffix:"%"},visible:!r||r.isSeriesVisible("clipProduction")},{id:"clipEndToEnd",name:e("reports","metrics:clip:endToEnd"),color:this.settings.getColor("clipEndToEnd"),type:"line",yAxis:1,data:t.endToEnd,tooltip:{valueSuffix:"%"},visible:!r||r.isSeriesVisible("clipEndToEnd")}]})},serializeToCsv:function(){for(var t=["date;readableDate;total;production;end2end"],e=this.chart.series,s=e[0].data,r=0;r<s.length;++r)t.push(i.format(s[r].x,"YYYY-MM-DD")+';"'+this.formatTooltipHeader(s[r].x)+'";'+e[0].data[r].y+";"+e[1].data[r].y+";"+e[2].data[r].y);return t.join("\r\n")}})});