// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/user","app/time","app/core/View","app/core/views/PaginationView","app/orders/views/OrderChangesView","app/reports/templates/clip/orders","app/reports/templates/clip/orderRow"],function(e,t,n,i,s,r,o,a){"use strict";return i.extend({template:o,events:{"click tr[data-id]":function(e){"A"!==e.target.tagName&&this.showOrderChanges(e.currentTarget.dataset.id)}},initialize:function(){var e=this,t=this.collection;e.orderChangesView=null,e.paginationView=new s({replaceUrl:!0,model:t.paginationData}),e.setView(".pagination-container",e.paginationView),e.listenTo(t,"change:delayReason change:m4",this.onDelayReasonChange),e.listenTo(t,"change:comment",this.onCommentChange),e.listenTo(t,"push:change",this.onChangePush),e.listenTo(t.paginationData,"change:page",this.scrollTop),e.listenTo(t.displayOptions.settings,"change",this.onSettingChange)},destroy:function(){this.hideOrderChanges()},serialize:function(){return{idPrefix:this.idPrefix,renderOrderRow:a,canViewOrders:t.isAllowedTo("ORDERS:VIEW"),dateProperty:this.collection.displayOptions.settings.getValue("clip.dateProperty","finishDate"),orders:this.collection.map(this.serializeOrder,this)}},serializeOrder:function(e){var t=e.get("productionStatus"),i=e.get("productionTime"),s="CNF"===t?"full":"PCNF"===t?"partial":"none",r=e.get("endToEndStatus"),o=e.get("endToEndTime"),a="DLV"===r?"full":"PDLV"===r?"partial":"none",l=this.delayReasons.get(e.get("delayReason")),d=e.get(this.collection.displayOptions.settings.getValue("clip.dateProperty","finishDate")),h=e.get("mrp"),c=e.get("confirmed"),g="none"===s||"none"===a,p="partial"===s||"partial"===a,m="success";return c||(g?m="danger":p&&(m="warning")),{className:m,no:e.id,name:e.get("name"),mrp:h,qty:(e.get("qtyDone")||0).toLocaleString()+"/"+(e.get("qty")||0).toLocaleString(),date:d?n.format(d,"L"):"",cnfStatus:t||"",cnfClassName:s,cnfTime:i?n.format(i,"L, HH:mm"):"",dlvStatus:r||"",dlvClassName:a,dlvTime:o?n.format(o,"L, HH:mm"):"",delayReason:l?l.getLabel():"",m4:e.get("m4"),drm:e.get("drm"),comment:e.get("comment"),planner:this.planners.getLabel(h)}},beforeRender:function(){this.stopListening(this.collection,"request"),this.stopListening(this.collection,"sync")},afterRender:function(){this.listenTo(this.collection,"request",this.onCollectionRequest),this.listenTo(this.collection,"sync",this.onCollectionSync)},renderOrderRows:function(){for(var e="",n=t.isAllowedTo("ORDERS:VIEW"),i=0,s=this.collection.length;i<s;++i)e+=a({canViewOrders:n,order:this.serializeOrder(this.collection.at(i))});this.hideOrderChanges(),this.$id("orders").html(e)},scrollTop:function(){var t=this.$el.offset().top-14,n=e(".navbar-fixed-top");n.length&&(t-=n.outerHeight()),window.scrollY>t&&e("html, body").stop(!0,!1).animate({scrollTop:t},"fast")},showOrderChanges:function(e){var t=this,n=t.$('tr[data-id="'+e+'"]'),i=n.next(".reports-2-changes").length;if(t.hideOrderChanges(),!i){var s=t.collection.get(e);if(s.get("changes"))return t.renderOrderChanges(s,n);t.req=t.ajax({url:"/orders/"+e+"?select(changes)"}),t.$el.css("cursor","wait"),t.req.done(function(e){s.set("changes",e.changes),t.renderOrderChanges(s,n)}),t.req.always(function(){t.$el.css("cursor","")})}},renderOrderChanges:function(t,n){var i=e('<tr class="reports-2-changes hidden"><td colspan="999"></td></tr>'),s=i.find("td");this.orderChangesView=new r({model:t,delayReasons:this.delayReasons,showPanel:!1}),s.append(this.orderChangesView.el),i.insertAfter(n),this.orderChangesView.render(),i.removeClass("hidden")},hideOrderChanges:function(){if(this.req&&(this.req.abort(),this.req=null),null!==this.orderChangesView){var e=this.orderChangesView.$el.closest(".reports-2-changes");this.orderChangesView.remove(),e.remove(),this.orderChangesView=null}},onCollectionRequest:function(){this.$id("empty").addClass("hidden")},onCollectionSync:function(){this.$id("empty").toggleClass("hidden",0!==this.collection.length),this.$id("orders").toggleClass("hidden",0===this.collection.length),this.renderOrderRows(),this.paginationView.render()},onDelayReasonChange:function(e){var t=this.delayReasons.get(e.get("delayReason")),n="";if(t){n=t.getLabel()+" ("+this.t("orders","m4:"+e.get("m4"));var i=t.get("drm")[e.get("m4")];i&&(n+="; "+i),n+=")"}this.$id("orders").find('tr[data-id="'+e.id+'"]').find(".reports-2-orders-delayReason").text(n)},onSettingChange:function(e){"reports.clip.dateProperty"===e.id&&this.$id("dateProperty").html(this.t("orders:"+e.getValue()))}})});