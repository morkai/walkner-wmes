// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/highcharts","app/core/View","app/orgUnits/util/renderOrgUnitPath","app/reports/util/formatTooltipHeader"],function(t,e,i,s,r,o,n){"use strict";return r.extend({className:"reports-chart reports-drillingChart reports-2-clip",initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:clip",this.render),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.displayOptions&&this.listenTo(this.displayOptions,"change",t.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading?this.chart.showLoading():this.displayOptions||this.updateExtremes()),this.shouldRenderChart=!0},updateChart:function(){var t=this.serializeChartData();this.updateExtremes(!1);for(var e=this.getMarkerStyles(t.orderCount.length),i=this.chart.series,s=0;s<i.length;++s)i[s].update({marker:e},!1);this.chart.series[0].setData(t.orderCount,!1),this.chart.series[1].setData(t.productionCount,!1),this.chart.series[2].setData(t.endToEndCount,!1),this.chart.series[3].setData(t.production,!1),this.chart.series[4].setData(t.endToEnd,!0)},serializeChartData:function(){var e=this.model.get("clip"),i=this.displayOptions?this.displayOptions.get("zeroes"):"include",s={};return"ignore"===i?t.forEach(e,function(t,e){s[e]=t.filter(function(t){return!!t.y})}):"gap"===i?t.forEach(e,function(e,i){s[i]=e.map(function(e){return e.y?e:t.assign({},e,{y:null})})}):s=e,s},formatTooltipHeader:n,getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},getTitle:function(){var t=this.model.get("orgUnitType");if(!t)return i("reports","charts:title:overall");var e=this.model.get("orgUnit");return"subdivision"===t?o(e,!1,!1):e.getLabel()},updateExtremes:function(t){var e=this.displayOptions;if(!e)return this.chart.yAxis[0].setExtremes(0,null,!1,!1),void this.chart.yAxis[1].setExtremes(0,null,t,!1);var i=!(this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes")),s=null,r=null;if(i){var o=e.isSeriesVisible("clipProduction"),n=e.isSeriesVisible("clipEndToEnd");s=e.isSeriesVisible("clipOrderCount")?e.get("maxClipOrderCount"):null,r=o||n?e.get("maxClipPercent"):null}this.chart.yAxis[0].setExtremes(0,s,!1,!1),this.chart.yAxis[1].setExtremes(0,r,t,!1)},updateColor:function(t,e){var i=this.chart.get(t);i&&i.update({color:e},!0)},onSettingsUpdate:function(t){switch(t.getType()){case"color":return this.updateColor(t.getMetricName(),t.getValue())}},onDisplayOptionsChange:function(){var t=this.displayOptions.changedAttributes(),e=!!t.zeroes,i=!1;if(t.series){var s=this.displayOptions.get("series");this.chart.series.forEach(function(t){var e=!!s[t.options.id];t.visible!==e&&(t.setVisible(e,!1),i=!0)})}void 0===t.maxClipOrderCount&&void 0===t.maxClipPercent||(this.updateExtremes(!1),i=!0),e?this.updateChart():i&&this.chart.redraw(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){var t=this.serializeChartData(),e=this.getMarkerStyles(t.orderCount.length),r=this.displayOptions;this.chart=new s.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:i("reports","filenames:2:clip"),buttons:{contextButton:{menuItems:s.getDefaultMenuItems().concat([{text:i("reports","clip:exportOrders"),onclick:this.exportOrders.bind(this)}])}}},title:{text:this.getTitle()},noData:{},tooltip:{shared:!0,headerFormatter:this.formatTooltipHeader.bind(this),valueDecimals:0},legend:{enabled:!1},plotOptions:{area:{lineWidth:0,marker:e},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:e}},xAxis:{type:"datetime"},yAxis:[{title:!1},{title:!1,opposite:!0,labels:{format:"{value}%"}}],series:[{id:"clipOrderCount",name:i("reports","metrics:clip:orderCount"),color:this.settings.getColor("clipOrderCount"),type:"area",yAxis:0,data:t.orderCount,visible:!r||r.isSeriesVisible("clipOrderCount")},{id:"clipProductionCount",name:i("reports","metrics:clip:productionCount"),color:this.settings.getColor("clipProduction"),type:"line",dashStyle:"LongDash",yAxis:0,data:t.productionCount,visible:!r||r.isSeriesVisible("clipOrderCount")},{id:"clipEndToEndCount",name:i("reports","metrics:clip:endToEndCount"),color:this.settings.getColor("clipEndToEnd"),type:"line",dashStyle:"LongDash",yAxis:0,data:t.endToEndCount,visible:!r||r.isSeriesVisible("clipOrderCount")},{id:"clipProduction",name:i("reports","metrics:clip:production"),color:this.settings.getColor("clipProduction"),type:"line",yAxis:1,data:t.production,tooltip:{valueSuffix:"%",valueDecimals:1},visible:!r||r.isSeriesVisible("clipProduction")},{id:"clipEndToEnd",name:i("reports","metrics:clip:endToEnd"),color:this.settings.getColor("clipEndToEnd"),type:"line",yAxis:1,data:t.endToEnd,tooltip:{valueSuffix:"%",valueDecimals:1},visible:!r||r.isSeriesVisible("clipEndToEnd")}]})},serializeToCsv:function(){for(var t=["date;readableDate;total;production;end2end"],i=this.chart.series,s=i[0].data,r=0;r<s.length;++r)t.push(e.format(s[r].x,"YYYY-MM-DD")+';"'+this.formatTooltipHeader(s[r].x)+'";'+i[0].data[r].y+";"+i[1].data[r].y+";"+i[2].data[r].y);return t.join("\r\n")},exportOrders:function(){var e=this.settings.getValue("clip.findDateProperty"),i=this.settings.getValue("clip.requiredStatuses"),s=this.settings.getValue("clip.ignoredStatuses"),r=this.model.get("mrps"),o=this.model.query.get("from"),n=this.model.query.get("to"),a="/orders;export.xlsx?"+e+">="+o+"&"+e+"<"+n;t.isEmpty(i)||(a+="&statuses=in=("+i.join(",")+")"),t.isEmpty(s)||(a+="&statuses=nin=("+s.join(",")+")"),t.isEmpty(r)||(a+="&mrp=in=("+r.join(",")+")"),window.open(a)}})});