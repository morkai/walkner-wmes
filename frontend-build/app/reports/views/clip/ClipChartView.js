define(["underscore","app/time","app/viewport","app/user","app/highcharts","app/core/View","app/core/util/pageActions","app/data/orgUnits","app/orgUnits/util/renderOrgUnitPath","app/reports/util/formatTooltipHeader","app/reports/util/formatXAxis"],function(t,e,i,o,s,r,n,a,l,d,h){"use strict";return r.extend({className:"reports-chart reports-drillingChart reports-2-clip",initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:clip",this.render),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.displayOptions&&this.listenTo(this.displayOptions,"change",t.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading?this.chart.showLoading():this.displayOptions||this.updateExtremes()),this.shouldRenderChart=!0},updateChart:function(){var e=this.chart,i=this.serializeChartData();this.updateExtremes(!1);for(var o=i.orderCount.length,s=this.getMarkerStyles(o),r=e.series,n=0;n<r.length;++n){var a=t.assign({marker:s},r[n].userOptions[1===o?"singleOptions":"multiOptions"]);r[n].update(a,!1)}r[0].setData(i.orderCount,!1),r[1].setData(i.productionCount,!1),r[2].setData(i.endToEndCount,!1),r[3].setData(i.production,!1),r[4].setData(i.endToEnd,!0)},serializeChartData:function(){var e=this.model.get("clip"),i=this.displayOptions?this.displayOptions.get("zeroes"):"include",o={};return"ignore"===i?t.forEach(e,function(t,e){o[e]=t.filter(function(t){return!!t.y})}):"gap"===i?t.forEach(e,function(e,i){o[i]=e.map(function(e){return e.y?e:t.assign({},e,{y:null})})}):o=e,o},formatTooltipHeader:d,getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},getTitle:function(t){var e=this.model.get("orgUnitType");if(!e)return this.t("charts:title:overall");var i=this.model.get("orgUnit");return"subdivision"===e?l(i,t,!1):i.getLabel()},updateExtremes:function(t){var e=this.displayOptions;if(!e)return this.chart.yAxis[0].setExtremes(0,null,!1,!1),void this.chart.yAxis[1].setExtremes(0,null,t,!1);var i=null,o=null;if(!(this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes"))){var s=e.isSeriesVisible("clipProduction"),r=e.isSeriesVisible("clipEndToEnd");i=e.isSeriesVisible("clipOrderCount")?e.get("maxClipOrderCount"):null,o=s||r?e.get("maxClipPercent"):null}this.chart.yAxis[0].setExtremes(0,i,!1,!1),this.chart.yAxis[1].setExtremes(0,o,t,!1)},updateColor:function(t,e){var i=this.chart.get(t);i&&i.update({color:e},!0)},onSettingsUpdate:function(t){switch(t.getType()){case"color":return this.updateColor(t.getMetricName(),t.getValue())}},onDisplayOptionsChange:function(){var t=this.displayOptions.changedAttributes(),e=!!t.zeroes,i=!1;if(t.series){var o=this.displayOptions.get("series");this.chart.series.forEach(function(t){var e=!!o[t.options.id];t.visible!==e&&(t.setVisible(e,!1),i=!0)})}void 0===t.maxClipOrderCount&&void 0===t.maxClipPercent||(this.updateExtremes(!1),i=!0),e?this.updateChart():i&&this.chart.redraw(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){var t=this.serializeChartData(),e=this.getMarkerStyles(t.orderCount.length),i=this.displayOptions,r=this.settings.getColor("clipOrderCount"),n=this.settings.getColor("clipProduction"),a=this.settings.getColor("clipEndToEnd"),l={enabled:!1},d={enabled:!0,formatter:function(){return Math.floor(this.y)}},p=s.getDefaultMenuItems().concat([{text:this.t("clip:exportMetrics"),onclick:this.exportMetrics.bind(this)},{text:this.t("clip:exportOrders"),onclick:this.exportOrders.bind(this)}]);"mrpController"===this.model.get("orgUnitType")&&o.isAllowedTo("PROD_DATA:VIEW")&&p.push({text:this.t("clip:showLineOrders"),onclick:this.showLineOrders.bind(this)}),this.chart=new s.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:this.t("filenames:2:clip"),buttons:{contextButton:{menuItems:p}}},title:{text:this.getTitle(!1)},noData:{},tooltip:{shared:!0,headerFormatter:this.formatTooltipHeader.bind(this),valueDecimals:0},legend:{enabled:!1},plotOptions:{area:{lineWidth:0,marker:e},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:e}},xAxis:{type:"datetime",labels:h.labels(this)},yAxis:[{title:!1,min:0},{title:!1,opposite:!0,labels:{format:"{value}%"},min:0}],series:[{id:"clipOrderCount",name:this.t("metrics:clip:orderCount"),color:r,type:"area",yAxis:0,data:t.orderCount,visible:!i||i.isSeriesVisible("clipOrderCount"),multiOptions:{type:"area",dataLabels:l},singleOptions:{type:"column",dataLabels:d}},{id:"clipProductionCount",name:this.t("metrics:clip:productionCount"),color:n,type:"line",dashStyle:"LongDash",yAxis:0,data:t.productionCount,visible:!i||i.isSeriesVisible("clipOrderCount"),multiOptions:{type:"line",color:n,dashStyle:"LongDash",dataLabels:l},singleOptions:{type:"column",borderWidth:4,borderColor:n,color:r,dashStyle:"Solid",dataLabels:d},tooltipColor:n},{id:"clipEndToEndCount",name:this.t("metrics:clip:endToEndCount"),color:a,type:"line",dashStyle:"LongDash",yAxis:0,data:t.endToEndCount,visible:!i||i.isSeriesVisible("clipOrderCount"),multiOptions:{type:"line",color:a,dashStyle:"LongDash",dataLabels:l},singleOptions:{type:"column",borderWidth:4,borderColor:a,color:r,dashStyle:"Solid",dataLabels:d},tooltipColor:a},{id:"clipProduction",name:this.t("metrics:clip:production"),color:n,type:"line",yAxis:1,data:t.production,tooltip:{valueSuffix:"%",valueDecimals:1},visible:!i||i.isSeriesVisible("clipProduction"),multiOptions:{type:"line",dataLabels:l},singleOptions:{type:"column",dataLabels:d}},{id:"clipEndToEnd",name:this.t("metrics:clip:endToEnd"),color:a,type:"line",yAxis:1,data:t.endToEnd,tooltip:{valueSuffix:"%",valueDecimals:1},visible:!i||i.isSeriesVisible("clipEndToEnd"),multiOptions:{type:"line",dataLabels:l},singleOptions:{type:"column",dataLabels:d}}]})},serializeToCsv:function(){for(var t=["date;readableDate;total;production;end2end;clipProd;clipE2e"],i=this.chart.series,o=i[0].data,s=0;s<o.length;++s)t.push(e.format(o[s].x,"YYYY-MM-DD")+';"'+this.formatTooltipHeader(o[s].x)+'";'+i[0].data[s].y.toLocaleString()+";"+i[1].data[s].y.toLocaleString()+";"+i[2].data[s].y.toLocaleString()+";"+i[3].data[s].y.toLocaleString()+";"+i[4].data[s].y.toLocaleString());return t.join("\r\n")},exportMetrics:function(){var t=this,e=i.msg.show({type:"warning",text:t.t("core","MSG:EXPORTING")}),o=t.getTitle(null),s=t.model.get("orgUnitType"),r=s&&"division"!==s&&"subdivision"!==s?{}:t.model.get("clip").mrps||{},a=t.chart.series,l=[];a[0].data.forEach(function(e,i){var n={orgUnitType:s,orgUnit:o,date:new Date(e.x),dateLong:t.formatTooltipHeader(e.x),dateShort:h(t,{value:e.x}),total:a[0].data[i].y,production:a[1].data[i].y,end2end:a[2].data[i].y,clipProd:a[3].data[i].y,clipE2E:a[4].data[i].y};l.push(n),Object.keys(r[i]).forEach(function(t){var e=r[i][t];l.push({orgUnitType:"mrpController",orgUnit:t,date:n.date,dateLong:n.dateLong,dateShort:n.dateShort,total:e[0],production:e[1],end2end:e[2],clipProd:Math.round(e[1]/e[0]*1e3)/10||0,clipE2E:Math.round(e[2]/e[0]*1e3)/10||0})})});var d=t.ajax({method:"POST",url:"/xlsxExporter",data:JSON.stringify({filename:"WMES-CLIP_METRICS",freezeRows:1,freezeColumns:0,columns:{orgUnitType:15,orgUnit:20,date:"date",dateLong:30,dateShort:10,total:"integer",production:"integer",end2end:"integer",clipProd:"decimal",clipE2E:"decimal"},data:l})});d.fail(function(){i.msg.hide(e,!0),i.msg.show({type:"error",time:2500,text:t.t("core","MSG:EXPORTING_FAILURE")})}),d.done(function(t){i.msg.hide(e,!0),n.exportXlsx("/xlsxExporter/"+t)})},exportOrders:function(){var e=this.settings.getValue("clip.findDateProperty"),i=this.settings.getValue("clip.requiredStatuses"),o=this.settings.getValue("clip.ignoredStatuses"),s=this.model.get("mrps"),r="/orders;export.xlsx?"+e+">="+this.model.get("fromTimeLocal")+"&"+e+"<"+this.model.get("toTimeLocal");t.isEmpty(i)||(r+="&statuses=in=("+i.join(",")+")"),t.isEmpty(o)||(r+="&statuses=nin=("+o.join(",")+")"),t.isEmpty(s)||(r+="&mrp=in=("+s.join(",")+")"),n.exportXlsx(r)},showLineOrders:function(){var t=this.model.query.get("orgUnitType"),i=this.model.query.get("orgUnitId"),o=a.getByTypeAndId(t,i),s=a.getDivisionFor(o),r="/#prodShiftOrders?exclude(creator,losses,orderData.bom,orderData.documents)&sort(-startedAt)&limit(30)&startedAt=ge="+e.getMoment(+this.model.query.get("from")).subtract(7,"days").valueOf()+"&startedAt=lt="+e.getMoment(+this.model.query.get("to")).add(7,"days").valueOf()+"&orderData.mrp=in=("+this.model.get("mrps").join(",")+")";s&&(r+="&division="+encodeURIComponent(s.id)),window.open(r)}})});