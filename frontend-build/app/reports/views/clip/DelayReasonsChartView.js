// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/highcharts","app/core/View"],function(t,i,e,s,r){"use strict";return r.extend({className:"reports-chart reports-2-delayReasons",initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:"+this.options.property,this.render),this.displayOptions&&this.listenTo(this.displayOptions,"change",t.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading?this.chart.showLoading():this.displayOptions||this.updateExtremes()),this.shouldRenderChart=!0},updateChart:function(){var t=this.serializeChartData();this.updateExtremes(!1,t),this.chart.series[0].setData(t,!0)},serializeChartData:function(){var t=this.model.get(this.options.property);if(t.length>10&&!this.el.classList.contains("is-fullscreen")){var i=t.slice(9);t=t.slice(0,9),t.push({name:e("reports","remaining"),color:"#000000",y:i.reduce(function(t,i){return i.y+t},0),remaining:!0})}return t},updateExtremes:function(i,e){var s=this.displayOptions;if(!s)return void this.chart.yAxis[0].setExtremes(0,null,i,!1);var r=!this.model.get("isParent")||"parent"===this.model.get("extremes"),a=r?s.get(this.options.maxProperty):null,h=t.last(this.chart.series[0].data)||t.last(e);null===a&&h&&h.remaining&&(a=(this.chart.series[0].data[0]||e[0]).y),this.chart.yAxis[0].setExtremes(0,a,i,!1)},onDisplayOptionsChange:function(){var t=this.displayOptions.changedAttributes(),i=!1;void 0!==t[this.options.maxProperty]&&(this.updateExtremes(!1),i=!0),i&&this.chart.redraw(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){var t=this.serializeChartData();this.chart=new s.Chart({chart:{renderTo:this.el,zoomType:null,type:"column"},exporting:{filename:this.t(this.options.property+":filename")},title:{text:this.t(this.options.property+":title")},noData:{},legend:{enabled:!1},tooltip:{valueDecimals:0},xAxis:{type:"category"},yAxis:[{title:!1}],series:[{id:this.options.property,name:this.t(this.options.property+":metric"),data:t}]})}})});