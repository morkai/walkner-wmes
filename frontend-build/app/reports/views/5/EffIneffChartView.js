define(["underscore","app/highcharts","app/i18n","app/core/View","app/data/categoryFactory","app/reports/util/wordwrapTooltip"],function(e,t,r,i,s,n){"use strict";var a={absenceRef:!0,dirIndir:!0,dirIndirRef:!0,eff:!0,ineff:!0};return i.extend({className:function(){return"reports-chart reports-5-effIneff"},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isFullscreen=!1,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:effIneff change:prodTasks",e.debounce(this.render,1)),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.listenTo(this.displayOptions,"change",e.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},updateChart:function(t,r){var i=this.chart,s=this.serializeChartData();i.xAxis[0].setCategories(s.categories,!1),r&&this.updateExtremes(!1);var n=i.series[1],a=e.any(s.reference,function(e){return e.y>0});n.visible!==a&&n.setVisible(a,!1),i.series[0].setData(s.data,!1,!1,!1),n.setData(s.reference,!1,!1,!1),!1!==t&&i.redraw(!1)},updateExtremes:function(e){var t=null;this.isFullscreen||this.model.get("isParent")&&"parent"!==this.displayOptions.get("extremes")||(t=this.displayOptions.get("maxResourceFte")),this.chart.yAxis[0].setExtremes(0,t,e,!1)},onSettingsUpdate:function(e){a[e.getMetricName()]&&this.updateChart()},onDisplayOptionsChange:function(){var e=this.displayOptions.changedAttributes(),t=this.displayOptions.previousAttributes(),r=!1;void 0!==e.maxResourceFte&&(this.updateExtremes(!1),r=!0);var i=e.series&&(e.series.dirIndir!==t.series.dirIndir||e.series.effIneff!==t.series.effIneff),s=e.references&&(e.references.dirIndir!==t.references.dirIndir||e.references.absence!==t.references.absence);(i||s||e.prodTasks)&&(this.updateChart(!0,!1),r=!1),r&&this.chart.redraw(!1)},serializeChartData:function(){var e=this.model,t=e.get("prodTasks"),i=e.get("effIneff"),a=[],o=[],h=[];if(0===i.value&&0===i.dirIndir)return{categories:a,data:o,reference:h};var f=this.settings,d=this.displayOptions;d.isSeriesVisible("effIneff")&&o.push({key:"effIneff",category:r("reports","effIneff:category:value"),name:r("reports","effIneff:name:value"),y:Math.abs(i.value),color:f.getColor(i.value>0?"eff":"ineff")}),d.isSeriesVisible("dirIndir")&&o.push({key:"dirIndir",category:r("reports","effIneff:category:dirIndir"),name:r("reports","effIneff:name:dirIndir"),y:i.dirIndir,color:f.getColor("dirIndir")});var c=d.get("prodTasks");Object.keys(i.prodTasks).forEach(function(e){if(c[e]){var r=t[e];o.push({key:e,category:s.getCategory("tasks",e),name:n(r?r.label:e),y:i.prodTasks[e],color:r?r.color:"#ee0"})}});var l=f.getValue("absenceRef.prodTask");o.sort(function(e,t){return t.y-e.y}).forEach(function(t){a.push(t.category);var r={y:null,color:null};"dirIndir"===t.key&&d.isReferenceVisible("dirIndir")?(r.y=Math.round(10*e.getDirIndirRef(f.getCoeff("dirIndirRef")))/10,r.color=f.getColor("dirIndirRef")):t.key===l&&d.isReferenceVisible("absence")&&(r.y=Math.round(10*e.getAbsenceRef(f.getCoeff("absenceRef")))/10,r.color=f.getColor("absenceRef")),h.push(r)},this);var u=a.length;if(!this.isFullscreen&&u>11){for(var p=a.slice(0,9),g=o.slice(0,9),y=h.slice(0,9),I=0,m=10;m<u;++m)I+=o[m].y;p.push(r("reports","effIneff:category:other")),g.push({name:r("reports","effIneff:name:other"),y:Math.round(10*I)/10,color:"#000"}),y.push(null),a=p,o=g,h=y}if(this.isFullscreen)for(var b=0;b<u;++b)a[b]=o[b].name;return{categories:a,data:o,reference:h}},onFullscreen:function(e){this.isFullscreen=e,this.chart.series.forEach(function(t){t.update({dataLabels:{enabled:e}},!1)}),this.updateChart(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){this.chart=new t.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:r("reports","filenames:2:effIneff")},title:{text:r("reports","effIneff:title")},noData:{},xAxis:{categories:[]},yAxis:{title:!1},tooltip:{shared:!0,valueDecimals:1},legend:{enabled:!1},series:[{name:r("reports","effIneff:seriesName"),type:"column",data:[]},{id:"reference",name:r.bound("reports","referenceValue"),type:"column",data:[]}]})}})});