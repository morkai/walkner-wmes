// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/highcharts","app/i18n","app/core/View","app/data/categoryFactory","app/reports/util/wordwrapTooltip"],function(e,t,r,i,s,n){"use strict";var a="#ee0",o="#000",h={absenceRef:!0,dirIndir:!0,dirIndirRef:!0,eff:!0,ineff:!0};return i.extend({className:function(){return"reports-chart reports-2-effIneff"},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isFullscreen=!1,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:effIneff change:prodTasks",e.debounce(this.render,1)),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.listenTo(this.displayOptions,"change",e.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},updateChart:function(t,r){var i=this.chart,s=this.serializeChartData();i.xAxis[0].setCategories(s.categories,!1),r&&this.updateExtremes(!1);var n=i.series[1],a=e.any(s.reference,function(e){return e.y>0});n.visible!==a&&n.setVisible(a,!1),i.series[0].setData(s.data,!1,!1,!1),n.setData(s.reference,!1,!1,!1),t!==!1&&i.redraw(!1)},updateExtremes:function(e){var t=null;this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes")||(t=this.displayOptions.get("maxResourceFte")),this.chart.yAxis[0].setExtremes(0,t,e,!1)},onSettingsUpdate:function(e){h[e.getMetricName()]&&this.updateChart()},onDisplayOptionsChange:function(){var e=this.displayOptions.changedAttributes(),t=this.displayOptions.previousAttributes(),r=!1;void 0!==e.maxResourceFte&&(this.updateExtremes(!1),r=!0);var i=e.series&&(e.series.dirIndir!==t.series.dirIndir||e.series.effIneff!==t.series.effIneff),s=e.references&&(e.references.dirIndir!==t.references.dirIndir||e.references.absence!==t.references.absence);(i||s||e.prodTasks)&&(this.updateChart(!0,!1),r=!1),r&&this.chart.redraw(!1)},serializeChartData:function(){var e=this.model,t=e.get("prodTasks"),i=e.get("effIneff"),h=[],f=[],d=[];if(0===i.value&&0===i.dirIndir)return{categories:h,data:f,reference:d};var c=this.settings,l=this.displayOptions;l.isSeriesVisible("effIneff")&&f.push({key:"effIneff",category:r("reports","effIneff:category:value"),name:r("reports","effIneff:name:value"),y:Math.abs(i.value),color:c.getColor(i.value>0?"eff":"ineff")}),l.isSeriesVisible("dirIndir")&&f.push({key:"dirIndir",category:r("reports","effIneff:category:dirIndir"),name:r("reports","effIneff:name:dirIndir"),y:i.dirIndir,color:c.getColor("dirIndir")});var u=l.get("prodTasks");Object.keys(i.prodTasks).forEach(function(e){if(u[e]){var r=t[e];f.push({key:e,category:s.getCategory("tasks",e),name:n(r?r.label:e),y:i.prodTasks[e],color:r?r.color:a})}});var p=c.getValue("absenceRef.prodTask");f.sort(function(e,t){return t.y-e.y}).forEach(function(t){h.push(t.category);var r={y:null,color:null};"dirIndir"===t.key&&l.isReferenceVisible("dirIndir")?(r.y=Math.round(10*e.getDirIndirRef(c.getCoeff("dirIndirRef")))/10,r.color=c.getColor("dirIndirRef")):t.key===p&&l.isReferenceVisible("absence")&&(r.y=Math.round(10*e.getAbsenceRef(c.getCoeff("absenceRef")))/10,r.color=c.getColor("absenceRef")),d.push(r)},this);var g=h.length,y=10;if(!this.isFullscreen&&g>y+1){for(var I=y-1,m=h.slice(0,I),b=f.slice(0,I),v=d.slice(0,I),C=0,R=y;R<g;++R)C+=f[R].y;m.push(r("reports","effIneff:category:other")),b.push({name:r("reports","effIneff:name:other"),y:Math.round(10*C)/10,color:o}),v.push(null),h=m,f=b,d=v}if(this.isFullscreen)for(var x=0;x<g;++x)h[x]=f[x].name;return{categories:h,data:f,reference:d}},onFullscreen:function(e){this.isFullscreen=e,this.chart.series.forEach(function(t){t.update({dataLabels:{enabled:e}},!1)}),this.updateChart(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){this.chart=new t.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:r("reports","filenames:2:effIneff")},title:{text:r("reports","effIneff:title")},noData:{},xAxis:{categories:[]},yAxis:{title:!1},tooltip:{shared:!0,valueDecimals:1},legend:{enabled:!1},series:[{name:r("reports","effIneff:seriesName"),type:"column",data:[]},{id:"reference",name:r.bound("reports","referenceValue"),type:"column",data:[]}]})}})});