// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/highcharts","app/i18n","app/core/View","app/data/companies"],function(t,e,s,i,a){"use strict";return i.extend({className:function(){return"reports-chart reports-5-attendance"},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isFullscreen=!1,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:attendance ",t.debounce(this.render,1)),this.listenTo(this.displayOptions,"change",t.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},updateChart:function(t,e){var s=this.chart,i=this.serializeChartData();s.xAxis[0].setCategories(i.categories,!1),e&&this.updateExtremes(!1),s.series[0].setData(i.present,!1,!1,!1),s.series[1].setData(i.absent,!1,!1,!1),t!==!1&&s.redraw(!1)},updateExtremes:function(t){var e=null;this.isFullscreen||this.model.get("isParent")&&"parent"!==this.displayOptions.get("extremes")||(e=this.displayOptions.get("maxAttendance")),this.chart.yAxis[0].setExtremes(0,e,t,!1)},onDisplayOptionsChange:function(){var t=this.displayOptions.changedAttributes(),e=!1;void 0!==t.maxAttendance&&(this.updateExtremes(!1),e=!0),t.companies&&(this.updateChart(!0,!1),e=!1),e&&this.chart.redraw(!1)},serializeChartData:function(){var e=this.model,s=e.get("attendance"),i=[],n=[],r=[];if(t.isEmpty(s))return{categories:i,present:n,absent:r};var h=this.displayOptions,o=this.isFullscreen;return t.forEach(s,function(t,e){if(h.isCompanyVisible(e)){var s=a.get(e);s?i.push(o?s.get("name"):s.get("shortName")||s.get("name")):i.push(e),n.push({y:t.demand-t.absence}),r.push({y:t.absence})}}),{categories:i,present:n,absent:r}},onFullscreen:function(t){this.isFullscreen=t,this.chart.series.forEach(function(e){e.update({dataLabels:{enabled:t}},!1)}),this.updateChart(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){this.chart=new e.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:s("reports","hr:attendance:filename")},title:{text:s("reports","hr:attendance:title")},noData:{},xAxis:{categories:[]},yAxis:{title:!1},tooltip:{shared:!0,valueDecimals:1},legend:{enabled:!1},series:[{name:s("reports","hr:attendance:series:present"),type:"column",color:"#00EE00",data:[]},{name:s("reports","hr:attendance:series:absent"),type:"column",color:"#EE0000",data:[]}],plotOptions:{column:{stacking:"normal"}}})}})});