// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/highcharts","app/data/companies","app/data/prodFunctions","./FteChartView","app/reports/util/formatTooltipHeader"],function(t,e,i,o,r,n,a){"use strict";return n.extend({fteType:"details",extremesChangeProperties:["maxDetailsFte"],localTopics:{"companies.synced":"updateChart","prodFunctions.synced":"updateChart"},serializeChartData:function(){var e=this.displayOptions,i=this.model.get("byCompanyAndProdFunction"),n=[];return t.forEach(i,function(i,a){var s=o.get(a);s&&e.isCompanyVisible(a)&&t.forEach(i,function(t,i){var o=r.get(i);t&&o&&e.isProdFunctionVisible(i)&&n.push({prodFunctionId:o.id,companyId:a,color:o.get("color"),borderColor:s.get("color"),y:t,states:{hover:{borderColor:s.get("color")}}})})}),{details:n.sort(function(t,e){return e.y-t.y})}},toggleSeriesVisibility:function(t){return(void 0!==t.companies||void 0!==t.prodFunctions)&&(this.chart.series[0].setData(this.serializeChartData().details,!1,!1,!1),!0)},getYAxisMaxValues:function(){return[this.displayOptions.get("maxDetailsFte")||null]},formatTooltip:function(){var t=this.points[0].point,e=t.prodFunctionId,n=r.get(e).getLabel(),a=t.series.data.filter(function(t){return t.prodFunctionId===e}).map(function(t){var e=o.get(t.companyId),i=t.series.tooltipOptions;return{name:e.getLabel(),value:t.y,color:e.get("color"),decimals:i.valueDecimals,suffix:i.valueSuffix}});return i.formatTableTooltip(n,a)},createChartOptions:function(){var t=n.prototype.createChartOptions.call(this);return t.tooltip.formatter=this.formatTooltip,t},createXAxis:function(){return{labels:{enabled:!1},tickWidth:0,tickLength:0}},createSeries:function(t){return[{id:"details",type:"column",yAxis:0,data:t.details,tooltip:{valueSuffix:" FTE",valueDecimals:2},borderWidth:2,minPointLength:2}]},exportCsvLines:function(){var t=this,i=[e("reports","hr:details:columns")],n={};return r.forEach(function(t){n[t.id]={},o.forEach(function(e){n[t.id][e.id]=[]})}),this.model.get("raw").forEach(function(e){"number"==typeof e&&(e={key:e,qty:0,dni:{}}),i[0]+=";"+t.quoteCsvString(a.call(t,e.key)),r.forEach(function(t){var i=e.dni[t.id];o.forEach(function(e){var o=0;void 0!==i&&i[e.id]&&(o=i[e.id][0]+i[e.id][1]),n[t.id][e.id].push(o)})})}),r.forEach(function(e){o.forEach(function(o){var r=[t.quoteCsvString(e.getLabel()),t.quoteCsvString(o.getLabel()),"FTE","0"],a=n[e.id][o.id],s=0;a.forEach(function(t){r.push(t.toLocaleString()),s+=t}),a.length&&(r[3]=(Math.round(s/a.length*100)/100).toLocaleString()),i.push(r.join(";"))})}),i}})});