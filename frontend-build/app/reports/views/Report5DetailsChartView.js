// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/highcharts","app/data/companies","app/data/prodFunctions","./Report5FteChartView","../util/formatTooltipHeader"],function(t,i,e,o,n,r,a){return r.extend({fteType:"details",extremesChangeProperties:["maxDetailsFte"],localTopics:{"companies.synced":"updateChart","prodFunctions.synced":"updateChart"},serializeChartData:function(){var t=this.displayOptions,i=this.model.get("byCompanyAndProdFunction"),e=[];return n.forEach(function(n){if(t.isProdFunctionVisible(n.id)){var r=n.get("color");(n.get("companies")||[]).forEach(function(a){var s=o.get(a);if(s&&void 0!==i[a]&&t.isCompanyVisible(a)){var c=i[a][n.id];null!=c&&0!==c&&e.push({prodFunctionId:n.id,companyId:a,color:r,borderColor:s.get("color"),y:c,states:{hover:{borderColor:s.get("color")}}})}})}}),{details:e.sort(function(t,i){return i.y-t.y})}},toggleSeriesVisibility:function(t){return void 0===t.companies&&void 0===t.prodFunctions?!1:(this.chart.series[0].setData(this.serializeChartData().details,!1,!1,!1),!0)},getYAxisMaxValues:function(){return[this.displayOptions.get("maxDetailsFte")||null]},formatTooltip:function(){var t=this.points[0].point,i=t.prodFunctionId,r=n.get(i).getLabel(),a=t.series.data.filter(function(t){return t.prodFunctionId===i}).map(function(t){var i=o.get(t.companyId),e=t.series.tooltipOptions;return{name:i.getLabel(),value:t.y,color:i.get("color"),decimals:e.valueDecimals,suffix:e.valueSuffix}});return e.formatTableTooltip(r,a)},createChartOptions:function(){var t=r.prototype.createChartOptions.call(this);return t.tooltip.formatter=this.formatTooltip,t},createXAxis:function(){return{labels:{enabled:!1},tickWidth:0,tickLength:0}},createSeries:function(t){return[{id:"details",type:"column",yAxis:0,data:t.details,tooltip:{valueSuffix:" FTE",valueDecimals:2},borderWidth:2,minPointLength:2}]},exportCsvLines:function(){var t=this,e=[i("reports","hr:details:columns")],r={};return n.forEach(function(t){r[t.id]={},o.forEach(function(i){r[t.id][i.id]=[]})}),this.model.get("raw").forEach(function(i){"number"==typeof i&&(i={key:i,qty:0,dni:{}}),e[0]+=";"+t.quoteCsvString(a.call(t,i.key)),n.forEach(function(t){var e=i.dni[t.id];o.forEach(function(i){var o=0;void 0!==e&&e[i.id]&&(o=e[i.id][0]+e[i.id][1]),r[t.id][i.id].push(o)})})}),n.forEach(function(i){o.forEach(function(o){var n=[t.quoteCsvString(i.getLabel()),t.quoteCsvString(o.getLabel()),"FTE","0"],a=r[i.id][o.id],s=0;a.forEach(function(t){n.push(t.toLocaleString()),s+=t}),a.length&&(n[3]=(Math.round(s/a.length*100)/100).toLocaleString()),e.push(n.join(";"))})}),e}})});