define(["underscore","jquery","app/time","app/i18n","app/viewport","app/core/View","app/data/views/renderOrgUnitPath","app/highcharts"],function(t,e,i,r,o,s,a,n){return s.extend({className:function(){return"reports-chart reports-1-coeffs"},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.loading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:coeffs",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.loading&&this.chart.showLoading()),this.shouldRenderChart=!0},createChart:function(){var t=this.serializeChartData(),i=this.formatTooltipHeader.bind(this),o=this.getMarkerStyles(t.quantityDone.length),s=this;this.chart=new n.Chart({chart:{renderTo:this.el,zoomType:"x",resetZoomButton:{relativeTo:"chart",position:{y:5}},events:{selection:function(t){t.resetSelection&&(s.timers.resetExtremes=setTimeout(this.yAxis[1].setExtremes.bind(this.yAxis[1],0,null,!0,!1),1))}}},title:{useHTML:!0,text:this.getTitle()},noData:{},xAxis:{type:"datetime"},yAxis:[{title:!1},{title:!1,opposite:!0,gridLineWidth:0}],tooltip:{borderColor:"#999999",shared:!0,useHTML:!0,formatter:function(){var t="<b>"+i(this.x)+"</b><table>";return e.each(this.points,function(e,i){t+='<tr><td style="color: '+i.series.color+'">'+i.series.name+":</td><td>"+i.y+i.series.tooltipOptions.valueSuffix+"</td></tr>"}),t+="</table>"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom",backgroundColor:"#FFFFFF",itemStyle:{fontSize:"10px"}},plotOptions:{area:{lineWidth:0,marker:o},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:o}},series:[{name:r("reports","coeffs:quantityDone"),color:"#00aaff",type:"area",yAxis:0,data:t.quantityDone,tooltip:{valueSuffix:r("reports","quantityDoneSuffix")}},{name:r("reports","coeffs:efficiency"),color:"#00ee00",type:"line",yAxis:1,data:t.efficiency,tooltip:{valueSuffix:"%"}},{name:r("reports","coeffs:productivity"),color:"#ffaa00",type:"line",yAxis:1,data:t.productivity,tooltip:{valueSuffix:"%"},visible:"hour"!==this.model.query.get("interval")},{name:r("reports","coeffs:downtime"),color:"rgba(255, 0, 0, .75)",borderColor:"#AC2925",borderWidth:0,type:"column",yAxis:1,data:t.downtime,tooltip:{valueSuffix:"%"}}]})},updateChart:function(){var t=this.serializeChartData(),e=0;t.quantityDone.length||(e=null),this.chart.yAxis[1].setExtremes(e,null,!1);var i="hour"!==this.model.query.get("interval"),r=this.getMarkerStyles(t.quantityDone.length);this.chart.series[0].update({marker:r},!1),this.chart.series[1].update({marker:r},!1),this.chart.series[2].update({marker:r,visible:i},!1),this.chart.series[3].update({marker:r},!1),this.chart.series[0].setData(t.quantityDone,!1),this.chart.series[1].setData(t.efficiency,!1),this.chart.series[2].setData(t.productivity,!1),this.chart.series[3].setData(t.downtime,!0)},serializeChartData:function(){return this.model.get("coeffs")},formatTooltipHeader:function(t){var e,o=i.getMoment(t),s=this.model.query.interval||"hour";return"shift"===s&&(e={shift:r("core","SHIFT:"+(6===o.hours()?1:14===o.hours()?2:3))}),o.format(r("reports","tooltipHeaderFormat:"+s,e))},getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},getTitle:function(){var t=this.model.get("orgUnitType");if(!t)return r("reports","report1:overallTitle");var e=this.model.get("orgUnit");return"subdivision"===t?a(e,!1,!1):e.getLabel()},onModelLoading:function(){this.loading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.loading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.loading=!1,this.chart&&this.chart.hideLoading()}})});