// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/core/View","app/core/util/parseNumber","app/reports/templates/9/table","app/reports/templates/9/summaryTr","app/reports/templates/9/monthsTr"],function(t,s,e,i,n,o,r,h){"use strict";function a(t){var s=t[0].getClientRects();return(s.length?s[0].width:0)+"px"}return i.extend({template:o,events:{"mouseenter tbody > tr":function(t){var s=t.currentTarget,e=+s.dataset.index;e!==this.highlightedIndex&&(this.$(".is-highlighted").removeClass("is-highlighted"),this.$('tr[data-index="'+e+'"]').addClass("is-highlighted"),this.highlightedIndex=e)},"mouseleave tbody > tr":function(){this.$(".is-highlighted").removeClass("is-highlighted"),this.highlightedIndex=-1},"click .reports-9-editable":function(t){this.showEditor(t.currentTarget)},"blur .reports-9-editor":function(){this.hideCurrentEditor()},"keydown .reports-9-editor":function(t){13===t.keyCode?this.saveCurrentEditor():27===t.keyCode&&t.target.blur()}},initialize:function(){this.highlightedIndex=-1,this.currentEditorSourceEl=null,this.listenTo(this.model,"sync",this.render),this.listenTo(this.model,"change:customLines",this.onCustomLinesChange),this.listenTo(this.model,"change:daysInMonth change:shiftsInDay change:hoursInShift",this.onOptionsChange),this.listenTo(this.model,"clearOptions",this.onOptionsClear),s(window).on("resize."+this.idPrefix,this.onResize.bind(this)).on("scroll."+this.idPrefix,this.onScroll.bind(this))},destroy:function(){s(window).off("."+this.idPrefix)},serialize:function(){var t=this.model,s=t.constructor.DEFAULTS,e=t.get("daysInMonth"),i=t.get("shiftsInDay"),n=t.get("hoursInShift");return{idPrefix:this.idPrefix,cags:t.get("cags"),lines:t.get("lines"),months:t.get("months"),summary:{daysInMonth:null==e.summary?s.daysInMonth:e.summary,customDaysInMonth:null!=e.summary,shiftsInDay:null==i.summary?s.shiftsInDay:i.summary,customShiftsInDay:null!=i.summary,hoursInShift:null==n?s.hoursInShift:n,customHoursInShift:null!=n}}},afterRender:function(){this.setUpStickyHeaders(),this.onResize()},setUpStickyHeaders:function(){this.$(".is-sticky").remove();var s={cags:this.$id("cags").find("thead"),lines:this.$id("lines").find("thead"),summary:this.$id("summary").find("thead:nth-child(2)"),months:this.$id("months").find("thead:nth-child(2)")};t.forEach(s,this.buildStickyHeader,this),this.tableTopPosition=s.cags.position().top},buildStickyHeader:function(t,e){var i=t.clone(),n=s("<table></table>").attr("class",t.parent().attr("class")).append(i),o=t.parent().parent(),r=t.find("th"),h=i.find("th");r.each(function(t){var s=a(r.eq(t)),e=h[t].style;e.maxWidth=s,e.minWidth=s}),"lines"===e?this.setUpStickyLinesHeader(o,n,t):n.addClass("is-sticky").append(i).appendTo(o)},setUpStickyLinesHeader:function(t,e){var i=this.$(".reports-9-table-lines"),n=s("<div></div>"),o=a(t);n.append(e),n.css({width:o,overflow:"hidden"}),n.addClass("is-sticky").appendTo(t),i.on("scroll",function(t){n.prop("scrollLeft",t.target.scrollLeft)}),this.stickyLinesHeader={$lines:i,$header:this.$(".reports-9-table-lines-header").css("width",o),$wrapper:n,$container:t}},adjustStickyLinesHeader:function(){var t=this.stickyLinesHeader;if(t){var s=a(t.$container);t.$wrapper.css("width",s).prop("scrollLeft",t.$lines.prop("scrollLeft")),t.$header.css("width",s)}},onResize:function(){var t=this.$id("cags");t.length&&(this.adjustStickyLinesHeader(),this.tableTopPosition=t.find("table").position().top)},onScroll:function(){var t=window.pageYOffset>this.tableTopPosition,s=this.$el.hasClass("reports-9-sticky");this.$el.toggleClass("reports-9-sticky",t),!s&&t&&this.adjustStickyLinesHeader()},showEditor:function(t){if(this.currentEditorSourceEl!==t){this.currentEditorSourceEl&&this.hideCurrentEditor();var s=t.dataset,e=+s.cagIndex,i=+s.monthIndex;switch(s.editor){case"customLines":this.showCustomLinesEditor(t,e,i);break;case"daysInMonth":this.showDaysInMonthEditor(t,i);break;case"shiftsInDay":this.showShiftsInDayEditor(t,i);break;case"hoursInShift":this.showHoursInShiftEditor(t)}t.classList.add("reports-9-editing"),this.currentEditorSourceEl=t}},hideCurrentEditor:function(){this.$(".reports-9-editor").remove(),this.currentEditorSourceEl.classList.remove("reports-9-editing"),this.currentEditorSourceEl=null},saveCurrentEditor:function(){var t=this.currentEditorSourceEl.dataset,s=+t.cagIndex,e=+t.monthIndex,i=this.model,o=this.$(".reports-9-editor"),r=o.val().replace(/[^0-9,.]+/g,""),h=""===r?null:n(r,!1);switch(t.editor){case"customLines":i.setCustomLines(s,e,h);break;case"daysInMonth":i.setDaysInMonth(e,h);break;case"shiftsInDay":i.setShiftsInDay(e,h);break;case"hoursInShift":i.setHoursInShift(h)}o.blur()},showCustomLinesEditor:function(t,s,e){var i=this.model.get("cags")[s],n=e>=0&&null!==i.customLines?i.customLines:i.lines,o=e>=0?i.customMonthLines[e]:i.customLines;this.showEditorInput(t,n,null===o?"":o)},showDaysInMonthEditor:function(t,s){this.showMonthsOptionEditor(t,s,"daysInMonth")},showShiftsInDayEditor:function(t,s){this.showMonthsOptionEditor(t,s,"shiftsInDay")},showMonthsOptionEditor:function(t,s,e){var i,n,o=this.model,r=o.constructor.DEFAULTS,h=o.get("months")[s],a=this.model.get(e);h?(i=null==a.summary?r[e]:a.summary,n=null==a[h.key]?null:a[h.key]):(i=r[e],n=null==a.summary?null:a.summary),this.showEditorInput(t,i,n)},showHoursInShiftEditor:function(t){var s=this.model.constructor.DEFAULTS.hoursInShift,e=this.model.get("hoursInShift");this.showEditorInput(t,s,e)},showEditorInput:function(t,e,i){s('<input type="text" autocomplete="new-password" maxlength="3" class="reports-9-editor">').attr("placeholder","number"==typeof e?e.toLocaleString():e).val("number"==typeof i?i.toLocaleString():i).appendTo(t).select()},renderSummaryAndMonths:function(){var s=this.model,e=s.get("months"),i="",n="";t.forEach(s.get("cags"),function(t,s){i+=r({cagI:s,cag:t}),n+=h({months:e,cagI:s,cag:t})}),this.$id("summaryRows").prop("innerHTML",i),this.$id("monthsRows").prop("innerHTML",n)},onCustomLinesChange:function(t){var s=t.cagIndex,e=this.model,i=e.get("cags")[s];this.$id("summaryRows").children().eq(s).replaceWith(r({cagI:s,cag:i})),this.$id("monthsRows").children().eq(s).replaceWith(h({months:e.get("months"),cagI:s,cag:i})),this.setUpStickyHeaders()},onOptionsChange:function(t){this.renderSummaryAndMonths();var s=this.$(".reports-9-table-options").find('.reports-9-editable[data-editor="'+t.option+'"]'),e=t.displayValue.toLocaleString();-1===t.monthIndex?s.each(function(){var s=void 0===this.dataset.monthIndex,i=this.classList.contains("reports-9-custom");s?(this.classList.toggle("reports-9-custom",null!==t.newValue),this.children[0].innerText=e):i||(this.children[0].innerText=e)}):s.filter('[data-month-index="'+t.monthIndex+'"]').toggleClass("reports-9-custom",null!==t.newValue).find(".reports-9-editable-value").text(e),this.setUpStickyHeaders()},onOptionsClear:function(){this.renderSummaryAndMonths();var t=this.model.constructor.DEFAULTS;this.$(".reports-9-custom").each(function(){this.classList.remove("reports-9-custom"),this.children[0].textContent=t[this.dataset.editor].toLocaleString()}),this.setUpStickyHeaders()}})});