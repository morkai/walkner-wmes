define(["underscore","app/time","app/i18n","app/highcharts","app/core/View","app/reports/util/formatTooltipHeader","app/reports/util/formatXAxis"],function(e,t,i,s,n,o,r){"use strict";return n.extend({className:"reports-chart reports-drillingChart reports-1-coeffs",initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:coeffs",this.render),this.settings&&this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.displayOptions&&(this.listenTo(this.displayOptions,"change:series change:maxQuantityDone change:maxPercentCoeff",e.debounce(this.onDisplayOptionsChange,1)),this.listenTo(this.displayOptions,"change:references",this.onDisplayReferencesChange),this.listenTo(this.displayOptions,"change:skipEmpty",this.onSkipEmptyChange))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},updateChart:function(){var e=this.serializeChartData(),t=this.getMarkerStyles(e.quantityDone.length),i=this.chart.series;this.updateExtremes(!1),this.model.query.get("skipEmpty")&&this.chart.xAxis[0].update({categories:this.serializeCategories()},!1),i.forEach(function(e){e.update({marker:t},!1)}),i[0].setData(e.quantityDone,!1),i[1].setData(e.efficiency,!1),i[2].setData(e.productivity,!1),i[3].setData(e.productivityNoWh,!1),i[4].setData(e.scheduledDowntime,!1),i[5].setData(e.unscheduledDowntime,!1),this.model.isPaintShop()&&i[6].setData(e.mmh,!1);var s="hour"!==this.model.query.get("interval"),n=s&&this.isSeriesVisible("productivity"),o=s&&this.isSeriesVisible("productivityNoWh");i[2].visible!==n&&i[2].setVisible(n,!1),i[3].visible!==o&&i[3].setVisible(o,!1),this.chart.redraw(!1),this.updateReferences()},updateReferences:function(){this.settings&&(this.updateReference("efficiency"),this.updateReference("productivity"),this.updateReference("productivityNoWh"),this.updateReference("scheduledDowntime"),this.updateReference("unscheduledDowntime"))},updateReference:function(e){if(this.chart){var t=this.chart.get(e);if(t&&(t.yAxis.removePlotLine(e),t.visible&&this.isReferenceVisible(e))){var i=this.getReference(e);i&&t.yAxis.addPlotLine({id:e,color:t.color,dashStyle:"dash",value:i,width:2,zIndex:4})}}},updateExtremes:function(e){if(this.displayOptions){var t=!this.model.get("isParent")||"parent"===this.model.get("extremes"),i=t?this.displayOptions.get("maxQuantityDone"):null,s=t?this.displayOptions.get("maxPercentCoeff"):null;this.chart.yAxis[0].setExtremes(null==i?null:0,i,!1,!1),this.chart.yAxis[1].setExtremes(null==s?null:0,s,e,!1)}},updateColor:function(e,t){var i=this.chart.get(e);i&&(i.update({color:t},!0),this.updateReference(e))},getReference:function(e){return this.settings.getReference(e,this.model.getReferenceOrgUnitId())},serializeCategories:function(){var e=this;return this.model.get("categorizedCoeffs").categories.map(function(t){return r(e,{value:t})})},serializeChartData:function(){return this.model.get(this.isSkipEmpty()?"categorizedCoeffs":"coeffs")},isSkipEmpty:function(){return!!this.displayOptions&&this.displayOptions.get("skipEmpty")},isSeriesVisible:function(e){return!this.displayOptions||this.displayOptions.isSeriesVisible(e)},isReferenceVisible:function(e){return!this.displayOptions||this.displayOptions.isReferenceVisible(e)},getMarkerStyles:function(e){return{radius:e>1?0:3,states:{hover:{radius:e>1?3:6}}}},getColor:function(e,t){return this.settings?this.settings.getColor(e,t):"#000000"},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onSettingsUpdate:function(e){switch(e.getType()){case"color":return this.updateColor(e.getMetricName(),e.getValue());case"ref":return this.updateReference(e.getMetricName())}},onDisplayOptionsChange:function(){if(this.chart){var e=this.displayOptions.get("series"),t="hour"===this.model.query.get("interval");this.chart.series.forEach(function(i){var s=!!e[i.options.id];/^productivity/.test(i.options.id)&&t&&(s=!1),i.visible!==s&&i.setVisible(s,!1)}),this.updateExtremes(!0)}},onDisplayReferencesChange:function(e,t){var i=Object.keys(t);if(!i.length)return this.updateReferences();for(var s=0,n=i.length;s<n;++s)if(this.chart.get(i[s])){this.updateReferences();break}},onSkipEmptyChange:function(){this.chart.destroy(),this.createChart()},createChart:function(){var e=this,t=e.serializeChartData(),n=e.getMarkerStyles(t.quantityDone.length),a=e.model.isPaintShop(),h=[{id:"quantityDone",name:i.bound("reports","coeffs:quantityDone"),color:e.getColor("quantityDone"),type:"area",yAxis:0,data:t.quantityDone,tooltip:{valueSuffix:i("reports","quantitySuffix")},visible:!a&&e.isSeriesVisible("quantityDone"),zIndex:1},{id:"efficiency",name:i.bound("reports","coeffs:efficiency"),color:e.getColor("efficiency"),type:"line",yAxis:1,data:t.efficiency,tooltip:{valueSuffix:"%"},events:{show:e.updateReference.bind(e,"efficiency"),hide:e.updateReference.bind(e,"efficiency")},visible:e.isSeriesVisible("efficiency"),zIndex:2},{id:"productivity",name:i.bound("reports","coeffs:productivity"),color:e.getColor("productivity"),type:"line",yAxis:1,data:t.productivity,tooltip:{valueSuffix:"%"},visible:"hour"!==e.model.query.get("interval")&&e.isSeriesVisible("productivity"),events:{show:e.updateReference.bind(e,"productivity"),hide:e.updateReference.bind(e,"productivity")},zIndex:3},{id:"productivityNoWh",name:i.bound("reports","coeffs:productivityNoWh"),color:e.getColor("productivityNoWh"),type:"line",yAxis:1,data:t.productivityNoWh,tooltip:{valueSuffix:"%"},visible:"hour"!==e.model.query.get("interval")&&e.isSeriesVisible("productivityNoWh"),events:{show:e.updateReference.bind(e,"productivityNoWh"),hide:e.updateReference.bind(e,"productivityNoWh")},zIndex:4},{id:"scheduledDowntime",name:i.bound("reports","coeffs:scheduledDowntime"),color:e.getColor("scheduledDowntime",.75),borderWidth:0,type:"column",yAxis:1,data:t.scheduledDowntime,tooltip:{valueSuffix:"%"},visible:e.isSeriesVisible("scheduledDowntime"),events:{show:e.updateReference.bind(e,"scheduledDowntime"),hide:e.updateReference.bind(e,"scheduledDowntime")},zIndex:5},{id:"unscheduledDowntime",name:i.bound("reports","coeffs:unscheduledDowntime"),color:e.getColor("unscheduledDowntime",.75),borderWidth:0,type:"column",yAxis:1,data:t.unscheduledDowntime,tooltip:{valueSuffix:"%"},visible:e.isSeriesVisible("unscheduledDowntime"),events:{show:e.updateReference.bind(e,"unscheduledDowntime"),hide:e.updateReference.bind(e,"unscheduledDowntime")},zIndex:6}];a&&h.push({id:"mmh",name:i.bound("reports","coeffs:mmh"),color:e.getColor("mmh"),borderWidth:0,type:"line",yAxis:2,data:t.mmh,tooltip:{valueSuffix:i.bound("reports","coeffs:mmh:unit")},visible:!0,zIndex:1});var d={};e.isSkipEmpty()?(d.labels={autoRotation:[15]},d.categories=e.serializeCategories()):(d.type="datetime",d.labels=r.labels(e)),e.chart=new s.Chart({chart:{renderTo:e.el,zoomType:null},exporting:{filename:i("reports","filenames:1:coeffs")},title:{text:e.model.getOrgUnitTitle()},noData:{},xAxis:d,yAxis:[{title:!1,showEmpty:!1},{title:!1,showEmpty:!1,opposite:!0,labels:{format:"{value}%"}},{title:!1,showEmpty:!1}],tooltip:{shared:!0,headerFormatter:function(t){return o.call(e,e.isSkipEmpty()?t.points[0].point.time:t.x)},valueDecimals:0},legend:{enabled:!1},plotOptions:{area:{lineWidth:0,marker:n},line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:n}},series:h})}})});