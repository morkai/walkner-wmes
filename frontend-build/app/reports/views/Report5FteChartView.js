// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/time","app/i18n","app/highcharts","app/core/View","app/data/companies","../util/formatTooltipHeader"],function(t,e,i,s,r,n,a){return r.extend({fteType:null,extremesChangeProperties:[],className:function(){return"reports-chart reports-5-"+this.fteType},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change",this.render),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.listenTo(this.displayOptions,"change",t.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},updateChart:function(){var t=this.serializeChartData();this.updateExtremes(!1);var e=this.getMarkerStyles(t[this.fteType].length),i=this.chart,s=i.series;s.forEach(function(i){i.update({marker:e},!1),t[i.options.id]&&i.setData(t[i.options.id],!1,!1,!1)}),t.byCompany&&n.forEach(function(e){var s=i.get(e.id);s&&s.setData(t.byCompany[e.id]||null,!1)}),i.redraw(!1)},serializeChartData:function(){throw new Error},getMarkerStyles:function(t){return{radius:t>1?0:3,states:{hover:{radius:t>1?3:6}}}},updateExtremes:function(t){var e=this.chart;this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes")||this.getYAxisMaxValues().forEach(function(t,i){e.yAxis[i].setExtremes(0,t,!1,!1)}),t!==!1&&e.redraw(!1)},getYAxisMaxValues:function(){return this.chart.yAxis.map(function(){return null})},updateColor:function(t,e){var i=this.chart.get(t);i&&i.update({color:e},!0)},onSettingsUpdate:function(t){switch(t.getType()){case"color":return this.updateColor(t.getMetricName(),t.getValue())}},onDisplayOptionsChange:function(){var e=this.displayOptions,i=e.changedAttributes(),s=this.toggleSeriesVisibility(i),r=t.any(this.extremesChangeProperties,function(t){return void 0!==i[t]});r&&(this.updateExtremes(!1),s=!0),s&&this.chart.redraw(!1)},toggleSeriesVisibility:function(t){var e=this.displayOptions,i=!1;return(t.series||t.companies)&&this.chart.series.forEach(function(t){var s=e.isSeriesVisible(t.options.id);t.visible!==s&&(t.setVisible(s,!1),i=!0)}),i},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},getChartTitle:function(){return i.bound("reports","hr:title:"+this.fteType)},createChart:function(){this.chart=new s.Chart(this.createChartOptions())},createChartOptions:function(){var t=this.serializeChartData(),e=this.getMarkerStyles(t[this.fteType].length);return{chart:{renderTo:this.el,zoomType:null},exporting:{filename:i.bound("reports","filenames:5:"+this.fteType)},title:{text:this.getChartTitle()},noData:{},tooltip:{shared:!0,headerFormatter:this.formatTooltipHeader.bind(this)},legend:{enabled:!1},plotOptions:{line:{lineWidth:2,states:{hover:{lineWidth:2}},marker:e}},xAxis:this.createXAxis(),yAxis:this.createYAxis(),series:this.createSeries(t)}},formatTooltipHeader:function(t){return a.call(this,t)},createXAxis:function(){return{type:"datetime"}},createYAxis:function(){return[{title:!1,min:0}]},createSeries:function(){throw new Error},createFteSeries:function(t,e,s,r){return{id:t,name:s||i.bound("reports","hr:"+t),color:r||this.settings.getColor(t),type:"line",yAxis:0,data:e,visible:this.displayOptions.isSeriesVisible(t),tooltip:{valueSuffix:" FTE",valueDecimals:1}}}})});