define(["underscore","app/user","app/core/util/idAndLabel","app/data/orgUnits","app/data/aors","app/data/downtimeReasons","app/data/delayReasons","app/data/orderStatuses","app/settings/views/SettingsView","app/reports/templates/settings","app/reports/templates/settings/rearmDowntimeRow","app/reports/templates/settings/rearmMetricRow"],function(e,t,i,a,n,r,s,o,l,d,m,u){"use strict";return l.extend({clientUrl:"#reports;settings",defaultTab:"efficiency",template:d,localTopics:{"divisions.synced":"render","subdivisions.synced":"render","aors.synced":"render","downtimeReasons.synced":"render"},events:e.assign({'change [name$="prodTask"]':"updateSettingOnInputChange",'change [name$="id"]':"updateSettingOnInputChange",'change [name$="aors"]':"updateSettingOnInputChange","change #-downtimesInAors-specificAor":"updateSettingOnInputChange",'change [name$="Subdivision"]':"updateSettingOnInputChange",'change [name$="DowntimeReasons"]':"updateSettingOnInputChange",'change [name$="ProdTasks"]':"updateSettingOnInputChange",'change [name$="ProdFlows"]':"updateSettingOnInputChange","change [data-select2-setting]":"updateSettingOnInputChange",'change [name="downtimesInAorsType"]':function(e){var t="own"===e.target.value?"own":"";this.updateSetting("reports.downtimesInAors.aors",t),this.toggleDowntimesInAors(t)},'click .btn[data-rearm-action$=".moveUp"]':function(e){const t="rearm."+e.currentTarget.dataset.rearmAction.split(".")[0],{variable:i}=this.$(e.currentTarget).closest("tr")[0].dataset,a=[...this.model.getValue(t,[])],n=a.findIndex(e=>e.variable===i);-1!==n&&(0===n?a.push(a.shift()):a.splice(n-1,0,a.splice(n,1)[0]),this.updateRearmColumnsSetting(t,a))},'click .btn[data-rearm-action$=".moveDown"]':function(e){const t="rearm."+e.currentTarget.dataset.rearmAction.split(".")[0],{variable:i}=this.$(e.currentTarget).closest("tr")[0].dataset,a=[...this.model.getValue(t,[])],n=a.findIndex(e=>e.variable===i);-1!==n&&(n===a.length-1?a.unshift(a.pop()):a.splice(n+1,0,a.splice(n,1)[0]),this.updateRearmColumnsSetting(t,a))},'click .btn[data-rearm-action$=".delete"]':function(e){const t="rearm."+e.currentTarget.dataset.rearmAction.split(".")[0],{variable:i}=this.$(e.currentTarget).closest("tr")[0].dataset,a=this.model.getValue(t,[]).filter(e=>e.variable!==i);this.updateRearmColumnsSetting(t,a)},'click .btn[data-rearm-action="downtimeColumns.edit"]':function(e){this.updateSelectedRearmDowntimeColumn(this.$(e.currentTarget).closest("tr")[0].dataset.variable)},"click #-rearm-downtimeColumns-submit":function(){this.saveSelectedRearmDowntimeColumn()},"click #-rearm-downtimeColumns-reset":function(){this.resetSelectedRearmDowntimeColumn()},'click .btn[data-rearm-action="metricColumns.edit"]':function(e){this.updateSelectedRearmMetricColumn(this.$(e.currentTarget).closest("tr")[0].dataset.variable)},"click #-rearm-metricColumns-submit":function(){this.saveSelectedRearmMetricColumn()},"click #-rearm-metricColumns-reset":function(){this.resetSelectedRearmMetricColumn()}},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.userPrivileges={}},serialize:function(){return e.assign(l.prototype.serialize.call(this),{divisions:this.serializeProdDivisions(),colors:this.serializeColors()})},serializeProdDivisions:function(){return a.getAllDivisions().filter(function(e){return"prod"===e.get("type")}).map(function(e){return{_id:e.id,label:e.getLabel(),subdivisions:a.getChildren(e).map(function(e){return{_id:e.id,label:e.getLabel()}}).sort(function(e,t){return e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0})})}}).sort(function(e,t){return e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0})})},serializeStorageSubdivisions:function(){return a.getAllByType("subdivision").filter(function(e){return"storage"===e.get("type")}).map(function(e){return{id:e.id,text:e.get("division")+" \\ "+e.get("name")}}).sort(function(e,t){return e.text.localeCompare(t.text,void 0,{numeric:!0,ignorePunctuation:!0})})},serializeColors:function(){var e={};return["quantityDone","lmh","mmh","efficiency","productivity","productivityNoWh","scheduledDowntime","unscheduledDowntime","clipOrderCount","clipProduction","clipEndToEnd","direct","directRef","indirect","indirectRef","warehouse","warehouseRef","absence","absenceRef","dirIndir","dirIndirRef","eff","ineff","hrTotal"].forEach(function(t){e[t]=this.settings.getColor(t)},this),e},afterRender:function(){l.prototype.afterRender.call(this);var e=this.serializeStorageSubdivisions();this.$id("wh-comp-id").select2({width:"374px",allowClear:!0,placeholder:" ",data:e}),this.$id("wh-finGoods-id").select2({width:"374px",allowClear:!0,placeholder:" ",data:e}),this.$('input[name$="prodTask"]').select2({width:"374px",allowClear:!0,placeholder:" ",data:this.prodTasks.serializeToSelect2()});var t=n.map(i);this.$('input[name$="aors"]').select2({allowClear:!0,multiple:!0,placeholder:" ",data:t}),this.$id("downtimesInAors-specificAor").select2({allowClear:!0,placeholder:" ",data:t}),this.setUpLeanSettings(),this.setUpClipSettings(),this.setUpRearmSettings(),this.onSettingsChange(this.settings.get("reports.downtimesInAors.statuses")),this.onSettingsChange(this.settings.get("reports.clip.ignoredMrps")),this.toggleDowntimesInAors(this.settings.getValue("downtimesInAors.aors"))},shouldAutoUpdateSettingField:function(e){return"reports.clip.ignoredMrps"!==e.id},updateSettingField:function(e){if("reports.rearm.downtimeColumns"===e.id)return this.renderRearmDowntimeColumns(),void this.updateSelectedRearmDowntimeColumn();if("reports.rearm.metricColumns"===e.id)return this.renderRearmMetricColumns(),void this.updateSelectedRearmMetricColumn();var t=this.$('input[name="'+e.id+'"]');return"reports.clip.ignoredMrps"===e.id?t.select2("data",e.getValue().map(function(e){return{id:e,text:e}})):t.hasClass("select2-offscreen")?t.select2("val",e.getValue()):void 0},toggleDowntimesInAors:function(e){null===e||"own"===e?(this.$('input[name="downtimesInAorsType"][value="own"]').prop("checked",!0),this.$id("downtimesInAors-aors").select2("enable",!1).select2("data",null)):(this.$('input[name="downtimesInAorsType"][value="specific"]').prop("checked",!0),this.$id("downtimesInAors-aors").select2("enable",!0))},toggleTabPrivileges:function(){var e=this.userPrivileges={all:!1};t.isAllowedTo("REPORTS:VIEW")?e.all=!0:this.$(".list-group-item[data-privileges]").each(function(){for(var i=this.dataset.privileges.split(","),a=0;a<i.length;++a){var n="REPORTS:"+i[a]+":VIEW";void 0===e[n]&&(e[n]=t.isAllowedTo(n)),e[n]||this.classList.add("disabled")}})},updateSettingOnInputChange:function(e){this.updateSetting(e.target.name,e.target.value)},setUpLeanSettings:function(){var e=this,t=a.getAllByType("subdivision").map(function(e){return{id:e.id,text:e.get("division")+" \\ "+e.getLabel()}}),n=r.map(i),s=this.prodTasks.serializeToSelect2(),o=this.serializeLeanProdFlows();this.$('input[name$="Subdivision"]').each(function(){e.$(this).select2({width:374,allowClear:!0,placeholder:" ",data:t})}),this.$('input[name$="DowntimeReasons"]').each(function(){e.$(this).select2({width:"100%",multiple:!0,allowClear:!0,placeholder:" ",data:n})}),this.$('input[name$="ProdTasks"]').each(function(){e.$(this).select2({width:"100%",multiple:!0,allowClear:!0,placeholder:" ",data:s})}),this.$('input[name$="ProdFlows"]').each(function(){e.$(this).select2({width:"100%",multiple:!0,allowClear:!0,placeholder:" ",data:o,formatResult:function(e,t,i,a){return e.deactivated?'<span style="text-decoration: line-through">'+a(e.text)+"</span>":a(e.text)},formatSelection:function(e,t,i){var a=e.deactivated?'<span style="text-decoration: line-through">'+i(e.text)+"</span>":i(e.text);return e.divisionId+": "+a}})})},setUpClipSettings:function(){var e=this;e.$id("clip-ignoredMrps").select2({width:"100%",allowClear:!0,placeholder:" ",multiple:!0,minimumResultsForSearch:-1,dropdownCssClass:"hidden",data:[],tokenizer:function(e,t,i){var a=e,n={};return t.forEach(function(e){n[e.id]=!0}),(e.match(/[A-Z0-9]{3,}[^A-Z0-9]/gi)||[]).forEach(function(e){a=a.replace(e,""),e=e.toUpperCase().replace(/[^A-Z0-9]+/g,""),n[e]||(i({id:e,text:e}),n[e]=!0)}),e===a?null:a.replace(/\s+/," ").trim()}}),e.$id("clip-ignoredDelayReasons").select2({width:"100%",allowClear:!0,placeholder:" ",multiple:!0,data:this.delayReasons.map(i)});var t=o.map(i);["ignoredStatuses","requiredStatuses","productionStatuses","endToEndStatuses","orderFilterStatuses"].forEach(function(i){e.$id("clip-"+i).select2({width:"100%",allowClear:!0,placeholder:" ",multiple:!0,data:t})})},serializeLeanProdFlows:function(){var t={};e.forEach(a.getAllByType("prodFlow"),function(e){var i=e.getSubdivision();i&&(t[i.id]||(t[i.id]=[]),t[i.id].push({id:e.id,text:e.getLabel(),divisionId:i.get("division"),deactivated:!!e.get("deactivatedAt")}))});var i=[];return a.getAllByType("division").filter(function(e){return"prod"===e.get("type")}).forEach(function(e){a.getChildren(e).forEach(function(a){"assembly"===a.get("type")&&i.push({text:e.id,children:t[a.id]||[]})})}),i},setUpRearmSettings:function(){this.$id("rearm-downtimeColumns-reasons").select2({width:"100%",multiple:!0,allowClear:!0,data:r.map(i)}),this.renderRearmDowntimeColumns(),this.renderRearmMetricColumns()},renderRearmDowntimeColumns:function(){let e="";this.model.getValue("rearm.downtimeColumns",[]).forEach(t=>{e+=this.renderPartialHtml(m,{row:{...t,reasons:t.reasons.map(e=>r.getLabel(e))}})}),this.$id("rearm-downtimeColumns-table").html(e),this.updateAvailRearmVars()},resetSelectedRearmDowntimeColumn:function(){this.$id("rearm-downtimeColumns-variable").val(""),this.$id("rearm-downtimeColumns-column").val(""),this.$id("rearm-downtimeColumns-description").val(""),this.$('input[name="rearm-downtimeColumns-exclude"][value="false"]').prop("checked",!0),this.$id("rearm-downtimeColumns-reasons").select2("val",[])},updateSelectedRearmDowntimeColumn:function(e){if(e||(e=this.$id("rearm-downtimeColumns-variable").val()),!e)return;const t=this.model.getValue("rearm.downtimeColumns",[]).find(t=>t.variable===e);t&&(this.$id("rearm-downtimeColumns-variable").val(t.variable),this.$id("rearm-downtimeColumns-column").val(t.column),this.$id("rearm-downtimeColumns-description").val(t.description),this.$(`input[name="rearm-downtimeColumns-exclude"][value="${t.exclude}"]`).prop("checked",!0),this.$id("rearm-downtimeColumns-reasons").select2("val",t.reasons))},saveSelectedRearmDowntimeColumn:function(){const e=this.$id("rearm-downtimeColumns-variable"),t=this.$id("rearm-downtimeColumns-column"),i=this.$id("rearm-downtimeColumns-description"),a=this.$('input[name="rearm-downtimeColumns-exclude"]:checked'),n=this.$id("rearm-downtimeColumns-reasons"),r={variable:e.val().trim(),column:t.val().trim(),description:i.val().trim(),exclude:!!a.length&&"true"===a.val(),reasons:n.select2("val")};if(!r.variable||!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(r.variable))return void e.focus();r.column||(r.column=r.variable);const s=[...this.model.getValue("rearm.downtimeColumns",[])],o=s.findIndex(e=>e.variable===r.variable);-1===o?s.push(r):s[o]=r,this.updateRearmColumnsSetting("rearm.downtimeColumns",s)},renderRearmMetricColumns:function(){let e="";this.model.getValue("rearm.metricColumns",[]).forEach(t=>{e+=this.renderPartialHtml(u,{row:t})}),this.$id("rearm-metricColumns-table").html(e),this.updateAvailRearmVars()},resetSelectedRearmMetricColumn:function(){this.$id("rearm-metricColumns-variable").val(""),this.$id("rearm-metricColumns-column").val(""),this.$id("rearm-metricColumns-description").val(""),this.$id("rearm-metricColumns-formula").val("")},updateSelectedRearmMetricColumn:function(e){if(e||(e=this.$id("rearm-metricColumns-variable").val()),!e)return;const t=this.model.getValue("rearm.metricColumns",[]).find(t=>t.variable===e);t&&(this.$id("rearm-metricColumns-variable").val(t.variable),this.$id("rearm-metricColumns-column").val(t.column),this.$id("rearm-metricColumns-description").val(t.description),this.$id("rearm-metricColumns-formula").val(t.formula))},saveSelectedRearmMetricColumn:function(){const e=this.$id("rearm-metricColumns-variable"),t=this.$id("rearm-metricColumns-column"),i=this.$id("rearm-metricColumns-description"),a=this.$id("rearm-metricColumns-formula"),n={variable:e.val().trim(),column:t.val().trim(),description:i.val().trim(),formula:a.val().trim()};if(!n.variable||!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(n.variable))return void e.focus();n.column||(n.column=n.variable),n.formula||(n.formula="0");const r=[...this.model.getValue("rearm.metricColumns",[])],s=r.findIndex(e=>e.variable===n.variable);-1===s?r.push(n):r[s]=n,this.updateRearmColumnsSetting("rearm.metricColumns",r)},updateRearmColumnsSetting:function(e,t){const i=this.$(`.panel-body[data-subtab="${e.split(".").pop()}"]`).find("button, input, textarea").prop("disabled",!0);this.updateSetting(`reports.${e}`,t).always(()=>{i.prop("disabled",!1)})},updateAvailRearmVars:function(){const e={IDLE:1,TT_SAP:1,TT_AVG:1,TT_MED:1,FIRST_AT:1,LAST_AT:1,PREV_AT:1,STARTED_AT:1,FINISHED_AT:1,QTY_DONE:1,WORKER_COUNT:1,EFF:1,EFF_COEFF:1,LABOR_TIME:1,IDX_OVERALL:1,IDX_SHIFT:1};this.model.getValue("rearm.downtimeColumns",[]).forEach(t=>e[t.variable]=1),this.model.getValue("rearm.metricColumns",[]).forEach(t=>e[t.variable]=1),this.$id("rearm-availVars").html(Object.keys(e).map(e=>`<code>${e}</code>`).join(", "))}})});