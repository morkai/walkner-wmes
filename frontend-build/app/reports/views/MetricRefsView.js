// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/core/View","app/data/orgUnits","app/reports/templates/metricRefs"],function(e,t,i,r){return t.extend({template:r,localTopics:{"divisions.synced":"render","subdivisions.synced":"render"},events:{"click .reports-metricRefs-tab > a":function(e){var t=this.$(e.target).closest("[data-metric]").attr("data-metric");return this.broker.publish("router.navigate",{url:"#reports;metricRefs?tab="+t,trigger:!1,replace:!0}),this.changeTab(t),!1},"change .form-control":"updateRemoteMetricRef","keyup .form-control":"updateRemoteMetricRef"},initialize:function(){this.idPrefix=e.uniqueId("metricRefs"),this.currentMetric=null,this.listenTo(this.metricRefs,"add",this.updateLocalMetricRef),this.listenTo(this.metricRefs,"change",this.updateLocalMetricRef)},serialize:function(){function e(e,t){return e.label.localeCompare(t.label)}return{idPrefix:this.idPrefix,divisions:i.getAllDivisions().filter(function(e){return"prod"===e.get("type")}).map(function(t){return{_id:t.id,label:t.getLabel(),subdivisions:i.getChildren(t).map(function(e){return{_id:e.id,label:e.getLabel()}}).sort(e)}}).sort(e)}},afterRender:function(){this.changeTab(this.currentMetric||this.options.initialTab||"efficiency")},changeTab:function(e){this.currentMetric=e,this.$(".reports-metricRefs-tab.active").removeClass("active"),this.$(".reports-metricRefs-tab[data-metric="+e+"]").addClass("active");var t=this;this.$(".form-control").each(function(){this.value=t.metricRefs.getValue(e,this.name)})},updateLocalMetricRef:function(e){var t=this.metricRefs.parseSettingId(e.id);this.currentMetric===t.metric&&this.$('.form-control[name="'+t.orgUnit+'"]').val(e.get("value"))},updateRemoteMetricRef:e.debounce(function(e){this.promised(this.metricRefs.updateValue(this.currentMetric,e.target.name,parseInt(e.target.value,10)))},300)})});