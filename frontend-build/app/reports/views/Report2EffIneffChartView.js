// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","screenfull","app/highcharts","app/i18n","app/core/View","app/data/categoryFactory","../util/wordwrapTooltip"],function(e,t,r,i,s,n,a){var o="#ee0",h="#000",f={absenceRef:!0,dirIndir:!0,dirIndirRef:!0,eff:!0,ineff:!0};return s.extend({className:function(){return"reports-chart reports-2-effIneff"},initialize:function(){this.shouldRenderChart=!this.options.skipRenderChart,this.chart=null,this.isFullscreen=!1,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:effIneff change:prodTasks",e.debounce(this.render,1)),this.listenTo(this.settings,"add change",this.onSettingsUpdate),this.listenTo(this.displayOptions,"change",e.debounce(this.onDisplayOptionsChange,1))},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.chart?this.updateChart():this.shouldRenderChart&&(this.createChart(),this.isLoading&&this.chart.showLoading()),this.shouldRenderChart=!0},updateChart:function(t,r){var i=this.chart,s=this.serializeChartData();i.xAxis[0].setCategories(s.categories,!1),r&&this.updateExtremes(!1);var n=i.series[1],a=e.any(s.reference,function(e){return e.y>0});n.visible!==a&&n.setVisible(a,!1),i.series[0].setData(s.data,!1,!1,!1),n.setData(s.reference,!1,!1,!1),t!==!1&&i.redraw(!1)},updateExtremes:function(e){var t=null;this.isFullscreen||this.model.get("isParent")&&"parent"!==this.model.get("extremes")||(t=this.displayOptions.get("maxResourceFte")),this.chart.yAxis[0].setExtremes(0,t,e,!1)},onSettingsUpdate:function(e){f[e.getMetricName()]&&this.updateChart()},onDisplayOptionsChange:function(){var e=this.displayOptions.changedAttributes(),t=this.displayOptions.previousAttributes(),r=!1;void 0!==e.maxResourceFte&&(this.updateExtremes(!1),r=!0);var i=e.series&&(e.series.dirIndir!==t.series.dirIndir||e.series.effIneff!==t.series.effIneff),s=e.references&&(e.references.dirIndir!==t.references.dirIndir||e.references.absence!==t.references.absence);(i||s||e.prodTasks)&&(this.updateChart(!0,!1),r=!1),r&&this.chart.redraw(!1)},serializeChartData:function(){var e=this.model,t=e.get("prodTasks"),r=e.get("effIneff"),s=[],f=[],d=[];if(0===r.value&&0===r.dirIndir)return{categories:s,data:f,reference:d};var c=this.settings,l=this.displayOptions;l.isSeriesVisible("effIneff")&&f.push({key:"effIneff",category:i("reports","effIneff:category:value"),name:i("reports","effIneff:name:value"),y:Math.abs(r.value),color:c.getColor(r.value>0?"eff":"ineff")}),l.isSeriesVisible("dirIndir")&&f.push({key:"dirIndir",category:i("reports","effIneff:category:dirIndir"),name:i("reports","effIneff:name:dirIndir"),y:r.dirIndir,color:c.getColor("dirIndir")});var u=l.get("prodTasks");Object.keys(r.prodTasks).forEach(function(e){if(u[e]){var i=t[e];f.push({key:e,category:n.getCategory("tasks",e),name:a(i?i.label:e),y:r.prodTasks[e],color:i?i.color:o})}});var p=c.getValue("absenceRef.prodTask");f.sort(function(e,t){return t.y-e.y}).forEach(function(t){s.push(t.category);var r={y:null,color:null};"dirIndir"===t.key&&l.isReferenceVisible("dirIndir")?(r.y=Math.round(10*e.getDirIndirRef(c.getCoeff("dirIndirRef")))/10,r.color=c.getColor("dirIndirRef")):t.key===p&&l.isReferenceVisible("absence")&&(r.y=Math.round(10*e.getAbsenceRef(c.getCoeff("absenceRef")))/10,r.color=c.getColor("absenceRef")),d.push(r)},this);var g=s.length,y=10;if(!this.isFullscreen&&g>y+1){for(var I=y-1,m=s.slice(0,I),b=f.slice(0,I),C=d.slice(0,I),v=0,R=y;g>R;++R)v+=f[R].y;m.push(i("reports","effIneff:category:other")),b.push({name:i("reports","effIneff:name:other"),y:Math.round(10*v)/10,color:h}),C.push(null),s=m,f=b,d=C}if(this.isFullscreen)for(var x=0;g>x;++x)s[x]=f[x].name;return{categories:s,data:f,reference:d}},onFullscreen:function(e){this.isFullscreen=e,this.chart.series.forEach(function(t){t.update({dataLabels:{enabled:e}},!1)}),this.updateChart(!1)},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},createChart:function(){this.chart=new r.Chart({chart:{renderTo:this.el,zoomType:null},exporting:{filename:i("reports","filenames:2:effIneff")},title:{text:i("reports","effIneff:title")},noData:{},xAxis:{categories:[]},yAxis:{title:!1},tooltip:{shared:!0},legend:!1,series:[{name:i("reports","effIneff:seriesName"),type:"column",data:[]},{id:"reference",name:i.bound("reports","referenceValue"),type:"column",data:[]}]})}})});