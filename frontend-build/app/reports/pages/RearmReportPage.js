define(["app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/pageActions","../RearmReport","../views/rearm/FilterView","../views/rearm/LineView","app/reports/templates/rearm/page"],function(e,t,i,r,n,o,s,a){"use strict";return t.extend({layoutName:"page",template:a,breadcrumbs:function(){return[this.t("rearm:breadcrumb")]},actions:function(){return[{icon:"download",label:this.t("core","PAGE_ACTION:export"),callback:this.export.bind(this)},{label:this.t("PAGE_ACTION:settings"),icon:"cogs",privileges:"REPORTS:MANAGE",href:"#reports;settings?tab=rearm"}]},initialize:function(){this.model=i(this.model,this),this.setView("#-filter",new o({model:this.model})),this.once("afterRender",()=>{this.listenTo(this.model,"filtered",this.onFiltered),this.listenTo(this.model.lines,"reset",()=>this.renderLines(!0))})},load:function(e){return this.options.autoLoad?e(this.model.fetch()):e()},onFiltered:function(){this.promised(this.model.fetch()),this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!1,replace:!0})},beforeRender:function(){this.renderLines(!1)},renderLines:function(e){this.removeView("#-lines"),this.model.lines.forEach(t=>{var i=new s({model:this.model,line:t});this.insertView("#-lines",i),e&&i.render()})},export:function(){const t=this;e.msg.loading();const i={line:{type:"string",width:10,caption:a("line"),position:1},orderNo:{type:"string",width:10,caption:a("orderNo")},mrp:{type:"string",width:5,caption:a("mrp")},shiftAt:{type:"date",caption:a("date")},shiftNo:{type:"integer",width:7,caption:a("shift")},startedAt:{type:"time",caption:a("startedAt")},finishedAt:{type:"time",caption:a("finishedAt")},firstAt:{type:"time",caption:a("firstAt")},lastAt:{type:"time",caption:a("lastAt")},sapTaktTime:{type:"integer",width:8,caption:a("sapTaktTime")},avgTaktTime:{type:"integer",width:8,caption:a("avgTaktTime")},medTaktTime:{type:"integer",width:8,caption:a("medTaktTime")},quantityDone:{type:"integer",width:8,caption:a("quantityDone")},workerCount:{type:"integer",width:8,caption:a("workerCount")},efficiency:{type:"integer",width:8,caption:a("efficiency")},idle:{type:"integer",width:8,caption:a("idle")}},{settings:n}=t.model.get("report");(n.downtimeColumns||[]).concat(n.metricColumns||[]).forEach(e=>{i[e.variable]={type:"integer",width:8,caption:e.variable}});const o=[];t.model.lines.forEach(e=>{e.get("orders").forEach(e=>{e={...e},(n.downtimeColumns||[]).forEach((t,i)=>{e[t.variable]=e.downtimes[i]}),(n.metricColumns||[]).forEach((t,i)=>{e[t.variable]=e.metrics[i]}),delete e.prodShift,delete e.prodShiftOrder,delete e.downtimes,delete e.metrics,o.push(e)})});const s=t.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify({filename:t.t("rearm:export:fileName"),sheetName:t.t("rearm:export:sheetName"),freezeRows:1,columns:i,data:o})});function a(e){return t.t(`rearm:column:${e}`).replace(/([^\s])-([^\s])/g,"$1$2")}s.fail(()=>{e.msg.loaded(),e.msg.show({type:"error",time:2500,text:t.t("core","MSG:EXPORTING_FAILURE")})}),s.done(t=>{e.msg.loaded(),r.exportXlsx(`/xlsxExporter/${t}`)})}})});