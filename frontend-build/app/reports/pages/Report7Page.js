define(["jquery","app/time","app/i18n","app/user","app/core/View","app/core/util/bindLoadingMessage","app/core/util/pageActions","../settings","../Report7","../Report7Query","../views/7/FilterView","../views/7/InoutChartView","../views/2/ClipChartView","app/prodDowntimes/ProdDowntimeCollection","app/prodDowntimes/views/ProdDowntimeListView","app/reports/templates/7/page","app/reports/templates/7/exportPageAction"],function(t,e,i,s,r,n,o,a,p,h,l,d,u,c,w,m,f){"use strict";return r.extend({layoutName:"page",pageId:"report7",template:m,breadcrumbs:[i.bound("reports","BREADCRUMB:7")],events:{"mouseup .highcharts-title":function(t){var i=e.getMoment().startOf("week"),s="#reports/2?interval=day&from="+i.valueOf()+"&to="+i.add(1,"week").valueOf();1===t.button?window.open(s):window.location.href=s}},actions:function(){var t=this,e=t.onExportMenuItemClick.bind(t);return[{template:f.bind(null,{urls:t.getExportUrls()}),afterRender:function(i){t.$exportAction=i.on("click","a[data-export]",e)}},{label:i.bound("reports","PAGE_ACTION:settings"),icon:"cogs",privileges:"REPORTS:MANAGE",href:"#reports;settings?tab=downtimesInAors"}]},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.setView(".filter-container",this.filterView),this.setView(".reports-7-clip-container",this.clipChartView),this.setView(".reports-7-downtimes-container",this.prodDowntimeListView),this.setView(".reports-7-downtimeTimes-container",this.downtimeTimesChartView),this.setView(".reports-7-downtimeCounts-container",this.downtimeCountsChartView)},destroy:function(){a.release()},defineModels:function(){this.settings=n(a.acquire(),this),this.query=h.fromQuery(this.options.query,{settings:this.settings}),this.report=n(new p(null,{query:this.query}),this),this.prodDowntimes=n(new c(null,{rqlQuery:{fields:{changes:0},sort:{startedAt:-1},limit:this.query.get("limit"),skip:this.query.get("skip"),selector:this.query.createProdDowntimesSelector()}}),this),this.prodDowntimes.genPaginationUrlTemplate=this.genPaginationUrlTemplate.bind(this),this.paginationData=this.prodDowntimes.paginationData},defineViews:function(){this.filterView=new l({model:this.query}),this.clipChartView=new u({skipRenderChart:!0,settings:this.settings,model:this.report}),this.prodDowntimeListView=new w({simple:!0,collection:this.prodDowntimes,replaceUrl:!0,columns:function(){return w.prototype.columns.apply(this,arguments).filter(function(t){return t&&"aor"!==t&&"aor"!==t.id})}}),this.downtimeTimesChartView=new d({type:"downtimeTimes",model:this.report}),this.downtimeCountsChartView=new d({type:"downtimeCounts",model:this.report})},defineBindings:function(){this.listenTo(this.prodDowntimes.paginationData,"change",function(){var t={limit:this.paginationData.get("limit"),skip:this.paginationData.get("skip")};this.query.set(t,{silent:!0})}),this.listenTo(this.query,"change:skip",function(){this.prodDowntimes.rqlQuery.skip=this.query.get("skip")}),this.listenTo(this.query,"change:limit",function(){this.prodDowntimes.rqlQuery.limit=this.query.get("limit")}),this.listenTo(this.query,"change",this.onQueryChange),this.once("afterRender",function(){this.prodDowntimes.rqlQuery.selector=this.query.createProdDowntimesSelector(),this.promised(this.report.fetch()),this.promised(this.prodDowntimes.fetch({reset:!0})),this.updateExportUrls()})},load:function(t){return t(this.settings.fetchIfEmpty())},onQueryChange:function(t,e){this.query.set({skip:0},{silent:!0}),this.prodDowntimes.rqlQuery.skip=0,this.prodDowntimes.rqlQuery.selector=this.query.createProdDowntimesSelector(),this.promised(this.prodDowntimes.fetch({reset:!0})),this.promised(this.report.fetch()),e&&e.reset&&this.broker.publish("router.navigate",{url:this.report.url()+"?"+this.query.serializeToString(),replace:!0,trigger:!1}),this.updateExportUrls()},afterRender:function(){a.acquire()},genPaginationUrlTemplate:function(){return"#reports/7?"+this.query.serializeToString().replace(/limit=[0-9]+/,"limit=${limit}").replace(/skip=[0-9]+/,"skip=${skip}")},getExportUrls:function(){return{clip:"#",downtimes:"/prodDowntimes;export."+(window.XLSX_EXPORT?"xlsx":"csv")+"?"+this.prodDowntimes.rqlQuery,downtimeTimes:"#",downtimeCounts:"#"}},updateExportUrls:function(){if(this.$exportAction){var t=this.getExportUrls();this.$exportAction.find("a[data-export]").each(function(){this.href=t[this.dataset.export]})}},onExportMenuItemClick:function(e){var s=e.target.dataset.export;if(e.preventDefault(),"downtimes"!==s){var r;r="clip"===s?this.clipChartView:"downtimeTimes"===s?this.downtimeTimesChartView:this.downtimeCountsChartView;var n=i("reports","filenames:7:"+s),a=r.serializeToCsv(),p=t(e.target).closest(".btn-group").find(".btn").prop("disabled",!0),h=this.ajax({type:"POST",url:"/reports;download?filename="+encodeURIComponent(n),contentType:"text/csv",data:a});h.done(function(t){window.open("/reports;download?key="+t)}),h.always(function(){p[0].disabled=!1})}else o.exportXlsx(e.target.href)}})});