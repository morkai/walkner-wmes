// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["h5.rql/index","app/time","app/i18n","app/core/View","app/core/util/bindLoadingMessage","../settings","../Report7","../Report7Query","../views/Report7FilterView","../views/Report7InoutChartView","../views/Report2ClipChartView","app/prodDowntimes/ProdDowntimeCollection","app/prodDowntimes/views/ProdDowntimeListView","app/reports/templates/report7Page"],function(t,e,i,s,r,n,o,a,h,p,l,u,w,d){"use strict";return s.extend({layoutName:"page",pageId:"report7",template:d,breadcrumbs:[i.bound("reports","BREADCRUMBS:7")],events:{"mouseup .highcharts-title":function(t){var i=e.getMoment().startOf("week"),s="#reports/2?interval=day&from="+i.valueOf()+"&to="+i.add(1,"week").valueOf();1===t.button?window.open(s):window.location.href=s}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.setView(".filter-container",this.filterView),this.setView(".reports-7-clip-container",this.clipChartView),this.setView(".reports-7-downtimes-container",this.prodDowntimeListView),this.setView(".reports-7-downtimeTimes-container",this.downtimeTimesChartView),this.setView(".reports-7-downtimeCounts-container",this.downtimeCountsChartView)},destroy:function(){n.release()},defineModels:function(){this.settings=r(n.acquire(),this),this.query=a.fromQuery(this.options.query),this.report=r(new o(null,{query:this.query}),this),this.prodDowntimes=r(new u(null,{rqlQuery:{fields:{changes:0},sort:{startedAt:-1},limit:this.query.get("limit"),skip:this.query.get("skip"),selector:this.query.createProdDowntimesSelector()}}),this),this.prodDowntimes.genPaginationUrlTemplate=this.genPaginationUrlTemplate.bind(this),this.paginationData=this.prodDowntimes.paginationData},defineViews:function(){this.filterView=new h({model:this.query}),this.clipChartView=new l({skipRenderChart:!0,settings:this.settings,model:this.report}),this.prodDowntimeListView=new w({simple:!0,collection:this.prodDowntimes,columns:w.prototype.columns.filter(function(t){return"aor"!==t&&"aor"!==t.id})}),this.downtimeTimesChartView=new p({type:"downtimeTimes",valueSuffix:"h",valueDecimals:2,model:this.report}),this.downtimeCountsChartView=new p({type:"downtimeCounts",model:this.report})},defineBindings:function(){this.listenTo(this.prodDowntimes.paginationData,"change",function(){var t={limit:this.paginationData.get("limit"),skip:this.paginationData.get("skip")};this.query.set(t,{silent:!0})}),this.listenTo(this.query,"change:skip",function(){this.prodDowntimes.rqlQuery.skip=this.query.get("skip")}),this.listenTo(this.query,"change:limit",function(){this.prodDowntimes.rqlQuery.limit=this.query.get("limit")}),this.listenTo(this.query,"change",this.onQueryChange)},load:function(t){return t(this.settings.fetchIfEmpty(function(){return[this.report.fetch(),this.prodDowntimes.fetch({reset:!0})]},this))},onQueryChange:function(t,e){var i=this.query.changedAttributes();(i.statuses||i.aors)&&(this.query.set({skip:0},{silent:!0}),this.prodDowntimes.rqlQuery.skip=0,this.prodDowntimes.rqlQuery.selector=this.query.createProdDowntimesSelector(),this.promised(this.prodDowntimes.fetch({reset:!0}))),i.aors&&this.promised(this.report.fetch()),e&&e.reset&&this.broker.publish("router.navigate",{url:this.report.url()+"?"+this.query.serializeToString(),replace:!0,trigger:!1})},afterRender:function(){n.acquire()},genPaginationUrlTemplate:function(){var t=this.query.serializeToString().replace(/limit=[0-9]+/,"limit=${limit}").replace(/skip=[0-9]+/,"skip=${skip}");return"#reports/7?"+t}})});