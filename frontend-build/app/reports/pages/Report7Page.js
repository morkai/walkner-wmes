// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/time","app/i18n","app/user","app/core/View","app/core/util/bindLoadingMessage","../settings","../Report7","../Report7Query","../views/7/FilterView","../views/7/InoutChartView","../views/2/ClipChartView","app/prodDowntimes/ProdDowntimeCollection","app/prodDowntimes/views/ProdDowntimeListView","app/reports/templates/7/page","app/reports/templates/7/exportPageAction"],function(t,e,i,s,r,n,o,a,p,h,l,d,u,c,m,w){"use strict";return r.extend({layoutName:"page",pageId:"report7",template:m,breadcrumbs:[i.bound("reports","BREADCRUMBS:7")],events:{"mouseup .highcharts-title":function(t){var i=e.getMoment().startOf("week"),s="#reports/2?interval=day&from="+i.valueOf()+"&to="+i.add(1,"week").valueOf();1===t.button?window.open(s):window.location.href=s}},actions:function(){var t=this.onExportMenuItemClick.bind(this);return[{template:w.bind(null,{urls:this.getExportUrls()}),afterRender:function(e){e.on("click","a[data-export]",t)}},{label:i.bound("reports","PAGE_ACTION:settings"),icon:"cogs",privileges:"REPORTS:MANAGE",href:"#reports;settings?tab=downtimesInAors"}]},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.setView(".filter-container",this.filterView),this.setView(".reports-7-clip-container",this.clipChartView),this.setView(".reports-7-downtimes-container",this.prodDowntimeListView),this.setView(".reports-7-downtimeTimes-container",this.downtimeTimesChartView),this.setView(".reports-7-downtimeCounts-container",this.downtimeCountsChartView)},destroy:function(){o.release()},defineModels:function(){this.settings=n(o.acquire(),this),this.query=p.fromQuery(this.options.query,{settings:this.settings}),this.report=n(new a(null,{query:this.query}),this),this.prodDowntimes=n(new u(null,{rqlQuery:{fields:{changes:0},sort:{startedAt:-1},limit:this.query.get("limit"),skip:this.query.get("skip"),selector:this.query.createProdDowntimesSelector()}}),this),this.prodDowntimes.genPaginationUrlTemplate=this.genPaginationUrlTemplate.bind(this),this.paginationData=this.prodDowntimes.paginationData},defineViews:function(){this.filterView=new h({model:this.query}),this.clipChartView=new d({skipRenderChart:!0,settings:this.settings,model:this.report}),this.prodDowntimeListView=new c({simple:!0,collection:this.prodDowntimes,replaceUrl:!0,columns:c.prototype.columns.filter(function(t){return"aor"!==t&&"aor"!==t.id})}),this.downtimeTimesChartView=new l({type:"downtimeTimes",model:this.report}),this.downtimeCountsChartView=new l({type:"downtimeCounts",model:this.report})},defineBindings:function(){this.listenTo(this.prodDowntimes.paginationData,"change",function(){var t={limit:this.paginationData.get("limit"),skip:this.paginationData.get("skip")};this.query.set(t,{silent:!0})}),this.listenTo(this.query,"change:skip",function(){this.prodDowntimes.rqlQuery.skip=this.query.get("skip")}),this.listenTo(this.query,"change:limit",function(){this.prodDowntimes.rqlQuery.limit=this.query.get("limit")}),this.listenTo(this.query,"change",this.onQueryChange),this.once("afterRender",function(){this.prodDowntimes.rqlQuery.selector=this.query.createProdDowntimesSelector(),this.promised(this.report.fetch()),this.promised(this.prodDowntimes.fetch({reset:!0}))})},load:function(t){return t(this.settings.fetchIfEmpty())},onQueryChange:function(t,e){this.query.set({skip:0},{silent:!0}),this.prodDowntimes.rqlQuery.skip=0,this.prodDowntimes.rqlQuery.selector=this.query.createProdDowntimesSelector(),this.promised(this.prodDowntimes.fetch({reset:!0})),this.promised(this.report.fetch()),e&&e.reset&&this.broker.publish("router.navigate",{url:this.report.url()+"?"+this.query.serializeToString(),replace:!0,trigger:!1}),this.updateExportUrls()},afterRender:function(){o.acquire()},genPaginationUrlTemplate:function(){var t=this.query.serializeToString().replace(/limit=[0-9]+/,"limit=${limit}").replace(/skip=[0-9]+/,"skip=${skip}");return"#reports/7?"+t},getExportUrls:function(){return{clip:"#",downtimes:"/prodDowntimes;export?"+this.prodDowntimes.rqlQuery,downtimeTimes:"#",downtimeCounts:"#"}},updateExportUrls:function(){if(this.$exportAction){var t=this.getExportUrls();this.$exportAction.find("a[data-export]").each(function(){this.href=t[this.dataset.export]})}},onExportMenuItemClick:function(e){var s=e.target.dataset.export;if("downtimes"!==s){e.preventDefault();var r;r="clip"===s?this.clipChartView:"downtimeTimes"===s?this.downtimeTimesChartView:this.downtimeCountsChartView;var n=i("reports","filenames:7:"+s),o=r.serializeToCsv(),a=t(e.target).closest(".btn-group").find(".btn").prop("disabled",!0),p=this.ajax({type:"POST",url:"/reports;download?filename="+encodeURIComponent(n),contentType:"text/csv",data:o});p.done(function(t){window.location.href="/reports;download?key="+t}),p.always(function(){a[0].disabled=!1})}}})});