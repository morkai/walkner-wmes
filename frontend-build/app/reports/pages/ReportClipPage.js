// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/core/util/bindLoadingMessage","app/core/util/pageActions","app/data/orgUnits","app/delayReasons/storage","./DrillingReportPage","../ReportClipOrderCollection","../ReportClipQuery","../ReportClipDisplayOptions","../ReportClipPlanners","../views/clip/HeaderView","../views/clip/FilterView","../views/clip/DisplayOptionsView","../views/clip/ChartsView","../views/clip/OrdersView","app/reports/templates/clip/page"],function(e,t,i,s,n,r,o,a,p,l,d,h,u,c,g,y,f){"use strict";return o.extend({template:f,rootBreadcrumbKey:"BREADCRUMBS:2",initialSettingsTab:"clip",maxOrgUnitLevel:"prodFlow",pageId:"clipReport",remoteTopics:{"orders.updated.*":"onOrderUpdated"},actions:function(e){var i=o.prototype.actions.call(this);return i.unshift(s.export({layout:e,page:this,collection:this.orders,privilege:!1,label:t("reports","PAGE_ACTION:2:export")})),i},setUpLayout:function(e){this.layout=e},initialize:function(){o.prototype.initialize.call(this),this.setView("#-orders",this.ordersView)},destroy:function(){o.prototype.destroy.call(this),r.release(),this.layout=null},defineModels:function(){o.prototype.defineModels.call(this),this.planners=i(new d,this),this.delayReasons=i(r.acquire(),this),this.orders=i(new a(null,{query:this.query,displayOptions:this.displayOptions}),this),this.paginationData=this.orders.paginationData},defineViews:function(){o.prototype.defineViews.call(this),this.ordersView=new y({collection:this.orders,planners:this.planners,delayReasons:this.delayReasons})},defineBindings:function(){var e=this;o.prototype.defineBindings.call(e),e.listenTo(e.orders.paginationData,"change",function(){var t={limit:e.paginationData.get("limit"),skip:e.paginationData.get("skip")};e.query.set(t,{silent:!0})}),e.listenTo(e.query,"change",function(){e.layout.setActions(e.actions,e)}),e.listenTo(e.query,"change:skip",function(){e.orders.rqlQuery.skip=e.query.get("skip")}),e.listenTo(e.query,"change:limit",function(){e.orders.rqlQuery.limit=e.query.get("limit")}),e.listenTo(e,"loading:started",function(t){0===t&&(e.orders.hash=null,e.orders.reset([]))}),e.listenTo(e,"loading:completed",function(){e.loadMrpsIfNecessary();var t=e.reports[0];e.query.set({orderHash:t.get("orderHash"),orderCount:t.get("orderCount")},{silent:!0})}),e.listenTo(e,"loading:finishing",function(){e.orders.hash!==e.query.get("orderHash")&&e.orders.fetch({reset:!0})}),e.listenTo(e,"operation:completed",function(t){e.removeExtraChart="drillingUp"===t})},onDisplayOptionsChange:function(e){o.prototype.onDisplayOptionsChange.call(this,e),this.paginationData.set("urlTemplate",this.orders.genPaginationUrlTemplate())},getQueryDataForOrgUnitChange:function(t){return e.extend(o.prototype.getQueryDataForOrgUnitChange.call(this,t),{skip:0})},getOrgUnitFromChartsElement:function(t){var i=o.prototype.getOrgUnitFromChartsElement.apply(this,arguments),s=!t.prev().length;if("division"===i.type){var r=n.getByTypeAndId("division",i.id),a=n.getChildren(r).filter(function(e){return"assembly"===e.get("type")});if(1===a.length&&!s)return{type:"subdivision",id:a[0].id};if(1===a.length&&s)return{type:null,id:null}}else if("subdivision"===i.type&&s){var p=t.attr("data-orgUnitId"),l=e.find(this.reports,function(e){return e.get("orgUnit").id===p});i.id=l.get("parent")}return i},load:function(e){return e(this.planners.fetch(),this.delayReasons.isEmpty()?this.delayReasons.fetch({reset:!0}):null,this.settings.isEmpty()?this.settings.fetch({reset:!0}):null)},afterRender:function(){o.prototype.afterRender.call(this),r.acquire(),this.loadMrpsIfNecessary()},createQuery:function(){return new p(this.options.query)},createDisplayOptions:function(){var e={settings:this.settings};return"string"==typeof this.options.displayOptions?l.fromString(this.options.displayOptions,e):new l(this.options.displayOptions,e)},createHeaderView:function(){return new h({model:this.query,displayOptions:this.displayOptions})},createFilterView:function(){return new u({model:this.query})},createDisplayOptionsView:function(){return new c({model:this.displayOptions})},createChartsView:function(e,t){return new g({model:e,settings:this.settings,displayOptions:this.displayOptions,delayReasons:this.delayReasons,skipRenderCharts:!!t})},createReportOptions:function(){return e.assign(o.prototype.createReportOptions.apply(this,arguments),{delayReasons:r.acquire()})},onOrderUpdated:function(t){var i=this.orders.get(t._id);if(i){var s=t.change,n=s.newValues.delayReason,r=s.comment,o={};e.isUndefined(n)||(o.delayReason=n),e.isEmpty(r)||(o.comment=r),i.set(o),i.get("changes").push(s),i.trigger("push:change",s),this.orders.trigger("push:change",s)}},loadMrpsIfNecessary:function(){var e=this.query.get("orgUnitType");e&&"division"!==e&&0!==this.reports.length&&0!==this.reports[0].get("children").length&&(this.headerView.update(this.reports[0]),1===this.reports.length?this.drillDown(!1):this.removeExtraChart&&(this.views[".reports-drillingCharts-container"][1].remove(),this.removeExtraChart=!1))}})});