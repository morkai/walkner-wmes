define(["underscore","app/i18n","app/core/util/bindLoadingMessage","app/core/util/pageActions","app/delayReasons/storage","./DrillingReportPage","../Report2OrderCollection","../Report2Query","../Report2DisplayOptions","../views/2/HeaderView","../views/2/FilterView","../views/2/DisplayOptionsView","../views/2/ChartsView","../views/2/OrdersView","app/reports/templates/2/page"],function(t,e,i,s,n,r,o,a,p,l,h,d,u,c,y){"use strict";return r.extend({template:y,rootBreadcrumbKey:"BREADCRUMBS:2",initialSettingsTab:"clip",maxOrgUnitLevel:"prodFlow",pageId:"report2",remoteTopics:{"orders.updated.*":"onOrderUpdated"},actions:function(t){var i=r.prototype.actions.call(this);return i.unshift(s.export({layout:t,page:this,collection:this.orders,privilege:!1,label:e("reports","PAGE_ACTION:2:export")})),i},setUpLayout:function(t){this.layout=t},initialize:function(){r.prototype.initialize.call(this),this.setView(".reports-2-orders-container",this.ordersView)},destroy:function(){r.prototype.destroy.call(this),n.release(),this.layout=null},defineModels:function(){r.prototype.defineModels.call(this),this.delayReasons=i(n.acquire(),this),this.orders=i(new o(null,{query:this.query,displayOptions:this.displayOptions}),this),this.paginationData=this.orders.paginationData},defineViews:function(){r.prototype.defineViews.call(this),this.ordersView=new c({collection:this.orders,delayReasons:this.delayReasons})},defineBindings:function(){r.prototype.defineBindings.call(this),this.listenTo(this.orders.paginationData,"change",function(){var t={limit:this.paginationData.get("limit"),skip:this.paginationData.get("skip")};this.query.set(t,{silent:!0})}),this.listenTo(this.query,"change",function(){this.layout.setActions(this.actions,this)}),this.listenTo(this.query,"change:skip",function(){this.orders.rqlQuery.skip=this.query.get("skip")}),this.listenTo(this.query,"change:limit",function(){this.orders.rqlQuery.limit=this.query.get("limit")})},onQueryChange:function(t,e){r.prototype.onQueryChange.call(this,t,e),this.promised(this.orders.fetch({reset:!0}))},onDisplayOptionsChange:function(t){r.prototype.onDisplayOptionsChange.call(this,t),this.paginationData.set("urlTemplate",this.orders.genPaginationUrlTemplate())},getQueryDataForOrgUnitChange:function(e){return t.extend(r.prototype.getQueryDataForOrgUnitChange.call(this,e),{skip:0})},load:function(t){return t(this.orders.fetch({reset:!0}),this.delayReasons.isEmpty()?this.delayReasons.fetch({reset:!0}):null,this.settings.isEmpty()?this.settings.fetch({reset:!0}):null)},afterRender:function(){r.prototype.afterRender.call(this),n.acquire()},createQuery:function(){return new a(this.options.query)},createDisplayOptions:function(){var t={settings:this.settings};return"string"==typeof this.options.displayOptions?p.fromString(this.options.displayOptions,t):new p(this.options.displayOptions,t)},createHeaderView:function(){return new l({model:this.query,displayOptions:this.displayOptions})},createFilterView:function(){return new h({model:this.query})},createDisplayOptionsView:function(){return new d({model:this.displayOptions})},createChartsView:function(t,e){return new u({model:t,settings:this.settings,displayOptions:this.displayOptions,skipRenderCharts:!!e})},onOrderUpdated:function(t){var e=this.orders.get(t._id);e&&(e.set({_id:e.id,delayReason:t.delayReason}),e.get("changes").push(t.change),e.trigger("push:change",t.change),this.orders.trigger("push:change",t.change))}})});