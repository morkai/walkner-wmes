// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/core/util/bindLoadingMessage","app/delayReasons/storage","./DrillingReportPage","../Report2OrderCollection","../Report2Query","../Report2DisplayOptions","../views/Report2HeaderView","../views/Report2FilterView","../views/Report2DisplayOptionsView","../views/Report2ChartsView","../views/Report2OrdersView","app/reports/templates/report2Page"],function(e,t,i,s,n,r,o,a,p,l,h,d,u){"use strict";return s.extend({template:u,rootBreadcrumbKey:"BREADCRUMBS:2",initialSettingsTab:"clip",maxOrgUnitLevel:"prodFlow",pageId:"report2",remoteTopics:{"orders.updated.*":"onOrderUpdated"},initialize:function(){s.prototype.initialize.call(this),this.setView(".reports-2-orders-container",this.ordersView)},destroy:function(){s.prototype.destroy.call(this),i.release()},defineModels:function(){s.prototype.defineModels.call(this),this.delayReasons=t(i.acquire(),this),this.orders=t(new n(null,{query:this.query,displayOptions:this.displayOptions}),this),this.paginationData=this.orders.paginationData},defineViews:function(){s.prototype.defineViews.call(this),this.ordersView=new d({collection:this.orders,delayReasons:this.delayReasons})},defineBindings:function(){s.prototype.defineBindings.call(this),this.listenTo(this.orders.paginationData,"change",function(){var e={limit:this.paginationData.get("limit"),skip:this.paginationData.get("skip")};this.query.set(e,{silent:!0})}),this.listenTo(this.query,"change:skip",function(){this.orders.rqlQuery.skip=this.query.get("skip")}),this.listenTo(this.query,"change:limit",function(){this.orders.rqlQuery.limit=this.query.get("limit")})},onQueryChange:function(e,t){s.prototype.onQueryChange.call(this,e,t),this.promised(this.orders.fetch({reset:!0}))},onDisplayOptionsChange:function(e){s.prototype.onDisplayOptionsChange.call(this,e),this.paginationData.set("urlTemplate",this.orders.genPaginationUrlTemplate())},getQueryDataForOrgUnitChange:function(t){return e.extend(s.prototype.getQueryDataForOrgUnitChange.call(this,t),{skip:0})},load:function(e){return e(this.orders.fetch({reset:!0}),this.delayReasons.isEmpty()?this.delayReasons.fetch({reset:!0}):null,this.settings.isEmpty()?this.settings.fetch({reset:!0}):null)},afterRender:function(){s.prototype.afterRender.call(this),i.acquire()},createQuery:function(){return new r(this.options.query)},createDisplayOptions:function(){var e={settings:this.settings};return"string"==typeof this.options.displayOptions?o.fromString(this.options.displayOptions,e):new o(this.options.displayOptions,e)},createHeaderView:function(){return new a({model:this.query,displayOptions:this.displayOptions})},createFilterView:function(){return new p({model:this.query})},createDisplayOptionsView:function(){return new l({model:this.displayOptions})},createChartsView:function(e,t){return new h({model:e,settings:this.settings,displayOptions:this.displayOptions,skipRenderCharts:!!t})},onOrderUpdated:function(e){var t=this.orders.get(e._id);t&&(t.set({_id:t.id,delayReason:e.delayReason}),t.get("changes").push(e.change),t.trigger("push:change",e.change),this.orders.trigger("push:change",e.change))}})});