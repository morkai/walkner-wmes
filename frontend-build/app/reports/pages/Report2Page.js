// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/core/util/bindLoadingMessage","app/delayReasons/storage","./DrillingReportPage","../Report2OrderCollection","../Report2Query","../Report2DisplayOptions","../views/Report2HeaderView","../views/Report2FilterView","../views/Report2DisplayOptionsView","../views/Report2ChartsView","../views/Report2OrdersView","app/reports/templates/report2Page"],function(t,e,i,s,n,r,o,a,p,l,h,d,u,c){"use strict";return n.extend({template:c,rootBreadcrumbKey:"BREADCRUMBS:2",initialSettingsTab:"clip",maxOrgUnitLevel:"prodFlow",pageId:"report2",remoteTopics:{"orders.updated.*":"onOrderUpdated"},actions:function(){var t=n.prototype.actions.call(this);return t.unshift({id:"export",label:e.bound("reports","PAGE_ACTION:2:export"),icon:"download",href:"/reports/2;export?"+this.orders.rqlQuery}),t},setUpLayout:function(t){this.layout=t},initialize:function(){n.prototype.initialize.call(this),this.setView(".reports-2-orders-container",this.ordersView)},destroy:function(){n.prototype.destroy.call(this),s.release(),this.layout=null},defineModels:function(){n.prototype.defineModels.call(this),this.delayReasons=i(s.acquire(),this),this.orders=i(new r(null,{query:this.query,displayOptions:this.displayOptions}),this),this.paginationData=this.orders.paginationData},defineViews:function(){n.prototype.defineViews.call(this),this.ordersView=new u({collection:this.orders,delayReasons:this.delayReasons})},defineBindings:function(){n.prototype.defineBindings.call(this),this.listenTo(this.orders.paginationData,"change",function(){var t={limit:this.paginationData.get("limit"),skip:this.paginationData.get("skip")};this.query.set(t,{silent:!0})}),this.listenTo(this.query,"change",function(){this.layout.setActions(this.actions,this)}),this.listenTo(this.query,"change:skip",function(){this.orders.rqlQuery.skip=this.query.get("skip")}),this.listenTo(this.query,"change:limit",function(){this.orders.rqlQuery.limit=this.query.get("limit")})},onQueryChange:function(t,e){n.prototype.onQueryChange.call(this,t,e),this.promised(this.orders.fetch({reset:!0}))},onDisplayOptionsChange:function(t){n.prototype.onDisplayOptionsChange.call(this,t),this.paginationData.set("urlTemplate",this.orders.genPaginationUrlTemplate())},getQueryDataForOrgUnitChange:function(e){return t.extend(n.prototype.getQueryDataForOrgUnitChange.call(this,e),{skip:0})},load:function(t){return t(this.orders.fetch({reset:!0}),this.delayReasons.isEmpty()?this.delayReasons.fetch({reset:!0}):null,this.settings.isEmpty()?this.settings.fetch({reset:!0}):null)},afterRender:function(){n.prototype.afterRender.call(this),s.acquire()},createQuery:function(){return new o(this.options.query)},createDisplayOptions:function(){var t={settings:this.settings};return"string"==typeof this.options.displayOptions?a.fromString(this.options.displayOptions,t):new a(this.options.displayOptions,t)},createHeaderView:function(){return new p({model:this.query,displayOptions:this.displayOptions})},createFilterView:function(){return new l({model:this.query})},createDisplayOptionsView:function(){return new h({model:this.displayOptions})},createChartsView:function(t,e){return new d({model:t,settings:this.settings,displayOptions:this.displayOptions,skipRenderCharts:!!e})},onOrderUpdated:function(t){var e=this.orders.get(t._id);e&&(e.set({_id:e.id,delayReason:t.delayReason}),e.get("changes").push(t.change),e.trigger("push:change",t.change),this.orders.trigger("push:change",t.change))}})});