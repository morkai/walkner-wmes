// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/data/orgUnits","app/core/View","../Report2","../Report2Query","../MetricRefCollection","../views/Report2HeaderView","../views/Report2FilterView","../views/Report2ChartsView","app/reports/templates/report2Page"],function(t,e,i,r,s,n,o,h,a,c,u,l){return s.extend({layoutName:"page",pageId:"report2",template:l,title:function(){var t=[i.bound("reports","BREADCRUMBS:2")],e=r.getByTypeAndId(this.query.get("orgUnitType"),this.query.get("orgUnitId"));if(e){var s="subdivision"===this.query.get("orgUnitType")?e.get("division")+" \\ ":"";t.push(s+e.getLabel())}else t.push(i.bound("reports","BREADCRUMBS:divisions"));return t},events:{"mousedown .reports-2-clip .highcharts-title":function(t){return 1===t.button?!1:void 0},"mouseup .reports-2-clip .highcharts-title":function(t){return 1===t.button?!1:void 0},"click .reports-2-clip .highcharts-title":function(t){t.ctrlKey||0!==t.button||this.changeOrgUnit(this.$(t.target).closest(".reports-drillingCharts"))}},initialize:function(){this.onKeyDown=this.onKeyDown.bind(this),e(this.el.ownerDocument.body).on("keydown",this.onKeyDown),this.$chartsContainer=null,this.defineModels(),this.defineViews(),this.setView(".reports-drillingHeader-container",this.headerView),this.setView(".filter-container",this.filterView),this.insertChartsViews()},destroy:function(){e(this.el.ownerDocument.body).off("keydown",this.onKeyDown),this.$chartsContainer=null,this.cancelAnimations()},setUpLayout:function(t){this.listenTo(this.query,"change:orgUnitId",function(){t.setTitle(this.title,this)})},afterRender:function(){this.$chartsContainer=this.$(".reports-drillingCharts-container")},defineModels:function(){this.metricRefs=new h({pubsub:this.pubsub}),this.query=new o(this.options.query),this.reports=this.query.createReports(),this.listenTo(this.query,"change",this.onQueryChange)},defineViews:function(){this.headerView=new a({model:this.query}),this.filterView=new c({model:this.query});var t=this.metricRefs;this.chartsViews=this.reports.map(function(e){return new u({model:e,metricRefs:t})})},load:function(t){return t(this.metricRefs.fetch({reset:!0}))},insertChartsViews:function(t,e){this.chartsViews.forEach(function(i,r){i!==t&&this.insertView(".reports-drillingCharts-container",i,e?{insertAt:r}:null)},this)},onQueryChange:function(t,e){var i=t.changedAttributes(),r="undefined"!=typeof i.orgUnitId,s="undefined"==typeof i.orgUnitType?1:2;e.reset||this.broker.publish("router.navigate",{url:this.reports[0].url()+"?"+this.query.serializeToString(),replace:!r,trigger:!1}),r?this.drill(Object.keys(i).length>s):this.refresh()},changeOrgUnit:function(t){if(!this.$el.hasClass("is-changing")){var e=t.attr("data-orgUnitType");if(e&&"prodFlow"!==e){var i=t.attr("data-orgUnitId");if(!t.prev().length){var s=r.getByTypeAndId(e,i),n=r.getParent(s);e=n?r.getType(n):null,i=n?n.id:null}this.query.set({orgUnitType:e,orgUnitId:i})}}},refresh:function(){this.reports.forEach(function(t){this.promised(t.fetch())},this)},drill:function(t){var e;this.$el.hasClass("is-changing")?(e=r.RELATION_TYPES.UNRELATED,this.cancelRequests(),this.cancelAnimations(),this.chartsViews.forEach(function(t){t.remove()}),this.chartsViews=[],this.reports=[]):(e=r.getRelationType(this.query.previous("orgUnitType"),this.query.previous("orgUnitId"),this.query.get("orgUnitType"),this.query.get("orgUnitId")),this.$el.addClass("is-changing")),e===r.RELATION_TYPES.CHILD?this.drillDown(t):e===r.RELATION_TYPES.PARENT?this.drillUp(t):this.replace()},drillDown:function(t){var e=this.getCurrentReport(),i=this.getChartsViewByReport(e),r=this.chartsViews.filter(function(t){return t!==i}),s=[],n=this.metricRefs;this.reports=this.query.createReports(e),this.chartsViews=this.reports.map(function(t,e){if(0===e)return i;var r=new u({model:t,metricRefs:n,skipRenderCharts:!0});return s.push(r),r}),t&&this.promised(e.fetch()),this.moveChartsViews("drillingDown",r,s,i)},drillUp:function(t){var e=this.getCurrentReport(!0),i=this.getChartsViewByReport(e),r=this.chartsViews.filter(function(t){return t!==i}),s=[],n=this.metricRefs;this.reports=this.query.createReports(null,e),this.chartsViews=this.reports.map(function(t){if(t===e)return i;var r=new u({model:t,metricRefs:n,skipRenderCharts:!0});return s.push(r),r}),t&&this.promised(e.fetch()),this.moveChartsViews("drillingUp",r,s,i)},replace:function(){var t=this,i=this.chartsViews.map(function(t){return t.el});e(i).fadeOut(300).promise().done(function(){t.chartsViews.forEach(function(t){t.remove()}),t.$(".reports-drillingCharts").remove(),t.reports=t.query.createReports(),t.chartsViews=t.reports.map(function(e){return new u({model:e,metricRefs:t.metricRefs,skipRenderCharts:!0})}),t.insertChartsViews(),t.showChartsViews("replacing",t.chartsViews)})},moveChartsViews:function(t,e,i,r){var s=this,n=this.chartsViews.indexOf(r);r.$el.siblings().fadeTo(400,0).promise().done(function(){s.$chartsContainer.css("overflow-x","hidden");var o=r.$el.position();r.$el.css({position:"absolute",top:o.top+"px",left:o.left+"px"}),e.forEach(function(t){t.remove()}),s.insertChartsViews(r,"drillingUp"===t),r.$el.animate({left:375*n},300).promise().done(function(){r.$el.css("position",""),s.$chartsContainer.css("overflow-x",""),s.showChartsViews(t,i)})})},showChartsViews:function(t,i){var r=this,s=[],n=[];this.$el.addClass("is-"+t),i.forEach(function(t,e){t.render(),t.$el.css("opacity",0),5>e?s.push(t.el):n.push(t.el)}),this.$el.removeClass("is-"+t),i.forEach(function(t){t.renderCharts(!0)}),e(s).fadeTo(400,1).promise().done(function(){e(n).css("opacity",""),r.$el.removeClass("is-changing")})},getCurrentReport:function(e){var i=r.getByTypeAndId(this.query[e?"previous":"get"]("orgUnitType"),this.query[e?"previous":"get"]("orgUnitId"));return t.find(this.reports,function(t){return t.get("orgUnit")===i})},getChartsViewByReport:function(e){return t.find(this.chartsViews,function(t){return t.model===e})},onKeyDown:function(t){return"INPUT"!==t.target.tagName||t.target.classList.contains("btn")?39===t.keyCode?(this.scroll(!0),!1):37===t.keyCode?(this.scroll(!1),!1):void 0:void 0},scroll:function(t){for(var e=Math.round(this.$chartsContainer[0].scrollLeft/376)+(t?1:-1),i=this.$chartsContainer.children(),r=0,s=0;e>s;++s)r+=i.eq(s).outerWidth();this.$chartsContainer.finish().animate({scrollLeft:r},250)}})});