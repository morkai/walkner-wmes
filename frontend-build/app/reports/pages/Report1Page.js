define(["underscore","jquery","app/i18n","app/data/orgUnits","app/core/View","../Report1","../Report1Query","../MetricRefCollection","../views/Report1HeaderView","../views/Report1FilterView","../views/Report1ChartsView","app/reports/templates/report1Page"],function(e,t,i,r,s,n,o,h,a,c,u,l){return s.extend({layoutName:"page",pageId:"report1",template:l,title:function(){var e=[i.bound("reports","BREADCRUMBS:1")],t=r.getByTypeAndId(this.query.get("orgUnitType"),this.query.get("orgUnitId"));if(t){var s="subdivision"===this.query.get("orgUnitType")?t.get("division")+" \\ ":"";e.push(s+t.getLabel())}else e.push(i.bound("reports","BREADCRUMBS:divisions"));return e},actions:[{label:i.bound("reports","PAGE_ACTION:editMetricRefs"),icon:"crosshairs",privileges:"REPORTS:MANAGE",href:"#reports;metricRefs"}],events:{"mousedown .reports-1-coeffs .highcharts-title":function(e){return 1===e.button?!1:void 0},"mouseup .reports-1-coeffs .highcharts-title":function(e){return 1===e.button?!1:void 0},"click .reports-1-coeffs .highcharts-title":function(e){e.ctrlKey||0!==e.button||this.changeOrgUnit(this.$(e.target).closest(".reports-drillingCharts"))}},initialize:function(){this.onKeyDown=this.onKeyDown.bind(this),t(this.el.ownerDocument.body).on("keydown",this.onKeyDown),this.$chartsContainer=null,this.defineModels(),this.defineViews(),this.setView(".reports-drillingHeader-container",this.headerView),this.setView(".filter-container",this.filterView),this.insertChartsViews()},destroy:function(){t(this.el.ownerDocument.body).off("keydown",this.onKeyDown),this.$chartsContainer=null,this.cancelAnimations()},setUpLayout:function(e){this.listenTo(this.query,"change:orgUnitId",function(){e.setTitle(this.title,this)})},afterRender:function(){this.$chartsContainer=this.$(".reports-drillingCharts-container")},defineModels:function(){this.metricRefs=new h({pubsub:this.pubsub}),this.query=new o(this.options.query),this.reports=this.query.createReports(),this.listenTo(this.query,"change",this.onQueryChange)},defineViews:function(){this.headerView=new a({model:this.query}),this.filterView=new c({model:this.query});var e=this.metricRefs;this.chartsViews=this.reports.map(function(t){return new u({model:t,metricRefs:e})})},load:function(e){return e(this.metricRefs.fetch({reset:!0}))},insertChartsViews:function(e,t){this.chartsViews.forEach(function(i,r){i!==e&&this.insertView(".reports-drillingCharts-container",i,t?{insertAt:r}:null)},this)},onQueryChange:function(e,t){var i=e.changedAttributes(),r="undefined"!=typeof i.orgUnitId,s="undefined"==typeof i.orgUnitType?1:2;t.reset||this.broker.publish("router.navigate",{url:this.reports[0].url()+"?"+this.query.serializeToString(),replace:!r,trigger:!1}),r?this.drill(Object.keys(i).length>s):this.refresh()},changeOrgUnit:function(e){if(!this.$el.hasClass("is-changing")){var t=e.attr("data-orgUnitType");if(t&&"prodLine"!==t){var i=e.attr("data-orgUnitId");if(!e.prev().length){var s=r.getByTypeAndId(t,i),n=r.getParent(s);t=n?r.getType(n):null,i=n?n.id:null}this.query.set({orgUnitType:t,orgUnitId:i})}}},refresh:function(){this.reports.forEach(function(e){this.promised(e.fetch())},this)},drill:function(e){var t;this.$el.hasClass("is-changing")?(t=r.RELATION_TYPES.UNRELATED,this.cancelRequests(),this.cancelAnimations(),this.chartsViews.forEach(function(e){e.remove()}),this.chartsViews=[],this.reports=[]):(t=r.getRelationType(this.query.previous("orgUnitType"),this.query.previous("orgUnitId"),this.query.get("orgUnitType"),this.query.get("orgUnitId")),this.$el.addClass("is-changing")),t===r.RELATION_TYPES.CHILD?this.drillDown(e):t===r.RELATION_TYPES.PARENT?this.drillUp(e):this.replace()},drillDown:function(e){var t=this.getCurrentReport(),i=this.getChartsViewByReport(t),r=this.chartsViews.filter(function(e){return e!==i}),s=[],n=this.metricRefs;this.reports=this.query.createReports(t),this.chartsViews=this.reports.map(function(e,t){if(0===t)return i;var r=new u({model:e,metricRefs:n,skipRenderCharts:!0});return s.push(r),r}),e&&this.promised(t.fetch()),this.moveChartsViews("drillingDown",r,s,i)},drillUp:function(e){var t=this.getCurrentReport(!0),i=this.getChartsViewByReport(t),r=this.chartsViews.filter(function(e){return e!==i}),s=[],n=this.metricRefs;this.reports=this.query.createReports(null,t),this.chartsViews=this.reports.map(function(e){if(e===t)return i;var r=new u({model:e,metricRefs:n,skipRenderCharts:!0});return s.push(r),r}),e&&this.promised(t.fetch()),this.moveChartsViews("drillingUp",r,s,i)},replace:function(){var e=this,i=this.chartsViews.map(function(e){return e.el});t(i).fadeOut(300).promise().done(function(){e.chartsViews.forEach(function(e){e.remove()}),e.$(".reports-drillingCharts").remove(),e.reports=e.query.createReports(),e.chartsViews=e.reports.map(function(t){return new u({model:t,metricRefs:e.metricRefs,skipRenderCharts:!0})}),e.insertChartsViews(),e.showChartsViews("replacing",e.chartsViews)})},moveChartsViews:function(e,t,i,r){var s=this,n=this.chartsViews.indexOf(r);r.$el.siblings().fadeTo(400,0).promise().done(function(){s.$chartsContainer.css("overflow-x","hidden");var o=r.$el.position();r.$el.css({position:"absolute",top:o.top+"px",left:o.left+"px"}),t.forEach(function(e){e.remove()}),s.insertChartsViews(r,"drillingUp"===e),r.$el.animate({left:375*n},300).promise().done(function(){r.$el.css("position",""),s.$chartsContainer.css("overflow-x",""),s.showChartsViews(e,i)})})},showChartsViews:function(e,i){var r=this,s=[],n=[];this.$el.addClass("is-"+e),i.forEach(function(e,t){e.render(),e.$el.css("opacity",0),5>t?s.push(e.el):n.push(e.el)}),this.$el.removeClass("is-"+e),i.forEach(function(e){e.renderCharts(!0)}),t(s).fadeTo(400,1).promise().done(function(){t(n).css("opacity",""),r.$el.removeClass("is-changing")})},getCurrentReport:function(t){var i=r.getByTypeAndId(this.query[t?"previous":"get"]("orgUnitType"),this.query[t?"previous":"get"]("orgUnitId"));return e.find(this.reports,function(e){return e.get("orgUnit")===i})},getChartsViewByReport:function(t){return e.find(this.chartsViews,function(e){return e.model===t})},onKeyDown:function(e){return"INPUT"!==e.target.tagName||e.target.classList.contains("btn")?39===e.keyCode?(this.scroll(!0),!1):37===e.keyCode?(this.scroll(!1),!1):void 0:void 0},scroll:function(e){for(var t=Math.round(this.$chartsContainer[0].scrollLeft/376)+(e?1:-1),i=this.$chartsContainer.children(),r=0,s=0;t>s;++s)r+=i.eq(s).outerWidth();this.$chartsContainer.finish().animate({scrollLeft:r},250)}})});