// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","../settings/SettingCollection","./ReportSetting"],function(e,r,t){return r.extend({model:t,topicSuffix:"reports.**",getValue:function(e){var r=this.get("reports."+e);return r?r.getValue():null},getColor:function(e,r){var t=this.getValue(e+".color")||"#000000";if(!r)return t;var n=t.match(/^#(.{2})(.{2})(.{2})$/);return n?"rgba("+parseInt(n[1],16)+","+parseInt(n[2],16)+","+parseInt(n[3],16)+","+r+")":t},getReference:function(e,r){return this.getValue(e+"."+r)||0},getCoeff:function(e){var r=this.getValue(e+".coeff");return r>0?r:0},update:function(r,t){if(t=this.prepareValue(r,t.trim()),void 0===t)return e.Deferred().reject().promise();var n=this.get(r);if(n){if(n.getValue()===t)return e.Deferred().resolve().promise()}else this.add({_id:r,value:null}),n=this.get(r);return n.save({value:t})},prepareValue:function(e,r){return"reports.absenceRef.prodTask"===e?this.prepareObjectIdValue(r):/color/i.test(e)?this.prepareColorValue(r):/coeff/i.test(e)?this.prepareCoeffValue(r):this.prepare100PercentValue(r)},prepareObjectIdValue:function(e){return""===e?null:/^[a-f0-9]{24}$/.test(e)?e:void 0},prepare100PercentValue:function(e){return""===e?0:(e=parseInt(e,10),isNaN(e)?void 0:0>e?0:e>100?100:e)},prepareCoeffValue:function(e){return""===e?0:(e=parseFloat(e),isNaN(e)?void 0:0>e?0:Math.round(1e4*e)/1e4)},prepareColorValue:function(e){return e=e.toLowerCase(),/^#[a-f0-9]{6}$/.test(e)?e:void 0}})});