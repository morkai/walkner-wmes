// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../data/companies","../data/prodFunctions","../core/Model"],function(t,n,i,r){return r.extend({urlRoot:"/reports/5",defaults:function(){return{orgUnitType:null,orgUnit:null,totals:{quantityDone:[],total:[],direct:[],indirect:[],byCompany:{}},maxTotals:{quantityDone:0,total:0,direct:0,indirect:0},directByCompany:{},indirectBycompany:{},dirIndir:[],maxDirIndir:0,byCompanyAndProdFunction:{}}},initialize:function(t,n){if(!n.query)throw new Error("query option is required!");this.query=n.query},fetch:function(n){return t.isObject(n)||(n={}),n.data=t.extend(n.data||{},this.query.serializeToObject(this.get("orgUnitType"),this.get("orgUnit"))),r.prototype.fetch.call(this,n)},parse:function(t){for(var r,o={totals:{quantityDone:[],total:[],direct:[],indirect:[],byCompany:{}},maxTotals:{quantityDone:0,total:0,direct:0,indirect:0},directByCompany:{},indirectByCompany:{},dirIndir:[],maxDirIndir:0,byCompanyAndProdFunction:{}},e=o.totals,a=o.maxTotals,y=n.map(function(t){return e.byCompany[t.id]=[],o.directByCompany[t.id]=[],o.indirectByCompany[t.id]=[],o.byCompanyAndProdFunction[t.id]={},t.id}),d=y.length,c=i.map(function(t){return y.forEach(function(n){o.byCompanyAndProdFunction[n][t.id]=0}),t.id}),u=c.length,p=0,m=0,s=t.data.length;s>m;++m){var f,h=t.data[m],l=0,C=0,x=0,g=0,b={},v={},F={};if("number"==typeof h)f=h;else{for(var q=h.dni,D=0;u>D;++D){var B=c[D],M=q[B];if(void 0!==M)for(var A=0;d>A;++A){r=y[A];var I=M[r];if(void 0!==I){var P=I[0],E=I[1],T=P+E;C+=T,x+=P,g+=E,void 0===b[r]?(b[r]=T,v[r]=P,F[r]=E):(b[r]+=T,v[r]+=P,F[r]+=E),o.byCompanyAndProdFunction[r][B]+=T}}}l=h.qty,f=h.key}var j=t.days[f]||1;j>1&&(C/=j,x/=j,g/=j),p+=j;var O=x?g/x*100:0;e.quantityDone.push({x:f,y:l}),e.total.push({x:f,y:C}),e.direct.push({x:f,y:x}),e.indirect.push({x:f,y:g}),o.dirIndir.push({x:f,y:O});for(var k=0;d>k;++k)r=y[k],e.byCompany[r].push({x:f,y:(b[r]||0)/j}),o.directByCompany[r].push({x:f,y:(v[r]||0)/j}),o.indirectByCompany[r].push({x:f,y:(F[r]||0)/j});l>a.quantityDone&&(a.quantityDone=l),C>a.total&&(a.total=C),x>a.direct&&(a.direct=x),g>a.indirect&&(a.indirect=g),O>o.maxDirIndir&&(o.maxDirIndir=O)}return p>1&&y.forEach(function(t){c.forEach(function(n){o.byCompanyAndProdFunction[t][n]/=p})}),o},getMaxCompanyFte:function(t,n){var i=0;return Object.keys(n).forEach(function(r){var o=n[r];t[r]&&o>i&&(i=o)}),i},getMaxTotalCompanyFte:function(t){return this.getMaxCompanyFte(t,this.get("totals").byCompany)},getMaxDirectCompanyFte:function(t){return this.getMaxCompanyFte(t,this.get("directByCompany"))},getMaxIndirectCompanyFte:function(t){return this.getMaxCompanyFte(t,this.get("indirectByCompany"))},getMaxFteByCompanyAndProdFunction:function(t,n){var i=0,r=this.get("byCompanyAndProdFunction");return Object.keys(r).forEach(function(o){if(t[o]){var e=r[o];Object.keys(e).forEach(function(t){var r=e[t];n[t]&&r>i&&(i=r)})}}),i}})});