// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["h5.rql/index","../time","../core/Model","../core/util/getShiftStartInfo"],function(e,t,r,i){return r.extend({defaults:function(){var e=t.getMoment().weekday(0).hours(0).minutes(0).seconds(0).milliseconds(0),r=i(new Date);return{from:e.valueOf(),to:e.add(7,"days").valueOf(),interval:"day",mode:"shift",shift:r.shift,masters:void 0,operators:void 0}},serializeToObject:function(){var e={from:this.get("from"),to:this.get("to"),interval:this.get("interval"),mode:this.get("mode")};return e.mode&&(e[e.mode]=this.get(e.mode),Array.isArray(e[e.mode])&&(e[e.mode]=this.serializeUsers())),e},serializeToString:function(){var e=this.attributes,t="from="+e.from+"&to="+e.to+"&interval="+e.interval;return e.mode&&(t+="&mode="+e.mode,t+="&"+e.mode+"=",t+=Array.isArray(e[e.mode])?this.serializeUsers():e[e.mode]),t},serializeUsers:function(){var e=this.get(this.get("mode"));return Array.isArray(e)?e.map(function(e){return e._id?e._id:e}).join(","):""},getUsersForSelect2:function(){if("shift"===this.get("mode"))return[];var e=this.get(this.get("mode"));return Array.isArray(e)?e.map(function(e){return"string"==typeof e?{id:e,text:e}:e&&e._id?{id:e._id,text:e.lastName+" "+e.firstName+" ("+e.personellId+")"}:null}).filter(function(e){return null!==e}):[]},updateUsers:function(e){"shift"!==this.get("mode")&&this.set(this.get("mode"),e)}},{fromQuery:function(e){var t=this,r={};return e.from&&e.to&&(r.from=parseInt(e.from,10),r.to=parseInt(e.to,10)),e.interval&&(r.interval=e.interval),e.mode&&(r.mode=e.mode,"shift"===e.mode?(r.shift=parseInt(e.shift,10),(r.shift<1||r.shift>3)&&(delete r.mode,delete r.shift)):"masters"===e.mode||"operators"===e.mode?(r[r.mode]=String(e[r.mode]).split(","),0===r[r.mode].length&&(delete r.mode,delete r[r.mode])):delete r.mode),new t(r)}})});