// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","h5.rql/index","../time","../core/Model"],function(e,i,t,s){return s.extend({defaults:function(){var e=t.getMoment().hours(0).minutes(0).seconds(0).milliseconds(0);return{to:e.valueOf(),from:e.subtract("days",1).valueOf(),interval:"day",majorMalfunction:1.5,divisions:[],subdivisionType:null,prodLines:{},sort:{division:1,_id:1}}},reset:function(i){this.set(e.defaults(i,this.defaults()),{reset:!0})},serializeToObject:function(){return{from:this.get("from"),to:this.get("to"),interval:this.get("interval"),majorMalfunction:this.get("majorMalfunction")}},serializeToString:function(){var t=this.attributes,s=new i.Query;return s.sort=this.get("sort"),s.selector={name:"and",args:[{name:"eq",args:["from",t.from]},{name:"eq",args:["to",t.to]},{name:"eq",args:["interval",t.interval]},{name:"eq",args:["majorMalfunction",t.majorMalfunction]}]},t.divisions.length&&s.selector.args.push({name:"in",args:["divisions",t.divisions]}),t.subdivisionType&&s.selector.args.push({name:"eq",args:["subdivisionType",t.subdivisionType]}),e.isEmpty(t.prodLines)||s.selector.args.push({name:"in",args:["prodLines",Object.keys(t.prodLines)]}),s.toString()},diffProdLines:function(e){var i=this.get("prodLines"),t={};Object.keys(i).forEach(function(i){e[i]&&(t[i]=!0)}),this.set("prodLines",t)},isProdLineSelected:function(i,t){return this.attributes.prodLines[i]?!0:t?e.isEmpty(this.attributes.prodLines):!1},getSelectedProdLines:function(){return Object.keys(this.attributes.prodLines)},toggleProdLineSelection:function(e,i){i?this.attributes.prodLines[e]=!0:delete this.attributes.prodLines[e],this.trigger("change"),this.trigger("change:prodLines")},matchProdLine:function(e){var i=this.get("divisions"),t=this.get("subdivisionType");return!(i.length&&-1===i.indexOf(e.division)||null!=t&&e.subdivisionType!==t)}},{fromRqlQuery:function(i){var t=this,s={sort:e.isEmpty(i.sort)?void 0:i.sort};return(i.selector?i.selector.args:[]).forEach(function(e){("eq"===e.name||"in"===e.name)&&("in"===e.name&&"prodLines"===e.args[0]?(s.prodLines={},e.args[1].forEach(function(e){s.prodLines[e]=!0})):s[e.args[0]]=e.args[1])}),new t(s)}})});