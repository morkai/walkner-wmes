// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","h5.rql/index","../time","../core/Model"],function(i,n,t,e){"use strict";var s=["totalAvailabilityH","operationalAvailabilityH","operationalAvailabilityP","exploitationH","exploitationP","oee","adjustingDuration","maintenanceDuration","renovationDuration","malfunctionDuration","malfunctionCount","majorMalfunctionCount","mttr","mtbf"];return e.extend({defaults:function(){var i=t.getMoment().hours(0).minutes(0).seconds(0).milliseconds(0);return{to:i.valueOf(),from:i.subtract(1,"days").valueOf(),interval:"day",majorMalfunction:1.5,divisions:[],subdivisionType:null,prodLines:{},sort:{division:1,_id:1},columns:{}}},serializeToObject:function(){return{from:this.get("from"),to:this.get("to"),interval:this.get("interval"),majorMalfunction:this.get("majorMalfunction")}},serializeToString:function(){var t=this.attributes,e=new n.Query;e.sort=this.get("sort"),e.selector={name:"and",args:[{name:"eq",args:["from",t.from]},{name:"eq",args:["to",t.to]},{name:"eq",args:["interval",t.interval]},{name:"eq",args:["majorMalfunction",t.majorMalfunction]}]},t.divisions.length&&e.selector.args.push({name:"in",args:["divisions",t.divisions]}),t.subdivisionType&&e.selector.args.push({name:"eq",args:["subdivisionType",t.subdivisionType]}),i.isEmpty(t.prodLines)||e.selector.args.push({name:"in",args:["prodLines",Object.keys(t.prodLines)]});var r="";return s.forEach(function(i){r+=t.columns[i]===!1?"0":"1"}),e.selector.args.push({name:"eq",args:["columns",r]}),e.toString()},diffProdLines:function(i){var n=this.get("prodLines"),t={};Object.keys(n).forEach(function(n){i[n]&&(t[n]=!0)}),this.set("prodLines",t)},isProdLineSelected:function(n,t){return!!this.attributes.prodLines[n]||!!t&&i.isEmpty(this.attributes.prodLines)},getSelectedProdLines:function(){return Object.keys(this.attributes.prodLines)},toggleProdLineSelection:function(i,n){n?this.attributes.prodLines[i]=!0:delete this.attributes.prodLines[i],this.trigger("change"),this.trigger("change:prodLines")},matchProdLine:function(i){var n=this.get("divisions"),t=this.get("subdivisionType");return!(n.length&&n.indexOf(i.division)===-1||null!=t&&t.indexOf(i.subdivisionType)===-1)},changeColumnVisibility:function(i,n){var t=this.get("columns");t[i]!==n&&(t[i]=n,this.trigger("change"),this.trigger("change:columns",i,n))},isColumnVisible:function(i){return this.get("columns")[i]!==!1}},{fromRqlQuery:function(n){var t=this,e={sort:i.isEmpty(n.sort)?void 0:n.sort};return(n.selector?n.selector.args:[]).forEach(function(i){"eq"!==i.name&&"in"!==i.name||("in"===i.name&&"prodLines"===i.args[0]?(e.prodLines={},i.args[1].forEach(function(i){e.prodLines[i]=!0})):"eq"===i.name&&"columns"===i.args[0]?(e.columns={},s.forEach(function(n,t){"0"===i.args[1][t]&&(e.columns[n]=!1)})):e[i.args[0]]=i.args[1])}),new t(e)}})});