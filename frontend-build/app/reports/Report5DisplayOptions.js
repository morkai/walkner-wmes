// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../core/Model","../data/companies","../data/prodFunctions"],function(t,e,i,n){function r(t,e){for(;t.length<e;)t="0"+t;return t}var a=["quantityDone","total","direct","indirect","dirIndir"];return e.extend({defaults:function(){var t={series:{},companies:{},prodFunctions:{},extremes:"none",maxQuantityDone:0,maxTotalFte:0,maxDirectFte:0,maxDirIndirFte:0,maxDirIndirPercent:0,maxDetailsFte:0};return a.forEach(function(e){t.series[e]=!0}),i.forEach(function(e){t.companies[e.id]=!0}),n.forEach(function(e){t.prodFunctions[e.id]=!0}),t},initialize:function(t,e){if(!e.settings)throw new Error("settings option is required!");this.settings=e.settings},isSeriesVisible:function(t){return!!this.get("series")[t]||!!this.get("companies")[t]||!!this.get("prodFunctions")[t]},isCompanyVisible:function(t){return!!this.get("companies")[t]},isProdFunctionVisible:function(t){return!!this.get("prodFunctions")[t]},updateExtremes:function(t){var e={maxQuantityDone:0,maxTotalFte:0,maxDirectFte:0,maxIndirectFte:0,maxDirIndirFte:0,maxDirIndirPercent:0,maxDetailsFte:0},i=this.get("extremes");if("none"===i)return this.set(e);for(var n=this.get("series"),r=this.get("companies"),a=this.get("prodFunctions"),o="siblings"===i?1:0,s=t.length;s>o;++o){var c=t[o],d=c.get("maxTotals");e.maxQuantityDone=Math.max(e.maxQuantityDone,n.quantityDone?d.quantityDone:0),e.maxTotalFte=Math.max(e.maxTotalFte,n.total?d.total:0,n.direct?d.direct:0,n.indirect?d.indirect:0,c.getMaxTotalCompanyFte(r)),e.maxDirectFte=Math.max(e.maxDirectFte,n.direct?d.direct:0,c.getMaxDirectCompanyFte(r)),e.maxIndirectFte=Math.max(e.maxIndirectFte,n.indirect?d.indirect:0,c.getMaxIndirectCompanyFte(r)),e.maxDirIndirFte=Math.max(e.maxDirIndirFte,n.direct?d.direct:0,n.indirect?d.indirect:0),e.maxDirIndirPercent=Math.max(e.maxDirIndirPercent,n.dirIndir?c.get("maxDirIndir"):0),e.maxDetailsFte=Math.max(e.maxDetailsFte,c.getMaxFteByCompanyAndProdFunction(r,a))}this.set(e)},serializeToString:function(){var t=this.get("extremes"),e=this.get("series"),r=this.get("companies"),o=this.get("prodFunctions"),s=["none"===t?0:"siblings"===t?1:2,"","",""];return a.forEach(function(t){s[1]+=e[t]?1:0}),i.forEach(function(t){s[2]+=r[t.id]?1:0}),n.forEach(function(t){s[3]+=o[t.id]?1:0}),s.join("&")}},{fromString:function(t,e){var o=this,s=t.split("&");if(4!==s.length)return new o(null,e);var c={extremes:"2"===s[0]?"parent":"1"===s[0]?"siblings":"none",series:{},companies:{},prodFunctions:{}},d=r(s[1],a.length);a.forEach(function(t,e){"1"===d[e]&&(c.series[t]=!0)});var m=r(s[2],i.length);i.forEach(function(t,e){"1"===m[e]&&(c.companies[t.id]=!0)});var u=r(s[3],n.length);return n.forEach(function(t,e){"1"===u[e]&&(c.prodFunctions[t.id]=!0)}),new o(c,e)}})});