// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../core/Model","../data/companies","../data/prodFunctions"],function(e,t,i,r){"use strict";function n(e,t){for(;e.length<t;)e="0"+e;return e}var s=["quantityDone","total","direct","indirect","indirDir","warehouse","productivity","productivityNoWh","dirIndir","effIneff","absence"];return t.extend({defaults:function(){var e={series:{},references:{},companies:{},prodFunctions:{},prodTasks:{},extremes:"none",maxQuantityDone:0,maxTotalFte:0,maxDirectFte:0,maxIndirDirFte:0,maxIndirDirPercent:0,maxDetailsFte:0,maxDirIndirFte:null,maxDirIndirPercent:null,maxResourceFte:null};return s.forEach(function(t){e.series[t]=!0,e.references[t]=!0}),i.forEach(function(t){e.companies[t.id]=!0}),r.forEach(function(t){e.prodFunctions[t.id]=!0}),e},initialize:function(e,t){if(!t.settings)throw new Error("settings option is required!");if(!t.prodTasks)throw new Error("prodTasks option is required!");this.settings=t.settings,this.prodTasks=t.prodTasks,this.listenToOnce(this.prodTasks,"reset",function(){t.prodTasksStr?this.constructor.readProdTasks(this.prodTasks,t.prodTasksStr,this.attributes.prodTasks):this.prodTasks.forEach(function(e){this.attributes.prodTasks[e.id]=!0,this.attributes.references[e.id]=!0},this)})},isSeriesVisible:function(e){return!!this.get("series")[e]||!!this.get("companies")[e]||!!this.get("prodFunctions")[e]},isReferenceVisible:function(e){return!!this.get("references")[e]},isCompanyVisible:function(e){return!!this.get("companies")[e]},isProdFunctionVisible:function(e){return!!this.get("prodFunctions")[e]},updateExtremes:function(e){var t={maxQuantityDone:0,maxTotalFte:0,maxDirectFte:0,maxIndirectFte:0,maxIndirDirFte:0,maxIndirDirPercent:0,maxDetailsFte:0,maxDirIndirFte:null,maxDirIndirPercent:null,maxResourceFte:null},i=this.get("extremes");if("none"===i)return this.set(t);for(var r=this.get("series"),n=this.get("references"),s=this.get("prodTasks"),a=this.get("companies"),o=this.get("prodFunctions"),d=this.settings,c=d.getCoeff("directRef"),f=d.getCoeff("indirectRef"),u=d.getCoeff("warehouseRef"),h=d.getCoeff("absenceRef"),m=d.getValue("absenceRef.prodTask"),g="siblings"===i?1:0,x=e.length;g<x;++g){var l=e[g],p=l.get("maxTotals");t.maxQuantityDone=Math.max(t.maxQuantityDone,r.quantityDone?p.quantityDone:0),t.maxTotalFte=Math.max(t.maxTotalFte,r.total?p.total:0,r.direct?p.direct:0,r.indirect?p.indirect:0,l.getMaxTotalCompanyFte(a)),t.maxDirectFte=Math.max(t.maxDirectFte,r.direct?p.direct:0,l.getMaxDirectCompanyFte(a)),t.maxIndirectFte=Math.max(t.maxIndirectFte,r.indirect?p.indirect:0,l.getMaxIndirectCompanyFte(a)),t.maxIndirDirFte=Math.max(t.maxIndirDirFte,r.direct?p.direct:0,r.indirect?p.indirect:0),t.maxIndirDirPercent=Math.max(t.maxIndirDirPercent,r.indirDir?l.get("maxDirIndir"):0),t.maxDetailsFte=Math.max(t.maxDetailsFte,l.getMaxFteByCompanyAndProdFunction(a,o));var F=l.get("dirIndir");t.maxDirIndirFte=Math.max(t.maxDirIndirFte,r.direct?F.direct:0,r.direct&&n.direct?l.getDirectRef(c):0,r.indirect?F.indirect:0,r.indirect&&n.indirect?l.getIndirectRef(m,f):0,r.warehouse?F.storage:0,r.warehouse&&n.warehouse?l.getWarehouseRef(u):0),t.maxDirIndirPercent=Math.max(t.maxDirIndirPercent,r.productivity?F.productivity:0,r.productivityNoWh?F.productivityNoWh:0);var D=l.get("effIneff");t.maxResourceFte=Math.max(t.maxResourceFte,r.dirIndir?D.dirIndir:0,r.dirIndir&&n.dirIndir?l.getDirIndirRef(d.getCoeff("dirIndirRef")):0,r.effIneff?Math.abs(D.value):0,s[m]&&n.absence?l.getAbsenceRef(h):0,l.getMaxEffIneffProdTaskFte(s))}this.set(t)},serializeToString:function(){var e=this.get("extremes"),t=this.get("series"),n=this.get("references"),a=this.get("prodTasks"),o=this.get("companies"),d=this.get("prodFunctions"),c=["none"===e?0:"siblings"===e?1:2,"","","",""];return s.forEach(function(e){c[1]+=t[e]?"1":"0",c[1]+=n[e]?"1":"0"}),i.forEach(function(e){c[2]+=o[e.id]?"1":"0"}),r.forEach(function(e){c[3]+=d[e.id]?"1":"0"}),this.prodTasks.forEach(function(e){c[4]+=a[e.id]?"1":"0"}),c.join("&")}},{fromString:function(e,t){var a=this,o=e.split("&");if(5!==o.length)return new a(null,t);var d,c,f={extremes:"2"===o[0]?"parent":"1"===o[0]?"siblings":"none",series:{},references:{},companies:{},prodTasks:{},prodFunctions:{}},u=n(o[1],2*s.length);for(d=2*s.length-1,c=s.length-1;d>0;--d,--c){var h=s[c];"1"===u[d]&&(f.references[h]=!0),"1"===u[--d]&&(f.series[h]=!0)}var m=n(o[2],i.length);i.forEach(function(e,t){"1"===m[t]&&(f.companies[e.id]=!0)});var g=n(o[3],2*r.length);for(d=2*r.length-1,c=r.length-1;d>0;--d,--c){var x=r.at(c);x&&"1"===g[d]&&(f.prodFunctions[x.id]=!0)}return t.prodTasksStr=o[4],t.prodTasks.length&&a.readProdTasks(t.prodTasks,t.prodTasksStr,f.prodTasks),new a(f,t)},readProdTasks:function(e,t,i){for(var r=n(t,2*e.length),s=2*e.length-1,a=e.length-1;s>0;--s,--a){var o=e.at(a);o&&"1"===r[s]&&(i[o.id]=!0)}}})});