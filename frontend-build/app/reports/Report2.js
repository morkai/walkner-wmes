// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../data/aors","../data/downtimeReasons","../core/Model"],function(r,n,t,e){return e.extend({urlRoot:"/reports/2",defaults:function(){return{orgUnitType:null,orgUnit:null,prodTasks:{},clip:{orderCount:[],production:[],endToEnd:[]},maxClip:{orderCount:0,production:0,endToEnd:0},dirIndir:{quantityDone:0,efficiencyNum:0,laborSetupTime:0,productivity:0,productivityNoWh:0,direct:0,indirect:0,indirectProdFlow:0,directByProdFunction:{},indirectByProdFunction:{},production:0,storage:0,storageByProdTasks:{}},effIneff:{value:0,efficiency:0,dirIndir:0,prodFlow:0,prodTasks:{}}}},initialize:function(r,n){if(!n.query)throw new Error("query option is required!");this.query=n.query},getDirectRef:function(r){if(!r)return null;var n=this.get("dirIndir");return n.efficiencyNum*r+n.laborSetupTime||null},getIndirectRef:function(r,n){if(!r||!n)return null;var t=this.get("dirIndir").production,e=this.get("effIneff").prodTasks,i=e[r]||0;return(t-i)*n||null},getWarehouseRef:function(r){if(!r)return null;var n=this.get("dirIndir").direct;return n*r||null},getDirIndirRef:function(r){if(!r)return null;var n=this.get("effIneff");return n.prodFlow*r||null},getAbsenceRef:function(r){if(!r)return null;var n=this.get("dirIndir");return(n.production+n.storage)*r||null},fetch:function(n){return r.isObject(n)||(n={}),n.data=r.extend(n.data||{},this.query.serializeToObject(this.get("orgUnitType"),this.get("orgUnit"))),e.prototype.fetch.call(this,n)},getMaxEffIneffProdTaskFte:function(r){var n=this.get("effIneff").prodTasks,t=0;return Object.keys(n).forEach(function(e){var i=n[e];i>t&&r[e]&&(t=i)}),t},parse:function(r){var n={prodTasks:r.options.prodTasks,fteRatios:r.fteRatios,clip:null,maxClip:null,dirIndir:null,effIneff:null};return this.parseClip(r.clip,n),this.parseDirIndir(r.dirIndir,n),this.parseEffIneff(r.effIneff,n),n},parseClip:function(r,n){var t={orderCount:[],production:[],endToEnd:[]},e={orderCount:0,production:0,endToEnd:0};r.forEach(function(r){var n=r.orderCount||0,i=Math.round(100*(r.production||0)),o=Math.round(100*(r.endToEnd||0));t.orderCount.push({x:r.key,y:n}),t.production.push({x:r.key,y:i}),t.endToEnd.push({x:r.key,y:o}),e.orderCount=Math.max(e.orderCount,n),e.production=Math.max(e.production,i),e.endToEnd=Math.max(e.endToEnd,o)}),n.clip=t,n.maxClip=e},parseDirIndir:function(r,n){r.productivity=Math.round(100*r.productivity),r.productivityNoWh=Math.round(100*r.productivityNoWh),r.direct=Math.round(10*r.direct)/10,r.indirect=Math.round(10*r.indirect)/10,n.dirIndir=r},parseEffIneff:function(r,n){r.value=Math.round(10*r.value)/10,r.dirIndir=Math.round(10*r.dirIndir)/10,Object.keys(r.prodTasks).forEach(function(n){r.prodTasks[n]=Math.round(10*r.prodTasks[n])/10}),n.effIneff=r}})});