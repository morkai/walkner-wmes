// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../data/aors","../data/downtimeReasons","../core/Model"],function(t,n,a,i,o){function e(t,n){return t&&t[n]?t[n]:[0,0]}function u(t){return Math.round(100*t)/100}function r(t){return t.reduce(function(t,n){return t+n},0)}return o.extend({urlRoot:"/reports/3",defaults:function(){return{workDays:{},groupKeys:[],prodLines:[],tableSummary:[],chartSummary:{}}},initialize:function(t,n){if(!n.query)throw new Error("query option is required!");this.query=n.query},calcTableSummary:function(t){arguments.length||(t=this.get("prodLines"));for(var n=[],a={},i=0,o=t.length;o>i;++i){var e=t[i];this.query.matchProdLine(e)&&(n.push(e),a[e._id]=!0)}return arguments.length||this.set("tableSummary",n),this.query.diffProdLines(a),n},calcChartSummary:function(t,n,a){arguments.length||(t=this.get("workDays"),n=this.get("groupKeys"),a=this.get("tableSummary"));for(var i={categories:[],totalAvailabilityH:[],operationalAvailabilityH:[],exploitationH:[],oee:[],operationalAvailabilityP:[],exploitationP:[],adjustingDuration:[],maintenanceDuration:[],renovationDuration:[],malfunctionDuration:[],mttr:[],mtbf:[],malfunctionCount:[],majorMalfunctionCount:[]},o=0,e=n.length;e>o;++o){for(var r=n[o],l=0,s=0,c=0,m=0,d=0,f=0,h=0,y=0,p=0,D=0,v=0,b=0,g=0,H=0,L=a.length;L>H;++H){var P=a[H];if(this.query.isProdLineSelected(P._id,!0)){var A=P.data[r];void 0===A&&(A=this.createDefaultDataPoint(t?t[r]:1)),l+=A.totalAvailabilityH,s+=A.scheduledDuration,c+=A.unscheduledDuration,m+=A.exploitationH,d+=A.adjustingDuration,f+=A.maintenanceDuration,h+=A.renovationDuration,y+=A.malfunctionDuration,p+=A.malfunctionCount,D+=A.majorMalfunctionCount,v+=A.mtbfNum,b+=A.quantityDone,g+=A.quantityLost}}var j=l-s-c,q=j/l*100,C=m/j*100,x=this.calcOee(j,l,m,b,g),k=+r;i.totalAvailabilityH.push([k,l]),i.operationalAvailabilityH.push([k,u(j)]),i.exploitationH.push([k,u(m)]),i.oee.push([k,u(x)]),i.operationalAvailabilityP.push([k,u(q)]),i.exploitationP.push([k,u(C)]),i.adjustingDuration.push([k,u(d)]),i.maintenanceDuration.push([k,u(f)]),i.renovationDuration.push([k,u(h)]),i.malfunctionDuration.push([k,u(y)]),i.malfunctionCount.push([k,p]),i.majorMalfunctionCount.push([k,D]),i.mttr.push([k,p?u(y/p):0]),i.mtbf.push([k,p?u(v/p):0])}return arguments.length||this.set("chartSummary",i),i},createDefaultDataPoint:function(t){return{workDays:t,totalAvailabilityH:24*t,scheduledDuration:0,unscheduledDuration:0,operationalAvailabilityH:24*t,operationalAvailabilityP:100,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,malfunctions:null,mttr:0,mtbfNum:0,mtbf:0,quantityDone:0,quantityLost:0}},fetch:function(n){return t.isObject(n)||(n={}),n.data=t.extend(n.data||{},this.query.serializeToObject()),o.prototype.fetch.call(this,n)},parse:function(t){var n=t.options.workDays,a={},i=this.parseProdLines(t.options,t.results,a);a=this.parseGroupKeys(a);var o=this.calcTableSummary(i),e=this.calcChartSummary(n,a,i);return{workDays:n,groupKeys:a,prodLines:i,tableSummary:o,chartSummary:e}},parseProdLines:function(t,n,a){for(var i=[],o=0,e=t.prodLinesInfo.length;e>o;o+=3){var u=n[t.prodLinesInfo[o]],r={_id:t.prodLinesInfo[o],division:t.prodLinesInfo[o+1],subdivisionType:t.prodLinesInfo[o+2],inventoryNo:"?",workDays:t.totalWorkDays,scheduledDuration:0,unscheduledDuration:0,totalAvailabilityH:0,operationalAvailabilityH:0,operationalAvailabilityP:0,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,mttr:0,mtbfNum:0,mtbf:0,quantityDone:0,quantityLost:0,data:{}};this.parseProdLineData(t,r,u,a),this.summarizeProdLine(r),i.push(r)}return i},parseProdLineData:function(t,n,a,i){var o=this;Object.keys(a).forEach(function(u){i[u]=!0;var l=a[u],s=l.w||0,c=(t.workDays?t.workDays[u]:1)+s,m=24*c,d=l.e,f=e(l.d,"scheduled")[1]+.0625*c,h=e(l.d,"unscheduled")[1],y=m-f-h,p=y/m*100,D=e(l.d,"adjusting")[1],v=e(l.d,"maintenance")[1],b=e(l.d,"renovation")[1],g=e(l.d,"malfunction"),H=g[0],L=g[1],P=e(l.d,"majorMalfunction")[0],A=l.m||null,j=A?r(A.h):0,q=l.q||0,C=l.l||0;n.workDays+=s,n.scheduledDuration+=f,n.unscheduledDuration+=h,n.exploitationH+=d,n.adjustingDuration+=D,n.maintenanceDuration+=v,n.renovationDuration+=b,n.malfunctionCount+=H,n.malfunctionDuration+=L,n.majorMalfunctionCount+=P,n.quantityDone+=q,n.quantityLost+=C,n.data[u]={workDays:c,totalAvailabilityH:m,scheduledDuration:f,unscheduledDuration:h,operationalAvailabilityH:y,operationalAvailabilityP:p,exploitationH:d,exploitationP:d/y*100,oee:0,adjustingDuration:D,maintenanceDuration:v,renovationDuration:b,malfunctionDuration:L,malfunctionCount:H,majorMalfunctionCount:P,malfunctions:A,mttr:L/H,mtbfNum:j,mtbf:j?j/A.h.length:0,quantityDone:q,quantityLost:C},o.calcProdLineOee(n.data[u],!1)})},summarizeProdLine:function(t){t.totalAvailabilityH=24*t.workDays,t.operationalAvailabilityH=u(t.totalAvailabilityH-t.scheduledDuration-t.unscheduledDuration),t.operationalAvailabilityP=u(t.operationalAvailabilityH/t.totalAvailabilityH*100),t.exploitationH=u(t.exploitationH),t.exploitationP=u(t.exploitationH/t.operationalAvailabilityH*100),t.adjustingDuration=u(t.adjustingDuration),t.maintenanceDuration=u(t.maintenanceDuration),t.renovationDuration=u(t.renovationDuration),t.malfunctionDuration=u(t.malfunctionDuration),t.mttr=t.malfunctionCount>0?u(t.malfunctionDuration/t.malfunctionCount):0,this.calcProdLineOee(t,!0),t.malfunctionCount>1&&this.calcProdLineMtbf(t)},calcProdLineMtbf:function(t){var n=[],a=null,i=null;Object.keys(t.data).forEach(function(o){var e=t.data[o].malfunctions;null!==e&&(null!==i&&n.push((e.s-i)/36e5),e.h.length>0&&(n=n.concat(e.h)),null===a&&(a=e.s),i=e.f)}),t.mtbfNum=r(n),t.mtbf=u(t.mtbfNum/t.malfunctionCount)},calcProdLineOee:function(t,n){var a=this.calcOee(t.operationalAvailabilityH,t.totalAvailabilityH,t.exploitationH,t.quantityDone,t.quantityLost);t.oee=n?u(a):a},calcOee:function(t,n,a,i,o){var e=i+o;if(0===n||0===t||0===e)return 0;var u=t/n,r=a/t,l=i/e;return u*r*l*100},parseGroupKeys:function(t){return Object.keys(t).sort(function(t,n){return t-n})}})});