// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../data/aors","../data/downtimeReasons","../core/Model"],function(t,a,n,i,o){function e(t,a){return t&&t[a]?t[a]:[0,0]}function r(t){return Math.round(100*t)/100}return o.extend({urlRoot:"/reports/3",defaults:function(){return{workDays:{},groupKeys:[],prodLines:[],tableSummary:[],chartSummary:{}}},initialize:function(t,a){if(!a.query)throw new Error("query option is required!");this.query=a.query},calcTableSummary:function(t){arguments.length||(t=this.get("prodLines"));for(var a=[],n={},i=0,o=t.length;o>i;++i){var e=t[i];this.query.matchProdLine(e)&&(a.push(e),n[e._id]=!0)}return arguments.length||this.set("tableSummary",a),this.query.diffProdLines(n),a},calcChartSummary:function(t,a,n){arguments.length||(t=this.get("workDays"),a=this.get("groupKeys"),n=this.get("tableSummary"));for(var i={categories:[],totalAvailabilityH:[],operationalAvailabilityH:[],exploitationH:[],oee:[],operationalAvailabilityP:[],exploitationP:[],adjustingDuration:[],maintenanceDuration:[],renovationDuration:[],malfunctionDuration:[],mttr:[],mttf:[],mtbf:[],malfunctionCount:[],majorMalfunctionCount:[]},o=0,e=a.length;e>o;++o){for(var u=a[o],l=0,s=0,c=0,m=0,d=0,f=0,y=0,p=0,h=0,D=0,v=0,b=0,H=0,g=n.length;g>H;++H){var A=n[H];if(this.query.isProdLineSelected(A._id,!0)){var L=A.data[u];void 0===L&&(L=this.createDefaultDataPoint(t?t[u]:1)),l+=L.totalAvailabilityH,s+=L.scheduledDuration,c+=L.unscheduledDuration,m+=L.exploitationH,d+=L.adjustingDuration,f+=L.maintenanceDuration,y+=L.renovationDuration,p+=L.malfunctionDuration,h+=L.malfunctionCount,D+=L.majorMalfunctionCount,v+=L.quantityDone,b+=L.quantityLost}}var P=l-s-c,j=P/l*100,q=m/P*100,x=this.calcOee(P,l,m,v,b),C=+u;i.totalAvailabilityH.push([C,l]),i.operationalAvailabilityH.push([C,r(P)]),i.exploitationH.push([C,r(m)]),i.oee.push([C,r(x)]),i.operationalAvailabilityP.push([C,r(j)]),i.exploitationP.push([C,r(q)]),i.adjustingDuration.push([C,r(d)]),i.maintenanceDuration.push([C,r(f)]),i.renovationDuration.push([C,r(y)]),i.malfunctionDuration.push([C,r(p)]),i.malfunctionCount.push([C,h]),i.majorMalfunctionCount.push([C,D]);var w=0,k=0;h>0&&(w=p/h,k=P/h);var S=r(k+w);i.mttr.push([C,r(w)]),i.mttf.push([C,r(k)]),i.mtbf.push([C,0===S?P:S])}return arguments.length||this.set("chartSummary",i),i},createDefaultDataPoint:function(t){return{workDays:t,totalAvailabilityH:24*t,scheduledDuration:0,unscheduledDuration:0,operationalAvailabilityH:24*t,operationalAvailabilityP:100,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,malfunctions:null,mttr:0,mttf:0,mtbf:0,quantityDone:0,quantityLost:0}},fetch:function(a){return t.isObject(a)||(a={}),a.data=t.extend(a.data||{},this.query.serializeToObject()),o.prototype.fetch.call(this,a)},parse:function(t){var a=t.options.workDays,n={},i=this.parseProdLines(t.options,t.results,n);n=this.parseGroupKeys(n);var o=this.calcTableSummary(i),e=this.calcChartSummary(a,n,i);return{workDays:a,groupKeys:n,prodLines:i,tableSummary:o,chartSummary:e}},parseProdLines:function(t,a,n){for(var i=[],o=0,e=t.prodLinesInfo.length;e>o;o+=3){var r=a[t.prodLinesInfo[o]],u={_id:t.prodLinesInfo[o],division:t.prodLinesInfo[o+1],subdivisionType:t.prodLinesInfo[o+2],inventoryNo:"?",workDays:t.totalWorkDays,scheduledDuration:0,unscheduledDuration:0,totalAvailabilityH:0,operationalAvailabilityH:0,operationalAvailabilityP:0,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,mttr:0,mttf:0,mtbf:0,quantityDone:0,quantityLost:0,data:{}};this.parseProdLineData(t,u,r,n),this.summarizeProdLine(u),i.push(u)}return i},parseProdLineData:function(t,a,n,i){var o=this;Object.keys(n).forEach(function(r){i[r]=!0;var u=n[r],l=u.w||0,s=(t.workDays?t.workDays[r]:1)+l,c=24*s,m=u.e,d=e(u.d,"scheduled")[1],f=e(u.d,"unscheduled")[1],y=c-d-f,p=y/c*100,h=e(u.d,"adjusting")[1],D=e(u.d,"maintenance")[1],v=e(u.d,"renovation")[1],b=e(u.d,"malfunction"),H=b[0],g=b[1],A=e(u.d,"majorMalfunction")[0],L=u.m||null,P=u.q||0,j=u.l||0,q=g/H,x=y/H;a.workDays+=l,a.scheduledDuration+=d,a.unscheduledDuration+=f,a.exploitationH+=m,a.adjustingDuration+=h,a.maintenanceDuration+=D,a.renovationDuration+=v,a.malfunctionCount+=H,a.malfunctionDuration+=g,a.majorMalfunctionCount+=A,a.quantityDone+=P,a.quantityLost+=j,a.data[r]={workDays:s,totalAvailabilityH:c,scheduledDuration:d,unscheduledDuration:f,operationalAvailabilityH:y,operationalAvailabilityP:p,exploitationH:m,exploitationP:m/y*100,oee:0,adjustingDuration:h,maintenanceDuration:D,renovationDuration:v,malfunctionDuration:g,malfunctionCount:H,majorMalfunctionCount:A,malfunctions:L,mttr:q,mttf:x,mtbf:x+q,quantityDone:P,quantityLost:j},o.calcProdLineOee(a.data[r],!1)})},summarizeProdLine:function(t){t.totalAvailabilityH=24*t.workDays,t.operationalAvailabilityH=r(t.totalAvailabilityH-t.scheduledDuration-t.unscheduledDuration),t.operationalAvailabilityP=r(t.operationalAvailabilityH/t.totalAvailabilityH*100),t.exploitationH=r(t.exploitationH),t.exploitationP=r(t.exploitationH/t.operationalAvailabilityH*100),t.adjustingDuration=r(t.adjustingDuration),t.maintenanceDuration=r(t.maintenanceDuration),t.renovationDuration=r(t.renovationDuration),t.malfunctionDuration=r(t.malfunctionDuration),t.malfunctionCount>0?(t.mttr=r(t.malfunctionDuration/t.malfunctionCount),t.mttf=r(t.operationalAvailabilityH/t.malfunctionCount),t.mtbf=t.mttr+t.mttf):(t.mttr=0,t.mttf=0,t.mtbf=t.operationalAvailabilityH),this.calcProdLineOee(t,!0)},calcProdLineOee:function(t,a){var n=this.calcOee(t.operationalAvailabilityH,t.totalAvailabilityH,t.exploitationH,t.quantityDone,t.quantityLost);t.oee=a?r(n):n},calcOee:function(t,a,n,i,o){var e=i+o;if(0===a||0===t||0===e)return 0;var r=t/a,u=n/t,l=i/e;return r*u*l*100},parseGroupKeys:function(t){return Object.keys(t).sort(function(t,a){return t-a})}})});