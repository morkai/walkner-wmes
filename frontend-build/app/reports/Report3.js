define(["underscore","../i18n","../data/aors","../data/downtimeReasons","../core/Model"],function(t,n,a,i,o){function u(t,n){return t&&t[n]?t[n]:[0,0]}function r(t){return Math.round(100*t)/100}function e(t){return t.reduce(function(t,n){return t+n},0)}return o.extend({urlRoot:"/reports/3",defaults:function(){return{workDays:{},groupKeyToWorkDayCount:{},groupKeys:[],prodLines:[],tableSummary:[],chartSummary:{}}},initialize:function(t,n){if(!n.query)throw new Error("query option is required!");this.query=n.query},calcTableSummary:function(t){arguments.length||(t=this.get("prodLines"));for(var n=[],a={},i=0,o=t.length;o>i;++i){var u=t[i];this.query.matchProdLine(u)&&(n.push(u),a[u._id]=!0)}return arguments.length||this.set("tableSummary",n),this.query.diffProdLines(a),n},calcChartSummary:function(t,n,a){arguments.length||(t=this.get("workDays"),n=this.get("groupKeys"),a=this.get("tableSummary"));for(var i={categories:[],totalAvailabilityH:[],operationalAvailabilityH:[],exploitationH:[],oee:[],operationalAvailabilityP:[],exploitationP:[],adjustingDuration:[],maintenanceDuration:[],renovationDuration:[],malfunctionDuration:[],mttr:[],mtbf:[],malfunctionCount:[],majorMalfunctionCount:[]},o=0,u=n.length;u>o;++o){for(var e=n[o],l=0,s=0,c=0,m=0,d=0,f=0,h=0,p=0,D=0,y=0,v=0,b=0,g=a.length;g>b;++b){var H=a[b];if(this.query.isProdLineSelected(H._id,!0)){var P=H.data[e];void 0===P&&(P=this.createDefaultDataPoint(t?t[e]:1)),l+=P.totalAvailabilityH,s+=P.scheduledDuration,c+=P.unscheduledDuration,m+=P.exploitationH,d+=P.adjustingDuration,f+=P.maintenanceDuration,h+=P.renovationDuration,p+=P.malfunctionDuration,D+=P.malfunctionCount,y+=P.majorMalfunctionCount,v+=P.mtbfNum}}var j=l-s-c,A=j/l*100,C=m/j*100,L=+e;i.totalAvailabilityH.push([L,l]),i.operationalAvailabilityH.push([L,r(j)]),i.exploitationH.push([L,r(m)]),i.oee.push([L,0]),i.operationalAvailabilityP.push([L,r(A)]),i.exploitationP.push([L,r(C)]),i.adjustingDuration.push([L,r(d)]),i.maintenanceDuration.push([L,r(f)]),i.renovationDuration.push([L,r(h)]),i.malfunctionDuration.push([L,r(p)]),i.malfunctionCount.push([L,D]),i.majorMalfunctionCount.push([L,y]),i.mttr.push([L,D?r(p/D):0]),i.mtbf.push([L,D?r(v/D):0])}return arguments.length||this.set("chartSummary",i),i},createDefaultDataPoint:function(t){return{workDays:t,totalAvailabilityH:24*t,scheduledDuration:0,unscheduledDuration:0,operationalAvailabilityH:24*t,operationalAvailabilityP:100,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,malfunctions:null,mttr:0,mtbfNum:0,mtbf:0}},fetch:function(n){return t.isObject(n)||(n={}),n.data=t.extend(n.data||{},this.query.serializeToObject()),o.prototype.fetch.call(this,n)},parse:function(t){var n=t.options.workDays,a={},i=this.parseProdLines(t.options,t.results,a);a=this.parseGroupKeys(a);var o=this.calcTableSummary(i),u=this.calcChartSummary(n,a,i);return{workDays:n,groupKeys:a,prodLines:i,tableSummary:o,chartSummary:u}},parseProdLines:function(t,n,a){for(var i=[],o=0,u=t.prodLinesInfo.length;u>o;o+=3){var r=n[t.prodLinesInfo[o]],e={_id:t.prodLinesInfo[o],division:t.prodLinesInfo[o+1],subdivisionType:t.prodLinesInfo[o+2],inventoryNo:"?",workDays:t.totalWorkDays,scheduledDuration:0,unscheduledDuration:0,totalAvailabilityH:0,operationalAvailabilityH:0,operationalAvailabilityP:0,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,mttr:0,mtbfNum:0,mtbf:0,data:{}};this.parseProdLineData(t,e,r,a),this.summarizeProdLine(e),i.push(e)}return i},parseProdLineData:function(t,n,a,i){Object.keys(a).forEach(function(o){i[o]=!0;var r=a[o],l=r.w||0,s=(t.workDays?t.workDays[o]:1)+l,c=24*s,m=r.e,d=u(r.d,"scheduled")[1]+.0625*s,f=u(r.d,"unscheduled")[1],h=c-d-f,p=h/c*100,D=u(r.d,"adjusting")[1],y=u(r.d,"maintenance")[1],v=u(r.d,"renovation")[1],b=u(r.d,"malfunction"),g=b[0],H=b[1],P=u(r.d,"majorMalfunction")[0],j=r.m||null,A=j?e(j.h):0;n.workDays+=l,n.scheduledDuration+=d,n.unscheduledDuration+=f,n.exploitationH+=m,n.adjustingDuration+=D,n.maintenanceDuration+=y,n.renovationDuration+=v,n.malfunctionCount+=g,n.malfunctionDuration+=H,n.majorMalfunctionCount+=P,n.data[o]={workDays:s,totalAvailabilityH:c,scheduledDuration:d,unscheduledDuration:f,operationalAvailabilityH:h,operationalAvailabilityP:p,exploitationH:m,exploitationP:m/h*100,oee:0,adjustingDuration:D,maintenanceDuration:y,renovationDuration:v,malfunctionDuration:H,malfunctionCount:g,majorMalfunctionCount:P,malfunctions:j,mttr:H/g,mtbfNum:A,mtbf:A?A/j.h.length:0}})},summarizeProdLine:function(t){t.totalAvailabilityH=24*t.workDays,t.operationalAvailabilityH=r(t.totalAvailabilityH-t.scheduledDuration-t.unscheduledDuration),t.operationalAvailabilityP=r(t.operationalAvailabilityH/t.totalAvailabilityH*100),t.exploitationH=r(t.exploitationH),t.exploitationP=r(t.exploitationH/t.operationalAvailabilityH*100),t.adjustingDuration=r(t.adjustingDuration),t.maintenanceDuration=r(t.maintenanceDuration),t.renovationDuration=r(t.renovationDuration),t.malfunctionDuration=r(t.malfunctionDuration),t.mttr=t.malfunctionCount>0?r(t.malfunctionDuration/t.malfunctionCount):0,t.malfunctionCount>1&&this.calcProdLineMtbf(t)},calcProdLineMtbf:function(t){var n=[],a=null,i=null;Object.keys(t.data).forEach(function(o){var u=t.data[o].malfunctions;null!==u&&(null!==i&&n.push((u.s-i)/36e5),u.h.length>0&&(n=n.concat(u.h)),null===a&&(a=u.s),i=u.f)}),t.mtbfNum=e(n),t.mtbf=r(t.mtbfNum/t.malfunctionCount)},parseGroupKeys:function(t){return Object.keys(t).sort(function(t,n){return t-n})}})});