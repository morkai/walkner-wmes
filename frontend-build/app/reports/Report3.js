define(["underscore","../data/aors","../data/downtimeReasons","../data/orgUnits","../core/Model"],function(t,a,i,n,o){"use strict";function e(t,a){return t&&t[a]?t[a]:[0,0]}function r(t){return isNaN(t)?0:Math.round(100*t)/100}return o.extend({urlRoot:"/reports/3",defaults:function(){return{workDays:{},groupKeys:[],prodLines:[],tableSummary:[],chartSummary:{totalAvailabilityH:[],operationalAvailabilityH:[],exploitationH:[],oee:[],operationalAvailabilityP:[],exploitationP:[],adjustingDuration:[],maintenanceDuration:[],renovationDuration:[],malfunctionDuration:[],mttr:[],mtbf:[],malfunctionCount:[],majorMalfunctionCount:[]}}},initialize:function(t,a){if(!a.query)throw new Error("query option is required!");this.query=a.query},calcTableSummary:function(t){arguments.length||(t=this.get("prodLines"));for(var a=[],i={},n=0,o=t.length;n<o;++n){var e=t[n];this.query.matchProdLine(e)&&(a.push(e),i[e._id]=!0)}return arguments.length||this.set("tableSummary",a),this.query.diffProdLines(i),a},calcChartSummary:function(t,a,i){arguments.length||(t=this.get("workDays"),a=this.get("groupKeys"),i=this.get("tableSummary"));for(var n={categories:[],totalAvailabilityH:[],operationalAvailabilityH:[],exploitationH:[],oee:[],operationalAvailabilityP:[],exploitationP:[],adjustingDuration:[],maintenanceDuration:[],renovationDuration:[],malfunctionDuration:[],mttr:[],mttf:[],mtbf:[],malfunctionCount:[],majorMalfunctionCount:[]},o=0,e=a.length;o<e;++o){for(var u=a[o],l=+u,s=0,c=0,m=0,d=0,f=0,y=0,p=0,D=0,h=0,v=0,b=0,H=0,A=0,g=i.length;A<g;++A){var P=i[A];if(this.query.isProdLineSelected(P._id,!0)){var j=P.data[u];void 0===j&&(j=this.createDefaultDataPoint(l>=P.deactivatedAt?0:t?t[u]:1)),s+=j.totalAvailabilityH,c+=j.scheduledDuration,m+=j.unscheduledDuration,d+=j.exploitationH,f+=j.adjustingDuration,y+=j.maintenanceDuration,p+=j.renovationDuration,D+=j.malfunctionDuration,h+=j.malfunctionCount,v+=j.majorMalfunctionCount,b+=j.quantityDone,H+=j.quantityLost}}var q=s-c-m,L=q/s*100,C=d/q*100,x=this.calcOee(q,s,d,b,H);n.totalAvailabilityH.push([l,s]),n.operationalAvailabilityH.push([l,r(q)]),n.exploitationH.push([l,r(d)]),n.oee.push([l,r(x)]),n.operationalAvailabilityP.push([l,r(L)]),n.exploitationP.push([l,r(C)]),n.adjustingDuration.push([l,r(f)]),n.maintenanceDuration.push([l,r(y)]),n.renovationDuration.push([l,r(p)]),n.malfunctionDuration.push([l,r(D)]),n.malfunctionCount.push([l,h]),n.majorMalfunctionCount.push([l,v]);var w=0,S=0;h>0&&(w=D/h,S=q/h);var k=r(S+w);n.mttr.push([l,r(w)]),n.mttf.push([l,r(S)]),n.mtbf.push([l,0===k?q:k])}return arguments.length||this.set("chartSummary",n),n},createDefaultDataPoint:function(t){return{workDays:t,totalAvailabilityH:24*t,scheduledDuration:0,unscheduledDuration:0,operationalAvailabilityH:24*t,operationalAvailabilityP:100,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,malfunctions:null,mttr:0,mttf:0,mtbf:0,quantityDone:0,quantityLost:0}},fetch:function(a){return t.isObject(a)||(a={}),a.data=t.assign(a.data||{},this.query.serializeToObject()),o.prototype.fetch.call(this,a)},parse:function(t){var a=t.options.workDays,i=this.parseGroupKeys(a),n=this.parseProdLines(t.options,t.results,i),o=this.calcTableSummary(n);return{workDays:a,groupKeys:i,prodLines:n,tableSummary:o,chartSummary:this.calcChartSummary(a,i,o)}},parseProdLines:function(t,a,i){for(var n=[],o=t.prodLinesInfo,e=0,r=o.length;e<r;e+=5){var u=o[e],l=a[u],s=o[e+4],c={_id:u,division:o[e+1],subdivisionType:o[e+2],inventoryNo:o[e+3],deactivatedAt:s,workDays:0,scheduledDuration:0,unscheduledDuration:0,totalAvailabilityH:0,operationalAvailabilityH:0,operationalAvailabilityP:0,exploitationH:0,exploitationP:0,oee:0,adjustingDuration:0,maintenanceDuration:0,renovationDuration:0,malfunctionDuration:0,malfunctionCount:0,majorMalfunctionCount:0,mttr:0,mttf:0,mtbf:0,quantityDone:0,quantityLost:0,data:{}};this.parseProdLineData(t,c,l||{},i),this.summarizeProdLine(c),n.push(c)}return n},parseProdLineData:function(t,a,i,n){var o=this;n.forEach(function(n){var r=i[n]||{},u=void 0===r.w?t.workDays[n]:r.w,l=24*u,s=u&&r.e||0,c=u?e(r.d,"scheduled")[1]:0,m=u?e(r.d,"unscheduled")[1]:0,d=l-c-m,f=u?d/l*100:0,y=u?e(r.d,"adjusting")[1]:0,p=u?e(r.d,"maintenance")[1]:0,D=u?e(r.d,"renovation")[1]:0,h=u?e(r.d,"malfunction"):[0,0],v=h[0],b=h[1],H=u?e(r.d,"majorMalfunction")[0]:0,A=u&&r.m||null,g=u&&r.q||0,P=u&&r.l||0,j=v?b/v:0,q=v?d/v:0;a.workDays+=u,a.scheduledDuration+=c,a.unscheduledDuration+=m,a.exploitationH+=s,a.adjustingDuration+=y,a.maintenanceDuration+=p,a.renovationDuration+=D,a.malfunctionCount+=v,a.malfunctionDuration+=b,a.majorMalfunctionCount+=H,a.quantityDone+=g,a.quantityLost+=P,a.data[n]={workDays:u,totalAvailabilityH:l,scheduledDuration:c,unscheduledDuration:m,operationalAvailabilityH:d,operationalAvailabilityP:f,exploitationH:s,exploitationP:s/d*100,oee:0,adjustingDuration:y,maintenanceDuration:p,renovationDuration:D,malfunctionDuration:b,malfunctionCount:v,majorMalfunctionCount:H,malfunctions:A,mttr:j,mttf:q,mtbf:q+j,quantityDone:g,quantityLost:P},o.calcProdLineOee(a.data[n],!1)})},summarizeProdLine:function(t){t.totalAvailabilityH=24*t.workDays,t.operationalAvailabilityH=r(t.totalAvailabilityH-t.scheduledDuration-t.unscheduledDuration),t.operationalAvailabilityP=r(t.operationalAvailabilityH/t.totalAvailabilityH*100),t.exploitationH=r(t.exploitationH),t.exploitationP=r(t.exploitationH/t.operationalAvailabilityH*100),t.adjustingDuration=r(t.adjustingDuration),t.maintenanceDuration=r(t.maintenanceDuration),t.renovationDuration=r(t.renovationDuration),t.malfunctionDuration=r(t.malfunctionDuration),t.malfunctionCount>0?(t.mttr=r(t.malfunctionDuration/t.malfunctionCount),t.mttf=r(t.operationalAvailabilityH/t.malfunctionCount),t.mtbf=t.mttr+t.mttf):(t.mttr=0,t.mttf=0,t.mtbf=t.operationalAvailabilityH),this.calcProdLineOee(t,!0)},calcProdLineOee:function(t,a){var i=this.calcOee(t.operationalAvailabilityH,t.totalAvailabilityH,t.exploitationH,t.quantityDone,t.quantityLost);t.oee=a?r(i):i},calcOee:function(t,a,i,n,o){var e=n+o;return 0===a||0===t||0===e?0:t/a*(i/t)*(n/e)*100},parseGroupKeys:function(t){return Object.keys(t).sort(function(t,a){return t-a})}})});