// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../core/Model","../data/aors","../data/downtimeReasons"],function(e,t,n,i){function s(e,t){for(;e.length<t;)e="0"+e;return e}var r=["quantityDone","scheduledDowntime","unscheduledDowntime","efficiency","productivity","productivityNoWh"];return t.extend({defaults:function(){var e={series:{},aors:{},reasons:{},extremes:"none",maxQuantityDone:null,maxPercentCoeff:null,maxDowntimesByAor:null,maxDowntimesByReason:null,references:{}};return r.forEach(function(t){e.series[t]=!0,e.references[t]=!0}),n.forEach(function(t){e.aors[t.id]=!0,e.references[t.id]=!0}),i.forEach(function(t){e.reasons[t.id]=!0,e.references[t.id]=!0}),e},initialize:function(e,t){if(!t.settings)throw new Error("settings option is required!");this.settings=t.settings},isSeriesVisible:function(e){return!!this.get("series")[e]},isReferenceVisible:function(e){return!!this.get("references")[e]},updateExtremes:function(e){var t={maxQuantityDone:null,maxPercentCoeff:null,maxDowntimesByAor:null,maxDowntimesByReason:null},n=this.get("extremes");if("none"===n)return this.set(t);for(var i=this.get("series"),s=this.get("aors"),r=this.get("reasons"),o=this.get("references"),a="siblings"===n?1:0,c=e.length;c>a;++a){var u=e[a],f=u.get("maxCoeffs"),h=u.getReferenceOrgUnitId();t.maxQuantityDone=Math.max(t.maxQuantityDone,i.quantityDone?f.quantityDone:0),t.maxPercentCoeff=Math.max(t.maxPercentCoeff,i.scheduledDowntime?f.scheduledDowntime:0,i.scheduledDowntime&&o.scheduledDowntime?this.settings.getReference("scheduledDowntime",h):0,i.unscheduledDowntime?f.unscheduledDowntime:0,i.unscheduledDowntime&&o.unscheduledDowntime?this.settings.getReference("unscheduledDowntime",h):0,i.efficiency?f.efficiency:0,i.efficiency&&o.efficiency?this.settings.getReference("efficiency",h):0,i.productivity?f.productivity:0,i.productivity&&o.productivity?this.settings.getReference("productivity",h):0,i.productivityNoWh?f.productivityNoWh:0,i.productivityNoWh&&o.productivityNoWh?this.settings.getReference("productivityNoWh",h):0),t.maxDowntimesByAor=Math.max(t.maxDowntimesByAor,u.getMaxDowntimesByAor(s,o)),t.maxDowntimesByReason=Math.max(t.maxDowntimesByReason,u.getMaxDowntimesByReason(r,o))}this.set(t)},serializeToString:function(){var e=this.get("extremes"),t=this.get("series"),s=this.get("references"),o=this.get("aors"),a=this.get("reasons"),c=["none"===e?0:"siblings"===e?1:2,"","",""];return r.forEach(function(e){c[1]+=t[e]?1:0,c[1]+=s[e]?1:0}),n.forEach(function(e){c[2]+=o[e.id]?1:0,c[2]+=s[e.id]?1:0}),i.forEach(function(e){c[3]+=a[e.id]?1:0,c[3]+=s[e.id]?1:0}),c.join("&")}},{fromString:function(e,t){var o=this,a=e.split("&");if(4!==a.length)return new o(null,t);var c,u,f={extremes:"2"===a[0]?"parent":"1"===a[0]?"siblings":"none",series:{},aors:{},reasons:{},references:{}},h=s(a[1],2*r.length);for(c=2*r.length-1,u=r.length-1;c>0;--c,--u)"1"===h[c]&&(f.references[r[u]]=!0),"1"===h[--c]&&(f.series[r[u]]=!0);var d=s(a[2],2*n.length);for(c=2*n.length-1,u=n.length-1;c>0;--c,--u){var l=n.at(u);"1"===d[c]&&(f.references[l.id]=!0),"1"===d[--c]&&(f.aors[l.id]=!0)}var m=s(a[3],2*i.length);for(c=2*i.length-1,u=i.length-1;c>0;--c,--u){var g=i.at(u);"1"===m[c]&&(f.references[g.id]=!0),"1"===m[--c]&&(f.reasons[g.id]=!0)}return new o(f,t)}})});