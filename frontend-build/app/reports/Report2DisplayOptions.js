// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../core/Model","../data/prodFunctions"],function(e,r,t){function i(e,r){for(;e.length<r;)e="0"+e;return e}var n=["clipOrderCount","clipProduction","clipEndToEnd","direct","indirect","warehouse","productivity","productivityNoWh","quantityDone","dirIndir","effIneff","absence"];return r.extend({defaults:function(){var e={series:{},prodFunctions:{},prodTasks:{},extremes:"none",maxClipOrderCount:null,maxClipPercent:null,maxDirIndirFte:null,maxDirIndirPercent:null,maxResourceFte:null,references:{}};return n.forEach(function(r){e.series[r]=!0,e.references[r]=!0}),t.forEach(function(r){e.prodFunctions[r.id]=!0,e.references[r.id]=!0}),e},initialize:function(e,r){if(!r.settings)throw new Error("settings option is required!");if(!r.prodTasks)throw new Error("prodTasks option is required!");this.settings=r.settings,this.prodTasks=r.prodTasks,this.listenToOnce(this.prodTasks,"reset",function(){r.prodTasksStr?this.constructor.readProdTasks(this.prodTasks,r.prodTasksStr,this.attributes.prodTasks):this.prodTasks.forEach(function(e){this.attributes.prodTasks[e.id]=!0,this.attributes.references[e.id]=!0},this)})},isSeriesVisible:function(e){return!!this.get("series")[e]},isReferenceVisible:function(e){return!!this.get("references")[e]},updateExtremes:function(e){var r={maxClipOrderCount:null,maxClipPercent:null,maxDirIndirFte:null,maxDirIndirPercent:null,maxResourceFte:null},t=this.get("extremes");if("none"===t)return this.set(r);for(var i=this.get("series"),n=this.get("prodTasks"),s=this.get("references"),o=this.settings,d=o.getCoeff("directRef"),a=o.getCoeff("indirectRef"),c=o.getCoeff("warehouseRef"),f=o.getCoeff("absenceRef"),u=o.getValue("absenceRef.prodTask"),h="siblings"===t?1:0,l=e.length;l>h;++h){var p=e[h],g=p.get("maxClip");r.maxClipOrderCount=Math.max(r.maxClipOrderCount,i.clipOrderCount?g.orderCount:0),r.maxClipPercent=Math.max(r.maxClipPercent,i.clipProduction?g.production:0,i.clipEndToEnd?g.endToEnd:0);var x=p.get("dirIndir");r.maxDirIndirFte=Math.max(r.maxDirIndirFte,i.direct?x.direct:0,i.direct&&s.direct?p.getDirectRef(d):0,i.indirect?x.indirect:0,i.indirect&&s.indirect?p.getIndirectRef(u,a):0,i.warehouse?x.storage:0,i.warehouse&&s.warehouse?p.getWarehouseRef(c):0),r.maxDirIndirPercent=Math.max(r.maxDirIndirPercent,i.productivity?x.productivity:0,i.productivityNoWh?x.productivityNoWh:0);var m=p.get("effIneff");r.maxResourceFte=Math.max(r.maxResourceFte,i.dirIndir?m.dirIndir:0,i.dirIndir&&s.dirIndir?p.getDirIndirRef(o.getCoeff("dirIndirRef")):0,i.effIneff?Math.abs(m.value):0,n[u]&&s.absence?p.getAbsenceRef(f):0,p.getMaxEffIneffProdTaskFte(n))}this.set(r)},serializeToString:function(){var e=this.get("extremes"),r=this.get("series"),i=this.get("references"),s=this.get("prodTasks"),o=this.get("prodFunctions"),d=["none"===e?0:"siblings"===e?1:2,"","",""];return n.forEach(function(e){d[1]+=r[e]?1:0,d[1]+=i[e]?1:0}),this.prodTasks.forEach(function(e){d[2]+=s[e.id]?1:0}),t.forEach(function(e){d[3]+=o[e.id]?1:0}),d.join("&")}},{fromString:function(e,r){var s=this,o=e.split("&");if(4!==o.length)return new s(null,r);var d,a,c={extremes:"2"===o[0]?"parent":"1"===o[0]?"siblings":"none",series:{},prodTasks:{},prodFunctions:{},references:{}},f=i(o[1],2*n.length);for(d=2*n.length-1,a=n.length-1;d>0;--d,--a)"1"===f[d]&&(c.references[n[a]]=!0),"1"===f[--d]&&(c.series[n[a]]=!0);r.prodTasksStr=o[2],r.prodTasks.length&&s.readProdTasks(r.prodTasks,r.prodTasksStr,c.prodTasks);var u=i(o[3],2*t.length);for(d=2*t.length-1,a=t.length-1;d>0;--d,--a){var h=t.at(a);h&&"1"===u[d]&&(c.prodFunctions[h.id]=!0)}return new s(c,r)},readProdTasks:function(e,r,t){for(var n=i(r,2*e.length),s=2*e.length-1,o=e.length-1;s>0;--s,--o){var d=e.at(o);d&&"1"===n[s]&&(t[d.id]=!0)}}})});