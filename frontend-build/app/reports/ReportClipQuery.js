// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../core/Model","../data/orgUnits","../mrpControllers/MrpController","./ReportClip"],function(t,e,r,n,i,o){"use strict";return r.extend({defaults:function(){var t=e.getMoment();return t.hours()<6&&t.subtract(1,"days"),t.startOf("day"),{orgUnitType:null,orgUnitId:null,to:t.valueOf(),from:t.subtract(7,"days").valueOf(),interval:"day",limit:25,skip:0,orderHash:null,orderCount:0}},reset:function(e){this.set(t.defaults(e,this.defaults()),{reset:!0})},createReports:function(t,e,r){var s=[],l=this.get("orgUnitType"),d=n.getByTypeAndId(l,this.get("orgUnitId"));d||"mrpController"!==l||(d=new i({_id:this.get("orgUnitId"),subdivision:null})),t||(t=new o({orgUnitType:this.get("orgUnitType"),orgUnit:d},r)),s.push(t);var g,u=n.getChildType(l);return d?"mrpController"===u?g=t.get("children").map(function(t){var e=n.getByTypeAndId("mrpController",t);return new i({_id:t,subdivision:d.id,description:e?e.get("description"):""})}):"prodFlow"===u?g=t.get("children").map(function(t){return n.getByTypeAndId(u,t)}):(g=n.getChildren(d),"subdivision"===u&&(g=g.filter(function(t){return"assembly"===t.get("type")}))):g=n.getAllDivisions().filter(function(t){return"prod"===t.get("type")}),g.sort(function(t,e){return t.getLabel().localeCompare(e.getLabel())}),g.forEach(function(t){e&&t.id===e.get("orgUnit").id?s.push(e):s.push(new o({orgUnitType:u,orgUnit:t},r))}),s},serializeToObject:function(t,e){var r={interval:this.get("interval"),from:this.get("from"),to:this.get("to")};return t&&e&&(r.orgUnitType=t,r.orgUnitId=e.id),r},serializeToString:function(t,e){var r="",n=this.attributes;return n.interval&&(r+="&interval="+n.interval),n.from&&n.to&&(r+="&from="+n.from,r+="&to="+n.to),2===arguments.length&&void 0!==t?t&&(r+="&orgUnitType="+t,r+="&orgUnitId="+encodeURIComponent(e)):n.orgUnitType&&(r+="&orgUnitType="+n.orgUnitType,r+="&orgUnitId="+encodeURIComponent(n.orgUnitId)),r+="&limit="+n.limit,r+="&skip="+n.skip,r.substr(1)}})});