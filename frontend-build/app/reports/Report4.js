define(["underscore","../i18n","../data/divisions","../data/downtimeReasons","../core/Model"],function(e,o,t,s,r){function n(e){return e?Math.round(100*e):0}function i(e){return e?Math.round(100*e)/100:0}return r.extend({urlRoot:"/reports/4",defaults:function(){return{lossReasons:{},effAndProd:{efficiency:[],productivity:[],byDivision:{}},workTimes:{total:0,sap:0,otherWorks:0,downtimes:[],downtimeCategories:[]},machineTimes:{categories:[],machineMedian:[],work:[],operatorMedian:[]},quantities:{good:0,bad:0,losses:{}}}},initialize:function(e,o){if(!o.query)throw new Error("query option is required!");this.query=o.query},fetch:function(o){return e.isObject(o)||(o={}),o.data=e.extend(o.data||{},this.query.serializeToObject()),r.prototype.fetch.call(this,o)},parse:function(e){return this.query.updateUsers(this.resolveUsers(e.options)),{lossReasons:e.options.lossReasons,effAndProd:this.parseEffAndProd(e.results.effAndProd),workTimes:this.parseWorkTimes(e.results.workTimes),machineTimes:this.parseMachineTimes(e.results.machineTimes),quantities:this.parseQuantities(e.options.lossReasons,e.results.quantities)}},resolveUsers:function(e){return"masters"===e.mode?e.masters:"operators"===e.mode?e.operators:[]},parseEffAndProd:function(e){var o=t.filter(function(e){return"prod"===e.get("type")}).map(function(e){return e.id}).sort(function(e,o){return e.localeCompare(o)}),s={efficiency:[],productivity:[],byDivision:{}};return o.forEach(function(e){s.byDivision[e]=[]}),Object.keys(e).forEach(function(t){var r=e[t],i=+t;s.efficiency.push({x:i,y:n(r.eff)}),s.productivity.push({x:i,y:n(r.prod)}),o.forEach(function(e){s.byDivision[e].push({x:i,y:n(r[e])})})}),s},parseWorkTimes:function(e){var o={total:[i(e.total)],sap:[i(e.sap)],otherWorks:[i(e.otherWorks)],downtimes:[],downtimeCategories:[]},t=[];return Object.keys(e.downtimes).forEach(function(o){var r=s.get(o);t.push({shortText:o,longText:r?r.getLabel():o,value:i(e.downtimes[o])})}),t.sort(function(e,o){return o.value-e.value}).forEach(function(e){o.downtimeCategories.push(e.shortText),o.downtimes.push({name:e.longText,y:e.value})}),o},parseMachineTimes:function(e){var o={categories:[],machineMedian:[],work:[],operatorMedian:[]},t=Object.keys(e),s=t.length>10;return t.forEach(function(t,r){var n=e[t];o.categories.push(s?r.toString(36).toUpperCase():t),s?(o.machineMedian.push({y:i(n.machineAdjustingMedian),name:t}),o.work.push({y:i(n.work),name:t}),o.operatorMedian.push({y:i(n.operatorAdjustingMedian),name:t})):(o.machineMedian.push(i(n.machineAdjustingMedian)),o.work.push(i(n.work)),o.operatorMedian.push(i(n.operatorAdjustingMedian)))}),o},parseQuantities:function(e,o){var t={total:[i(o.good+o.bad)],good:[i(o.good)],bad:[i(o.bad)],losses:[],lossCategories:[]},s=[];return Object.keys(o.losses).forEach(function(t){s.push({shortText:t,longText:e[t]||t,value:o.losses[t]})}),s.sort(function(e,o){return o.value-e.value}).forEach(function(e){t.lossCategories.push(e.shortText),t.losses.push({name:e.longText,y:e.value})}),t}})});