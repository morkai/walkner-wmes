define(["underscore","../i18n","../core/Model","../data/colorFactory"],function(o,n,e,r){"use strict";return e.extend({nlsDomain:"reports",urlRoot:"/reports/clip",defaults:function(){return{orgUnitType:null,orgUnit:null,orderHash:null,orderCount:0,parent:null,children:[],mrps:[],fromTimeLocal:0,toTimeLocal:0,clip:{orderCount:[],production:[],productionCount:[],endToEnd:[],endToEndCount:[]},delayReasons:[],m4s:[],drms:[],maxClip:{orderCount:0,production:0,endToEnd:0},maxDelayReasons:0,maxM4s:0,maxDrms:0}},initialize:function(o,n){if(!n.query)throw new Error("query option is required!");this.query=n.query,this.delayReasons=n.delayReasons},fetch:function(n){return o.isObject(n)||(n={}),n.data=o.assign(n.data||{},this.query.serializeToObject(this.get("orgUnitType"),this.get("orgUnit"))),e.prototype.fetch.call(this,n)},parse:function(o){var n={orderHash:o.orderHash,orderCount:o.orderCount,parent:o.parent,children:o.children,mrps:o.mrps,fromTimeLocal:o.fromTimeLocal,toTimeLocal:o.toTimeLocal,clip:null,delayReasons:null,m4s:null,drms:null,maxClip:null,maxDelayReasons:null,maxM4s:null,maxDrms:null};return this.parseClip(o.groups,n),this.parseDelayReasons(o.delayReasons,n),this.parseM4s(o.m4s,n),this.parseDrms(o.drms,n),n},parseClip:function(o,n){var e={mrps:[],orderCount:[],productionCount:[],endToEndCount:[],production:[],endToEnd:[]},r={orderCount:0,productionCount:0,endToEndCount:0,production:0,endToEnd:0};o.forEach(function(o){var n=Math.round(o.productionCount/o.orderCount*1e3)/10||0,t=Math.round(o.endToEndCount/o.orderCount*1e3)/10||0;e.mrps.push(o.mrps),e.orderCount.push({x:o.key,y:o.orderCount}),e.production.push({x:o.key,y:n}),e.productionCount.push({x:o.key,y:o.productionCount}),e.endToEnd.push({x:o.key,y:t}),e.endToEndCount.push({x:o.key,y:o.endToEndCount}),r.orderCount=Math.max(r.orderCount,o.orderCount),r.productionCount=Math.max(r.productionCount,o.productionCount),r.endToEndCount=Math.max(r.endToEndCount,o.endToEndCount),r.production=Math.max(r.production,n),r.endToEnd=Math.max(r.endToEnd,t)}),n.clip=e,n.maxClip=r},parseDelayReasons:function(o,n){var e=this;n.maxDelayReasons=0,n.delayReasons=[],o.forEach(function(o){var t=e.delayReasons&&e.delayReasons.get(o._id);n.delayReasons.push({name:t?t.getLabel():o._id,y:o.count,color:r.getColor("delayReasons",o._id)}),n.maxDelayReasons=Math.max(n.maxDelayReasons,o.count)})},parseM4s:function(o,e){e.maxM4s=0,e.m4s=[],o.forEach(function(o){e.m4s.push({name:n("orders","m4:"+o._id),y:o.count,color:r.getColor("m4s",o._id)}),e.maxM4s=Math.max(e.maxM4s,o.count)})},parseDrms:function(o,n){n.maxDrms=0,n.drms=[],o.forEach(function(o){n.drms.push({name:o._id,y:o.count,color:r.getColor("drms",o._id)}),n.maxDrms=Math.max(n.maxDelayReasons,o.count)})},isEmpty:function(){return 0===this.attributes.clip.orderCount.length}})});