// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../time","../core/Model","../core/util/colorLabel"],function(n,r,t,s){"use strict";function e(n){return n.length>28?n.substr(0,13).trim()+"..."+n.substr(-10).trim():""}function a(n){var r=n+"\n\n";if(n.length<=4)return r;for(var t=0;t<o.length;++t){var s=o[t],e=n.split(s);if(2===e.length)return e.join("\n"+s);if(e.length>2)return r=e.pop(),1===r.length&&(r=e.pop()+s+r),e.join(s)+"\n"+s+r}return r}var o=["-","_","."],i=20,u=3;return t.extend({urlRoot:"/reports/9",defaults:function(){return{daysInMonth:{},shiftsInDay:{},hoursInShift:null,customLines:{},months:[],groups:[],cags:[],lines:[]}},parse:function(n){n.groups[null]={_id:null,name:"???",cags:[],color:"#FFFFFF"};var r={months:this.parseMonths(n),groups:this.parseGroups(n),cags:this.parseCags(n),lines:this.parseLines(n)};return r},parseMonths:function(t){var s=this.attributes;return n.map(t.months,function(n){var t=r.getMoment(n),e=t.format("YYMM");return{_id:n,key:t.format("YYMM"),label:t.format("MMMM YYYY"),days:s.daysInMonth[e]||s.daysInMonth.summary||i,shifts:s.shiftsInDay[e]||s.shiftsInDay.summary||u}})},parseCags:function(r){var t=this.attributes,s=t.daysInMonth.summary||i,a=t.shiftsInDay.summary||u;return n.map(r.cags,function(o){var i=t.customLines[o._id];return o.shortName=e(o.name),o.group=r.groups[o.group],o.customLines=i||null,o.maxOnLine=o.avgQPerShift*s*a,o.maxOnLines=o.maxOnLine*(i||o.lines),o.utilization=n.map(o.plan,function(n){var r=Math.round(n/o.maxOnLines*100);return isNaN(r)||!isFinite(r)?0:r}),o})},parseGroups:function(r){return n.map(r.groups,function(n){return n.color||(n.color="#FFFFFF"),n.contrast=s.requiresContrast(n.color),n})},parseLines:function(r){var t=[];return n.forEach(r.lines,function(n,r){t.push({_id:r,name:a(r),cags:n})}),t}})});