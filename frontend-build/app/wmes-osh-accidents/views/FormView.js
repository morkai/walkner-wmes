define(["underscore","app/user","app/time","app/viewport","app/wmes-osh-common/dictionaries","app/wmes-osh-common/views/FormView","../Accident","app/wmes-osh-accidents/templates/form"],function(t,e,s,n,a,i,o,r){"use strict";return i.extend({template:r,dialogClassName:"osh-entries-form-dialog",events:Object.assign({'change input[type="file"][data-max]':function(t){const e=t.currentTarget,s=+e.dataset.max;e.setCustomValidity(e.files.length>s?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:s}):"")}},i.prototype.events),getTemplateData:function(){return{today:s.getMoment().format("YYYY-MM-DD")}},serializeToForm:function(){const t=this.model.toJSON();if(t.eventDate){const e=s.utc.getMoment(t.eventDate);t.eventDate=e.format("YYYY-MM-DD"),t.eventTime=e.format("HH:mm")}else{const e=s.getMoment();t.eventDate=e.format("YYYY-MM-DD"),t.eventTime=e.format("HH:mm")}return delete t.coordinators,delete t.attachments,delete t.users,delete t.changes,t},serializeForm:function(t){const e=this.$id("workplace").select2("data");return t.division=e.model.get("division"),t.workplace=e.id,t.department=this.$id("department").select2("data").id,t.building=parseInt(this.$id("building").val(),10)||0,t.location=parseInt(this.$id("location").val(),10)||0,t.station=parseInt(this.$id("station").val(),10)||0,t.eventDate=s.utc.getMoment(`${t.eventDate} ${t.eventTime||"00:00"}:00`,"YYYY-MM-DD HH:mm:ss").toISOString(),delete t.eventTime,t},afterRender:function(){i.prototype.afterRender.apply(this,arguments),this.setUpDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(!1),this.setUpLocationSelect2(),this.setUpStationSelect2()},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){n.msg.saving();const t=i.prototype.request.apply(this,arguments);return t.always(()=>{n.msg.saved()}),t},submitRequest:function(t,e){const s=this,a=new FormData;let o=0;if(s.$('input[type="file"]').each(function(){const t=this.name.replace("attachments.","");for(let e=0;e<this.files.length;++e)a.append(t,this.files[e]),o+=1}),0===o)return i.prototype.submitRequest.call(s,t,e);n.msg.saving();const r=s.ajax({type:"POST",url:"/osh/attachments",data:a,processData:!1,contentType:!1});r.done(a=>{e.attachments={added:a},i.prototype.submitRequest.call(s,t,e),n.msg.saved()}),r.fail(()=>{n.msg.saved(),s.showErrorMessage(s.t("wmes-osh-common","FORM:ERROR:upload")),t.attr("disabled",!1)})},onDialogShown:function(){this.$id("subject").focus()}})});