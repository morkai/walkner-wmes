// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","moment","js2form","reltime","app/i18n","app/user","app/data/prodLines","app/core/View","app/core/util/fixTimeRange","app/prodLogEntries/templates/filter","select2"],function(e,t,i,r,a,n,l,s,o,d){return s.extend({template:d,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("prodLogEntryFilter")},destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();i(this.el.querySelector(".filter-form"),e),this.$id("prodLine").select2({width:"275px",allowClear:!n.getDivision(),data:this.getApplicableProdLines()}),this.$id("type").select2({width:"275px",allowClear:!0})},getApplicableProdLines:function(){return l.getForCurrentUser().map(function(e){return{id:e.id,text:e.getLabel()}})},serializeRqlQuery:function(){var e=this.model.rqlQuery,t={createdAt:"",prodLine:null,type:null,limit:e.limit<5?5:e.limit>100?100:e.limit};return e.selector.args.forEach(function(e){var i=e.args[0];switch(i){case"createdAt":o.toFormData(t,e,"date+time");break;case"prodLine":case"type":"eq"===e.name&&(t[i]=e.args[1])}}),t},changeFilter:function(){var e=this.model.rqlQuery,t=o.fromView(this,{defaultTime:"06:00"}),i=[],r=this.$id("prodLine").val(),a=this.$id("type").val();r&&r.length&&i.push({name:"eq",args:["prodLine",r]}),a&&a.length&&i.push({name:"eq",args:["type",a]}),t.from&&i.push({name:"ge",args:["createdAt",t.from]}),t.to&&i.push({name:"le",args:["createdAt",t.to]}),e.selector={name:"and",args:i},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)}})});