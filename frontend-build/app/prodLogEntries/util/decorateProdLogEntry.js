// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/data/aors","app/data/prodLines","app/data/downtimeReasons","app/data/views/renderOrgUnitPath","app/core/templates/userInfo"],function(e,r,a,t,o,d,i,n){"use strict";function s(r,t){var o=e.without(Object.keys(t),"_id");return"editOrder"===r&&(o=e.without(o,"mechOrder","orderData"),-1!==o.indexOf("orderId")&&(o=e.without(o,"operationNo"))),o.map(function(e){return a(p[r],"PROPERTY:"+e)}).join(", ")}var p={editShift:"prodShifts",editOrder:"prodShiftOrders",editDowntime:"prodDowntimes"};return function(e){var o=e.toJSON(),i=o.data,p="data:"+o.type,c={};switch(o.type){case"changeShift":c.date=r.format(i.startedProdShift.date,"L"),c.shift=a("core","SHIFT:"+i.startedProdShift.shift);break;case"addShift":c.date=r.format(i.date,"L"),c.shift=a("core","SHIFT:"+i.shift);break;case"changeMaster":case"changeLeader":case"changeOperator":c.name=i?i.label:"-";break;case"changeQuantitiesDone":c.hour=i.hour+1,c.value=i.newValue;break;case"changeOrder":case"correctOrder":case"addOrder":var h=i.orderData&&i.orderData.operations?i.orderData.operations[i.operationNo]:null;c.orderId=i.orderId,c.orderName=i.orderData.name||"?",c.operationNo=i.operationNo,c.operationName=h?h.name:"?";break;case"changeQuantityDone":case"changeWorkerCount":c.value=i.newValue;break;case"startDowntime":case"addDowntime":var f=d.get(i.reason),S=t.get(i.aor);c._id=i._id,c.reason=f?f.getLabel():i.reason,c.aor=S?S.getLabel():i.aor;break;case"editShift":case"editOrder":case"editDowntime":"editDowntime"===o.type&&(c._id=i._id),c.changedProperties=s(o.type,i);break;case"checkSpigot":p+=":"+(i["final"]?"final":"initial"),c.result=i.valid?"valid":"invalid",c.nc12=i.nc12,c.downtimeId=i.prodDowntime;break;case"checkSerialNumber":p+=i.error?":error":"",c.sn=i._id,c.error=i.error;break;case"setNextOrder":c.nextOrder=i.orderNo?i.orderNo+", "+i.operationNo:"-";break;default:c=i}var u=null;return o.savedAt&&(u=(Date.parse(o.savedAt)-Date.parse(o.createdAt))/1e3),o.data=a("prodLogEntries",p,c),o.type=a("prodLogEntries","type:"+o.type),o.createdAt=r.format(o.createdAt,"L, LTS"),o.creator=n({userInfo:o.creator}),u&&(o.createdAt+=" ("+(0>u?"-":"+")+r.toString(Math.abs(u),!1,!0)+")"),o.prodShift&&(o.prodShift='<a href="#prodShifts/'+o.prodShift._id+'">'+r.format(o.prodShift.date,"L")+", "+a("core","SHIFT:"+o.prodShift.shift)+"</a>"),o.prodShiftOrder?o.prodShiftOrder='<a href="#prodShiftOrders/'+o.prodShiftOrder._id+'">'+o.prodShiftOrder.orderId+", "+o.prodShiftOrder.operationNo+"</a>":o.prodShiftOrder=a("prodLogEntries","noData:prodShiftOrder"),o}});