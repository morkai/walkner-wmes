define(["underscore","app/time","app/i18n","app/data/aors","app/data/prodLines","app/data/downtimeReasons","app/orgUnits/util/renderOrgUnitPath","app/core/templates/userInfo"],function(e,r,a,t,o,d,i,n){"use strict";var s={editShift:"prodShifts",editOrder:"prodShiftOrders",editDowntime:"prodDowntimes"};return function(o){var i,p,c,h=o.toJSON(),f=h.data,u="data:"+h.type,l={};switch(h.type){case"changeShift":l.date=r.format(f.startedProdShift.date,"L"),l.shift=a("core","SHIFT:"+f.startedProdShift.shift);break;case"addShift":l.date=r.format(f.date,"L"),l.shift=a("core","SHIFT:"+f.shift);break;case"changeMaster":case"changeLeader":case"changeOperator":l.name=f?f.label:"-";break;case"changeOperators":l.names=(f&&f.personnel.length?f.personnel:[]).filter(function(e){return!!e.label}).map(function(e){return"<em>"+e.label+"</em>"}).join(", ");break;case"changeQuantitiesDone":l.hour=f.hour+1,l.value=f.newValue;break;case"changeOrder":case"correctOrder":case"addOrder":var m=f.orderData&&f.orderData.operations?f.orderData.operations[f.operationNo]:null;l.orderId=f.orderId,l.orderName=f.orderData.name||"?",l.operationNo=f.operationNo,l.operationName=m?m.name:"?";break;case"changeQuantityDone":case"changeWorkerCount":l.value=f.newValue;break;case"startDowntime":case"addDowntime":var S=d.get(f.reason),O=t.get(f.aor);l._id=f._id,l.reason=S?S.getLabel():f.reason,l.aor=O?O.getLabel():f.aor;break;case"editShift":case"editOrder":case"editDowntime":"editDowntime"===h.type&&(l._id=f._id),l.changedProperties=(i=h.type,p=f,c=e.without(Object.keys(p),"_id"),"editOrder"===i&&-1!==(c=e.without(c,"mechOrder","orderData")).indexOf("orderId")&&(c=e.without(c,"operationNo")),c.map(function(e){return a(s[i],"PROPERTY:"+e)}).join(", "));break;case"checkSpigot":u+=":"+(f.final?"final":"initial"),l.result=f.valid?"valid":"invalid",l.nc12=f.nc12,l.downtimeId=f.prodDowntime;break;case"checkSerialNumber":u+=f.error?":error":"",l.sn=f._id,l.error=f.error;break;case"setNextOrder":e.isEmpty(f.orderNo)&&e.isEmpty(f.orders)?l.queue="-":Array.isArray(f.orders)?l.queue=f.orders.map(function(e){return e.orderNo}).join(", "):l.queue=f.orderNo;break;default:l=f}var g=null;return h.savedAt&&(g=(Date.parse(h.savedAt)-Date.parse(h.createdAt))/1e3),h.data=a("prodLogEntries",u,l),h.type=a("prodLogEntries","type:"+h.type),h.createdAt=r.format(h.createdAt,"L, LTS"),h.creator=n({userInfo:h.creator}),g&&(h.createdAt+=" ("+(g<0?"-":"+")+r.toString(Math.abs(g),!1,!0)+")"),h.prodShift&&(h.prodShift='<a href="#prodShifts/'+h.prodShift._id+'">'+r.format(h.prodShift.date,"L")+", "+a("core","SHIFT:"+h.prodShift.shift)+"</a>"),h.prodShiftOrder?h.prodShiftOrder='<a href="#prodShiftOrders/'+h.prodShiftOrder._id+'">'+h.prodShiftOrder.orderId+", "+h.prodShiftOrder.operationNo+"</a>":h.prodShiftOrder=a("prodLogEntries","noData:prodShiftOrder"),h}});