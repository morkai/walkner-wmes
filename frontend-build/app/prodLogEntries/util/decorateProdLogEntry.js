define(["underscore","app/time","app/i18n","app/data/aors","app/data/prodLines","app/data/downtimeReasons","app/orgUnits/util/renderOrgUnitPath","app/core/templates/userInfo"],function(e,r,a,t,o,d,i,n){"use strict";var s={editShift:"prodShifts",editOrder:"prodShiftOrders",editDowntime:"prodDowntimes"};return function(o){var i,p,c,h=o.toJSON(),f=h.data,u="data:"+h.type,S={};switch(h.type){case"changeShift":S.date=r.format(f.startedProdShift.date,"L"),S.shift=a("core","SHIFT:"+f.startedProdShift.shift);break;case"addShift":S.date=r.format(f.date,"L"),S.shift=a("core","SHIFT:"+f.shift);break;case"changeMaster":case"changeLeader":case"changeOperator":S.name=f?f.label:"-";break;case"changeQuantitiesDone":S.hour=f.hour+1,S.value=f.newValue;break;case"changeOrder":case"correctOrder":case"addOrder":var m=f.orderData&&f.orderData.operations?f.orderData.operations[f.operationNo]:null;S.orderId=f.orderId,S.orderName=f.orderData.name||"?",S.operationNo=f.operationNo,S.operationName=m?m.name:"?";break;case"changeQuantityDone":case"changeWorkerCount":S.value=f.newValue;break;case"startDowntime":case"addDowntime":var l=d.get(f.reason),O=t.get(f.aor);S._id=f._id,S.reason=l?l.getLabel():f.reason,S.aor=O?O.getLabel():f.aor;break;case"editShift":case"editOrder":case"editDowntime":"editDowntime"===h.type&&(S._id=f._id),S.changedProperties=(i=h.type,p=f,c=e.without(Object.keys(p),"_id"),"editOrder"===i&&-1!==(c=e.without(c,"mechOrder","orderData")).indexOf("orderId")&&(c=e.without(c,"operationNo")),c.map(function(e){return a(s[i],"PROPERTY:"+e)}).join(", "));break;case"checkSpigot":u+=":"+(f.final?"final":"initial"),S.result=f.valid?"valid":"invalid",S.nc12=f.nc12,S.downtimeId=f.prodDowntime;break;case"checkSerialNumber":u+=f.error?":error":"",S.sn=f._id,S.error=f.error;break;case"setNextOrder":e.isEmpty(f.orderNo)&&e.isEmpty(f.orders)?S.queue="-":Array.isArray(f.orders)?S.queue=f.orders.map(function(e){return e.orderNo}).join(", "):S.queue=f.orderNo;break;default:S=f}var g=null;return h.savedAt&&(g=(Date.parse(h.savedAt)-Date.parse(h.createdAt))/1e3),h.data=a("prodLogEntries",u,S),h.type=a("prodLogEntries","type:"+h.type),h.createdAt=r.format(h.createdAt,"L, LTS"),h.creator=n({userInfo:h.creator}),g&&(h.createdAt+=" ("+(g<0?"-":"+")+r.toString(Math.abs(g),!1,!0)+")"),h.prodShift&&(h.prodShift='<a href="#prodShifts/'+h.prodShift._id+'">'+r.format(h.prodShift.date,"L")+", "+a("core","SHIFT:"+h.prodShift.shift)+"</a>"),h.prodShiftOrder?h.prodShiftOrder='<a href="#prodShiftOrders/'+h.prodShiftOrder._id+'">'+h.prodShiftOrder.orderId+", "+h.prodShiftOrder.operationNo+"</a>":h.prodShiftOrder=a("prodLogEntries","noData:prodShiftOrder"),h}});