// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/i18n","app/data/aors","app/data/prodLines","app/data/downtimeReasons","app/data/views/renderOrgUnitPath","app/core/templates/userInfo"],function(a,e,t,r,d,o,i,n){"use strict";function s(e,r){var d=a.without(Object.keys(r),"_id");return"editOrder"===e&&(d=a.without(d,"mechOrder","orderData"),d.indexOf("orderId")!==-1&&(d=a.without(d,"operationNo"))),d.map(function(a){return t(p[e],"PROPERTY:"+a)}).join(", ")}var p={editShift:"prodShifts",editOrder:"prodShiftOrders",editDowntime:"prodDowntimes"};return function(a){var d=a.toJSON(),i="data:"+d.type,p={};switch(d.type){case"changeShift":p.date=e.format(d.data.startedProdShift.date,"YYYY-MM-DD"),p.shift=t("core","SHIFT:"+d.data.startedProdShift.shift);break;case"addShift":p.date=e.format(d.data.date,"YYYY-MM-DD"),p.shift=t("core","SHIFT:"+d.data.shift);break;case"changeMaster":case"changeLeader":case"changeOperator":p.name=d.data?d.data.label:"-";break;case"changeQuantitiesDone":p.hour=d.data.hour+1,p.value=d.data.newValue;break;case"changeOrder":case"correctOrder":case"addOrder":var c=d.data.orderData&&d.data.orderData.operations?d.data.orderData.operations[d.data.operationNo]:null;p.orderId=d.data.orderId,p.orderName=d.data.orderData.name||"?",p.operationNo=d.data.operationNo,p.operationName=c?c.name:"?";break;case"changeQuantityDone":case"changeWorkerCount":p.value=d.data.newValue;break;case"startDowntime":case"addDowntime":var h=o.get(d.data.reason),f=r.get(d.data.aor);p._id=d.data._id,p.reason=h?h.getLabel():d.data.reason,p.aor=f?f.getLabel():d.data.aor;break;case"editShift":case"editOrder":case"editDowntime":"editDowntime"===d.type&&(p._id=d.data._id),p.changedProperties=s(d.type,d.data);break;case"checkSpigot":i+=":"+(d.data.final?"final":"initial"),p.result=d.data.valid?"valid":"invalid",p.nc12=d.data.nc12,p.downtimeId=d.data.prodDowntime;break;default:p=d.data}var u=null;return d.savedAt&&(u=(Date.parse(d.savedAt)-Date.parse(d.createdAt))/1e3),d.data=t("prodLogEntries",i,p),d.type=t("prodLogEntries","type:"+d.type),d.createdAt=e.format(d.createdAt,"YYYY-MM-DD HH:mm:ss"),d.creator=n({userInfo:d.creator}),u&&(d.createdAt+=" ("+(u<0?"-":"+")+e.toString(Math.abs(u),!1,!0)+")"),d.prodShift&&(d.prodShift='<a href="#prodShifts/'+d.prodShift._id+'">'+e.format(d.prodShift.date,"YYYY-MM-DD")+", "+t("core","SHIFT:"+d.prodShift.shift)+"</a>"),d.prodShiftOrder?d.prodShiftOrder='<a href="#prodShiftOrders/'+d.prodShiftOrder._id+'">'+d.prodShiftOrder.orderId+", "+d.prodShiftOrder.operationNo+"</a>":d.prodShiftOrder=t("prodLogEntries","noData:prodShiftOrder"),d}});