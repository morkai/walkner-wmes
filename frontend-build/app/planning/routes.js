define(["jquery","../broker","../router","../viewport","../user","../time"],function(n,a,e,t,r,i){"use strict";var p=["css!app/planning/assets/main","css!app/paintShop/assets/main"],l=["i18n!app/nls/planning","i18n!app/nls/paintShop"],s=r.auth("EMBEDDED","PLANNING:VIEW"),o=r.auth("PLANNING:MANAGE"),u=r.auth("WH:VIEW");e.map("/planning/settings/:id",o,function(n){t.loadPage(["app/planning/PlanSettings","app/planning/pages/PlanSettingsPage",p[0],l[0]],function(a,e){return new e({model:new a({_id:n.params.id}),back:"1"===n.query.back})})}),e.map("/planning/changes",s,function(n){t.loadPage(["app/planning/PlanChangesCollection","app/planning/pages/PlanChangesPage",p[0],l[0]],function(a,e){return new e({collection:new a(null,{rqlQuery:n.rql,paginate:!1})})})}),e.map("/planning/plans",s,function(n){t.loadPage(["app/planning/PlanStatsCollection","app/planning/pages/PlanListPage"].concat(p,l),function(a,e){return new e({collection:a.fromQuery(n.query)})})}),e.map("/planning/plans/:id",s,function(n){/^-?[0-9]+d$/.test(n.params.id)&&(n.params.id=i.getMoment().subtract(i.getMoment().hours()<6?1:0,"days").startOf("day").add(+n.params.id.replace("d",""),"days").format("YYYY-MM-DD"),a.publish("router.navigate",{url:"/planning/plans/"+n.params.id,replace:!0,trigger:!1})),t.loadPage(["app/planning/pages/PlanPage"].concat(p,l),function(a){return new a({date:n.params.id,mrps:void 0===n.query.mrps?null:n.query.mrps.split(/[^A-Z0-9]+/i).filter(function(n){return n.length>0}),division:n.query.division||null,order:n.query.order})})}),e.map("/planning/wh/:id",u,function(n){/^-?[0-9]+d$/.test(n.params.id)&&(n.params.id=i.getMoment().subtract(i.getMoment().hours()<6?1:0,"days").startOf("day").add(+n.params.id.replace("d",""),"days").format("YYYY-MM-DD"),a.publish("router.navigate",{url:"/planning/wh/"+n.params.id,replace:!0,trigger:!1}));var e={date:n.params.id,mrps:void 0===n.query.mrps?null:n.query.mrps.split(/[^A-Z0-9]+/i).filter(function(n){return n.length>0}),from:void 0===n.query.from?"06:00":n.query.from,to:void 0===n.query.to?"06:00":n.query.to};["lines","whStatuses","psStatuses"].forEach(function(a){e[a]=void 0===n.query[a]?null:n.query[a].split(",").filter(function(n){return n.length>0})}),t.loadPage(["app/planning/pages/WhPage"].concat(p,l),function(n){return new n(e)})}),e.map("/planning/settings",o,function(n){t.loadPage(["app/planning/pages/PlanningSettingsPage",p[0],l[0]],function(a){return new a({initialTab:n.query.tab})})}),e.map("/planning;jump-to-order",s,function(e){t.msg.loading();var r=e.query.order,p=n.ajax({url:"/orders/"+r+"?select(mrp,scheduledStartDate)"});p.fail(function(){t.msg.loaded(),a.publish("viewport.page.loadingFailed",{page:null,xhr:p})}),p.done(function(n){t.msg.loaded();var e=i.getMoment(n.scheduledStartDate).format("YYYY-MM-DD");a.publish("router.navigate",{url:"/planning/plans/"+e+"?mrps="+n.mrp+"&order="+r,trigger:!0,replace:!0})})})});