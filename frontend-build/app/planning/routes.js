// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../broker","../router","../viewport","../user","../time","./Plan","./PlanSettings","./PlanSettingsCollection","./PlanChangesCollection","./pages/PlanPage","./pages/PlanListPage","./pages/PlanSettingsPage","./pages/PlanChangesPage","i18n!app/nls/planning"],function(n,a,e,t,i,l,r,s,g,p,o,u,d){"use strict";function c(){var n=e.currentLayout.getView(".navbar");n&&n.$id("planning-2d").toggleClass("disabled",i.getMoment().hours()<17),setTimeout(c,6e4)}var m=t.auth("PLANNING:VIEW"),P=t.auth("PLANNING:MANAGE");a.map("/planning/settings/:id",P,function(n){e.showPage(new u({model:new r({_id:n.params.id}),back:"1"===n.query.back}))}),a.map("/planning/changes",m,function(n){e.showPage(new d({collection:new g(null,{rqlQuery:n.rql,paginate:!1})}))}),a.map("/planning/plans",m,function(n){e.showPage(new o({collection:new s(null,{rqlQuery:n.rql,paginate:!1})}))}),a.map("/planning/plans/:id",m,function(a){/^[0-9]+d$/.test(a.params.id)&&(a.params.id=i.getMoment().subtract(i.getMoment().hours()<6?1:0,"days").startOf("day").add(a.params.id.replace("d",""),"days").format("YYYY-MM-DD"),n.publish("router.navigate",{url:"/planning/plans/"+a.params.id,replace:!0,trigger:!1})),e.showPage(new p({date:a.params.id,mrps:void 0===a.query.mrps?null:a.query.mrps.split(/[^A-Z0-9]+/).filter(function(n){return n.length>0})}))}),e.once("afterRender",c)});