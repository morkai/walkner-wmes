// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../core/Model","../data/orgUnits","./PlanOrderCollection","./PlanLineCollection","./util/shift"],function(t,e,n,i,r){"use strict";return t.extend({initialize:function(){var t=e.getByTypeAndId("mrpController",this.id);this.attributes.description=t?t.get("description"):"",this.orders=new n(null,{paginate:!1}),this.lines=new i(null,{paginate:!1}),this.attributes.orders&&(this.orders.reset(this.attributes.orders),delete this.attributes.orders),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines),Object.defineProperty(this,"plan",{get:function(){return this.collection?this.collection.plan:null}}),Object.defineProperty(this,"settings",{get:function(){return this.plan.settings.mrps.get(this.id)}})},getStats:function(){var t=this.orders,e=this.plan,n={manHours:{todo:0,late:0,plan:0,remaining:0},quantity:{todo:0,late:0,plan:0,remaining:0},execution:{plan:0,done:0,percent:0}};return this.lines.forEach(function(t){(t.get("shiftData")||[]).forEach(function(t){n.manHours.plan+=t.manHours,n.quantity.plan+=t.quantity}),t.orders.forEach(function(i){var o=Date.parse(i.get("startAt")),a=r.getShiftNo(o),s=e.shiftOrders.getTotalQuantityDone(t.id,a,i.get("orderNo")),u=i.get("quantity");n.execution.plan+=1,n.execution.done+=s>=u?1:0})}),n.execution.percent=n.execution.plan?Math.round(n.execution.done/n.execution.plan*100):100,e&&(t.forEach(function(t){var i=e.sapOrders.get(t.id);if(i){var r=i.get("quantityTodo")-i.getQuantityDone();n.manHours.todo+=t.get("manHours"),n.quantity.todo+=t.getQuantityTodo(),n.manHours.remaining+=t.getManHours(r),n.quantity.remaining+=r}}),e.lateOrders.mrp(this.id).forEach(function(e){t.get(e.id)||(n.manHours.late+=e.get("manHours"),n.quantity.late+=e.getQuantityTodo())})),n}})});