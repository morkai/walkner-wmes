define(["underscore","jquery","app/time","app/user","app/socket","app/core/Model","app/data/orgUnits","./util/shift","./changeHandlers","./PlanOrderCollection","./PlanLineCollection","./PlanMrpCollection","./PlanShiftOrderCollection","./PlanSapOrderCollection","./PlanLateOrderCollection","./PlanWorkingLineCollection"],function(t,e,i,n,s,r,a,o,l,u,d,h,c,p,f,g){"use strict";return r.extend({urlRoot:"/planning/plans",clientUrlRoot:"#planning/plans",topicPrefix:"planning.plans",privilegePrefix:"PLANNING",nlsDomain:"planning",defaults:{active:!1,loading:!1},initialize:function(e,i){i=t.defaults({},i,{displayOptions:null,settings:null,whLines:null,sapOrders:null,minMaxDates:!1}),this.urlQuery="minMaxDates="+(i.minMaxDates?1:0)+"&activeMrps="+(i.activeMrps?1:0),this.displayOptions=i.displayOptions,this.settings=i.settings,this.whLines=i.whLines,this.workingLines=new g(null,{plan:this,paginate:!1}),this.shiftOrders=new c(null,{plan:this,paginate:!1}),this.lateOrders=new f(null,{plan:this,paginate:!1}),this.sapOrders=new p(null,{plan:this,paginate:!1}),this.orders=new u(null,{plan:this,paginate:!1}),this.lines=new d(null,{plan:this,paginate:!1}),this.mrps=new h(null,{plan:this,paginate:!1}),this.lines.on("reset",function(){this.mrps.reset()},this),this.attributes.orders&&(this.orders.reset(this.attributes.orders),delete this.attributes.orders),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines)},url:function(){return this.urlRoot+"/"+this.id+"?"+this.urlQuery},parse:function(e){var n={};e._id&&(n._id=i.utc.format(e._id,"YYYY-MM-DD")),e.createdAt&&(n.createdAt=new Date(e.createdAt)),e.updatedAt&&(n.updatedAt=new Date(e.updatedAt)),n.active=o.isActive(n._id||this.id);var s=t.pick(e,["minDate","maxDate","activeMrps"]);return t.isEmpty(s)||this.displayOptions.set(s),e.orders&&this.orders.reset(e.orders),e.lines&&this.lines.reset(e.lines),n},getLabel:function(){return i.utc.format(this.id,"L")},getMoment:function(){return i.utc.getMoment(this.id,"YYYY-MM-DD")},getActualOrderData:function(t){var e;return this.displayOptions.isLatestOrderDataUsed()&&(e=this.sapOrders.get(t)),e||(e=this.orders.get(t)),e?e.getActualOrderData():{quantityTodo:-1,quantityDone:-1,statuses:[],etoCont:!1}},isAnythingLoading:function(){return this.get("loading")},isProdStateUsed:function(){return this.isActive()&&this.displayOptions.isLatestOrderDataUsed()},isActive:function(){return!0===this.attributes.active},isFrozen:function(){return!0===this.attributes.frozen},isEditable:function(){return"development"===window.ENV&&n.isAllowedTo("SUPER")||!this.isFrozen()&&this.settings.isEditable()},canEditSettings:function(){return this.isEditable()&&n.isAllowedTo("PLANNING:MANAGE","PLANNING:PLANNER")},canCommentOrders:function(){return n.can.commentOrders()},canLockMrps:function(){return this.canEditSettings()},canFreezeOrders:function(){return!("development"!==window.ENV||!n.isAllowedTo("SUPER"))||!!this.canEditSettings()&&(Date.now()>=i.getMoment(this.id,"YYYY-MM-DD").add(23,"hours").valueOf()||this.lines.some(function(t){return t.getFrozenOrderCount()>0}))},canChangeDropZone:function(){return!1},canChangeWhDropZone:function(){return!1},canChangeWhStatus:function(){return n.isAllowedTo("PLANNING:WHMAN")},canAddLateOrders:function(){return this.isEditable()&&n.isAllowedTo("PLANNING:PLANNER","PLANNING:MANAGE")},applyChange:function(t){var e=this;i.utc.format(t.plan,"YYYY-MM-DD")===e.id&&(e.set("updatedAt",new Date(t.date)),Object.keys(t.data).forEach(function(i){l[i]&&l[i](e,t.data[i])}))},getOrderList:function(e,i){var n=[];return this.mrps.forEach(function(s){if(e[s.id]){var r={};s.lines.forEach(function(t){t.orders.forEach(function(t){var e=t.get("orderNo");if(s.orders.get(e)){var i=r[e];i||(i=r[e]={orderNo:e,shiftNo:Number.MAX_VALUE,startTime:Number.MAX_VALUE});var n=t.getShiftNo();n<i.shiftNo&&(i.shiftNo=n);var a=Date.parse(t.get("startAt"));a<i.startTime&&(i.startTime=a)}})}),t.values(r).sort(function(t,e){return t.startTime-e.startTime}).forEach(function(t){i&&t.shiftNo!==i||n.push(t.orderNo)})}}),n}},{applySettingsChanges:function(t,e){e.length&&l.settings(new this(null,{settings:t}),e)}})});