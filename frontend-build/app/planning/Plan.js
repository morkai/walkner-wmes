// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../user","../core/Model","./changeHandlers","./PlanOrderCollection","./PlanLineCollection","./PlanMrpCollection","./PlanSapOrderCollection","./PlanLateOrderCollection"],function(t,e,i,s,n,a,r,l,d,o){"use strict";return s.extend({urlRoot:"/planning/plans",clientUrlRoot:"#planning/plans",topicPrefix:"planning.plans",privilegePrefix:"PLANNING",nlsDomain:"planning",defaults:{loading:!1},initialize:function(e,i){i=t.defaults({},i,{displayOptions:null,settings:null,sapOrders:null,minMaxDates:!1,pceTimes:!1}),this.urlQuery="minMaxDates="+(i.minMaxDates?1:0)+"&pceTimes="+(i.pceTimes?1:0),this.displayOptions=i.displayOptions,this.settings=i.settings,this.lateOrders=new o(null,{plan:this,paginate:!1}),this.sapOrders=new d(null,{plan:this,paginate:!1}),this.orders=new a(null,{plan:this,paginate:!1}),this.lines=new r(null,{plan:this,paginate:!1}),this.mrps=new l(null,{plan:this,paginate:!1}),this.lines.on("reset",function(){this.mrps.reset()},this),this.attributes.orders&&(this.orders.reset(this.attributes.orders),delete this.attributes.orders),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines)},url:function(){return this.urlRoot+"/"+this.id+"?"+this.urlQuery},parse:function(i){var s={};return i._id&&(s._id=e.utc.format(i._id,"YYYY-MM-DD")),i.createdAt&&(s.createdAt=new Date(i.createdAt)),i.updatedAt&&(s.updatedAt=new Date(i.updatedAt)),(i.minDate||i.maxDate)&&this.displayOptions.set(t.pick(i,["minDate","maxDate"])),i.orders&&this.orders.reset(i.orders),i.lines&&this.lines.reset(i.lines),s},getLabel:function(){return e.utc.format(this.id,"LL")},getActualOrderData:function(t){return this.displayOptions.isLatestOrderDataUsed()?(this.sapOrders.get(t)||this.orders.get(t)).getActualOrderData():this.orders.get(t).getActualOrderData()},isFrozen:function(){return this.attributes.frozen===!0},isEditable:function(){return!this.isFrozen()&&this.settings.isEditable()},canEditSettings:function(){return this.isEditable()&&i.isAllowedTo("PLANNING:MANAGE","PLANNING:PLANNER")},applyChange:function(t){var i=this;e.utc.format(t.plan,"YYYY-MM-DD")===i.id&&(i.set("updatedAt",new Date(t.date)),Object.keys(t.data).forEach(function(e){n[e]&&n[e](i,t.data[e])}))}},{applySettingsChanges:function(t,e){e.length&&n.settings(new this(null,{settings:t}),e)}})});