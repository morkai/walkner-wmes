// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../user","../socket","../core/Model","../data/orgUnits","./util/shift","./changeHandlers","./PlanOrderCollection","./PlanLineCollection","./PlanMrpCollection","./PlanSapOrderCollection","./PlanLateOrderCollection"],function(t,e,n,i,r,s,a,l,o,u,d,c,h,p){"use strict";return s.extend({urlRoot:"/planning/plans",clientUrlRoot:"#planning/plans",topicPrefix:"planning.plans",privilegePrefix:"PLANNING",nlsDomain:"planning",defaults:{loading:!1},initialize:function(e,n){n=t.defaults({},n,{displayOptions:null,settings:null,sapOrders:null,minMaxDates:!1,pceTimes:!1}),this.urlQuery="minMaxDates="+(n.minMaxDates?1:0)+"&pceTimes="+(n.pceTimes?1:0),this.displayOptions=n.displayOptions,this.settings=n.settings,this.lateOrders=new p(null,{plan:this,paginate:!1}),this.sapOrders=new h(null,{plan:this,paginate:!1}),this.orders=new u(null,{plan:this,paginate:!1}),this.lines=new d(null,{plan:this,paginate:!1}),this.mrps=new c(null,{plan:this,paginate:!1}),this.lines.on("reset",function(){this.mrps.reset()},this),this.attributes.orders&&(this.orders.reset(this.attributes.orders),delete this.attributes.orders),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines)},url:function(){return this.urlRoot+"/"+this.id+"?"+this.urlQuery},parse:function(e){var i={};return e._id&&(i._id=n.utc.format(e._id,"YYYY-MM-DD")),e.createdAt&&(i.createdAt=new Date(e.createdAt)),e.updatedAt&&(i.updatedAt=new Date(e.updatedAt)),(e.minDate||e.maxDate)&&this.displayOptions.set(t.pick(e,["minDate","maxDate"])),e.orders&&this.orders.reset(e.orders),e.lines&&this.lines.reset(e.lines),i},getLabel:function(){return n.utc.format(this.id,"LL")},getActualOrderData:function(t){return this.displayOptions.isLatestOrderDataUsed()?(this.sapOrders.get(t)||this.orders.get(t)).getActualOrderData():this.orders.get(t).getActualOrderData()},isAnythingLoading:function(){return this.get("loading")||!!this.lateOrders.currentRequest||!!this.sapOrders.currentRequest},isFrozen:function(){return this.attributes.frozen===!0},isEditable:function(){return!this.isFrozen()&&this.settings.isEditable()},canEditSettings:function(){return this.isEditable()&&i.isAllowedTo("PLANNING:MANAGE","PLANNING:PLANNER")},applyChange:function(t){var e=this;n.utc.format(t.plan,"YYYY-MM-DD")===e.id&&(e.set("updatedAt",new Date(t.date)),Object.keys(t.data).forEach(function(n){o[n]&&o[n](e,t.data[n])}))},setHourlyPlans:function(i){var r=this,s={};r.lines.forEach(function(t){if(!i||i(t)){var e=a.getByTypeAndId("prodLine",t.id);if(e){var n=a.getAllForProdLine(e),r=n.division,o=n.prodFlow;if(r&&o){var u=s[r];u||(u=s[r]={});var d=u[o];d||(d=u[o]=l.EMPTY_HOURLY_PLAN.slice()),t.get("hourlyPlan").forEach(function(t,e){d[e]+=t})}}}});var o=n.getMoment(r.id,"YYYY-MM-DD").toISOString(),u=1,d=[];return t.forEach(s,function(t,e){d.push(r.setHourlyPlan(e,o,u,t))}),e.when.apply(e,d)},setHourlyPlan:function(t,n,i,s){var a=e.Deferred(),l={division:t,date:n,shift:i};return r.emit("hourlyPlans.findOrCreate",l,function(t,n){if(t)return a.reject(t);var i=e.ajax({url:"/hourlyPlans/"+n});i.fail(function(){a.reject(new Error("FIND_HOURLY_PLAN_FAILURE"))}),i.done(function(t){var i=[];t.flows.forEach(function(t,o){var u=s[t.id];if(u){var d=e.Deferred();l={type:"counts",socketId:r.getId(),_id:n,flowIndex:o,newValues:u},r.emit("hourlyPlans.updateCounts",l,function(t){t?d.reject(t):a.resolve()}),i.push(d.promise())}}),e.when.apply(e,i).then(function(){a.resolve()},function(t){a.reject(t)})})}),a.promise()},getOrderList:function(t,e){var n={};return this.lines.forEach(function(i){t&&!t(i)||i.orders.forEach(function(t){e&&t.getShiftNo()!==e||(n[t.get("orderNo")]=!0)})}),Object.keys(n)}},{applySettingsChanges:function(t,e){e.length&&o.settings(new this(null,{settings:t}),e)}})});