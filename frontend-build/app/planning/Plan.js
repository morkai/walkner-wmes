// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../core/Model","../core/Collection","../data/orgUnits","./PlanOrder","./PlanOrderCollection","./PlanLineCollection","./PlanMrpCollection","./PlanSapOrderCollection"],function(e,t,r,i,s,n,a,o,d,l){"use strict";var p={change:function(e,t){e.settings.set(t.property,t.newValue)},"lines:add":function(e,t,r){var i=t.line._id,s=e.settings.lines.add(t.line).get(i),n=e.lines.add({_id:s.id}).get(i);r.lines[i]=!0,s.get("mrpPriority").forEach(function(t){var i=e.mrps.get(t);i&&i.lines.add(n),r.mrps[t]=!0})},"lines:remove":function(e,t,r){var i=t.line._id,s=e.settings.lines.get(i),n=e.lines.get(i);s&&(e.settings.lines.remove(s),r.lines[i]=!0,s.get("mrpPriority").forEach(function(t){n&&e.mrps.get(t).lines.remove(n),r.mrps[t]=!0}))},"lines:change":function(e,t,r){var i=e.settings.lines.get(t.line);i&&("mrpPriority"===t.property&&i.get("mrpPriority").forEach(function(e){r.mrps[e]=!0}),i.set(t.property,t.newValue),i.get("mrpPriority").forEach(function(e){r.mrps[e]=!0}),r.lines[i.id]=!0)},"mrps:add":function(e,t,r){var i=e.settings.mrps.add(t.mrp).get(t.mrp._id);r.mrps[i.id]=!0,i.lines.forEach(function(e){r.lines[e.id]=!0})},"mrps:remove":function(e,t,r){var i=t.mrp._id,s=e.settings.mrps.get(i);s&&(e.settings.mrps.remove(s),r.mrps[i]=!0,s.lines.forEach(function(e){r.lines[e.id]=!0}))},"mrps:change":function(e,t,r){var i=e.settings.mrps.get(t.mrp);i&&(i.set(t.property,t.newValue),r.mrps[i.id]=!0,i.lines.forEach(function(e){r.lines[e.id]=!0}))},"mrpLines:add":function(e,t,r){var i=e.settings.mrps.get(t.mrp);i&&(i.lines.add(t.line),r.mrps[i.id]=!0,r.lines[t.line._id]=!0)},"mrpLines:remove":function(e,t,r){var i=e.settings.mrps.get(t.mrp);i&&(i.lines.remove(t.line._id),r.mrps[i.id]=!0,r.lines[t.line._id]=!0)},"mrpLines:change":function(e,t,r){var i=e.settings.mrps.get(t.mrp);if(i){var s=i.lines.get(t.line);s&&(s.set(t.property,t.newValue),r.mrps[i.id]=!0,r.lines[s.id]=!0)}}},c={settings:function(e,t){var r={reset:!1,lines:{},mrps:{}};t.forEach(function(t){r.reset=r.reset||/add|remove/.test(t.type),p[t.type](e,t,r)}),r.lines.any=Object.keys(r.lines).length>0,r.mrps.any=Object.keys(r.mrps).length>0,e.settings.trigger("changed",r)},addedOrders:function(e,t){var r=[],i={};t.forEach(function(e){var t=new n(e);r.push(t),i[e.mrp]||(i[e.mrp]=[]),i[e.mrp].push(t)}),e.orders.add(r),e.orders.trigger("added",r),Object.keys(i).forEach(function(t){var r=e.mrps.get(t);r.orders.add(i[t]),r.orders.trigger("added",i[t])})},removedOrders:function(e,t){var r=[],i={};t.forEach(function(t){var s=e.orders.get(t._id);if(s){r.push(s);var n=s.get("mrp");i[n]||(i[n]=[]),i[n].push(s)}}),Object.keys(i).forEach(function(t){var r=e.mrps.get(t);r&&(r.orders.remove(i[r.id]),r.orders.trigger("removed",i[r.id]))}),e.orders.remove(r),e.orders.trigger("removed",r)},changedOrders:function(e,t){var r=[],i={},s={};t.forEach(function(t){var n=e.orders.get(t._id);if(n){r.push(n);var a=e.mrps.get(n.get("mrp")),o=(t.changes.mrp?e.mrps.get(t.changes.mrp[1]):null)||a;a.id!==o.id&&(s[a.id]||(s[a.id]=[]),s[a.id].push(n),a.orders.remove(n)),i[o.id]||(i[o.id]=[]),i[o.id].push(n);var d={};Object.keys(t.changes).forEach(function(e){d[e]=t.changes[e][1]}),n.set(d)}}),Object.keys(s).forEach(function(t){e.mrps.get(t).trigger("removed",s[t])}),e.orders.trigger("changed",r),Object.keys(i).forEach(function(t){e.mrps.get(t).orders.trigger("changed",i[t])})},changedLines:function(t,r){var i=[],s={};r.forEach(function(r){var n=t.lines.get(r._id);n.get("version")>=r.version||(n.set(e.omit(r,"orders")),r.orders&&n.orders.reset(r.orders),i.push(n),n.settings&&n.settings.get("mrpPriority").forEach(function(e){s[e]||(s[e]=[]),s[e].push(n)}))}),t.lines.trigger("changed",i),Object.keys(s).forEach(function(e){t.mrps.get(e).lines.trigger("changed",s[e])})}};return r.extend({urlRoot:"/planning/plans",clientUrlRoot:"#planning/plans",topicPrefix:"planning.plans",privilegePrefix:"PLANNING",nlsDomain:"planning",defaults:{loading:!1},initialize:function(t,r){r=e.defaults({},r,{displayOptions:null,settings:null,sapOrders:null,minMaxDates:!1,pceTimes:!1}),this.urlQuery="minMaxDates="+(r.minMaxDates?1:0)+"&pceTimes="+(r.pceTimes?1:0),this.displayOptions=r.displayOptions,this.settings=r.settings,this.sapOrders=new l(null,{plan:this,paginate:!1}),this.orders=new a(null,{plan:this,paginate:!1}),this.lines=new o(null,{plan:this,paginate:!1}),this.mrps=new d(null,{plan:this,paginate:!1}),this.lines.on("reset",function(){this.mrps.reset()},this),this.attributes.orders&&(this.orders.reset(this.attributes.orders),delete this.attributes.orders),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines)},url:function(){return this.urlRoot+"/"+this.id+"?"+this.urlQuery},parse:function(r){var i={};return r._id&&(i._id=t.utc.format(r._id,"YYYY-MM-DD")),r.createdAt&&(i.createdAt=new Date(r.createdAt)),r.updatedAt&&(i.updatedAt=new Date(r.updatedAt)),(r.minDate||r.maxDate)&&this.displayOptions.set(e.pick(r,["minDate","maxDate"])),r.orders&&this.orders.reset(r.orders),r.lines&&this.lines.reset(r.lines),i},getLabel:function(){return t.utc.format(this.id,"LL")},getActualOrderData:function(e){return this.displayOptions.isLatestOrderDataUsed()?(this.sapOrders.get(e)||this.orders.get(e)).getActualOrderData():this.orders.get(e).getActualOrderData()},isFrozen:function(){return this.attributes.frozen===!0},isEditable:function(){return!this.isFrozen()&&this.settings.isEditable()},applyChange:function(e){var r=this;t.utc.format(e.plan,"YYYY-MM-DD")===r.id&&(r.set("updatedAt",new Date(e.date)),Object.keys(e.data).forEach(function(t){c[t]&&c[t](r,e.data[t])}))}},{applySettingsChanges:function(e,t){t.length&&c.settings(new this(null,{settings:e}),t)}})});