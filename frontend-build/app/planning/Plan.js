// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../core/Model","../core/Collection","../data/orgUnits","./PlanOrder","./PlanOrderCollection","./PlanLineCollection","./PlanMrpCollection"],function(e,t,r,i,n,s,a,o,d){"use strict";var l={change:function(e,t){e.settings.set(t.property,t.newValue)},"lines:add":function(e,t,r){var i=t.line._id,n=e.settings.lines.add(t.line).get(i),s=e.lines.add({_id:n.id}).get(i);r.lines[i]=!0,n.get("mrpPriority").forEach(function(t){var i=e.mrps.get(t);i&&i.lines.add(s),r.mrps[t]=!0})},"lines:remove":function(e,t,r){var i=t.line._id,n=e.settings.lines.get(i),s=e.lines.get(i);n&&s&&(e.settings.lines.remove(n),r.lines[i]=!0,n.get("mrpPriority").forEach(function(t){e.mrps.get(t).lines.remove(s),r.mrps[t]=!0}))},"lines:change":function(e,t,r){var i=e.settings.lines.get(t.line);i&&("mrpPriority"===t.property&&i.get("mrpPriority").forEach(function(e){r.mrps[e]=!0}),i.set(t.property,t.newValue),i.get("mrpPriority").forEach(function(e){r.mrps[e]=!0}),r.lines[i.id]=!0)},"mrps:add":function(e,t,r){var i=e.settings.mrps.add(t.mrp).get(t.mrp._id);r.mrps[i.id]=!0,i.lines.forEach(function(e){r.lines[e.id]=!0})},"mrps:remove":function(e,t,r){var i=t.mrp._id,n=e.settings.mrps.get(i);n&&(e.settings.mrps.remove(n),r.mrps[i]=!0,n.lines.forEach(function(e){r.lines[e.id]=!0}))},"mrps:change":function(e,t,r){var i=e.settings.mrps.get(t.mrp);i&&(i.set(t.property,t.newValue),r.mrps[i.id]=!0,i.lines.forEach(function(e){r.lines[e.id]=!0}))},"mrpLines:add":function(e,t,r){var i=e.settings.mrps.get(t.mrp);i&&(i.lines.add(t.line),r.mrps[i.id]=!0,r.lines[t.line._id]=!0)},"mrpLines:remove":function(e,t,r){var i=e.settings.mrps.get(t.mrp);i&&(i.lines.remove(t.line._id),r.mrps[i.id]=!0,r.lines[t.line._id]=!0)},"mrpLines:change":function(e,t,r){var i=e.settings.mrps.get(t.mrp);if(i){var n=i.lines.get(t.line);n&&(n.set(t.property,t.newValue),r.mrps[i.id]=!0,r.lines[n.id]=!0)}}},p={settings:function(e,t){var r={reset:!1,lines:{},mrps:{}};t.forEach(function(t){r.reset=r.reset||/add|remove/.test(t.type),l[t.type](e,t,r)}),r.lines.any=Object.keys(r.lines).length>0,r.mrps.any=Object.keys(r.mrps).length>0,e.settings.trigger("changed",r)},addedOrders:function(e,t){var r=[],i={};t.forEach(function(e){var t=new s(e);r.push(t),i[e.mrp]||(i[e.mrp]=[]),i[e.mrp].push(t)}),e.orders.add(r),e.orders.trigger("added",r),Object.keys(i).forEach(function(t){var r=e.mrps.get(t);r.orders.add(i[t]),r.orders.trigger("added",i[t])})},removedOrders:function(e,t){var r=[],i={};t.forEach(function(t){var n=e.orders.get(t._id);if(n){r.push(n);var s=n.get("mrp");i[s]||(i[s]=[]),i[s].push(n)}}),Object.keys(i).forEach(function(t){var r=e.mrps.get(t);r&&(r.orders.remove(i[r.id]),r.orders.trigger("removed",i[r.id]))}),e.orders.remove(r),e.orders.trigger("removed",r)},changedOrders:function(e,t){var r=[],i={},n={};t.forEach(function(t){var s=e.orders.get(t._id);if(s){r.push(s);var a=e.mrps.get(s.get("mrp")),o=(t.changes.mrp?e.mrps.get(t.changes.mrp[1]):null)||a;a.id!==o.id&&(n[a.id]||(n[a.id]=[]),n[a.id].push(s),a.orders.remove(s)),i[o.id]||(i[o.id]=[]),i[o.id].push(s);var d={};Object.keys(t.changes).forEach(function(e){d[e]=t.changes[e][1]}),s.set(d)}}),Object.keys(n).forEach(function(t){e.mrps.get(t).trigger("removed",n[t])}),e.orders.trigger("changed",r),Object.keys(i).forEach(function(t){e.mrps.get(t).orders.trigger("changed",i[t])})},changedLines:function(t,r){var i=[],n={};r.forEach(function(r){var s=t.lines.get(r._id);s.get("version")>=r.version||(s.set(e.omit(r,"orders")),r.orders&&s.orders.reset(r.orders),i.push(s),s.settings&&s.settings.get("mrpPriority").forEach(function(e){n[e]||(n[e]=[]),n[e].push(s)}))}),t.lines.trigger("changed",i),Object.keys(n).forEach(function(e){t.mrps.get(e).lines.trigger("changed",n[e])})}};return r.extend({urlRoot:"/planning/plans",clientUrlRoot:"#planning/plans",topicPrefix:"planning.plans",privilegePrefix:"PLANNING",nlsDomain:"planning",defaults:{loading:!1},initialize:function(t,r){r=e.defaults({},r,{displayOptions:null,settings:null,minMaxDates:!1,pceTimes:!1}),this.urlQuery="minMaxDates="+(r.minMaxDates?1:0)+"&pceTimes="+(r.pceTimes?1:0),this.displayOptions=r.displayOptions,this.settings=r.settings,this.orders=new a(null,{plan:this,paginate:!1}),this.lines=new o(null,{plan:this,paginate:!1}),this.mrps=new d(null,{plan:this,paginate:!1}),this.lines.on("reset",function(){this.mrps.reset()},this),this.attributes.orders&&(this.orders.reset(this.attributes.orders),delete this.attributes.orders),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines)},url:function(){return this.urlRoot+"/"+this.id+"?"+this.urlQuery},parse:function(r){var i={};return r._id&&(i._id=t.utc.format(r._id,"YYYY-MM-DD")),r.createdAt&&(i.createdAt=new Date(r.createdAt)),r.updatedAt&&(i.updatedAt=new Date(r.updatedAt)),(r.minDate||r.maxDate)&&this.displayOptions.set(e.pick(r,["minDate","maxDate"])),r.orders&&this.orders.reset(r.orders),r.lines&&this.lines.reset(r.lines),i},getLabel:function(){return t.utc.format(this.id,"LL")},isEditable:function(){return this.settings.isEditable()},applyChange:function(e){var r=this;t.utc.format(e.plan,"YYYY-MM-DD")===r.id&&(r.set("updatedAt",new Date(e.date)),Object.keys(e.data).forEach(function(t){p[t]&&p[t](r,e.data[t])}))}})});