// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../core/Model","../core/Collection","./Plan"],function(t,e,i,n,s){"use strict";var r=i.extend({defaults:function(){return{mrpPriority:[],activeFrom:"",activeTo:""}}}),a=n.extend({model:r}),u=i.extend({defaults:function(){return{extraOrderSeconds:0,extraShiftSeconds:[0,0,0],bigOrderQuantity:0,splitOrderQuantity:0,maxSplitLineCount:0,hardOrderManHours:0,hardComponents:[],lines:[]}},initialize:function(){this.lines=new d(null,{paginate:!1}),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines)},toJSON:function(){return t.assign({lines:this.lines.toJSON()},this.attributes)}}),l=n.extend({model:u}),o=i.extend({defaults:function(){return{workerCount:0,orderPriority:["small","easy","hard"]}}}),d=n.extend({model:o});return i.extend({urlRoot:"/planning/settings",clientUrlRoot:"#planning/settings",topicPrefix:"planning.settings",privilegePrefix:"PLANNING",nlsDomain:"planning",initialize:function(){this.lines=new a(null,{paginate:!1}),this.mrps=new l(null,{paginate:!1}),this.attributes.lines&&(this.lines.reset(this.attributes.lines),delete this.attributes.lines),this.attributes.mrps&&(this.mrps.reset(this.attributes.mrps),delete this.attributes.mrps)},parse:function(i){var n=t.omit(i,["lines","mrps"]);return i._id&&(n._id=e.utc.format(i._id,"YYYY-MM-DD")),i.lines&&(this.lines?this.lines.reset(i.lines):n.lines=i.lines),i.mrps&&(this.mrps?this.mrps.reset(i.mrps):n.mrps=i.mrps),n},toJSON:function(){return t.assign({lines:this.lines.toJSON(),mrps:this.mrps.toJSON()},this.attributes)},getLabel:function(){return e.utc.format(this.id,"LL")},getDefinedMrpIds:function(){return this.mrps.map(function(t){return t.id}).sort(function(t,e){return t.localeCompare(e,void 0,{numeric:!0})})},isEditable:function(){return e.getMoment(this.id).hours(6).diff(Date.now())>3e5},applyChanges:function(t){s.applySettingsChanges(this,t)},hasAllRequiredStatuses:function(e){var i=this.get("requiredStatuses");return t.intersection(i,e).length===i.length},hasAnyIgnoredStatus:function(e){return t.intersection(this.get("ignoredStatuses"),e).length>0}},{fromDate:function(t){var i=e.utc.getMoment().startOf("day");return/^-?[0-9]+d$/.test(t)&&(t=i.add(+t.replace("d",""),"days").format("YYYY-MM-DD")),new this({_id:t})}})});