define(["underscore","../time","../core/Collection","./PlanShiftOrder","./util/shift"],function(t,e,i,n,r){"use strict";var a=["_id","prodLine","shift","orderId","operationNo","quantityDone","startedAt","finishedAt"];return i.extend({model:n,initialize:function(t,e){var i=this;i.plan=e.plan,i.shiftStartTime=0,i.shiftEndTime=0,i.cache={execution:{},byLine:{},byOrder:{}},i.updateShiftTime(),i.plan.on("change:_id",i.updateShiftTime.bind(i)),i.on("reset",function(){i.cache={execution:{},byLine:{},byOrder:{}},i.forEach(i.cacheOrder,i)}),i.on("add",i.cacheOrder,i),i.on("change:quantityDone",function(){this.cache.execution={}}),i.forEach(i.cacheOrder,i)},url:function(){return"/planning/shiftOrders/"+this.plan.id},updateShiftTime:function(){var t=e.getMoment(this.plan.id,"YYYY-MM-DD").hours(6);this.shiftStartTime=t.valueOf(),this.shiftEndTime=t.add(1,"days").valueOf()},findOrders:function(t,e,i){var n=this.cache.byOrder[t]||[];return e&&(n=n.filter(function(t){return t.get("prodLine")===e})),i&&(n=n.filter(function(t){return t.get("shift")===i})),n},getLineOrderExecution:function(t,i,n){var a=t+i.id;if(this.cache.execution[a])return this.cache.execution[a];var o=i.get("orderNo"),u=this.plan.orders.get(o),c=this.cache.execution[a]={quantityDoneOnLine:0,quantityDoneOnDay:0,quantityDoneOnShift:0,plannedQuantityDone:0,plannedQuantitiesDone:[]};if(!u)return c;if(!this.cache.byLine[t])return c;var d=Date.parse(i.get("startAt")),h=e.utc.getMoment(d).local(!0).valueOf(),s=h-144e5,f=h+144e5,l=u.getOperationNo(),p=r.getShiftStartTime(h,!0),O=r.getFirstShiftStartTime(p,!0),g=O+3*r.SHIFT_DURATION,y=p+r.SHIFT_DURATION,D=s-p,v=f-y;if(n&&(D<0||v>0)){var S=r.getShiftNo(h,!0);D<0&&n.prevAt[S]&&(s=e.utc.getMoment(n.prevAt[S]).local(!0).valueOf()+D),v>0&&n.nextAt[S]&&(f=e.utc.getMoment(n.nextAt[S]).local(!0).valueOf()+v)}return this.findOrders(o,t).forEach(function(t){var e=t.attributes.quantityDone;if(e){var i=t.attributes.operationNo;if(l&&i&&i===l){c.quantityDoneOnLine+=e;var n=Date.parse(t.attributes.startedAt);n>=O&&n<=g&&(c.quantityDoneOnDay+=e),r.getShiftStartTime(n,!0)===p&&(c.quantityDoneOnShift+=e),n>=s&&n<=f&&(c.plannedQuantityDone+=e,c.plannedQuantitiesDone.push(e))}}}),c},getTotalQuantityDone:function(t,e){return this.getLineOrderExecution(t,e).quantityDoneOnShift},update:function(e){if(e=e.prodShiftOrders){var i=this;if(Array.isArray(e))e.forEach(function(t){i.addOrder(t)});else{var n=i.get(e._id);n?n.set(t.pick(e,a)):e._id&&i.addOrder(e)}}},addOrder:function(t){this.plan.orders.get(t.orderId)&&this.add(t,{merge:!0})},cacheOrder:function(t){var e=this.cache.byLine,i=this.cache.byOrder,n=t.get("prodLine"),r=t.get("shift"),a=t.get("orderId");e[n]||(e[n]={all:[]}),e[n][r]||(e[n][r]={all:[]}),e[n][r][a]||(e[n][r][a]=[]),i[a]||(i[a]=[]),e[n].all.push(t),e[n][r].all.push(t),e[n][r][a].push(t),i[a].push(t),this.cache.execution={}}})});