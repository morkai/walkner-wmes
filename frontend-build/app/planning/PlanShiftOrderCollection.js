define(["underscore","../time","../core/Collection","./PlanShiftOrder","./util/shift"],function(t,e,n,i,r){"use strict";var a=["_id","prodLine","shift","orderId","operationNo","quantityDone","startedAt","finishedAt"];return n.extend({model:i,initialize:function(t,e){var n=this;n.plan=e.plan,n.shiftStartTime=0,n.shiftEndTime=0,n.cache={execution:{},byLine:{},byOrder:{}},n.updateShiftTime(),n.plan.on("change:_id",n.updateShiftTime.bind(n)),n.on("reset",function(){n.cache={execution:{},byLine:{},byOrder:{}},n.forEach(n.cacheOrder,n)}),n.on("add",n.cacheOrder,n),n.on("change:quantityDone",function(){this.cache.execution={}}),n.forEach(n.cacheOrder,n)},url:function(){return"/planning/shiftOrders/"+this.plan.id},updateShiftTime:function(){var t=e.getMoment(this.plan.id,"YYYY-MM-DD").hours(6);this.shiftStartTime=t.valueOf(),this.shiftEndTime=t.add(1,"days").valueOf()},findOrders:function(t,e,n){var i=this.cache.byOrder[t]||[];return e&&(i=i.filter(function(t){return t.get("prodLine")===e})),n&&(i=i.filter(function(t){return t.get("shift")===n})),i},getExecutionOrders:function(t,e,n){const i=this.cache.byLine[t],r=[];if(!i)return r;const a=i.orders[e];return a?(a.forEach(t=>{t.attributes.operationNo===n&&r.push({pso:t,quantityDone:t.attributes.quantityDone,startedAt:Date.parse(t.attributes.startedAt),continuation:!!r.length&&r[r.length-1].pso.nextLinePso===t})}),r):r},getLineOrderExecution:function(t,n,i){const a=t+n.id,o=this.cache.execution;if(o[a])return o[a];i||(i=this.plan.workingLines.getWorkingTimes(this.plan.lines.get(t)));const s=n.get("orderNo"),u=this.plan.orders.get(s),d=o[a]={quantityDoneOnLine:0,quantityDoneOnDay:0,quantityDoneOnShift:0,plannedQuantityDone:0,plannedQuantitiesDone:[],prodShiftOrders:[]};if(!u)return d;const c=u.getOperationNo(),h=this.getExecutionOrders(t,s,c);if(!h.length)return d;const f=n.get("quantity"),l=Date.parse(n.get("startAt")),p=e.utc.getMoment(l).local(!0).valueOf();let g=p-144e5,O=p+144e5;const y=r.getShiftStartTime(p,!0),D=r.getFirstShiftStartTime(y,!0),S=D+3*r.SHIFT_DURATION,A=y+r.SHIFT_DURATION,m=g-y,q=O-A;if(i&&(m<0||q>0)){var T=r.getShiftNo(p,!0);m<0&&(g=i.prevAt[T]?e.utc.getMoment(i.prevAt[T]).local(!0).valueOf()+m:0),q>0&&(O=i.nextAt[T]?e.utc.getMoment(i.nextAt[T]).local(!0).valueOf()+q:Number.MAX_SAFE_INTEGER)}return h.forEach(t=>{d.quantityDoneOnLine+=t.quantityDone,t.startedAt>=D&&t.startedAt<=S&&(d.quantityDoneOnDay+=t.quantityDone),r.getShiftStartTime(t.startedAt,!0)===y&&(d.quantityDoneOnShift+=t.quantityDone),!o[t.pso.id]&&d.plannedQuantityDone<f&&(t.startedAt>=g&&t.startedAt<=O||t.continuation)&&(o[t.pso.id]=!0,d.plannedQuantityDone+=t.quantityDone,d.plannedQuantitiesDone.push(t.quantityDone,d.plannedQuantityDone),d.prodShiftOrders.push(t.pso))}),d},getTotalQuantityDone:function(t,e){return this.getLineOrderExecution(t,e).quantityDoneOnShift},update:function(e){if(e=e.prodShiftOrders){var n=this;if(Array.isArray(e))e.forEach(function(t){n.addOrder(t)});else{var i=n.get(e._id);i?i.set(t.pick(e,a)):e._id&&n.addOrder(e)}}},addOrder:function(t){this.plan.orders.get(t.orderId)&&this.add(t,{merge:!0})},cacheOrder:function(t){var e=this.cache.byLine,n=this.cache.byOrder,i=t.get("prodLine"),r=t.get("shift"),a=t.get("orderId");e[i]||(e[i]={all:[],orders:{}}),e[i][r]||(e[i][r]={all:[]}),e[i][r][a]||(e[i][r][a]=[]),e[i].orders[a]||(e[i].orders[a]=[]),n[a]||(n[a]=[]),e[i].all.length&&(e[i].all[e[i].all.length-1].nextLinePso=t),e[i].all.push(t),e[i][r].all.push(t),e[i][r][a].push(t),e[i].orders[a].push(t),n[a].push(t),this.cache.execution={}}})});