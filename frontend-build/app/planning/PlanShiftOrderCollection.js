define(["underscore","../time","../core/Collection","./PlanShiftOrder","./util/shift"],function(e,t,n,i,r){"use strict";var a=["_id","prodLine","shift","orderId","operationNo","quantityDone","startedAt","finishedAt"];return n.extend({model:i,initialize:function(e,t){var n=this;n.plan=t.plan,n.shiftStartTime=0,n.shiftEndTime=0,n.cache={execution:{},byLine:{},byOrder:{}},n.updateShiftTime(),n.plan.on("change:_id",n.updateShiftTime.bind(n)),n.on("reset",function(){n.cache={execution:{},byLine:{},byOrder:{}},n.forEach(n.cacheOrder,n)}),n.on("add",n.cacheOrder,n),n.on("change:quantityDone",function(){this.cache.execution={}}),n.forEach(n.cacheOrder,n)},url:function(){return"/planning/shiftOrders/"+this.plan.id},updateShiftTime:function(){var e=t.getMoment(this.plan.id,"YYYY-MM-DD").hours(6);this.shiftStartTime=e.valueOf(),this.shiftEndTime=e.add(1,"days").valueOf()},findOrders:function(e,t,n){var i=this.cache.byOrder[e]||[];return t&&(i=i.filter(function(e){return e.get("prodLine")===t})),n&&(i=i.filter(function(e){return e.get("shift")===n})),i},getLineOrderExecution:function(e,n){var i=e+n.id;if(this.cache.execution[i])return this.cache.execution[i];var a=n.get("orderNo"),o=this.plan.orders.get(a),d=this.cache.execution[i]={quantityDoneOnLine:0,quantityDoneOnDay:0,quantityDoneOnShift:0,plannedQuantityDone:0,plannedQuantitiesDone:[]};if(!o)return d;var c=this.cache.byLine[e];if(!c)return d;var u=Date.parse(n.get("startAt")),h=t.utc.getMoment(u).local(!0).valueOf(),f=h-144e5,s=h+144e5,l=o.getOperationNo(),p=r.getShiftStartTime(h,!0),O=p+864e5;return c.all.forEach(function(e){if(e.get("orderId")===a){var t=e.get("quantityDone");if(t){var n=e.get("operationNo");if(l&&n&&n===l){d.quantityDoneOnLine+=t;var i=Date.parse(e.get("startedAt"));i>=p&&i<=O&&(d.quantityDoneOnDay+=t),r.getShiftStartTime(i,!0)===p&&(d.quantityDoneOnShift+=t),i>=f&&i<=s&&(d.plannedQuantityDone+=t,d.plannedQuantitiesDone.push(t))}}}}),d},getTotalQuantityDone:function(e,t){return this.getLineOrderExecution(e,t).quantityDoneOnShift},update:function(t){if(t=t.prodShiftOrders){var n=this;if(Array.isArray(t))t.forEach(function(e){n.addOrder(e)});else{var i=n.get(t._id);i?i.set(e.pick(t,a)):t._id&&n.addOrder(t)}}},addOrder:function(e){this.plan.orders.get(e.orderId)&&this.add(e,{merge:!0})},cacheOrder:function(e){var t=this.cache.byLine,n=this.cache.byOrder,i=e.get("prodLine"),r=e.get("shift"),a=e.get("orderId");t[i]||(t[i]={all:[]}),t[i][r]||(t[i][r]={all:[]}),t[i][r][a]||(t[i][r][a]=[]),n[a]||(n[a]=[]),t[i].all.push(e),t[i][r].all.push(e),t[i][r][a].push(e),n[a].push(e),this.cache.execution={}}})});