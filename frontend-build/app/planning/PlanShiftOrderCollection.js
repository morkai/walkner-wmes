define(["underscore","../time","../core/Collection","./PlanShiftOrder","./util/shift"],function(t,e,r,i,n){"use strict";var a=["_id","prodLine","shift","orderId","operationNo","quantityDone","startedAt","finishedAt"];return r.extend({model:i,initialize:function(t,e){var r=this;r.plan=e.plan,r.shiftStartTime=0,r.shiftEndTime=0,r.cache={byLine:{},byOrder:{}},r.updateShiftTime(),r.plan.on("change:_id",r.updateShiftTime.bind(r)),r.on("reset",function(){r.cache={byLine:{},byOrder:{}},r.forEach(r.cacheOrder,r)}),r.on("add",r.cacheOrder,r),r.forEach(r.cacheOrder,r)},url:function(){return"/planning/shiftOrders/"+this.plan.id},updateShiftTime:function(){var t=e.getMoment(this.plan.id,"YYYY-MM-DD").hours(6);this.shiftStartTime=t.valueOf(),this.shiftEndTime=t.add(1,"days").valueOf()},findOrders:function(t,e,r){var i=this.cache.byOrder[t]||[];return e&&(i=i.filter(function(t){return t.get("prodLine")===e})),r&&(i=i.filter(function(t){return t.get("shift")===r})),i},getTotalQuantityDone:function(t,e){var r=e.get("orderNo"),i=this.plan.orders.get(r);if(!i)return 0;var a=this.cache.byLine,d=Date.parse(e.get("startAt")),o=n.getShiftNo(d),h=i.getOperationNo(),s=a[t]&&a[t][o]&&a[t][o][r],f=0;return s?(s.forEach(function(t){var e=t.get("operationNo");h&&e&&h!==e||(f+=t.get("quantityDone")||0)}),f):f},update:function(e){if(e=e.prodShiftOrders){var r=this;if(Array.isArray(e))e.forEach(function(t){r.addOrder(t)});else{var i=r.get(e._id);i?i.set(t.pick(e,a)):e._id&&r.addOrder(e)}}},addOrder:function(t){this.plan.orders.get(t.orderId)&&this.add(t,{merge:!0})},cacheOrder:function(t){var e=this.cache.byLine,r=this.cache.byOrder,i=t.get("prodLine"),n=t.get("shift"),a=t.get("orderId"),d=Date.parse(t.get("startedAt"));d<this.shiftStartTime||d>this.shiftEndTime||(e[i]||(e[i]={}),e[i][n]||(e[i][n]={}),e[i][n][a]||(e[i][n][a]=[]),e[i][n][a].push(t),r[a]||(r[a]=[]),r[a].push(t))}})});