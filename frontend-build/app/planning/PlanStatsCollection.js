define(["app/time","app/core/Collection","app/core/util/getShiftStartInfo"],function(t,n,o){"use strict";return n.extend({nlsDomain:"planning",initialize:function(t,n){this.month=n&&n.month},url:function(){if(!this.month)return"/planning/plans";var t=this.getDateRange();return"/planning/plans?select(stats)&sort(_id)&limit(0)&_id>="+t.from.valueOf()+"&_id<"+t.to.valueOf()},getDateRange:function(){var n=t.utc.getMoment(this.month+"-01","YYYY-MM-DD"),o=n.clone(),e=n.clone().add(1,"month");return 1!==n.isoWeekday()&&o.subtract(n.isoWeekday()-1,"days"),7!==n.endOf("month").isoWeekday()&&e.add(7-n.isoWeekday(),"days"),{from:o,to:e}},parse:function(n){var e={};n.collection.forEach(n=>{n._id=t.utc.format(n._id,"YYYY-MM-DD"),e[n._id]=n});for(var a=[],r=this.getDateRange(),i=r.to.valueOf(),m=t.utc.getMoment(this.month,"YYYY-MM"),s=o(Date.now()).moment;r.from.valueOf()<i;){var h=r.from.format("YYYY-MM-DD"),f=e[h]||{_id:h,stats:[]};f.from="06:00",f.to="06:00",f.currentMonth=r.from.year()===m.year()&&r.from.month()===m.month(),f.currentDay=r.from.year()===s.year()&&r.from.month()===s.month()&&r.from.date()===s.date(),f.stats.length&&(f.stats[0].startAt&&(f.from=t.utc.format(f.stats[0].startAt,"HH:mm")),f.stats[0].finishAt&&(f.to=t.utc.format(f.stats[0].finishAt,"HH:mm")),"13:59"===f.to?f.to="14:00":"21:59"===f.to?f.to="22:00":"05:59"===f.to&&(f.to="06:00")),a.push(f),r.from.add(1,"days")}return a},prevMonth:function(){this.setMonth(t.getMoment(this.month,"YYYY-MM").subtract(1,"month").format("YYYY-MM"))},nextMonth:function(){this.setMonth(t.getMoment(this.month,"YYYY-MM").add(1,"month").format("YYYY-MM"))},setMonth:function(t){this.month=t,this.trigger("change:month")}},{fromQuery:function(n){var o=n.month;return o&&t.utc.getMoment(o+"-01","YYYY-MM-DD").isValid()||(o=t.getMoment().format("YYYY-MM")),new this(null,{month:o,paginate:!1})}})});