// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/time","app/core/Model","app/core/View","app/users/ownMrps","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","app/planning/views/PlanFilterView","app/planning/views/PlanMrpView","app/planning/templates/planPage"],function(n,e,i,t,s,a,l,p,r,o,d,h,g,c){"use strict";return l.extend({template:c,layoutName:"page",breadcrumbs:function(){return[{href:"#planning/plans",label:i.bound("planning","BREADCRUMBS:base")},this.plan.getLabel()]},actions:function(){return[{label:i.bound("planning","PAGE_ACTION:changes"),icon:"list-ol",href:"#planning/changes?sort(-date)&plan="+this.plan.id},{label:i.bound("planning","PAGE_ACTION:settings"),icon:"cogs",privileges:"PROD_DATA:MANAGE",href:"#planning/settings/"+this.plan.id}]},remoteTopics:{"planning.changes.created":function(n){},"planning.generator.finished":function(n){n.date===this.plan.id&&this.reload()}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings()},setUpLayout:function(n){this.layout=n},defineModels:function(){this.plan=new r({_id:this.options.date},{displayOptions:d.fromLocalStorage({mrps:this.options.mrps}),settings:o.fromDate(this.options.date),minMaxDates:!0,pceTimes:!1}),window.plan=this.plan},defineViews:function(){this.filterView=new h({plan:this.plan}),this.setView("#-filter",this.filterView)},defineBindings:function(){var e=this,i=e.plan,t=n.debounce(i.mrps.reset.bind(i.mrps),1),s=n.after(n.debounce(e.renderMrps.bind(e),1),1);e.listenTo(i,"change:loading",e.onLoadingChanged),e.listenTo(i,"change:_id",e.onDateFilterChanged),e.listenTo(i.displayOptions,"change:mrps",e.onMrpsFilterChanged),e.listenTo(i.settings.mrps,"add remove",t),e.listenTo(i.settings.lines,"add remove",t),e.listenTo(i.mrps,"reset",s)},load:function(n){return n(p.load(this),this.loadStyles(),this.plan.settings.fetch(),this.plan.fetch())},loadStyles:function(){var n=e.Deferred(),i=e("head");return i.find('link[href$="plan.css"]').length?n.resolve():e('<link rel="stylesheet" href="/app/planning/assets/plan.css">').on("load",function(){n.resolve()}).appendTo(i),n.promise()},afterRender:function(){this.renderMrps()},reload:function(){function n(){i.set("loading",!1),t.msg.loadingFailed()}var e=this,i=e.plan;i.set("loading",!0),e.promised(i.settings.fetch()).then(function(){e.promised(e.plan.fetch()).then(i.set.bind(i,"loading",!1),n)},n)},updateUrl:function(){this.broker.publish("router.navigate",{url:"/planning/plans/"+this.plan.id+"?mrps="+this.plan.displayOptions.get("mrps"),replace:!0,trigger:!1})},renderMrps:function(){var n=this;n.removeView("#-mrps"),n.plan.mrps.forEach(function(e){n.insertView("#-mrps",new g({plan:n.plan,mrp:e})).render()}),this.$id("empty").toggleClass("hidden",n.plan.mrps.length>0),this.$id("mrps").toggleClass("hidden",0===n.plan.mrps.length)},onDateFilterChanged:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this)),this.updateUrl(),this.reload()},onMrpsFilterChanged:function(){this.updateUrl(),this.renderMrps()},onLoadingChanged:function(){this.plan.get("loading")||this.renderMrps()}})});