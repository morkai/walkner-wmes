// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/core/Model","app/core/View","app/users/ownMrps","app/planning/Plan","app/planning/PlanSettings","app/planning/views/PlanFilterView","app/planning/views/PlanMrpView","app/planning/templates/planPage"],function(n,i,e,t,s,a,l,r,o,p,h){"use strict";return s.extend({template:h,layoutName:"page",breadcrumbs:function(){return[{href:"#planning/plans",label:i.bound("planning","BREADCRUMBS:base")},this.plan.getLabel()]},actions:function(){return[{label:i.bound("planning","PAGE_ACTION:changes"),icon:"list-ol",href:"#planning/changes?sort(-date)&plan="+this.plan.id},{label:i.bound("planning","PAGE_ACTION:settings"),icon:"cogs",privileges:"PLANNING:MANAGE",href:"#planning/settings/"+this.plan.id}]},remoteTopics:{"planning.generator.finished":function(n){n.date===this.plan.id&&this.reload()}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings()},setUpLayout:function(n){this.layout=n},defineModels:function(){this.planningOptions=new t(JSON.parse(localStorage.getItem("PLANNING:OPTIONS")||"{}")),this.settings=r.forDate(this.options.date),this.plan=new l({_id:this.settings.id,mrpFilter:this.options.mrpFilter},{cache:!0,urlQuery:"pceTimes=0&minMaxDates=1",options:this.planningOptions,settings:this.settings})},defineViews:function(){this.filterView=new o({model:this.plan}),this.setView("#-filter",this.filterView)},defineBindings:function(){this.listenTo(this.planningOptions,"change",function(){localStorage.setItem("PLANNING:OPTIONS",JSON.stringify(this.planningOptions.toJSON()))}),this.listenTo(this.plan,"change:_id",this.onDateFilterChanged),this.listenTo(this.plan,"change:mrpFilter",this.onMrpFilterChanged),this.listenTo(this.plan,"change:loading",this.onLoadingChanged)},load:function(n){return n(a.load(this),this.loadStyles(),this.settings.fetch(),this.plan.fetch())},loadStyles:function(){var i=n.Deferred(),e=n("head");return e.find('link[href$="plan.css"]').length?i.resolve():n('<link rel="stylesheet" href="/app/planning/assets/plan.css">').on("load",function(){i.resolve()}).appendTo(e),i.promise()},afterRender:function(){this.renderMrps()},reload:function(){function n(){t.set("loading",!1),e.msg.loadingFailed()}var i=this,t=i.plan;t.set("loading",!0),i.promised(i.settings.fetch()).then(function(){i.promised(i.plan.fetch()).then(t.set.bind(t,"loading",!1),n)},n)},updateUrl:function(){var n=this.plan.getFilter();this.broker.publish("router.navigate",{url:"/planning/plans/"+n.date+"?mrp="+n.mrp,replace:!0,trigger:!1})},renderMrps:function(){var n=this;n.removeView("#-mrps"),n.plan.serializeMrps().forEach(function(i){n.insertView("#-mrps",new p({model:i})).render()});var i=this.$id("mrps")[0].childElementCount>0;this.$id("empty").toggleClass("hidden",i),this.$id("mrps").toggleClass("hidden",!i)},onDateFilterChanged:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this)),this.updateUrl(),this.reload()},onMrpFilterChanged:function(){this.updateUrl(),this.renderMrps()},onLoadingChanged:function(){this.plan.get("loading")||this.renderMrps()}})});