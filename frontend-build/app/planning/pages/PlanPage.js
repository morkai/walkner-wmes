// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/time","app/core/Model","app/core/View","app/core/util/bindLoadingMessage","app/delayReasons/DelayReasonCollection","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","app/planning/views/PlanFilterView","app/planning/views/PlanMrpView","app/planning/templates/planPage"],function(e,n,t,i,s,a,r,o,l,p,d,h,c,u,g){"use strict";return r.extend({template:g,layoutName:"page",breadcrumbs:function(){return[{href:"#planning/plans",label:t.bound("planning","BREADCRUMBS:base")},this.plan.getLabel()]},actions:function(){var e=this;return[{label:t.bound("planning","PAGE_ACTION:changes"),icon:"list-ol",href:"#planning/changes?sort(date)&plan="+e.plan.id},{label:t.bound("planning","PAGE_ACTION:settings"),icon:"cogs",privileges:"PLANNING:MANAGE",href:"#planning/settings/"+e.plan.id,className:e.plan.isEditable()?"":"disabled",callback:function(n){if(0===n.button&&!n.ctrlKey&&e.plan.isEditable())return e.broker.publish("router.navigate",{url:"/planning/settings/"+e.plan.id+"?back=1",trigger:!0,replace:!1}),!1}}]},remoteTopics:{"planning.changes.created":function(e){this.plan.applyChange(e)},"planning.generator.started":function(e){e.date===this.plan.id&&(this.$msg=i.msg.show({type:"info",text:t("planning","MSG:GENERATING")}))},"planning.generator.finished":function(e){var n=this.$msg;n&&e.date===this.plan.id&&(i.msg.hide(n),this.$msg=null)},"orders.synced":function(){this.reloadOrders()},"orders.updated.*":function(e){var n=this.plan.lateOrders.get(e._id);n&&"undefined"!=typeof e.change.newValues.delayReason&&n.set("delayReason",e.change.newValues.delayReason)}},localTopics:{"planning.mrpStatsRecounted":"scheduleStatRecount"},initialize:function(){this.$msg=null,this.defineModels(),this.defineViews(),this.defineBindings()},destroy:function(){n(window).off("."+this.idPrefix)},setUpLayout:function(e){this.layout=e},defineModels:function(){this.delayReasons=new l,this.plan=new p({_id:this.options.date},{displayOptions:h.fromLocalStorage({mrps:this.options.mrps}),settings:d.fromDate(this.options.date),minMaxDates:!0,pceTimes:!1}),o(this.plan,this,"MSG:LOADING_PLAN_FAILURE"),o(this.plan.settings,this,"MSG:LOADING_SETTINGS_FAILURE"),o(this.plan.sapOrders,this,"MSG:LOADING_SAP_ORDERS_FAILURE"),window.plan=this.plan},defineViews:function(){this.filterView=new c({plan:this.plan}),this.setView("#-filter",this.filterView)},defineBindings:function(){var t=this,i=t.plan;t.listenTo(i,"sync",t.onPlanSynced),t.listenTo(i,"change:_id",t.onDateFilterChanged),t.listenTo(i.displayOptions,"change:mrps",t.onMrpsFilterChanged),t.listenTo(i.displayOptions,"change:wrapLists",t.onWrapListsChanged),t.listenTo(i.displayOptions,"change:useLatestOrderData",t.updateUrl),t.listenTo(i.settings,"changed",t.onSettingsChanged),t.listenTo(i.settings,"errored",t.reload),t.listenTo(i.mrps,"reset",e.after(2,e.debounce(t.renderMrps.bind(t),1))),t.listenTo(i.sapOrders,"sync",t.onSapOrdersSynced),n(window).on("resize."+t.idPrefix,e.debounce(t.onWindowResize.bind(t),16)).on("keyup."+t.idPrefix,t.onWindowKeyUp.bind(t))},load:function(e){var n=this.plan;return e(this.delayReasons.fetch({reset:!0}),n.settings.fetch(),n.sapOrders.fetch({reset:!0}),n.lateOrders.fetch({reset:!0}),n.fetch())},serialize:function(){return{idPrefix:this.idPrefix,wrap:this.plan.displayOptions.isListWrappingEnabled()}},afterRender:function(){this.renderMrps()},reload:function(){function e(){s.set("loading",!1),i.msg.loadingFailed()}var t=this,s=t.plan;s.set("loading",!0),t.promised(s.settings.set("_id",s.id).fetch()).then(function(){var i=n.when(s.sapOrders.fetch({reset:!0,reload:!0}),s.lateOrders.fetch({reset:!0,reload:!0}),s.fetch());t.promised(i).then(s.set.bind(s,"loading",!1),e)},e)},updateUrl:function(){var e=this.plan;this.broker.publish("router.navigate",{url:"/planning/plans/"+e.id+"?mrps="+e.displayOptions.get("mrps")+"&sapOrders="+(e.displayOptions.isLatestOrderDataUsed()?"1":"0"),replace:!0,trigger:!1})},renderMrps:function(){var e=this;e.removeView("#-mrps"),e.plan.mrps.forEach(function(n){var t=new u({delayReasons:e.delayReasons,plan:e.plan,mrp:n});e.insertView("#-mrps",t).render()}),this.$id("empty").toggleClass("hidden",e.plan.mrps.length>0),this.$id("mrps").toggleClass("hidden",0===e.plan.mrps.length),clearTimeout(this.timers.recountStats),this.recountStats()},reloadOrders:function(){this.promised(this.plan.lateOrders.fetch({reset:!0})),this.promised(this.plan.sapOrders.fetch({reset:!0}))},scheduleStatRecount:function(){this.timers.recountStats&&clearTimeout(this.timers.recountStats),this.timers.recountStats=setTimeout(this.recountStats.bind(this),10)},recountStats:function(){this.filterView.recountStats()},onDateFilterChanged:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this)),this.updateUrl(),this.reload()},onMrpsFilterChanged:function(){this.updateUrl(),this.plan.mrps.reset()},onWrapListsChanged:function(){this.$el.toggleClass("wrap",this.plan.displayOptions.isListWrappingEnabled())},onPlanSynced:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this))},onSettingsChanged:function(e){e.reset&&this.plan.mrps.reset()},onSapOrdersSynced:function(){this.timers.reloadOrders&&clearTimeout(this.timers.reloadOrders),this.timers.reloadOrders=setTimeout(this.reloadOrders.bind(this),6e5)},onWindowResize:function(e){this.broker.publish("planning.windowResized",e)},onWindowKeyUp:function(e){27===e.keyCode&&this.broker.publish("planning.escapePressed")}})});