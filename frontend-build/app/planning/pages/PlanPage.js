// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/time","app/core/Model","app/core/View","app/core/util/bindLoadingMessage","app/delayReasons/DelayReasonCollection","app/factoryLayout/productionState","app/paintShop/views/PaintShopDatePickerView","../Plan","../PlanSettings","../PlanDisplayOptions","../views/PlanFilterView","../views/PlanMrpView","app/planning/templates/planPage","app/planning/templates/planLegend"],function(e,t,n,i,s,a,r,o,l,d,p,c,h,u,g,f,m,y){"use strict";var b=!1;return r.extend({template:m,layoutName:"page",breadcrumbs:function(){return[{href:"#planning/plans",label:n.bound("planning","BREADCRUMBS:base")},{href:"#planning/plans/"+this.plan.id,label:this.plan.getLabel(),template:function(e){return'<span class="paintShop-breadcrumb"><a class="fa fa-chevron-left" data-action="prev"></a><a href="'+e.href+'" data-action="showPicker">'+e.label+'</a><a class="fa fa-chevron-right" data-action="next"></a></span>'}}]},actions:function(){var e=this;return[{label:n.bound("planning","PAGE_ACTION:legend"),icon:"question-circle",callback:function(){return e.toggleLegend(this.querySelector(".btn")),!1}},{label:n.bound("planning","PAGE_ACTION:changes"),icon:"list-ol",href:"#planning/changes?sort(date)&plan="+e.plan.id},{label:n.bound("planning","PAGE_ACTION:settings"),icon:"cogs",privileges:"PLANNING:MANAGE",href:"#planning/settings/"+e.plan.id,className:e.plan.isEditable()?"":"disabled",callback:function(t){if(0===t.button&&!t.ctrlKey&&e.plan.isEditable())return e.broker.publish("router.navigate",{url:"/planning/settings/"+e.plan.id+"?back=1",trigger:!0,replace:!1}),!1}}]},remoteTopics:{"planning.changes.created":function(e){this.plan.applyChange(e)},"planning.generator.started":function(e){e.date===this.plan.id&&(this.$msg=i.msg.show({type:"info",text:n("planning","MSG:GENERATING")}))},"planning.generator.finished":function(e){var t=this.$msg;t&&e.date===this.plan.id&&(i.msg.hide(t),this.$msg=null)},"orders.synced":function(){this.reloadOrders()},"orders.updated.*":function(e){var t=this.plan.lateOrders.get(e._id),n=e.change,i=n.newValues.delayReason,s=n.comment,a="undefined"!=typeof i;t&&a&&t.set("delayReason",i);var r=this.plan.sapOrders.get(e._id);if(r&&(s||a)){var o={};s&&(o.comments=[].concat(r.get("comments"),{time:n.time,user:n.user,text:s,delayReason:i})),a&&(o.delayReason=i),(s&&a||s&&(!r.get("comment")||!r.get("delayReason")))&&(o.comment=s),r.set(o)}},shiftChanged:function(e){this.plan.set("active",s.format(e.date,"YYYY-MM-DD")===this.plan.id)},"production.stateChanged.**":function(e){this.plan.shiftOrders.update(e)},"paintShop.orders.updated.*":function(e){var t=this.plan.sapOrders.get(e.order);t&&e.status&&t.set("psStatus",e.status)}},localTopics:{"socket.disconnected":function(){b=!0},"planning.mrpStatsRecounted":"scheduleStatRecount"},initialize:function(){this.$msg=null,this.defineModels(),this.defineViews(),this.defineBindings()},destroy:function(){t(document).off("."+this.idPrefix),t(window).off("."+this.idPrefix),d.unload()},setUpLayout:function(e){this.layout=e},defineModels:function(){var e=this,t=e.plan=new c({_id:e.options.date},{displayOptions:u.fromLocalStorage({mrps:e.options.mrps}),settings:h.fromDate(e.options.date),minMaxDates:!0,pceTimes:!1});e.delayReasons=new l;var n="MSG:LOADING_FAILURE:",i="planning";o(t,e,n+"plan",i),o(t.settings,e,n+"settings",i),o(t.lateOrders,e,n+"lateOrders",i),o(t.sapOrders,e,n+"sapOrders",i),o(t.shiftOrders,e,n+"shiftOrders",i),o(e.delayReasons,e,n+"delayReasons",i),o(d,e,n+"productionState",i),window.plan=t},defineViews:function(){this.filterView=new g({plan:this.plan}),this.setView("#-filter",this.filterView)},defineBindings:function(){var n=this,i=n.plan;n.listenTo(i,"sync",n.onPlanSynced),n.listenTo(i,"change:_id",n.onDateFilterChanged),n.listenTo(i.displayOptions,"change:mrps",n.onMrpsFilterChanged),n.listenTo(i.displayOptions,"change:wrapLists",n.onWrapListsChanged),n.listenTo(i.displayOptions,"change:useDarkerTheme",n.onDarkerThemeChanged),n.listenTo(i.displayOptions,"change:useLatestOrderData",n.updateUrl),n.listenTo(i.settings,"changed",n.onSettingsChanged),n.listenTo(i.settings,"errored",n.reload),n.listenTo(i.mrps,"reset",e.after(2,e.debounce(n.renderMrps.bind(n),1))),n.listenTo(i.sapOrders,"sync",n.onSapOrdersSynced),t(document).on("click."+n.idPrefix,".paintShop-breadcrumb",this.onBreadcrumbsClick.bind(this)),t(window).on("resize."+n.idPrefix,e.debounce(n.onWindowResize.bind(n),16)).on("keyup."+n.idPrefix,n.onWindowKeyUp.bind(n))},load:function(e){var t=this.plan,n=b;return b=!1,e(d.load(n),this.delayReasons.fetch({reset:!0}),t.settings.fetch(),t.shiftOrders.fetch({reset:!0}),t.sapOrders.fetch({reset:!0}),t.lateOrders.fetch({reset:!0}),t.fetch())},serialize:function(){return{idPrefix:this.idPrefix,wrap:this.plan.displayOptions.isListWrappingEnabled(),darker:this.plan.displayOptions.isDarkerThemeUsed()}},afterRender:function(){d.load(!1),this.renderMrps()},reload:function(){function e(){s.set("loading",!1),i.msg.loadingFailed()}var n=this,s=n.plan;s.set("loading",!0),n.promised(s.settings.set("_id",s.id).fetch()).then(function(){var i=t.when(s.shiftOrders.fetch({reset:!0,reload:!0}),s.sapOrders.fetch({reset:!0,reload:!0}),s.lateOrders.fetch({reset:!0,reload:!0}),s.fetch());n.promised(i).then(s.set.bind(s,"loading",!1),e)},e)},updateUrl:function(){var e=this.plan;this.broker.publish("router.navigate",{url:"/planning/plans/"+e.id+"?mrps="+e.displayOptions.get("mrps")+"&sapOrders="+(e.displayOptions.isLatestOrderDataUsed()?"1":"0"),replace:!0,trigger:!1})},renderMrps:function(){var e=this,t=e.plan.isAnythingLoading();e.removeView("#-mrps"),e.plan.mrps.forEach(function(n){var i=new f({delayReasons:e.delayReasons,prodLineStates:d.prodLineStates,plan:e.plan,mrp:n});e.insertView("#-mrps",i),t||i.render()}),this.$id("empty").toggleClass("hidden",e.plan.mrps.length>0),this.$id("mrps").toggleClass("hidden",0===e.plan.mrps.length),clearTimeout(this.timers.recountStats),this.recountStats()},reloadOrders:function(){this.promised(this.plan.lateOrders.fetch({reset:!0})),this.promised(this.plan.sapOrders.fetch({reset:!0}))},scheduleStatRecount:function(){this.timers.recountStats&&clearTimeout(this.timers.recountStats),this.timers.recountStats=setTimeout(this.recountStats.bind(this),10)},recountStats:function(){this.filterView.recountStats()},toggleLegend:function(e){return this.$legendPopover?(this.$legendPopover.popover("destroy"),void(this.$legendPopover=null)):(this.$legendPopover=t(e).popover({trigger:"manual",placement:"left",html:!0,content:y({}),template:'<div class="popover planning-legend-popover"><div class="popover-content"></div></div>'}),this.$legendPopover.one("hide.bs.popover",function(){e.classList.remove("active")}),this.$legendPopover.popover("show"),void e.classList.add("active"))},toggleLineOrdersList:function(){var e=this.$(".planning-mrp"),t=window.scrollY,n=null;if(e.length>1&&t>e[0].offsetTop&&(n=e[e.length-1],t+window.innerHeight<document.scrollingElement.scrollHeight))for(var i=0;i<e.length&&(n=e[i],!(t<n.offsetTop+125));++i);this.plan.displayOptions.toggleLineOrdersList(),n&&window.scrollTo(0,n.offsetTop-(e[0]===n?10:-1))},onBreadcrumbsClick:function(e){if("A"===e.target.tagName)return!e.target.classList.contains("disabled")&&("showPicker"===e.target.dataset.action?this.showDatePickerDialog():this.selectNonEmptyDate(e.target.dataset.action),!1)},showDatePickerDialog:function(){var e=new p({model:{date:this.plan.id}});this.listenTo(e,"picked",function(e){i.closeDialog(),e!==this.plan.id&&this.plan.set("_id",e)}),i.showDialog(e)},selectNonEmptyDate:function(e){t(".paintShop-breadcrumb").find("a").addClass("disabled");var a=this,r=+a.plan.getMoment().valueOf(),o=2592e6,l="/planning/plans/?limit(1)&select(_id)&orders>()";l+="prev"===e?"&sort(-_id)&_id<"+r+"&_id>"+(r-o):"&sort(_id)&_id>"+r+"&_id<"+(r+o);var d=a.ajax({url:l});d.done(function(e){e.totalCount?a.plan.set("_id",s.utc.format(e.collection[0]._id,"YYYY-MM-DD")):i.msg.show({type:"warning",time:2500,text:n("paintShop","MSG:date:empty")})}),d.fail(function(){i.msg.show({type:"error",time:2500,text:n("paintShop","MSG:date:failure")})}),d.always(function(){a.layout&&a.layout.setBreadcrumbs(a.breadcrumbs,a)})},onDateFilterChanged:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this)),this.updateUrl(),this.reload()},onMrpsFilterChanged:function(){this.updateUrl(),this.plan.mrps.reset()},onWrapListsChanged:function(){this.$el.toggleClass("wrap",this.plan.displayOptions.isListWrappingEnabled())},onDarkerThemeChanged:function(){this.$el.toggleClass("planning-darker",this.plan.displayOptions.isDarkerThemeUsed())},onPlanSynced:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this))},onSettingsChanged:function(e){e.reset&&this.plan.mrps.reset()},onSapOrdersSynced:function(){this.timers.reloadOrders&&clearTimeout(this.timers.reloadOrders),this.timers.reloadOrders=setTimeout(this.reloadOrders.bind(this),6e5)},onWindowResize:function(e){this.broker.publish("planning.windowResized",e)},onWindowKeyUp:function(e){27===e.keyCode?this.broker.publish("planning.escapePressed"):79!==e.keyCode&&90!==e.keyCode||"INPUT"===e.target.tagName||this.toggleLineOrdersList()}})});