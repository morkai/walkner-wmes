// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/core/View","app/core/util/bindLoadingMessage","app/core/templates/userInfo","app/planning/templates/change"],function(e,n,t,a,i,r,l){"use strict";return a.extend({layoutName:"page",breadcrumbs:function(){return[{label:n.bound("planning","BREADCRUMBS:base"),href:"#planning/plans"},{label:this.collection.getDate("LL"),href:"#planning/plans/"+this.collection.getDate("YYYY-MM-DD")},{label:n.bound("planning","BREADCRUMBS:changes")}]},remoteTopics:{"planning.changes.created":function(e){t.utc.format(e.plan,"X")===this.collection.getDate("X")&&this.collection.unshift(e)}},events:{"click .planning-change-hd":function(e){var n=this.$(e.currentTarget),t=n.parent().attr("data-type");t&&0===n.next()[0].childElementCount&&!n.hasClass("is-expanded")&&this.renderDetails(n.next(),t,this.collection.get(n.closest(".planning-change").attr("data-id")).get("data")[t]),n.toggleClass("is-expanded")}},initialize:function(){this.expanded={},this.collection=i(this.collection,this),this.listenTo(this.collection,"add",this.renderChange)},load:function(e){return e(this.collection.fetch({reset:!0}))},afterRender:function(){this.collection.forEach(this.renderChange,this)},renderChange:function(e){var a=e.get("data"),i=Object.keys(a).map(function(e){return{type:e,label:n("planning","changes:what:"+e,{count:a[e].length})}}),s={id:e.id,hd:n("planning","changes:hd",{when:t.format(e.get("date"),"LL LTS"),who:r({userInfo:e.get("user")||{label:"System"}}),what:i.map(function(e){return e.label}).join(", ")}),what:i};this.$el.append(l(s))},renderDetails:function(n,t,a){switch(t){case"removedOrders":this.renderRemovedOrders(n,a);break;case"changedLines":n.html(e.pluck(a,"_id").join("; "));break;default:n.html("<pre>"+JSON.stringify(a,null,2)+"</pre>")}},renderRemovedOrders:function(e,t){var a=t.map(function(e){var t="REQUIRED_STATUS"===e.reason?"success":"IGNORED_STATUS"===e.reason?"danger":"default",a=n("planning","changes:removedOrders:"+e.reason,e.data);return'<a class="label label-'+t+'" title="'+a+'" href="#orders/'+e._id+'" target="_blank">'+e._id+"</a> "});e.html(a.join(""))}})});