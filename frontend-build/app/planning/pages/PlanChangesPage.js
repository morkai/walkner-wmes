define(["underscore","app/i18n","app/time","app/core/View","app/core/util/bindLoadingMessage","app/core/templates/userInfo","app/orderStatuses/util/renderOrderStatusLabel","app/planning-orderGroups/OrderGroupCollection","app/planning/templates/change","app/planning/templates/orderPopover"],function(e,t,n,a,r,i,s,o,l,c){"use strict";return a.extend({layoutName:"page",breadcrumbs:function(){return[{label:this.t("BREADCRUMB:base"),href:"#planning/plans"},{label:this.collection.getDate("LL"),href:"#planning/plans/"+this.collection.getDate("YYYY-MM-DD")},{label:this.t("BREADCRUMB:changes")}]},actions:function(){return[{icon:"chevron-down",label:this.t("PAGE_ACTION:toggleChanges:expand"),callback:this.toggleChanges.bind(this,!0)},{icon:"chevron-up",label:this.t("PAGE_ACTION:toggleChanges:collapse"),callback:this.toggleChanges.bind(this,!1)}]},remoteTopics:{"planning.changes.created":function(e){n.utc.format(e.plan,"X")===this.collection.getDate("X")&&this.collection.unshift(e)}},events:{"click .planning-change-hd":function(e){var t=this.$(e.currentTarget),n=t.parent().attr("data-type");n&&0===t.next()[0].childElementCount&&!t.hasClass("is-expanded")&&this.renderDetails(t.next(),n,this.collection.get(t.closest(".planning-change").attr("data-id")).get("data")[n]),t.toggleClass("is-expanded")},"mouseenter .planning-change-addedOrder":function(e){var t=this.$(e.currentTarget),n=t.closest(".planning-change").attr("data-id"),a=t.attr("data-i"),r=this.collection.get(n).get("data").addedOrders[a];t.popover({trigger:"hover",html:!0,placement:"top",className:"planning-mrp-popover",content:c({order:{_id:r.id,nc12:r.nc12,name:r.name,kind:r.kind,incomplete:r.incomplete,quantityTodo:r.quantityTodo,quantityDone:r.quantityDone,quantityPlan:r.quantityPlan,statuses:r.statuses.map(s),manHours:r.manHours,laborTime:r.operation&&r.operation.laborTime||0,lines:r.lines||[]}})}).popover("show")},"mouseenter .planning-change-changedOrder":function(e){var t=this,n=t.$(e.currentTarget),a=n.closest(".planning-change").attr("data-id"),r=n.attr("data-i"),i=t.collection.get(a).get("data").changedOrders[r].changes,s="<table>";Object.keys(i).forEach(e=>{var n=t.formatValue(e,i[e][0]),a=t.formatValue(e,i[e][1]);s+="<tr><th>"+this.t("orders:"+e)+"</th><td>"+n+' <i class="fa fa-arrow-right"></i> '+("statuses"===e||"operation"===e?"<br>":"")+a+"</td></tr>"}),s+="</table>",n.popover({trigger:"hover",html:!0,placement:"top",className:"planning-mrp-popover",content:s}).popover("show")}},initialize:function(){this.expanded={},this.collection=r(this.collection,this),this.orderGroups=r(new o(null,{rqlQuery:"limit(0)&target=plan"}),this),this.listenTo(this.collection,"add",this.renderChange)},load:function(e){return e(this.orderGroups.fetch({reset:!0}),this.collection.fetch({reset:!0}))},afterRender:function(){this.collection.forEach(this.renderChange,this)},renderChange:function(e){var t=e.get("data"),a=Object.keys(t).map(e=>({type:e,label:this.t("changes:what:"+e,{count:t[e].length})})),r={id:e.id,hd:this.t("changes:hd",{when:n.format(e.get("date"),"LL LTS"),who:i(e.get("user")||{label:"System"}),what:a.map(e=>e.label).join(", ")}),what:a};this.$el.append(l(r))},renderDetails:function(t,n,a){switch(n){case"addedOrders":this.renderOrders("addedOrder",t,a);break;case"changedOrders":this.renderOrders("changedOrder",t,a);break;case"removedOrders":this.renderRemovedOrders(t,a);break;case"settings":this.renderSettings(t,a);break;case"changedLines":t.html(e.pluck(a,"_id").join("; "));break;default:t.html("<pre>"+JSON.stringify(a,null,2)+"</pre>")}},renderOrders:function(e,t,n){var a=n.map((t,n)=>'<a class="label label-default planning-change-'+e+'" href="#orders/'+t._id+'" target="_blank" data-i="'+n+'">'+t._id+"</a> ");t.html(a.join(""))},renderRemovedOrders:function(e,t){var n=t.map(e=>{return'<a class="label label-'+("REQUIRED_STATUS"===e.reason?"success":"IGNORED_STATUS"===e.reason?"danger":"default")+'" title="'+this.t(`changes:removedOrders:${e.reason}`,e.data)+'" href="#orders/'+e._id+'" target="_blank">'+e._id+"</a> "});e.html(n.join(""))},renderSettings:function(e,t){var n=["<ul>"];t.forEach(this.renderSetting.bind(this,n)),n.push("</ul>"),e.html(n.join(""))},renderSetting:function(e,t){switch(t.type){case"change":e.push('<li><i class="fa fa-minus planning-change-icon"></i> ',this.t("settings:"+t.property)+": ",this.formatValue(t.property,t.oldValue),' <i class="fa fa-arrow-right"></i> ',this.formatValue(t.property,t.newValue),"</li>");break;case"lines:change":case"mrps:change":case"mrpLines:change":e.push('<li><i class="fa fa-minus planning-change-icon"></i> ',this.t("changes:settings:"+t.type,{mrp:t.mrp&&t.mrp._id||t.mrp,line:t.line&&t.line._id||t.line,property:this.t("settings:"+t.property)}),this.formatValue(t.property,t.oldValue),' <i class="fa fa-arrow-right"></i> ',this.formatValue(t.property,t.newValue),"</li>");break;default:e.push('<li><i class="fa fa-minus planning-change-icon"></i> ',this.t("changes:settings:"+t.type,{mrp:t.mrp&&t.mrp._id||t.mrp,line:t.line&&t.line._id||t.line}),"</li>")}},formatValue:function(e,n){if(""===n||null==n)return"-";if("number"==typeof n)return n.toLocaleString();if("boolean"==typeof n)return t("core",`BOOL:${n}`);switch(e){case"kind":return this.t(`orderPriority:${n}`);case"source":return this.t(`orders:source:${n}`);case"orderPriority":return n.map(e=>this.t(`orderPriority:${e}`)).join("; ");case"statuses":case"ignoredStatuses":case"requiredStatuses":case"completedStatuses":return n.map(s).join(" ");case"lines":case"extraShiftSeconds":case"mrpPriority":case"linePriority":return 0===n.length?"-":n.join("; ");case"workerCount":return Array.isArray(n)?n.map(e=>e.toLocaleString()).join("; "):n.toLocaleString();case"operation":return n.no+". "+n.name+" - "+(n.laborTime||0).toLocaleString();case"groups":return n.length;case"activeTime":return 0===n.length?"06:00-06:00":n.map(e=>`${e.from}-${e.to}`).join(", ");case"orderGroupPriority":return n.map(e=>{var t=this.orderGroups.get(e);return t?t.getLabel():e}).join("; ");default:return String(n)}},toggleChanges:function(e){this.$(".planning-change-hd").each(function(){if(e){if(this.classList.contains("is-expanded"))return;this.click()}else this.classList.remove("is-expanded")})}})});