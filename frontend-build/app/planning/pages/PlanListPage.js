define(["jquery","app/time","app/core/View","app/core/util/bindLoadingMessage","../views/PlanListView"],function(t,e,a,o,i){"use strict";return a.extend({actions:[],breadcrumbs:function(){return[this.t("BREADCRUMB:base"),{href:"#planning/plans?month="+this.collection.month,label:e.getMoment(this.collection.month,"YYYY-MM").format("MMMM YYYY"),template:function(t){return'<span class="paintShop-breadcrumb is-variable-width"><a class="fa fa-chevron-left" data-action="prev"></a><a class="fa fa-chevron-right" data-action="next"></a><a href="'+t.href+'" data-action="showPicker">'+t.label+"</a></span>"}}]},initialize:function(){o(this.collection,this),this.view=new i({collection:this.collection}),this.listenTo(this.collection,"change:month",this.onMonthChange),t(window).on("mousedown."+this.idPrefix,this.onMouseDown.bind(this)).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)),t(document).on("click."+this.idPrefix,".paintShop-breadcrumb",this.onBreadcrumbsClick.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),t(document).off("."+this.idPrefix)},setUpLayout:function(t){this.layout=t},load:function(t){return t(this.collection.fetch({reset:!0}))},onMonthChange:function(){this.broker.publish("router.navigate",{url:"/planning/plans?month="+this.collection.month,trigger:!1,replace:!0}),this.promised(this.collection.fetch({reset:!0})),this.layout.setBreadcrumbs(this.breadcrumbs,this)},onBreadcrumbsClick:function(t){if("A"===t.target.tagName){if(t.target.classList.contains("disabled"))return!1;var e=t.target.dataset.action;return"showPicker"===e?this.showMonthPicker():"prev"===e?this.collection.prevMonth():"next"===e&&this.collection.nextMonth(),!1}},onMouseDown:function(e){t(e.target).closest(".paintShop-breadcrumb").length||this.hideMonthPicker()},onKeyDown:function(t){"Escape"===t.key&&this.hideMonthPicker()},showMonthPicker:function(){var e=this,a=t('.paintShop-breadcrumb > a[data-action="showPicker"]');a.next().hasClass("popover")?a.popover("destroy"):(a.popover({html:!0,trigger:"manual",placement:"bottom",className:"planning-list-monthPicker",content:function(){return e.buildMonthPicker(e.collection.month)}}),a.popover("show"),a.data("bs.popover").tip().on("click","a[data-action]",function(a){console.log(this);var o=a.currentTarget.dataset.action;switch(o){case"nextYear":case"prevYear":var i=e.collection.month.split("-");i[0]=this.dataset.year,t(this).closest(".popover-content").html(e.buildMonthPicker(i.join("-"),e.collection.month));break;default:e.collection.setMonth(o)}}))},buildMonthPicker:function(t){for(var a=+t.substr(0,4),o=+t.substr(5)-1,i='<table><tbody><tr><td><a href="javascript:void(0)" data-action="prevYear" data-year="'+(a-1)+'"><i class="fa fa-chevron-up"></i></a><td colspan="3">',n=e.getMoment(t,"YYYY-MM").startOf("year").subtract(2,"years"),r=0;r<4;++r){if(i+="<tr><td>",n.year()===a)i+=n.year();else{var s=o+1;s<10&&(s="0"+s),i+='<a href="javascript:void(0)" data-action="'+n.year()+"-"+s+'">'+n.year()+"</a>"}for(var c=0;c<3;++c)i+="<td>",n.month()===o?i+=n.format("MMMM"):i+='<a href="javascript:void(0)" data-action="'+a+"-"+n.format("MM")+'">'+n.format("MMMM")+"</a>",n.add(1,"months");n.add(1,"years")}return i+='<tr><td><a href="javascript:void(0)" data-action="nextYear" data-year="'+(a+1)+'"><i class="fa fa-chevron-down"></i></a><td colspan="3">',i+="</table>"},hideMonthPicker:function(){t('.paintShop-breadcrumb > a[data-action="showPicker"]').popover("destroy")}})});