define(["underscore","app/i18n","app/time","app/viewport","app/core/View","../PlanSettingsCollection","app/planning/templates/copySettingsDialog"],function(t,i,e,s,n,r,o){"use strict";return n.extend({template:o,events:{submit:function(){return this.submitForm(),!1},"click #-allMrps":function(){this.$id("mrps").select2("data",this.$id("mrps").data("select2").opts.data)}},initialize:function(){const t=e.getMoment();t.hours()<6&&t.subtract(1,"days"),t.startOf("day");const i=e.utc.getMoment(t.format("YYYY-MM-DD"),"YYYY-MM-DD").valueOf();this.plans=new r(null,{rqlQuery:`select(_id)&sort(_id)&_id>${i}`})},getTemplateData:function(){const t={mrpSettings:!1,lineGroups:!1,mrpPriority:!1,workerCount:!0,activeTime:!0};return this.model.settings.getVersion()>1&&Object.assign(t,{extraCapacity:!0,linePriority:!0,orderGroupPriority:!0}),t.orderPriority=!0,{source:this.model.getMoment().format("LL"),what:t}},afterRender:function(){this.loadTargetPlans(),this.setUpMrpsSelect2()},loadTargetPlans:function(){s.msg.loading();const t=this.$id("submit").prop("disabled",!0),i=this.$id("target").select2({data:[]}).select2("enable",!1),n=this.plans.fetch();n.done(n=>{s.msg.loaded(),i.select2({width:"100%",placeholder:this.t("copySettings:target:placeholder"),allowClear:!0,multiple:!0,data:(n.collection||[]).map(t=>({id:e.format(t._id,"YYYY-MM-DD"),text:e.format(t._id,"LL")})).filter(t=>t.id!==this.model.id)}),i.select2("enable",!0),t.prop("disabled",!1)}),n.fail(()=>{s.msg.loadingFailed()})},setUpMrpsSelect2:function(){this.$id("mrps").select2({width:"100%",placeholder:this.t("copySettings:mrps:placeholder"),allowClear:!0,multiple:!0,data:this.model.settings.mrps.map(t=>({id:t.id,text:t.id})).sort((t,i)=>t.text.localeCompare(i.text,void 0,{numeric:!0,ignorePunctuation:!0}))}),this.$('input[name="filter"][value="in"]').prop("checked",!0)},submitForm:function(){const i=this.model.settings.getVersion(),e={},n=this.$id("mrps").select2("val");let r=this.$id("target").select2("val");if(this.$('input[name="what[]"]').each(function(t,i){i.checked&&(e[i.value]=!0)}),0===r.length&&(r=this.$id("target").data("select2").opts.data.map(t=>t.id)),0===r.length)return void s.msg.show({type:"warning",time:2500,text:this.t("copySettings:target:empty")});if(t.isEmpty(e))return void s.msg.show({type:"warning",time:2500,text:this.t("copySettings:what:empty")});const o={mrps:{},lines:{},mrpLines:{}};n.forEach(t=>{const s=this.model.settings.mrps.get(t);o.mrps[t]=s.pick([e.linePriority&&i>1?"linePriority":null,e.lineGroups?"groups":null].concat(e.mrpSettings?["limitSmallOrders","extraOrderSeconds","extraShiftSeconds","smallOrderQuantity","bigOrderQuantity","splitOrderQuantity","maxSplitLineCount","hardOrderManHours","hardBigComponents","hardComponents"]:[]))}),this.model.settings.lines.forEach(s=>{t.intersection(s.get("mrpPriority"),n).length&&(o.lines[s.id]=s.pick([e.mrpPriority?"mrpPriority":null,e.orderPriority&&i>1?"orderPriority":null,e.orderGroupPriority&&i>1?"orderGroupPriority":null,e.workerCount&&i>1?"workerCount":null,e.activeTime?"activeTime":null,e.extraCapacity&&i>1?"extraCapacity":null]))}),1===i&&this.model.settings.mrps.forEach(t=>{o.mrps[t.id]&&t.lines.forEach(i=>{o.lines[i.id]&&(o.mrpLines[t.id+":"+i.id]=i.pick([e.workerCount?"workerCount":null,e.orderPriority?"orderPriority":null]))})}),this.$id("submit").prop("disabled",!0).find(".fa-spinner").removeClass("hidden"),this.copyNext(r,o)},copyNext:function(t,i){const e=t.shift();e?this.fetchSettings(e,s=>{s.lines.forEach(t=>{Object.assign(t,i.lines[t._id])}),s.mrps.forEach(t=>{Object.assign(t,i.mrps[t._id]),t.lines.forEach(e=>{Object.assign(e,i.mrpLines[t._id+":"+e._id])})}),this.saveSettings(e,s,this.copyNext.bind(this,t,i))}):s.closeDialog()},fetchSettings:function(t,i){s.msg.loading();const e=this.ajax({url:`/planning/settings/${t}`});e.done(t=>{s.msg.loaded(),i(t)}),e.fail(function(){s.msg.loadingFailed(),this.fail()})},saveSettings:function(t,i,e){s.msg.saving();const n=this.ajax({method:"PUT",url:`/planning/settings/${t}`,data:JSON.stringify(i)});n.done(()=>{s.msg.saved(),e()}),n.fail(function(){s.msg.savingFailed(),this.fail()})},fail:function(){this.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")}})});