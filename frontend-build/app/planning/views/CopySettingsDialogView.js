define(["underscore","app/i18n","app/time","app/viewport","app/core/View","../PlanSettingsCollection","app/planning/templates/copySettingsDialog"],function(t,i,e,n,s,a,o){"use strict";return s.extend({template:o,events:{submit:function(){return this.submitForm(),!1}},initialize:function(){var t=e.getMoment();t.hours()<6&&t.subtract(1,"days"),t.startOf("day"),this.plans=new a(null,{rqlQuery:"select(_id)&sort(_id)&_id>"+e.utc.getMoment(t.format("YYYY-MM-DD"),"YYYY-MM-DD").valueOf()})},getTemplateData:function(){return{source:this.model.getMoment().format("LL")}},afterRender:function(){this.loadTargetPlans(),this.setUpMrpsSelect2()},loadTargetPlans:function(){var t=this;n.msg.loading(),t.$id("submit").prop("disabled",!0),t.$id("target").select2({data:[]}).select2("enable",!1);var i=t.plans.fetch();i.done(function(i){n.msg.loaded(),t.$id("target").select2({width:"100%",placeholder:t.t("copySettings:target:all"),allowClear:!0,multiple:!0,data:(i.collection||[]).map(function(t){return{id:e.format(t._id,"YYYY-MM-DD"),text:e.format(t._id,"LL")}}).filter(function(i){return i.id!==t.model.id})}).select2("enable",!0),t.$id("submit").prop("disabled",!1)}),i.fail(function(){n.msg.loadingFailed()})},setUpMrpsSelect2:function(){this.$id("mrps").select2({width:"100%",placeholder:this.t("copySettings:mrps:all"),allowClear:!0,multiple:!0,data:this.model.settings.mrps.map(function(t){return{id:t.id,text:t.id}}).sort(function(t,i){return t.text.localeCompare(i.text,void 0,{numeric:!0,ignorePunctuation:!0})})}),this.$('input[name="filter"][value="in"]').prop("checked",!0)},submitForm:function(){var i=this.$id("target").select2("val"),e=this.$('input[name="filter"]:checked').val(),s=this.$id("mrps").select2("val"),a={};if(this.$('input[name="what[]"]').each(function(){this.checked&&(a[this.value]=!0)}),0===i.length&&(i=this.$id("target").data("select2").opts.data.map(function(t){return t.id})),0===s.length&&(s=this.$id("mrps").data("select2").opts.data.map(function(t){return t.id})),0!==i.length)if(t.isEmpty(a))n.msg.show({type:"warning",time:3e3,text:this.t("copySettings:what:empty")});else{var o={mrps:{},lines:{},mrpLines:{}};"in"===e?s.forEach(function(t){o.mrps[t]=!0}):this.model.settings.mrps.forEach(function(t){-1===s.indexOf(t.id)&&(o.mrps[t.id]=!0)}),0!==(s=Object.keys(o.mrps)).length?(this.model.settings.lines.forEach(function(i){t.intersection(i.get("mrpPriority"),s).length&&(o.lines[i.id]=i.pick([a.activeTime?"activeTime":null]))}),this.model.settings.mrps.forEach(function(t){o.mrps[t.id]&&t.lines.forEach(function(i){o.lines[i.id]&&(o.mrpLines[t.id+":"+i.id]=i.pick([a.workerCount?"workerCount":null,a.orderPriority?"orderPriority":null]))})}),this.$id("submit").prop("disabled",!0).find(".fa-spinner").removeClass("hidden"),this.copyNext(i,o)):n.msg.show({type:"warning",time:3e3,text:this.t("copySettings:mrps:empty")})}else n.msg.show({type:"warning",time:3e3,text:this.t("copySettings:target:empty")})},copyNext:function(i,e){var s=this,a=i.shift();a?s.fetchSettings(a,function(n){n.lines.forEach(function(i){t.assign(i,e.lines[i._id])}),n.mrps.forEach(function(i){i.lines.forEach(function(n){t.assign(n,e.mrpLines[i._id+":"+n._id])})}),s.saveSettings(a,n,s.copyNext.bind(s,i,e))}):n.closeDialog()},fetchSettings:function(t,i){n.msg.loading();var e=this,s=e.ajax({url:"/planning/settings/"+t});s.done(function(t){n.msg.loaded(),i(t)}),s.fail(function(){n.msg.loadingFailed(),e.fail()})},saveSettings:function(t,i,e){n.msg.saving();var s=this,a=s.ajax({method:"PUT",url:"/planning/settings/"+t,data:JSON.stringify(i)});a.done(function(){n.msg.saved(),e()}),a.fail(function(){n.msg.savingFailed(),s.fail()})},fail:function(){this.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")}})});