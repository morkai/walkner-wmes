// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","Sortable","app/i18n","app/viewport","app/core/View","app/planning/templates/linesOrderPriorityDialog"],function(e,i,t,r,n,s,o){"use strict";return s.extend({template:o,events:{submit:function(){return this.submitForm(),!1}},initialize:function(){this.sortables=[]},destroy:function(){this.destroySortables()},destroySortables:function(){e.invoke(this.sortables,"destroy"),this.sortables=[]},serialize:function(){var e=this;return{idPrefix:e.idPrefix,lines:e.mrp.lines.map(function(i){var t=i.mrpSettings(e.mrp.id);return{_id:i.id,orderPriority:t?t.get("orderPriority").join(","):""}})}},afterRender:function(){var e=this;e.$("input[data-line-id]").each(function(){e.setUpOrderPriority(e.$(this))})},setUpOrderPriority:function(e){e.select2({allowClear:!0,multiple:!0,data:[{id:"small",text:r("planning","orderPriority:small")},{id:"easy",text:r("planning","orderPriority:easy")},{id:"hard",text:r("planning","orderPriority:hard")}]}),this.sortables.push(new t(e.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){e.select2("onSortStart")},onEnd:function(){e.select2("onSortEnd").select2("focus")}}))},submitForm:function(){var e=this,i=e.$id("submit").prop("disabled",!0),t=i.find(".fa-spinner").removeClass("hidden"),s=e.plan.settings;e.$("input[data-line-id]").each(function(){var i=e.mrp.lines.get(this.dataset.lineId);if(i){var t=i.mrpSettings(e.mrp.id),r=this.value;t&&r.length&&t&&t.set("orderPriority",r.split(","))}});var o=s.save();o.done(n.closeDialog),o.fail(function(){t.addClass("hidden"),i.prop("disabled",!1),n.msg.show({type:"error",time:3e3,text:r("planning","lines:menu:orderPriority:failure")}),e.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});