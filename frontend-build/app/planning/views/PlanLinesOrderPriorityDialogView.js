define(["underscore","jquery","Sortable","app/viewport","app/core/View","app/core/util/resultTips","app/planning/templates/linesOrderPriorityDialog"],function(t,e,i,s,r,n,a){"use strict";return r.extend({template:a,modelProperty:"plan",events:{submit:function(){return this.submitForm(),!1},'click a[data-action="copy"]':function(t){this.copyData=this.$(t.target).closest(".form-group").find("input").select2("data"),n.showCopied({e:t})},'click a[data-action="paste"]':function(t){this.$(t.target).closest(".form-group").find("input").select2("data",this.copyData).trigger("change")}},initialize:function(){this.copyData=[]},destroy:function(){this.destroySortables()},destroySortables:function(){this.$("input[data-line-id]").each((t,e)=>{const i=this.$(e);i.data("sortable").destroy(),i.removeData("sortable")})},getTemplateData:function(){const t=this.plan.settings.getVersion();return{lines:this.mrp.getSortedLines().map(e=>{const i=1===t?e.mrpSettings(this.mrp.id):e.settings;return{_id:e.id,orderPriority:i?i.get("orderPriority").join(","):""}})}},afterRender:function(){this.$("input[data-line-id]").each((t,e)=>{this.setUpOrderPriority(this.$(e))})},setUpOrderPriority:function(t){t.select2({allowClear:!0,multiple:!0,data:this.plan.settings.getAvailableOrderPriorities().map(t=>({id:t,text:this.t(`orderPriority:${t}`)}))});let e=t.data("sortable");e&&e.destroy(),e=new i(t.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:()=>{t.select2("onSortStart")},onEnd:()=>{t.select2("onSortEnd").select2("focus")}}),t.data("sortable",e)},submitForm:function(){const t=this.$id("submit").prop("disabled",!0),e=t.find(".fa-spinner").removeClass("hidden"),i=this.plan.settings,r=i.getVersion();this.$("input[data-line-id]").each((t,e)=>{const i=this.mrp.lines.get(e.dataset.lineId);if(!i)return;const s=1===r?i.mrpSettings(this.mrp.id):i.settings;if(!s)return;const n=e.value.split(",").filter(t=>!!t);s.set("orderPriority",n)}),s.msg.saving();const n=i.save();n.done(()=>{s.msg.saved(),s.closeDialog()}),n.fail(()=>{e.addClass("hidden"),t.prop("disabled",!1),s.msg.savingFailed(),this.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});