define(["underscore","jquery","Sortable","app/i18n","app/viewport","app/core/View","app/planning/templates/linesOrderPriorityDialog"],function(t,e,i,s,r,n,o){"use strict";return n.extend({template:o,modelProperty:"plan",events:{submit:function(){return this.submitForm(),!1}},initialize:function(){this.sortables=[]},destroy:function(){this.destroySortables()},destroySortables:function(){t.invoke(this.sortables,"destroy"),this.sortables=[]},getTemplateData:function(){const t=this.plan.settings.getVersion();return{lines:this.mrp.getSortedLines().map(e=>{const i=1===t?e.mrpSettings(this.mrp.id):e.settings;return{_id:e.id,orderPriority:i?i.get("orderPriority").join(","):""}})}},afterRender:function(){this.$("input[data-line-id]").each((t,e)=>{this.setUpOrderPriority(this.$(e))})},setUpOrderPriority:function(t){t.select2({allowClear:!0,multiple:!0,data:this.plan.settings.getAvailableOrderPriorities().map(t=>({id:t,text:this.t(`orderPriority:${t}`)}))}),this.sortables.push(new i(t.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:()=>{t.select2("onSortStart")},onEnd:()=>{t.select2("onSortEnd").select2("focus")}}))},submitForm:function(){const t=this.$id("submit").prop("disabled",!0),e=t.find(".fa-spinner").removeClass("hidden"),i=this.plan.settings,s=i.getVersion();this.$("input[data-line-id]").each((t,e)=>{const i=this.mrp.lines.get(e.dataset.lineId);if(!i)return;const r=1===s?i.mrpSettings(this.mrp.id):i.settings;if(!r)return;const n=e.value.split(",").filter(t=>!!t);r.set("orderPriority",n)}),r.msg.saving();var n=i.save();n.done(()=>{r.msg.saved(),r.closeDialog()}),n.fail(()=>{e.addClass("hidden"),t.prop("disabled",!1),r.msg.savingFailed(),this.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});