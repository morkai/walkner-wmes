define(["underscore","jquery","app/i18n","app/time","app/core/View","app/core/util/idAndLabel","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/whFilter","app/core/util/ExpandableSelect"],function(e,t,a,s,i,n,l,p,r){"use strict";return i.extend({template:r,events:{"input #-date":"changeFilter","change #-date":"changeFilter","change #-mrps":"changeFilter","change #-lines":"changeFilter","change #-whStatuses":"changeFilter","change #-psStatuses":"changeFilter","change #-from":"changeFilter","change #-to":"changeFilter","click #-useDarkerTheme":function(){this.plan.displayOptions.toggleDarkerThemeUse()},'change input[name="mrpMode"]':function(){this.toggleMrpsSelect2(),this.changeFilter()}},initialize:function(){this.stats={};var e=this.plan,t=e.displayOptions;this.listenTo(e,"change:loading",this.onLoadingChanged),this.listenTo(e,"change:_id",this.onDateChanged),this.listenTo(t,"change:minDate change:maxDate",this.onMinMaxDateChanged),this.listenTo(t,"change:useDarkerTheme",this.updateToggles)},destroy:function(){this.$(".is-expandable").expandableSelect("destroy")},getTemplateData:function(){var t=this.plan,a=t.displayOptions,s="1",i=[].concat(a.get("mrps"));switch(i[0]){case"1":i.shift();break;case"0":s="0",i.shift();break;case"mine":case"wh":s=i[0],i=[]}return e.assign({date:t.id,minDate:a.get("minDate"),maxDate:a.get("maxDate"),mrps:i,lines:a.get("lines"),whStatuses:a.get("whStatuses"),psStatuses:a.get("psStatuses"),mrpMode:s,from:a.get("from"),to:a.get("to"),useDarkerTheme:a.isDarkerThemeUsed()})},afterRender:function(){p(this.$id("mrps"),{width:"450px",placeholder:a("planning","filter:mrps:placeholder"),sortable:!0,own:!1,view:this}),this.$id("lines").select2({width:"300px",placeholder:" ",allowClear:!0,multiple:!0,data:l.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(n)}),this.$(".is-expandable").expandableSelect(),this.toggleMrpsSelect2(),this.updateStats()},updateToggles:function(){this.$id("useDarkerTheme").toggleClass("active",this.plan.displayOptions.isDarkerThemeUsed())},toggleMrpsSelect2:function(){var e=this.$('[name="mrpMode"]:checked').val(),t="1"===e||"0"===e,s=this.$id("mrps").select2("enable",t);t?(s.attr("placeholder",a("planning","filter:mrps:placeholder")),""===s.val()&&s.select2("val","")):s.attr("placeholder",a("planning","filter:mrps:"+e)).select2("val","")},changeFilter:function(){var t=this,a=t.$id("whStatuses"),s=t.$id("psStatuses"),i=t.$id("date").val(),n={mrps:t.$id("mrps").val().split(",").filter(function(e){return e.length>0}),lines:t.$id("lines").val().split(",").filter(function(e){return e.length>0}),whStatuses:a.val(),psStatuses:s.val(),from:t.$id("from").val()||"06:00",to:t.$id("to").val()||"06:00"};switch(n.whStatuses&&n.whStatuses.length!==a[0].options.length||(n.whStatuses=[]),n.psStatuses&&n.psStatuses.length!==s[0].options.length||(n.psStatuses=[]),t.$('[name="mrpMode"]:checked').val()){case"1":n.mrps.unshift("1");break;case"0":n.mrps.unshift("0");break;case"mine":n.mrps=["mine"];break;case"wh":n.mrps=["wh"]}var l={};["mrps","lines","whStatuses","psStatuses","from","to"].forEach(function(a){e.isEqual(n[a],t.plan.displayOptions.get(a))||(l[a]=n[a])}),e.isEmpty(l)||t.plan.displayOptions.set(l),/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(i)&&i!==t.plan.id&&t.plan.set("_id",i)},onLoadingChanged:function(){var e=this,t=e.plan.get("loading");["date","whStatuses","psStatuses","from","to"].forEach(function(a){e.$id(a).prop("disabled",t)}),e.$id("mrps").select2("enable",!t),e.$id("lines").select2("enable",!t)},onDateChanged:function(){this.$id("date").val(this.plan.id)},onMinMaxDateChanged:function(){this.$id("date").prop("min",this.plan.displayOptions.get("minDate")).prop("max",this.plan.displayOptions.get("maxDate"))},updateStats:function(t){t&&(this.stats=t);var a=this.$id("stats");a.length&&e.forEach(this.stats,function(e,t){a.find('.planning-wh-stats-v[data-status="'+t+'"]').text(e.toLocaleString())})},updateStat:function(e,t){e!==t&&(this.stats[e]-=1,this.stats[t]+=1,this.updateStats())}})});