define(["underscore","jquery","app/i18n","app/time","app/core/View","app/core/util/idAndLabel","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/whFilter","app/core/util/ExpandableSelect"],function(e,t,a,i,s,n,l,p,r){"use strict";return s.extend({template:r,events:{"input #-date":"changeFilter","change #-date":"changeFilter","change #-mrps":"changeFilter","change #-lines":"changeFilter","change #-whStatuses":"changeFilter","click #-useDarkerTheme":function(){this.plan.displayOptions.toggleDarkerThemeUse()},'change input[name="mrpMode"]':function(){this.toggleMrpsSelect2(),this.changeFilter()}},initialize:function(){this.stats={};var e=this.plan,t=e.displayOptions;this.listenTo(e,"change:loading",this.onLoadingChanged),this.listenTo(e,"change:_id",this.onDateChanged),this.listenTo(t,"change:minDate change:maxDate",this.onMinMaxDateChanged),this.listenTo(t,"change:useDarkerTheme",this.updateToggles)},destroy:function(){this.$(".is-expandable").expandableSelect("destroy")},serialize:function(){var t=this.plan,a=t.displayOptions,i="1",s=[].concat(a.get("mrps"));switch(s[0]){case"1":s.shift();break;case"0":i="0",s.shift();break;case"mine":case"wh":i=s[0],s=[]}return e.assign({idPrefix:this.idPrefix,date:t.id,mrps:s,lines:a.get("lines"),whStatuses:a.get("whStatuses"),mrpMode:i,minDate:a.get("minDate"),maxDate:a.get("maxDate"),useDarkerTheme:a.isDarkerThemeUsed()})},afterRender:function(){p(this.$id("mrps"),{width:"600px",placeholder:a("planning","filter:mrps:placeholder"),sortable:!0,own:!1,view:this}),this.$id("lines").select2({width:"300px",placeholder:" ",allowClear:!0,multiple:!0,data:l.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(n)}),this.$(".is-expandable").expandableSelect(),this.toggleMrpsSelect2(),this.updateStats()},updateToggles:function(){this.$id("useDarkerTheme").toggleClass("active",this.plan.displayOptions.isDarkerThemeUsed())},toggleMrpsSelect2:function(){var e=this.$('[name="mrpMode"]:checked').val(),t="1"===e||"0"===e,i=this.$id("mrps").select2("enable",t);t?(i.attr("placeholder",a("planning","filter:mrps:placeholder")),""===i.val()&&i.select2("val","")):i.attr("placeholder",a("planning","filter:mrps:"+e)).select2("val","")},changeFilter:function(){var t=this,a=t.$id("date").val(),i={mrps:t.$id("mrps").val().split(",").filter(function(e){return e.length>0}),lines:t.$id("lines").val().split(",").filter(function(e){return e.length>0}),whStatuses:t.$id("whStatuses").val()};switch(i.whStatuses&&4!==i.whStatuses.length||(i.whStatuses=[]),t.$('[name="mrpMode"]:checked').val()){case"1":i.mrps.unshift("1");break;case"0":i.mrps.unshift("0");break;case"mine":i.mrps=["mine"];break;case"wh":i.mrps=["wh"]}var s={};["mrps","lines","whStatuses"].forEach(function(a){e.isEqual(i[a],t.plan.displayOptions.get(a))||(s[a]=i[a])}),e.isEmpty(s)||t.plan.displayOptions.set(s),/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(a)&&a!==t.plan.id&&t.plan.set("_id",a)},onLoadingChanged:function(){var e=this.plan.get("loading");this.$id("date").prop("disabled",e),this.$id("mrps").select2("enable",!e),this.$id("lines").select2("enable",!e)},onDateChanged:function(){this.$id("date").val(this.plan.id)},onMinMaxDateChanged:function(){this.$id("date").prop("min",this.plan.displayOptions.get("minDate")).prop("max",this.plan.displayOptions.get("maxDate"))},updateStats:function(t){t&&(this.stats=t);var a=this.$id("stats");a.length&&e.forEach(this.stats,function(e,t){a.find('.planning-wh-stats-v[data-status="'+t+'"]').text(e.toLocaleString())})},updateStat:function(e,t){e!==t&&(this.stats[e]-=1,this.stats[t]+=1,this.updateStats())}})});