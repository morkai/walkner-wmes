// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/user","app/core/View","app/core/views/DialogView","app/data/orgUnits","app/orderStatuses/util/renderOrderStatusLabel","../util/scrollIntoView","../util/contextMenu","./PlanOrderQuantityDialogView","app/planning/templates/orders","app/planning/templates/orderPopover","app/planning/templates/orderIgnoreDialog"],function(e,i,t,r,n,o,s,a,d,p,l,h,u,g,c){"use strict";return o.extend({template:u,events:{"mouseenter .is-order":function(e){this.mrp.orders.trigger("highlight",{source:"orders",state:!0,orderNo:e.currentTarget.dataset.id})},"mouseleave .is-order":function(e){this.mrp.orders.trigger("highlight",{source:"orders",state:!1,orderNo:e.currentTarget.dataset.id})},"click .is-order":function(e){if(0===e.button){var i=e.currentTarget.dataset.id;if(e.ctrlKey)return void window.open("#orders/"+i);this.mrp.orders.trigger("preview",{orderNo:i})}},"contextmenu .is-order":function(e){return this.showMenu(e),!1}},localTopics:{"planning.windowResized":"resize","planning.escapePressed":function(){this.hidePreview(),this.hideMenu()},"planning.contextMenu.shown":"hidePreview"},initialize:function(){var e=this,i=e.mrp,t=e.plan;e.$preview=null,e.listenTo(i.orders,"added changed",e.onOrdersChanged),e.listenTo(i.orders,"removed",e.onOrdersRemoved),e.listenTo(i.orders,"highlight",e.onOrderHighlight),e.listenTo(i.orders,"preview",e.onOrderPreview),e.listenTo(t.displayOptions,"change:useLatestOrderData",e.render),e.listenTo(t.sapOrders,"reset",e.onSapOrdersReset)},destroy:function(){this.$preview&&(this.$preview.popover("destroy"),this.$preview=null),this.$el.popover("destroy")},serialize:function(){var e=this.plan;return{idPrefix:this.idPrefix,orders:this.mrp.orders.map(function(i){var t=e.getActualOrderData(i.id);return{_id:i.id,kind:i.get("kind"),incomplete:i.get("incomplete")>0,completed:t.quantityDone>=t.quantityTodo,surplus:t.quantityDone>t.quantityTodo,invalid:!1,ignored:i.get("ignored"),confirmed:t.statuses.indexOf("CNF")!==-1,delivered:t.statuses.indexOf("DLV")!==-1,customQuantity:i.get("quantityPlan")>0}})}},afterRender:function(){var e=this;if(e.$el.popover({container:e.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){if(!e.$preview||e.$preview.data("orderNo")!==this.dataset.id)return e.serializePopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}),e.$popover){var i=e.$popover.data("orderNo");e.hidePreview(),e.showPreview(i)}e.$id("list").on("scroll",function(i){e.$id("scrollIndicator").toggleClass("hidden",i.target.scrollLeft<=40),e.hidePreview()}),e.resize()},resize:function(){var e=this.$id("edit"),i=this.$id("scrollIndicator"),t=e.position();i.css({top:t.top+1+"px",left:e.outerWidth()+t.left+"px"}),this.$preview&&this.$preview.popover("show"),l.hide(this)},$item:function(e){return e?this.$('.planning-mrp-list-item[data-id="'+e+'"]'):this.$(".planning-mrp-list-item")},serializePopover:function(e){var i=this.plan.orders.get(e);if(!i)return null;var t=this.plan.getActualOrderData(i.id),r=i.get("operation");return g({order:{_id:i.id,nc12:i.get("nc12"),name:i.get("name"),kind:i.get("kind"),incomplete:i.get("incomplete"),completed:t.quantityDone>=t.quantityTodo,surplus:t.quantityDone>t.quantityTodo,quantityTodo:t.quantityTodo,quantityDone:t.quantityDone,quantityPlan:i.get("quantityPlan"),ignored:i.get("ignored"),statuses:t.statuses.map(d),manHours:i.get("manHours"),laborTime:r&&r.laborTime?r.laborTime:0}})},hidePreview:function(){this.$preview&&(this.$preview.popover("hide"),this.$preview=null)},showPreview:function(e){var i=this;i.$preview=i.$item(e.id).find(".planning-mrp-list-item-inner").data("orderNo",e.id).popover({container:i.el,trigger:"manual",placement:"top",html:!0,content:i.serializePopover(e.id),template:'<div class="popover planning-mrp-popover planning-mrp-popover-preview"><div class="arrow"></div><div class="popover-content"></div></div>'}),i.$preview.one("hidden.bs.popover",function(){i.$preview&&i.$preview.data("orderNo")===e.id&&(i.$preview.popover("destroy"),i.$preview=null)}),i.$preview.data("bs.popover").tip().on("click",function(){""===window.getSelection().toString()&&i.hidePreview()}),i.$preview.popover("show")},hideMenu:function(){l.hide(this)},showMenu:function(e){if(this.plan.isEditable()&&n.isAllowedTo("PLANNING:PLANNER","PLANNING:MANAGE")){var i=this.mrp.orders.get(this.$(e.currentTarget).attr("data-id"));l.show(this,e.pageY,e.pageX,[{label:t("planning","orders:menu:details"),handler:this.handleDetailsAction.bind(this,i)},{label:t("planning","orders:menu:quantity"),handler:this.handleQuantityAction.bind(this,i)},{label:t("planning","orders:menu:"+(i.get("ignored")?"unignore":"ignore")),handler:this.handleIgnoreAction.bind(this,i)}])}},handleDetailsAction:function(e){window.open("#orders/"+e.id)},handleQuantityAction:function(e){var i=new h({plan:this.plan,mrp:this.mrp,order:e});r.showDialog(i,t("planning","orders:menu:quantity:title"))},handleIgnoreAction:function(e){var i=this,n=new s({autoHide:!1,template:c,model:{action:e.get("ignored")?"unignore":"ignore",plan:i.plan.getLabel(),mrp:i.mrp.getLabel(),order:e.getLabel()}});i.listenTo(n,"answered",function(){var o=i.ajax({method:"POST",url:"/planning/plans/"+i.plan.id+"/orders/"+e.id,data:JSON.stringify({ignored:!e.get("ignored")})});o.done(n.closeDialog),o.fail(function(){r.msg.show({type:"error",time:3e3,text:t("planning","orders:menu:ignore:failure")}),i.plan.settings.trigger("errored"),n.enableAnswers()})}),r.showDialog(n,t("planning","orders:menu:ignore:title"))},onOrdersChanged:function(){this.render()},onOrdersRemoved:function(e){var i=this;e.forEach(function(e){i.$item(e.id).remove()})},onOrderHighlight:function(e){var i=this.$('.is-order[data-id="'+e.orderNo+'"]').toggleClass("is-highlighted",e.state);"orders"===e.source||this.plan.displayOptions.isListWrappingEnabled()||(this.hidePreview(),p(i[0]))},onOrderPreview:function(e){var t=this.mrp.orders.get(e.orderNo);if(t){if(this.$preview){var r=this.$preview.data("orderNo");if(this.hidePreview(),t.id===r)return}if(e.scrollIntoView){var n=this.$el.position().top-180;i("html, body").animate({scrollTop:n},"fast","swing",this.showPreview.bind(this,t))}else this.showPreview(t)}},onSapOrdersReset:function(e,i){!i.reload&&this.plan.displayOptions.isLatestOrderDataUsed()&&this.render()}})});