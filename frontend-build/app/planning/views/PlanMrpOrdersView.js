// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/data/orgUnits","app/orderStatuses/util/renderOrderStatusLabel","app/planning/templates/orders","app/planning/templates/orderPopover"],function(e,t,i,n,r,o,s){"use strict";return i.extend({template:o,events:{},initialize:function(){this.onResize=e.debounce(this.resize.bind(this),16),this.listenTo(this.mrp.orders,"added changed",this.render),this.listenTo(this.mrp.orders,"removed",this.onOrdersRemoved),t(window).on("resize."+this.idPrefix,this.onResize)},destroy:function(){t(window).off("."+this.idPrefix),this.$el.popover("destroy")},serialize:function(){return{idPrefix:this.idPrefix,orders:this.mrp.orders.map(function(e){return{_id:e.id,kind:e.get("kind"),incomplete:e.get("incomplete")>0,completed:e.get("quantityDone")>=e.get("quantityTodo"),surplus:e.get("quantityDone")>e.get("quantityTodo"),invalid:!1,ignored:e.get("ignored"),confirmed:e.get("statuses").indexOf("CNF")!==-1,delivered:e.get("statuses").indexOf("DLV")!==-1,customQuantity:e.get("quantityPlan")>0}})}},afterRender:function(){var e=this;e.$id("list").on("scroll",function(t){e.$id("scrollIndicator").toggleClass("hidden",t.target.scrollLeft<=40)}),e.resize(),e.$el.popover({container:e.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){return e.serializePopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},resize:function(){var e=this.$id("edit"),t=this.$id("scrollIndicator"),i=e.position();t.css({top:i.top+1+"px",left:e.outerWidth()+i.left+"px"})},$item:function(e){return e?this.$('.planning-mrp-list-item[data-id="'+e+'"]'):this.$(".planning-mrp-list-item")},serializePopover:function(e){var t=this.plan.orders.get(e),i=t.get("quantityTodo"),n=t.get("quantityDone"),o=t.get("quantityPlan"),d=t.get("operation");return s({order:{_id:t.id,nc12:t.get("nc12"),name:t.get("name"),kind:t.get("kind"),completed:n>=i,surplus:n>i,quantityTodo:i,quantityDone:n,quantityPlan:o,ignored:t.get("ignored"),statuses:t.get("statuses").map(r),manHours:t.get("manHours"),laborTime:d&&d.laborTime?d.laborTime:0}})},onOrdersRemoved:function(e){var t=this;e.forEach(function(e){t.$item(e.id).remove()})}})});