define(["underscore","select2","Sortable","app/viewport","app/core/View","app/core/util/idAndLabel","app/core/util/resultTips","app/data/clipboard","app/planning/templates/linesOrderGroupPriorityDialog"],function(t,e,i,r,a,s,o,n,l){"use strict";return a.extend({template:l,modelProperty:"plan",events:{submit:function(){return this.submitForm(),!1},"change input":function(){r.adjustDialogBackdrop()},'click a[data-action="copy"]':function(t){this.copyData=this.$(t.target).closest(".form-group").find("input").select2("data"),o.showCopied({e:t})},'click a[data-action="paste"]':function(t){this.$(t.target).closest(".form-group").find("input").select2("data",this.copyData).trigger("change")}},initialize:function(){this.sortables=[],this.copyData=[]},destroy:function(){this.destroySortables()},destroySortables:function(){var t=this;t.$("input[data-line-id]").each(function(){var e=t.$(this);e.data("sortable").destroy(),e.removeData("sortable")})},getTemplateData:function(){return{lines:this.mrp.getSortedLines().map(function(t){return{_id:t.id,orderGroupPriority:(t.settings.get("orderGroupPriority")||[]).join(",")}})}},afterRender:function(){var t=this;t.$("input[data-line-id]").each(function(){t.setUpOrderGroupPriority(t.$(this))})},setUpOrderGroupPriority:function(r){const a=this.mrp.lines.get(r[0].dataset.lineId).settings.get("mrpPriority"),s=this.orderGroups.map(e=>{const i=e.get("mrp")||[];return{id:e.id,text:e.getLabel(),mrps:i,search:(e.getLabel()+" "+i.join(" ")).trim().toUpperCase(),hasLineMrps:t.intersection(i,a).length>0,model:e}});s.sort((t,e)=>t.model.isNoMatchGroup()?-1:e.model.isNoMatchGroup()?1:t.hasLineMrps===e.hasLineMrps?t.text.localeCompare(e.text,void 0,{numeric:!0,ignorePunctuation:!0}):t.hasLineMrps?-1:1),r.select2({allowClear:!0,multiple:!0,data:s,matcher:(t,e,i)=>i.search.includes(t.toUpperCase()),formatResult:(t,i,r,a)=>{const s=[];return e.util.markMatch(t.text,r.term,s,a),t.mrps.length&&t.mrps.forEach(t=>{s.push(' &nbsp;<span class="label label-default">'),e.util.markMatch(t,r.term,s,a),s.push("</span>")}),s.join("")}});let o=r.data("sortable");o&&o.destroy(),o=new i(r.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:()=>{r.select2("onSortStart")},onEnd:()=>{r.select2("onSortEnd").select2("focus")}}),r.data("sortable",o)},submitForm:function(){var t=this,e=t.$id("submit").prop("disabled",!0),i=e.find(".fa-spinner").removeClass("hidden"),a=t.plan.settings;t.$("input[data-line-id]").each(function(){var e=t.mrp.lines.get(this.dataset.lineId);if(e){var i=this.value;i.length&&e.settings.set("orderGroupPriority",i.split(","))}});var s=a.save();s.done(r.closeDialog),s.fail(function(){i.addClass("hidden"),e.prop("disabled",!1),r.msg.show({type:"error",time:3e3,text:t.t("lines:menu:orderGroupPriority:failure")}),t.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});