define(["underscore","jquery","select2","Sortable","app/viewport","app/core/View","app/core/util/idAndLabel","app/core/util/resultTips","app/planning/templates/linesOrderGroupPriorityDialog","app/planning/templates/linesOrderGroupPriorityGroup"],function(e,t,i,r,n,o,s,a,l,p){"use strict";return o.extend({template:l,modelProperty:"plan",dialogClassName:"planning-orderGroupPriority-dialog",events:{submit:function(){return this.submitForm(),!1},"change input":function(){n.adjustDialogBackdrop()},'click a[data-action="copy"]':function(e){this.copyData=this.$(e.target).closest(".planning-orderGroupPriority-line").find(".planning-orderGroupPriority-groups").html(),a.showCopied({e:e})},'click a[data-action="paste"]':function(e){this.$(e.target).closest(".planning-orderGroupPriority-line").find(".planning-orderGroupPriority-groups").html(this.copyData)},'click a[data-action="remove"]':function(e){const t=this.$(e.target).closest(".planning-orderGroupPriority-group");t.fadeOut("fast",()=>{t.remove(),this.setUpNewGroupSelect2()})},"click .planning-orderGroupPriority-line":function(e){this.selectLine(e.currentTarget.dataset.lineId)},"mouseenter .planning-orderGroupPriority-group":function(e){const t=e.currentTarget,{groupId:i}=t.dataset,r=new Set;this.$(`.planning-orderGroupPriority-group[data-group-id="${i}"]`).each((e,i)=>{r.add(i.parentNode.parentNode.dataset.lineId),i!==t&&(i.classList.add("is-same"),i.parentNode.scrollTop=i.offsetTop-i.parentNode.offsetTop-i.parentNode.offsetHeight/2)}),this.updateTitleLines(t.querySelector(".planning-orderGroupPriority-group-name").innerText,Array.from(r).sort((e,t)=>e.localeCompare(t,void 0,{numeric:!0,ignorePunctuation:!0})))},"mouseleave .planning-orderGroupPriority-group":function(){this.$(".is-same").removeClass("is-same"),this.updateTitleLines("",[])},"change #-newGroup":function(e){const t=this.renderPartial(p,{group:{id:e.added.id,label:e.added.text}}),i=this.$(`.planning-orderGroupPriority-line[data-line-id="${this.selectedLine}"]`).find(".planning-orderGroupPriority-groups").append(t);i[0].scrollTop=i[0].scrollHeight,t.addClass("highlight"),this.setUpNewGroupSelect2()},"change #-matchingMrps":function(){this.setUpNewGroupSelect2()}},localTopics:{"viewport.resized":"resize"},initialize:function(){this.copyData="",this.selectedLine=""},destroy:function(){this.destroySortables()},destroySortables:function(){this.$(".planning-orderGroupPriority-groups").each((e,t)=>{const i=this.$(t);i.data("sortable").destroy(),i.removeData("sortable")})},getTemplateData:function(){return{renderGroup:this.renderPartialHtml.bind(this,p),lines:this.mrp.getSortedLines().map(e=>({_id:e.id,orderGroupPriority:(e.settings.get("orderGroupPriority")||[]).map(e=>{const t=this.orderGroups.get(e);return{id:e,label:t?t.getLabel():null}}).filter(e=>!!e.label)}))}},afterRender:function(){this.$(".planning-orderGroupPriority-groups").each((e,t)=>{this.setUpSortable(this.$(t))}),this.$(".planning-orderGroupPriority-line").first().click()},setUpSortable:function(e){const t=new r(e[0],{draggable:".planning-orderGroupPriority-group",handle:"i",filter:"a",onStart:e=>{this.selectLine(e.item.parentNode.parentNode.dataset.lineId),this.$el.addClass("sortable-dragging")},onEnd:e=>{this.$el.removeClass("sortable-dragging"),e.item.offsetHeight}});e.data("sortable",t)},setUpNewGroupSelect2:function(){if(!this.selectedLine)return;const t=new Set;this.$(`.planning-orderGroupPriority-line[data-line-id="${this.selectedLine}"]`).find(".planning-orderGroupPriority-group").each((e,i)=>t.add(i.dataset.groupId));const r=this.mrp.lines.get(this.selectedLine).settings.get("mrpPriority"),n=this.$id("matchingMrps").prop("checked"),o=this.orderGroups.filter(e=>!t.has(e.id)).map(t=>{const i=t.get("mrp")||[];return{id:t.id,text:t.getLabel(),mrps:i,search:(t.getLabel()+" "+i.join(" ")).trim().toUpperCase(),hasLineMrps:0===i.length||e.intersection(i,r).length>0,model:t}}).filter(e=>!n||e.hasLineMrps);o.sort((e,t)=>e.model.isNoMatchGroup()?-1:t.model.isNoMatchGroup()?1:e.hasLineMrps===t.hasLineMrps?e.text.localeCompare(t.text,void 0,{numeric:!0,ignorePunctuation:!0}):e.hasLineMrps?-1:1),this.$id("newGroup").val("").select2({width:"600px",data:o,placeholder:this.t("lines:menu:orderGroupPriority:newGroup",{line:this.selectedLine}),matcher:(e,t,i)=>i.search.includes(e.toUpperCase()),formatResult:(e,t,n,o)=>{const s=[];return i.util.markMatch(e.text,n.term,s,o),e.mrps.length&&e.mrps.forEach(e=>{const t=r.includes(e)?"success":"default";s.push(` &nbsp;<span class="label label-${t}">`),i.util.markMatch(e,n.term,s,o),s.push("</span>")}),s.join("")}})},submitForm:function(){const e=this.$id("submit").prop("disabled",!0),t=e.find(".fa-spinner").removeClass("hidden"),i=this.plan.settings;this.$(".planning-orderGroupPriority-line").each((e,t)=>{const r=i.lines.get(t.dataset.lineId);if(!r)return;const n=this.$(t).find(".planning-orderGroupPriority-group").map((e,t)=>t.dataset.groupId).get();r.set("orderGroupPriority",n)}),n.msg.saving();const r=i.save();r.done(()=>{n.msg.saved(),n.closeDialog()}),r.fail(()=>{t.addClass("hidden"),e.prop("disabled",!1),n.msg.savingFailed(),this.plan.settings.trigger("errored")})},onDialogShowing:function(){this.resize()},resize:function(){const e=window.innerHeight-20-30-55-65-2;this.$id("lines")[0].style.height=e+"px",n.adjustDialogBackdrop()},updateTitleLines:function(i,r){const n=t(".modal-title");let o=n.find(".planning-orderGroupPriority-title-lines");o.length||(o=t('<span class="planning-orderGroupPriority-title-lines"></span>').appendTo(n));const s=r.length?`<b>${e.escape(i)}</b><br>${e.escape(r.join(" â–ª "))}`:"";o.html(s)},selectLine:function(e){this.selectedLine!==e&&(this.selectedLine=e,this.$(".is-selected").removeClass("is-selected"),this.$(`.planning-orderGroupPriority-line[data-line-id="${e}"]`).addClass("is-selected"),this.setUpNewGroupSelect2())}})});