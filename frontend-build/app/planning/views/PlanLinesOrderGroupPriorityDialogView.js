define(["underscore","select2","Sortable","app/viewport","app/core/View","app/core/util/idAndLabel","app/core/util/resultTips","app/planning/templates/linesOrderGroupPriorityDialog"],function(t,e,i,s,r,a,o,n){"use strict";return r.extend({template:n,modelProperty:"plan",events:{submit:function(){return this.submitForm(),!1},"change input":function(){s.adjustDialogBackdrop()},'click a[data-action="copy"]':function(t){this.copyData=this.$(t.target).closest(".form-group").find("input").select2("data"),o.showCopied({e:t})},'click a[data-action="paste"]':function(t){this.$(t.target).closest(".form-group").find("input").select2("data",this.copyData).trigger("change")}},initialize:function(){this.copyData=[]},destroy:function(){this.destroySortables()},destroySortables:function(){this.$("input[data-line-id]").each((t,e)=>{const i=this.$(e);i.data("sortable").destroy(),i.removeData("sortable")})},getTemplateData:function(){return{lines:this.mrp.getSortedLines().map(function(t){return{_id:t.id,orderGroupPriority:(t.settings.get("orderGroupPriority")||[]).join(",")}})}},afterRender:function(){this.$("input[data-line-id]").each((t,e)=>{this.setUpOrderGroupPriority(this.$(e))})},setUpOrderGroupPriority:function(s){const r=this.mrp.lines.get(s[0].dataset.lineId).settings.get("mrpPriority"),a=this.orderGroups.map(e=>{const i=e.get("mrp")||[];return{id:e.id,text:e.getLabel(),mrps:i,search:(e.getLabel()+" "+i.join(" ")).trim().toUpperCase(),hasLineMrps:t.intersection(i,r).length>0,model:e}});a.sort((t,e)=>t.model.isNoMatchGroup()?-1:e.model.isNoMatchGroup()?1:t.hasLineMrps===e.hasLineMrps?t.text.localeCompare(e.text,void 0,{numeric:!0,ignorePunctuation:!0}):t.hasLineMrps?-1:1),s.select2({allowClear:!0,multiple:!0,data:a,matcher:(t,e,i)=>i.search.includes(t.toUpperCase()),formatResult:(t,i,s,r)=>{const a=[];return e.util.markMatch(t.text,s.term,a,r),t.mrps.length&&t.mrps.forEach(t=>{a.push(' &nbsp;<span class="label label-default">'),e.util.markMatch(t,s.term,a,r),a.push("</span>")}),a.join("")}});let o=s.data("sortable");o&&o.destroy(),o=new i(s.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:()=>{s.select2("onSortStart")},onEnd:()=>{s.select2("onSortEnd").select2("focus")}}),s.data("sortable",o)},submitForm:function(){const t=this.$id("submit").prop("disabled",!0),e=t.find(".fa-spinner").removeClass("hidden"),i=this.plan.settings;this.$("input[data-line-id]").each((t,e)=>{const s=i.lines.get(e.dataset.lineId);if(!s)return;const r=e.value.split(",").filter(t=>!!t.length);s.set("orderGroupPriority",r)}),s.msg.saving();const r=i.save();r.done(()=>{s.msg.saved(),s.closeDialog()}),r.fail(()=>{e.addClass("hidden"),t.prop("disabled",!1),s.msg.savingFailed(),this.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});