define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/pageActions","app/data/clipboard","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/planFilter"],function(t,e,n,a,i,r,s,o,p,l){"use strict";return r.extend({template:l,events:{"input #-date":"changeFilter","change #-date":"changeFilter","change #-mrps":"changeFilter","click #-lineOrdersList":function(){this.plan.displayOptions.toggleLineOrdersList()},"click #-useDarkerTheme":function(){this.plan.displayOptions.toggleDarkerThemeUse()},'click a[role="copyOrderList"]':function(t){this.copyOrderList(+t.currentTarget.dataset.shift)},"click #-exportStats":function(){this.exportStats()}},modelProperty:"plan",initialize:function(){var t=this.plan,e=t.displayOptions;this.listenTo(t,"change:loading",this.onLoadingChanged),this.listenTo(t,"change:_id",this.onDateChanged),this.listenTo(e,"change:minDate change:maxDate",this.onMinMaxDateChanged),this.listenTo(e,"change:lineOrdersList change:useDarkerTheme",this.updateToggles)},getTemplateData:function(){var t=this.plan,e=t.displayOptions;return{date:t.id,mrps:e.get("mrps"),minDate:e.get("minDate"),maxDate:e.get("maxDate"),lineOrdersList:e.isLineOrdersListEnabled(),useDarkerTheme:e.isDarkerThemeUsed(),showToggles:!1!==this.options.toggles,showStats:!1!==this.options.stats}},afterRender:function(){p(this.$id("mrps"),{width:"400px",placeholder:this.t("filter:mrps:placeholder"),sortable:!0,own:!0,view:this})},copyOrderList:function(t){var n=this,a={};e(".planning-mrp[data-id]").each(function(){a[this.dataset.id]=!0});var i=n.plan.getOrderList(a,t);o.copy(function(t){if(t){t.setData("text/plain",i.join("\r\n")),t.setData("text/html","<ul><li>"+i.join("</li><li>")+"</li></ul>");var e=n.$id("copyOrderList").tooltip({container:n.el,trigger:"manual",placement:"bottom",title:n.t("toolbar:copyOrderList:success")});e.tooltip("show").data("bs.tooltip").tip().addClass("result success"),n.timers.hideTooltip&&clearTimeout(n.timers.hideTooltip),n.timers.hideTooltip=setTimeout(function(){e.tooltip("destroy")},1337)}})},getStats:function(){var t={manHours:{todo:0,late:0,plan:0,remaining:0},quantity:{todo:0,late:0,plan:0,remaining:0},execution:{plan:0,done:0,percent:0,1:{plan:0,done:0,percent:0},2:{plan:0,done:0,percent:0},3:{plan:0,done:0,percent:0}},orders:{todo:0,late:0,plan:0,remaining:0}};e(".planning-mrp-stats-bd").each(function(){e(this).find("td").each(function(){var e=this.dataset;if(e.plan){var n=e.shiftNo;n?(t.execution[n].plan+=parseInt(e.plan,10),t.execution[n].done+=parseInt(e.done,10)):(t.execution.plan+=parseInt(e.plan,10),t.execution.done+=parseInt(e.done,10))}else{var a=e.value;a>0&&(t[e.group][e.subgroup]+=parseFloat(a))}})}),t.execution.percent=t.execution.plan?Math.round(t.execution.done/t.execution.plan*100):0;for(var n=1;n<=3;++n){var a=t.execution[n];a.percent=a.plan?Math.round(a.done/a.plan*100):100}return t},recountStats:function(){var t=this.getStats();this.$("td[data-group]").each(function(){var e=this.dataset.group.split("."),n=t[e[0]];e.length>1&&(n=n[e[1]]),this.textContent=n[this.dataset.subgroup].toLocaleString()})},exportStats:function(){var t=this;t.$exportMsg=i.msg.show({type:"info",text:t.t("MSG:export:started")});var e={mrp:{type:"string",width:5,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:t.t("stats:mrp")}};o("todo"),o("late"),o("plan"),o("remaining"),p(1,3,t.t("filter:stats:execution")),p(2),p(3),p(0);var n=[{mrp:"",todo$manHours:t.t("stats:manHours"),todo$quantity:t.t("stats:quantity"),todo$orders:t.t("stats:orderCount"),late$manHours:t.t("stats:manHours"),late$quantity:t.t("stats:quantity"),late$orders:t.t("stats:orderCount"),plan$manHours:t.t("stats:manHours"),plan$quantity:t.t("stats:quantity"),plan$orders:t.t("stats:orderCount"),remaining$manHours:t.t("stats:manHours"),remaining$quantity:t.t("stats:quantity"),remaining$orders:t.t("stats:orderCount"),execution$1:t.t("core","SHIFT:1"),execution$2:t.t("core","SHIFT:2"),execution$3:t.t("core","SHIFT:3"),execution$0:t.t("core","SHIFT:1")+"-"+t.t("core","SHIFT:3")}];t.plan.mrps.forEach(function(t){l(t.id,t.getStats())}),l("",this.getStats());var a={filename:t.t("stats:export:fileName",{date:t.plan.id}),sheetName:t.t("stats:export:sheetName",{date:t.plan.id}),freezeRows:2,freezeColumns:1,subHeader:!0,subHeaderAlignmentH:"Center",columns:e,data:n},r=t.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify(a)});function o(n){e[n+"$manHours"]={type:"decimal",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:2,caption:t.t("filter:stats:"+n)},e[n+"$quantity"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""},e[n+"$orders"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""}}function p(t,n,a){e["execution$"+t]={type:"percent",width:7,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:n||0,caption:a||""}}function l(t,e){n.push({mrp:t,todo$manHours:e.manHours.todo,todo$quantity:e.quantity.todo,todo$orders:e.orders.todo,late$manHours:e.manHours.late,late$quantity:e.quantity.late,late$orders:e.orders.late,plan$manHours:e.manHours.plan,plan$quantity:e.quantity.plan,plan$orders:e.orders.plan,remaining$manHours:e.manHours.remaining,remaining$quantity:e.quantity.remaining,remaining$orders:e.orders.remaining,execution$1:e.execution[1].percent/100,execution$2:e.execution[2].percent/100,execution$3:e.execution[3].percent/100,execution$0:e.execution.percent/100})}r.fail(function(){i.msg.hide(t.$exportMsg,!0),i.msg.show({type:"error",time:2500,text:t.t("MSG:export:failure")})}),r.done(function(e){i.msg.hide(t.$exportMsg,!0),s.exportXlsx("/xlsxExporter/"+e)})},updateToggles:function(){if(!1!==this.options.toggles){var t=this.plan.displayOptions;this.$id("lineOrdersList").toggleClass("active",t.isLineOrdersListEnabled()),this.$id("useDarkerTheme").toggleClass("active",t.isDarkerThemeUsed())}},changeFilter:function(){var e=this.$id("date")[0],n=e.value,a={mrps:this.$id("mrps").val().split(",").filter(function(t){return t.length>0})};e.checkValidity()&&/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(n)&&(a.date=n),t.isEqual(a.mrps,this.plan.displayOptions.get("mrps"))||this.plan.displayOptions.set("mrps",a.mrps),a.date&&a.date!==this.plan.id&&this.plan.set("_id",a.date)},onLoadingChanged:function(){var t=this.plan.get("loading");this.$id("date").prop("disabled",t),this.$id("mrps").select2("enable",!t)},onDateChanged:function(){this.$id("date").val(this.plan.id)},onMinMaxDateChanged:function(){this.$id("date").prop("min",this.plan.displayOptions.get("minDate")).prop("max",this.plan.displayOptions.get("maxDate"))}})});