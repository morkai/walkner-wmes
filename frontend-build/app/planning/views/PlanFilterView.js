// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/core/View","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/planFilter"],function(t,a,e,i,s,n,p){"use strict";return s.extend({template:p,events:{"input #-date":"changeFilter","change #-date":"changeFilter","change #-mrps":"changeFilter","click #-wrapLists":function(){this.plan.displayOptions.toggleListWrapping()},"click #-useLatestOrderData":function(){this.plan.displayOptions.toggleLatestOrderDataUse()}},initialize:function(){var t=this.plan,a=t.displayOptions;this.listenTo(t,"change:loading",this.onLoadingChanged),this.listenTo(a,"change:minDate change:maxDate",this.onMinMaxDateChanged),this.listenTo(a,"change:wrapLists",this.updateToggles),this.listenTo(a,"change:useLatestOrderData",this.updateToggles)},serialize:function(){var a=this.plan,e=a.displayOptions;return t.assign({idPrefix:this.idPrefix,date:a.id,mrps:e.get("mrps"),minDate:e.get("minDate"),maxDate:e.get("maxDate"),wrapLists:e.isListWrappingEnabled(),useLatestOrderData:e.isLatestOrderDataUsed()})},afterRender:function(){n(this.$id("mrps"),{width:"600px",placeholder:e("planning","filter:mrps:placeholder"),sortable:!0,own:!0,view:this})},recountStats:function(){var t={manHours:{todo:0,done:0,late:0},quantity:{todo:0,done:0,late:0}};a(".planning-mrp-stats-bd").each(function(){a(this).find("td").each(function(){var a=this.dataset.value;a>0&&(t[this.dataset.group][this.dataset.subgroup]+=parseFloat(a))})}),this.$(".planning-mrp-stats-bd td").each(function(){var a=this.dataset.group,e="manHours"===a?1e3:1,i=Math.round(t[a][this.dataset.subgroup]*e)/e;this.textContent=i.toLocaleString()})},updateToggles:function(){var t=this.plan.displayOptions;this.$id("wrapLists").toggleClass("active",!t.isListWrappingEnabled()),this.$id("useLatestOrderData").toggleClass("active",t.isLatestOrderDataUsed())},changeFilter:function(){var a=this.$id("date")[0],e=a.value,i={mrps:this.$id("mrps").val().split(",").filter(function(t){return t.length>0})};a.checkValidity()&&/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(e)&&(i.date=e),t.isEqual(i.mrps,this.plan.displayOptions.get("mrps"))||this.plan.displayOptions.set("mrps",i.mrps),i.date&&i.date!==this.plan.id&&this.plan.set("_id",i.date)},onLoadingChanged:function(){var t=this.plan.get("loading");this.$id("date").prop("disabled",t),this.$id("mrps").select2("enable",!t)},onMinMaxDateChanged:function(){this.$id("date").prop("min",this.plan.displayOptions.get("minDate")),this.$id("date").prop("max",this.plan.displayOptions.get("maxDate"))}})});