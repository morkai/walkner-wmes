define(["underscore","app/i18n","app/time","app/viewport","app/core/View","app/core/util/idAndLabel","app/core/util/pageActions","app/core/util/forms/dateTimeRange","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/exportStatsDialog"],function(e,t,n,a,r,i,o,s,d,m,u){"use strict";return r.extend({template:u,events:{"click a[data-date-time-range]":s.handleRangeEvent,'change input[name="filter"]':function(){var e=this.$('input[name="filter"]:checked').val();this.$id("mrps").prev().toggleClass("hidden","lines"===e),this.$id("lines").prev().toggleClass("hidden","mrps"===e)},submit:function(){return this.submitForm(),!1}},getTemplateData:function(){return{mrps:this.model.displayOptions.get("mrps").join(",")}},afterRender:function(){var e=this.model.getMoment();this.$id("from-date").val(e.format("YYYY-MM-DD")),this.$id("to-date").val(e.add(1,"days").format("YYYY-MM-DD")),m(this.$id("mrps"),{width:"100%",placeholder:this.t("filter:mrps:placeholder"),view:this}),this.$id("lines").select2({width:"100%",placeholder:this.t("filter:lines:placeholder"),multiple:!0,allowClear:!0,data:d.getActiveByType("prodLine").map(i).sort(function(e,t){return e.text.localeCompare(t.text,void 0,{numeric:!0,ignorePunctuation:!0})})}).prev().addClass("hidden")},submitForm:function(){var e=this;e.$msg=a.msg.show({type:"info",text:e.t("MSG:export:started")}),e.$id("submit").prop("disabled",!0).find(".fa-spinner").removeClass("hidden");var t=e.$('input[name="filter"]:checked').val();e.ajax({url:"/planning/reports/execution",data:{from:e.$id("from-date").val(),to:e.$id("to-date").val(),mrps:"mrps"===t?e.$id("mrps").val():"",lines:"lines"===t?e.$id("lines").val():""},error:function(){a.msg.hide(e.$msg,!0),a.msg.show({type:"error",time:2500,text:e.t("MSG:export:failure")}),e.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")},success:function(t){a.msg.hide(e.$msg,!0),e.exportStats(t.options,t.data)}})},exportStats:function(e,t){var r=this,i={date:{type:"string",width:10,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:r.t("stats:date")},mrp:{type:"string",width:5,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:r.t("stats:mrp")},line:{type:"string",width:10,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:r.t("stats:line")}};l("todo"),l("late"),l("plan"),l("remaining"),l("executed"),p(1,3,r.t("filter:stats:execution")),p(2),p(3),p(0);var s=[{date:"",mrp:"",line:"",todo$manHours:r.t("stats:manHours"),todo$quantity:r.t("stats:quantity"),todo$orders:r.t("stats:orderCount"),late$manHours:r.t("stats:manHours"),late$quantity:r.t("stats:quantity"),late$orders:r.t("stats:orderCount"),plan$manHours:r.t("stats:manHours"),plan$quantity:r.t("stats:quantity"),plan$orders:r.t("stats:orderCount"),remaining$manHours:r.t("stats:manHours"),remaining$quantity:r.t("stats:quantity"),remaining$orders:r.t("stats:orderCount"),executed$manHours:r.t("stats:manHours"),executed$quantity:r.t("stats:quantity"),executed$orders:r.t("stats:orderCount"),execution$1:r.t("core","SHIFT:1"),execution$2:r.t("core","SHIFT:2"),execution$3:r.t("core","SHIFT:3"),execution$0:r.t("core","SHIFT:1")+"-"+r.t("core","SHIFT:3")}];t.forEach(function(e){s.push({date:e.date,mrp:e.mrp,line:e.line,todo$manHours:e.manHours.todo,todo$quantity:e.quantity.todo,todo$orders:e.orders.todo,late$manHours:e.manHours.late,late$quantity:e.quantity.late,late$orders:e.orders.late,plan$manHours:e.manHours.plan,plan$quantity:e.quantity.plan,plan$orders:e.orders.plan,remaining$manHours:e.manHours.remaining,remaining$quantity:e.quantity.remaining,remaining$orders:e.orders.remaining,executed$manHours:e.manHours.executed,executed$quantity:e.quantity.executed,executed$orders:e.orders.executed,execution$1:e.execution[1].percent/100,execution$2:e.execution[2].percent/100,execution$3:e.execution[3].percent/100,execution$0:e.execution[0].percent/100})});var d={from:n.utc.format(e.fromTime,"YY.M.D"),to:n.utc.format(e.toTime,"YY.M.D")},m={filename:r.t("stats:export:fileName",d),sheetName:r.t("stats:export:sheetName",d),freezeRows:2,freezeColumns:3,subHeader:!0,subHeaderAlignmentH:"Center",columns:i,data:s},u=r.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify(m)});function l(e){i[e+"$manHours"]={type:"decimal",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:2,caption:r.t("filter:stats:"+e)},i[e+"$quantity"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""},i[e+"$orders"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""}}function p(e,t,n){i["execution$"+e]={type:"percent",width:7,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:t||0,caption:n||""}}u.fail(function(){a.msg.hide(r.$msg,!0),a.msg.show({type:"error",time:2500,text:r.t("MSG:export:failure")})}),u.done(function(e){a.msg.hide(r.$msg,!0),o.exportXlsx("/xlsxExporter/"+e)}),u.always(function(){r.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")})}})});