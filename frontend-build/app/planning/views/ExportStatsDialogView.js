define(["underscore","app/i18n","app/time","app/viewport","app/core/View","app/core/util/idAndLabel","app/core/util/pageActions","app/core/util/forms/dateTimeRange","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/exportStatsDialog"],function(t,e,n,a,r,i,o,s,d,l,m){"use strict";return r.extend({template:m,events:{"click a[data-date-time-range]":s.handleRangeEvent,'change input[name="filter"]':function(){var t=this.$('input[name="filter"]:checked').val();this.$id("mrps").prev().toggleClass("hidden","lines"===t),this.$id("lines").prev().toggleClass("hidden","mrps"===t)},submit:function(){return this.submitForm(),!1}},getTemplateData:function(){return{mrps:this.model.displayOptions.get("mrps").join(",")}},afterRender:function(){var t=this.model.getMoment();this.$id("from-date").val(t.format("YYYY-MM-DD")),this.$id("to-date").val(t.add(1,"days").format("YYYY-MM-DD")),l(this.$id("mrps"),{width:"100%",placeholder:this.t("filter:mrps:placeholder"),view:this}),this.$id("lines").select2({width:"100%",placeholder:this.t("filter:lines:placeholder"),multiple:!0,allowClear:!0,data:d.getActiveByType("prodLine").map(i).sort(function(t,e){return t.text.localeCompare(e.text,void 0,{numeric:!0,ignorePunctuation:!0})})}).prev().addClass("hidden")},submitForm:function(){var t=this;t.$msg=a.msg.show({type:"info",text:t.t("MSG:export:started")}),t.$id("submit").prop("disabled",!0).find(".fa-spinner").removeClass("hidden");var e=t.$('input[name="filter"]:checked').val();t.ajax({url:"/planning/reports/execution",data:{from:t.$id("from-date").val(),to:t.$id("to-date").val(),mrps:"mrps"===e?t.$id("mrps").val():"",lines:"lines"===e?t.$id("lines").val():""},error:function(){a.msg.hide(t.$msg,!0),a.msg.show({type:"error",time:2500,text:t.t("MSG:export:failure")}),t.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")},success:function(e){a.msg.hide(t.$msg,!0),t.exportStats(e.options,e.data)}})},exportStats:function(t,e){var r=this,i={date:{type:"string",width:10,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:r.t("stats:date")},mrp:{type:"string",width:5,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:r.t("stats:mrp")},line:{type:"string",width:10,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:r.t("stats:line")}};p("todo"),p("late"),p("plan"),p("remaining"),u(1,3,r.t("filter:stats:execution")),u(2),u(3),u(0);var s=[{date:"",mrp:"",line:"",todo$manHours:r.t("stats:manHours"),todo$quantity:r.t("stats:quantity"),todo$orders:r.t("stats:orderCount"),late$manHours:r.t("stats:manHours"),late$quantity:r.t("stats:quantity"),late$orders:r.t("stats:orderCount"),plan$manHours:r.t("stats:manHours"),plan$quantity:r.t("stats:quantity"),plan$orders:r.t("stats:orderCount"),remaining$manHours:r.t("stats:manHours"),remaining$quantity:r.t("stats:quantity"),remaining$orders:r.t("stats:orderCount"),execution$1:r.t("core","SHIFT:1"),execution$2:r.t("core","SHIFT:2"),execution$3:r.t("core","SHIFT:3"),execution$0:r.t("core","SHIFT:1")+"-"+r.t("core","SHIFT:3")}];e.forEach(function(t){s.push({date:t.date,mrp:t.mrp,line:t.line,todo$manHours:t.manHours.todo,todo$quantity:t.quantity.todo,todo$orders:t.orders.todo,late$manHours:t.manHours.late,late$quantity:t.quantity.late,late$orders:t.orders.late,plan$manHours:t.manHours.plan,plan$quantity:t.quantity.plan,plan$orders:t.orders.plan,remaining$manHours:t.manHours.remaining,remaining$quantity:t.quantity.remaining,remaining$orders:t.orders.remaining,execution$1:t.execution[1].percent/100,execution$2:t.execution[2].percent/100,execution$3:t.execution[3].percent/100,execution$0:t.execution[0].percent/100})});var d={from:n.utc.format(t.fromTime,"YY.M.D"),to:n.utc.format(t.toTime,"YY.M.D")},l={filename:r.t("stats:export:fileName",d),sheetName:r.t("stats:export:sheetName",d),freezeRows:2,freezeColumns:3,subHeader:!0,subHeaderAlignmentH:"Center",columns:i,data:s},m=r.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify(l)});function p(t){i[t+"$manHours"]={type:"decimal",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:2,caption:r.t("filter:stats:"+t)},i[t+"$quantity"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""},i[t+"$orders"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""}}function u(t,e,n){i["execution$"+t]={type:"percent",width:7,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:e||0,caption:n||""}}m.fail(function(){a.msg.hide(r.$msg,!0),a.msg.show({type:"error",time:2500,text:r.t("MSG:export:failure")})}),m.done(function(t){a.msg.hide(r.$msg,!0),o.exportXlsx("/xlsxExporter/"+t)}),m.always(function(){r.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")})}})});