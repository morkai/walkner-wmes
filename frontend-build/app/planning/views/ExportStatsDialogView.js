define(["underscore","app/i18n","app/time","app/viewport","app/core/View","app/core/util/idAndLabel","app/core/util/pageActions","app/core/util/forms/dateTimeRange","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/exportStatsDialog"],function(e,t,n,i,r,a,o,s,d,m,l){"use strict";return r.extend({template:l,events:{"click a[data-date-time-range]":s.handleRangeEvent,'change input[name="filter"]':function(){var e=this.$('input[name="filter"]:checked').val();this.$id("mrps").prev().toggleClass("hidden","lines"===e),this.$id("lines").prev().toggleClass("hidden","mrps"===e)},submit:function(){return this.submitForm(),!1}},getTemplateData:function(){return{mrps:this.model.displayOptions.get("mrps").join(",")}},afterRender:function(){var e=this.model.getMoment();this.$id("from-date").val(e.format("YYYY-MM-DD")),this.$id("to-date").val(e.add(1,"days").format("YYYY-MM-DD")),m(this.$id("mrps"),{width:"100%",placeholder:this.t("filter:mrps:placeholder"),view:this}),this.$id("lines").select2({width:"100%",placeholder:this.t("filter:lines:placeholder"),multiple:!0,allowClear:!0,data:d.getActiveByType("prodLine").map(a).sort(function(e,t){return e.text.localeCompare(t.text,void 0,{numeric:!0,ignorePunctuation:!0})})}).prev().addClass("hidden")},submitForm:function(){var e=this;e.$msg=i.msg.show({type:"info",text:e.t("MSG:export:started")}),e.$id("submit").prop("disabled",!0).find(".fa-spinner").removeClass("hidden");var t=e.$('input[name="filter"]:checked').val();e.ajax({url:"/planning/reports/execution",data:{from:e.$id("from-date").val(),to:e.$id("to-date").val(),mrps:"mrps"===t?e.$id("mrps").val():"",lines:"lines"===t?e.$id("lines").val():""},error:function(){i.msg.hide(e.$msg,!0),i.msg.show({type:"error",time:2500,text:e.t("MSG:export:failure")}),e.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")},success:function(t){i.msg.hide(e.$msg,!0),e.exportStats(t.options,t.data)}})},exportStats:function(t,r){var a=this,s={date:{type:"string",width:10,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:a.t("stats:date")},division:{type:"string",width:10,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:a.t("stats:division")},mrp:{type:"string",width:5,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:a.t("stats:mrp")},line:{type:"string",width:10,headerRotation:0,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeV:1,caption:a.t("stats:line")}};p("todo"),p("late"),p("plan"),p("remaining"),p("executed"),c(1,3,a.t("filter:stats:execution")),c(2),c(3),c(0);var d=[{date:"",division:"",mrp:"",line:"",todo$manHours:a.t("stats:manHours"),todo$quantity:a.t("stats:quantity"),todo$orders:a.t("stats:orderCount"),late$manHours:a.t("stats:manHours"),late$quantity:a.t("stats:quantity"),late$orders:a.t("stats:orderCount"),plan$manHours:a.t("stats:manHours"),plan$quantity:a.t("stats:quantity"),plan$orders:a.t("stats:orderCount"),remaining$manHours:a.t("stats:manHours"),remaining$quantity:a.t("stats:quantity"),remaining$orders:a.t("stats:orderCount"),executed$manHours:a.t("stats:manHours"),executed$quantity:a.t("stats:quantity"),executed$orders:a.t("stats:orderCount"),execution$1:a.t("core","SHIFT:1"),execution$2:a.t("core","SHIFT:2"),execution$3:a.t("core","SHIFT:3"),execution$0:a.t("core","SHIFT:1")+"-"+a.t("core","SHIFT:3")}];r.forEach(function(t){d.push({date:t.date,division:e.isEmpty(t.division)?"":t.division.join(" "),mrp:t.mrp,line:t.line,todo$manHours:t.manHours.todo,todo$quantity:t.quantity.todo,todo$orders:t.orders.todo,late$manHours:t.manHours.late,late$quantity:t.quantity.late,late$orders:t.orders.late,plan$manHours:t.manHours.plan,plan$quantity:t.quantity.plan,plan$orders:t.orders.plan,remaining$manHours:t.manHours.remaining,remaining$quantity:t.quantity.remaining,remaining$orders:t.orders.remaining,executed$manHours:t.manHours.executed,executed$quantity:t.quantity.executed,executed$orders:t.orders.executed,execution$1:t.execution[1].percent/100,execution$2:t.execution[2].percent/100,execution$3:t.execution[3].percent/100,execution$0:t.execution[0].percent/100})});var m={from:n.utc.format(t.fromTime,"YY.M.D"),to:n.utc.format(t.toTime,"YY.M.D")},l={filename:a.t("stats:export:fileName",m),sheetName:a.t("stats:export:sheetName",m),freezeRows:2,freezeColumns:3,subHeader:!0,subHeaderAlignmentH:"Center",columns:s,data:d},u=a.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify(l)});function p(e){s[e+"$manHours"]={type:"decimal",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:2,caption:a.t("filter:stats:"+e)},s[e+"$quantity"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""},s[e+"$orders"]={type:"integer",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:""}}function c(e,t,n){s["execution$"+e]={type:"percent",width:7,headerAlignmentH:"Center",headerAlignmentV:"Center",mergeH:t||0,caption:n||""}}u.fail(function(){i.msg.hide(a.$msg,!0),i.msg.show({type:"error",time:2500,text:a.t("MSG:export:failure")})}),u.done(function(e){i.msg.hide(a.$msg,!0),o.exportXlsx("/xlsxExporter/"+e)}),u.always(function(){a.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")})}})});