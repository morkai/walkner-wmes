define(["underscore","jquery","Sortable","app/i18n","app/user","app/viewport","app/core/View","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/linesMrpPriorityDialog"],function(t,e,i,s,n,r,a,o,d,l){"use strict";return a.extend({modelProperty:"plan",template:l,events:{submit:function(){return this.submitForm(),!1},"change #-line":function(t){this.addLine(t.added.id),this.$id("line").select2("val",""),r.adjustDialogBackdrop()},'click .btn[data-action="remove"]':function(t){var e=this.$(t.target).closest("tr");this.removedLines[e[0].dataset.id]=!0,e.fadeOut("fast",()=>{e.remove(),this.recountLines(),r.adjustDialogBackdrop()})},'click .btn[data-action="down"]':function(t){var e=this.$(t.target).closest("tr"),i=e.next();i.length?e.insertAfter(i):e.insertBefore(e.parent()[0].firstElementChild),this.recountLines(),t.currentTarget.focus()},'click .btn[data-action="up"]':function(t){var e=this.$(t.target).closest("tr"),i=e.prev();i.length?e.insertBefore(i):e.insertAfter(e.parent()[0].lastElementChild),this.recountLines(),t.currentTarget.focus()}},initialize:function(){this.removedLines={},this.listenTo(this.plan.settings,"changed",this.onSettingsChanged)},destroy:function(){this.sortable&&this.sortable.destroy()},getTemplateData:function(){return{mrp:this.mrp.id}},afterRender:function(){this.mrp.getSortedLines().forEach(t=>this.addLine(t.id)),this.setUpLineSelect2(),this.setUpSortable(),r.adjustDialogBackdrop()},setUpLineSelect2:function(){var e=this,i=0,s=o.getAllByType("prodLine").filter(t=>!t.get("deactivatedAt")).map(t=>{t.id.length>i&&(i=t.id.length);var s=e.plan.settings.isLineLocked(t.id);return{id:t.id,text:t.get("description"),disabled:s,locked:s}}).sort((t,e)=>t.id.localeCompare(e.id,void 0,{numeric:!0,ignorePunctuation:!0}));e.$id("line").select2({allowClear:!0,data:s,matcher:(t,e,i)=>(t=t.toUpperCase(),i.id.toUpperCase().indexOf(t)>=0||i.text.toUpperCase().indexOf(t)>=0),formatSelection:e=>t.escape(e.id)+": "+t.escape(e.text),formatResult:e=>{for(var s=e.id;s.length<i;)s+=" ";var n="";return e.disabled&&(n='<i class="fa fa-lock" style="color: #e00"></i> '),'<span class="text-mono">'+t.escape(s).replace(/ /g,"&nbsp;")+'</span>: <span class="text-small">'+n+t.escape(e.text)+"</span>"}})},setUpSortable:function(){this.sortable&&this.sortable.destroy(),this.sortable=new i(this.$id("lines")[0],{draggable:"tr",filter:".actions",ghostClass:"planning-sortable-ghost",onEnd:()=>{this.recountLines()}})},addLine:function(t){delete this.removedLines[t];var e=this.$id("lines");if(!e.find('tr[data-id="'+t+'"]').length){this.$rowTemplate||(this.$rowTemplate=e.children().first().detach());var i=this.$rowTemplate.clone().attr("data-id",t);i[0].children[0].textContent=e[0].childElementCount+1+".",i[0].children[1].textContent=t,e.append(i)}},recountLines:function(){this.$id("lines").children().each((t,e)=>{e.children[0].textContent=t+1+"."})},submitForm:function(){r.msg.saving();var t=this.$id("submit").prop("disabled",!0),e=t.find(".fa-spinner").removeClass("hidden"),i=this.plan.settings,s=[];this.$("tr[data-id]").each((t,e)=>{var n=e.dataset.id,r=i.lines.get(n);if(s.push(n),r){var a=r.get("mrpPriority");a.includes(this.mrp.id)||r.set("mrpPriority",a.concat([this.mrp.id]))}else i.lines.add({_id:n,mrpPriority:[this.mrp.id]})}),Object.keys(this.removedLines).forEach(t=>{var e=i.lines.get(t);if(e){var s=e.get("mrpPriority");s.includes(this.mrp.id)&&e.set("mrpPriority",s.filter(t=>t!==this.mrp.id))}}),i.mrps.get(this.mrp.id).set("linePriority",s);var n=i.save();n.done(()=>{r.msg.saved(),r.closeDialog()}),n.fail(()=>{e.addClass("hidden"),t.prop("disabled",!1),r.msg.savingFailed(),this.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")},onSettingsChanged:function(e){if(e.locked){var i=this;i.setUpLineSelect2(),i.$("input[data-line-id]").each(function(){var e=i.$(this),s=i.plan.settings.lines.get(this.dataset.lineId).get("mrpPriority"),n=e.val().split(",").filter(function(e){return e.length>0&&(t.includes(s,e)||!i.plan.settings.isMrpLocked(e))});e.select("destroy").val(n.join(",")),i.setUpMrpPriority(e,!1)})}}})});