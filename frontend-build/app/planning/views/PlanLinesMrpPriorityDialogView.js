define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/linesMrpPriorityDialog"],function(e,t,i,n,s,r,a,l,o){"use strict";return r.extend({template:o,events:{submit:function(){return this.submitForm(),!1},"change #-line":function(e){this.removeEmptyLines(),this.addLine(e.added.id),this.$id("line").select2("val",""),this.toggleSubmit()},"change input[data-line-id]":function(){this.toggleSubmit()}},afterRender:function(){this.setUpLineSelect2(),this.mrp.lines.forEach(function(e){this.addLine(e.id)},this),this.toggleSubmit()},toggleSubmit:function(){var e=!1;this.$("input[data-line-id]").each(function(){e=e||this.value.length}),this.$id("submit").prop("disabled",!e)},setUpLineSelect2:function(){var t=0,i=a.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(function(i){return i.id.length>t&&(t=i.id.length),{id:i.id,text:e.escape(i.get("description"))}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})});this.$id("line").select2({allowClear:!0,data:i,matcher:function(e,t,i){return e=e.toUpperCase(),i.id.toUpperCase().indexOf(e)>=0||i.text.toUpperCase().indexOf(e)>=0},formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var i=e.id;i.length<t;)i+=" ";return'<span class="text-mono">'+i.replace(/ /g,"&nbsp;")+"</span>: "+e.text}})},removeEmptyLines:function(){this.$("input[data-line-id]").each(function(){""===this.value&&t(this).select2("destroy").parent().remove()})},addLine:function(n){if(!this.$id(n).select2("focus").length){var s=this.plan.settings.lines.get(n),r=s?s.get("mrpPriority"):[];e.includes(r,this.mrp.id)||r.push(this.mrp.id);var a=this.idPrefix+"-"+n,o=t('<div class="form-group"></div>'),d=t("<label></label>").attr("for",a).text(n),p=t('<input type="text" autocomplete="new-password">').attr("id",a).attr("data-line-id",n).val(r.join(","));o.append(d).append(p).appendTo(this.$id("lines")),l(p,{view:this,sortable:!0,width:"100%",placeholder:i("planning","settings:mrpPriority:placeholder")}),p.select2("focus")}},submitForm:function(){var e=this,t=e.$id("submit").prop("disabled",!0),n=t.find(".fa-spinner").removeClass("hidden"),r=e.plan.settings;e.$("input[data-line-id]").each(function(){var e=this.dataset.lineId,t=r.lines.get(e),i=this.value.length?this.value.split(","):[];t?t.set("mrpPriority",i):i.length&&r.lines.add({_id:e,mrpPriority:i})});var a=r.save();a.done(s.closeDialog),a.fail(function(){n.addClass("hidden"),t.prop("disabled",!1),s.msg.show({type:"error",time:3e3,text:i("planning","lines:menu:mrpPriority:failure")}),e.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});