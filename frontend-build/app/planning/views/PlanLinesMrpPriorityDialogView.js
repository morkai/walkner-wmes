define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/linesMrpPriorityDialog"],function(t,e,i,n,s,a,r,l,o){"use strict";return a.extend({modelProperty:"plan",template:o,events:{submit:function(){return this.submitForm(),!1},"change #-line":function(t){this.removeEmptyLines(),this.addLine(t.added.id),this.$id("line").select2("val",""),this.toggleSubmit()},"change input[data-line-id]":function(){this.toggleSubmit()}},initialize:function(){this.listenTo(this.plan.settings,"changed",this.onSettingsChanged)},afterRender:function(){this.setUpLineSelect2(),this.mrp.lines.forEach(function(t){this.addLine(t.id)},this),this.toggleSubmit()},toggleSubmit:function(){var t=!1;this.$("input[data-line-id]").each(function(){t=t||this.value.length}),this.$id("submit").prop("disabled",!t)},setUpLineSelect2:function(){var e=this,i=0,n=r.getAllByType("prodLine").filter(function(t){return!t.get("deactivatedAt")}).map(function(t){t.id.length>i&&(i=t.id.length);var n=e.plan.settings.isLineLocked(t.id);return{id:t.id,text:t.get("description"),disabled:n,locked:n}}).sort(function(t,e){return t.id.localeCompare(e.id,void 0,{numeric:!0})});e.$id("line").select2({allowClear:!0,data:n,matcher:function(t,e,i){return t=t.toUpperCase(),i.id.toUpperCase().indexOf(t)>=0||i.text.toUpperCase().indexOf(t)>=0},formatSelection:function(e){return t.escape(e.id)+": "+t.escape(e.text)},formatResult:function(e){for(var n=e.id;n.length<i;)n+=" ";var s="";return e.disabled&&(s='<i class="fa fa-lock" style="color: #e00"></i> '),'<span class="text-mono">'+t.escape(n).replace(/ /g,"&nbsp;")+'</span>: <span class="text-small">'+s+t.escape(e.text)+"</span>"}})},removeEmptyLines:function(){this.$("input[data-line-id]").each(function(){""===this.value&&e(this).select2("destroy").parent().remove()})},addLine:function(i){if(!this.$id(i).select2("focus").length){var n=this.plan.settings.lines.get(i),s=n?n.get("mrpPriority").concat([]):[];t.includes(s,this.mrp.id)||s.push(this.mrp.id);var a=this.idPrefix+"-"+i,r=e('<div class="form-group"></div>'),l=e("<label></label>").attr("for",a).text(i),o=e('<input type="text" autocomplete="new-password">').attr("id",a).attr("data-line-id",i).val(s.join(","));r.append(l).append(o).appendTo(this.$id("lines")),this.setUpMrpPriority(o,!0)}},setUpMrpPriority:function(t,e){var i=this,n=t.attr("data-line-id");l(t,{view:i,sortable:!0,width:"100%",placeholder:i.t("settings:mrpPriority:placeholder"),itemDecorator:function(t){return t.disabled=i.plan.settings.isMrpLocked(t.id),t.locked=t.disabled,t.locked&&(t.icon={id:"fa-lock",color:"#e00"}),t}}),i.plan.settings.isLineLocked(n)?t.select2("readonly",!0):e&&t.select2("focus")},submitForm:function(){var t=this,e=t.$id("submit").prop("disabled",!0),i=e.find(".fa-spinner").removeClass("hidden"),n=t.plan.settings;t.$("input[data-line-id]").each(function(){var t=this.dataset.lineId,e=n.lines.get(t),i=this.value.length?this.value.split(","):[];e?e.set("mrpPriority",i):i.length&&n.lines.add({_id:t,mrpPriority:i})});var a=n.save();a.done(s.closeDialog),a.fail(function(){i.addClass("hidden"),e.prop("disabled",!1),s.msg.show({type:"error",time:3e3,text:t.t("lines:menu:mrpPriority:failure")}),t.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")},onSettingsChanged:function(e){if(e.locked){var i=this;i.setUpLineSelect2(),i.$("input[data-line-id]").each(function(){var e=i.$(this),n=i.plan.settings.lines.get(this.dataset.lineId).get("mrpPriority"),s=e.val().split(",").filter(function(e){return e.length>0&&(t.includes(n,e)||!i.plan.settings.isMrpLocked(e))});e.select("destroy").val(s.join(",")),i.setUpMrpPriority(e,!1)})}}})});