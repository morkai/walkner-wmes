// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/linesMrpPriorityDialog"],function(t,e,i,n,r,s,a,l,o){"use strict";return s.extend({template:o,events:{submit:function(){return this.submitForm(),!1},"change #-line":function(t){this.removeEmptyLines(),this.addLine(t.added.id),this.$id("line").select2("val",""),this.toggleSubmit()},"change input[data-line-id]":function(){this.toggleSubmit()}},afterRender:function(){this.setUpLineSelect2(),this.mrp.lines.forEach(function(t){this.addLine(t.id)},this),this.toggleSubmit()},toggleSubmit:function(){var t=!1;this.$("input[data-line-id]").each(function(){t=t||this.value.length}),this.$id("submit").prop("disabled",!t)},setUpLineSelect2:function(){var e=this,i=0,n=a.getAllByType("prodLine").filter(function(t){return!t.get("deactivatedAt")}).map(function(e){return e.id.length>i&&(i=e.id.length),{id:e.id,text:t.escape(e.get("description"))}}).sort(function(t,e){return t.id.localeCompare(e.id,void 0,{numeric:!0})});e.$id("line").select2({allowClear:!0,data:n,matcher:function(t,e,i){return t=t.toUpperCase(),i.id.toUpperCase().indexOf(t)>=0||i.text.toUpperCase().indexOf(t)>=0},formatSelection:function(e){return t.escape(e.id+": "+e.text)},formatResult:function(t){for(var e=t.id;e.length<i;)e+=" ";return'<span class="text-mono">'+e.replace(/ /g,"&nbsp;")+"</span>: "+t.text}})},removeEmptyLines:function(){this.$("input[data-line-id]").each(function(){""===this.value&&e(this).select2("destroy").parent().remove()})},addLine:function(n){if(!this.$id(n).select2("focus").length){var r=this.plan.settings.lines.get(n),s=r?r.get("mrpPriority"):[];t.includes(s,this.mrp.id)||s.push(this.mrp.id);var a=this.idPrefix+"-"+n,o=e('<div class="form-group"></div>'),d=e("<label></label>").attr("for",a).text(n),p=e('<input type="text">').attr("id",a).attr("data-line-id",n).val(s.join(","));o.append(d).append(p).appendTo(this.$id("lines")),l(p,{view:this,sortable:!0,width:"100%",placeholder:i("planning","settings:mrpPriority:placeholder")}),p.select2("focus")}},submitForm:function(){var t=this,e=t.$id("submit").prop("disabled",!0),n=e.find(".fa-spinner").removeClass("hidden"),s=t.plan.settings;t.$("input[data-line-id]").each(function(){var t=this.dataset.lineId,e=s.lines.get(t),i=this.value.length?this.value.split(","):[];e?e.set("mrpPriority",i):i.length&&s.lines.add({_id:t,mrpPriority:i})});var a=s.save();a.done(r.closeDialog),a.fail(function(){n.addClass("hidden"),e.prop("disabled",!1),r.msg.show({type:"error",time:3e3,text:i("planning","lines:menu:mrpPriority:failure")}),t.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});