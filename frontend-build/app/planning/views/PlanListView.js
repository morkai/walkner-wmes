define(["underscore","app/time","app/i18n","app/user","app/core/views/ListView","app/planning/templates/list"],function(n,e,t,i,r,a){"use strict";return r.extend({template:a,remoteTopics:{"planning.settings.updated":function(n){this.collection.get(n.date)&&this.refreshCollection()},"planning.generator.finished":function(n){this.$('.is-empty[data-id="'+n.date+'"]').length&&this.refreshCollection()}},events:{"mousedown .planning-list-day":function(n){1===n.button&&n.preventDefault()},"mouseup .planning-list-day":function(n){if(!n.currentTarget.classList.contains("is-empty")){var e="#planning/plans/"+n.currentTarget.dataset.id;return 0===n.button?window.location.href=e:1===n.button&&window.open(e),!1}},"click .btn-primary":function(n){var e=this.$(n.currentTarget).prop("disabled",!0),t=e.closest(".planning-list-day").attr("data-id");this.ajax({method:"POST",url:"/planning/plans/"+t+";generate"}).fail(function(){e.prop("disabled",!1)})}},serialize:function(){var n=r.prototype.serialize.apply(this,arguments),e=n.rows[0].moment.clone().subtract(1,"days"),t=e.clone().subtract(6,"days");return n.prevLink="#planning/plans?select(mrps._id,mrps.lines._id,mrps.lines.workerCount)&_id>="+t.valueOf()+"&_id<="+e.valueOf(),e=(t=n.rows[6].moment.clone().add(1,"days")).clone().add(6,"days"),n.nextLink="#planning/plans?select(mrps._id,mrps.lines._id,mrps.lines.workerCount)&_id>="+t.valueOf()+"&_id<="+e.valueOf(),n},serializeColumns:function(){return[]},serializeRows:function(){for(var t=n.find(this.collection.rqlQuery.selector.args,function(n){return"ge"===n.name&&"_id"===n.args[0]}).args[1],i=[],r={},a=0;a<7;++a){var s=e.utc.getMoment(t).add(a,"days"),o={moment:s,date:s.format("YYYY-MM-DD"),mrps:[]};r[o.moment.valueOf()]=o,i.push(o)}return this.collection.forEach(function(n){var e=r[Date.parse(n.id)];e&&n.mrps.forEach(function(n){e.mrps.push({_id:n.id,lines:n.lines.map(function(n){return{_id:n.id}})})})}),i.forEach(function(n){n.mrps.sort(function(n,e){return n._id.localeCompare(e._id)})}),i}})});