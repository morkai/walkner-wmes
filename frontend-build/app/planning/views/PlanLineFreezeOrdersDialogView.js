// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","select2","form2js","app/i18n","app/viewport","app/core/View","app/planning/templates/lineFreezeOrdersDialog"],function(e,t,r,n,i,a,s,d){"use strict";return s.extend({template:d,events:{submit:function(){return this.submitForm(),!1},"change #-availableOrders":function(e){this.addOrder(e.added.id),this.$id("availableOrders").select2("data",null),setTimeout(function(e){e.$(".planning-freezeOrders-quantity").last().select()},1,this)},"keydown .planning-freezeOrders-quantity":function(e){if(13===e.keyCode){var t=this.$(e.currentTarget).closest("tr").next();return t.length?t.find(".planning-freezeOrders-quantity").select():this.$(".planning-freezeOrders-quantity").first().select(),!1}},'click .btn[data-action="remove"]':function(e){var r=this;this.$(e.currentTarget).closest("tr").fadeOut("fast",function(){t(this).remove(),r.recountOrders()})},'click .btn[data-action="up"]':function(e){var t=this.$(e.currentTarget),r=t.closest("tr"),n=r.prev();if(n.length)r.insertBefore(n);else{var i=r.parent().children();i.length>1&&r.insertAfter(i.last())}this.recountOrders(),t.focus()},'click .btn[data-action="down"]':function(e){var t=this.$(e.currentTarget),r=t.closest("tr"),n=r.next();if(n.length)r.insertAfter(n);else{var i=r.parent().children();i.length>1&&r.insertBefore(i.first())}this.recountOrders(),t.focus()},"click .btn[data-shift]":function(e){var t=this;t.$id("frozenOrders").html("");var r=+e.currentTarget.dataset.shift,n=[],i={};t.line.orders.forEach(function(e){var t=e.get("orderNo"),a=e.get("quantity"),s=e.getShiftNo();i[t]?i[t]+=a:s<=r&&(n.push(t),i[t]=a)}),n.forEach(function(e){t.addOrder(e,i[e])})}},initialize:function(){this.nextOrderIndex=0,this.$frozenOrder=null},serialize:function(){return{idPrefix:this.idPrefix,mrp:this.mrp.getLabel(),line:this.line.getLabel()}},serializeAvailableOrders:function(){var e=this,t=[];return e.line.settings.get("mrpPriority").forEach(function(r){e.plan.orders.forEach(function(e){e.get("mrp")===r&&t.push({id:e.id,text:e.get("name")})})}),t},afterRender:function(){var e=this;e.$frozenOrder=e.$id("frozenOrders").children().first().detach(),e.setUpAvailableOrdersSelect2(),e.line.get("frozenOrders").forEach(function(t){e.addOrder(t.orderNo,t.quantity)})},setUpAvailableOrdersSelect2:function(){this.$id("availableOrders").select2({multiple:!0,data:this.serializeAvailableOrders(),matcher:function(e,t,r){return e=e.toUpperCase(),r.id.toUpperCase().indexOf(e)>=0||r.text.toUpperCase().indexOf(e)>=0},formatSelection:function(t){return e.escape(t.id)},formatResult:function(e,t,n,i){var a=['<span class="text-mono">'];return r.util.markMatch(e.id,n.term,a,i),""===e.text?a.push("</span>"):(a.push('</span> <span class="text-small">'),r.util.markMatch(e.text,n.term,a,i),a.push("</span>")),a.join("")}})},addOrder:function(t,r){var n=this.plan.orders.get(t);if(n){var i=this.$id("frozenOrders"),a=this.$frozenOrder.clone(),s=a.find(".planning-freezeOrders-order"),d=++this.nextOrderIndex;a.children().first().text(i.children().length+1+"."),a.find(".planning-freezeOrders-quantity").attr("name","frozenOrders["+d+"].quantity").val(r||n.get("quantityTodo")),s.find("input").attr("name","frozenOrders["+d+"].orderNo").val(t),s.find("span").html("<code>"+t+"</code> <small>"+e.escape(n.get("name"))+"</small>"),i.append(a)}},recountOrders:function(){this.$id("frozenOrders").children().each(function(e){this.children[0].textContent=e+1+"."})},submitForm:function(){var t=this,r=t.$id("submit").prop("disabled",!0),s=r.find(".fa-spinner").removeClass("hidden"),d=t.ajax({method:"PATCH",url:"/planning/plans/"+t.plan.id+"/lines/"+t.line.id,data:JSON.stringify({frozenOrders:e.map(n(this.el).frozenOrders,function(e){return{orderNo:e.orderNo,quantity:parseInt(e.quantity,10)}}).filter(function(e){return e.quantity>0&&e.quantity<1e3})})});d.done(a.closeDialog),d.fail(function(){s.addClass("hidden"),r.prop("disabled",!1),a.msg.show({type:"error",time:3e3,text:i("planning","lines:menu:freezeOrders:failure")}),t.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("availableOrders").select2("focus")}})});