// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/core/View","app/data/downtimeReasons","../util/shift","../util/contextMenu","app/planning/templates/lineOrders","app/planning/templates/lineOrderPopover","app/planning/templates/lineOrderDowntimePopover","app/planning/templates/lineOrderShiftPopover","app/planning/templates/lineOrderLinePopover"],function(e,t,i,r,n,s,o,a,d,l,h,p){"use strict";return r.extend({template:a,events:{"mouseenter .is-lineOrder":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!0,orderNo:this.line.orders.get(e.currentTarget.dataset.id).get("orderNo")})},"mouseleave .is-lineOrder":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!1,orderNo:this.line.orders.get(e.currentTarget.dataset.id).get("orderNo")})},"click .is-lineOrder":function(e){if(0===e.button){var t=this.line.orders.get(e.currentTarget.dataset.id).get("orderNo");if(e.ctrlKey)return void window.open("#orders/"+t);if(this.mrp.orders.get(t))this.mrp.orders.trigger("preview",{orderNo:t});else{var i=this.plan.mrps.get(this.plan.orders.get(t).get("mrp"));i&&i.orders.trigger("preview",{orderNo:t,scrollIntoView:!0})}}},"contextmenu .is-lineOrder":function(e){return this.showLineOrderMenu(e),!1},"contextmenu .is-downtime":function(e){e.preventDefault()}},initialize:function(){var e=this;e.listenTo(e.plan,"change:active",this.renderIfNotLoading),e.listenTo(e.plan.displayOptions,"change:useLatestOrderData",e.render),e.listenTo(e.plan.shiftOrders,"add",e.updateShiftOrder),e.listenTo(e.plan.shiftOrders,"change:quantityDone",e.updateShiftOrder),e.listenTo(e.plan.sapOrders,"reset",e.onSapOrdersReset),e.listenTo(e.line.orders,"reset",e.renderIfNotLoading),e.listenTo(e.mrp.orders,"highlight",e.onOrderHighlight),e.listenTo(e.mrp.orders,"change:incomplete",e.onIncompleteChange),e.listenTo(e.prodLineState,"change:online",e.onOnlineChange),e.listenTo(e.prodLineState,"change:state",e.updateShiftState),e.listenTo(e.prodLineState,"change:prodShift",e.updateShiftState),e.listenTo(e.prodLineState,"change:prodShiftOrders",e.updateShiftState)},destroy:function(){this.$el.popover("destroy")},serialize:function(){var e=this.serializeProdState();return{idPrefix:this.idPrefix,line:this.line.id,prodState:e,shifts:this.serializeShifts(e)}},afterRender:function(){var e=this;e.$el.popover({container:e.el,selector:"div[data-popover-content]",trigger:"hover",html:!0,placement:function(){return this.$element.attr("data-popover-placement")||"top"},hasContent:!0,content:function(){switch(this.dataset.popoverContent){case"lineOrder":return e.serializeOrderPopover(this.dataset.id);case"downtime":return e.serializeDowntimePopover(this.dataset.id);case"shift":return e.serializeShiftPopover(this.dataset.shift-1);case"line":return e.serializeLinePopover()}},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},$item:function(e){return e?this.$('.planning-mrp-list-item[data-id="'+e+'"]'):this.$(".planning-mrp-list-item")},serializeProdState:function(){if(!this.plan.isProdStateUsed())return{online:"",shift:0,state:"",orderNo:""};var e=this.prodLineState,t=e.get("prodShift"),i=e.getCurrentOrder();return{online:e.get("online")?"is-online":"is-offline",state:e.get("state")||"",shift:t?t.get("shift"):0,orderNo:i?i.get("orderId"):""}},serializeShifts:function(e){var t=this.plan,i=this.mrp,r=this.line,n=[];if(0===r.orders.length)return n;[0,1,2,3].forEach(function(t){n.push({no:t,state:e.shift===t?e.state:"",startTime:0,orders:[],downtimes:[]})});var o=!1;return r.orders.forEach(function(a){if(!o){var d=t.orders.get(a.get("orderNo"));if(!d)return void(o=!0);var l=t.getActualOrderData(d.id),h=d.get("mrp"),p=Date.parse(a.get("startAt")),f=Date.parse(a.get("finishAt")),g=f-p,u=n[s.getShiftNo(p)];0===u.startTime&&(u.startTime=s.getShiftStartTime(p));var c=u.orders[u.orders.length-1],m=c?c.finishAt:u.startTime,O=a.get("quantity"),v=t.shiftOrders.getTotalQuantityDone(r.id,u.no,d.id);u.orders.push({_id:a.id,orderNo:d.id,quantity:a.get("quantity"),incomplete:d.get("incomplete")>0?"is-incomplete":"",completed:v>=O?"is-completed":"",started:v>0&&v<O?"is-started":"",confirmed:l.statuses.indexOf("CNF")!==-1?"is-cnf":"",delivered:l.statuses.indexOf("DLV")!==-1?"is-dlv":"",selected:u.state&&d.id===e.orderNo?"is-selected":"",external:h!==i.id?"is-external":"",finishAt:f,margin:100*(p-m)/s.SHIFT_DURATION,width:100*g/s.SHIFT_DURATION,mrp:h})}}),r.get("downtimes").forEach(function(e,t){var i=Date.parse(e.startAt),r=n[s.getShiftNo(i)];r.downtimes.push({_id:t,reason:e.reason,left:100*(i-r.startTime)/s.SHIFT_DURATION,width:100*e.duration/s.SHIFT_DURATION})}),n.filter(function(e){return!o&&e&&e.orders.length>0})},serializeLinePopover:function(){var e=this.line.get("hourlyPlan"),t=0,i=0,r=0;return(this.line.get("shiftData")||[]).forEach(function(e){t+=e.orderCount,i+=e.quantity,r+=e.manHours}),p({stats:{orderCount:t,quantity:i,manHours:r,hourlyPlan:e}})},serializeShiftPopover:function(e){var t=this.line.get("hourlyPlan").slice(8*e,8*e+8),i=(this.line.get("shiftData")||[])[e]||{};return h({stats:{orderCount:i.orderCount||0,quantity:i.quantity||0,manHours:i.manHours||0,hourlyPlan:t}})},serializeOrderPopover:function(e){var t=this.line.orders.get(e),i=this.plan.orders.get(t.get("orderNo")),r=this.plan.getActualOrderData(i.id),n=Date.parse(t.get("startAt")),o=Date.parse(t.get("finishAt")),a=this.plan.isProdStateUsed()?this.plan.shiftOrders.getTotalQuantityDone(this.line.id,s.getShiftNo(n),i.id):-1;return d({lineOrder:{_id:t.id,orderNo:i.id,quantityPlanned:t.get("quantity"),quantityRemaining:r.quantityTodo-r.quantityDone,quantityTotal:r.quantityTodo,quantityDone:a,pceTime:t.get("pceTime")/1e3,manHours:t.get("manHours")||0,startAt:n,finishAt:o,duration:(o-n)/1e3}})},serializeDowntimePopover:function(e){var t=this.line.get("downtimes")[e],i=Date.parse(t.startAt),r=i+t.duration,s=n.get(t.reason);return l({lineDowntime:{reason:s?s.getLabel():t.reason,startAt:i,finishAt:r,duration:t.duration/1e3}})},hideMenu:function(){o.hide(this)},showLineOrderMenu:function(e){var t=this.line.orders.get(this.$(e.currentTarget).attr("data-id")),r=t.get("orderNo"),n=[o.actions.sapOrder(r)];(this.plan.shiftOrders.findOrders(r).length||this.plan.getActualOrderData(r).quantityDone)&&n.push({icon:"fa-file-text-o",label:i("planning","orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,t)}),this.plan.canCommentOrders()&&n.push(o.actions.comment(r)),o.show(this,e.pageY,e.pageX,n)},handleShiftOrderAction:function(e){var t=e.get("orderNo"),i=this.line.id,r=s.getShiftNo(e.get("startAt")),n=this.plan.shiftOrders.findOrders(t,i,r);return 1===n.length?window.open("/#prodShiftOrders/"+n[0].id):n.length?window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+t+"&prodLine="+encodeURIComponent(i)+"&shift="+r):(n=this.plan.shiftOrders.findOrders(t,i),1===n.length?window.open("/#prodShiftOrders/"+n[0].id):n.length?window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+t+"&prodLine="+encodeURIComponent(i)):(n=this.plan.shiftOrders.findOrders(t),1===n.length?window.open("/#prodShiftOrders/"+n[0].id):void window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+t)))},updateShiftState:function(){var e=this.serializeProdState(),t=this.$(".planning-mrp-lineOrders-shift").attr("data-state",""),i=t.filter('[data-shift="'+e.shift+'"]');i.length&&e.state&&i.attr("data-state",e.state),this.$(".is-selected").removeClass("is-selected"),e.shift&&e.orderNo&&this.$id("list-"+e.shift).find('.is-lineOrder[data-order-no="'+e.orderNo+'"]').addClass("is-selected")},onOrderHighlight:function(e){this.$('.is-lineOrder[data-order-no="'+e.orderNo+'"]').toggleClass("is-highlighted",e.state)},onIncompleteChange:function(e){this.$('.is-lineOrder[data-order-no="'+e.id+'"]').toggleClass("is-incomplete",e.get("incomplete")>0)},onSapOrdersReset:function(e,t){!t.reload&&this.plan.displayOptions.isLatestOrderDataUsed()&&this.render()},onOnlineChange:function(){var e=this.$(".planning-mrp-list-hd").removeClass("is-online is-offline");this.plan.isProdStateUsed()&&e.addClass("is-"+(this.prodLineState.get("online")?"online":"offline"))},updateShiftOrder:function(e){if(this.plan.isProdStateUsed()&&e.get("prodLine")===this.line.id){var t=this.prodLineState.get("prodShift");if(t){var i=t.get("shift"),r=e.get("orderId"),n=this.$id("list-"+i).find('.is-lineOrder[data-order-no="'+r+'"]');if(n.length){var s=this.line.orders.get(n.attr("data-id"));if(s){var o=s.get("quantity"),a=this.plan.shiftOrders.getTotalQuantityDone(this.line.id,i,r);n.toggleClass("is-started",a>0).toggleClass("is-completed",a>=o)}}}}}})});