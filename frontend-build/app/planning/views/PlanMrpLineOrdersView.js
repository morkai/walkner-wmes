// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/planning/util/shift","app/planning/templates/lineOrders","app/planning/templates/lineOrderPopover"],function(e,t,i,r,n,o){"use strict";return i.extend({template:n,events:{},initialize:function(){},destroy:function(){this.$el.popover("destroy")},serialize:function(){return{idPrefix:this.idPrefix,line:this.model.mrpLine.id,shifts:this.serializeShifts()}},afterRender:function(){var e=this;e.$el.popover({container:e.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){return e.serializePopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},$item:function(e){return e?this.$('.planning-mrp-list-item[data-id="'+e+'"]'):this.$(".planning-mrp-list-item")},serializeShifts:function(){var e=this.model.planMrp,t=this.model.mrpLine,i=[];if(0===t.orders.length)return i;var n={1:[],2:[],3:[]};return t.orders.forEach(function(t){var i=e.plan.orders.get(t.get("orderNo")),o=i.get("mrp"),a=Date.parse(t.get("startAt")),s=Date.parse(t.get("finishAt")),p=s-a,l=r.getShiftNo(a),d=n[l],g=d[d.length-1],h=g?g.finishAt:r.getShiftStartTime(a);d.push({_id:t.id,orderNo:t.get("orderNo"),quantity:t.get("quantity"),incomplete:i.get("incomplete")>0,finishAt:s,margin:100*(a-h)/r.SHIFT_DURATION,width:100*p/r.SHIFT_DURATION,mrp:o,external:o!==e.mrp._id})}),n[1].length&&i.push({no:1,orders:n[1]}),n[2].length&&i.push({no:2,orders:n[2]}),n[3].length&&i.push({no:3,orders:n[3]}),i},serializePopover:function(e){var t=this.model.mrpLine.orders.get(e),i=this.model.planMrp.plan.orders.get(t.get("orderNo")),r=Date.parse(t.get("startAt")),n=Date.parse(t.get("finishAt"));return o({lineOrder:{_id:t.id,orderNo:i.id,quantityPlanned:t.get("quantity"),quantityRemaining:i.get("quantityTodo")-i.get("quantityDone"),quantityTotal:i.get("quantityTodo"),pceTime:t.get("pceTime")/1e3,startAt:r,finishAt:n,duration:(n-r)/1e3}})}})});