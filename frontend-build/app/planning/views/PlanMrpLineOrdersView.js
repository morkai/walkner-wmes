// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/data/downtimeReasons","app/planning/util/shift","app/planning/templates/lineOrders","app/planning/templates/lineOrderPopover","app/planning/templates/lineDowntimePopover"],function(e,t,i,r,n,s,o,a){"use strict";return i.extend({template:s,events:{"mouseenter .is-lineOrder":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!0,orderNo:this.line.orders.get(e.currentTarget.dataset.id).get("orderNo")})},"mouseleave .is-lineOrder":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!1,orderNo:this.line.orders.get(e.currentTarget.dataset.id).get("orderNo")})},"click .is-lineOrder":function(e){if(0===e.button){var t=this.line.orders.get(e.currentTarget.dataset.id).get("orderNo");if(e.ctrlKey)return void window.open("#orders/"+t);if(this.mrp.orders.get(t))this.mrp.orders.trigger("preview",{orderNo:t});else{var i=this.plan.mrps.get(this.plan.orders.get(t).get("mrp"));i&&i.orders.trigger("preview",{orderNo:t,scrollIntoView:!0})}}},"contextmenu .is-lineOrder":function(e){e.preventDefault()},"contextmenu .is-downtime":function(e){e.preventDefault()}},initialize:function(){this.listenTo(this.line.orders,"reset",this.render),this.listenTo(this.mrp.orders,"highlight",this.onOrderHighlight),this.listenTo(this.mrp.orders,"change:incomplete",this.onIncompleteChange)},destroy:function(){this.$el.popover("destroy")},serialize:function(){return{idPrefix:this.idPrefix,line:this.line.id,shifts:this.serializeShifts()}},afterRender:function(){var e=this;e.$el.popover({container:e.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){return this.classList.contains("is-downtime")?e.serializeDowntimePopover(this.dataset.id):e.serializeOrderPopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},$item:function(e){return e?this.$('.planning-mrp-list-item[data-id="'+e+'"]'):this.$(".planning-mrp-list-item")},serializeShifts:function(){var e=this.plan,t=this.mrp,i=this.line,r=[];if(0===i.orders.length)return r;r.push(null,{no:1,startTime:0,orders:[],downtimes:[]},{no:2,startTime:0,orders:[],downtimes:[]},{no:3,startTime:0,orders:[],downtimes:[]});var s=!1;return i.orders.forEach(function(i){if(!s){var o=e.orders.get(i.get("orderNo"));if(!o)return void(s=!0);var a=o.get("mrp"),d=Date.parse(i.get("startAt")),l=Date.parse(i.get("finishAt")),p=l-d,g=r[n.getShiftNo(d)];0===g.startTime&&(g.startTime=n.getShiftStartTime(d));var h=g.orders[g.orders.length-1],u=h?h.finishAt:g.startTime;g.orders.push({_id:i.id,orderNo:i.get("orderNo"),quantity:i.get("quantity"),incomplete:o.get("incomplete")>0,finishAt:l,margin:100*(d-u)/n.SHIFT_DURATION,width:100*p/n.SHIFT_DURATION,mrp:a,external:a!==t.id})}}),i.get("downtimes").forEach(function(e,t){var i=Date.parse(e.startAt),s=r[n.getShiftNo(i)];s.downtimes.push({_id:t,reason:e.reason,left:100*(i-s.startTime)/n.SHIFT_DURATION,width:100*e.duration/n.SHIFT_DURATION})}),r.filter(function(e){return!s&&e&&e.orders.length>0})},serializeOrderPopover:function(e){var t=this.line.orders.get(e),i=this.plan.orders.get(t.get("orderNo")),r=Date.parse(t.get("startAt")),n=Date.parse(t.get("finishAt"));return o({lineOrder:{_id:t.id,orderNo:i.id,quantityPlanned:t.get("quantity"),quantityRemaining:i.get("quantityTodo")-i.get("quantityDone"),quantityTotal:i.get("quantityTodo"),pceTime:t.get("pceTime")/1e3,startAt:r,finishAt:n,duration:(n-r)/1e3}})},serializeDowntimePopover:function(e){var t=this.line.get("downtimes")[e],i=Date.parse(t.startAt),n=i+t.duration,s=r.get(t.reason);return a({lineDowntime:{reason:s?s.getLabel():t.reason,startAt:i,finishAt:n,duration:t.duration/1e3}})},onOrderHighlight:function(e){this.$('.is-lineOrder[data-id^="'+e.orderNo+'"]').toggleClass("is-highlighted",e.state)},onIncompleteChange:function(e){this.$('.is-lineOrder[data-id^="'+e.id+'"]').toggleClass("is-incomplete",e.get("incomplete")>0)}})});