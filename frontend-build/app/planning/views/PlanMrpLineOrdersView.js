// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/data/downtimeReasons","app/planning/util/shift","app/planning/templates/lineOrders","app/planning/templates/lineOrderPopover","app/planning/templates/lineDowntimePopover"],function(t,e,i,r,n,s,o,a){"use strict";return i.extend({template:s,events:{},initialize:function(){this.listenTo(this.line.orders,"reset",this.render)},destroy:function(){this.$el.popover("destroy")},serialize:function(){return{idPrefix:this.idPrefix,line:this.line.id,shifts:this.serializeShifts()}},afterRender:function(){var t=this;t.$el.popover({container:t.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){return this.classList.contains("is-downtime")?t.serializeDowntimePopover(this.dataset.id):t.serializeOrderPopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},$item:function(t){return t?this.$('.planning-mrp-list-item[data-id="'+t+'"]'):this.$(".planning-mrp-list-item")},serializeShifts:function(){var t=this.plan,e=this.mrp,i=this.line,r=[];if(0===i.orders.length)return r;r.push(null,{no:1,startTime:0,orders:[],downtimes:[]},{no:2,startTime:0,orders:[],downtimes:[]},{no:3,startTime:0,orders:[],downtimes:[]});var s=!1;return i.orders.forEach(function(i){if(!s){var o=t.orders.get(i.get("orderNo"));if(!o)return void(s=!0);var a=o.get("mrp"),d=Date.parse(i.get("startAt")),p=Date.parse(i.get("finishAt")),l=p-d,u=r[n.getShiftNo(d)];0===u.startTime&&(u.startTime=n.getShiftStartTime(d));var h=u.orders[u.orders.length-1],m=h?h.finishAt:u.startTime;u.orders.push({_id:i.id,orderNo:i.get("orderNo"),quantity:i.get("quantity"),incomplete:o.get("incomplete")>0,finishAt:p,margin:100*(d-m)/n.SHIFT_DURATION,width:100*l/n.SHIFT_DURATION,mrp:a,external:a!==e.id})}}),i.get("downtimes").forEach(function(t,e){var i=Date.parse(t.startAt),s=r[n.getShiftNo(i)];s.downtimes.push({_id:e,reason:t.reason,left:100*(i-s.startTime)/n.SHIFT_DURATION,width:100*t.duration/n.SHIFT_DURATION})}),r.filter(function(t){return!s&&t&&t.orders.length>0})},serializeOrderPopover:function(t){var e=this.line.orders.get(t),i=this.plan.orders.get(e.get("orderNo")),r=Date.parse(e.get("startAt")),n=Date.parse(e.get("finishAt"));return o({lineOrder:{_id:e.id,orderNo:i.id,quantityPlanned:e.get("quantity"),quantityRemaining:i.get("quantityTodo")-i.get("quantityDone"),quantityTotal:i.get("quantityTodo"),pceTime:e.get("pceTime")/1e3,startAt:r,finishAt:n,duration:(n-r)/1e3}})},serializeDowntimePopover:function(t){var e=this.line.get("downtimes")[t],i=Date.parse(e.startAt),n=i+e.duration,s=r.get(e.reason);return a({lineDowntime:{reason:s?s.getLabel():e.reason,startAt:i,finishAt:n,duration:e.duration/1e3}})}})});