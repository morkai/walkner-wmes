define(["underscore","jquery","app/i18n","app/user","app/core/View","app/data/downtimeReasons","../util/shift","../util/contextMenu","app/planning/templates/lineOrders","app/planning/templates/lineOrderPopover","app/planning/templates/lineOrderDowntimePopover","app/planning/templates/lineOrderShiftPopover","app/planning/templates/lineOrderLinePopover","app/planning/templates/orderStatusIcons"],function(e,t,r,i,n,s,o,a,d,l,h,p,u,c){"use strict";return n.extend({template:d,modelProperty:"plan",events:{"mouseenter .is-lineOrder":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!0,orderNo:this.line.orders.get(e.currentTarget.dataset.id).get("orderNo")})},"mouseleave .is-lineOrder":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!1,orderNo:this.line.orders.get(e.currentTarget.dataset.id).get("orderNo")})},"click .is-lineOrder":function(e){if(0!==e.button)return;const t=this.line.orders.get(e.currentTarget.dataset.id).get("orderNo");if(e.ctrlKey)return void window.open(`/#orders/${t}`);if(this.mrp.orders.get(t))return void this.mrp.orders.trigger("preview",{orderNo:t,source:"lineOrders"});const r=this.plan.orders.get(t);if(!r)return;const i=this.plan.mrps.get(r.get("mrp"));i&&i.orders.trigger("preview",{orderNo:t,scrollIntoView:!0,source:"lineOrders"})},"contextmenu .is-lineOrder":function(e){return this.showLineOrderMenu(e),!1},"contextmenu .is-downtime":function(e){e.preventDefault()}},initialize:function(){const e=this;e.listenTo(e.plan,"change:active",this.renderIfNotLoading),e.listenTo(e.plan.displayOptions,"change:useLatestOrderData",e.render),e.listenTo(e.plan.shiftOrders,"add",e.updateShiftOrder),e.listenTo(e.plan.shiftOrders,"change:quantityDone",e.updateShiftOrder),e.listenTo(e.plan.sapOrders,"reset",e.onSapOrdersReset),e.listenTo(e.plan.whProblems,"reset",e.onWhProblemReset),e.listenTo(e.plan.whProblems,"add",e.onWhProblemAdd),e.listenTo(e.plan.whProblems,"remove",e.onWhProblemRemove),e.listenTo(e.line.orders,"reset",e.renderIfNotLoading),e.listenTo(e.line.orders,"change:executed",e.onLineOrderExecuted),e.listenTo(e.mrp.orders,"highlight",e.onOrderHighlight),e.listenTo(e.mrp.orders,"change:incomplete",e.onIncompleteChange),e.prodLineState&&(e.listenTo(e.prodLineState,"change:online",e.onOnlineChange),e.listenTo(e.prodLineState,"change:state",e.updateShiftState),e.listenTo(e.prodLineState,"change:prodShift",e.updateShiftState),e.listenTo(e.prodLineState,"change:prodShiftOrders",e.updateShiftState))},destroy:function(){this.$el.popover("destroy")},getTemplateData:function(){const e=this.serializeProdState();return{prodState:e,line:this.line.id,shifts:this.serializeShifts(e)}},afterRender:function(){const e=this;e.$el.popover({container:e.el,selector:"div[data-popover-content]",trigger:"hover",html:!0,placement:function(){return this.$element[0].dataset.popoverPlacement||"top"},hasContent:!0,className:"planning-mrp-popover",content:function(){switch(this.dataset.popoverContent){case"lineOrder":return e.serializeOrderPopover(this.dataset.id);case"downtime":return e.serializeDowntimePopover(this.dataset.id);case"shift":return e.serializeShiftPopover(this.dataset.shift-1);case"line":return e.serializeLinePopover()}}})},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},$item:function(e){return e?this.$(`.planning-mrp-list-item[data-id="${e}"]`):this.$(".planning-mrp-list-item")},serializeProdState:function(){const e=this.prodLineState;if(!e||!this.plan.isProdStateUsed())return{online:"",shift:0,state:"",orderNo:""};const t=e.get("prodShift"),r=e.getCurrentOrder();return{online:e.get("online")?"is-online":"is-offline",state:e.get("state")||"",shift:t?t.get("shift"):0,orderNo:r?r.get("orderId"):""}},serializeShifts:function(e){const t=this.plan,r=this.mrp,i=this.line,n=[];return 0===i.orders.length?n:([0,1,2,3].forEach(t=>{n.push({no:t,state:e.shift===t?e.state:"",startTime:0,orders:[],downtimes:[]})}),i.orders.forEach(s=>{const a=s.get("orderNo"),d=t.orders.get(a),l=t.getActualOrderData(a),h=d?d.get("mrp"):d,p=Date.parse(s.get("startAt")),u=Date.parse(s.get("finishAt")),c=u-p,g=n[o.getShiftNo(p)];0===g.startTime&&(g.startTime=o.getShiftStartTime(p));const f=g.orders[g.orders.length-1],m=f?f.finishAt:g.startTime,O=s.get("quantity"),S=t.shiftOrders.getTotalQuantityDone(i.id,s),T=S>=O,w=l.quantityDone>=l.quantityTodo,P=l.statuses.includes("CNF"),v=l.statuses.includes("DLV");g.orders.push({_id:s.id,orderNo:a,quantity:s.get("quantity"),missing:d?"":"is-missing",incomplete:d&&d.get("incomplete")>0?"is-incomplete":"",completed:T||w||P||v?"is-completed":"",started:S>0&&S<O?"is-started":"",confirmed:P?"is-cnf":"",delivered:v?"is-dlv":"",selected:a===e.orderNo?"is-selected":"",executed:this.resolveExecutedClassName(s),problem:t.whProblems.isProblem(i.id,a)?"is-problem":"",external:h!==r.id?"is-external":"",finishAt:u,margin:100*(p-m)/o.SHIFT_DURATION,width:100*c/o.SHIFT_DURATION,mrp:h})}),i.get("downtimes").forEach((e,t)=>{const r=Date.parse(e.startAt),i=n[o.getShiftNo(r)];i.downtimes.push({_id:t,reason:e.reason,left:100*(r-i.startTime)/o.SHIFT_DURATION,width:100*e.duration/o.SHIFT_DURATION})}),n.filter(e=>0!==e.no&&(e.orders.length>0||!!n[e.no+1]&&n[e.no+1].orders.length>0)))},serializeLinePopover:function(){const e=this.line.get("hourlyPlan");let t=0,r=0,i=0;return(this.line.get("shiftData")||[]).forEach(function(e,n){0!==n&&(t+=e.orderCount,r+=e.quantity,i+=e.manHours)}),this.renderPartialHtml(u,{stats:{orderCount:t,quantity:r,manHours:i,hourlyPlan:e}})},serializeShiftPopover:function(e){const t=this.line.get("hourlyPlan").slice(8*e,8*e+8),r=(this.line.get("shiftData")||[])[e+1]||{};return this.renderPartialHtml(p,{stats:{orderCount:r.orderCount||0,quantity:r.quantity||0,manHours:r.manHours||0,hourlyPlan:t}})},serializeOrderPopover:function(e){const t=this.line.orders.get(e),r=t.get("orderNo"),i=this.plan.sapOrders.get(r),n=this.plan.getActualOrderData(r),s=Date.parse(t.get("startAt")),o=Date.parse(t.get("finishAt")),a=this.plan.isProdStateUsed()?this.plan.shiftOrders.getTotalQuantityDone(this.line.id,t):-1,d=this.orderGroups.get(t.get("group"));return this.renderPartialHtml(l,{lineOrder:{_id:t.id,orderNo:r,quantityPlanned:t.get("quantity"),quantityRemaining:n.quantityTodo-n.quantityDone,quantityTotal:n.quantityTodo,quantityDone:a,pceTime:t.get("pceTime")/1e3,manHours:t.get("manHours")||0,startAt:s,finishAt:o,duration:(o-s)/1e3,comment:i?i.getCommentWithIcon():"",statusIcons:c(this.plan,r,{sapStatuses:!1}),group:d?d.getLabel():""}})},serializeDowntimePopover:function(e){const t=this.line.get("downtimes")[e],r=Date.parse(t.startAt),i=r+t.duration,n=s.get(t.reason);return h({lineDowntime:{reason:n?n.getLabel():t.reason,startAt:r,finishAt:i,duration:t.duration/1e3}})},hideMenu:function(){a.hide(this)},showLineOrderMenu:function(e){const t=this.line.orders.get(this.$(e.currentTarget).attr("data-id")),r=t.get("orderNo"),n=[a.actions.sapOrder(r)];i.isAllowedTo("PROD_DATA:VIEW")&&(this.plan.shiftOrders.findOrders(r).length||this.plan.getActualOrderData(r).quantityDone)&&n.push({icon:"fa-file-text-o",label:this.t("orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,t)}),this.plan.canCommentOrders()&&n.push(a.actions.commentPopover(r)),a.show(this,e.pageY,e.pageX,n)},handleShiftOrderAction:function(e){const t=e.get("orderNo"),r=this.line.id,i=o.getShiftNo(e.get("startAt"));let n=this.plan.shiftOrders.findOrders(t,r,i);return 1===n.length?window.open(`/#prodShiftOrders/${n[0].id}`):n.length?window.open("/#prodShiftOrders?sort(startedAt)&limit(-1337)&orderId=string:"+t+"&prodLine="+encodeURIComponent(r)+"&shift="+i):1===(n=this.plan.shiftOrders.findOrders(t,r)).length?window.open(`/#prodShiftOrders/${n[0].id}`):n.length?window.open("/#prodShiftOrders?sort(startedAt)&limit(-1337)&orderId=string:"+t+"&prodLine="+encodeURIComponent(r)):1===(n=this.plan.shiftOrders.findOrders(t)).length?window.open(`/#prodShiftOrders/${n[0].id}`):void window.open(`/#prodShiftOrders?sort(startedAt)&limit(-1337)&orderId=string:${t}`)},updateShiftState:function(){const e=this.serializeProdState(),t=this.$(".planning-mrp-lineOrders-shift").attr("data-state","").filter(`[data-shift="${e.shift}"]`);t.length&&e.state&&t.attr("data-state",e.state),this.$(".is-selected").removeClass("is-selected"),e.shift&&e.orderNo&&this.$(`.is-lineOrder[data-order-no="${e.orderNo}"]`).addClass("is-selected")},onOrderHighlight:function(e){this.$(`.is-lineOrder[data-order-no="${e.orderNo}"]`).toggleClass("is-highlighted",e.state)},onIncompleteChange:function(e){this.$(`.is-lineOrder[data-order-no="${e.id}"]`).toggleClass("is-incomplete",e.get("incomplete")>0)},onSapOrdersReset:function(e,t){!t.reload&&this.plan.displayOptions.isLatestOrderDataUsed()&&this.render()},onOnlineChange:function(){const e=this.$(".planning-mrp-list-hd").removeClass("is-online is-offline");this.prodLineState&&this.plan.isProdStateUsed()&&e.addClass(this.prodLineState.get("online")?"is-online":"is-offline")},updateShiftOrder:function(e){if(!this.prodLineState||!this.plan.isProdStateUsed()||e.get("prodLine")!==this.line.id)return;const t=this.prodLineState.get("prodShift");if(!t)return;const r=t.get("shift"),i=e.get("orderId"),n=this.$id("list-"+r).find('.is-lineOrder[data-order-no="'+i+'"]');if(!n.length)return;const s=this.line.orders.get(n.attr("data-id"));s&&this.onLineOrderExecuted(s)},onLineOrderExecuted:function(e){this.$(`.is-lineOrder[data-id="${e.id}"]`).removeClass("is-sequence-ok is-sequence-nok is-sequence-unknown").addClass(this.resolveExecutedClassName(e))},resolveExecutedClassName:function(e){const t=e.get("executed");return t?"is-sequence-ok":null==t?"is-sequence-unknown":this.plan.shiftOrders.findOrders(e.get("orderNo")).length?"is-sequence-nok":"is-sequence-unknown"},onWhProblemReset:function(){this.$(".is-problem").removeClass("is-problem"),this.plan.whProblems.forEach(this.onWhProblemAdd,this)},onWhProblemAdd:function(e){e.get("line")===this.line.id&&this.$(`.is-lineOrder[data-order-no="${e.get("order")}"]`).addClass("is-problem")},onWhProblemRemove:function(e){e.get("line")===this.line.id&&this.$(`.is-problem[data-order-no="${e.get("order")}"]`).removeClass("is-problem")}})});