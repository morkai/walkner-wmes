// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/data/downtimeReasons","app/planning/util/shift","app/planning/templates/lineOrders","app/planning/templates/lineOrderPopover","app/planning/templates/lineDowntimePopover"],function(t,e,i,r,n,s,a,o){"use strict";return i.extend({template:s,events:{},initialize:function(){},destroy:function(){this.$el.popover("destroy")},serialize:function(){return{idPrefix:this.idPrefix,line:this.line.id,shifts:this.serializeShifts()}},afterRender:function(){var t=this;t.$el.popover({container:t.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){return this.classList.contains("is-downtime")?t.serializeDowntimePopover(this.dataset.id):t.serializeOrderPopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},$item:function(t){return t?this.$('.planning-mrp-list-item[data-id="'+t+'"]'):this.$(".planning-mrp-list-item")},serializeShifts:function(){var t=this.plan,e=this.mrp,i=this.line,r=[];return 0===i.orders.length?r:(r.push(null,{no:1,startTime:0,orders:[],downtimes:[]},{no:2,startTime:0,orders:[],downtimes:[]},{no:3,startTime:0,orders:[],downtimes:[]}),i.orders.forEach(function(i){var s=t.orders.get(i.get("orderNo")),a=s.get("mrp"),o=Date.parse(i.get("startAt")),d=Date.parse(i.get("finishAt")),p=d-o,l=r[n.getShiftNo(o)];0===l.startTime&&(l.startTime=n.getShiftStartTime(o));var m=l.orders[l.orders.length-1],u=m?m.finishAt:l.startTime;l.orders.push({_id:i.id,orderNo:i.get("orderNo"),quantity:i.get("quantity"),incomplete:s.get("incomplete")>0,finishAt:d,margin:100*(o-u)/n.SHIFT_DURATION,width:100*p/n.SHIFT_DURATION,mrp:a,external:a!==e.id})}),i.get("downtimes").forEach(function(t,e){var i=Date.parse(t.startAt),s=r[n.getShiftNo(i)];s.downtimes.push({_id:e,reason:t.reason,left:100*(i-s.startTime)/n.SHIFT_DURATION,width:100*t.duration/n.SHIFT_DURATION})}),r.filter(function(t){return t&&t.orders.length>0}))},serializeOrderPopover:function(t){var e=this.line.orders.get(t),i=this.plan.orders.get(e.get("orderNo")),r=Date.parse(e.get("startAt")),n=Date.parse(e.get("finishAt"));return a({lineOrder:{_id:e.id,orderNo:i.id,quantityPlanned:e.get("quantity"),quantityRemaining:i.get("quantityTodo")-i.get("quantityDone"),quantityTotal:i.get("quantityTodo"),pceTime:e.get("pceTime")/1e3,startAt:r,finishAt:n,duration:(n-r)/1e3}})},serializeDowntimePopover:function(t){var e=this.line.get("downtimes")[t],i=Date.parse(e.startAt),n=i+e.duration,s=r.get(e.reason);return o({lineDowntime:{reason:s?s.getLabel():e.reason,startAt:i,finishAt:n,duration:e.duration/1e3}})}})});