// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/viewport","app/core/View","../util/shift","app/planning/templates/toolbar","app/planning/templates/toolbarPrintLineList","app/planning/templates/printPage"],function(i,t,e,n,r,s,o,a,l){"use strict";return r.extend({template:o,events:{"click a[data-print-line]":function(i){this.printLines(i.currentTarget.dataset.printLine)},"click #-showTimes":function(){return this.plan.displayOptions.togglePrintOrderTime(),this.toggleShowTimes(),!1},"show.bs.dropdown #-printDropdown":"toggleShowTimes"},initialize:function(){},serialize:function(){return{idPrefix:this.idPrefix,lines:this.mrp.lines.map(function(i){return i.id})}},updatePrintAction:function(){this.$id("printPlan").prop("disabled",!this.mrp.lines.length),this.$id("printList").html(a(this.serialize()))},printLines:function(e){var r=this.mrp,s=[];if(i.isString(e))if("__ALL__"===e)s=r.lines.models;else{var o=r.lines.get(e);o&&s.push(o)}else i.forEach(e,function(i){var t=r.lines.get(i);t&&s.push(t)});if(s.length){var a=window.open(null,"PLANNING:PLAN_PRINT");if(!a)return n.msg.show({type:"error",time:5e3,text:t("planning","toolbar:popups")});a.document.body.innerHTML=l({date:this.plan.id,lines:i.pluck(s,"id").join(", "),showTimes:this.plan.displayOptions.isOrderTimePrinted(),pages:this.serializePrintPages(s)}),a.print()}},serializePrintPages:function(i){var t=this.plan,e=-1,n=[];return i.forEach(function(i){var r={pageNo:1,pageCount:1,mrp:i.settings.get("mrpPriority").join(" "),line:i.id,hourlyPlan:i.get("hourlyPlan"),workerCount:i.get("workerCount"),orders:i.orders.map(function(i,n){var r=t.orders.get(i.get("orderNo")),o=s.getShiftNo(i.get("startAt")),a=e!==-1&&o!==e;return e=o,{no:n+1,orderNo:r.id,nc12:r.get("nc12"),name:r.get("name"),qtyTodo:r.get("quantityTodo"),qtyPlan:i.get("quantity"),startAt:i.get("startAt"),finishAt:i.get("finishAt"),nextShift:a}})},o=42,a=35,l=r.orders.length;if(l<=o)return l>a&&(r.hourlyPlan=null),void n.push(r);for(var p=Math.ceil(l/o),d=1;d<=p;++d){var h=r.orders.slice((d-1)*o,d*o);n.push({pageNo:d,pageCount:p,line:r.line,hourlyPlan:d===p&&h.length<=a?r.hourlyPlan:null,orders:h})}}),n},toggleShowTimes:function(){this.$id("showTimes").blur().find(".fa").removeClass("fa-check fa-times").addClass(this.plan.displayOptions.isOrderTimePrinted()?"fa-check":"fa-times")}})});