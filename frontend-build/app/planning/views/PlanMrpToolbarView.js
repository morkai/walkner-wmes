// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/data/clipboard","app/prodShifts/ProdShiftCollection","../util/shift","../PlanSapOrderCollection","app/planning/templates/toolbar","app/planning/templates/toolbarSetHourlyPlan","app/planning/templates/toolbarPrintLineList","app/planning/templates/printPage"],function(t,e,i,n,r,s,o,a,l,p,d,u,h,c){"use strict";return s.extend({template:d,events:{"click #-setHourlyPlan":function(){var t=this.$popover,e=this.$id("setHourlyPlan");this.hidePopover(),t&&t[0]===e[0]||(this.$popover=this.$id("setHourlyPlan").popover({container:this.el,trigger:"manual",placement:"left",html:1,hasContent:!0,content:u({idPrefix:this.idPrefix}),template:'<div class="popover planning-mrp-toolbar-setHourlyPlans"><div class="arrow"></div><div class="popover-content"></div></div>'}),this.$popover.popover("show"))},"click #-setHourlyPlan-yes":function(){this.hidePopover(),this.setHourlyPlan()},"click #-setHourlyPlan-no":function(){this.hidePopover()},'click a[role="copyOrderList"]':function(t){this.copyOrderList(+t.currentTarget.dataset.shift)},'click a[role="printLines"]':function(e){var i=this,r=e.currentTarget.dataset.line,s=[];if(t.isString(r))if("__ALL__"===r)s=i.mrp.lines.models;else{var o=i.mrp.lines.get(r);o&&s.push(o)}else t.forEach(r,function(t){var e=i.mrp.lines.get(t);e&&s.push(e)});if(s.length){var a=n.getMoment(this.plan.id+" 06:00:00","YYYY-MM-DD HH:mm:ss").diff(Date.now(),"minutes");a>-1380||e.altKey?this.printLines(s):this.loadAndPrintLines(s)}},"click #-showTimes":function(){return this.plan.displayOptions.togglePrintOrderTime(),this.toggleShowTimes(),!1},"show.bs.dropdown #-printLines":"toggleShowTimes"},localTopics:{"planning.escapePressed":"hidePopover"},initialize:function(){this.listenTo(this.plan.lateOrders,"reset",this.scheduleRender),this.listenTo(this.plan.sapOrders,"reset",this.scheduleRender),this.listenTo(this.mrp.orders,"added removed changed reset",this.scheduleRender),this.listenTo(this.mrp.lines,"added removed changed reset",this.scheduleRender)},destroy:function(){this.hidePopover()},serialize:function(){return{idPrefix:this.idPrefix,lines:this.mrp.lines.map(function(t){return t.id}),stats:this.mrp.getStats()}},afterRender:function(){this.broker.publish("planning.mrpStatsRecounted",{mrp:this.mrp})},scheduleRender:function(){this.timers.render&&clearTimeout(this.timers.render),this.plan.isAnythingLoading()||(this.timers.render=setTimeout(this.render.bind(this),1))},hidePopover:function(){this.$popover&&(this.$popover.popover("destroy"),this.$popover=null)},copyOrderList:function(t){var e=this,n=e.plan.getOrderList(function(t){return!!e.mrp.lines.get(t.id)},t);o.copy(function(t){if(t){t.setData("text/plain",n.join("\r\n")),t.setData("text/html","<ul><li>"+n.join("</li><li>")+"</li></ul>");var r=e.$id("copyOrderList").tooltip({container:e.el,trigger:"manual",placement:"left",title:i("planning","toolbar:copyOrderList:success")});r.tooltip("show").data("bs.tooltip").tip().addClass("result success"),e.timers.hideTooltip&&clearTimeout(e.timers.hideTooltip),e.timers.hideTooltip=setTimeout(function(){r.tooltip("destroy")},1337)}})},loadAndPrintLines:function(s){var o=this,d=o.$id("printLines").find(".btn").prop("disabled",!0),u=d.find(".fa").removeClass("fa-print").addClass("fa-spinner fa-spin"),h=n.getMoment(o.plan.id+" 06:00:00","YYYY-MM-DD HH:mm:ss"),c=new a(null,{url:"/prodShifts?select(prodLine,shift,quantitiesDone)&limit(0)&date=in=("+[h.valueOf(),h.add(8,"hours").valueOf(),h.add(8,"hours").valueOf()]+")&prodLine=in=("+t.pluck(s,"id")+")"}),f=new p(null,{paginate:!1,plan:o.plan,mrp:o.mrp.id}),m=o.promised(c.fetch()),g=o.promised(f.fetch()),v=e.when(m,g);m.fail(function(){r.msg.show({type:"error",time:3e3,text:i("planning","MSG:LOADING_FAILURE:shifts")})}),g.fail(function(){r.msg.show({type:"error",time:3e3,text:i("planning","MSG:LOADING_FAILURE:sapOrders")})}),v.done(function(){var t={};c.forEach(function(e){var i=e.get("prodLine");t[i]||(t[i]=l.EMPTY_HOURLY_PLAN.slice());var n=8*(e.get("shift")-1);e.get("quantitiesDone").forEach(function(e,r){t[i][n+r]+=e.actual})}),o.printLines(s,f,t)}),v.always(function(){u.removeClass("fa-spinner fa-spin").addClass("fa-print"),d.prop("disabled",!1)})},printLines:function(e,n,s){var o=window.open(null,"PLANNING:PLAN_PRINT");return o?void(o.document.body.innerHTML=c({date:this.plan.id,lines:t.pluck(e,"id").join(", "),showTimes:!!n||this.plan.displayOptions.isOrderTimePrinted(),done:!!n,pages:this.serializePrintPages(e,n,s),pad:function(t){return t<10?"&nbsp;"+t:t}})):r.msg.show({type:"error",time:5e3,text:i("planning","toolbar:popups")})},serializePrintPages:function(e,r,s){var o=this,a=!!r,p=o.plan,d=-1,u=[],h={};return e.forEach(function(e){var c=[],f={pageNo:1,pageCount:1,mrp:e.settings.get("mrpPriority").join(" "),line:e.id,hourlyPlan:e.get("hourlyPlan"),quantityDone:a?s[e.id]||l.EMPTY_HOURLY_PLAN.slice():null,workerCount:"?",orders:[]};e.orders.forEach(function(i,s){var u=p.orders.get(i.get("orderNo")),m=l.getShiftNo(i.get("startAt")),g=d!==-1&&m!==d;d=m;var v=e.mrpSettings(u.get("mrp"));v&&!t.includes(c,v.get("workerCount"))&&c.push(v.get("workerCount"));var y=i.get("quantity"),P=a?p.shiftOrders.getTotalQuantityDone(e.id,m,u.id):-1,L={no:s+1,orderNo:u.id,nc12:u.get("nc12"),name:u.get("name"),kind:u.get("kind"),qtyTodo:u.get("quantityTodo"),qtyPlan:y,qtyClass:P===-1?"":P===y?"is-completed":P>y?"is-surplus":P>0?"is-incomplete":"",startAt:i.get("startAt"),finishAt:i.get("finishAt"),nextShift:g};if(f.orders.push(L),a&&!h[u.id]){var w=r.get(u.id),T=p.shiftOrders.findOrders(u.id,e.id).sort(function(t,e){return Date.parse(t.get("startedAt"))-Date.parse(e.get("startedAt"))}),D=w?o.delayReasons.get(w.get("delayReason")):"",O=w?w.get("comment"):"";D&&(D=D.getLabel(),O&&(D+=":")),T.forEach(function(t,e){f.orders.push({no:null,delayReason:0===e&&D?D:"",comment:0===e?O:"",qtyTodo:i.get("quantity"),qtyPlan:t.get("quantityDone"),startAt:n.utc.getMoment(n.getMoment(t.get("startedAt")).format("YYYY-MM-DD HH:mm:ss"),"YYYY-MM-DD HH:mm:ss").valueOf(),finishAt:n.utc.getMoment(n.getMoment(t.get("finishedAt")).format("YYYY-MM-DD HH:mm:ss"),"YYYY-MM-DD HH:mm:ss").valueOf(),nextShift:!1})}),T.length||!O&&!D||f.orders.push({no:null,delayReason:D,comment:O,qtyTodo:i.get("quantity"),qtyDone:0,startAt:null,finishAt:null,nextShift:!1}),h[u.id]=!0}}),0===c.length&&c.push(1),1===c.length?f.workerCount=i("planning","print:workerCount",{count:c[0]}):(c.sort(),f.workerCount=i("planning","print:workerCounts",{to:c.pop(),from:c.join("-")}));var m=42,g=35,v=f.orders.length;if(v<=m)return v>g&&(f.hourlyPlan=null,f.quantityDone=null),void u.push(f);for(var y=Math.ceil(v/m),P=1;P<=y;++P){var L=f.orders.slice((P-1)*m,P*m),w=P===y&&L.length<=g;u.push({pageNo:P,pageCount:y,mrp:f.mrp,line:f.line,hourlyPlan:w?f.hourlyPlan:null,quantityDone:w?f.quantityDone:null,workerCount:f.workerCount,orders:L})}}),u},toggleShowTimes:function(){this.$id("showTimes").blur().find(".fa").removeClass("fa-check fa-times").addClass(this.plan.displayOptions.isOrderTimePrinted()?"fa-check":"fa-times")},setHourlyPlan:function(){var t=this,e=t.$id("setHourlyPlan").prop("disabled",!0);r.msg.saving();var i=t.plan.setHourlyPlans(function(e){return!!t.mrp.lines.get(e.id)});i.fail(function(){r.msg.savingFailed()}),i.done(function(){r.msg.saved()}),i.always(function(){e.prop("disabled",!1)})}})});