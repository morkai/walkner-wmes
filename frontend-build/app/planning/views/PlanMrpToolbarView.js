// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/data/clipboard","../util/shift","app/planning/templates/toolbar","app/planning/templates/toolbarSetHourlyPlan","app/planning/templates/toolbarPrintLineList","app/planning/templates/printPage"],function(e,t,i,n,r,s,o,l,a,p,d,h){"use strict";return s.extend({template:a,events:{"click #-setHourlyPlan":function(){var e=this.$popover,t=this.$id("setHourlyPlan");this.hidePopover(),e&&e[0]===t[0]||(this.$popover=this.$id("setHourlyPlan").popover({container:this.el,trigger:"manual",placement:"left",html:1,hasContent:!0,content:p({idPrefix:this.idPrefix}),template:'<div class="popover planning-mrp-toolbar-setHourlyPlans"><div class="arrow"></div><div class="popover-content"></div></div>'}),this.$popover.popover("show"))},"click #-setHourlyPlan-yes":function(){this.hidePopover(),this.setHourlyPlan()},"click #-setHourlyPlan-no":function(){this.hidePopover()},'click a[role="copyOrderList"]':function(e){this.copyOrderList(+e.currentTarget.dataset.shift)},'click a[role="printLines"]':function(e){this.printLines(e.currentTarget.dataset.line)},"click #-showTimes":function(){return this.plan.displayOptions.togglePrintOrderTime(),this.toggleShowTimes(),!1},"show.bs.dropdown #-printLines":"toggleShowTimes"},localTopics:{"planning.escapePressed":"hidePopover"},initialize:function(){this.listenTo(this.plan.lateOrders,"reset",this.scheduleRender),this.listenTo(this.plan.sapOrders,"reset",this.scheduleRender),this.listenTo(this.mrp.orders,"added removed changed reset",this.scheduleRender),this.listenTo(this.mrp.lines,"added removed changed reset",this.scheduleRender)},destroy:function(){this.hidePopover()},serialize:function(){return{idPrefix:this.idPrefix,lines:this.mrp.lines.map(function(e){return e.id}),stats:this.mrp.getStats()}},afterRender:function(){this.broker.publish("planning.mrpStatsRecounted",{mrp:this.mrp})},scheduleRender:function(){this.timers.render&&clearTimeout(this.timers.render),this.plan.isAnythingLoading()||(this.timers.render=setTimeout(this.render.bind(this),1))},hidePopover:function(){this.$popover&&(this.$popover.popover("destroy"),this.$popover=null)},copyOrderList:function(e){var t=this,n=t.plan.getOrderList(function(e){return!!t.mrp.lines.get(e.id)},e);o.copy(function(e){if(e){e.setData("text/plain",n.join("\r\n")),e.setData("text/html","<ul><li>"+n.join("</li><li>")+"</li></ul>");var r=t.$id("copyOrderList").tooltip({container:t.el,trigger:"manual",placement:"left",title:i("planning","toolbar:copyOrderList:success")});r.tooltip("show").data("bs.tooltip").tip().addClass("result success"),t.timers.hideTooltip&&clearTimeout(t.timers.hideTooltip),t.timers.hideTooltip=setTimeout(function(){r.tooltip("destroy")},1337)}})},printLines:function(t){var n=this.mrp,s=[];if(e.isString(t))if("__ALL__"===t)s=n.lines.models;else{var o=n.lines.get(t);o&&s.push(o)}else e.forEach(t,function(e){var t=n.lines.get(e);t&&s.push(t)});if(s.length){var l=window.open(null,"PLANNING:PLAN_PRINT");return l?void(l.document.body.innerHTML=h({date:this.plan.id,lines:e.pluck(s,"id").join(", "),showTimes:this.plan.displayOptions.isOrderTimePrinted(),pages:this.serializePrintPages(s)})):r.msg.show({type:"error",time:5e3,text:i("planning","toolbar:popups")})}},serializePrintPages:function(t){var n=this.plan,r=-1,s=[];return t.forEach(function(t){var o=[],a={pageNo:1,pageCount:1,mrp:t.settings.get("mrpPriority").join(" "),line:t.id,hourlyPlan:t.get("hourlyPlan"),workerCount:"?",orders:t.orders.map(function(i,s){var a=n.orders.get(i.get("orderNo")),p=l.getShiftNo(i.get("startAt")),d=r!==-1&&p!==r;r=p;var h=t.mrpSettings(a.get("mrp"));return h&&!e.includes(o,h.get("workerCount"))&&o.push(h.get("workerCount")),{no:s+1,orderNo:a.id,nc12:a.get("nc12"),name:a.get("name"),kind:a.get("kind"),qtyTodo:a.get("quantityTodo"),qtyPlan:i.get("quantity"),startAt:i.get("startAt"),finishAt:i.get("finishAt"),nextShift:d}})};0===o.length&&o.push(1),1===o.length?a.workerCount=i("planning","print:workerCount",{count:o[0]}):(o.sort(),a.workerCount=i("planning","print:workerCounts",{to:o.pop(),from:o.join("-")}));var p=42,d=35,h=a.orders.length;if(h<=p)return h>d&&(a.hourlyPlan=null),void s.push(a);for(var u=Math.ceil(h/p),c=1;c<=u;++c){var g=a.orders.slice((c-1)*p,c*p);s.push({pageNo:c,pageCount:u,line:a.line,hourlyPlan:c===u&&g.length<=d?a.hourlyPlan:null,orders:g})}}),s},toggleShowTimes:function(){this.$id("showTimes").blur().find(".fa").removeClass("fa-check fa-times").addClass(this.plan.displayOptions.isOrderTimePrinted()?"fa-check":"fa-times")},setHourlyPlan:function(){var e=this,t=e.$id("setHourlyPlan").prop("disabled",!0);r.msg.saving();var i=e.plan.setHourlyPlans(function(t){return!!e.mrp.lines.get(t.id)});i.fail(function(){r.msg.savingFailed()}),i.done(function(){r.msg.saved()}),i.always(function(){t.prop("disabled",!1)})}})});