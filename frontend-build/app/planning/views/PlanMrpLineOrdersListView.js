// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/core/View","app/data/clipboard","../util/shift","../util/contextMenu","app/planning/templates/lineOrdersList"],function(e,t,i,n,r,s,o,a,l){"use strict";return r.extend({template:l,events:{"mouseenter tr":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!0,orderNo:e.currentTarget.dataset.id})},"mouseleave tr":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!1,orderNo:e.currentTarget.dataset.id})},"contextmenu tr":function(e){return this.showMenu(e),!1},"dblclick tr":function(e){window.getSelection().removeAllRanges();var t=e.currentTarget,i=t.dataset.index,n=e.clientY-e.currentTarget.getBoundingClientRect().top;this.$el.toggleClass("is-expanded"),this.expanded=this.$el.hasClass("is-expanded"),this.expanded?window.scrollTo(0,window.scrollY+t.getBoundingClientRect().top-e.clientY+n):i>=10&&(window.scrollTo(0,this.$el.closest(".planning-mrp")[0].offsetTop),e.currentTarget.scrollIntoView({block:"center"}),window.scrollBy(0,(e.clientY-t.getBoundingClientRect().top-n)*-1))},wheel:function(e){return this.expanded||e.target.classList.contains("no-scroll")?window.scrollBy(e.originalEvent.deltaX,e.originalEvent.deltaY):this.el.scrollBy(e.originalEvent.deltaX,e.originalEvent.deltaY),!1}},initialize:function(){var e=this;e.expanded=!1,e.listenTo(e.mrp.lines,"reset changed",e.renderIfNotLoading),e.listenTo(e.mrp.orders,"highlight",e.onOrderHighlight)},serialize:function(){return{idPrefix:this.idPrefix,expanded:this.expanded,orders:this.serializeOrders()}},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},serializeOrders:function(){var t=this.mrp,i={};return t.lines.forEach(function(e){e.orders.forEach(function(n){var r=n.get("orderNo"),s=t.orders.get(r);if(s){var o=i[r];o||(o=i[r]={orderNo:s.id,nc12:s.get("nc12"),name:s.get("name"),startTime:Number.MAX_VALUE,finishTime:0,qtyTodo:s.get("quantityTodo"),qtyPlan:0,lines:{}}),o.qtyPlan+=n.get("quantity");var a=Date.parse(n.get("startAt"));a<o.startTime&&(o.startTime=a);var l=Date.parse(n.get("finishAt"));l>o.finishTime&&(o.finishTime=l),o.lines[e.id]||(o.lines[e.id]=0),o.lines[e.id]+=n.get("quantity")}})}),e.values(i).sort(function(e,t){return e.startTime-t.startTime}).map(function(t,i){return t.no=i+1,t.shift=o.getShiftNo(t.startTime),t.startTime=n.utc.format(t.startTime,"HH:mm:ss"),t.finishTime=n.utc.format(t.finishTime,"HH:mm:ss"),t.lines=e.map(t.lines,function(e,t){return t+" ("+e+")"}).join("; "),t})},hideMenu:function(){a.hide(this)},showMenu:function(e){var t=e.currentTarget.dataset.id,n=[a.actions.sapOrder(t)];(this.plan.shiftOrders.findOrders(t).length||this.plan.getActualOrderData(t).quantityDone)&&n.push({label:i("planning","orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,t)}),this.plan.canCommentOrders()&&n.push(a.actions.comment(t)),n.push({label:i("planning","lineOrders:menu:copy"),handler:this.handleCopyAction.bind(this,e.currentTarget,e.pageY,e.pageX)}),a.show(this,e.pageY,e.pageX,n)},handleShiftOrderAction:function(e){var t=this.plan.shiftOrders.findOrders(e);return 1===t.length?window.open("/#prodShiftOrders/"+t[0].id):void window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+e)},handleCopyAction:function(e,t,n){var r=this;s.copy(function(s){if(s){var o=[["no","shift","orderNo","nc12","name","qtyPlan","qtyTodo","startTime","finishTime","lines"].map(function(e){return i("planning","lineOrders:list:"+e)}).join("\t")];r.serializeOrders().forEach(function(e){var t=[e.no,e.shift,e.orderNo,e.nc12,e.name,e.qtyPlan,e.qtyTodo,e.startTime,e.finishTime,e.lines];o.push(t.join("\t"))}),s.setData("text/plain",o.join("\r\n"));var a=r.$(e).tooltip({container:r.el,trigger:"manual",placement:"bottom",title:i("planning","lineOrders:menu:copy:success")});a.tooltip("show").data("bs.tooltip").tip().addClass("result success").css({left:n+"px",top:t+"px"}),r.timers.hideTooltip&&clearTimeout(r.timers.hideTooltip),r.timers.hideTooltip=setTimeout(function(){a.tooltip("destroy")},1337)}})},onOrderHighlight:function(e){if("lineOrders"!==e.source&&this.mrp.orders.get(e.orderNo)){var t=this.$('tr[data-id="'+e.orderNo+'"]').toggleClass("is-highlighted",e.state)[0];t&&!this.expanded&&(this.el.scrollTop=t.offsetTop)}}})});