define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/data/clipboard","../util/shift","../util/contextMenu","../PlanSapOrder","./PlanOrderDropZoneDialogView","app/core/templates/userInfo","app/planning/templates/lineOrdersList","app/planning/templates/lineOrderComments","app/planning/templates/orderStatusIcons"],function(t,e,n,i,r,s,o,a,d,l,p,h,c,m,u){"use strict";return s.extend({template:c,modelProperty:"plan",events:{"mouseenter tbody > tr":function(t){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!0,orderNo:t.currentTarget.dataset.id})},"mouseleave tbody > tr":function(t){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!1,orderNo:t.currentTarget.dataset.id})},"contextmenu tbody > tr":function(t){return this.showMenu(t),!1},"dblclick tr":function(t){window.getSelection().removeAllRanges();var e=t.currentTarget,n=e.dataset.index,i=t.clientY-t.currentTarget.getBoundingClientRect().top;this.$el.toggleClass("is-expanded"),this.expanded=this.$el.hasClass("is-expanded"),this.expanded?window.scrollTo(0,window.scrollY+e.getBoundingClientRect().top-t.clientY+i):n>=10&&(window.scrollTo(0,this.$el.closest(".planning-mrp")[0].offsetTop),t.currentTarget.scrollIntoView({block:"center"}),window.scrollBy(0,-1*(t.clientY-e.getBoundingClientRect().top-i)))},"mousedown .planning-mrp-lineOrders-comment":function(t){if(0===t.button){var e=this.plan.sapOrders.get(t.currentTarget.parentNode.dataset.id);if(e){var n=e.get("comments");n.length&&this.$(t.currentTarget).popover({trigger:"manual",placement:"left",html:!0,content:m({comments:n.map(function(t){return{user:h({noIp:!0,userInfo:t.user}),time:i.toTagData(t.time).human,text:l.formatCommentWithIcon(t)}})}),template:'<div class="popover planning-mrp-comment-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")}}},"mouseup .planning-mrp-lineOrders-comment":function(t){this.$(t.currentTarget).popover("destroy")},"click .planning-mrp-lineOrders-dropZone":function(t){this.handleDropZoneAction(this.$(t.target).closest("tr").attr("data-id"))},'click th[data-id="startTime"]':function(){this.reorder("startTime")},'click th[data-id="lines"]':function(){this.reorder("lines")}},initialize:function(){this.expanded=!1,this.listenTo(this.mrp.lines,"reset added changed removed",this.renderIfNotLoading),this.listenTo(this.mrp.orders,"highlight",this.onOrderHighlight),this.listenTo(this.plan.sapOrders,"change:comments",this.onCommentChange),this.listenTo(this.plan.sapOrders,"reset",this.onSapOrdersReset),this.listenTo(this.plan.sapOrders,"change:psStatus",this.onPsStatusChanged)},getTemplateData:function(){return{version:this.plan.settings.getVersion(),expanded:this.expanded,orders:this.serializeOrders()}},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},serializeOrders:function(){const e=this.plan.sapOrders,n={};this.mrp.lines.forEach(t=>{t.orders.forEach(i=>{const r=i.get("orderNo"),s=this.plan.orders.get(r),o=e.get(r);let a=n[r];if(a||(a=n[r]={orderNo:r,nc12:s?s.get("nc12"):"",name:s?s.get("name"):"",startTime:Number.MAX_VALUE,finishTime:0,qtyTodo:s?s.get("quantityTodo"):-1,qtyPlan:0,lines:{},comment:o?o.getCommentWithIcon():"",comments:o?o.get("comments"):[],status:s?s.getStatus():"missing",statuses:this.serializeOrderStatuses(r),orderGroup:"",rowClassName:""}),!a.orderGroup){const t=i.get("group");if(t){const e=this.orderGroups.get(t);a.orderGroup=e?e.getLabel():t}}a.qtyPlan+=i.get("quantity");const d=Date.parse(i.get("startAt"));d<a.startTime&&(a.startTime=d);const l=Date.parse(i.get("finishAt"));l>a.finishTime&&(a.finishTime=l),a.lines[t.id]||(a.lines[t.id]=0),a.lines[t.id]+=i.get("quantity")})});const r=t.values(n);r.forEach(e=>{e.shift=a.getShiftNo(e.startTime),e.lineSort=Object.keys(e.lines).join(" "),e.lines=t.map(e.lines,(t,e)=>`${e} (${t})`).join("; ")});const s="startTime"===this.plan.displayOptions.get("lineOrdersSort");return r.sort((t,e)=>{if(s)return t.startTime-e.startTime;let n=t.lineSort.localeCompare(e.lineSort,void 0,{numeric:!0});return 0===n&&(n=t.startTime-e.startTime),n}),r.forEach((t,e)=>{t.startTime=i.utc.format(t.startTime,"HH:mm:ss"),t.finishTime=i.utc.format(t.finishTime,"HH:mm:ss"),t.no=e+1}),r},serializeOrderStatuses:function(t){return u(this.plan,t)},formatIcon:function(e,n){return'<span class="planning-mrp-list-property" title="'+t.escape(this.t(n))+'"><i class="fa '+e+'"></i></span>'},reorder:function(t){this.plan.displayOptions.set("lineOrdersSort",t),this.render()},hideMenu:function(){d.hide(this)},showMenu:function(t){var e=t.currentTarget.dataset.id,n=[d.actions.sapOrder(e)];(this.plan.shiftOrders.findOrders(e).length||this.plan.getActualOrderData(e).quantityDone)&&n.push({icon:"fa-file-text-o",label:this.t("orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,e)}),this.plan.canCommentOrders()&&n.push(d.actions.commentPopover(e)),n.push({icon:"fa-clipboard",label:this.t("lineOrders:menu:copy"),handler:this.handleCopyAction.bind(this,t.currentTarget,t.pageY,t.pageX)}),d.show(this,t.pageY,t.pageX,n)},handleShiftOrderAction:function(t){var e=this.plan.shiftOrders.findOrders(t);if(1===e.length)return window.open("/#prodShiftOrders/"+e[0].id);window.open("/#prodShiftOrders?sort(startedAt)&limit(-1337)&orderId=string:"+t)},handleCopyAction:function(t,e,n){var i=this;o.copy(function(t){if(t){var r=[["no","shift","orderNo","nc12","name","qtyPlan","qtyTodo","startTime","finishTime","lines","comment"].map(function(t){return i.t("lineOrders:list:"+t)}).join("\t")];i.serializeOrders().forEach(function(t){var e=[t.no,t.shift,t.orderNo,t.nc12,t.name,t.qtyPlan,t.qtyTodo,t.startTime,t.finishTime,t.lines,'"'+t.comments.map(function(t){return t.user.label+": "+t.text.replace(/"/g,"'")}).join("\r\n--\r\n")+'"'];r.push(e.join("\t"))}),t.setData("text/plain",r.join("\r\n")),o.showTooltip({x:n,y:e,text:i.t("lineOrders:menu:copy:success")})}})},onOrderHighlight:function(t){if("lineOrders"!==t.source&&this.mrp.orders.get(t.orderNo)){var e=this.$('tr[data-id="'+t.orderNo+'"]').toggleClass("is-highlighted",t.state)[0];e&&!this.expanded&&(this.el.scrollTop=e.offsetTop)}},onCommentChange:function(t){this.mrp.orders.get(t.id)&&this.$('tr[data-id="'+t.id+'"] > .planning-mrp-lineOrders-comment').html(t.getCommentWithIcon())},onSapOrdersReset:function(t,e){e.reload||!this.plan.displayOptions.isLatestOrderDataUsed()||this.plan.isAnythingLoading()||this.render()},onPsStatusChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');if(e.length){var n=this.plan.sapOrders.getPsStatus(t.id);e.find(".planning-mrp-list-property-psStatus").attr("title",this.t("orders:psStatus:"+n)).attr("data-ps-status",n)}}})});