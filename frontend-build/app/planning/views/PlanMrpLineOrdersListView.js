// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/core/View","app/data/clipboard","../util/shift","../util/contextMenu","../PlanSapOrder","app/core/templates/userInfo","app/planning/templates/lineOrdersList","app/planning/templates/lineOrderComments"],function(t,e,n,i,r,o,s,a,d,l,c,p){"use strict";return r.extend({template:c,events:{"mouseenter tbody > tr":function(t){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!0,orderNo:t.currentTarget.dataset.id})},"mouseleave tbody > tr":function(t){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!1,orderNo:t.currentTarget.dataset.id})},"contextmenu tbody > tr":function(t){return this.showMenu(t),!1},"dblclick tr":function(t){window.getSelection().removeAllRanges();var e=t.currentTarget,n=e.dataset.index,i=t.clientY-t.currentTarget.getBoundingClientRect().top;this.$el.toggleClass("is-expanded"),this.expanded=this.$el.hasClass("is-expanded"),this.expanded?window.scrollTo(0,window.scrollY+e.getBoundingClientRect().top-t.clientY+i):n>=10&&(window.scrollTo(0,this.$el.closest(".planning-mrp")[0].offsetTop),t.currentTarget.scrollIntoView({block:"center"}),window.scrollBy(0,(t.clientY-e.getBoundingClientRect().top-i)*-1))},"mousedown td.no-scroll":function(t){if(0===t.button){var e=this.plan.sapOrders.get(t.currentTarget.parentNode.dataset.id);if(e){var n=e.get("comments");n.length&&this.$(t.currentTarget).popover({trigger:"manual",placement:"left",html:!0,content:p({comments:n.map(function(t){return{user:l({noIp:!0,userInfo:t.user}),time:i.toTagData(t.time).human,text:d.formatCommentWithIcon(t)}})}),template:'<div class="popover planning-mrp-comment-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")}}},"mouseup td.no-scroll":function(t){this.$(t.currentTarget).popover("destroy")}},initialize:function(){var t=this;t.expanded=!1,t.listenTo(t.mrp.lines,"reset changed",t.renderIfNotLoading),t.listenTo(t.mrp.orders,"highlight",t.onOrderHighlight),t.listenTo(t.plan.sapOrders,"change:comments",t.onCommentChange)},serialize:function(){return{idPrefix:this.idPrefix,expanded:this.expanded,orders:this.serializeOrders()}},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},serializeOrders:function(){var e=this.plan.sapOrders,n=this.mrp,r={};return n.lines.forEach(function(t){t.orders.forEach(function(i){var o=i.get("orderNo"),s=n.orders.get(o);if(s){var a=e.get(o),d=r[o];d||(d=r[o]={orderNo:s.id,nc12:s.get("nc12"),name:s.get("name"),startTime:Number.MAX_VALUE,finishTime:0,qtyTodo:s.get("quantityTodo"),qtyPlan:0,lines:{},comment:a?a.getCommentWithIcon():"",comments:a?a.get("comments"):[]}),d.qtyPlan+=i.get("quantity");var l=Date.parse(i.get("startAt"));l<d.startTime&&(d.startTime=l);var c=Date.parse(i.get("finishAt"));c>d.finishTime&&(d.finishTime=c),d.lines[t.id]||(d.lines[t.id]=0),d.lines[t.id]+=i.get("quantity")}})}),t.values(r).sort(function(t,e){return t.startTime-e.startTime}).map(function(e,n){return e.no=n+1,e.shift=s.getShiftNo(e.startTime),e.startTime=i.utc.format(e.startTime,"HH:mm:ss"),e.finishTime=i.utc.format(e.finishTime,"HH:mm:ss"),e.lines=t.map(e.lines,function(t,e){return e+" ("+t+")"}).join("; "),e})},hideMenu:function(){a.hide(this)},showMenu:function(t){var e=t.currentTarget.dataset.id,i=[a.actions.sapOrder(e)];(this.plan.shiftOrders.findOrders(e).length||this.plan.getActualOrderData(e).quantityDone)&&i.push({icon:"fa-file-text-o",label:n("planning","orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,e)}),this.plan.canCommentOrders()&&i.push(a.actions.comment(e)),i.push({icon:"fa-clipboard",label:n("planning","lineOrders:menu:copy"),handler:this.handleCopyAction.bind(this,t.currentTarget,t.pageY,t.pageX)}),a.show(this,t.pageY,t.pageX,i)},handleShiftOrderAction:function(t){var e=this.plan.shiftOrders.findOrders(t);return 1===e.length?window.open("/#prodShiftOrders/"+e[0].id):void window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+t)},handleCopyAction:function(t,e,i){var r=this;o.copy(function(o){if(o){var s=["no","shift","orderNo","nc12","name","qtyPlan","qtyTodo","startTime","finishTime","lines","comment"],a=[s.map(function(t){return n("planning","lineOrders:list:"+t)}).join("\t")];r.serializeOrders().forEach(function(t){var e=[t.no,t.shift,t.orderNo,t.nc12,t.name,t.qtyPlan,t.qtyTodo,t.startTime,t.finishTime,t.lines,'"'+t.comments.map(function(t){return t.user.label+": "+t.text.replace(/"/g,"'")}).join("\r\n--\r\n")+'"'];a.push(e.join("\t"))}),o.setData("text/plain",a.join("\r\n"));var d=r.$(t).tooltip({container:r.el,trigger:"manual",placement:"bottom",title:n("planning","lineOrders:menu:copy:success")});d.tooltip("show").data("bs.tooltip").tip().addClass("result success").css({left:i+"px",top:e+"px"}),r.timers.hideTooltip&&clearTimeout(r.timers.hideTooltip),r.timers.hideTooltip=setTimeout(function(){d.tooltip("destroy")},1337)}})},onOrderHighlight:function(t){if("lineOrders"!==t.source&&this.mrp.orders.get(t.orderNo)){var e=this.$('tr[data-id="'+t.orderNo+'"]').toggleClass("is-highlighted",t.state)[0];e&&!this.expanded&&(this.el.scrollTop=e.offsetTop)}},onCommentChange:function(t){this.mrp.orders.get(t.id)&&this.$('tr[data-id="'+t.id+'"] > .no-scroll').html(t.getCommentWithIcon())}})});