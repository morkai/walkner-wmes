// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/core/View","../util/shift","../util/contextMenu","app/planning/templates/lineOrdersList"],function(e,t,i,r,n,s,o,a){"use strict";return n.extend({template:a,events:{"mouseenter tr":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!0,orderNo:e.currentTarget.dataset.id})},"mouseleave tr":function(e){this.mrp.orders.trigger("highlight",{source:"lineOrders",state:!1,orderNo:e.currentTarget.dataset.id})},"contextmenu tr":function(e){return this.showMenu(e),!1},"dblclick tr":function(e){window.getSelection().removeAllRanges();var t=e.currentTarget,i=t.dataset.index,r=e.clientY-e.currentTarget.getBoundingClientRect().top;this.$el.toggleClass("is-expanded"),this.$el.hasClass("is-expanded")?window.scrollTo(0,window.scrollY+t.getBoundingClientRect().top-e.clientY+r):i>=10&&(window.scrollTo(0,this.$el.closest(".planning-mrp")[0].offsetTop),e.currentTarget.scrollIntoView({block:"center"}),window.scrollBy(0,(e.clientY-t.getBoundingClientRect().top-r)*-1))},wheel:function(e){return e.target.classList.contains("no-scroll")||this.el.classList.contains("is-expanded")?window.scrollBy(e.originalEvent.deltaX,e.originalEvent.deltaY):this.el.scrollBy(e.originalEvent.deltaX,e.originalEvent.deltaY),!1}},initialize:function(){var e=this;e.listenTo(e.mrp.orders,"reset changed",e.renderIfNotLoading),e.listenTo(e.mrp.orders,"highlight",e.onOrderHighlight)},serialize:function(){return{idPrefix:this.idPrefix,orders:this.serializeOrders()}},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},serializeOrders:function(){var t=this.mrp,i={};return t.lines.forEach(function(e){e.orders.forEach(function(r){var n=r.get("orderNo"),s=t.orders.get(n);if(s){var o=i[n];o||(o=i[n]={orderNo:s.id,nc12:s.get("nc12"),name:s.get("name"),startTime:Number.MAX_VALUE,finishTime:0,qtyTodo:s.get("quantityTodo"),qtyPlan:0,lines:{}}),o.qtyPlan+=r.get("quantity");var a=Date.parse(r.get("startAt"));a<o.startTime&&(o.startTime=a);var d=Date.parse(r.get("finishAt"));d>o.finishTime&&(o.finishTime=d),o.lines[e.id]||(o.lines[e.id]=0),o.lines[e.id]+=r.get("quantity")}})}),e.values(i).sort(function(e,t){return e.startTime-t.startTime}).map(function(t,i){return t.no=i+1,t.shift=s.getShiftNo(t.startTime),t.startTime=r.utc.format(t.startTime,"HH:mm:ss"),t.finishTime=r.utc.format(t.finishTime,"HH:mm:ss"),t.lines=e.map(t.lines,function(e,t){return t+" ("+e+")"}).join("; "),t})},hideMenu:function(){o.hide(this)},showMenu:function(e){var t=e.currentTarget.dataset.id,r=[o.actions.sapOrder(t)];(this.plan.shiftOrders.findOrders(t).length||this.plan.getActualOrderData(t).quantityDone)&&r.push({label:i("planning","orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,t)}),this.plan.canCommentOrders()&&r.push(o.actions.comment(t)),o.show(this,e.pageY,e.pageX,r)},handleShiftOrderAction:function(e){var t=this.plan.shiftOrders.findOrders(e);return 1===t.length?window.open("/#prodShiftOrders/"+t[0].id):void window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+e)},onOrderHighlight:function(e){if("lineOrders"!==e.source&&this.mrp.orders.get(e.orderNo)){var t=this.$('tr[data-id="'+e.orderNo+'"]').toggleClass("is-highlighted",e.state)[0];t&&!this.el.classList.contains("is-expanded")&&(this.el.scrollTop=t.offsetTop)}}})});