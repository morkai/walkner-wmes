define(["underscore","jquery","Sortable","app/i18n","app/viewport","app/core/View","app/core/util/idAndLabel","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/lineSettingsDialog"],function(t,e,i,r,o,s,n,a,l){"use strict";return s.extend({modelProperty:"plan",template:l,events:{submit:function(){return this.submitForm(),!1},"change #-orderGroupPriority":function(){o.adjustDialogBackdrop()}},initialize:function(){this.sortables=[],this.listenTo(this.plan.settings,"changed",this.onSettingsChanged)},destroy:function(){this.destroySortables()},destroySortables:function(){t.invoke(this.sortables,"destroy"),this.sortables=[]},getTemplateData:function(){var t=this.line.settings,e=this.line.mrpSettings(this.mrp.id);return{version:this.plan.settings.getVersion(),mrp:this.mrp.getLabel(),line:this.line.getLabel(),mrpPriority:t.get("mrpPriority").join(","),orderGroupPriority:(t.get("orderGroupPriority")||[]).join(","),activeTime:t.get("activeTime").map(function(t){return t.from+"-"+t.to}).join(", "),workerCount:e.get("workerCount"),orderPriority:e.get("orderPriority").join(","),extraCapacity:t.get("extraCapacity")||"0"}},afterRender:function(){this.setUpMrpPriority(),this.setUpOrderGroupPriority(),this.setUpOrderPriority()},setUpMrpPriority:function(){var t=this;a(t.$id("mrpPriority"),{view:t,sortable:!0,width:"100%",placeholder:t.t("settings:mrpPriority:placeholder"),itemDecorator:function(e){return e.disabled=t.plan.settings.isMrpLocked(e.id),e.locked=e.disabled,e.locked&&(e.icon={id:"fa-lock",color:"#e00"}),e}})},setUpOrderGroupPriority:function(){var t=this.$id("orderGroupPriority").select2({allowClear:!0,multiple:!0,data:this.orderGroups.map(n)});this.sortables.push(new i(t.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){t.select2("onSortStart")},onEnd:function(){t.select2("onSortEnd").select2("focus")}}))},setUpOrderPriority:function(){var t=this,e=t.$id("orderPriority").select2({allowClear:!0,multiple:!0,data:t.plan.settings.getAvailableOrderPriorities().map(function(e){return{id:e,text:t.t("orderPriority:"+e)}})});t.sortables.push(new i(e.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){e.select2("onSortStart")},onEnd:function(){e.select2("onSortEnd").select2("focus")}}))},submitForm:function(){var t=this,e=t.$id("submit").prop("disabled",!0),i=e.find(".fa-spinner").removeClass("hidden"),r=t.plan.settings,s=t.line.settings,n=this.$id("extraCapacity").val().trim()||"0";"0%"===n&&(n="0"),s.set({mrpPriority:t.$id("mrpPriority").val().split(","),orderGroupPriority:(t.$id("orderGroupPriority").val()||"").split(",").filter(t=>!!t),activeTime:t.$id("activeTime").val().split(",").map(t=>{var e=t.trim().split("-");return{from:e[0],to:e[1]}}).filter(t=>!!t.from&&!!t.to),extraCapacity:n});var a=s.get("mrpPriority"),l=t.$id("orderPriority").val().split(","),d=t.$id("applyToAllMrps").prop("checked"),p=[1,2,3].map(e=>Math.max(0,+t.$id(`workerCount${e}`).val()||0));a.forEach(e=>{var i=r.mrps.get(e);i||(i=r.mrps.add({_id:e}).get(e));var o=i.lines.get(t.line.id);o||(o=i.lines.add({_id:t.line.id}).get(t.line.id)),(d||o.id===t.line.id)&&o.set({workerCount:p,orderPriority:l})}),o.msg.saving();var c=t.plan.settings.save();c.done(()=>{o.msg.saved(),o.closeDialog()}),c.fail(()=>{i.addClass("hidden"),e.prop("disabled",!1),o.msg.savingFailed(),t.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("mrpPriority").select2("focus")},onSettingsChanged:function(e){if(e.locked){var i=this,r=i.$id("mrpPriority"),o=i.line.settings.get("mrpPriority"),s=r.val().split(",").filter(function(e){return e.length>0&&(t.includes(o,e)||!i.plan.settings.isMrpLocked(e))});r.select("destroy").val(s.join(",")),this.setUpMrpPriority()}}})});