define(["underscore","jquery","Sortable","app/i18n","app/viewport","app/core/View","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/lineSettingsDialog"],function(t,i,e,r,o,n,s,l){"use strict";return n.extend({modelProperty:"plan",template:l,events:{submit:function(){return this.submitForm(),!1}},initialize:function(){this.sortables=[],this.listenTo(this.plan.settings,"changed",this.onSettingsChanged)},destroy:function(){this.destroySortables()},destroySortables:function(){t.invoke(this.sortables,"destroy"),this.sortables=[]},getTemplateData:function(){var t=this.line.settings,i=this.line.mrpSettings(this.mrp.id);return{mrp:this.mrp.getLabel(),line:this.line.getLabel(),mrpPriority:t.get("mrpPriority").join(","),activeTime:t.get("activeTime").map(function(t){return t.from+"-"+t.to}).join(", "),workerCount:i.get("workerCount"),orderPriority:i.get("orderPriority").join(",")}},afterRender:function(){this.setUpMrpPriority(),this.setUpOrderPriority()},setUpMrpPriority:function(){var t=this;s(t.$id("mrpPriority"),{view:t,sortable:!0,width:"100%",placeholder:t.t("settings:mrpPriority:placeholder"),itemDecorator:function(i){return i.disabled=t.plan.settings.isMrpLocked(i.id),i.locked=i.disabled,i.locked&&(i.icon={id:"fa-lock",color:"#e00"}),i}})},setUpOrderPriority:function(){var t=this.$id("orderPriority").select2({allowClear:!0,multiple:!0,data:[{id:"small",text:this.t("orderPriority:small")},{id:"easy",text:this.t("orderPriority:easy")},{id:"hard",text:this.t("orderPriority:hard")}]});this.sortables.push(new e(t.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){t.select2("onSortStart")},onEnd:function(){t.select2("onSortEnd").select2("focus")}}))},submitForm:function(){var t=this,i=t.$id("submit").prop("disabled",!0),e=i.find(".fa-spinner").removeClass("hidden"),r=t.plan.settings,n=t.line.settings;n.set({mrpPriority:t.$id("mrpPriority").val().split(","),activeTime:t.$id("activeTime").val().split(",").map(function(t){var i=t.trim().split("-");return{from:i[0],to:i[1]}}).filter(function(t){return!!t.from&&!!t.to})});var s=n.get("mrpPriority"),l=t.$id("orderPriority").val().split(","),a=t.$id("applyToAllMrps").prop("checked"),d=[1,2,3].map(function(i){return Math.max(0,+t.$id("workerCount"+i).val()||0)});s.forEach(function(i){var e=r.mrps.get(i);e||(e=e.add({_id:i}).get(i));var o=e.lines.get(t.line.id);o||(o=e.lines.add({_id:t.line.id}).get(t.line.id)),(a||o.id===t.line.id)&&o.set({workerCount:d,orderPriority:l})});var p=t.plan.settings.save();p.done(o.closeDialog),p.fail(function(){e.addClass("hidden"),i.prop("disabled",!1),o.msg.show({type:"error",time:3e3,text:t.t("lines:menu:remove:failure")}),t.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("mrpPriority").select2("focus")},onSettingsChanged:function(i){if(i.locked){var e=this,r=e.$id("mrpPriority"),o=e.line.settings.get("mrpPriority"),n=r.val().split(",").filter(function(i){return i.length>0&&(t.includes(o,i)||!e.plan.settings.isMrpLocked(i))});r.select("destroy").val(n.join(",")),this.setUpMrpPriority()}}})});