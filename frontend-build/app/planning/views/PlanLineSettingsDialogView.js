define(["underscore","jquery","select2","Sortable","app/i18n","app/viewport","app/core/View","app/core/util/idAndLabel","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/lineSettingsDialog"],function(t,e,i,r,s,o,n,a,l,p){"use strict";return n.extend({modelProperty:"plan",template:p,events:{submit:function(){return this.submitForm(),!1},"change #-orderGroupPriority":function(){o.adjustDialogBackdrop()},"change #-activeTime":function(){const t=this.$id("activeTime"),e=t.val().trim().split(/[\s,]+/).map(t=>{const e=t.trim().split("-"),i=e[0].split(":"),r=(e[1]||"0").split(":");return`${(parseInt(i[0],10)||0).toString().padStart(2,"0")}:${(parseInt(i[1],10)||0).toString().padStart(2,"0")}-${(parseInt(r[0],10)||0).toString().padStart(2,"0")}:${(parseInt(r[1],10)||0).toString().padStart(2,"0")}`}).filter(t=>"00:00-00:00"!==t&&"06:00-06:00"!==t).join(", ");t.val(e)},'blur input[name^="workerCount"]':function(t){let e=parseInt(t.target.value,10);(!e||e<=0)&&(e=""),t.target.value=e}},initialize:function(){this.sortables=[],this.listenTo(this.plan.settings,"changed",this.onSettingsChanged)},destroy:function(){this.destroySortables()},destroySortables:function(){t.invoke(this.sortables,"destroy"),this.sortables=[]},getTemplateData:function(){const t=this.plan.settings.getVersion(),e=this.line.settings,i=this.line.mrpSettings(this.mrp.id);return{version:t,mrp:this.mrp.getLabel(),line:this.line.getLabel(),mrpPriority:e.get("mrpPriority").join(","),orderGroupPriority:(e.get("orderGroupPriority")||[]).join(","),activeTime:e.get("activeTime").map(t=>`${t.from}-${t.to}`).join(", "),workerCount:(1===t?i:e).get("workerCount"),orderPriority:(1===t?i:e).get("orderPriority").join(","),extraCapacity:e.get("extraCapacity")||"0"}},afterRender:function(){this.setUpMrpPriority(),this.setUpOrderGroupPriority(),this.setUpOrderPriority()},setUpMrpPriority:function(){l(this.$id("mrpPriority"),{view:this,sortable:!0,width:"100%",placeholder:this.t("settings:mrpPriority:placeholder"),itemDecorator:t=>(t.disabled=this.plan.settings.isMrpLocked(t.id),t.locked=t.disabled,t.locked&&(t.icon={id:"fa-lock",color:"#e00"}),t)})},setUpOrderGroupPriority:function(){const e=this.$id("orderGroupPriority");if(!e.length)return;const s=this.$id("mrpPriority").select2("val"),o=this.orderGroups.map(e=>{const i=e.get("mrp")||[];return{id:e.id,text:e.getLabel(),mrps:i,search:(e.getLabel()+" "+i.join(" ")).trim().toUpperCase(),hasLineMrps:t.intersection(i,s).length>0,model:e}});o.sort((t,e)=>t.model.isNoMatchGroup()?-1:e.model.isNoMatchGroup()?1:t.hasLineMrps===e.hasLineMrps?t.text.localeCompare(e.text,void 0,{numeric:!0,ignorePunctuation:!0}):t.hasLineMrps?-1:1),e.select2({allowClear:!0,multiple:!0,data:o,matcher:(t,e,i)=>i.search.includes(t.toUpperCase()),formatResult:(t,e,r,o)=>{const n=[];return i.util.markMatch(t.text,r.term,n,o),t.mrps.length&&t.mrps.forEach(t=>{const e=s.includes(t)?"success":"default";n.push(` &nbsp;<span class="label label-${e}">`),i.util.markMatch(t,r.term,n,o),n.push("</span>")}),n.join("")}});let n=e.data("sortable");n&&n.destroy(),n=new r(e.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:()=>{e.select2("onSortStart")},onEnd:()=>{e.select2("onSortEnd").select2("focus")}}),e.data("sortable",n)},setUpOrderPriority:function(){var t=this.$id("orderPriority").select2({allowClear:!0,multiple:!0,data:this.plan.settings.getAvailableOrderPriorities().map(t=>({id:t,text:this.t(`orderPriority:${t}`)}))});this.sortables.push(new r(t.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:()=>{t.select2("onSortStart")},onEnd:()=>{t.select2("onSortEnd").select2("focus")}}))},submitForm:function(){const t=this.$id("submit").prop("disabled",!0),e=t.find(".fa-spinner").removeClass("hidden"),i=this.plan.settings,r=this.line.settings,s=i.getVersion(),n=this.$id("mrpPriority").val().split(","),a=this.$id("orderPriority").val().split(","),l=[1,2,3].map(t=>Math.max(0,+this.$id(`workerCount${t}`).val()||0));let p=this.$id("extraCapacity").val().trim();p&&"0"!==p&&"0%"!==p||(p="0"),r.set({mrpPriority:n,orderGroupPriority:(this.$id("orderGroupPriority").val()||"").split(",").filter(t=>!!t),activeTime:this.$id("activeTime").val().split(",").map(t=>{const e=t.trim().split("-");return{from:e[0],to:e[1]}}).filter(t=>!!t.to),extraCapacity:p}),s>1&&r.set({workerCount:l,orderPriority:a});const c=!!this.$id("applyToAllMrps").prop("checked");n.forEach(t=>{let e=i.mrps.get(t);e||(e=i.mrps.add({_id:t}).get(t));let r=e.lines.get(this.line.id);r||(r=e.lines.add({_id:this.line.id}).get(this.line.id)),(c||r.id===this.line.id)&&r.set({workerCount:1===s?l:[0,0,0],orderPriority:1===s?a:[]})}),o.msg.saving();const d=this.plan.settings.save();d.done(()=>{o.msg.saved(),o.closeDialog()}),d.fail(()=>{e.addClass("hidden"),t.prop("disabled",!1),o.msg.savingFailed(),this.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("mrpPriority").select2("focus")},onSettingsChanged:function(e){if(e.locked){var i=this,r=i.$id("mrpPriority"),s=i.line.settings.get("mrpPriority"),o=r.val().split(",").filter(function(e){return e.length>0&&(t.includes(s,e)||!i.plan.settings.isMrpLocked(e))});r.select("destroy").val(o.join(",")),this.setUpMrpPriority()}}})});