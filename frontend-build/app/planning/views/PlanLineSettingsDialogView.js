// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","Sortable","app/i18n","app/viewport","app/core/View","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/lineSettingsDialog"],function(i,e,t,r,n,o,s,l){"use strict";return o.extend({template:l,events:{submit:function(){return this.submitForm(),!1}},initialize:function(){this.sortables=[]},destroy:function(){this.destroySortables()},destroySortables:function(){i.invoke(this.sortables,"destroy"),this.sortables=[]},serialize:function(){var i=this.line.settings,e=this.line.mrpSettings(this.mrp.id);return{idPrefix:this.idPrefix,mrp:this.mrp.getLabel(),line:this.line.getLabel(),mrpPriority:i.get("mrpPriority").join(","),activeTime:i.get("activeTime").map(function(i){return i.from+"-"+i.to}).join(", "),workerCount:e.get("workerCount"),orderPriority:e.get("orderPriority").join(",")}},afterRender:function(){this.setUpMrpPriority(),this.setUpOrderPriority()},setUpMrpPriority:function(){s(this.$id("mrpPriority"),{view:this,sortable:!0,width:"100%",placeholder:r("planning","settings:mrpPriority:placeholder")})},setUpOrderPriority:function(){var i=this.$id("orderPriority").select2({allowClear:!0,multiple:!0,data:[{id:"small",text:r("planning","orderPriority:small")},{id:"easy",text:r("planning","orderPriority:easy")},{id:"hard",text:r("planning","orderPriority:hard")}]});this.sortables.push(new t(i.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){i.select2("onSortStart")},onEnd:function(){i.select2("onSortEnd").select2("focus")}}))},submitForm:function(){var i=this,e=i.$id("submit").prop("disabled",!0),t=e.find(".fa-spinner").removeClass("hidden"),o=i.plan.settings,s=i.line.settings;s.set({mrpPriority:i.$id("mrpPriority").val().split(","),activeTime:i.$id("activeTime").val().split(",").map(function(i){var e=i.trim().split("-");return{from:e[0],to:e[1]}}).filter(function(i){return!!i.from&&!!i.to})});var l=s.get("mrpPriority"),a=+i.$id("workerCount").val(),d=i.$id("orderPriority").val().split(","),p=i.$id("applyToAllMrps").prop("checked");l.forEach(function(e){var t=o.mrps.get(e);t||(t=t.add({_id:e}).get(e));var r=t.lines.get(i.line.id);r||(r=t.lines.add({_id:i.line.id}).get(i.line.id)),(p||r.id===i.line.id)&&r.set({workerCount:a,orderPriority:d})});var c=i.plan.settings.save();c.done(n.closeDialog),c.fail(function(){t.addClass("hidden"),e.prop("disabled",!1),n.msg.show({type:"error",time:3e3,text:r("planning","lines:menu:remove:failure")}),i.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("mrpPriority").select2("focus")}})});