define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/util/pageActions","app/data/clipboard","../util/shift","../util/contextMenu","../PlanSapOrder","./PlanOrderDropZoneDialogView","app/core/templates/userInfo","app/planning/templates/whList","app/planning/templates/lineOrderComments","app/planning/templates/orderStatusIcons"],function(t,e,n,i,s,r,a,o,l,d,p,h,u,g,m,c,f){"use strict";return a.extend({template:m,events:{"contextmenu tbody > tr[data-id]":function(t){return this.showMenu(t),!1},"mousedown .planning-mrp-lineOrders-comment":function(t){if(0===t.button){var e=this.plan.sapOrders.get(t.currentTarget.parentNode.dataset.id);if(e){var n=e.get("comments");n.length&&this.$(t.currentTarget).popover({trigger:"manual",placement:"left",html:!0,content:c({comments:n.map(function(t){return{user:g({noIp:!0,userInfo:t.user}),time:i.toTagData(t.time).human,text:h.formatCommentWithIcon(t)}})}),template:'<div class="popover planning-mrp-comment-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")}}},"mouseup .planning-mrp-lineOrders-comment":function(t){this.$(t.currentTarget).popover("destroy")},"click .planning-mrp-lineOrders-dropZone":function(t){this.handleDropZoneAction(this.$(t.target).closest("tr").attr("data-id"))},"click .planning-wh-status":function(t){this.handleWhStatusAction(this.$(t.target).closest("tr").attr("data-key"),t.pageY,t.pageX)},"submit #-qtySent-form":function(t){this.hideMenu();var e=+this.$id("qtySent-value").val();return 0!==e&&this.saveStatus(t.currentTarget.dataset.orderKey,3,e),!1}},localTopics:{"planning.contextMenu.hidden":function(){this.$id("qtySent-form").addClass("hidden")}},initialize:function(){var t=this.plan,e=t.sapOrders;this.model=t,this.listenTo(t,"change:loading change:updatedAt",this.scheduleRender),this.listenTo(e,"change:comments",this.onCommentChange),this.listenTo(e,"reset",this.onSapOrdersReset),this.listenTo(e,"change:psStatus",this.onPsStatusChanged),this.listenTo(e,"change:whStatus",this.onWhStatusChanged),this.listenTo(e,"change:whDropZone change:whTime",this.onWhDropZoneChanged),this.listenTo(this.whOrderStatuses,"add change",this.onWhOrderStatusChanged),this.listenTo(t.displayOptions,"change:whStatuses",this.onWhStatusesFilterChanged),this.listenTo(t.displayOptions,"change:psStatuses",this.onPsStatusesFilterChanged),this.listenTo(t.displayOptions,"change:from change:to",this.onStartTimeFilterChanged)},getTemplateData:function(){return{canChangeStatus:this.plan.canChangeWhStatus(),orders:this.serializeOrders()}},beforeRender:function(){clearTimeout(this.timers.render)},afterRender:function(){this.toggleSeparatorRowVisibility()},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},shouldUseLineToOrders:function(){return this.plan.getMoment().diff(Date.parse("2018-09-21T00:00:00.000Z"))>=0},serializeOrders:function(){var t=this,e=t.plan,n=e.displayOptions.get("lines"),s=e.displayOptions.get("whStatuses")||[],r=e.displayOptions.get("psStatuses")||[],a=e.displayOptions.getStartTimeRange(e.id),o=e.settings.global.getValue("wh.newIncludedMrps")||[],l=[];t.groupDuration=e.settings.global.getWhGroupDuration(),t.groupTimeWindow=3600*t.groupDuration*1e3,t.groupExtraItems=e.settings.global.getWhGroupExtraItems(),e.lines.forEach(function(i){if(!n.length||-1!==n.indexOf(i.id))for(var s=0;s<i.orders.length;++s){var r=i.orders.models[s],a=r.get("orderNo"),d=e.orders.get(a);if(d){var p=d.get("mrp");if(e.mrps.get(p)&&-1===o.indexOf(p)){var h=e.sapOrders.get(a),u=Date.parse(r.get("startAt")),g=Date.parse(r.get("finishAt")),m=g-u,c=r.get("quantity"),f={orderNo:a,mrp:p,nc12:d.get("nc12"),name:d.get("name"),startTimeMs:u,startTime:u,finishTime:g,group:t.getOrderGroup(u),duration:m,pceTime:Math.ceil(m/c),qtyTodo:d.get("quantityTodo"),qtyPlan:c,line:i.id,whStatus:null,comment:h?h.getCommentWithIcon():"",comments:h?h.get("comments"):[],status:d.getStatus(),statuses:t.serializeOrderStatuses(a),dropZone:h?h.getDropZone():"",rowClassName:h&&"done"===h.get("whStatus")?"success":"",newGroup:!1,newLine:!1,lineOrder:r};f.finishTime-f.startTime>t.groupTimeWindow?t.splitOrder(f,l):l.push(f),t.combineOrder(l)}}}});var p=e.settings.global.getValue("wh.sortByLines",!1);l.sort(function(t,e){return t.group!==e.group?t.group-e.group:p&&t.line!==e.line?t.line.localeCompare(e.line):t.startTime-e.startTime});var h=null,u={all:0,0:0,1:0,2:0,3:0},g={},m=t.shouldUseLineToOrders(),c=l.map(function(n,o){g[n.line]||(g[n.line]={}),g[n.line][n.orderNo]||(g[n.line][n.orderNo]=0),n.lineOrderNo=g[n.line][n.orderNo]+=1,n.no=o+1,n.shift=d.getShiftNo(n.startTime),n.startTime=i.utc.format(n.startTime,"HH:mm:ss"),n.finishTime=i.utc.format(n.finishTime,"HH:mm:ss"),n.key=m?n.orderNo+":"+n.lineOrderNo+":"+n.line:n.orderNo+":"+n.group+":"+n.line,n.whStatus=t.whOrderStatuses.serialize(n.key),n.psStatus=e.sapOrders.getPsStatus(n.orderNo);var l=s.length&&-1===s.indexOf(n.whStatus.status.toString()),c=r.length&&-1===r.indexOf(n.psStatus),f=n.startTimeMs<a.from||n.startTimeMs>=a.to;return(l||c||f)&&(n.rowClassName+=" hidden"),h&&(n.newGroup=n.group!==h.group,n.newLine=p&&n.line!==h.line),h=n,u.all+=1,u[n.whStatus.status]+=1,n});return t.trigger("statsRecounted",u),c},getOrderGroup:function(t){var e=new Date(t).getUTCHours();return e<6?e=18+e:e-=6,Math.floor(e/this.groupDuration)+1},getGroupStartTime:function(t,e){var n=i.utc.getMoment(e).startOf("day");return n.add(6+(t-1)*this.groupDuration,"hours"),n.valueOf()},splitOrder:function(e,n){for(var i=Math.ceil(e.duration/this.groupTimeWindow),s=e.qtyPlan,r=e.startTime,a=this.getOrderGroup(r),o=this.getGroupStartTime(a,r)+this.groupTimeWindow,l=0;l<i;++l){var d=o-r,p=Math.floor(d/e.pceTime),h=t.assign({},e,{startTime:r,finishTime:0,group:a++,qtyPlan:Math.min(s,p)});n.push(h),s-=h.qtyPlan,r=h.finishTime=r+e.pceTime*h.qtyPlan,o+=this.groupTimeWindow}},combineOrder:function(t){var e=t[t.length-2];if(e){var n=t[t.length-1];if(n.orderNo===e.orderNo){n.qtyPlan<=this.groupExtraItems&&(e.finishTime=n.finishTime,e.qtyPlan+=n.qtyPlan,t.pop());for(var i=-1,s=t.length-1;s>=0&&t[s].orderNo===n.orderNo;--s)i=s;var r=t[i];if(r.qtyPlan<=this.groupExtraItems){var a=t[i+1];a&&(a.startTime=r.startTime,a.qtyPlan+=r.qtyPlan,t.splice(i,1))}}}},serializeOrderStatuses:function(t){return f(this.plan,t)},hideMenu:function(){p.hide(this)},showMenu:function(t){var e=t.currentTarget,i=e.dataset.id,r=[p.actions.sapOrder(i)];s.isAllowedTo("PROD_DATA:VIEW")&&(this.plan.shiftOrders.findOrders(i).length||this.plan.getActualOrderData(i).quantityDone)&&r.push({icon:"fa-file-text-o",label:n("planning","orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,i)}),this.plan.canCommentOrders()&&r.push(p.actions.comment(i)),r.push({icon:"fa-clipboard",label:n("planning","lineOrders:menu:copy"),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX,!1,!1)}),r.push({label:n("planning","wh:menu:copy:lineGroup",{group:e.dataset.group,line:e.dataset.line}),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX,!0,!1)}),r.push({label:n("planning","wh:menu:copy:lineGroupNo",{group:e.dataset.group,line:e.dataset.line}),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX,!0,!0)}),this.plan.canChangeDropZone()&&r.push({icon:"fa-level-down",label:n("planning","orders:menu:dropZone"),handler:this.handleDropZoneAction.bind(this,i)}),r.push({icon:"fa-download",label:n("planning","wh:menu:export"),handler:this.export.bind(this)}),p.show(this,t.pageY,t.pageX,r)},handleShiftOrderAction:function(t){var e=this.plan.shiftOrders.findOrders(t);if(1===e.length)return window.open("/#prodShiftOrders/"+e[0].id);window.open("/#prodShiftOrders?sort(startedAt)&limit(-1337)&orderId=string:"+t)},handleCopyAction:function(e,i,s,r,a){var o=this;l.copy(function(l){if(l){var d=a?[]:[["group","no","shift","mrp","orderNo","nc12","name","qtyPlan","qtyTodo","startTime","finishTime","line","whStatus","comment"].map(function(t){return n("planning","lineOrders:list:"+t)}).join("\t")],p=e.dataset.line,h=+e.dataset.group;o.serializeOrders().forEach(function(t){if(!r||t.line===p&&t.group===h)if(a)d.push(t.orderNo);else{var e=[t.group,t.no,t.shift,t.mrp,t.orderNo,t.nc12,t.name,t.qtyPlan,t.qtyTodo,t.startTime,t.finishTime,t.line,t.whStatus.status,'"'+t.comments.map(function(t){return t.user.label+": "+t.text.replace(/"/g,"'")}).join("\r\n--\r\n")+'"'];d.push(e.join("\t"))}}),a&&(d=t.uniq(d)),l.setData("text/plain",d.join("\r\n"));var u=o.$(e).tooltip({container:o.el,trigger:"manual",placement:"bottom",title:n("planning","lineOrders:menu:copy:success")});u.tooltip("show").data("bs.tooltip").tip().addClass("result success").css({left:s+"px",top:i+"px"}),o.timers.hideTooltip&&clearTimeout(o.timers.hideTooltip),o.timers.hideTooltip=setTimeout(function(){u.tooltip("destroy")},1337)}})},handleDropZoneAction:function(t){var e=new u({plan:this.plan,order:this.plan.orders.get(t)});r.showDialog(e,n("planning","orders:menu:dropZone:title"))},handleWhStatusAction:function(t,i,s){var r=this;if(r.plan.canChangeWhStatus()){var a=r.whOrderStatuses.get(t);a&&a.get("status")<3&&(i-=17+24*(a.get("status")+1),s-=10);var o={menu:[0,1,2,3].map(function(e){return{label:n("planning","wh:status:"+e,{qtySent:0}),handler:r.handleChangeWhStatusAction.bind(r,t,e)}}),hideFilter:function(t){return 1!==e(t.target).closest(".planning-wh-qtySent").length}};p.show(r,i,s,o)}},handleChangeWhStatusAction:function(t,e,n){3===e?this.showQtySentDialog(t,e,n):this.saveStatus(t,e,0)},showQtySentDialog:function(t,e,n){n.contextMenu.hide=!1,this.$id("qtySent-form").attr("data-order-key",t).css({top:n.pageY-25+"px",left:n.pageX-206+20+"px"}).removeClass("hidden"),this.$id("qtySent-value").val("").focus()},saveStatus:function(t,e,s){var a=this.$('tr[data-key="'+t+'"]');if(a.length){r.msg.saving();var o=this.shouldUseLineToOrders(),l=a[0].dataset,d={date:i.utc.getMoment(this.plan.id,"YYYY-MM-DD").valueOf(),line:l.line,orderNo:l.id,groupNo:o?+l.lineOrderNo:+l.group,status:e,qtySent:s,pceTime:+l.pceTime,comment:null};3===d.status&&0!==d.qtySent&&(d.comment=n("planning","wh:sent:comment",{qtySent:d.qtySent,line:d.line,date:i.format(Date.now(),"L"),time:i.format(Date.now(),"HH:mm")}));var p=this.ajax({method:"POST",url:"/planning/whOrderStatuses",data:JSON.stringify(d)});p.fail(function(){r.msg.savingFailed()}),p.done(function(){r.msg.saved()})}},onCommentChange:function(t){this.plan.orders.get(t.id)&&this.$('tr[data-id="'+t.id+'"] > .planning-mrp-lineOrders-comment').html(t.getCommentWithIcon())},onSapOrdersReset:function(t,e){!e.reload&&this.plan.displayOptions.isLatestOrderDataUsed()&&this.scheduleRender()},onPsStatusChanged:function(e){var i=this.$('tr[data-id="'+e.id+'"]');if(i.length){var s=this.plan.sapOrders.getPsStatus(e.id);i.find(".planning-mrp-list-property-psStatus").attr("title",n("planning","orders:psStatus:"+s)).attr("data-ps-status",s),t.isEmpty(this.plan.displayOptions.get("psStatuses"))||this.toggleOrderRowVisibility()}},onWhStatusChanged:function(e){var i=this.$('tr[data-id="'+e.id+'"]');if(i.length){var s=this.plan.sapOrders.getWhStatus(e.id);i.toggleClass("success","wh"===this.options.mode&&"done"===s).find(".planning-mrp-list-property-whStatus").attr("title",n("planning","orders:whStatus:"+s)).attr("data-wh-status",s),t.isEmpty(this.plan.displayOptions.get("whStatuses"))||this.toggleOrderRowVisibility()}},onWhDropZoneChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');e.length&&e.find(".planning-mrp-lineOrders-dropZone").html(t.getDropZone())},onWhOrderStatusChanged:function(t){var e=this.$('tr[data-key="'+t.id+'"]');if(e.length){var n=this.whOrderStatuses.serialize(t.id);e.find(".planning-wh-status").attr("data-status",t.get("status")).html(n.label);var i=this.plan.displayOptions.get("whStatuses")||[];e.toggleClass("hidden",i.length>0&&-1===i.indexOf(n.status.toString())),this.toggleSeparatorRowVisibility()}},onWhStatusesFilterChanged:function(){this.toggleOrderRowVisibility()},onPsStatusesFilterChanged:function(){this.toggleOrderRowVisibility()},onStartTimeFilterChanged:function(){this.toggleOrderRowVisibility()},toggleOrderRowVisibility:function(){var t=this.plan.displayOptions.getStartTimeRange(this.plan.id),e=this.plan.displayOptions.get("whStatuses")||[],n=this.plan.displayOptions.get("psStatuses")||[];this.$(".planning-wh-order").each(function(){var i=+this.dataset.startTime,s=i<t.from||i>=t.to;if(!s&&e.length){var r=this.querySelector(".planning-wh-status").dataset.status;s=-1===e.indexOf(r)}if(!s&&n.length){var a=this.querySelector(".planning-mrp-list-property-psStatus"),o=a?a.dataset.psStatus:"unknown";s=-1===n.indexOf(o)}this.classList.toggle("hidden",s)}),this.toggleSeparatorRowVisibility()},toggleSeparatorRowVisibility:function(){var e=this.$(".planning-mrp-lineOrders-table");if(t.isEmpty(this.plan.displayOptions.get("whStatuses"))&&t.isEmpty(this.plan.displayOptions.get("psStatuses"))&&"06:00"===this.plan.displayOptions.get("from")&&"06:00"===this.plan.displayOptions.get("to"))return e.find(".planning-wh-newLine-tr.hidden").removeClass("hidden"),void e.find(".planning-wh-newGroup-tr.hidden").removeClass("hidden");var n=e[0].tBodies[0].firstElementChild;if(n){var i="",s="",r={};do{if(n.dataset.id){i=n.dataset.group,s=n.dataset.line,r[i]||(r[i]={lines:{},separator:null,empty:!0}),r[i].lines[s]||(r[i].lines[s]={separator:null,empty:!0});var a=n.classList.contains("hidden");r[i].lines[s].empty=a&&r[i].lines[s].empty,r[i].empty=a&&r[i].empty}else n.classList.contains("planning-wh-newLine-tr")?r[i].lines[s].separator=n:n.classList.contains("planning-wh-newGroup-tr")&&(r[i].separator=n);n=n.nextElementSibling}while(n);t.forEach(r,function(e){e.separator&&e.separator.classList.toggle("hidden",e.empty);var n=null,i=null;t.forEach(e.lines,function(t){t.separator&&(t.separator.classList.toggle("hidden",t.empty),t.empty||(i=t.separator)),n=t}),i&&n.empty&&i.classList.add("hidden")})}},export:function(){var t=this;t.$exportMsg=r.msg.show({type:"warning",text:t.t("MSG:export:started")});var e=t.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify({filename:t.t("wh:export:fileName",{date:t.plan.id}),sheetName:t.t("wh:export:sheetName",{date:t.plan.id}),freezeRows:1,freezeColumns:0,subHeader:!1,columns:{group:{type:"integer",width:3,caption:t.t("lineOrders:list:group")},no:{type:"integer",width:3,caption:t.t("lineOrders:list:no")},shift:{type:"integer",width:3,caption:t.t("lineOrders:list:shift")},mrp:{type:"string",width:5,caption:t.t("lineOrders:list:mrp")},orderNo:{type:"string",width:9,caption:t.t("lineOrders:list:orderNo")},status:{type:"string",width:30,caption:t.t("lineOrders:list:status")},nc12:{type:"string",width:12,caption:t.t("lineOrders:list:nc12")},name:{type:"string",width:40,caption:t.t("lineOrders:list:name")},qtyPlan:{type:"integer",width:5,caption:t.t("lineOrders:list:qtyPlan")},qtyTodo:{type:"integer",width:5,caption:t.t("lineOrders:list:qtyTodo")},startTime:{type:"datetime+utc",caption:t.t("lineOrders:list:startTime")},finishTime:{type:"datetime+utc",caption:t.t("lineOrders:list:finishTime")},line:{type:"string",width:10,caption:t.t("lineOrders:list:line")},whStatus:{type:"string",width:15,caption:t.t("lineOrders:list:whStatus")},comment:{type:"string",width:50,caption:t.t("lineOrders:list:comment")}},data:t.serializeOrders().map(function(e){for(var n=t.t("orderStatus:"+e.status),i=null,s=/title="(.*?)"/g;null!==(i=s.exec(e.statuses));)n+=";"+i[1];return{group:e.group,no:e.no,shift:e.shift,mrp:e.mrp,orderNo:e.orderNo,status:n,nc12:e.nc12,name:e.name,qtyPlan:e.qtyPlan,qtyTodo:e.qtyTodo,startTime:e.lineOrder.get("startAt"),finishTime:e.lineOrder.get("finishAt"),line:e.line,whStatus:e.whStatus.label,comment:e.comment.replace(/(<([^>]+)>)/g,"")}})})});e.fail(function(){r.msg.hide(t.$exportMsg,!0),r.msg.show({type:"error",time:2500,text:t.t("MSG:export:failure")})}),e.done(function(e){o.exportXlsx("/xlsxExporter/"+e),r.msg.hide(t.$exportMsg,!0)})}})});