// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","../util/shift","../util/contextMenu","../PlanSapOrder","./PlanOrderDropZoneDialogView","app/core/templates/userInfo","app/planning/templates/whList","app/planning/templates/lineOrderComments","app/planning/templates/orderStatusIcons"],function(t,e,n,r,a,i,s,o,d,p,l,u,h,g,c,m){"use strict";return s.extend({template:g,events:{"contextmenu tbody > tr[data-id]":function(t){return this.showMenu(t),!1},"mousedown .planning-mrp-lineOrders-comment":function(t){if(0===t.button){var e=this.plan.sapOrders.get(t.currentTarget.parentNode.dataset.id);if(e){var n=e.get("comments");n.length&&this.$(t.currentTarget).popover({trigger:"manual",placement:"left",html:!0,content:c({comments:n.map(function(t){return{user:h({noIp:!0,userInfo:t.user}),time:r.toTagData(t.time).human,text:l.formatCommentWithIcon(t)}})}),template:'<div class="popover planning-mrp-comment-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")}}},"mouseup .planning-mrp-lineOrders-comment":function(t){this.$(t.currentTarget).popover("destroy")},"click .planning-mrp-lineOrders-dropZone":function(t){this.handleDropZoneAction(this.$(t.target).closest("tr").attr("data-id"))},"click .planning-wh-status":function(t){this.handleWhStatusAction(this.$(t.target).closest("tr").attr("data-key"),t.pageY,t.pageX)}},initialize:function(){var t=this,e=t.plan,n=e.sapOrders;t.listenTo(e,"change:loading change:updatedAt",t.scheduleRender),t.listenTo(n,"change:comments",t.onCommentChange),t.listenTo(n,"reset",t.onSapOrdersReset),t.listenTo(n,"change:psStatus",t.onPsStatusChanged),t.listenTo(n,"change:whStatus",t.onWhStatusChanged),t.listenTo(n,"change:whDropZone change:whTime",t.onWhDropZoneChanged),t.listenTo(t.whOrderStatuses,"change:orders",t.onWhOrderStatusChanged)},serialize:function(){return{idPrefix:this.idPrefix,canChangeStatus:this.plan.canChangeWhStatus(),orders:this.serializeOrders()}},beforeRender:function(){clearTimeout(this.timers.render)},scheduleRender:function(){clearTimeout(this.timers.render),this.plan.isAnythingLoading()||(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},serializeOrders:function(){var t=this,e=t.plan,n=[];t.groupDuration=e.settings.global.getWhGroupDuration(),t.groupTimeWindow=3600*t.groupDuration*1e3,e.lines.forEach(function(r){for(var a=0;a<r.orders.length;++a){var i=r.orders.models[a],s=i.get("orderNo"),o=e.orders.get(s);if(o){var d=o.get("mrp");if(e.mrps.get(d)){var p=e.sapOrders.get(s),l=Date.parse(i.get("startAt")),u=Date.parse(i.get("finishAt")),h=u-l,g=i.get("quantity"),c=Math.ceil(h/g),m={orderNo:s,mrp:d,nc12:o.get("nc12"),name:o.get("name"),startTime:l,finishTime:u,group:t.getOrderGroup(l),duration:h,pceTime:c,maxQty:Math.floor(t.groupTimeWindow/c),qtyTodo:o.get("quantityTodo"),qtyPlan:g,line:r.id,whStatus:null,comment:p?p.getCommentWithIcon():"",comments:p?p.get("comments"):[],status:o.getStatus(),statuses:t.serializeOrderStatuses(o),dropZone:p?p.getDropZone():"",rowClassName:p&&"done"===p.get("whStatus")?"success":"",newGroup:!1,newLine:!1};m.finishTime-m.startTime>t.groupTimeWindow?t.splitOrder(m,n):n.push(m)}}}});var a=e.settings.global.getValue("wh.sortByLines",!1);n.sort(function(t,e){return t.group!==e.group?t.group-e.group:a&&t.line!==e.line?t.line.localeCompare(e.line):t.startTime-e.startTime});var i=null;return n.map(function(e,n){return e.no=n+1,e.shift=d.getShiftNo(e.startTime),e.startTime=r.utc.format(e.startTime,"HH:mm:ss"),e.finishTime=r.utc.format(e.finishTime,"HH:mm:ss"),e.key=e.orderNo+":"+e.group+":"+e.line,e.whStatus=t.whOrderStatuses.getOrderStatus(e.key),i&&(e.newGroup=e.group!==i.group,e.newLine=a&&e.line!==i.line),i=e,e})},getOrderGroup:function(t){var e=new Date(t).getUTCHours();return e<6?e=18+e:e-=6,Math.floor(e/this.groupDuration)+1},splitOrder:function(e,n){for(var r=Math.ceil(e.duration/this.groupTimeWindow),a=e.qtyPlan,i=e.startTime,s=0;s<r;++s){var o=t.assign({},e,{startTime:i,finishTime:0,group:this.getOrderGroup(i),qtyPlan:Math.min(a,e.maxQty)});n.push(o),a-=e.maxQty,i=o.finishTime=i+e.pceTime*o.qtyPlan}},serializeOrderStatuses:function(t){return m(this.plan,t.id)},hideMenu:function(){p.hide(this)},showMenu:function(t){var e=t.currentTarget,r=e.dataset.id,a=[p.actions.sapOrder(r)];(this.plan.shiftOrders.findOrders(r).length||this.plan.getActualOrderData(r).quantityDone)&&a.push({icon:"fa-file-text-o",label:n("planning","orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,r)}),this.plan.canCommentOrders()&&a.push(p.actions.comment(r)),a.push({icon:"fa-clipboard",label:n("planning","lineOrders:menu:copy"),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX)}),a.push({label:n("planning","wh:menu:copy:lineGroup",{group:e.dataset.group,line:e.dataset.line}),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX,!0)}),a.push({label:n("planning","wh:menu:copy:lineGroupNo",{group:e.dataset.group,line:e.dataset.line}),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX,!0,!0)}),this.plan.canChangeDropZone()&&a.push({icon:"fa-level-down",label:n("planning","orders:menu:dropZone"),handler:this.handleDropZoneAction.bind(this,r)}),p.show(this,t.pageY,t.pageX,a)},handleShiftOrderAction:function(t){var e=this.plan.shiftOrders.findOrders(t);if(1===e.length)return window.open("/#prodShiftOrders/"+e[0].id);window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+t)},handleCopyAction:function(e,r,a,i,s){var d=this;o.copy(function(o){if(o){var p=["group","no","shift","mrp","orderNo","nc12","name","qtyPlan","qtyTodo","startTime","finishTime","line","whStatus","comment"],l=s?[]:[p.map(function(t){return n("planning","lineOrders:list:"+t)}).join("\t")],u=e.dataset.line,h=+e.dataset.group;d.serializeOrders().forEach(function(t){if(!i||t.line===u&&t.group===h){if(s)return void l.push(t.orderNo);var e=[t.group,t.no,t.shift,t.mrp,t.orderNo,t.nc12,t.name,t.qtyPlan,t.qtyTodo,t.startTime,t.finishTime,t.line,t.whStatus.status,'"'+t.comments.map(function(t){return t.user.label+": "+t.text.replace(/"/g,"'")}).join("\r\n--\r\n")+'"'];l.push(e.join("\t"))}}),s&&(l=t.uniq(l)),o.setData("text/plain",l.join("\r\n"));var g=d.$(e).tooltip({container:d.el,trigger:"manual",placement:"bottom",title:n("planning","lineOrders:menu:copy:success")});g.tooltip("show").data("bs.tooltip").tip().addClass("result success").css({left:a+"px",top:r+"px"}),d.timers.hideTooltip&&clearTimeout(d.timers.hideTooltip),d.timers.hideTooltip=setTimeout(function(){g.tooltip("destroy")},1337)}})},handleDropZoneAction:function(t){var e=new u({plan:this.plan,order:this.plan.orders.get(t)});i.showDialog(e,n("planning","orders:menu:dropZone:title"))},handleWhStatusAction:function(t,e,r){var a=this;if(a.plan.canChangeWhStatus()){var i=a.whOrderStatuses.getOrderStatus(t).status;i<3&&(e-=17+24*(i+1),r-=10),p.show(a,e,r,[0,1,2,3].map(function(e){return{label:n("planning","wh:status:"+e),handler:a.handleChangeWhStatusAction.bind(a,t,e)}}))}},handleChangeWhStatusAction:function(t,e){i.msg.saving();var n=this,r=n.whOrderStatuses.getOrderStatus(t),s={status:e,updatedAt:new Date,updater:a.getInfo()};n.whOrderStatuses.setOrderStatus(t,s);var o=n.ajax({method:"POST",url:"/planning/whOrderStatuses/"+n.plan.id,data:JSON.stringify({key:t,status:e})});o.fail(function(){i.msg.savingFailed(),n.whOrderStatuses.getOrderStatus(t)===s&&n.whOrderStatuses.setOrderStatus(t,r)}),o.done(function(){i.msg.saved()})},onCommentChange:function(t){this.plan.orders.get(t.id)&&this.$('tr[data-id="'+t.id+'"] > .planning-mrp-lineOrders-comment').html(t.getCommentWithIcon())},onSapOrdersReset:function(t,e){e.reload||!this.plan.displayOptions.isLatestOrderDataUsed()||this.plan.isAnythingLoading()||this.render()},onPsStatusChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');if(e.length){var r=this.plan.sapOrders.getPsStatus(t.id);e.find(".planning-mrp-list-property-psStatus").attr("title",n("planning","orders:psStatus:"+r)).attr("data-ps-status",r)}},onWhStatusChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');if(e.length){var r=this.plan.sapOrders.getWhStatus(t.id);e.toggleClass("success","wh"===this.options.mode&&"done"===r).find(".planning-mrp-list-property-whStatus").attr("title",n("planning","orders:whStatus:"+r)).attr("data-wh-status",r)}},onWhDropZoneChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');e.length&&e.find(".planning-mrp-lineOrders-dropZone").html(t.getDropZone())},onWhOrderStatusChanged:function(t,e){var r=this.$('tr[data-key="'+t+'"]');r.length&&r.find(".planning-wh-status").attr("data-status",e.status).html(n("planning","wh:status:"+e.status))}})});