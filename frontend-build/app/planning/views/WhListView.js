// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/data/clipboard","app/orderStatuses/util/renderOrderStatusLabel","../util/shift","../util/contextMenu","../PlanSapOrder","./PlanOrderDropZoneDialogView","app/core/templates/userInfo","app/planning/templates/whList","app/planning/templates/lineOrderComments"],function(t,e,n,r,i,s,a,o,p,d,l,h,u,c,m){"use strict";var g=72e5;return s.extend({template:c,events:{"contextmenu tbody > tr":function(t){return this.showMenu(t),!1},"mousedown .planning-mrp-lineOrders-comment":function(t){if(0===t.button){var e=this.plan.sapOrders.get(t.currentTarget.parentNode.dataset.id);if(e){var n=e.get("comments");n.length&&this.$(t.currentTarget).popover({trigger:"manual",placement:"left",html:!0,content:m({comments:n.map(function(t){return{user:u({noIp:!0,userInfo:t.user}),time:r.toTagData(t.time).human,text:l.formatCommentWithIcon(t)}})}),template:'<div class="popover planning-mrp-comment-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")}}},"mouseup .planning-mrp-lineOrders-comment":function(t){this.$(t.currentTarget).popover("destroy")},"click .planning-mrp-lineOrders-dropZone":function(t){this.handleDropZoneAction(this.$(t.target).closest("tr").attr("data-id"))}},initialize:function(){var t=this,e=t.plan,n=e.sapOrders;t.listenTo(e,"change:loading change:updatedAt",t.scheduleRender),t.listenTo(n,"change:comments",t.onCommentChange),t.listenTo(n,"reset",t.onSapOrdersReset),t.listenTo(n,"change:psStatus",t.onPsStatusChanged),t.listenTo(n,"change:whStatus",t.onWhStatusChanged),t.listenTo(n,"change:whDropZone change:whTime",t.onWhDropZoneChanged)},serialize:function(){return{idPrefix:this.idPrefix,orders:this.serializeOrders()}},beforeRender:function(){clearTimeout(this.timers.render)},scheduleRender:function(){clearTimeout(this.timers.render),this.plan.isAnythingLoading()||(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},serializeOrders:function(){var t=this,e=t.plan,n=[];return e.lines.forEach(function(r){for(var i=0;i<r.orders.length;++i){var s=r.orders.models[i],a=s.get("orderNo"),o=e.orders.get(a);if(o){var p=o.get("mrp");if(e.mrps.get(p)){var d=e.sapOrders.get(a),l=Date.parse(s.get("startAt")),h=Date.parse(s.get("finishAt")),u=h-l,c=s.get("quantity"),m=Math.ceil(u/c),f={orderNo:a,mrp:p,nc12:o.get("nc12"),name:o.get("name"),startTime:l,finishTime:h,duration:u,pceTime:m,maxQty:Math.floor(g/m),qtyTodo:o.get("quantityTodo"),qtyPlan:c,line:r.id,comment:d?d.getCommentWithIcon():"",comments:d?d.get("comments"):[],status:o.getStatus(),statuses:t.serializeOrderStatuses(o),dropZone:d?d.getDropZone():"",rowClassName:d&&"done"===d.get("whStatus")?"success":""};f.finishTime-f.startTime>g?t.splitOrder(f,n):n.push(f)}}}}),n.sort(function(t,e){return t.startTime-e.startTime}).map(function(t,e){return t.no=e+1,t.shift=p.getShiftNo(t.startTime),t.startTime=r.utc.format(t.startTime,"HH:mm:ss"),t.finishTime=r.utc.format(t.finishTime,"HH:mm:ss"),t})},splitOrder:function(e,n){for(var r=Math.ceil(e.duration/72e5),i=e.qtyPlan,s=e.startTime,a=0;a<r;++a){var o=t.assign({},e,{startTime:s,finishTime:0,qtyPlan:Math.min(i,e.maxQty)});n.push(o),i-=e.maxQty,s=o.finishTime=s+e.pceTime*o.qtyPlan}},serializeOrderStatuses:function(t){var e=[],r=this.plan.getActualOrderData(t.id),i=t.getKindIcon(),s=t.getSourceIcon(),a=this.plan.sapOrders.getPsStatus(t.id),p=this.plan.sapOrders.getWhStatus(t.id);return t.get("ignored")&&e.push(this.formatIcon(t.getIcon("ignored"),"orders:ignored")),i&&e.push(this.formatIcon(i,"orderPriority:"+t.get("kind"))),s&&e.push(this.formatIcon(s,"orders:source:"+t.get("source"))),t.get("urgent")&&e.push(this.formatIcon(t.getIcon("urgent"),"orders:urgent")),t.isPinned()&&e.push(this.formatIcon(t.getIcon("pinned"),"orders:pinned")),e.push('<span class="planning-mrp-list-property planning-mrp-list-property-psStatus" title="'+n("planning","orders:psStatus:"+a)+'" data-ps-status="'+a+'"><i class="fa '+t.getIcon("psStatus")+'"></i></span>'),e.push('<span class="planning-mrp-list-property planning-mrp-list-property-whStatus" title="'+n("planning","orders:whStatus:"+p)+'" data-wh-status="'+p+'"><i class="fa '+t.getIcon("whStatus")+'"></i></span>'),r.statuses.indexOf("CNF")!==-1&&e.push(o("CNF")),r.statuses.indexOf("DLV")!==-1&&e.push(o("DLV")),e.join("")},formatIcon:function(e,r){return'<span class="planning-mrp-list-property" title="'+t.escape(n("planning",r))+'"><i class="fa '+e+'"></i></span>'},hideMenu:function(){d.hide(this)},showMenu:function(t){var e=t.currentTarget.dataset.id,r=[d.actions.sapOrder(e)];(this.plan.shiftOrders.findOrders(e).length||this.plan.getActualOrderData(e).quantityDone)&&r.push({icon:"fa-file-text-o",label:n("planning","orders:menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,e)}),this.plan.canCommentOrders()&&r.push(d.actions.comment(e)),r.push({icon:"fa-clipboard",label:n("planning","lineOrders:menu:copy"),handler:this.handleCopyAction.bind(this,t.currentTarget,t.pageY,t.pageX)}),this.plan.canChangeDropZone()&&r.push({icon:"fa-level-down",label:n("planning","orders:menu:dropZone"),handler:this.handleDropZoneAction.bind(this,e)}),d.show(this,t.pageY,t.pageX,r)},handleShiftOrderAction:function(t){var e=this.plan.shiftOrders.findOrders(t);return 1===e.length?window.open("/#prodShiftOrders/"+e[0].id):void window.open("/#prodShiftOrders?sort(startedAt)&limit(20)&orderId="+t)},handleCopyAction:function(t,e,r){var i=this;a.copy(function(s){if(s){var a=["no","shift","orderNo","nc12","name","qtyPlan","qtyTodo","startTime","finishTime","dropZone","lines","comment"],o=[a.map(function(t){return n("planning","lineOrders:list:"+t)}).join("\t")];i.serializeOrders().forEach(function(t){var e=[t.no,t.shift,t.orderNo,t.nc12,t.name,t.qtyPlan,t.qtyTodo,t.startTime,t.finishTime,t.dropZone,t.lines,'"'+t.comments.map(function(t){return t.user.label+": "+t.text.replace(/"/g,"'")}).join("\r\n--\r\n")+'"'];o.push(e.join("\t"))}),s.setData("text/plain",o.join("\r\n"));var p=i.$(t).tooltip({container:i.el,trigger:"manual",placement:"bottom",title:n("planning","lineOrders:menu:copy:success")});p.tooltip("show").data("bs.tooltip").tip().addClass("result success").css({left:r+"px",top:e+"px"}),i.timers.hideTooltip&&clearTimeout(i.timers.hideTooltip),i.timers.hideTooltip=setTimeout(function(){p.tooltip("destroy")},1337)}})},handleDropZoneAction:function(t){var e=new h({plan:this.plan,order:this.plan.orders.get(t)});i.showDialog(e,n("planning","orders:menu:dropZone:title"))},onCommentChange:function(t){this.plan.orders.get(t.id)&&this.$('tr[data-id="'+t.id+'"] > .planning-mrp-lineOrders-comment').html(t.getCommentWithIcon())},onSapOrdersReset:function(t,e){e.reload||!this.plan.displayOptions.isLatestOrderDataUsed()||this.plan.isAnythingLoading()||this.render()},onPsStatusChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');if(e.length){var r=this.plan.sapOrders.getPsStatus(t.id);e.find(".planning-mrp-list-property-psStatus").attr("title",n("planning","orders:psStatus:"+r)).attr("data-ps-status",r)}},onWhStatusChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');if(e.length){var r=this.plan.sapOrders.getWhStatus(t.id);e.toggleClass("success","wh"===this.options.mode&&"done"===r).find(".planning-mrp-list-property-whStatus").attr("title",n("planning","orders:whStatus:"+r)).attr("data-wh-status",r)}},onWhDropZoneChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');e.length&&e.find(".planning-mrp-lineOrders-dropZone").html(t.getDropZone())}})});