// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/broker","app/i18n","app/viewport","app/time","app/core/View","app/orderStatuses/util/renderOrderStatusLabel","app/planning/templates/orderAddDialog","app/planning/templates/orderAddDetails"],function(e,r,i,s,t,d,n,a){"use strict";return t.extend({template:n,events:{submit:function(){return this.submitForm(),!1},"input #-orderNo":"searchOrder"},initialize:function(){this.order=null},serialize:function(){return{idPrefix:this.idPrefix,orderNo:this.order?this.order._id:this.model.orderNo||"",urgent:this.model.urgent}},afterRender:function(){this.searchOrder()},showMessage:function(e){e?this.$id("message").html(r("planning","orders:add:"+e)).removeClass("hidden"):this.$id("message").addClass("hidden")},searchOrder:function(){var e=this,i=e.$id("submit").prop("disabled",!0),s=e.$id("orderNo").val().replace(/[^0-9]+/g,"");if(e.$id("details").addClass("hidden"),9!==s.length)return e.showMessage("invalidOrderNo");e.showMessage("searching");var t=e.ajax({url:"/planning/plans/"+e.plan.id+"/orders/"+s});t.fail(function(i){var s=i.responseJSON&&i.responseJSON.error&&i.responseJSON.error.message||"";r.has("planning","orders:add:"+s)?e.showMessage(s):e.showMessage("searchFailed")}),t.done(function(r){var s=e.validateOrder(r);e.showMessage(s),e.showDetails(r),s||(e.order=r.order,i.prop("disabled",!1))})},validateOrder:function(e){for(var r=e.plans,i=0;i<r.length;++i)if(s.utc.format(r[i],"YYYY-MM-DD")===this.plan.id)return"alreadyExists";var t=e.order;return s.utc.getMoment(t.date,"YYYY-MM-DD").diff(s.utc.getMoment(this.plan.id))>0?"future":this.plan.settings.mrps.get(t.mrp)?this.plan.settings.hasAllRequiredStatuses(t.statuses)?this.plan.settings.hasAnyIgnoredStatus(t.statuses)?"ignoredStatus":null:"requiredStatus":"undefinedMrp"},showDetails:function(e){e.idPrefix=this.idPrefix,e.order.statuses=e.order.statuses.map(d).join(""),e.urgent=e.order._id===this.model.orderNo&&this.model.urgent,this.$id("details").html(a(e)).removeClass("hidden")},submitForm:function(){var s=this,t=s.$id("submit").prop("disabled",!0),d=t.find(".fa-spinner").removeClass("hidden"),n=s.ajax({method:"POST",url:"/planning/plans/"+s.plan.id+"/orders/"+s.order._id,data:JSON.stringify({urgent:this.$id("urgent").prop("checked")})});n.done(function(){e.subscribe("viewport.dialog.hidden",s.previewAddedOrder.bind(s)).setLimit(1),i.closeDialog()}),n.fail(function(){d.addClass("hidden"),t.prop("disabled",!1),i.msg.show({type:"error",time:3e3,text:r("planning","orders:add:failure")}),s.plan.settings.trigger("errored")})},previewAddedOrder:function(){var e=this.plan.mrps.get(this.order.mrp);e&&e.orders.trigger("preview",{orderNo:this.order._id,scrollIntoView:!0})},onDialogShown:function(){this.$id("orderNo").focus()}})});