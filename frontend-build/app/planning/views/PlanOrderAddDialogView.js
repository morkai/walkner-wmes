// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/broker","app/i18n","app/viewport","app/time","app/core/View","app/orderStatuses/util/renderOrderStatusLabel","app/planning/templates/orderAddDialog","app/planning/templates/orderAddDetails"],function(e,r,s,i,t,d,n,a){"use strict";return t.extend({template:n,events:{submit:function(){return this.submitForm(),!1},"input #-orderNo":"searchOrder"},initialize:function(){this.order=null},serialize:function(){return{idPrefix:this.idPrefix,orderNo:this.order?this.order._id:this.model.orderNo||""}},afterRender:function(){this.searchOrder()},showMessage:function(e){e?this.$id("message").html(r("planning","orders:add:"+e)).removeClass("hidden"):this.$id("message").addClass("hidden")},searchOrder:function(){var e=this,s=e.$id("submit").prop("disabled",!0),i=e.$id("orderNo").val().replace(/[^0-9]+/g,"");if(e.$id("details").addClass("hidden"),9!==i.length)return e.showMessage("invalidOrderNo");e.showMessage("searching");var t=e.ajax({url:"/planning/plans/"+e.plan.id+"/orders/"+i});t.fail(function(s){var i=s.responseJSON&&s.responseJSON.error&&s.responseJSON.error.message||"";r.has("planning","orders:add:"+i)?e.showMessage(i):e.showMessage("searchFailed")}),t.done(function(r){var i=e.validateOrder(r);e.showMessage(i),e.showDetails(r),i||(e.order=r.order,s.prop("disabled",!1))})},validateOrder:function(e){for(var r=e.plans,s=0;s<r.length;++s)if(i.utc.format(r[s],"YYYY-MM-DD")===this.plan.id)return"alreadyExists";var t=e.order;return i.utc.getMoment(t.date,"YYYY-MM-DD").diff(i.utc.getMoment(this.plan.id))>0?"future":this.plan.settings.mrps.get(t.mrp)?this.plan.settings.hasAllRequiredStatuses(t.statuses)?this.plan.settings.hasAnyIgnoredStatus(t.statuses)?"ignoredStatus":null:"requiredStatus":"undefinedMrp"},showDetails:function(e){e.order.statuses=e.order.statuses.map(d).join(""),this.$id("details").html(a(e)).removeClass("hidden")},submitForm:function(){var i=this,t=i.$id("submit").prop("disabled",!0),d=t.find(".fa-spinner").removeClass("hidden"),n=i.ajax({method:"POST",url:"/planning/plans/"+i.plan.id+"/orders/"+i.order._id});n.done(function(){e.subscribe("viewport.dialog.hidden",i.previewAddedOrder.bind(i)).setLimit(1),s.closeDialog()}),n.fail(function(){d.addClass("hidden"),t.prop("disabled",!1),s.msg.show({type:"error",time:3e3,text:r("planning","orders:add:failure")}),i.plan.settings.trigger("errored")})},previewAddedOrder:function(){var e=this.plan.mrps.get(this.order.mrp);e&&e.orders.trigger("preview",{orderNo:this.order._id,scrollIntoView:!0})},onDialogShown:function(){this.$id("orderNo").focus()}})});