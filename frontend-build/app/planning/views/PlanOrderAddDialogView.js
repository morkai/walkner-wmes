// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/viewport","app/time","app/core/View","app/orderStatuses/util/renderOrderStatusLabel","app/planning/templates/orderAddDialog","app/planning/templates/orderAddDetails"],function(e,r,s,i,t,a,n){"use strict";return i.extend({template:a,events:{submit:function(){return this.submitForm(),!1},"input #-orderNo":"searchOrder"},initialize:function(){this.order=null},serialize:function(){return{idPrefix:this.idPrefix,orderNo:this.order?this.order._id:this.model.orderNo||""}},afterRender:function(){this.searchOrder()},showMessage:function(r){r?this.$id("message").html(e("planning","orders:add:"+r)).removeClass("hidden"):this.$id("message").addClass("hidden")},searchOrder:function(){var r=this,s=r.$id("submit").prop("disabled",!0),i=r.$id("orderNo").val().replace(/[^0-9]+/g,"");if(r.$id("details").addClass("hidden"),9!==i.length)return r.showMessage("invalidOrderNo");r.showMessage("searching");var t=r.ajax({url:"/planning/plans/"+r.plan.id+"/orders/"+i});t.fail(function(s){var i=s.responseJSON&&s.responseJSON.error&&s.responseJSON.error.message||"";e.has("planning","orders:add:"+i)?r.showMessage(i):r.showMessage("searchFailed")}),t.done(function(e){var i=r.validateOrder(e);r.showMessage(i),r.showDetails(e),i||(r.order=e.order,s.prop("disabled",!1))})},validateOrder:function(e){for(var r=e.plans,i=0;i<r.length;++i)if(s.utc.format(r[i],"YYYY-MM-DD")===this.plan.id)return"alreadyExists";var t=e.order;return s.utc.getMoment(t.date,"YYYY-MM-DD").diff(s.utc.getMoment(this.plan.id))>0?"future":this.plan.settings.mrps.get(t.mrp)?this.plan.settings.hasAllRequiredStatuses(t.statuses)?this.plan.settings.hasAnyIgnoredStatus(t.statuses)?"ignoredStatus":null:"requiredStatus":"undefinedMrp"},showDetails:function(e){e.order.statuses=e.order.statuses.map(t).join(""),this.$id("details").html(n(e)).removeClass("hidden")},submitForm:function(){var s=this,i=s.$id("submit").prop("disabled",!0),t=i.find(".fa-spinner").removeClass("hidden"),a=s.ajax({method:"POST",url:"/planning/plans/"+s.plan.id+"/orders/"+s.order._id});a.done(r.closeDialog),a.fail(function(){t.addClass("hidden"),i.prop("disabled",!1),r.msg.show({type:"error",time:3e3,text:e("planning","orders:add:failure")}),s.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("orderNo").focus()}})});