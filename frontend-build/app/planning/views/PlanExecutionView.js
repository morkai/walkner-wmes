define(["underscore","app/time","app/core/View","app/planning/util/shift","app/planning/templates/planExecution"],function(t,e,i,r,n){"use strict";return i.extend({template:n,getTemplateData:function(){var i=this,n=i.mrp?i.mrp.id:null,a={true:"is-ok",false:"is-nok"};return{mrps:i.plan.mrps.map(function(s){return n&&s.id!==n?null:{_id:s.id,lines:s.lines.map(function(n){var s=1;return{_id:n.id,orders:n.orders.map(function(o){var u=o.get("orderNo"),l=i.plan.orders.get(u);if(!l)return null;var f=i.plan.shiftOrders.cache.byLine[n.id]||{all:[]},d=l.getOperationNo(),m=o.get("quantity"),p=e.utc.getMoment(o.get("startAt")),c=p.valueOf(),g=p.format("YYYY-MM-DD"),h=r.getShiftEndTime(c),v=c+144e5-h;if(v>0){var A=r.getShiftNo(c)+1;4!==A&&-1!==t.findLastIndex(f.all,function(t){return t.attributes.shift===A})&&(v=0)}var D=[],b=!1;i.plan.shiftOrders.findOrders(u).forEach(function(t){var i=t.attributes.operationNo;if(d===i){var s=t.attributes.prodLine,o=t.attributes.quantityDone,u=e.getMoment(t.attributes.startedAt).utc(!0),l=u.valueOf(),f=u.format("YYYY-MM-DD"),h={line:a[s===n.id],quantity:a[o===m],date:a[f===g],time:a[Math.abs(u.diff(p))<=144e5]};if(h.time===a.false&&1===t.attributes.shift&&v>0&&l>c+144e5){var A=r.getShiftStartTime(l);u>=A&&u<=A+v&&(h.time=a.true)}D.push({line:s,quantityDone:o,startedAtTime:u.format("HH:mm:ss"),startedAtDate:f,startedAt:u.valueOf(),classNames:h,ok:"is-ok"===h.line&&"is-ok"===h.quantity&&"is-ok"===h.time}),b||(b=D[D.length-1].ok)}});var k={numeric:!0,ignorePunctuation:!0};return D.sort(function(t,e){if(t.line===n.id&&e.line!==n.id)return-1;if(t.line!==n.id&&e.line===n.id)return 1;var i=t.line.localeCompare(e.line,void 0,k);return 0===i&&(i=t.startedAt-e.startedAt),i}),{no:s++,orderNo:u,quantityPlanned:m,startAtTime:p.format("HH:mm:ss"),startAtDate:g,shiftOrders:D,ok:b}}).filter(t=>!!t)}}).filter(t=>!!t&&t.orders.length)}}).filter(t=>!!t)}},afterRender:function(){}})});