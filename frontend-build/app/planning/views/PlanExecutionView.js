define(["underscore","app/time","app/core/View","app/planning/util/shift","app/planning/templates/planExecution"],function(t,e,r,i,n){"use strict";var a={true:"is-ok",false:"is-nok"};return r.extend({template:n,getTemplateData:function(){var t=this.mrp?this.mrp.id:null;return{mrps:this.plan.mrps.map(e=>t&&e.id!==t?null:{_id:e.id,lines:e.lines.map(t=>({_id:t.id,orders:t.orders.map(e=>this.serializeLineOrder(e,t)).filter(t=>!!t)})).filter(t=>!!t&&t.orders.length)}).filter(t=>!!t)}},serializeLineOrder:function(t,r){var n=t.get("orderNo"),s=this.plan.orders.get(n);if(!s)return null;var o=s.getOperationNo(),l=t.get("quantity"),d=e.utc.getMoment(t.get("startAt")),u=d.valueOf(),f=d.format("YYYY-MM-DD"),p=i.getShiftStartTime(u,!1),m=p+i.SHIFT_DURATION,g=u-144e5,h=u+144e5,c=g-p,v=h-m,O=null;if(c<0||v>0){var A=i.getShiftNo(u,!1);O=this.plan.workingLines.getWorkingTimes(r),c<0&&O.prevAt[A]&&(g=e.utc.getMoment(O.prevAt[A]).valueOf()+c),v>0&&O.nextAt[A]&&(h=e.utc.getMoment(O.nextAt[A]).valueOf()+v)}var D=[],k={},M=!1;if(this.plan.shiftOrders.findOrders(n).forEach(t=>{if(o===t.get("operationNo")){var i=t.get("prodLine"),n=t.get("quantityDone"),s=e.getMoment(t.get("startedAt")).utc(!0),d=s.valueOf(),u=s.format("YYYY-MM-DD"),p=d>=g&&d<=h,m={line:a[i===r.id],quantity:a[n===l],date:a[u===f],time:a[p]},c={pso:t,line:i,quantityDone:n,startedAtTime:s.format("HH:mm:ss"),startedAtDate:u,startedAt:s.valueOf(),classNames:m,timeOk:p,ok:"is-ok"===m.line&&"is-ok"===m.quantity&&p};M=M||c.ok,D.push(c),k[t.id]=c}}),!M){var Y=this.plan.shiftOrders.getLineOrderExecution(r.id,t,O);if(M=Y.plannedQuantitiesDone.some(t=>t===l)){var q=[],y=0;for(let t=0;t<Y.prodShiftOrders.length&&y!==l;++t){q=[],y=0;for(let e=t;e<Y.prodShiftOrders.length&&y!==l;++e){const t=Y.prodShiftOrders[e];q.push(t),y+=t.get("quantityDone")}}q.forEach(function(t){k[t.id].ok=!0})}}var N={numeric:!0,ignorePunctuation:!0};return D.sort((t,e)=>{if(t.line===r.id&&e.line!==r.id)return-1;if(t.line!==r.id&&e.line===r.id)return 1;var i=t.line.localeCompare(e.line,void 0,N);return 0===i&&(i=t.startedAt-e.startedAt),i}),{orderNo:n,quantityPlanned:l,startAtTime:d.format("HH:mm:ss"),startAtDate:f,shiftOrders:D,ok:M}}})});