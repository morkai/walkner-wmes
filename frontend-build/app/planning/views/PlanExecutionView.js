define(["underscore","app/time","app/core/View","app/planning/util/shift","app/planning/templates/planExecution"],function(t,e,i,r,n){"use strict";var a={true:"is-ok",false:"is-nok"};return i.extend({template:n,getTemplateData:function(){var t=this.mrp?this.mrp.id:null;return{mrps:this.plan.mrps.map(e=>t&&e.id!==t?null:{_id:e.id,lines:e.lines.map(t=>({_id:t.id,orders:t.orders.map(e=>this.serializeLineOrder(e,t)).filter(t=>!!t)})).filter(t=>!!t&&t.orders.length)}).filter(t=>!!t)}},serializeLineOrder:function(t,i){var n=t.get("orderNo"),s=this.plan.orders.get(n);if(!s)return null;var o=s.getOperationNo(),l=t.get("quantity"),u=e.utc.getMoment(t.get("startAt")),d=u.valueOf(),m=u.format("YYYY-MM-DD"),p=r.getShiftStartTime(d,!1),f=p+r.SHIFT_DURATION,g=d-144e5,c=d+144e5,h=g-p,v=c-f,k=null;if(h<0||v>0){var O=r.getShiftNo(d,!1);k=this.plan.workingLines.getWorkingTimes(i),h<0&&k.prevAt[O]&&(g=e.utc.getMoment(k.prevAt[O]).valueOf()+h),v>0&&k.nextAt[O]&&(c=e.utc.getMoment(k.nextAt[O]).valueOf()+v)}var A=[],D=!1;if(this.plan.shiftOrders.findOrders(n).forEach(t=>{if(o===t.get("operationNo")){var r=t.get("prodLine"),n=t.get("quantityDone"),s=e.getMoment(t.get("startedAt")).utc(!0),u=s.valueOf(),d=s.format("YYYY-MM-DD"),p=u>=g&&u<=c,f={line:a[r===i.id],quantity:a[n===l],date:a[d===m],time:a[p]};A.push({pso:t,line:r,quantityDone:n,startedAtTime:s.format("HH:mm:ss"),startedAtDate:d,startedAt:s.valueOf(),classNames:f,timeOk:p,ok:"is-ok"===f.line&&"is-ok"===f.quantity&&p}),D=D||A[A.length-1].ok}}),!D){var N=this.plan.shiftOrders.getLineOrderExecution(i.id,t,k);(D=N.plannedQuantitiesDone.some(t=>t===l))&&A.forEach(function(t){!t.ok&&"is-ok"!==t.classNames.quantity&&N.prodShiftOrders.includes(t.pso)&&(t.classNames.quantity="is-ok",t.ok="is-ok"===t.classNames.line&&"is-ok"===t.classNames.quantity&&t.timeOk)})}var q={numeric:!0,ignorePunctuation:!0};return A.sort((t,e)=>{if(t.line===i.id&&e.line!==i.id)return-1;if(t.line!==i.id&&e.line===i.id)return 1;var r=t.line.localeCompare(e.line,void 0,q);return 0===r&&(r=t.startedAt-e.startedAt),r}),{orderNo:n,quantityPlanned:l,startAtTime:u.format("HH:mm:ss"),startAtDate:m,shiftOrders:A,ok:D}}})});