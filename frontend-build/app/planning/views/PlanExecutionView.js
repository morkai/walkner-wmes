define(["underscore","app/time","app/core/View","app/planning/util/shift","app/planning/templates/planExecution"],function(t,e,r,n,i){"use strict";return r.extend({template:i,getTemplateData:function(){var t=this,r=t.mrp?t.mrp.id:null,i={true:"is-ok",false:"is-nok"};return{mrps:t.plan.mrps.map(function(a){return r&&a.id!==r?null:{_id:a.id,lines:a.lines.map(function(r){var a=1;return{_id:r.id,orders:r.orders.map(function(o){var s=o.get("orderNo"),u=t.plan.orders.get(s);if(!u)return null;var l=u.getOperationNo(),d=o.get("quantity"),f=e.utc.getMoment(o.get("startAt")),m=f.valueOf(),p=f.format("YYYY-MM-DD"),c=n.getShiftStartTime(m,!1),g=c+n.SHIFT_DURATION,v=m-144e5,A=m+144e5,h=v-c,k=A-g;if(h<0||k>0){var D=t.plan.workingLines.getWorkingTimes(r),O=n.getShiftNo(m,!1);h<0&&D.prevAt[O]&&(v=e.utc.getMoment(D.prevAt[O]).local(!0).valueOf()+h),k>0&&D.nextAt[O]&&(A=e.utc.getMoment(D.nextAt[O]).local(!0).valueOf()+k)}var M=[],Y=!1;t.plan.shiftOrders.findOrders(s).forEach(function(t){var n=t.attributes.operationNo;if(l===n){var a=t.attributes.prodLine,o=t.attributes.quantityDone,s=e.getMoment(t.attributes.startedAt).utc(!0),u=s.valueOf(),f=s.format("YYYY-MM-DD"),m={line:i[a===r.id],quantity:i[o===d],date:i[f===p],time:i[u>=v&&u<=A]};M.push({line:a,quantityDone:o,startedAtTime:s.format("HH:mm:ss"),startedAtDate:f,startedAt:s.valueOf(),classNames:m,ok:"is-ok"===m.line&&"is-ok"===m.quantity&&"is-ok"===m.time}),Y||(Y=M[M.length-1].ok)}});var N={numeric:!0,ignorePunctuation:!0};return M.sort(function(t,e){if(t.line===r.id&&e.line!==r.id)return-1;if(t.line!==r.id&&e.line===r.id)return 1;var n=t.line.localeCompare(e.line,void 0,N);return 0===n&&(n=t.startedAt-e.startedAt),n}),{no:a++,orderNo:s,quantityPlanned:d,startAtTime:f.format("HH:mm:ss"),startAtDate:p,shiftOrders:M,ok:Y}}).filter(t=>!!t)}}).filter(t=>!!t&&t.orders.length)}}).filter(t=>!!t)}},afterRender:function(){}})});