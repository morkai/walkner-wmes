define(["underscore","app/time","app/core/View","app/planning/util/shift","app/planning/templates/planExecution"],function(t,e,i,r,n){"use strict";var a={true:"is-ok",false:"is-nok"};return i.extend({template:n,getTemplateData:function(){var t=this.mrp?this.mrp.id:null;return{mrps:this.plan.mrps.map(e=>t&&e.id!==t?null:{_id:e.id,lines:e.lines.map(t=>({_id:t.id,orders:t.orders.map(e=>this.serializeLineOrder(e,t)).filter(t=>!!t)})).filter(t=>!!t&&t.orders.length)}).filter(t=>!!t)}},serializeLineOrder:function(t,i){var n=t.get("orderNo"),s=this.plan.orders.get(n);if(!s)return null;var o=s.getOperationNo(),l=t.get("quantity"),u=e.utc.getMoment(t.get("startAt")),d=u.valueOf(),m=u.format("YYYY-MM-DD"),p=r.getShiftStartTime(d,!1),f=p+r.SHIFT_DURATION,g=d-144e5,c=d+144e5,h=g-p,v=c-f;if(h<0||v>0){var A=this.plan.workingLines.getWorkingTimes(i),O=r.getShiftNo(d,!1);h<0&&A.prevAt[O]&&(g=e.utc.getMoment(A.prevAt[O]).local(!0).valueOf()+h),v>0&&A.nextAt[O]&&(c=e.utc.getMoment(A.nextAt[O]).local(!0).valueOf()+v)}var k=[],D=!1;this.plan.shiftOrders.sumExecutionOrders(this.plan.shiftOrders.findOrders(n)).forEach(t=>{var r=t.operationNo;if(o===r){var n=t.prodLine,s=t.quantityDone,u=e.getMoment(t.startedAt).utc(!0),d=u.valueOf(),p=u.format("YYYY-MM-DD"),f={line:a[n===i.id],quantity:a[s===l],date:a[p===m],time:a[d>=g&&d<=c]};k.push({line:n,quantityDone:s,startedAtTime:u.format("HH:mm:ss"),startedAtDate:p,startedAt:u.valueOf(),classNames:f,ok:"is-ok"===f.line&&"is-ok"===f.quantity&&"is-ok"===f.time}),D||(D=k[k.length-1].ok)}});var M={numeric:!0,ignorePunctuation:!0};return k.sort((t,e)=>{if(t.line===i.id&&e.line!==i.id)return-1;if(t.line!==i.id&&e.line===i.id)return 1;var r=t.line.localeCompare(e.line,void 0,M);return 0===r&&(r=t.startedAt-e.startedAt),r}),{orderNo:n,quantityPlanned:l,startAtTime:u.format("HH:mm:ss"),startAtDate:m,shiftOrders:k,ok:D}}})});