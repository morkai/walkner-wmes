define(["underscore","app/time","app/core/View","app/planning/util/shift","app/planning/templates/planExecution"],function(t,e,i,r,n){"use strict";var a={true:"is-ok",false:"is-nok"};return i.extend({template:n,getTemplateData:function(){var t=this.mrp?this.mrp.id:null;return{mrps:this.plan.mrps.map(e=>t&&e.id!==t?null:{_id:e.id,lines:e.lines.map(t=>({_id:t.id,orders:t.orders.map(e=>this.serializeLineOrder(e,t)).filter(t=>!!t)})).filter(t=>!!t&&t.orders.length)}).filter(t=>!!t)}},serializeLineOrder:function(t,i){var n=t.get("orderNo"),s=this.plan.orders.get(n);if(!s)return null;var o=s.getOperationNo(),l=t.get("quantity"),d=e.utc.getMoment(t.get("startAt")),u=d.valueOf(),p=d.format("YYYY-MM-DD"),m=r.getShiftStartTime(u,!1),f=m+r.SHIFT_DURATION,g=u-144e5,h=u+144e5,v=g-m,c=h-f,O=null;if(v<0||c>0){var A=r.getShiftNo(u,!1);O=this.plan.workingLines.getWorkingTimes(i),v<0&&O.prevAt[A]&&(g=e.utc.getMoment(O.prevAt[A]).valueOf()+v),c>0&&O.nextAt[A]&&(h=e.utc.getMoment(O.nextAt[A]).valueOf()+c)}var D=[],k=!1;if(this.plan.shiftOrders.findOrders(n).forEach(t=>{if(o===t.get("operationNo")){var r=t.get("prodLine"),n=t.get("quantityDone"),s=e.getMoment(t.get("startedAt")).utc(!0),d=s.valueOf(),u=s.format("YYYY-MM-DD"),m=d>=g&&d<=h,f={line:a[r===i.id],quantity:a[n===l],date:a[u===p],time:a[m]};D.push({line:r,quantityDone:n,startedAtTime:s.format("HH:mm:ss"),startedAtDate:u,startedAt:s.valueOf(),classNames:f,timeOk:m,ok:"is-ok"===f.line&&"is-ok"===f.quantity&&m}),k=k||D[D.length-1].ok}}),!k){var M=this.plan.shiftOrders.getLineOrderExecution(i.id,t,O);k=M.plannedQuantitiesDone.some(t=>t===l)}var Y={numeric:!0,ignorePunctuation:!0};return D.sort((t,e)=>{if(t.line===i.id&&e.line!==i.id)return-1;if(t.line!==i.id&&e.line===i.id)return 1;var r=t.line.localeCompare(e.line,void 0,Y);return 0===r&&(r=t.startedAt-e.startedAt),r}),{orderNo:n,quantityPlanned:l,startAtTime:d.format("HH:mm:ss"),startAtDate:p,shiftOrders:D,ok:k}}})});