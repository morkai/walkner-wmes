define(["underscore","app/i18n","app/viewport","app/core/View","app/planning/templates/orderLinesDialog"],function(e,i,t,s,n){"use strict";return s.extend({template:n,modelProperty:"plan",events:{submit:function(){return this.submitForm(),!1},"change #-urgent":function(){if(this.setUpLinesSelect2(),!this.$id("urgent").prop("checked")){var i=this.serializeLines().filter(e=>!e.disabled).map(e=>e.id),t=this.$id("lines").select2("data");this.$id("lines").select2("data",t.filter(t=>e.includes(i,t.id)))}}},getTemplateData:function(){var e=this.order;return{version:this.plan.settings.getVersion(),orderNo:e.id,mrp:e.get("mrp"),kind:e.get("kind"),urgent:e.get("urgent")}},afterRender:function(){this.setUpLinesSelect2(),this.$id("lines").select2("data",(this.order.get("lines")||[]).map(e=>({id:e,text:e})))},setUpLinesSelect2:function(){this.$id("lines").select2({multiple:!0,allowClear:!0,placeholder:" ",data:this.serializeLines()})},serializeLines:function(){var i=this.order.get("kind"),t=!!this.$id("urgent").prop("checked");return this.plan.settings.getVersion()>1&&(t=!0),this.plan.settings.mrps.get(this.order.get("mrp")).lines.map(s=>({id:s.id,text:s.id,disabled:!t&&!e.includes(s.get("orderPriority"),i)})).sort((e,i)=>e.text.localeCompare(i.text,void 0,{numeric:!0,ignorePunctuation:!0}))},submitForm:function(){var e=this.$id("submit").prop("disabled",!0),i=e.find(".fa-spinner").removeClass("hidden");t.msg.saving();var s=this.ajax({method:"PATCH",url:"/planning/plans/"+this.plan.id+"/orders/"+this.order.id,data:JSON.stringify({urgent:!!this.$id("urgent").prop("checked"),lines:this.$id("lines").val().split(",").filter(e=>!!e.length)})});s.done(()=>{t.msg.saved(),t.closeDialog()}),s.fail(()=>{i.addClass("hidden"),e.prop("disabled",!1),t.msg.savingFailed(),this.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("lines").select2("focus")}})});