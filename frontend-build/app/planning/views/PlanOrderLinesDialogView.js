define(["underscore","app/i18n","app/viewport","app/core/View","app/planning/templates/orderLinesDialog"],function(e,i,t,n,r){"use strict";return n.extend({template:r,modelProperty:"plan",events:{submit:function(){return this.submitForm(),!1},"change #-urgent":function(){if(this.setUpLinesSelect2(),!this.$id("urgent").prop("checked")){var i=this.serializeLines().filter(function(e){return!e.disabled}).map(function(e){return e.id}),t=this.$id("lines").select2("data");this.$id("lines").select2("data",t.filter(function(t){return e.includes(i,t.id)}))}}},getTemplateData:function(){var e=this.order;return{orderNo:e.id,mrp:e.get("mrp"),kind:e.get("kind"),urgent:e.get("urgent")}},afterRender:function(){this.setUpLinesSelect2(),this.$id("lines").select2("data",(this.order.get("lines")||[]).map(function(e){return{id:e,text:e}}))},setUpLinesSelect2:function(){this.$id("lines").select2({multiple:!0,allowClear:!0,placeholder:" ",data:this.serializeLines()})},serializeLines:function(){var i=this.order.get("kind"),t=this.$id("urgent").prop("checked");return this.plan.settings.mrps.get(this.order.get("mrp")).lines.map(function(n){return{id:n.id,text:n.id,disabled:!t&&!e.includes(n.get("orderPriority"),i)}})},submitForm:function(){var e=this,i=e.$id("submit").prop("disabled",!0),n=i.find(".fa-spinner").removeClass("hidden"),r=e.ajax({method:"PATCH",url:"/planning/plans/"+e.plan.id+"/orders/"+e.order.id,data:JSON.stringify({urgent:this.$id("urgent").prop("checked"),lines:this.$id("lines").val().split(",").filter(function(e){return e.length>0})})});r.done(t.closeDialog),r.fail(function(){n.addClass("hidden"),i.prop("disabled",!1),t.msg.show({type:"error",time:3e3,text:e.t("orders:menu:lines:failure")}),e.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("lines").select2("focus")}})});