// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/user","app/core/View","app/core/views/DialogView","app/data/orgUnits","../util/contextMenu","./PlanLineSettingsDialogView","app/planning/templates/lines","app/planning/templates/linePopover","app/planning/templates/lineRemoveDialog"],function(e,i,n,t,r,s,o,l,a,p,d,g,c){"use strict";return s.extend({template:d,events:{"contextmenu .is-line":function(e){return this.showMenu(e),!1}},localTopics:{"planning.windowResized":"resize","planning.escapePressed":"hideMenu"},initialize:function(){this.listenTo(this.plan.settings,"changed",this.onSettingsChanged)},destroy:function(){this.hideMenu(),this.$el.popover("destroy"),i(document.body).off("."+this.idPrefix)},serialize:function(){var e=this;return{idPrefix:e.idPrefix,lines:e.mrp.lines.map(function(i){var n=i.mrpSettings(e.mrp.id);return{_id:i.id,workerCount:n?n.get("workerCount"):"?",customTimes:e.serializeActiveTime(i,!1)}})}},afterRender:function(){var e=this;e.$id("list").on("scroll",function(i){e.$id("scrollIndicator").toggleClass("hidden",i.target.scrollLeft<=40)}),e.resize(),this.$el.popover({container:this.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){return e.serializePopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},resize:function(){var e=this.$id("edit"),i=this.$id("scrollIndicator"),n=e.position();i.css({top:n.top+1+"px",left:e.outerWidth()+n.left+"px"}),a.hide(this)},$item:function(e){return e?this.$('.planning-mrp-list-item[data-id="'+e+'"]'):this.$(".planning-mrp-list-item")},serializePopover:function(e){var i=this.mrp.lines.get(e);if(!i)return null;var n=l.getAllForProdLine(e),t=l.getByTypeAndId("prodFlow",n.prodFlow),r=l.getByTypeAndId("prodLine",n.prodLine),s=i.mrpSettings(this.mrp.id);return g({line:{_id:e,division:n.division?n.division:"?",prodFlow:t?t.get("name"):"?",prodLine:r?r.get("description"):"?",workerCount:s?s.get("workerCount"):"?",activeTime:this.serializeActiveTime(i,!0)}})},serializeActiveTime:function(e,i){if(!e.settings)return"";var n=e.settings.get("activeFrom"),t=e.settings.get("activeTo");return i||n||t?(n||"06:00")+"-"+(t||"06:00"):""},hideMenu:function(){a.hide(this)},showMenu:function(e){if(this.plan.isEditable()&&r.isAllowedTo("PLANNING:PLANNER","PLANNING:MANAGE")){var i=this.mrp.lines.get(this.$(e.currentTarget).attr("data-id"));a.show(this,e.pageY,e.pageX,[{label:n("planning","lines:menu:settings"),handler:this.handleSettingsAction.bind(this,i)},{label:n("planning","lines:menu:remove"),handler:this.handleRemoveAction.bind(this,i)}])}},handleSettingsAction:function(e){var i=new p({plan:this.plan,mrp:this.mrp,line:e});t.showDialog(i,n("planning","lines:menu:settings:title"))},handleRemoveAction:function(i){var r=this,s=new o({autoHide:!1,template:c,model:{plan:r.plan.getLabel(),mrp:r.mrp.getLabel(),line:i.getLabel()}});r.listenTo(s,"answered",function(){var o=r.plan.settings.lines.get(i.id);o.set("mrpPriority",e.without(o.get("mrpPriority"),r.mrp.id));var l=r.promised(r.plan.settings.save());l.done(s.closeDialog),l.fail(function(){t.msg.show({type:"error",time:3e3,text:n("planning","lines:menu:remove:failure")}),r.plan.settings.trigger("errored"),s.enableAnswers()})}),t.showDialog(s,n("planning","lines:menu:remove:title"))},onSettingsChanged:function(e){e.lines.any&&e.mrps[this.mrp.id]&&this.render()}})});