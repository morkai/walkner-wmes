// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/core/View","app/data/orgUnits","app/planning/templates/lines","app/planning/templates/linePopover","app/planning/templates/contextMenu"],function(e,i,n,t,o,r,s,d){"use strict";return t.extend({template:r,events:{"contextmenu .is-line":function(e){return this.showMenu(e),!1}},localTopics:{"planning.windowResized":"resize","planning.escapePressed":"hideMenu"},initialize:function(){this.hideMenu=this.hideMenu.bind(this),this.$menu=null,this.listenTo(this.plan.settings,"changed",this.onSettingsChanged)},destroy:function(){this.hideMenu(),this.$el.popover("destroy"),i(document.body).off("."+this.idPrefix)},serialize:function(){var e=this;return{idPrefix:e.idPrefix,lines:e.mrp.lines.map(function(i){var n=i.mrpSettings(e.mrp.id);return{_id:i.id,workerCount:n?n.get("workerCount"):"?",customTimes:e.serializeActiveTime(i,!1)}})}},afterRender:function(){var e=this;e.$id("list").on("scroll",function(i){e.$id("scrollIndicator").toggleClass("hidden",i.target.scrollLeft<=40)}),e.resize(),this.$el.popover({container:this.el,selector:".planning-mrp-list-item",trigger:"hover",placement:"top",html:!0,content:function(){return e.serializePopover(this.dataset.id)},template:'<div class="popover planning-mrp-popover"><div class="arrow"></div><div class="popover-content"></div></div>'})},resize:function(){var e=this.$id("edit"),i=this.$id("scrollIndicator"),n=e.position();i.css({top:n.top+1+"px",left:e.outerWidth()+n.left+"px"}),this.hideMenu()},$item:function(e){return e?this.$('.planning-mrp-list-item[data-id="'+e+'"]'):this.$(".planning-mrp-list-item")},serializePopover:function(e){var i=this.mrp.lines.get(e);if(!i)return null;var n=o.getAllForProdLine(e),t=o.getByTypeAndId("prodFlow",n.prodFlow),r=o.getByTypeAndId("prodLine",n.prodLine),d=i.mrpSettings(this.mrp.id);return s({line:{_id:e,division:n.division?n.division:"?",prodFlow:t?t.get("name"):"?",prodLine:r?r.get("description"):"?",workerCount:d?d.get("workerCount"):"?",activeTime:this.serializeActiveTime(i,!0)}})},serializeActiveTime:function(e,i){if(!e.settings)return"";var n=e.settings.get("activeFrom"),t=e.settings.get("activeTo");return i||n||t?(n||"06:00")+"-"+(t||"06:00"):""},hideMenu:function(){var e=this.$menu;e&&(i(window).off(".menu."+this.idPrefix),i(document.body).off(".menu."+this.idPrefix),e.fadeOut("fast",function(){e.remove()}),this.$menu=null)},showMenu:function(e){var t=this;if(t.plan.isEditable()){t.hideMenu();var o=t.mrp.lines.get(t.$(e.currentTarget).attr("data-id"));t.$menu=i(d({header:n("planning","lines:menu:header",{line:o.id}),prefix:"lines",actions:["settings","remove"]})),t.$menu.css({top:e.pageY+"px",left:e.pageX+"px"}),t.$menu.on("mousedown",function(e){return 1===e.which&&void e.stopPropagation()}),t.$menu.on("mouseup",function(e){if(1!==e.which)return!1}),t.$menu.on("contextmenu",!1),t.$menu.on("click","a[data-action]",this.onMenuClick.bind(this)),i(window).one("scroll.menu."+this.idPrefix,t.hideMenu),i(document.body).one("mousedown.menu."+this.idPrefix,t.hideMenu),t.$menu.appendTo(document.body)}},onMenuClick:function(e){return this.hideMenu(),!1},onSettingsChanged:function(e){e.lines.any&&e.mrps[this.mrp.id]&&this.render()}})});