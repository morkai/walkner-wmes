// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/linesEditDialog"],function(e,t,i,n,r,s,a,l){"use strict";return r.extend({template:l,events:{submit:function(){return this.submitForm(),!1},"change #-line":function(e){this.removeEmptyLines(),this.addLine(e.added.id),this.$id("line").select2("val","")}},afterRender:function(){this.setUpLineSelect2(),this.mrp.lines.forEach(function(e){this.addLine(e.id)},this)},setUpLineSelect2:function(){var t=this,i=0,n=s.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(function(t){return t.id.length>i&&(i=t.id.length),{id:t.id,text:e.escape(t.get("description"))}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})});t.$id("line").select2({allowClear:!0,data:n,matcher:function(e,t,i){return e=e.toUpperCase(),i.id.toUpperCase().indexOf(e)>=0||i.text.toUpperCase().indexOf(e)>=0},formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var t=e.id;t.length<i;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text}})},removeEmptyLines:function(){this.$("input[data-line-id]").each(function(){""===this.value&&t(this).select2("destroy").parent().remove()})},addLine:function(n){if(!this.$id(n).select2("focus").length){var r=this.plan.settings.lines.get(n),s=r?r.get("mrpPriority"):[];e.includes(s,this.mrp.id)||s.push(this.mrp.id);var l=this.idPrefix+"-"+n,d=t('<div class="form-group"></div>'),o=t("<label></label>").attr("for",l).text(n),p=t('<input type="text">').attr("id",l).attr("data-line-id",n).val(s.join(","));d.append(o).append(p).appendTo(this.$id("lines")),a(p,{view:this,sortable:!0,width:"100%",placeholder:i("planning","settings:mrpPriority:placeholder")}),p.select2("focus")}},submitForm:function(){var e=this,t=e.$id("submit").prop("disabled",!0),r=t.find(".fa-spinner").removeClass("hidden"),s=e.plan.settings;e.$("input[data-line-id]").each(function(){var e=this.dataset.lineId,t=s.lines.get(e),i=this.value.length?this.value.split(","):[];t?t.set("mrpPriority",i):i.length&&s.lines.add({_id:e,mrpPriority:i})});var a=s.save();a.done(n.closeDialog),a.fail(function(){r.addClass("hidden"),t.prop("disabled",!1),n.msg.show({type:"error",time:3e3,text:i("planning","lines:edit:failure")}),e.plan.settings.trigger("errored")})},onDialogShown:function(){this.$id("line").select2("focus")}})});