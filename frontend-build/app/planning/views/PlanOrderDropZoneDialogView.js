// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/time","app/viewport","app/core/View","app/planning/templates/orderDropZoneDialog"],function(e,t,i,r,n){"use strict";return r.extend({template:n,events:{submit:"submitForm","blur #-orders":function(){var e=this.$id("orders"),t=e.val().match(/([0-9]{9})/g);e.val(t?t.join(", "):"")},"blur #-dropZone":"toggleRequired"},serialize:function(){var e=this.order,i=this.plan.sapOrders.get(e.id),r=i.get("whDropZone")||"",n=[e.id];return r&&this.plan.sapOrders.forEach(function(e){if(e.id!==i.id){var t=e.get("whDropZone")||"";t===r&&n.push(e.id)}}),{idPrefix:this.idPrefix,status:this.plan.sapOrders.getWhStatus(i.id),dropZone:r,time:i.get("whTime")?t.utc.format(i.get("whTime"),"HH:mm"):t.format(Date.now(),"HH:mm"),orders:n.join(", "),canChangeStatus:this.plan.canChangeWhStatus()}},afterRender:function(){this.toggleRequired()},submitForm:function(){var r=this,n=r.$id("submit").prop("disabled",!0),o=n.find(".fa-spinner").removeClass("hidden"),a=r.plan.canChangeWhStatus(),d=a?r.$id("comment").val().trim():void 0,s=a?r.$('input[name="status"]:checked').val():void 0,p=r.$id("dropZone").val().trim(),u=t.utc.getMoment("2000-01-01 "+r.$id("time").val().trim(),"YYYY-MM-DD HH:mm"),m=""!==p&&u.isValid()?u.toISOString():null;m||(p="");var l=r.ajax({method:"POST",url:"/orders",data:JSON.stringify(this.$id("orders").val().match(/([0-9]{9})/g).map(function(e){return{_id:e,source:"wh",comment:d,whStatus:s,whDropZone:p,whTime:m}}))});return l.done(i.closeDialog),l.fail(function(){o.addClass("hidden"),n.prop("disabled",!1),i.msg.show({type:"error",time:3e3,text:e("planning","orders:menu:dropZone:failure")}),r.plan.settings.trigger("errored")}),!1},toggleRequired:function(){var e=this.$id("dropZone").val().trim().length>0;this.$id("time").prop("required",e)},onDialogShown:function(){this.$id("dropZone").focus()}})});