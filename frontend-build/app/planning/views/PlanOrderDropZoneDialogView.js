// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/time","app/viewport","app/core/View","app/planning/templates/orderDropZoneDialog"],function(e,i,t,n,r){"use strict";return n.extend({template:r,events:{submit:"submitForm","blur #-orders":function(){var e=this.$id("orders"),i=e.val().match(/([0-9]{9})/g);e.val(i?i.join(", "):"")},"blur #-dropZone":"toggleRequired"},serialize:function(){var e=this.order,t=this.plan.sapOrders.get(e.id),n=t.get("whDropZone")||"",r=[e.id];return n&&this.plan.sapOrders.forEach(function(e){if(e.id!==t.id){(e.get("whDropZone")||"")===n&&r.push(e.id)}}),{idPrefix:this.idPrefix,status:this.plan.sapOrders.getWhStatus(t.id),dropZone:n,time:t.get("whTime")?i.utc.format(t.get("whTime"),"HH:mm"):i.format(Date.now(),"HH:mm"),orders:r.join(", "),canChangeDropZone:this.plan.canChangeWhDropZone(),canChangeStatus:this.plan.canChangeWhStatus()}},afterRender:function(){this.toggleRequired()},submitForm:function(){var n=this,r=n.$id("submit").prop("disabled",!0),o=r.find(".fa-spinner").removeClass("hidden"),a=n.plan.canChangeWhStatus(),d=a?n.$id("comment").val().trim():void 0,s=a?n.$('input[name="status"]:checked').val():void 0,p=n.$id("dropZone").val().trim(),h=i.utc.getMoment("2000-01-01 "+n.$id("time").val().trim(),"YYYY-MM-DD HH:mm"),l=""!==p&&h.isValid()?h.toISOString():null;l||(p=""),n.plan.canChangeWhDropZone()||(p=void 0,l=void 0);var u=n.ajax({method:"POST",url:"/orders",data:JSON.stringify(this.$id("orders").val().match(/([0-9]{9})/g).map(function(e){return{_id:e,source:"wh",comment:d,whStatus:s,whDropZone:p,whTime:l}}))});return u.done(t.closeDialog),u.fail(function(){o.addClass("hidden"),r.prop("disabled",!1),t.msg.show({type:"error",time:3e3,text:e("planning","orders:menu:dropZone:failure")}),n.plan.settings.trigger("errored")}),!1},toggleRequired:function(){var e=this.$id("dropZone").val().trim().length>0;this.$id("time").prop("required",e)},onDialogShown:function(){this.plan.canChangeWhDropZone()&&this.$id("dropZone").focus()}})});