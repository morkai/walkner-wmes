define(["underscore","jquery","Sortable","app/i18n","app/time","app/user","app/viewport","app/data/orgUnits","app/data/orderStatuses","app/core/views/FormView","app/core/util/decimalSeparator","app/mrpControllers/util/setUpMrpSelect2","app/orderStatuses/util/renderOrderStatusLabel","app/planning/templates/planSettings","app/planning/templates/planSettingsGroup"],function(e,t,i,r,s,a,n,o,l,d,c,p,h,u,m){"use strict";function g(e,t,i){return e=e.toUpperCase(),i.id.toUpperCase().indexOf(e)>=0||i.text.toUpperCase().indexOf(e)>=0}return d.extend({template:u,events:e.assign({"change [data-object]":function(e){var t=e.currentTarget.dataset.object,i=e.currentTarget.name,r=e.currentTarget.dataset.index>=0?+e.currentTarget.dataset.index:void 0;this.updateProperty(t,i,r)},"change #-mrp":function(t){var i=t.added?t.added.id:null,r=e.result(this.$id("mrpLine").select2("data"),"id");r||(r=e.result(this.$id("line").select2("data"),"id"));var s=this.model.mrps.get(i);s?s.lines.get(r)||(r=e.result(s.lines.first(),"id")):r=e.result(this.model.lines.find(function(t){return e.includes(t.get("mrpPriority"),i)}),"id"),this.selectMrp(i,r||null)},"change #-mrpLine":function(e){var t=this.model.mrps.get(this.$id("mrp").val());this.selectMrpLine(t,e.added?e.added.id:null,!1)},"blur #-schedulingRate":function(e){e.target.value=this.formatSchedulingRate(this.model.get("schedulingRate"))},"blur #-ignoredWorkCenters":function(e){e.target.value=this.formatIgnoredWorkCenters(this.model.get("ignoredWorkCenters"))},"click #-addGroup":function(){this.addGroup({splitOrderQuantity:0,lines:[],components:[]})},'click .btn[name="removeGroup"]':function(e){var t=this,i=t.$(e.currentTarget).closest("tr");i.fadeOut("fast",function(){i.find('[name="group.lines"]').select2("destroy"),i.find('[name="group.components"]').select2("destroy"),i.remove(),t.updateProperty("mrp","group")})}},d.prototype.events),remoteTopics:{"planning.generator.finished":function(e){e.date===this.model.id&&this.onGeneratorFinished()},"planning.settings.updated":function(e){e.date===this.model.id&&(0===e.changes.length?this.onGeneratorFinished():this.model.applyChanges(e.changes))}},initialize:function(){d.prototype.initialize.apply(this,arguments),this.sortables=[],this.maxLineLength=0,this.lines=[],this.stopListening(this.model,"change"),this.once("afterRender",()=>{this.listenTo(this.model,"change",this.onSettingChange),this.listenTo(this.model,"changed",this.onSettingsChanged)})},destroy:function(){for(var e=0,t=this.sortables.length;e<t;++e)this.sortables[e].destroy();this.sortables=[]},getTemplateData:function(){return{version:this.model.getVersion()}},afterRender:function(){d.prototype.afterRender.call(this),this.cacheLines(),this.setUpHelpPopovers(),this.setUpOrderStatusSelect2("requiredStatuses"),this.setUpOrderStatusSelect2("ignoredStatuses"),this.setUpOrderStatusSelect2("completedStatuses"),this.setUpComponentsSelect2(this.$id("hardComponents")),this.setUpComponentsSelect2(this.$id("hardBigComponents")),this.setUpLineSelect2(),this.setUpMrpSelect2(),this.setUpMrpLineSelect2(),this.setUpLinePrioritySelect2(),this.setUpOrderPrioritySelect2(),this.selectMrp(null),this.model.isEditable()||this.$id("submit").prop("disabled",!0)},setUpHelpPopovers:function(){const e=this;e.$("label[data-help]").popover({trigger:"hover",className:"planning-settings-helpPopover",html:!0,content:function(){const t=`settings:${this.dataset.help||this.control.name}:help`;return e.t.has(t)?e.t(t):""}})},cacheLines:function(){this.lines=o.getAllByType("prodLine").filter(e=>!e.get("deactivatedAt")).map(t=>(t.id.length>this.maxLineLength&&(this.maxLineLength=t.id.length),{id:t.id,text:e.escape(t.get("description")),disabled:this.model.isLineLocked(t.id)})).sort((e,t)=>e.id.localeCompare(t.id,void 0,{numeric:!0,ignorePunctuation:!0}))},setUpOrderStatusSelect2:function(t){this.$id(t).select2({allowClear:!0,multiple:!0,data:l.map(e=>({id:e.id,text:e.get("label")})),matcher:g,formatSelection:e=>e.id,formatResult:t=>`${h(t.id)} ${e.escape(t.text)}`})},setUpComponentsSelect2:function(e){e.length&&e.select2({width:"100%",placeholder:"12NC...",allowClear:!0,multiple:!0,data:[],formatNoMatches:null,minimumResultsForSearch:1,dropdownCssClass:"hidden",tokenizer:(e,t,i)=>{var r=e,s={};return t.forEach(function(e){s[e.id]=!0}),(e.match(/([0-9]{12}|[A-Z]{3}[A-Z0-9]{4})/gi)||[]).forEach(function(e){r=r.replace(e,""),e=e.toUpperCase(),s[e]||(i({id:e,text:e}),s[e]=!0)}),e===r?null:r.replace(/\s+/," ").trim()}})},setUpLineSelect2:function(){var t=this,i=t.$id("line");i.select2({width:"100%",placeholder:t.t("settings:line:placeholder"),allowClear:!0,data:this.lines,matcher:g,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var i=e.id;i.length<t.maxLineLength;)i+=" ";return'<span class="text-mono">'+i.replace(/ /g,"&nbsp;")+"</span>: "+e.text}}),i.on("change",function(e,i){void 0===i&&(i=e.added),t.selectLine(i?i.id:null)}),t.$id("activeTime").prop("disabled",!0),t.$id("extraCapacity").prop("disabled",!0),t.model.getVersion()>1&&t.$('input[name="workerCount"]').prop("disabled",!0),t.setUpMrpPriority(),t.setUpOrderGroupPriority()},setUpMrpPriority:function(){var e=this,r=e.$id("mrpPriority");p(r,{width:"100%",placeholder:e.t("settings:mrpPriority:placeholder")});var s=r.select2("container").find(".select2-choices")[0];e.sortables.push(new i(s,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){r.select2("onSortStart")},onEnd:function(i){r.select2("onSortEnd").select2("focus"),e.saveMrpPriority(),e.selectMrp(t(i.target).data("select2-data").id,e.$id("line").val()||null)}})),r.on("change",function(t){e.saveMrpPriority(),t.added?e.selectMrp(t.added.id,e.$id("line").val()||null):t.removed&&e.selectMrp(null)}),r.select2("enable",!1)},setUpOrderGroupPriority:function(){var e=this,t=e.$id("orderGroupPriority");if(t.length){t.select2({width:"100%",allowClear:!0,multiple:!0,placeholder:e.t("settings:orderGroupPriority:placeholder"),data:this.orderGroups.map(function(e){return{id:e.id,text:e.getLabel()}})});var r=t.select2("container").find(".select2-choices")[0];e.sortables.push(new i(r,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){console.log("onSortStart"),t.select2("onSortStart")},onEnd:function(){t.select2("onSortEnd").select2("focus"),e.saveOrderGroupPriority()}})),t.on("change",function(){e.saveOrderGroupPriority()}),t.select2("enable",!1)}},setUpMrpSelect2:function(){var t=this,i=0,r={};t.model.lines.forEach(function(e){e.get("mrpPriority").forEach(function(e){r[e]=1,e.length>i&&(i=e.length)})}),t.$id("mrp").select2({width:"100%",placeholder:t.t("settings:mrp:placeholder"),allowClear:!0,data:Object.keys(r).map(function(e){var i=o.getByTypeAndId("mrpController",e);return{id:e,text:i?i.get("description"):"",disabled:t.model.isMrpLocked(e)}}),matcher:g,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var t=e.id;t.length<i;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text}})},setUpMrpLineSelect2:function(){var t=this.$id("mrp").select2("data"),i=0,r={};this.model.lines.forEach(function(s){t&&e.includes(s.get("mrpPriority"),t.id)&&(r[s.id]=1,s.id.length>i&&(i=s.id.length))});var s=Object.keys(r).map(function(e){var t=o.getByTypeAndId("prodLine",e);return{id:e,text:t?t.get("description"):""}});this.$id("mrpLine").select2({width:"100%",placeholder:this.t("settings:mrpLine:placeholder"),allowClear:!0,data:s,matcher:g,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var t=e.id;t.length<i;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text}}).select2("enable",s.length>0)},setUpLinePrioritySelect2:function(){var e=this.$id("linePriority");if(e.length){var t=[],r=this.$id("mrp").val();if(r){var s=this.model.mrps.get(r),a=[].concat(s.get("linePriority")||[]);this.model.lines.forEach(e=>{!a.includes(e.id)&&e.get("mrpPriority").includes(r)&&a.push(e.id)}),a.forEach(e=>{t.push({id:e,text:e,locked:!0})})}e.select2({allowClear:!1,multiple:!0,dropdownCssClass:"hidden",data:t.concat([]).sort((e,t)=>e.id.localeCompare(t.id,void 0,{numeric:!0,ignorePunctuation:!0}))}),e.data("sortable")&&e.data("sortable").destroy();var n=e.select2("container").find(".select2-choices")[0],o=new i(n,{draggable:".select2-search-choice",onStart:()=>{e.select2("onSortStart")},onEnd:()=>{e.select2("onSortEnd"),this.saveLinePriority()}});e.data("sortable",o),this.sortables.push(o),e.select2("data",t).select2("enable",!!r.length)}},setUpOrderPrioritySelect2:function(){const e=this.$id("orderPriority").select2({allowClear:!0,multiple:!0,placeholder:this.t("settings:orderPriority:placeholder"),data:this.model.getAvailableOrderPriorities().map(e=>({id:e,text:this.t(`orderPriority:${e}`)}))}),t=e.select2("container").find(".select2-choices")[0];this.sortables.push(new i(t,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:()=>{e.select2("onSortStart")},onEnd:()=>{e.select2("onSortEnd").select2("focus"),this.saveOrderPriority()}})),e.on("change",()=>{this.saveOrderPriority()}),e.select2("enable",!1)},selectLine:function(t){const i=this.model.getVersion(),r=!t,s=this.$id("mrpPriority"),a=this.$id("orderPriority"),n=this.$id("orderGroupPriority");let o="",l="",d=[0,0,0];if(this.$id("line").select2("val",t||""),r)s.select2("enable",!1).select2("val",""),i>1&&(a.select2("enable",!1).select2("val",""),n.select2("enable",!1).select2("val","")),this.selectMrp(null,null);else{let r=t,c=this.model.lines.get(r);c||(c=this.model.lines.add({_id:r}).get(r));const p=c.get("mrpPriority");if(s.select2("enable",!0).select2("data",p.map(e=>({id:e,text:e}))),i>1){const e=c.get("orderPriority")||[];a.select2("enable",!0).select2("data",e.map(e=>({id:e,text:this.t(`orderPriority:${e}`)})));const t=c.get("orderGroupPriority")||[];n.select2("enable",!0).select2("data",t.map(e=>{const t=this.orderGroups.get(e);return{id:e,text:t?t.getLabel():e}})),l=c.get("extraCapacity")||"",d=c.get("workerCount")||d}o=this.buildActiveTime(c.get("activeTime"));let h=this.$id("mrp").select2("data");p.length?h=h&&e.includes(p,h.id)?h.id:p[0]:(h=null,r=null),this.selectMrp(h,r)}this.$id("activeTime").val(o).prop("disabled",r),this.$id("extraCapacity").val(l).prop("disabled",r),i>1&&this.$('input[name="workerCount"]').each((e,t)=>{t.value=d[e],t.disabled=r})},selectMrp:function(e,t){var i=this;i.$id("mrp").select2("val",e||"");var r=i.model.mrps,s=r.get(e),a=!!i.$id("mrp").select2("data"),n=!a;a&&!s&&(s=r.add({_id:e}).get(e)),(s?s.get("extraShiftSeconds"):[0,0,0]).forEach((e,t)=>{i.$id("extraShiftSeconds-"+(t+1)).val(n?"":e).prop("disabled",n)}),i.$id("limitSmallOrders").prop("checked",!n&&s.get("limitSmallOrders")).prop("disabled",n),["extraOrderSeconds","smallOrderQuantity","bigOrderQuantity","hardOrderManHours","splitOrderQuantity","maxSplitLineCount"].forEach(e=>{i.$id(e).val(n?"":s.get(e)).prop("disabled",n)}),["hardComponents","hardBigComponents"].forEach(e=>{var t=[];n||(t=(s.get(e)||[]).map(function(e){return{id:e,text:e}})),i.$id(e).select2("data",t).select2("enable",a)}),i.removeGroups(),s&&s.get("groups").forEach(i.addGroup,i),i.$id("addGroup").prop("disabled",n),i.setUpLinePrioritySelect2(),i.setUpMrpLineSelect2(),i.selectMrpLine(s,t,n)},selectMrpLine:function(e,t,i){if(2===this.model.getVersion())return;let r=e?e.lines.get(t):null;this.$id("mrpLine").select2("val",t||"").select2("enable",!i),(i=i||!this.$id("mrpLine").select2("data"))||r||(r=e.lines.add({_id:t}).get(t)),this.$('input[name="workerCount"]').each((e,t)=>{this.$(t).val(i?"":r.get("workerCount")[t.dataset.index]).prop("disabled",i)}),this.$id("orderPriority").select2("val",i?[]:r.get("orderPriority")).prop("disabled",i)},saveLine:function(t){const i=this.$id("line").val(),r=this.model.lines,s=r.get(i);if(s)s.set(t);else{const t={_id:i,mrpPriority:e.pluck(this.$id("mrpPriority").select2("data"),"id"),orderGroupPriority:e.pluck(this.$id("orderGroupPriority").select2("data"),"id"),activeTime:this.parseActiveTime(this.$id("activeTime")),extraCapacity:this.parseExtraCapacity(this.$id("extraCapacity"))};this.model.getVersion()>1&&(t.orderPriority=e.pluck(this.$id("orderPriority").select2("data"),"id"),t.workerCount=this.$('input[name="workerCount"]').map((e,t)=>+t.value||0).get()),r.add(t)}},saveMrpPriority:function(){this.saveLine({mrpPriority:e.pluck(this.$id("mrpPriority").select2("data"),"id")}),this.setUpMrpSelect2()},saveOrderGroupPriority:function(){this.saveLine({orderGroupPriority:e.pluck(this.$id("orderGroupPriority").select2("data"),"id")})},saveOrderPriority:function(){const t=e.pluck(this.$id("orderPriority").select2("data"),"id");if(1===this.model.getVersion()){this.model.mrps.get(this.$id("mrp").val()).lines.get(this.$id("mrpLine").val()).set("orderPriority",t)}else this.saveLine({orderPriority:t})},saveLinePriority:function(){this.model.mrps.get(this.$id("mrp").val()).set("linePriority",e.pluck(this.$id("linePriority").select2("data"),"id"))},buildActiveTime:function(e){return(e||[]).map(e=>e.from+"-"+e.to).join(", ")},parseActiveTime:function(e){var t=e.val().split(",").map(e=>{var t=e.trim().split("-");return{from:i(t[0]),to:i(t[1])}}).filter(e=>!!e.from&&!!e.to);return e.val(this.buildActiveTime(t)),t;function i(e){var t=e.split(":"),i=+t[0],r=+t[1]||0;return i>=0&&i<=24&&r>=0&&r<=59?(24===i&&(i=0),(i<10?"0":"")+i+":"+(r<10?"0":"")+r):""}},parseExtraCapacity:function(e){var t=(e.val()||"").trim();return/^[0-9]{1,3}%?$/.test(t)&&"0%"!==t||(t="0"),e.val(t),t},serializeToForm:function(){var e=this.model.toJSON();return e.requiredStatuses=e.requiredStatuses.join(","),e.ignoredStatuses=e.ignoredStatuses.join(","),e.completedStatuses=e.completedStatuses.join(","),e.schedulingRate=this.formatSchedulingRate(e.schedulingRate),e.ignoredWorkCenters=this.formatIgnoredWorkCenters(e.ignoredWorkCenters),e},serializeForm:function(){return{}},checkValidity:function(){return!0},addGroup:function(t){var i=this,r=i.$id("groups");r.append(this.renderPartialHtml(m,{group:Object.assign({no:r.children().length+1},t)}));var s=r.children().last();s.find('[name="group.lines"]').select2({width:"500px",allowClear:!0,multiple:!0,data:this.lines,matcher:g,formatSelection:t=>e.escape(t.id),formatResult:e=>{for(var t=e.id;t.length<i.maxLineLength;)t+=" ";return'<small><span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text+"</small>"}});var a=s.find('[name="group.components"]').val("");i.setUpComponentsSelect2(a),a.select2("data",t.components.map(e=>({id:e,text:e})))},removeGroups:function(){var e=this.$id("groups");e.find(".select2-container + input").select2("destroy"),e.html("")},serializeGroups:function(){var e=this,t=[];return e.$id("groups").find("tr").each(function(i){var r=e.$(this);r.find("td").first().text(i+1+".");var s={splitOrderQuantity:Math.max(0,r.find('[name="group.splitOrderQuantity"]').val()||0),lines:r.find('[name="group.lines"]').val().split(",").filter(function(e){return!!e.length}),components:r.find('[name="group.components"]').val().split(",").filter(function(e){return!!e.length})};s.lines.length&&t.push(s)}),t},updateProperty:function(e,t,i){var r,s=this.model;if("line"===e?s=s.lines.get(this.$id("line").val()):"plan"!==e&&(s=s.mrps.get(this.$id("mrp").val()),"mrpLine"===e&&(s=s.lines.get(this.$id("mrpLine").val()))),s){var a=this.$id(t);if(a.length||(a=this.$('[name="'+t+'"]')),a.length||"group"===t){switch(i>=0&&(a=a.filter('[data-index="'+i+'"]')),t){case"requiredStatuses":case"ignoredStatuses":case"completedStatuses":case"hardComponents":case"hardBigComponents":case"orderPriority":case"linePriority":r=a.val().split(",").filter(function(e){return e.length>0});break;case"schedulingRate":r={ANY:1},a.val().split("\n").forEach(function(e){var t=e.match(/([0-9,.]+)/);if(t){var i=Math.max(0,parseFloat(t[1].replace(",","."))||0)||1;e.replace(t[0],"").split(/[^A-Za-z0-9]/).forEach(function(e){e.length>=3&&(r[e.toUpperCase()]=i)})}});break;case"ignoredWorkCenters":r=a.val().split(",").map(function(e){return e.trim()}).filter(function(e){return e.length});break;case"forceWorkDay":case"ignoreCompleted":case"useRemainingQuantity":case"limitSmallOrders":r=a.prop("checked");break;case"freezeHour":case"lateHour":case"etoPilotHour":case"minIncompleteDuration":case"extraOrderSeconds":case"smallOrderQuantity":case"bigOrderQuantity":case"splitOrderQuantity":case"maxSplitLineCount":r=Math.max(0,parseInt(a.val(),10)||0);break;case"workerCount":r=Math.max(0,+parseFloat(a.val()).toFixed(2)||0);break;case"extraShiftSeconds":r=[Math.max(0,parseInt(this.$id(t+"-1").val(),10)||0),Math.max(0,parseInt(this.$id(t+"-2").val(),10)||0),Math.max(0,parseInt(this.$id(t+"-3").val(),10)||0)];break;case"hardOrderManHours":r=Math.max(0,parseFloat(a.val())||0);break;case"activeTime":r=this.parseActiveTime(a);break;case"extraCapacity":r=this.parseExtraCapacity(a);break;default:/^group/.test(t)&&(t="groups",r=this.serializeGroups())}if(void 0!==r)if(i>=0){if(!Array.isArray(s.attributes[t]))return;s.attributes[t][i]=r}else s.attributes[t]=r}}},submitRequest:function(e,t){var i=this.request(t);i.done(this.handleSuccess.bind(this)),i.fail(this.handleFailure.bind(this))},handleSuccess:function(){this.timers.waitForGenerator=setTimeout(this.onGeneratorFinished.bind(this),1e4),n.msg.show({type:"success",time:2500,text:this.t("settings:msg:success")})},handleFailure:function(){d.prototype.handleFailure.apply(this,arguments),this.$id("submit").prop("disabled",!1)},getFailureText:function(){return this.t("settings:msg:failure")},formatSchedulingRate:function(e){var t=this,i=[t.formatSchedulingRateNumber(e.ANY||1)+": ANY"],r={};return Object.keys(e).forEach(function(i){if("ANY"!==i){var s=t.formatSchedulingRateNumber(e[i]);r[s]||(r[s]=[]),r[s].push(i)}}),Object.keys(r).forEach(function(e){i.push(e+": "+r[e].sort().join(", "))}),i.join("\n")},formatSchedulingRateNumber:function(e){var t=e.toString();if(-1===t.indexOf("."))t+=".0000";else for(;t.length<6;)t+="0";return t.replace(".",c)},formatIgnoredWorkCenters:function(e){return Array.isArray(e)?e.join(", "):""},onGeneratorFinished:function(){this.timers.waitForGenerator&&(clearTimeout(this.timers.waitForGenerator),this.timers.waitForGenerator=null,this.options.back?this.broker.publish("router.navigate",{url:"/planning/plans/"+this.model.id,trigger:!0,replace:!1}):this.$id("submit").prop("disabled",!1))},onSettingChange:function(){var e=this,t=e.model.changed;Object.keys(t).forEach(function(i){var r=t[i];switch(i){case"ignoreCompleted":case"useRemainingQuantity":e.$id(i).prop("checked",!!r);break;case"requiredStatuses":case"ignoredStatuses":case"completedStatuses":e.$id(i).select2("val",r);break;case"schedulingRate":e.$id(i).val(e.formatSchedulingRate(r));break;case"ignoredWorkCenters":e.$id(i).val(e.formatIgnoredWorkCenters(r))}})},onSettingsChanged:function(e){var t=document.activeElement,i=this.$id("line").val(),r=this.$id("mrp").val(),s=this.$id("mrpLine").val(),a=this.model.isMrpLocked(r),n=this.model.isLineLocked(i);n&&(i=null),(n||e.lines[i])&&this.selectLine(i),a&&(r=null,s=null),(a||e.mrps[r])&&this.selectMrp(r,s),e.locked&&(this.cacheLines(),this.setUpLineSelect2(),this.setUpMrpSelect2()),t&&t.focus()}})});