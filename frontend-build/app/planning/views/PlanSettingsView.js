// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","Sortable","app/i18n","app/time","app/user","app/data/orgUnits","app/data/orderStatuses","app/core/views/FormView","app/mrpControllers/util/setUpMrpSelect2","app/orderStatuses/util/renderOrderStatusLabel","app/planning/templates/planSettings"],function(e,t,r,i,a,n,s,l,o,d,c,p){"use strict";function u(e,t,r){return e=e.toUpperCase(),r.id.toUpperCase().indexOf(e)>=0||r.text.toUpperCase().indexOf(e)>=0}return o.extend({template:p,events:e.extend({"change [data-object]":function(e){var t,r=e.currentTarget.dataset.object,i=e.currentTarget.name,a=this.model,n=a;"line"===r?n=n.lines.get(this.$id("line").val()):"plan"!==r&&(n=n.mrps.get(this.$id("mrp").val()),"mrpLine"===r&&(n=n.lines.get(this.$id("mrpLine").val())));var s=this.$id(i);switch(i){case"requiredStatuses":case"ignoredStatuses":case"hardComponents":case"orderPriority":t=s.val().split(",").filter(function(e){return e.length>0});break;case"ignoreCompleted":case"useRemainingQuantity":t=s.prop("checked");break;case"extraOrderSeconds":case"bigOrderQuantity":case"workerCount":t=Math.max(0,parseInt(s.val(),10)||0);break;case"extraShiftSeconds":t=[Math.max(0,parseInt(this.$id(i+"-1").val(),10)||0),Math.max(0,parseInt(this.$id(i+"-2").val(),10)||0),Math.max(0,parseInt(this.$id(i+"-3").val(),10)||0)];break;case"hardOrderManHours":t=Math.max(0,parseFloat(s.val())||0);break;case"activeFrom":case"activeTo":var l=s.val().split(":"),o=+l[0],d=+l[1];o>=0&&o<=24&&d>=0&&d<=59?(24===o&&(o=0),t=(o<10?"0":"")+o+":"+(d<10?"0":"")+d):t=""}void 0!==t&&(n.attributes[i]=t)},"change #-mrp":function(t){var r=t.added?t.added.id:null,i=e.result(this.$id("mrpLine").select2("data"),"id");i||(i=e.result(this.$id("line").select2("data"),"id"));var a=this.model.mrps.get(r);a?a.lines.get(i)||(i=e.result(a.lines.first(),"id")):i=e.result(this.model.lines.find(function(t){return e.includes(t.get("mrpPriority"),r)}),"id"),this.selectMrp(r,i||null)},"change #-mrpLine":function(e){var t=this.model.mrps.get(this.$id("mrp").val());this.selectMrpLine(t,e.added?e.added.id:null,!1)}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.sortables=[],this.stopListening(this.model,"change")},destroy:function(){this.destroySortables()},destroySortables:function(){for(var e=0,t=this.sortables.length;e<t;++e)this.sortables[e].destroy();this.sortables=[]},serialize:function(){return e.extend(o.prototype.serialize.call(this),{})},afterRender:function(){o.prototype.afterRender.call(this),this.setUpOrderStatusSelect2("requiredStatuses"),this.setUpOrderStatusSelect2("ignoredStatuses"),this.setUpHardComponentsSelect2(),this.setUpLine(),this.setUpMrpSelect2(),this.setUpMrpLineSelect2(),this.setUpOrderPrioritySelect2(),this.selectMrp(null)},setUpOrderStatusSelect2:function(t){this.$id(t).select2({allowClear:!0,multiple:!0,data:l.map(function(e){return{id:e.id,text:e.get("label")}}),matcher:u,formatSelection:function(e){return e.id},formatResult:function(t){return c(t.id)+" "+e.escape(t.text)}})},setUpHardComponentsSelect2:function(){this.$id("hardComponents").select2({placeholder:"12NC...",allowClear:!0,multiple:!0,data:[],formatNoMatches:null,minimumResultsForSearch:1,dropdownCssClass:"hidden",tokenizer:function(e,t,r){var i=e,a={};return t.forEach(function(e){a[e.id]=!0}),(e.match(/([0-9]{12}|[A-Z]{3}[A-Z0-9]{4})/gi)||[]).forEach(function(e){i=i.replace(e,""),e=e.toUpperCase(),a[e]||(r({id:e,text:e}),a[e]=!0)}),e===i?null:i.replace(/\s+/," ").trim()}})},setUpLine:function(){var a=this,n=a.$id("line"),l=a.$id("mrpPriority"),o=0,c=s.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(function(t){return t.id.length>o&&(o=t.id.length),{id:t.id,text:e.escape(t.get("description"))}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})});n.select2({placeholder:i("planning","settings:line:placeholder"),allowClear:!0,data:c,matcher:u,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var t=e.id;t.length<o;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text}}),d(l,{width:"100%",placeholder:i("planning","settings:mrpPriority:placeholder")});var p=l.select2("container").find(".select2-choices")[0];this.sortables.push(new r(p,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){l.select2("onSortStart")},onEnd:function(e){l.select2("onSortEnd").select2("focus"),a.saveMrpPriority(),a.selectMrp(t(e.target).data("select2-data").id,n.val()||null)}})),n.on("change",function(t){var r=!t.added,i="",n="";if(r)l.select2("enable",!1).select2("val",""),a.selectMrp(null,null);else{var s=t.added.id,o=a.model.lines.get(s);l.select2("enable",!0).select2("val",o?o.get("mrpPriority"):[]);var d=a.$id("mrp").select2("data");if(o&&o.get("mrpPriority").length){var c=o.get("mrpPriority");d=d&&e.includes(c,d.id)?d.id:c[0],i=o.get("activeFrom"),n=o.get("activeTo")}else d=null,s=null;a.selectMrp(d,s)}a.$id("activeFrom").val(i).prop("disabled",r),a.$id("activeTo").val(n).prop("disabled",r)}),l.on("change",function(e){a.saveMrpPriority(),e.added?a.selectMrp(e.added.id,n.val()||null):e.removed&&a.selectMrp(null)}),l.select2("enable",!1),a.$id("activeFrom").prop("disabled",!0),a.$id("activeTo").prop("disabled",!0)},setUpMrpSelect2:function(){var t=0,r={};this.model.lines.forEach(function(e){e.get("mrpPriority").forEach(function(e){r[e]=1,e.length>t&&(t=e.length)})}),this.$id("mrp").select2({placeholder:i("planning","settings:mrp:placeholder"),allowClear:!0,data:Object.keys(r).map(function(e){var t=s.getByTypeAndId("mrpController",e);return{id:e,text:t?t.get("description"):""}}),matcher:u,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var r=e.id;r.length<t;)r+=" ";return'<span class="text-mono">'+r.replace(/ /g,"&nbsp;")+"</span>: "+e.text}})},setUpMrpLineSelect2:function(){var t=this.$id("mrp").select2("data"),r=0,a={};this.model.lines.forEach(function(i){t&&e.includes(i.get("mrpPriority"),t.id)&&(a[i.id]=1,i.id.length>r&&(r=i.id.length))});var n=Object.keys(a).map(function(e){var t=s.getByTypeAndId("prodLine",e);return{id:e,text:t?t.get("description"):""}}),l=this.$id("mrpLine").select2({placeholder:i("planning","settings:mrpLine:placeholder"),allowClear:!0,data:n,matcher:u,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var t=e.id;t.length<r;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text}});l.select2("enable",n.length>0)},setUpOrderPrioritySelect2:function(){var e=this,t=e.$id("orderPriority").select2({allowClear:!0,multiple:!0,data:[{id:"small",text:i("planning","orderPriority:small")},{id:"easy",text:i("planning","orderPriority:easy")},{id:"hard",text:i("planning","orderPriority:hard")}]}),a=t.select2("container").find(".select2-choices")[0];e.sortables.push(new r(a,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){t.select2("onSortStart")},onEnd:function(){t.select2("onSortEnd").select2("focus"),e.saveOrderPriority()}})),t.on("change",function(){e.saveOrderPriority()})},selectMrp:function(e,t){var r=this;r.$id("mrp").select2("val",e||"");var i=r.model.mrps,a=i.get(e),n=!!r.$id("mrp").select2("data"),s=!n;n&&!a&&(a=i.add({_id:e,extraOrderSeconds:0,extraShiftSeconds:[0,0,0],bigOrderQuantity:0,hardOrderManHours:0,hardComponents:[],lines:[]}).get(e)),r.$id("extraOrderSeconds").val(s?"":a.get("extraOrderSeconds")).prop("disabled",s),(a?a.get("extraShiftSeconds"):[0,0,0]).forEach(function(e,t){r.$id("extraShiftSeconds-"+(t+1)).val(s?"":e).prop("disabled",s)}),r.$id("bigOrderQuantity").val(s?"":a.get("bigOrderQuantity")).prop("disabled",s),r.$id("hardOrderManHours").val(s?"":a.get("hardOrderManHours")).prop("disabled",s),r.$id("hardComponents").select2("data",s?[]:(a.get("hardComponents")||[]).map(function(e){return{id:e,text:e}})).select2("enable",n),r.setUpMrpLineSelect2(),r.selectMrpLine(a,t,s)},selectMrpLine:function(e,t,r){var i=this;i.$id("mrpLine").select2("val",t||"").select2("enable",!r);var a=e?e.lines.get(t):null;r=r||!i.$id("mrpLine").select2("data"),r||a||(a=e.lines.add({_id:t,workerCount:1,orderPriority:["small","easy","hard"]}).get(t)),i.$id("workerCount").val(r?"":a.get("workerCount")).prop("disabled",r),i.$id("orderPriority").select2("val",r?[]:a.get("orderPriority")).prop("disabled",r)},saveMrpPriority:function(){var e=this.$id("line").val(),t=this.$id("mrpPriority").val(),r=this.model.lines,i=r.get(e);t.length?i?i.set("mrpPriority",t.split(",")):r.add({_id:e,mrpPriority:t.split(","),activeFrom:"",activeTo:""}):i&&r.remove(i),this.setUpMrpSelect2()},saveOrderPriority:function(){var t=this.model.mrps.get(this.$id("mrp").val()),r=t.lines.get(this.$id("mrpLine").val());r.set("orderPriority",e.pluck(this.$id("orderPriority").select2("data"),"id"))},serializeToForm:function(){var e=this.model.toJSON();return e.requiredStatuses=e.requiredStatuses.join(","),e.ignoredStatuses=e.ignoredStatuses.join(","),e},serializeForm:function(){return{}},checkValidity:function(){return!0}})});