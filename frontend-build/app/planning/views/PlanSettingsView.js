// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","Sortable","app/i18n","app/time","app/user","app/data/orgUnits","app/data/orderStatuses","app/core/views/FormView","app/orderStatuses/util/renderOrderStatusLabel","app/planning/templates/planSettings"],function(e,t,i,r,n,a,s,l,o,d,c){"use strict";function p(e,t,i){return e=e.toUpperCase(),i.id.toUpperCase().indexOf(e)>=0||i.text.toUpperCase().indexOf(e)>=0}return o.extend({template:c,events:e.extend({"change [data-object]":function(t){var i,r=t.currentTarget.dataset.object,n=t.currentTarget.name,a=this.model.attributes;"plan"!==r&&(a=e.findWhere(a.mrps,{_id:this.$id("mrp").val()}),"line"===r&&(a=e.findWhere(a.lines,{_id:this.$id("line").val()})));var s=this.$id(n);switch(n){case"requiredStatuses":case"ignoredStatuses":case"hardComponents":case"orderPriority":i=s.val().split(",").filter(function(e){return e.length>0});break;case"ignoreCompleted":case"useRemainingQuantity":i=s.prop("checked");break;case"extraOrderSeconds":case"bigOrderQuantity":case"workerCount":i=Math.max(0,parseInt(s.val(),10)||0);break;case"extraShiftSeconds":i=[Math.max(0,parseInt(this.$id(n+"-1").val(),10)||0),Math.max(0,parseInt(this.$id(n+"-2").val(),10)||0),Math.max(0,parseInt(this.$id(n+"-3").val(),10)||0)];break;case"hardOrderManHours":i=Math.max(0,parseFloat(s.val())||0);break;case"activeFrom":case"activeTo":var l=s.val().split(":"),o=+l[0],d=+l[1];o>=0&&o<=24&&d>=0&&d<=59?(24===o&&(o=0),i=(o<10?"0":"")+o+":"+(d<10?"0":"")+d):i=""}void 0!==i&&(a[n]=i)},"change #-mrp":function(t){var i=t.added?t.added.id:null,r=e.result(this.$id("line").select2("data"),"id");r||(r=e.result(this.$id("linePriorities-line").select2("data"),"id"));var n=e.findWhere(this.model.get("mrps"),{_id:i});n?e.findWhere(n.lines,{_id:r})||(r=e.result(n.lines[0],"_id")):r=e.result(e.find(this.model.get("linePriorities"),function(e){return e.mrps.indexOf(i)>=0}),"line"),this.selectMrp(i,r||null)},"change #-line":function(t){var i=e.findWhere(this.model.get("mrps"),{_id:this.$id("mrp").val()});this.selectLine(i,t.added?t.added.id:null,!1)}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.sortables=[]},destroy:function(){this.destroySortables()},destroySortables:function(){for(var e=0,t=this.sortables.length;e<t;++e)this.sortables[e].destroy();this.sortables=[]},serialize:function(){return e.extend(o.prototype.serialize.call(this),{})},afterRender:function(){o.prototype.afterRender.call(this),this.setUpOrderStatusSelect2("requiredStatuses"),this.setUpOrderStatusSelect2("ignoredStatuses"),this.setUpHardComponentsSelect2(),this.setUpLinePriorities(),this.setUpMrpSelect2(),this.setUpLineSelect2(),this.setUpOrderPrioritySelect2(),this.selectMrp(null)},setUpOrderStatusSelect2:function(t){this.$id(t).select2({allowClear:!0,multiple:!0,data:l.map(function(e){return{id:e.id,text:e.get("label")}}),matcher:p,formatSelection:function(e){return e.id},formatResult:function(t){return d(t.id)+" "+e.escape(t.text)}})},setUpHardComponentsSelect2:function(){var e=this.$id("hardComponents").select2({placeholder:"12NC...",allowClear:!0,multiple:!0,data:[],formatNoMatches:null,minimumResultsForSearch:1,dropdownCssClass:"hidden",tokenizer:function(e,t,i){var r=e,n={};return t.forEach(function(e){n[e.id]=!0}),(e.match(/([0-9]{12}|[A-Z]{3}[A-Z0-9]{4})/gi)||[]).forEach(function(e){r=r.replace(e,""),e=e.toUpperCase(),n[e]||(i({id:e,text:e}),n[e]=!0)}),e===r?null:r.replace(/\s+/," ").trim()}});e.select2("data",e.val().split(",").filter(function(e){return!!e.length}).map(function(e){return{id:e,text:e}}))},setUpLinePriorities:function(){var n=this,a=n.$id("linePriorities-line"),l=n.$id("linePriorities-mrps"),o=0,d=0,c=s.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(function(t){return t.id.length>o&&(o=t.id.length),{id:t.id,text:e.escape(t.get("description"))}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})}),u=s.getAllByType("mrpController").filter(function(e){return e.id.indexOf("~")===-1}).map(function(t){return t.id.length>d&&(d=t.id.length),{id:t.id,text:e.escape(t.get("description"))}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})});a.select2({placeholder:r("planning","settings:linePriorities:line"),allowClear:!0,data:c,matcher:p,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var t=e.id;t.length<o;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text}}),l.select2({containerCss:{marginTop:"-1px"},placeholder:r("planning","settings:linePriorities:mrps"),allowClear:!0,multiple:!0,data:u,matcher:p,formatSelection:function(t){return e.escape(t.id)},formatResult:function(e){for(var t=e.id;t.length<d;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text},tokenizer:function(e,t,i){var r=e,n={};return t.forEach(function(e){n[e.id]=!0}),(e.match(/([A-Z]{2}[0-9]+)/gi)||[]).forEach(function(e){r=r.replace(e,""),e=e.toUpperCase(),n[e]||(i({id:e,text:e}),n[e]=!0)}),e===r?null:r.replace(/\s+/," ").trim()}});var h=l.select2("container").find(".select2-choices")[0];this.sortables.push(new i(h,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){l.select2("onSortStart")},onEnd:function(e){l.select2("onSortEnd").select2("focus"),n.saveLinePriority(),n.selectMrp(t(e.target).data("select2-data").id,a.val()||null)}})),a.on("change",function(t){var i=n.model.get("linePriorities");if(t.added){var r=t.added.id,a=e.findWhere(i,{line:r});l.select2("enable",!0).select2("val",a?a.mrps:[]);var s=n.$id("mrp").select2("data");a&&a.mrps.length?s=s&&a.mrps.indexOf(s.id)>=0?s.id:a.mrps[0]:(s=null,r=null),n.selectMrp(s,r)}else l.select2("enable",!1).select2("val",""),n.selectMrp(null,null)}),l.on("change",function(e){n.saveLinePriority(),e.added?n.selectMrp(e.added.id,a.val()||null):e.removed&&n.selectMrp(null)}),l.select2("enable",!1)},setUpMrpSelect2:function(){var t=0,i={};this.model.get("linePriorities").forEach(function(e){e.mrps.forEach(function(e){i[e]=1,e.length>t&&(t=e.length)})}),this.$id("mrp").select2({placeholder:r("planning","settings:mrp:placeholder"),allowClear:!0,data:Object.keys(i).map(function(e){var t=s.getByTypeAndId("mrpController",e);return{id:e,text:t?t.get("description"):""}}),matcher:p,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var i=e.id;i.length<t;)i+=" ";return'<span class="text-mono">'+i.replace(/ /g,"&nbsp;")+"</span>: "+e.text}})},setUpLineSelect2:function(){var t=this.$id("mrp").select2("data"),i=0,n={};this.model.get("linePriorities").forEach(function(e){t&&e.mrps.indexOf(t.id)>=0&&(n[e.line]=1,e.line.length>i&&(i=e.line.length))});var a=Object.keys(n).map(function(e){var t=s.getByTypeAndId("prodLine",e);return{id:e,text:t?t.get("description"):""}}),l=this.$id("line").select2({placeholder:r("planning","settings:line:placeholder"),allowClear:!0,data:a,matcher:p,formatSelection:function(t){return e.escape(t.id+": "+t.text)},formatResult:function(e){for(var t=e.id;t.length<i;)t+=" ";return'<span class="text-mono">'+t.replace(/ /g,"&nbsp;")+"</span>: "+e.text}});l.select2("enable",a.length>0)},setUpOrderPrioritySelect2:function(){var e=this,t=e.$id("orderPriority").select2({allowClear:!0,multiple:!0,data:[{id:"small",text:r("planning","orderPriority:small")},{id:"easy",text:r("planning","orderPriority:easy")},{id:"hard",text:r("planning","orderPriority:hard")}]}),n=t.select2("container").find(".select2-choices")[0];e.sortables.push(new i(n,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){t.select2("onSortStart")},onEnd:function(){t.select2("onSortEnd").select2("focus"),e.saveOrderPriority()}})),t.on("change",function(){e.saveOrderPriority()})},selectMrp:function(t,i){var r=this;r.$id("mrp").select2("val",t||"");var n=r.model.get("mrps"),a=e.findWhere(n,{_id:t}),s=!!r.$id("mrp").select2("data"),l=!s;a||(a={_id:t,extraOrderSeconds:0,extraShiftSeconds:[0,0,0],bigOrderQuantity:0,hardOrderManHours:0,lines:[]},s&&n.push(a)),r.$id("extraOrderSeconds").val(l?"":a.extraOrderSeconds).prop("disabled",l),a.extraShiftSeconds.forEach(function(e,t){r.$id("extraShiftSeconds-"+(t+1)).val(l?"":e).prop("disabled",l)}),r.$id("bigOrderQuantity").val(l?"":a.bigOrderQuantity).prop("disabled",l),r.$id("hardOrderManHours").val(l?"":a.hardOrderManHours).prop("disabled",l),r.setUpLineSelect2(),r.selectLine(a,i,l)},selectLine:function(t,i,r){var n=this;n.$id("line").select2("val",i||"").select2("enable",!r);var a=e.findWhere(t.lines,{_id:i});r=r||!n.$id("line").select2("data"),a||(a={_id:i,workerCount:1,activeFrom:"",activeTo:"",orderPriority:["small","easy","hard"]},r||t.lines.push(a)),n.$id("workerCount").val(r?"":a.workerCount).prop("disabled",r),n.$id("activeFrom").val(r?"":a.activeFrom).prop("disabled",r),n.$id("activeTo").val(r?"":a.activeTo).prop("disabled",r),n.$id("orderPriority").select2("val",r?[]:a.orderPriority).prop("disabled",r)},saveLinePriority:function(){var t=this.$id("linePriorities-line").val(),i=this.$id("linePriorities-mrps").val(),r=this.model.get("linePriorities"),n=e.findWhere(r,{line:t});i.length?n?n.mrps=i.split(","):r.push({line:t,mrps:i.split(",")}):n&&this.model.set("linePriorities",r.filter(function(e){return e.line!==t}),{silent:!0}),this.setUpMrpSelect2()},saveOrderPriority:function(){e.pluck(this.$id("orderPriority").select2("data"),"id")},serializeToForm:function(){var e=this.model.toJSON();return e.requiredStatuses=e.requiredStatuses.join(","),e.ignoredStatuses=e.ignoredStatuses.join(","),e.mrps=void 0,e},serializeForm:function(){return{}},checkValidity:function(){return!0}})});