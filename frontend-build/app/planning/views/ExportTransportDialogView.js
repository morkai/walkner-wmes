define(["underscore","app/i18n","app/time","app/viewport","app/core/View","app/core/util/idAndLabel","app/core/util/pageActions","app/core/util/forms/dateTimeRange","app/data/orgUnits","app/mrpControllers/util/setUpMrpSelect2","app/planning/templates/exportTransportDialog"],function(t,e,i,r,a,s,n,o,p,d,l){"use strict";return a.extend({template:l,events:{"click a[data-date-time-range]":o.handleRangeEvent,'change input[name="filter"]':function(){var t=this.$('input[name="filter"]:checked').val();this.$id("mrps").prev().toggleClass("hidden","lines"===t),this.$id("lines").prev().toggleClass("hidden","mrps"===t)},submit:function(){return this.submitForm(),!1}},getTemplateData:function(){return{mrps:this.model.displayOptions.get("mrps").join(",")}},afterRender:function(){var t=this.model.getMoment();this.$id("from-date").val(t.format("YYYY-MM-DD")),this.$id("to-date").val(t.add(1,"days").format("YYYY-MM-DD")),d(this.$id("mrps"),{width:"100%",placeholder:this.t("filter:mrps:placeholder"),view:this}),this.$id("lines").select2({width:"100%",placeholder:this.t("filter:lines:placeholder"),multiple:!0,allowClear:!0,data:p.getActiveByType("prodLine").map(s).sort(function(t,e){return t.text.localeCompare(e.text,void 0,{numeric:!0,ignorePunctuation:!0})})}).prev().addClass("hidden")},submitForm:function(){var t=this;t.$msg=r.msg.show({type:"info",text:t.t("MSG:export:started")}),t.$id("submit").prop("disabled",!0).find(".fa-spinner").removeClass("hidden");var e=t.$('input[name="filter"]:checked').val();t.ajax({url:"/planning/reports/transport",data:{from:t.$id("from-date").val(),to:t.$id("to-date").val(),mrps:"mrps"===e?t.$id("mrps").val():"",lines:"lines"===e?t.$id("lines").val():""},error:function(){r.msg.hide(t.$msg,!0),r.msg.show({type:"error",time:2500,text:t.t("MSG:export:failure")}),t.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")},success:function(e){r.msg.hide(t.$msg,!0),t.exportData(e.options,e.data)}})},exportData:function(t,e){var a=this,s={date:{type:"date+utc",caption:a.t("transport:date"),position:1},time:{type:"time+utc",caption:a.t("transport:time"),position:2},shiftNo:{type:"integer",width:7,caption:a.t("transport:shiftNo")},line:{type:"string",width:10,caption:a.t("transport:line")},mrp:{type:"string",width:5,caption:a.t("transport:mrp")},orderNo:{type:"string",width:10,caption:a.t("transport:orderNo")},salesOrderNo:{type:"string",width:10,caption:a.t("transport:salesOrderNo")},salesOrderItem:{type:"string",width:5,caption:a.t("transport:salesOrderItem")},quantity:{type:"integer",width:10,caption:a.t("transport:quantity")}};e.forEach(function(t){t.time=Date.parse(t.startAt),t.startAt=void 0,t.date=i.utc.getMoment(t.time),t.date.hours()<6&&t.date.subtract(1,"days"),t.date=t.date.startOf("day").valueOf()});var o={from:i.utc.format(t.fromTime,"YY.M.D"),to:i.utc.format(t.toTime,"YY.M.D")},p=a.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify({filename:a.t("transport:export:fileName",o),sheetName:a.t("transport:export:sheetName",o),freezeRows:1,columns:s,data:e})});p.fail(function(){r.msg.hide(a.$msg,!0),r.msg.show({type:"error",time:2500,text:a.t("MSG:export:failure")})}),p.done(function(t){r.msg.hide(a.$msg,!0),n.exportXlsx("/xlsxExporter/"+t)}),p.always(function(){a.$id("submit").prop("disabled",!1).find(".fa-spinner").addClass("hidden")})}})});