define(["underscore","./PlanOrder"],function(e,r){"use strict";var s={change:function(e,r){e.settings.set(r.property,r.newValue)},"lines:add":function(e,r,s){var n=r.line._id,i=e.settings.lines.add(r.line).get(n),t=e.lines.add({_id:i.id}).get(n);s.lines[n]=!0,i.get("mrpPriority").forEach(function(r){var n=e.mrps.get(r);n&&n.lines.add(t),s.mrps[r]=!0})},"lines:remove":function(e,r,s){var n=r.line._id,i=e.settings.lines.get(n);e.settings.lines.remove(n),e.lines.remove(n),s.lines[n]=!0,i&&i.get("mrpPriority").forEach(function(r){var i=e.mrps.get(r);i&&i.lines.remove(n),s.mrps[r]=!0})},"lines:change":function(e,r,s){var n=e.settings.lines.get(r.line);n&&("mrpPriority"===r.property&&n.get("mrpPriority").forEach(function(e){s.mrps[e]=!0}),n.set(r.property,r.newValue),n.get("mrpPriority").forEach(function(e){s.mrps[e]=!0}),s.lines[n.id]=!0)},"mrps:add":function(e,r,s){var n=e.settings.mrps.add(r.mrp).get(r.mrp._id);s.mrps[n.id]=!0,n.lines.forEach(function(e){s.lines[e.id]=!0})},"mrps:remove":function(e,r,s){var n=r.mrp._id,i=e.settings.mrps.get(n);e.settings.mrps.remove(n),e.mrps.remove(n),s.mrps[n]=!0,i&&i.lines.forEach(function(e){s.lines[e.id]=!0})},"mrps:change":function(e,r,s){var n=e.settings.mrps.get(r.mrp);n&&(n.set(r.property,r.newValue),s.mrps[n.id]=!0,n.lines.forEach(function(e){s.lines[e.id]=!0}),"locked"===r.property&&(s.locked=!0))},"mrpLines:add":function(e,r,s){var n=e.settings.mrps.get(r.mrp);n&&(n.lines.add(r.line),s.mrps[n.id]=!0,s.lines[r.line._id]=!0)},"mrpLines:remove":function(e,r,s){var n=r.mrp,i=r.line._id,t=e.settings.mrps.get(n);t&&t.lines.remove(i);var o=e.mrps.get(n);o&&o.lines.remove(i),s.mrps[n]=!0,s.lines[i]=!0},"mrpLines:change":function(e,r,s){var n=e.settings.mrps.get(r.mrp);if(n){var i=n.lines.get(r.line);i&&(i.set(r.property,r.newValue),s.mrps[n.id]=!0,s.lines[i.id]=!0)}}};return{settings:function(e,r){var n={reset:!1,lines:{},mrps:{},locked:!1};r.forEach(function(r){n.reset=n.reset||/add|remove/.test(r.type),s[r.type](e,r,n)}),n.lines.any=Object.keys(n.lines).length>0,n.mrps.any=Object.keys(n.mrps).length>0,n.locked&&(e.settings.lockedMrps=null,e.settings.lockedLines=null),e.settings.trigger("changed",n)},addedOrders:function(e,s){var n=[],i={};s.forEach(function(e){var s=new r(e);n.push(s),i[e.mrp]||(i[e.mrp]=[]),i[e.mrp].push(s)}),e.orders.add(n),e.orders.trigger("added",n),Object.keys(i).forEach(function(r){var s=e.mrps.get(r);s&&(s.orders.add(i[r]),s.orders.trigger("added",i[r]))})},removedOrders:function(e,r){var s=[],n={};r.forEach(function(r){var i=e.orders.get(r._id);if(i){s.push(i);var t=i.get("mrp");n[t]||(n[t]=[]),n[t].push(i)}}),Object.keys(n).forEach(function(r){var s=e.mrps.get(r);s&&(s.orders.remove(n[s.id]),s.orders.trigger("removed",n[s.id]))}),e.orders.remove(s),e.orders.trigger("removed",s)},changedOrders:function(e,r){var s=[],n={},i={};r.forEach(function(r){var t=e.orders.get(r._id);if(t){s.push(t);var o=e.mrps.get(t.get("mrp")),d=(r.changes.mrp?e.mrps.get(r.changes.mrp[1]):null)||o;o&&o.id!==d.id&&(i[o.id]||(i[o.id]=[]),i[o.id].push(t),o.orders.remove(t)),d&&(n[d.id]||(n[d.id]=[]),n[d.id].push(t));var g={};Object.keys(r.changes).forEach(function(e){g[e]=r.changes[e][1]}),t.set(g)}}),Object.keys(i).forEach(function(r){e.mrps.get(r).trigger("removed",i[r])}),e.orders.trigger("changed",s),Object.keys(n).forEach(function(r){e.mrps.get(r).orders.trigger("changed",n[r])})},changedLines:function(r,s){var n=[],i={};s.forEach(function(s){var t=r.lines.get(s._id);t&&t.get("hash")!==s.hash&&(t.set(e.omit(s,"orders")),s.orders&&t.orders.reset(s.orders),n.push(t),t.settings&&t.settings.get("mrpPriority").forEach(function(e){i[e]||(i[e]=[]),i[e].push(t)}))}),r.lines.trigger("changed",n),Object.keys(i).forEach(function(e){var s=r.mrps.get(e);s&&s.lines.trigger("changed",i[e])})}}});