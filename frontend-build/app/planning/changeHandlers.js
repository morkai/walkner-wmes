define(["underscore","./PlanOrder"],function(e,r){"use strict";var n={change:function(e,r){e.settings.set(r.property,r.newValue)},"lines:add":function(e,r,n){var s=r.line._id,i=e.settings.lines.add(r.line).get(s),t=e.lines.add({_id:i.id}).get(s);n.lines[s]=!0,i.get("mrpPriority").forEach(function(r){var s=e.mrps.get(r);s&&s.lines.add(t),n.mrps[r]=!0})},"lines:remove":function(e,r,n){var s=r.line._id,i=e.settings.lines.get(s);e.settings.lines.remove(s),e.lines.remove(s),n.lines[s]=!0,i&&i.get("mrpPriority").forEach(function(r){var i=e.mrps.get(r);i&&i.lines.remove(s),n.mrps[r]=!0})},"lines:change":function(e,r,n){var s=e.settings.lines.get(r.line);s&&("mrpPriority"===r.property&&s.get("mrpPriority").forEach(function(e){n.mrps[e]=!0}),s.set(r.property,r.newValue),s.get("mrpPriority").forEach(function(e){n.mrps[e]=!0}),n.lines[s.id]=!0)},"mrps:add":function(e,r,n){var s=e.settings.mrps.add(r.mrp).get(r.mrp._id);n.mrps[s.id]=!0,s.lines.forEach(function(e){n.lines[e.id]=!0})},"mrps:remove":function(e,r,n){var s=r.mrp._id,i=e.settings.mrps.get(s);e.settings.mrps.remove(s),e.mrps.remove(s),n.mrps[s]=!0,i&&i.lines.forEach(function(e){n.lines[e.id]=!0})},"mrps:change":function(e,r,n){var s=e.settings.mrps.get(r.mrp);s&&(s.set(r.property,r.newValue),n.mrps[s.id]=!0,s.lines.forEach(function(e){n.lines[e.id]=!0}),"locked"===r.property&&(n.locked=!0))},"mrpLines:add":function(e,r,n){var s=e.settings.mrps.get(r.mrp);s&&(s.lines.add(r.line),n.mrps[s.id]=!0,n.lines[r.line._id]=!0)},"mrpLines:remove":function(e,r,n){var s=r.mrp,i=r.line._id,t=e.settings.mrps.get(s);t&&t.lines.remove(i);var o=e.mrps.get(s);o&&o.lines.remove(i),n.mrps[s]=!0,n.lines[i]=!0},"mrpLines:change":function(e,r,n){var s=e.settings.mrps.get(r.mrp);if(s){var i=s.lines.get(r.line);i&&(i.set(r.property,r.newValue),n.mrps[s.id]=!0,n.lines[i.id]=!0)}}};return{settings:function(e,r){var s={reset:!1,lines:{},mrps:{},locked:!1};r.forEach(function(r){s.reset=s.reset||/add|remove/.test(r.type),n[r.type](e,r,s)}),s.lines.any=Object.keys(s.lines).length>0,s.mrps.any=Object.keys(s.mrps).length>0,s.locked&&(e.settings.lockedMrps=null,e.settings.lockedLines=null),e.settings.trigger("changed",s)},addedOrders:function(e,n){var s=[],i={};n.forEach(function(e){var n=new r(e);s.push(n),i[e.mrp]||(i[e.mrp]=[]),i[e.mrp].push(n)}),e.orders.add(s),e.orders.trigger("added",s),Object.keys(i).forEach(function(r){var n=e.mrps.get(r);n&&(n.orders.add(i[r]),n.orders.trigger("added",i[r]))})},removedOrders:function(e,r){var n=[],s={};r.forEach(function(r){var i=e.orders.get(r._id);if(i){n.push(i);var t=i.get("mrp");s[t]||(s[t]=[]),s[t].push(i)}}),Object.keys(s).forEach(function(r){var n=e.mrps.get(r);n&&(n.orders.remove(s[n.id]),n.orders.trigger("removed",s[n.id]))}),e.orders.remove(n),e.orders.trigger("removed",n)},changedOrders:function(e,r){var n=[],s={},i={};r.forEach(function(r){var t=e.orders.get(r._id);if(t){n.push(t);var o=e.mrps.get(t.get("mrp")),d=(r.changes.mrp?e.mrps.get(r.changes.mrp[1]):null)||o;o&&o.id!==d.id&&(i[o.id]||(i[o.id]=[]),i[o.id].push(t),o.orders.remove(t)),d&&(s[d.id]||(s[d.id]=[]),s[d.id].push(t));var a={};Object.keys(r.changes).forEach(function(e){a[e]=r.changes[e][1]}),t.set(a)}}),Object.keys(i).forEach(function(r){e.mrps.get(r).trigger("removed",i[r])}),e.orders.trigger("changed",n),Object.keys(s).forEach(function(r){e.mrps.get(r).orders.trigger("changed",s[r])})},changedLines:function(r,n){var s=[],i={};n.forEach(function(n){var t=r.lines.get(n._id);if(t&&t.get("hash")!==n.hash){var o=n;n.changes&&(o={},Object.keys(n.changes).forEach(function(e){o[e]=n.changes[e][1]})),t.set(e.omit(o,"orders")),n.orders&&t.orders.reset(n.orders),s.push(t),t.settings&&t.settings.get("mrpPriority").forEach(function(e){i[e]||(i[e]=[]),i[e].push(t)})}}),r.lines.trigger("changed",s),Object.keys(i).forEach(function(e){var n=r.mrps.get(e);n&&n.lines.trigger("changed",i[e])})}}});