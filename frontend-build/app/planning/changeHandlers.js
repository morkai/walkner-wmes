// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","./PlanOrder"],function(e,r){"use strict";var n={change:function(e,r){e.settings.set(r.property,r.newValue)},"lines:add":function(e,r,n){var i=r.line._id,s=e.settings.lines.add(r.line).get(i),t=e.lines.add({_id:s.id}).get(i);n.lines[i]=!0,s.get("mrpPriority").forEach(function(r){var i=e.mrps.get(r);i&&i.lines.add(t),n.mrps[r]=!0})},"lines:remove":function(e,r,n){var i=r.line._id,s=e.settings.lines.get(i),t=e.lines.get(i);s&&(e.settings.lines.remove(s),n.lines[i]=!0,s.get("mrpPriority").forEach(function(r){t&&e.mrps.get(r).lines.remove(t),n.mrps[r]=!0}))},"lines:change":function(e,r,n){var i=e.settings.lines.get(r.line);i&&("mrpPriority"===r.property&&i.get("mrpPriority").forEach(function(e){n.mrps[e]=!0}),i.set(r.property,r.newValue),i.get("mrpPriority").forEach(function(e){n.mrps[e]=!0}),n.lines[i.id]=!0)},"mrps:add":function(e,r,n){var i=e.settings.mrps.add(r.mrp).get(r.mrp._id);n.mrps[i.id]=!0,i.lines.forEach(function(e){n.lines[e.id]=!0})},"mrps:remove":function(e,r,n){var i=r.mrp._id,s=e.settings.mrps.get(i);s&&(e.settings.mrps.remove(s),n.mrps[i]=!0,s.lines.forEach(function(e){n.lines[e.id]=!0}))},"mrps:change":function(e,r,n){var i=e.settings.mrps.get(r.mrp);i&&(i.set(r.property,r.newValue),n.mrps[i.id]=!0,i.lines.forEach(function(e){n.lines[e.id]=!0}))},"mrpLines:add":function(e,r,n){var i=e.settings.mrps.get(r.mrp);i&&(i.lines.add(r.line),n.mrps[i.id]=!0,n.lines[r.line._id]=!0)},"mrpLines:remove":function(e,r,n){var i=e.settings.mrps.get(r.mrp);i&&(i.lines.remove(r.line._id),n.mrps[i.id]=!0,n.lines[r.line._id]=!0)},"mrpLines:change":function(e,r,n){var i=e.settings.mrps.get(r.mrp);if(i){var s=i.lines.get(r.line);s&&(s.set(r.property,r.newValue),n.mrps[i.id]=!0,n.lines[s.id]=!0)}}},i={settings:function(e,r){var i={reset:!1,lines:{},mrps:{}};r.forEach(function(r){i.reset=i.reset||/add|remove/.test(r.type),n[r.type](e,r,i)}),i.lines.any=Object.keys(i.lines).length>0,i.mrps.any=Object.keys(i.mrps).length>0,e.settings.trigger("changed",i)},addedOrders:function(e,n){var i=[],s={};n.forEach(function(e){var n=new r(e);i.push(n),s[e.mrp]||(s[e.mrp]=[]),s[e.mrp].push(n)}),e.orders.add(i),e.orders.trigger("added",i),Object.keys(s).forEach(function(r){var n=e.mrps.get(r);n&&(n.orders.add(s[r]),n.orders.trigger("added",s[r]))})},removedOrders:function(e,r){var n=[],i={};r.forEach(function(r){var s=e.orders.get(r._id);if(s){n.push(s);var t=s.get("mrp");i[t]||(i[t]=[]),i[t].push(s)}}),Object.keys(i).forEach(function(r){var n=e.mrps.get(r);n&&(n.orders.remove(i[n.id]),n.orders.trigger("removed",i[n.id]))}),e.orders.remove(n),e.orders.trigger("removed",n)},changedOrders:function(e,r){var n=[],i={},s={};r.forEach(function(r){var t=e.orders.get(r._id);if(t){n.push(t);var o=e.mrps.get(t.get("mrp")),d=(r.changes.mrp?e.mrps.get(r.changes.mrp[1]):null)||o;o&&o.id!==d.id&&(s[o.id]||(s[o.id]=[]),s[o.id].push(t),o.orders.remove(t)),d&&(i[d.id]||(i[d.id]=[]),i[d.id].push(t));var g={};Object.keys(r.changes).forEach(function(e){g[e]=r.changes[e][1]}),t.set(g)}}),Object.keys(s).forEach(function(r){e.mrps.get(r).trigger("removed",s[r])}),e.orders.trigger("changed",n),Object.keys(i).forEach(function(r){e.mrps.get(r).orders.trigger("changed",i[r])})},changedLines:function(r,n){var i=[],s={};n.forEach(function(n){var t=r.lines.get(n._id);!t||t.get("version")>=n.version||(t.set(e.omit(n,"orders")),n.orders&&t.orders.reset(n.orders),i.push(t),t.settings&&t.settings.get("mrpPriority").forEach(function(e){s[e]||(s[e]=[]),s[e].push(t)}))}),r.lines.trigger("changed",i),Object.keys(s).forEach(function(e){var n=r.mrps.get(e);n&&n.lines.trigger("changed",s[e])})}};return i});