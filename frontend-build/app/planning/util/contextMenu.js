// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/planning/templates/contextMenu"],function(n,e){"use strict";return{hide:function(e){var t=e.$contextMenu;t&&(n(window).off(".contextMenu."+e.idPrefix),n(document.body).off(".contextMenu."+e.idPrefix),t.fadeOut("fast",function(){t.remove()}),t.data("backdrop").remove(),t.removeData("backdrop"),e.$contextMenu=null,e.broker.publish("planning.contextMenu.hidden"))},show:function(t,o,i,d){var c=this.hide.bind(this,t);c();var u=n(e({top:o,menu:d.map(function(n){return"-"===n?{type:"divider"}:"string"==typeof n?{type:"header",label:n}:n})}));u.on("mousedown",function(n){return 1===n.which&&void n.stopPropagation()}),u.on("mouseup",function(n){if(1!==n.which)return!1}),u.on("contextmenu",!1),u.on("click","a[data-action]",function(n){var e=d[n.currentTarget.dataset.action];c(),e&&e.handler&&e.handler()});var r=n("<div></div>").css({position:"fixed",top:0,left:0,right:0,bottom:0}).one("mousedown",function(n){c(),document.elementFromPoint(n.clientX,n.clientY).click()});u.data("backdrop",r),n(window).one("scroll.contextMenu."+t.idPrefix,c),n(document.body).one("mousedown.contextMenu."+t.idPrefix,c).append(r).append(u),i+u.outerWidth()>=document.body.clientWidth&&(i-=i+u.outerWidth()-document.body.clientWidth+5),u.css("left",i+"px"),t.$contextMenu=u,t.broker.publish("planning.contextMenu.shown")}}});