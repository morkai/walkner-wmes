// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/broker","app/planning/templates/contextMenu"],function(n,e,t,o){"use strict";return{hide:function(e){var o=e.$contextMenu;o&&(n(window).off(".contextMenu."+e.idPrefix),n(document.body).off(".contextMenu."+e.idPrefix),o.fadeOut("fast",function(){o.remove()}),o.data("backdrop").remove(),o.removeData("backdrop"),e.$contextMenu=null,t.publish("planning.contextMenu.hidden"))},show:function(e,i,r,d){var a=this.hide.bind(this,e);a();var c=n(o({top:i,menu:d.map(function(n){return"-"===n?{type:"divider"}:"string"==typeof n?{type:"header",label:n}:n})}));c.on("mousedown",function(n){return 1===n.which&&void n.stopPropagation()}),c.on("mouseup",function(n){if(1!==n.which)return!1}),c.on("contextmenu",!1),c.on("click","a[data-action]",function(n){var e=d[n.currentTarget.dataset.action];a(),e&&e.handler&&e.handler()});var u=n("<div></div>").css({position:"fixed",top:0,left:0,right:0,bottom:0}).one("mousedown",a);c.data("backdrop",u),n(window).one("scroll.contextMenu."+e.idPrefix,a).one("resize.contextMenu."+e.idPrefix,a),n(document.body).one("mousedown.contextMenu."+e.idPrefix,a).append(u).append(c);var p=c.outerWidth(),s=c.outerHeight();r+p>=document.body.clientWidth&&(r-=r+p-document.body.clientWidth+5);var f=window.innerHeight+window.pageYOffset;i+s>=f&&(i-=i+s-f+5),c.css({top:i+"px",left:r+"px"}),e.$contextMenu=c,t.publish("planning.contextMenu.shown")},actions:{sapOrder:function(n){return{label:e.bound("planning","orders:menu:sapOrder"),handler:function(){window.open("/#orders/"+n)}}},comment:function(n){return{label:e("planning","orders:menu:comment"),handler:function(){var e=Math.min(window.screen.availWidth-200,1400),t=Math.min(window.screen.availHeight-160,800),o=window.screen.availWidth-e-80,i=window.open("/?hd=0#orders/"+n,"WMES_PLANNING_COMMENT","top=80,left="+o+",width="+e+",height="+t);i.onPageShown=function(){i.focus(),i.document.querySelector('textarea[name="comment"]').focus(),setTimeout(function(){i.scrollTo(0,i.document.body.scrollHeight)},1)}}}}}}});