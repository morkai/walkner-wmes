define(["underscore","jquery","app/i18n","app/broker","app/core/util/scrollbarSize","app/orders/util/commentPopover","app/planning/templates/contextMenu","i18n!app/nls/planning"],function(n,e,t,o,i,a,r){"use strict";function c(n){var t=e(n.currentTarget).closest(".planning-menu").find("[tabindex]:not(.planning-menu-disabled)").toArray(),o=t.indexOf(n.currentTarget)-1;return-1===o&&(o=t.length-1),t[o].focus(),!1}function u(n){var t=e(n.currentTarget).closest(".planning-menu").find("[tabindex]:not(.planning-menu-disabled)").toArray(),o=t.indexOf(n.currentTarget)+1;return o>=t.length&&(o=0),t[o].focus(),!1}return{isVisible:function(n){return!!n.$contextMenu},hide:function(n,t){var i=n.$contextMenu;if(i){e(document.body).click(),o.publish("planning.contextMenu.hiding",{$menu:i});var a=i.data("options");e(window).off(".contextMenu."+n.idPrefix),e(document.body).off(".contextMenu."+n.idPrefix),i.data("backdrop").remove(),i.removeData("backdrop"),i.removeData("options"),!1===a.animate||!1===t?i.remove():i.fadeOut("fast",function(){i.remove()}),n.$contextMenu=null,o.publish("planning.contextMenu.hidden")}},show:function(t,i,a,d){var s,l=this.hide.bind(this,t),f=this.show.bind(this,t,i,a,d);s=d.menu?d.menu:(d={menu:d}).menu,l(!1),s=(s=s.map(function(n){return"-"===n?{type:"divider"}:"string"==typeof n?{type:"header",label:n}:(n.type||(n.type="item"),n)}).filter(function(n){return!1!==n.visible})).filter(function(n,e){var t=s[e+1];return"header"!==n.type||"header"===n.type&&t&&"item"===t.type});var p=e(r({className:d.className||"",top:i,icons:n.some(s,function(n){return!!n.icon}),menu:s}));p.on("mousedown",function(n){if(1!==n.which)return!1;n.stopPropagation()}),p.on("mouseup",function(n){if(1!==n.which)return!1}),p.on("contextmenu",!1),p.on("click","a[data-action]",function(n){var e=n.currentTarget;if(!e.classList.contains("planning-menu-disabled")&&!e.classList.contains("planning-menu-loading")){var o=e.dataset.action,i=s[o];p.find("a").addClass("planning-menu-loading"),n.contextMenu={hide:!0,action:o,item:i,view:t,top:d.top,left:d.left,menu:s,restore:f},i&&i.handler&&i.handler(n),n.contextMenu.hide?l():p.find(e).find(".fa").attr("class","fa fa-spinner fa-spin")}}),p.on("keydown","[tabindex]",function(n){var t=n.currentTarget.tagName,o="SELECT"===t||"TEXTAREA"===t||"INPUT"===t,i="SELECT"!==t&&"TEXTAREA"!==t,a=i&&"INPUT"!==t;switch(n.originalEvent.key){case"ArrowUp":return i?c(n):void 0;case"ArrowDown":return i?u(n):void 0;case"Tab":return n.shiftKey?c(n):u(n);case" ":case"Enter":if(a){var r=new e.Event("click");return r.pageY=d.top,r.pageX=d.left,e(n.currentTarget).trigger(r),!1}break;case"Delete":case"Backspace":if(!o)return l(),!1;break;case"Escape":return l(),!1}});var m=e('<div class="planning-menu-backdrop"></div>').one("mousedown",l);p.data("backdrop",m),p.data("options",d),e(window).one("scroll.contextMenu."+t.idPrefix,l).one("resize.contextMenu."+t.idPrefix,l),e(document.body).one("mousedown.contextMenu."+t.idPrefix,function(n){d.hideFilter&&!d.hideFilter(n)||l()}).append(m).append(p),t.$contextMenu=p,this.position(t,i,a),s.forEach(function(n,e){n.template&&n.handler&&n.handler(p.find('li[data-action="'+e+'"]'))}),!1!==d.autoFocus&&(p.find("[autofocus]").length?p.find("[autofocus]").first().focus().select():p.find("[tabindex]:not(.planning-menu-disabled)").first().focus()),o.publish("planning.contextMenu.shown",{$menu:p})},position:function(e,t,o){if(e.$contextMenu){var i=e.$contextMenu;!function e(a){var r=i.outerWidth();var c=i.outerHeight();o+r>=document.body.clientWidth&&(o-=o+r-document.body.clientWidth+5);var u=window.innerHeight+window.pageYOffset;t+c>=u&&(t-=t+c-u+5);i.css({top:t+"px",left:o+"px"});n.assign(i.data("options"),{top:t,left:o});!a&&i[0].scrollHeight>i[0].offsetHeight&&e(!0)}(!1)}},actions:{sapOrder:function(n){return{icon:"fa-file-o",label:t.bound("planning","orders:menu:sapOrder"),handler:function(){window.open("/#orders/"+n)}}},comment:function(n){return{icon:"fa-comment-o",label:t("planning","orders:menu:comment"),handler:function(){var e=Math.min(window.screen.availWidth-200,1400),t=Math.min(window.screen.availHeight-160,800),o=window.screen.availWidth-e-80,i=window.open("/#orders/"+n,"WMES_ORDER_DETAILS","top=80,left="+o+",width="+e+",height="+t);i&&(i.onPageShown=function(){if(i){i.focus();var n=i.document.querySelector('textarea[name="comment"]');n&&n.focus(),setTimeout(function(){i.scrollTo(0,i.document.body.scrollHeight)},1)}})}}},commentPopover:function(n,e){return{icon:"fa-comment-o",label:t("planning","orders:menu:comment"),handler:function(t){a.show(t.contextMenu.view,n,t.contextMenu.top,t.contextMenu.left,{source:e||"other"})}}}}}});