// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/planning/templates/contextMenu"],function(n,e,t){"use strict";return{hide:function(e){var t=e.$contextMenu;t&&(n(window).off(".contextMenu."+e.idPrefix),n(document.body).off(".contextMenu."+e.idPrefix),t.fadeOut("fast",function(){t.remove()}),t.data("backdrop").remove(),t.removeData("backdrop"),e.$contextMenu=null,e.broker.publish("planning.contextMenu.hidden"))},show:function(e,o,i,r){var d=this.hide.bind(this,e);d();var a=n(t({top:o,menu:r.map(function(n){return"-"===n?{type:"divider"}:"string"==typeof n?{type:"header",label:n}:n})}));a.on("mousedown",function(n){return 1===n.which&&void n.stopPropagation()}),a.on("mouseup",function(n){if(1!==n.which)return!1}),a.on("contextmenu",!1),a.on("click","a[data-action]",function(n){var e=r[n.currentTarget.dataset.action];d(),e&&e.handler&&e.handler()});var c=n("<div></div>").css({position:"fixed",top:0,left:0,right:0,bottom:0}).one("mousedown",d);a.data("backdrop",c),n(window).one("scroll.contextMenu."+e.idPrefix,d),n(document.body).one("mousedown.contextMenu."+e.idPrefix,d).append(c).append(a);var u=a.outerWidth(),s=a.outerHeight();i+u>=document.body.clientWidth&&(i-=i+u-document.body.clientWidth+5);var p=window.innerHeight+window.pageYOffset;o+s>=p&&(o-=o+s-p+5),a.css({top:o+"px",left:i+"px"}),e.$contextMenu=a,e.broker.publish("planning.contextMenu.shown")},actions:{sapOrder:function(n){return{label:e.bound("planning","orders:menu:sapOrder"),handler:function(){window.open("/#orders/"+n)}}},comment:function(n){return{label:e("planning","orders:menu:comment"),handler:function(){var e=Math.min(window.screen.availWidth-200,1400),t=Math.min(window.screen.availHeight-160,800),o=window.screen.availWidth-e-80,i=window.open("/?hd=0#orders/"+n,"WMES_PLANNING_COMMENT","top=80,left="+o+",width="+e+",height="+t);i.onPageShown=function(){i.focus(),i.document.querySelector('textarea[name="comment"]').focus(),setTimeout(function(){i.scrollTo(0,i.document.body.scrollHeight)},1)}}}}}}});