// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/broker","app/planning/templates/contextMenu"],function(n,e,o,t,i){"use strict";return{hide:function(n){var o=n.$contextMenu;o&&(e(window).off(".contextMenu."+n.idPrefix),e(document.body).off(".contextMenu."+n.idPrefix),o.fadeOut("fast",function(){o.remove()}),o.data("backdrop").remove(),o.removeData("backdrop"),n.$contextMenu=null,t.publish("planning.contextMenu.hidden"))},show:function(o,r,d,a){var c=this.hide.bind(this,o);c();var u=e(i({top:r,icons:n.some(a,function(n){return!!n.icon}),menu:a.map(function(n){return"-"===n?{type:"divider"}:"string"==typeof n?{type:"header",label:n}:n})}));u.on("mousedown",function(n){if(1!==n.which)return!1;n.stopPropagation()}),u.on("mouseup",function(n){if(1!==n.which)return!1}),u.on("contextmenu",!1),u.on("click","a[data-action]",function(n){var e=a[n.currentTarget.dataset.action];c(),e&&e.handler&&e.handler()});var s=e("<div></div>").css({position:"fixed",top:0,left:0,right:0,bottom:0}).one("mousedown",c);u.data("backdrop",s),e(window).one("scroll.contextMenu."+o.idPrefix,c).one("resize.contextMenu."+o.idPrefix,c),e(document.body).one("mousedown.contextMenu."+o.idPrefix,c).append(s).append(u);var f=u.outerWidth(),p=u.outerHeight();d+f>=document.body.clientWidth&&(d-=d+f-document.body.clientWidth+5);var l=window.innerHeight+window.pageYOffset;r+p>=l&&(r-=r+p-l+5),u.css({top:r+"px",left:d+"px"}),o.$contextMenu=u,t.publish("planning.contextMenu.shown")},actions:{sapOrder:function(n){return{icon:"fa-file-o",label:o.bound("planning","orders:menu:sapOrder"),handler:function(){window.open("/#orders/"+n)}}},comment:function(n){return{icon:"fa-comment-o",label:o("planning","orders:menu:comment"),handler:function(){var e=Math.min(window.screen.availWidth-200,1400),o=Math.min(window.screen.availHeight-160,800),t=window.screen.availWidth-e-80,i=window.open("/?hd=0#orders/"+n,"WMES_PLANNING_COMMENT","top=80,left="+t+",width="+e+",height="+o);i.onPageShown=function(){i.focus(),i.document.querySelector('textarea[name="comment"]').focus(),setTimeout(function(){i.scrollTo(0,i.document.body.scrollHeight)},1)}}}}}}});