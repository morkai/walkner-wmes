// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["../broker","../pubsub","../socket","../viewport","../time","./views/RestartMessageView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,r,s,o,a){"use strict";function u(){w.versions.time=Date.now(),localStorage.setItem(f,JSON.stringify(w.versions))}function d(){v||(v=!0,R&&(null!==m&&m.remove(),m=new s({template:o,type:"backend"}),i.insertView(m).render(),m.$el.slideDown()),e.subscribe("socket.connected").setLimit(1).on("message",function(){v=!1,null!==m&&m.$el.slideUp(function(){"backend"===m.options.type&&(m.remove(),m=null)}),e.publish("updater.backendRestarted")}),e.publish("updater.backendRestarting"))}function l(){g||(g=!0,window.addEventListener("mousemove",p),window.addEventListener("keypress",p),R&&(null!==m&&m.remove(),m=new s({template:a,type:"frontend"}),i.insertView(m).render(),m.$el.slideDown()),e.publish("updater.frontendRestarting"),p())}function p(){clearTimeout(b),b=setTimeout(c,6e4)}function c(){t.isConnected()&&(k=!0,e.publish("updater.frontendReloading"),window.location.reload())}var f="VERSIONS",w={},b=null,m=null,v=!1,g=!1,k=!1,R=!0,V=window[f],S=JSON.parse(localStorage.getItem(f)||"null");return delete window[f],w.versions=S&&S.time>r.appData?S:V,w.isRestarting=function(){return v||g},w.isBackendRestarting=function(){return v},w.isFrontendRestarting=function(){return g},w.isFrontendReloading=function(){return k},w.enableViews=function(){R=!0},w.disableViews=function(){R=!1},w.pull=function(e){t.emit("updater.pull",e)},w.getCurrentVersionString=function(){return w.versions["package"]},u(),t.on("updater.versions",function(e){var n=w.versions;w.versions=e,u(),e.frontend!==n.frontend&&l()}),n.subscribe("updater.newVersion",function(n){e.publish("updater.newVersion",n),"backend"===n.service?d():"frontend"===n.service&&l()}),window.updater=w,w});