// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../broker","../pubsub","../socket","../viewport","../time","../data/localStorage","./views/RestartMessageView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,r,o,s,a,d,u){"use strict";function l(){g.versions.time=Date.now(),s.setItem(m,JSON.stringify(g.versions))}function c(){V||(V=!0,D&&(null!==k&&k.remove(),k=new a({template:d,type:"backend"}),r.insertView(k).render(),k.$el.slideDown()),n.subscribe("socket.connected").setLimit(1).on("message",function(){if(V=!1,k){var e=k;e.$el.slideUp(function(){k===e&&(k.remove(),k=null)}),n.publish("updater.backendRestarted")}}),n.publish("updater.backendRestarting"))}function p(){E||V||(E=!0,window.addEventListener("mousemove",w),window.addEventListener("keypress",w),D&&(k&&k.cancelAnimations(!0,!0),k&&k.remove(),k=new a({template:u,type:"frontend"}),r.insertView(k).render(),k.$el.slideDown()),n.publish("updater.frontendRestarting"),w())}function w(){clearTimeout(R),R=setTimeout(f,6e4)}function f(){i.isConnected()&&(S=!0,n.publish("updater.frontendReloading"),window.location.reload())}var m="VERSIONS",v="BACKEND_SERVICE",b="FRONTEND_SERVICE",g={},R=null,k=null,V=!1,E=!1,S=!1,D=!0,N=window[v]||"backend",h=window[b]||"frontend",C=window[m],I=JSON.parse(s.getItem(m)||"null");return delete window[m],delete window[b],delete window[v],g.versions=I&&I.time>o.appData?I:C,g.isRestarting=function(){return V||E},g.isBackendRestarting=function(){return V},g.isFrontendRestarting=function(){return E},g.isFrontendReloading=function(){return S},g.enableViews=function(){D=!0},g.disableViews=function(){D=!1},g.pull=function(e){i.emit("updater.pull",e)},g.getCurrentVersionString=function(){return g.versions.package},l(),i.on("updater.versions",function(n){var t=g.versions;g.versions=n,e.isEqual(e.omit(n,"time"),e.omit(t,"time"))||l(),n.frontend!==t.frontend&&p()}),t.subscribe("updater.newVersion",function(e){n.publish("updater.newVersion",e),e.service===N?c():e.service===h&&p()}),window.updater=g,g});