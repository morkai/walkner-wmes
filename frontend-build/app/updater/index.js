define(["underscore","../broker","../pubsub","../socket","../viewport","../time","../i18n","../data/localStorage","./views/RestartMessageView","./views/BrowserUpdateDialogView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,r,o,s,a,d,u,w,l){"use strict";var p="VERSIONS",c={},f=null,m=null,g=!1,v=!1,b=!1,R=!0,E=window.BACKEND_SERVICE||"backend",V=window.FRONTEND_SERVICE||"frontend",S=window[p],k=JSON.parse(a.getItem(p)||"null");function D(){c.versions.time=Date.now(),a.setItem(p,JSON.stringify(c.versions))}function h(){v||g||(v=!0,window.addEventListener("mousemove",C),window.addEventListener("keypress",C),R&&(m&&m.cancelAnimations(!0,!0),m&&m.remove(),m=new d({template:l,type:"frontend"}),r.insertView(m).render(),m.$el.slideDown()),n.publish("updater.frontendRestarting"),C())}function C(){clearTimeout(f),f=setTimeout(I,e.random(6e4,12e4))}function I(){i.isConnected()&&(b=!0,n.publish("updater.frontendReloading"),window.location.reload())}return delete window[p],delete window.FRONTEND_SERVICE,delete window.BACKEND_SERVICE,c.versions=k&&k.time>o.appData?k:S,c.isRestarting=function(){return g||v},c.isBackendRestarting=function(){return g},c.isFrontendRestarting=function(){return v},c.isFrontendReloading=function(){return b},c.enableViews=function(){R=!0},c.disableViews=function(){R=!1},c.pull=function(e){i.emit("updater.pull",e)},c.getCurrentVersionString=function(){return c.versions.package},D(),i.on("updater.versions",function(n){var t=c.versions;c.versions=n,e.isEqual(e.omit(n,"time"),e.omit(t,"time"))||D(),n.frontend!==t.frontend&&h()}),t.subscribe("updater.newVersion",function(e){n.publish("updater.newVersion",e),e.service===E?function(){if(g)return;g=!0,R&&(null!==m&&m.remove(),m=new d({template:w,type:"backend"}),r.insertView(m).render(),m.$el.slideDown());n.subscribe("socket.connected").setLimit(1).on("message",function(){if(g=!1,m){var e=m;e.$el.slideUp(function(){m===e&&(m.remove(),m=null)}),n.publish("updater.backendRestarted")}}),n.publish("updater.backendRestarting")}():e.service===V&&h()}),n.subscribe("viewport.page.shown",function(e){if("dashboard"===e.pageId&&-1!==window.navigator.vendor.toLowerCase().indexOf("google")&&"1"!==window.sessionStorage.getItem("WMES_BROWSER_UPDATE")){var n=window.navigator.userAgent.match(/Chrome\/([0-9]+)/);if(n)+n[1]>=70||r.showDialog(new u,s("updater","browserUpdate:title"))}}),window.updater=c,c});