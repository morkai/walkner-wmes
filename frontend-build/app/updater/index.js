// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../broker","../pubsub","../socket","../viewport","../time","./views/RestartMessageView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,r,o,s,a){"use strict";function u(){m.versions.time=Date.now(),localStorage.setItem(w,JSON.stringify(m.versions))}function d(){R||(R=!0,E&&(null!==g&&g.remove(),g=new o({template:s,type:"backend"}),i.insertView(g).render(),g.$el.slideDown()),e.subscribe("socket.connected").setLimit(1).on("message",function(){R=!1,null!==g&&g.$el.slideUp(function(){"backend"===g.options.type&&(g.remove(),g=null)}),e.publish("updater.backendRestarted")}),e.publish("updater.backendRestarting"))}function l(){k||(k=!0,window.addEventListener("mousemove",p),window.addEventListener("keypress",p),E&&(null!==g&&g.remove(),g=new o({template:a,type:"frontend"}),i.insertView(g).render(),g.$el.slideDown()),e.publish("updater.frontendRestarting"),p())}function p(){clearTimeout(v),v=setTimeout(c,6e4)}function c(){t.isConnected()&&(V=!0,e.publish("updater.frontendReloading"),window.location.reload())}var w="VERSIONS",f="BACKEND_SERVICE",b="FRONTEND_SERVICE",m={},v=null,g=null,R=!1,k=!1,V=!1,E=!0,S=window[f]||"backend",D=window[b]||"frontend",N=window[w],h=JSON.parse(localStorage.getItem(w)||"null");return delete window[w],delete window[b],delete window[f],m.versions=h&&h.time>r.appData?h:N,m.isRestarting=function(){return R||k},m.isBackendRestarting=function(){return R},m.isFrontendRestarting=function(){return k},m.isFrontendReloading=function(){return V},m.enableViews=function(){E=!0},m.disableViews=function(){E=!1},m.pull=function(e){t.emit("updater.pull",e)},m.getCurrentVersionString=function(){return m.versions["package"]},u(),t.on("updater.versions",function(e){var n=m.versions;m.versions=e,u(),e.frontend!==n.frontend&&l()}),n.subscribe("updater.newVersion",function(n){e.publish("updater.newVersion",n),n.service===S?d():n.service===D&&l()}),window.updater=m,m});