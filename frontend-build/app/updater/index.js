define(["underscore","../broker","../pubsub","../socket","../viewport","../time","../i18n","../data/localStorage","./views/RestartMessageView","./views/BrowserUpdateDialogView","./views/AddressUpdateDialogView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,r,o,s,a,d,u,w,l,p){"use strict";var c=70,f="VERSIONS",m={},g=null,v=null,b=!1,E=!1,R=!1,S=!0,D=window.BACKEND_SERVICE||"backend",V=window.FRONTEND_SERVICE||"frontend",h=window[f],k=JSON.parse(a.getItem(f)||"null");function I(){m.versions.time=Date.now(),a.setItem(f,JSON.stringify(m.versions))}function C(){E||b||(E=!0,window.addEventListener("mousemove",N),window.addEventListener("keypress",N),S&&(v&&v.cancelAnimations(!0,!0),v&&v.remove(),v=new d({template:p,type:"frontend"}),r.insertView(v).render(),v.$el.slideDown()),n.publish("updater.frontendRestarting"),N())}function N(){clearTimeout(g),g=setTimeout(A,e.random(6e4,12e4))}function A(){i.isConnected()&&(R=!0,n.publish("updater.frontendReloading"),window.location.reload())}return delete window[f],delete window.FRONTEND_SERVICE,delete window.BACKEND_SERVICE,m.versions=k&&k.time>o.appData?k:h,m.isRestarting=function(){return b||E},m.isBackendRestarting=function(){return b},m.isFrontendRestarting=function(){return E},m.isFrontendReloading=function(){return R},m.enableViews=function(){S=!0},m.disableViews=function(){S=!1},m.pull=function(e){i.emit("updater.pull",e)},m.getCurrentVersionString=function(){return m.versions.package},I(),i.on("updater.versions",function(n){var t=m.versions;m.versions=n,e.isEqual(e.omit(n,"time"),e.omit(t,"time"))||I(),n.frontend!==t.frontend&&C()}),t.subscribe("updater.newVersion",function(e){n.publish("updater.newVersion",e),e.service===D?function(){if(b)return;b=!0,S&&(null!==v&&v.remove(),v=new d({template:l,type:"backend"}),r.insertView(v).render(),v.$el.slideDown());n.subscribe("socket.connected").setLimit(1).on("message",function(){if(b=!1,v){var e=v;e.$el.slideUp(function(){v===e&&(v.remove(),v=null)}),n.publish("updater.backendRestarted")}}),n.publish("updater.backendRestarting")}():e.service===V&&C()}),n.subscribe("viewport.page.shown",function(e){!function(e){if("dashboard"!==e.pageId||-1===window.navigator.vendor.toLowerCase().indexOf("google")||"1"===window.sessionStorage.getItem("WMES_BROWSER_UPDATE"))return;var n=window.navigator.userAgent.match(/Chrome\/([0-9]+)/);if(!n)return;if(+n[1]>=c)return;r.showDialog(new u,s("updater","browserUpdate:title"))}(e),function(e){if("dashboard"!==e.pageId||"ket.wmes.pl"===window.location.hostname||"192.168.21.60"===window.location.hostname||"1"===window.sessionStorage.getItem("WMES_ADDRESS_UPDATE"))return;r.showDialog(new w,s("updater","addressUpdate:title"))}(e)}),window.updater=m,m});