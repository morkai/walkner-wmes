define(["../broker","../pubsub","../socket","../viewport","../time","./views/RestartMessageView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,t,n,r,i,o,a,s){function l(){h.versions.time=Date.now(),localStorage.setItem(f,JSON.stringify(h.versions))}function d(){g||(g=!0,y&&(null!==v&&v.remove(),v=new o({template:a,type:"backend"}),r.insertView(v).render(),v.$el.slideDown()),e.subscribe("socket.connected").setLimit(1).on("message",function(){g=!1,null!==v&&v.$el.slideUp(function(){"backend"===v.options.type&&(v.remove(),v=null)}),e.publish("updater.backendRestarted")}),e.publish("updater.backendRestarting"))}function u(){w||(w=!0,window.addEventListener("mousemove",c),window.addEventListener("keypress",c),y&&(null!==v&&v.remove(),v=new o({template:s,type:"frontend"}),r.insertView(v).render(),v.$el.slideDown()),e.publish("updater.frontendRestarting"),c())}function c(){clearTimeout(m),m=setTimeout(p,6e4)}function p(){n.isConnected()&&(b=!0,e.publish("updater.frontendReloading"),window.location.reload())}var f="VERSIONS",h={},m=null,v=null,g=!1,w=!1,b=!1,y=!0,E=window[f],R=JSON.parse(localStorage.getItem(f)||"null");return delete window[f],h.versions=R&&R.time>i.appData?R:E,h.isRestarting=function(){return g||w},h.isBackendRestarting=function(){return g},h.isFrontendRestarting=function(){return w},h.isFrontendReloading=function(){return b},h.enableViews=function(){y=!0},h.disableViews=function(){y=!1},h.pull=function(e){n.emit("updater.pull",e)},l(),n.on("updater.versions",function(e){var t=h.versions;h.versions=e,l(),e.frontend!==t.frontend&&u()}),t.subscribe("updater.newVersion",function(t){e.publish("updater.newVersion",t),"backend"===t.service?d():"frontend"===t.service&&u()}),window.updater=h,h});