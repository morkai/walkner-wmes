define(["underscore","jquery","../broker","../pubsub","../socket","../viewport","../time","../i18n","../data/localStorage","./views/RestartMessageView","./views/BrowserUpdateDialogView","./views/AddressUpdateDialogView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,o,r,s,a,d,u,w,c,l,p){"use strict";var f=70,g="VERSIONS",m={},v=null,E=null,R=!1,b=!1,S=!1,h=!0,D=window.BACKEND_SERVICE||"backend",k=window.FRONTEND_SERVICE||"frontend",V=window[g],_=JSON.parse(d.getItem(g)||"null");function A(){m.versions.time=Date.now(),d.setItem(g,JSON.stringify(m.versions))}function C(){b||R||(b=!0,window.addEventListener("mousemove",I),window.addEventListener("keypress",I),h&&(E&&E.cancelAnimations(!0,!0),E&&E.remove(),E=new u({template:p,type:"frontend"}),r.insertView(E).render(),E.$el.slideDown()),t.publish("updater.frontendRestarting"),window.navigator.serviceWorker&&window.navigator.serviceWorker.getRegistrations&&window.navigator.serviceWorker.getRegistrations().then(function(n){n.forEach(function(n){n.unregister().catch(e.noop)})}).catch(e.noop),I())}function I(){clearTimeout(v),v=setTimeout(T,e.random(6e4,12e4))}function T(){o.isConnected()&&(S=!0,t.publish("updater.frontendReloading"),window.location.reload())}return delete window[g],delete window.FRONTEND_SERVICE,delete window.BACKEND_SERVICE,m.versions=_&&_.time>s.appData?_:V,m.isRestarting=function(){return R||b},m.isBackendRestarting=function(){return R},m.isFrontendRestarting=function(){return b},m.isFrontendReloading=function(){return S},m.enableViews=function(){h=!0},m.disableViews=function(){h=!1},m.pull=function(e){o.emit("updater.pull",e)},m.getCurrentVersionString=function(){return m.versions.package},A(),o.on("updater.versions",function(n){var t=m.versions;m.versions=n,e.isEqual(e.omit(n,"time"),e.omit(t,"time"))||A(),n.frontend!==t.frontend&&C()}),i.subscribe("updater.newVersion",function(e){t.publish("updater.newVersion",e),e.service===D?function(){if(R)return;R=!0,h&&(null!==E&&E.remove(),E=new u({template:l,type:"backend"}),r.insertView(E).render(),E.$el.slideDown());t.subscribe("socket.connected").setLimit(1).on("message",function(){if(R=!1,E){var e=E;e.$el.slideUp(function(){E===e&&(E.remove(),E=null)}),t.publish("updater.backendRestarted")}}),t.publish("updater.backendRestarting")}():e.service===k&&C()}),t.subscribe("viewport.page.shown",function(e){!1!==window.WMES_UPDATER_BROWSER&&function(e){if("dashboard"!==e.pageId||-1===window.navigator.vendor.toLowerCase().indexOf("google")||"1"===window.sessionStorage.getItem("WMES_BROWSER_UPDATE"))return;var n=window.navigator.userAgent.match(/Chrome\/([0-9]+)/);if(!n)return;if(+n[1]>=f)return;r.showDialog(new w,a("updater","browserUpdate:title"))}(e),!1!==window.WMES_UPDATER_ADDRESS&&function(){if(/\.wmes\.pl$/.test(window.location.hostname)||"localhost"===window.location.hostname||"1"===window.sessionStorage.getItem("WMES_ADDRESS_UPDATE")||window.document.body.classList.contains("is-embedded"))return;n.ajax({method:"GET",url:"https://ket.wmes.pl/ping",dataType:"text"}).done(function(e){"pong"===e&&r.showDialog(new c,a("updater","addressUpdate:title"))})}()}),window.updater=m,m});