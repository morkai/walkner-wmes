define(["underscore","jquery","../broker","../pubsub","../socket","../viewport","../time","../i18n","../data/localStorage","./views/RestartMessageView","./views/BrowserUpdateDialogView","./views/AddressUpdateDialogView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,o,r,s,a,d,u,w,c,l,p){"use strict";var f=70,g="VERSIONS",m={},v=null,b=null,E=!1,R=!1,h=!1,S=!0,D=window.BACKEND_SERVICE||"backend",k=window.FRONTEND_SERVICE||"frontend",V=window[g],C=JSON.parse(d.getItem(g)||"null");function I(){m.versions.time=Date.now(),d.setItem(g,JSON.stringify(m.versions))}function N(){R||E||(R=!0,window.addEventListener("mousemove",A),window.addEventListener("keypress",A),S&&(b&&b.cancelAnimations(!0,!0),b&&b.remove(),b=new u({template:p,type:"frontend"}),r.insertView(b).render(),b.$el.slideDown()),t.publish("updater.frontendRestarting"),window.navigator.serviceWorker&&window.navigator.serviceWorker.getRegistrations&&window.navigator.serviceWorker.getRegistrations().then(function(n){n.forEach(function(n){n.unregister().catch(e.noop)})}).catch(e.noop),A())}function A(){clearTimeout(v),v=setTimeout(T,e.random(6e4,12e4))}function T(){o.isConnected()&&(h=!0,t.publish("updater.frontendReloading"),window.location.reload())}return delete window[g],delete window.FRONTEND_SERVICE,delete window.BACKEND_SERVICE,m.versions=C&&C.time>s.appData?C:V,m.isRestarting=function(){return E||R},m.isBackendRestarting=function(){return E},m.isFrontendRestarting=function(){return R},m.isFrontendReloading=function(){return h},m.enableViews=function(){S=!0},m.disableViews=function(){S=!1},m.pull=function(e){o.emit("updater.pull",e)},m.getCurrentVersionString=function(){return m.versions.package},I(),o.on("updater.versions",function(n){var t=m.versions;m.versions=n,e.isEqual(e.omit(n,"time"),e.omit(t,"time"))||I(),n.frontend!==t.frontend&&N()}),i.subscribe("updater.newVersion",function(e){t.publish("updater.newVersion",e),e.service===D?function(){if(E)return;E=!0,S&&(null!==b&&b.remove(),b=new u({template:l,type:"backend"}),r.insertView(b).render(),b.$el.slideDown());t.subscribe("socket.connected").setLimit(1).on("message",function(){if(E=!1,b){var e=b;e.$el.slideUp(function(){b===e&&(b.remove(),b=null)}),t.publish("updater.backendRestarted")}}),t.publish("updater.backendRestarting")}():e.service===k&&N()}),t.subscribe("viewport.page.shown",function(e){!function(e){if("dashboard"!==e.pageId||-1===window.navigator.vendor.toLowerCase().indexOf("google")||"1"===window.sessionStorage.getItem("WMES_BROWSER_UPDATE"))return;var n=window.navigator.userAgent.match(/Chrome\/([0-9]+)/);if(!n)return;if(+n[1]>=f)return;r.showDialog(new w,a("updater","browserUpdate:title"))}(e),function(){if(/\.wmes\.pl$/.test(window.location.hostname)||"localhost"===window.location.hostname||"1"===window.sessionStorage.getItem("WMES_ADDRESS_UPDATE")||window.document.body.classList.contains("is-embedded"))return;n.ajax({method:"GET",url:"https://ket.wmes.pl/ping",dataType:"text"}).done(function(e){"pong"===e&&r.showDialog(new c,a("updater","addressUpdate:title"))})}()}),window.updater=m,m});