define(["underscore","../broker","../pubsub","../socket","../viewport","../time","../data/localStorage","./views/RestartMessageView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,r,o,s,a,d,u){"use strict";var l="VERSIONS",c={},p=null,w=null,f=!1,m=!1,v=!1,b=!0,R=window.BACKEND_SERVICE||"backend",E=window.FRONTEND_SERVICE||"frontend",g=window[l],V=JSON.parse(s.getItem(l)||"null");function k(){c.versions.time=Date.now(),s.setItem(l,JSON.stringify(c.versions))}function S(){m||f||(m=!0,window.addEventListener("mousemove",N),window.addEventListener("keypress",N),b&&(w&&w.cancelAnimations(!0,!0),w&&w.remove(),w=new a({template:u,type:"frontend"}),r.insertView(w).render(),w.$el.slideDown()),n.publish("updater.frontendRestarting"),N())}function N(){clearTimeout(p),p=setTimeout(C,e.random(6e4,12e4))}function C(){i.isConnected()&&(v=!0,n.publish("updater.frontendReloading"),window.location.reload())}return delete window[l],delete window.FRONTEND_SERVICE,delete window.BACKEND_SERVICE,c.versions=V&&V.time>o.appData?V:g,c.isRestarting=function(){return f||m},c.isBackendRestarting=function(){return f},c.isFrontendRestarting=function(){return m},c.isFrontendReloading=function(){return v},c.enableViews=function(){b=!0},c.disableViews=function(){b=!1},c.pull=function(e){i.emit("updater.pull",e)},c.getCurrentVersionString=function(){return c.versions.package},k(),i.on("updater.versions",function(n){var t=c.versions;c.versions=n,e.isEqual(e.omit(n,"time"),e.omit(t,"time"))||k(),n.frontend!==t.frontend&&S()}),t.subscribe("updater.newVersion",function(e){n.publish("updater.newVersion",e),e.service===R?function(){if(f)return;f=!0,b&&(null!==w&&w.remove(),w=new a({template:d,type:"backend"}),r.insertView(w).render(),w.$el.slideDown());n.subscribe("socket.connected").setLimit(1).on("message",function(){if(f=!1,w){var e=w;e.$el.slideUp(function(){w===e&&(w.remove(),w=null)}),n.publish("updater.backendRestarted")}}),n.publish("updater.backendRestarting")}():e.service===E&&S()}),window.updater=c,c});