// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../broker","../pubsub","../socket","../viewport","../time","../data/localStorage","./views/RestartMessageView","app/updater/templates/backendRestart","app/updater/templates/frontendRestart","i18n!app/nls/updater"],function(e,n,t,i,r,o,s,a,d,u){"use strict";function l(){v.versions.time=Date.now(),s.setItem(m,JSON.stringify(v.versions))}function c(){E||(E=!0,k&&(null!==R&&R.remove(),R=new a({template:d,type:"backend"}),r.insertView(R).render(),R.$el.slideDown()),n.subscribe("socket.connected").setLimit(1).on("message",function(){if(E=!1,R){var e=R;e.$el.slideUp(function(){R===e&&(R.remove(),R=null)}),n.publish("updater.backendRestarted")}}),n.publish("updater.backendRestarting"))}function p(){g||E||(g=!0,window.addEventListener("mousemove",w),window.addEventListener("keypress",w),k&&(R&&R.cancelAnimations(!0,!0),R&&R.remove(),R=new a({template:u,type:"frontend"}),r.insertView(R).render(),R.$el.slideDown()),n.publish("updater.frontendRestarting"),w())}function w(){clearTimeout(b),b=setTimeout(f,6e4)}function f(){i.isConnected()&&(V=!0,n.publish("updater.frontendReloading"),window.location.reload())}var m="VERSIONS",v={},b=null,R=null,E=!1,g=!1,V=!1,k=!0,S=window.BACKEND_SERVICE||"backend",N=window.FRONTEND_SERVICE||"frontend",C=window[m],D=JSON.parse(s.getItem(m)||"null");return delete window[m],delete window.FRONTEND_SERVICE,delete window.BACKEND_SERVICE,v.versions=D&&D.time>o.appData?D:C,v.isRestarting=function(){return E||g},v.isBackendRestarting=function(){return E},v.isFrontendRestarting=function(){return g},v.isFrontendReloading=function(){return V},v.enableViews=function(){k=!0},v.disableViews=function(){k=!1},v.pull=function(e){i.emit("updater.pull",e)},v.getCurrentVersionString=function(){return v.versions.package},l(),i.on("updater.versions",function(n){var t=v.versions;v.versions=n,e.isEqual(e.omit(n,"time"),e.omit(t,"time"))||l(),n.frontend!==t.frontend&&p()}),t.subscribe("updater.newVersion",function(e){n.publish("updater.newVersion",e),e.service===S?c():e.service===N&&p()}),window.updater=v,v});