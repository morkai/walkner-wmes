define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","./dictionaries"],function(e,r,s,t,o,a){"use strict";var i=["type","status","section","area","cause","risk","nearMissCategory","company"],n={section:"sections",area:"areas",cause:"causes",risk:"risks",nearMissCategory:"categories",suggestionCategory:"categories",company:"companies"};return window.KAIZEN_MULTI&&i.push("suggestionCategory"),t.extend({urlRoot:"/kaizen/report",nlsDomain:"kaizenOrders",defaults:function(){return{from:0,to:0,interval:"month",sections:[],areas:[]}},fetch:function(r){return e.isObject(r)||(r={}),r.data=e.assign(r.data||{},e.pick(this.attributes,["from","to","interval","sections","areas"])),r.data.sections=r.data.sections.join(","),r.data.areas=r.data.areas.join(","),t.prototype.fetch.call(this,r)},genClientUrl:function(){return"/kaizenOrders/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&areas="+this.get("areas")},parse:function(r){var s=this,t=r.totals,o=t.count,n={type:{rows:this.prepareTypeRows(t),series:this.prepareTypeSeries()},status:{rows:this.prepareRows(o,t.status,"status"),series:{}},owner:{categories:this.prepareUserCategories(r.users,t.owner),series:this.prepareOwnerSeries(t.owner,r.groups)},confirmer:{categories:this.prepareUserCategories(r.users,t.confirmer),series:this.prepareConfirmerSeries(t.confirmer,r.groups)}};return e.forEach(i,function(e){n[e]||(n[e]={rows:s.prepareRows(o,t[e],e),series:{}})}),e.forEach(r.groups,function(r){var t;"number"==typeof r?r={key:t=r,type:{}}:t=r.key;var o=n.type.series;o.nearMiss.data.push({x:t,y:r.type.nearMiss||null}),a.multiType&&(o.suggestion.data.push({x:t,y:r.type.suggestion||null}),o.kaizen.data.push({x:t,y:r.type.kaizen||null})),e.forEach(i,function(e){"type"!==e&&s.createSeriesFromRows(e,n,r)})},this),n},prepareTypeRows:function(e){if(!a.multiType)return[{id:"nearMiss",abs:e.type.nearMiss,rel:e.type.nearMiss/e.count,color:a.colors.nearMiss}];var r=e.type.nearMiss+e.type.suggestion+e.type.kaizen;return[{id:"singleTotal",abs:e.count,rel:1},{id:"multiTotal",abs:r,rel:1},{id:"nearMiss",abs:e.type.nearMiss,rel:e.type.nearMiss/r,color:a.colors.nearMiss},{id:"suggestion",abs:e.type.suggestion,rel:e.type.suggestion/r,color:a.colors.suggestion},{id:"kaizen",abs:e.type.kaizen,rel:e.type.kaizen/r,color:a.colors.kaizen}]},prepareTypeSeries:function(){var e={nearMiss:{data:[],color:a.colors.nearMiss}};return a.multiType&&(e.suggestion={data:[],color:a.colors.suggestion},e.kaizen={data:[],color:a.colors.kaizen}),e},prepareRows:function(e,r,s){var t=a.forProperty(n[s]);return r.map(function(r){var a=t?t.get(r[0]):null;return{id:r[0],abs:r[1],rel:r[1]/e,color:(a?a.get("color"):null)||o.getColor(s,r[0]),label:a?a.getLabel():void 0}})},createSeriesFromRows:function(r,s,t){var o=s[r].series;e.forEach(s[r].rows,function(e){o[e.id]||(o[e.id]={name:e.label,data:[],color:e.color}),o[e.id].data.push({x:t.key,y:t[r]&&t[r][e.id]||null})})},prepareUserCategories:function(e,r){return r.map(function(r){var s=r[0];return e[s]||s})},prepareOwnerSeries:function(s){var t=[{id:"nearMiss",name:r.bound("kaizenOrders","report:series:nearMiss"),data:[],color:a.colors.nearMiss}];return a.multiType&&(t.push({id:"suggestion",name:r.bound("kaizenOrders","report:series:suggestion"),data:[],color:a.colors.suggestion}),t.push({id:"kaizen",name:r.bound("kaizenOrders","report:series:kaizen"),data:[],color:a.colors.kaizen})),e.forEach(s,function(e){t[0].data.push(e[2]),a.multiType&&(t[1].data.push(e[3]),t[2].data.push(e[4]))}),t},prepareConfirmerSeries:function(s){return[{id:"entry",name:r.bound("kaizenOrders","report:series:"+(a.multiType?"entry":"nearMiss")),color:a.multiType?null:a.colors.nearMiss,data:e.map(s,function(e){return e[1]})}]}},{TABLE_AND_CHART_METRICS:i,fromQuery:function(r){return void 0===r.from&&void 0===r.to&&(r.from=s.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+r.from||void 0,to:+r.to||void 0,interval:r.interval||void 0,sections:e.isEmpty(r.sections)?[]:r.sections.split(","),areas:e.isEmpty(r.areas)?[]:r.areas.split(",")})}})});