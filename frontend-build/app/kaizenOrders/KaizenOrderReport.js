// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","./dictionaries"],function(e,r,t,s,i,a){"use strict";var n="#d9534f",o="#f0ad4e",u="#5cb85c",p=["type","status","section","area","cause","risk","nearMissCategory"],c={section:"sections",area:"areas",cause:"causes",risk:"risks",nearMissCategory:"categories",suggestionCategory:"categories"};return window.KAIZEN_MULTI&&p.push("suggestionCategory"),s.extend({urlRoot:"/kaizen/report",defaults:function(){return{from:0,to:0,interval:"month"}},initialize:function(){},fetch:function(r){return e.isObject(r)||(r={}),r.data=e.extend(r.data||{},{from:this.get("from"),to:this.get("to"),interval:this.get("interval")}),s.prototype.fetch.call(this,r)},genClientUrl:function(){return"/kaizenReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")},parse:function(r){var t=this,s=r.totals,i=s.count,n={type:{rows:this.prepareTypeRows(s),series:this.prepareTypeSeries()},status:{rows:this.prepareRows(i,s.status,"status"),series:{}},owner:{categories:this.prepareUserCategories(r.users,s.owner),series:this.prepareOwnerSeries(s.owner,r.groups)},confirmer:{categories:this.prepareUserCategories(r.users,s.confirmer),series:this.prepareConfirmerSeries(s.confirmer,r.groups)}};return e.forEach(p,function(e){n[e]||(n[e]={rows:t.prepareRows(i,s[e],e),series:{}})}),e.forEach(r.groups,function(r){var s;"number"==typeof r?(s=r,r={key:s,type:{}}):s=r.key;var i=n.type.series;i.nearMiss.data.push({x:s,y:r.type.nearMiss||null}),a.multiType&&(i.suggestion.data.push({x:s,y:r.type.suggestion||null}),i.kaizen.data.push({x:s,y:r.type.kaizen||null})),e.forEach(p,function(e){t.createSeriesFromRows(e,n,r)})},this),n},prepareTypeRows:function(e){if(!a.multiType)return[{id:"nearMiss",abs:e.type.nearMiss,rel:e.type.nearMiss/e.count,color:n}];var r=e.type.nearMiss+e.type.suggestion+e.type.kaizen;return[{id:"singleTotal",abs:e.count,rel:1},{id:"multiTotal",abs:r,rel:1},{id:"nearMiss",abs:e.type.nearMiss,rel:e.type.nearMiss/r,color:n},{id:"suggestion",abs:e.type.suggestion,rel:e.type.suggestion/r,color:o},{id:"kaizen",abs:e.type.kaizen,rel:e.type.kaizen/r,color:u}]},prepareTypeSeries:function(){var e={nearMiss:{data:[],color:n}};return a.multiType&&(e.suggestion={data:[],color:o},e.kaizen={data:[],color:u}),e},prepareRows:function(e,r,t){var s=c[t];return r.map(function(r){return{id:r[0],abs:r[1],rel:r[1]/e,color:i.getColor(t,r[0]),label:s?a.getLabel(s,r[0]):void 0}})},createSeriesFromRows:function(r,t,s){var i=t[r].series;e.forEach(t[r].rows,function(e){i[e.id]||(i[e.id]={name:e.label,data:[],color:e.color}),i[e.id].data.push({x:s.key,y:s[r]?s[r][e.id]||null:null})})},prepareUserCategories:function(e,r){return r.map(function(r){var t=r[0];return e[t]||t})},prepareOwnerSeries:function(t){var s=[{id:"nearMiss",name:r.bound("kaizenOrders","report:series:nearMiss"),data:[],color:n}];return a.multiType&&(s.push({id:"suggestion",name:r.bound("kaizenOrders","report:series:suggestion"),data:[],color:o}),s.push({id:"kaizen",name:r.bound("kaizenOrders","report:series:kaizen"),data:[],color:u})),e.forEach(t,function(e){s[0].data.push(e[2]),a.multiType&&(s[1].data.push(e[3]),s[2].data.push(e[4]))}),s},prepareConfirmerSeries:function(t){return[{id:"entry",type:"bar",name:r.bound("kaizenOrders","report:series:"+(a.multiType?"entry":"nearMiss")),color:a.multiType?null:n,data:e.map(t,function(e){return e[1]})}]}},{TABLE_AND_CHART_METRICS:p})});