// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../time","../core/Model","../data/colorFactory","./dictionaries"],function(e,t,r,s,a){"use strict";var i=["type","status","section","area","cause","risk","nearMissCategory"],o={section:"sections",area:"areas",cause:"causes",risk:"risks",nearMissCategory:"categories",suggestionCategory:"categories"};return window.KAIZEN_MULTI&&i.push("suggestionCategory"),r.extend({urlRoot:"/kaizen/report",defaults:function(){return{from:0,to:0,interval:"month"}},initialize:function(){},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.extend(t.data||{},{from:this.get("from"),to:this.get("to"),interval:this.get("interval")}),r.prototype.fetch.call(this,t)},genClientUrl:function(){return"/kaizenReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")},parse:function(t){var r=this,s=t.totals,o=s.count,n={type:{rows:this.prepareTypeRows(s),series:this.prepareTypeSeries()},status:{rows:this.prepareRows(o,s.status,"status"),series:{}}};return e.forEach(i,function(e){n[e]||(n[e]={rows:r.prepareRows(o,s[e],e),series:{}})}),e.forEach(t.groups,function(t){var s;"number"==typeof t?(s=t,t={key:s,type:{}}):s=t.key;var o=n.type.series;o.nearMiss.data.push({x:s,y:t.type.nearMiss||null}),a.multiType&&(o.suggestion.data.push({x:s,y:t.type.suggestion||null}),o.kaizen.data.push({x:s,y:t.type.kaizen||null})),e.forEach(i,function(e){r.createSeriesFromRows(e,n,t)})},this),n},prepareTypeRows:function(e){if(!a.multiType)return[{id:"nearMiss",abs:e.type.nearMiss,rel:e.type.nearMiss/e.count,color:"#d9534f"}];var t=e.type.nearMiss+e.type.suggestion+e.type.kaizen;return[{id:"singleTotal",abs:e.count,rel:1},{id:"multiTotal",abs:t,rel:1},{id:"nearMiss",abs:e.type.nearMiss,rel:e.type.nearMiss/t,color:"#d9534f"},{id:"suggestion",abs:e.type.suggestion,rel:e.type.suggestion/t,color:"#f0ad4e"},{id:"kaizen",abs:e.type.kaizen,rel:e.type.kaizen/t,color:"#5cb85c"}]},prepareTypeSeries:function(){var e={nearMiss:{data:[],color:"#d9534f"}};return a.multiType&&(e.suggestion={data:[],color:"#f0ad4e"},e.kaizen={data:[],color:"#5cb85c"}),e},prepareRows:function(e,t,r){var i=o[r];return t.map(function(t){return{id:t[0],abs:t[1],rel:t[1]/e,color:s.getColor(r,t[0]),label:i?a.getLabel(i,t[0]):void 0}})},createSeriesFromRows:function(t,r,s){var a=r[t].series;e.forEach(r[t].rows,function(e){a[e.id]||(a[e.id]={name:e.label,data:[],color:e.color}),a[e.id].data.push({x:s.key,y:s[t]?s[t][e.id]||null:null})})}},{TABLE_AND_CHART_METRICS:i})});