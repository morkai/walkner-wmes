define(["underscore","app/i18n","app/highcharts","app/core/View","../dictionaries","../KaizenMetricsReport","../views/KaizenMetricsReportFilterView","../views/KaizenMetricsReportChartView","app/kaizenOrders/templates/metricsReportPage"],function(e,t,i,r,o,s,n,a,l){"use strict";return r.extend({layoutName:"page",template:l,breadcrumbs:[t.bound("kaizenOrders","BREADCRUMB:base"),t.bound("kaizenOrders","BREADCRUMB:reports:metrics")],events:{"click .kaizenOrders-report-grouping":function(e){var t=this.$(e.currentTarget);if(t.hasClass("active"))return!1;var i=t[0].dataset.metric,r=t[0].dataset.grouping;return this.$('.kaizenOrders-report-grouping[data-metric="'+i+'"].active').removeClass("active"),t.addClass("active"),this.model.setMetricGrouping(i,r),!1}},initialize:function(){this.setView("#-filter",new n({model:this.model})),["ipr","ips","ipc"].forEach(function(e,t){this.setView("#-"+e+"-report",new a({metric:e,model:this.model,unit:0===t?"":"%"}))},this),this.setView("#-count-report",new a({metric:"count",model:this.model,valueDecimals:0,dataLabels:!1})),this.setView("#-users-report",new a({metric:"users",model:this.model,valueDecimals:0})),this.setView("#-fte-report",new a({metric:"fte",model:this.model,tooltipUnit:"FTE"})),this.listenTo(this.model,"filtered",this.onFiltered),this.listenTo(this.model,"change:total",this.updateSubtitles),this.listenTo(this.model,"change:interval",this.updateGroupings)},destroy:function(){o.unload()},serialize:function(){return{idPrefix:this.idPrefix,metrics:s.TABLE_AND_CHART_METRICS,grouping:{ipr:this.model.getMetricGrouping("ipr"),ips:this.model.getMetricGrouping("ips"),ipc:this.model.getMetricGrouping("ipc"),fte:this.model.getMetricGrouping("fte")},totalGroupingVisible:"none"!==this.model.get("interval")}},load:function(e){return o.loaded?e(this.model.fetch()):o.load().then(this.model.fetch.bind(this.model))},afterRender:function(){o.load(),this.updateSubtitles()},onFiltered:function(){this.promised(this.model.fetch()),this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!1,replace:!0})},updateSubtitles:function(){var r=this,o=r.model.get("total");["ipr","ips","ipc","fte"].forEach(function(e){var s="fte"===e?o.fte.avg:o[e];r.$id(e+"-total").html(t("kaizenOrders","report:subtitle:"+e,{value:i.numberFormat(s,2)}))}),r.$id("users-total").html(t("kaizenOrders","report:subtitle:users",{value:i.numberFormat(o.userCount,0)})),r.$id("count-total").html(t("kaizenOrders","report:subtitle:count",{nearMisses:i.numberFormat(o.nearMissCount,0),suggestions:i.numberFormat(o.suggestionCount,0),observations:i.numberFormat(o.observationCount,0),minutes:i.numberFormat(o.minutesCount,0)}));var s=r.model.get("companies"),n=[i.numberFormat(o.fte.avg,2)];e.forEach(o.fteByCompany,function(e,t){e.total>0&&n.push(s[t].name+": "+i.numberFormat(e.avg,2))}),r.$id("fte-total").html(t("kaizenOrders","report:subtitle:fte",{value:n.join("; ")}))},updateGroupings:function(){var e=this,t="none"===e.model.get("interval"),i=".kaizenOrders-report-grouping";e.$(i+'[data-grouping="total"][data-metric^="ip"]').toggleClass("hidden",t),["ipr","ips","ipc"].forEach(function(t){var r=e.model.getMetricGrouping(t);e.$(i+'[data-metric="'+t+'"][data-grouping="'+r+'"]').click()})}})});