// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/highcharts","app/core/View","../dictionaries","../KaizenMetricsReport","../views/KaizenMetricsReportFilterView","../views/KaizenMetricsReportChartView","app/kaizenOrders/templates/metricsReportPage"],function(e,t,i,r,s,o,n,a){"use strict";return i.extend({layoutName:"page",template:a,breadcrumbs:[e.bound("kaizenOrders","BREADCRUMBS:base"),e.bound("kaizenOrders","BREADCRUMBS:reports:metrics")],events:{"click .kaizenOrders-report-grouping":function(e){var t=this.$(e.currentTarget);if(t.hasClass("active"))return!1;var i=t[0].dataset.metric,r=t[0].dataset.grouping;return this.$('.kaizenOrders-report-grouping[data-metric="'+i+'"].active').removeClass("active"),t.addClass("active"),this.model.setMetricGrouping(i,r),!1}},initialize:function(){this.setView("#-filter",new o({model:this.model})),["ipr","ips","ipc"].forEach(function(e,t){this.setView("#-"+e+"-report",new n({metric:e,model:this.model,unit:0===t?"":"%"}))},this),this.setView("#-count-report",new n({metric:"count",model:this.model,valueDecimals:0,dataLabels:!1})),this.setView("#-users-report",new n({metric:"users",model:this.model,valueDecimals:0})),this.setView("#-fte-report",new n({metric:"fte",model:this.model,tooltipUnit:"FTE"})),this.listenTo(this.model,"filtered",this.onFiltered),this.listenTo(this.model,"change:total",this.updateSubtitles),this.listenTo(this.model,"change:interval",this.updateGroupings)},destroy:function(){r.unload()},serialize:function(){return{idPrefix:this.idPrefix,metrics:s.TABLE_AND_CHART_METRICS,grouping:{ipr:this.model.getMetricGrouping("ipr"),ips:this.model.getMetricGrouping("ips"),ipc:this.model.getMetricGrouping("ipc")},totalGroupingVisible:"none"!==this.model.get("interval")}},load:function(e){return r.loaded?e(this.model.fetch()):r.load().then(this.model.fetch.bind(this.model))},afterRender:function(){r.load(),this.updateSubtitles()},onFiltered:function(){this.promised(this.model.fetch()),this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!1,replace:!0})},updateSubtitles:function(){var i=this,r=i.model.get("total");["ipr","ips","ipc","fte"].forEach(function(s){var o="fte"===s?r.fte.avg:r[s];i.$id(s+"-total").html(e("kaizenOrders","report:subtitle:"+s,{value:t.numberFormat(o,2)}))}),i.$id("users-total").html(e("kaizenOrders","report:subtitle:users",{value:t.numberFormat(r.userCount,0)})),i.$id("count-total").html(e("kaizenOrders","report:subtitle:count",{nearMisses:t.numberFormat(r.nearMissCount,0),suggestions:t.numberFormat(r.suggestionCount,0),observations:t.numberFormat(r.observationCount,0),minutes:t.numberFormat(r.minutesCount,0)}))},updateGroupings:function(){var e=this,t="none"===e.model.get("interval"),i=".kaizenOrders-report-grouping";e.$(i+'[data-grouping="total"]').toggleClass("hidden",t),["ipr","ips","ipc"].forEach(function(t){var r=e.model.getMetricGrouping(t);e.$(i+'[data-metric="'+t+'"][data-grouping="'+r+'"]').click()})}})});