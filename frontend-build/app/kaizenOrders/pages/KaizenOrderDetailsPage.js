// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/user","app/viewport","app/core/pages/DetailsPage","app/core/util/pageActions","../dictionaries","../views/KaizenOrderDetailsView","../views/KaizenOrderHistoryView","app/kaizenOrders/templates/detailsPage"],function(e,i,t,s,r,n,o,a,d){"use strict";return s.extend({template:d,baseBreadcrumb:!0,localTopics:{"kaizen.orders.seen":"onSeen"},actions:function(){var i=[];this.model.isNotSeen()&&i.push({id:"markAsSeen",icon:"eye",label:e("kaizenOrders","PAGE_ACTION:markAsSeen"),callback:this.markAsSeen.bind(this)});var t=this.model.get("observer");return"subscriber"===t.role?i.push({id:"unobserve",icon:"eye-slash",label:e("kaizenOrders","PAGE_ACTION:unobserve"),callback:this.unobserve.bind(this)}):"viewer"===t.role&&i.push({id:"observe",icon:"eye",label:e("kaizenOrders","PAGE_ACTION:observe"),callback:this.observe.bind(this)}),this.model.canEdit()&&i.push(r.edit(this.model,!1)),this.model.canDelete()&&i.push(r["delete"](this.model,!1)),i},initialize:function(){s.prototype.initialize.apply(this,arguments),this.setView(".kaizenOrders-detailsPage-properties",this.detailsView),this.setView(".kaizenOrders-detailsPage-history",this.historyView)},destroy:function(){s.prototype.destroy.call(this),n.unload()},defineViews:function(){this.detailsView=new o({model:this.model}),this.historyView=new a({model:this.model})},load:function(e){return e(this.model.fetch(),n.load())},setUpLayout:function(e){this.listenTo(this.model,"reset change",function(){e.setActions(this.actions,this)})},afterRender:function(){s.prototype.afterRender.call(this),n.load()},markAsSeen:function(i){var s=i.currentTarget.querySelector(".btn");s.disabled=!0,this.socket.emit("kaizen.markAsSeen",{_id:this.model.id},function(i){i&&(t.msg.show({type:"error",time:3e3,text:e("kaizenOrders","MSG:markAsSeen:failure")}),s.disabled=!1)})},observe:function(i){var s=i.currentTarget.querySelector(".btn");s.disabled=!0,this.socket.emit("kaizen.observe",{_id:this.model.id,state:!0},function(i){i&&(t.msg.show({type:"error",time:3e3,text:e("kaizenOrders","MSG:observe:failure")}),s.disabled=!1)})},unobserve:function(i){var s=i.currentTarget.querySelector(".btn");s.disabled=!0,this.socket.emit("kaizen.observe",{_id:this.model.id,state:!1},function(i){i&&(t.msg.show({type:"error",time:3e3,text:e("kaizenOrders","MSG:unobserve:failure")}),s.disabled=!1)})},onSeen:function(e){e===this.model.id&&this.model.markAsSeen()}})});