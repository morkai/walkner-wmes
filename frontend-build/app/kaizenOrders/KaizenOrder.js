// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../time","../user","../core/Model","./dictionaries","app/core/templates/userInfo"],function(e,t,r,a,n,i,s){"use strict";var o=["eventDate","kaizenStartDate","kaizenFinishDate"],u=["createdAt","updatedAt","confirmedAt"],c=["creator","updater","confirmer"],l=["nearMissOwners","suggestionOwners","kaizenOwners"];return n.extend({urlRoot:"/kaizen/orders",clientUrlRoot:"#kaizen/orders",topicPrefix:"kaizen.orders",privilegePrefix:"KAIZEN",nlsDomain:"kaizenOrders",labelAttribute:"rid",defaults:{status:"new"},serialize:function(e){var a=e&&e.longDateTime,n=a?"LL":"YY-MM-DD",d=a?"LLLL":"YY-MM-DD, HH:mm:ss",f=this.toJSON();return f.types=f.types.map(function(e){return'<span class="label kaizenOrders-label-'+e+'" title="'+t("kaizenOrders","type:"+e)+'">'+t("kaizenOrders","typeLabel:"+e)+"</span>"}).join(" "),f.status=t("kaizenOrders","status:"+f.status),o.forEach(function(e){f[e]=f[e]?r.format(f[e],n):null}),u.forEach(function(e){f[e]=f[e]?r.format(f[e],d):null}),f.section=i.sections.getLabel(f.section),f.area=i.areas.getLabel(f.area),f.nearMissCategory=i.categories.getLabel(f.nearMissCategory),f.suggestionCategory=i.categories.getLabel(f.suggestionCategory),f.cause=i.causes.getLabel(f.cause),f.risk=i.risks.getLabel(f.risk),f.kaizenDuration=f.kaizenDuration?r.toString(f.kaizenDuration):null,c.forEach(function(e){f[e]=s({userInfo:f[e]})}),l.forEach(function(e){f[e]=(f[e]||[]).map(function(e){return s({userInfo:e})})}),f},serializeDetails:function(){return this.serialize({longDateTime:!0})},canEdit:function(){if(a.isAllowedTo("KAIZEN:MANAGE"))return!0;var t=this.attributes;return t.creator&&t.creator.id===a.data._id?!0:e.any(l,function(r){return e.any(t[r],function(e){return e.id===a.data._id})})}},{DATE_PROPERTIES:o})});