define(["require","underscore","../i18n","../time","../user","../core/Model","app/core/templates/userInfo"],function(e,t,r,s,n,i,a){"use strict";var o=["kaizenStartDate","kaizenFinishDate"],u=["createdAt","updatedAt","confirmedAt"],c=["creator","updater","confirmer"],l=["nearMissOwners","suggestionOwners","kaizenOwners"],d={new:"default",accepted:"info",todo:"info",inProgress:"active",paused:"warning",finished:"success",cancelled:"danger"};return i.extend({urlRoot:"/kaizen/orders",clientUrlRoot:"#kaizenOrders",topicPrefix:"kaizen.orders",privilegePrefix:"KAIZEN",nlsDomain:"kaizenOrders",labelAttribute:"rid",defaults:function(){return{status:"new",types:window.KAIZEN_MULTI?[]:["nearMiss"],eventDate:new Date}},initialize:function(){this.on("reset change",this.prepareUsers),this.prepareUsers()},supportsRelatedSuggestion:function(){var e=Date.parse(this.get("createdAt"));return"development"===window.ENV||!e||e>=15751764e5},isMulti:function(){var e=this.get("types");return e.length>1||"nearMiss"!==e[0]},serialize:function(t){var n=t&&t.nlsDomain||"kaizenOrders",i=t&&t.longDateTime,d=i?"LL":"L",f=i?"LLLL":"L, LTS",h=this.toJSON();h.types=h.types.map(function(e){return'<span class="label kaizenOrders-label-'+e+'" title="'+r(n,"type:"+e)+'">'+r(n,"type:label:"+e)+"</span>"}).join(" "),h.status=r(n,"status:"+h.status),h.eventDate=h.eventDate?s.format(h.eventDate,r(n,"PROPERTY:eventDate:"+(i?"long":"short"))):null,o.forEach(function(e){h[e]=h[e]?s.format(h[e],d):null}),u.forEach(function(e){h[e]=h[e]?s.format(h[e],f):null});var g=null;try{g=e("app/kaizenOrders/dictionaries")}catch(e){}return g&&(h.section=g.sections.getLabel(h.section),h.area=g.areas.getLabel(h.area),h.nearMissCategory=g.categories.getLabel(h.nearMissCategory),h.suggestionCategory=g.categories.getLabel(h.suggestionCategory),h.cause=g.causes.getLabel(h.cause),h.risk=g.risks.getLabel(h.risk),h.kaizenDuration=h.kaizenDuration?s.toString(h.kaizenDuration):null),h.stdReturn=r("core","BOOL:"+!!h.stdReturn),c.forEach(function(e){h[e]=a({userInfo:h[e]})}),l.forEach(function(e){h[e]=(h[e]||[]).map(function(e){return e.rendered})}),Array.isArray(h.attachments)||(h.attachments=[]),h},serializeRow:function(e){var s=this.serialize(e);s.className=d[this.get("status")],s.observer&&s.observer.notify&&t.isEmpty(s.observer.changes)&&(s.className+=" is-changed");var n=s.owners;return n&&(s.owners=1===n.length?n[0].rendered:r(e&&e.nlsDomain||"kaizenOrders","LIST:owners",{first:n[0].rendered,count:n.length-1})),s},serializeDetails:function(){var e=this.serialize({longDateTime:!0});return e.changed=e.observer.changes||{},delete e.changed.all,e.changed.all=e.observer.notify&&t.isEmpty(e.observer.changes),e},isCreator:function(){return this.attributes.creator&&this.attributes.creator.id===n.data._id},isConfirmer:function(){return this.attributes.confirmer&&this.attributes.confirmer.id===n.data._id},isNotSeen:function(){return this.attributes.observer.notify},canEdit:function(){if(n.isAllowedTo("KAIZEN:MANAGE"))return!0;var e=this.attributes;return!(!n.isLoggedIn()||"finished"===e.status||"cancelled"===e.status)&&(!(!this.isCreator()&&!this.isConfirmer())||t.any(l,function(r){return t.any(e[r],function(e){return e.id===n.data._id})}))},canDelete:function(){return n.isLoggedIn()&&(n.isAllowedTo("KAIZEN:MANAGE")||"new"===this.get("status")&&this.isCreator())},markAsSeen:function(){var e=this.attributes.observer;if(e&&e.notify){e.lastSeenAt=new Date,e.notify=!1,e.changes={};var t=this.attributes.observers;this.attributes.observers=null,this.set("observers",t),this.trigger("seen")}},hasMultipleOwners:function(e){var t=this.attributes[e+"Owners"];return Array.isArray(t)&&t.length>1},prepareUsers:function(){this.attributes.observers&&this.prepareObserver(),this.attributes.nearMissOwners&&this.prepareOwners()},prepareObserver:function(){var e=this.get("observers")||[],r=t.find(e,function(e){return e.user.id===n.data._id});this.attributes.observer=r||{user:{id:n.data._id,label:n.getLabel()},role:"viewer",lastSeenAt:null,notify:!1,changes:{}},r&&"string"==typeof r.lastSeenAt&&(r.lastSeenAt=new Date(r.lastSeenAt)),this.trigger("change:observer")},prepareOwners:function(){var e=this.attributes,r={};l.forEach(function(t){e[t]=(e[t]||[]).map(function(e){return e.rendered=a({userInfo:e}),r[e.id]||(r[e.id]=e),e})}),e.owners=t.values(r),this.trigger("change:owners")}},{DATE_PROPERTIES:o})});