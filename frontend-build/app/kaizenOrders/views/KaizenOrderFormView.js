define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/util/formatResultWithDescription","app/core/views/FormView","app/users/util/setUpUserSelect2","../dictionaries","../KaizenOrder","app/kaizenOrders/templates/form","app/minutesForSafetyCards/templates/_formRidEditor"],function(e,t,i,s,a,n,r,o,l,d,u,c,p,h){"use strict";function g(e){return{id:e.id,text:e.getLabel(),description:e.get("description")}}function f(e,t){return t}return l.extend({template:p,events:e.assign({'keydown [role="togglePanel"]':function(e){window.KAIZEN_MULTI&&13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),e.currentTarget.click())},'click [role="togglePanel"]':function(e){if(window.KAIZEN_MULTI){var t=this.$(e.currentTarget).closest(".panel"),i=t.attr("data-type");t.hasClass("is-collapsed")?this.expandPanel(i):this.collapsePanel(i)}},'change [name="status"]':"toggleRequiredToFinishFlags",'change [type="date"]':function(e){var n=s.getMoment(e.target.value,"YYYY-MM-DD"),r=n.isValid()?n.diff(new Date,"days"):0,o=Math.abs(r),l=this.$(e.target).closest(".form-group"),d=l.find(".help-block");if(o<=7)return e.target.setCustomValidity(""),void d.remove();!a.isAllowedTo("KAIZEN:MANAGE")&&o>60&&e.target.setCustomValidity(i("kaizenOrders","FORM:ERROR:date",{days:60})),d.length||(d=t('<p class="help-block"></p>')),d.text(i("kaizenOrders","FORM:help:date:diff",{dir:r>0?"future":"past",days:o})).appendTo(l)},"change #-confirmer":function(){var e=this.$id("confirmer").select2("data");this.$id("fm24-group").toggleClass("hidden",!e||!/fm.?24/i.test(e.text))},"change #-fm24-confirmation":function(e){var t=this.$id("fm24-email");t.prop("disabled",!e.target.checked),e.target.checked&&(/@/.test(t.val())||t.val(a.data.email),t.select())},"click #-relatedSuggestion-message > a":function(){sessionStorage.setItem("KO_LAST",JSON.stringify(e.assign(this.model.toJSON(),this.getFormData())))},"click a[role=rid]":function(e){return this.showRidEditor("relatedSuggestion",e.currentTarget),!1},"change #-stdReturn":function(){this.togglePreventiveMeasuresValidity()},"change #-relatedSuggestion-checkbox":function(){this.togglePreventiveMeasuresValidity()}},l.prototype.events),serialize:function(){var t={};return this.options.editMode&&this.model.get("attachments").forEach(function(e){t[e.description]=e}),e.assign(l.prototype.serialize.call(this),{relatedSuggestion:this.model.supportsRelatedSuggestion(),multiType:!!window.KAIZEN_MULTI||this.model.isMulti(),multiOwner:this.isMultiOwner(),today:s.format(new Date,"YYYY-MM-DD"),statuses:u.nmStatuses,types:u.types,attachments:t,backTo:this.serializeBackTo()})},serializeBackTo:function(){if(void 0!==this.backTo)return this.backTo;var t,i,s={BOC_LAST:"behaviorObsCards",MFS_LAST:"minutesForSafetyCards"};return e.forEach(s,function(e,s){t||(i=JSON.parse(sessionStorage.getItem(s)||"null"))&&(t=e)}),t?this.backTo={type:t,data:i,submitLabel:this.t("FORM:backTo:"+t+":"+(i._id?"edit":"add")),cancelLabel:this.t("FORM:backTo:"+t+":cancel"),cancelUrl:"#"+t+(i._id?"/"+i._id+";edit":";add")}:(e.forEach(s,function(e){sessionStorage.removeItem(e)}),this.backTo=null)},isMultiOwner:function(){return this.options.editMode&&this.model.hasMultipleOwners("nearMiss")},checkValidity:function(){return!0},submitRequest:function(e,t){var s=this,a=new FormData,n=0;if(this.$('input[type="file"]').each(function(){this.files.length&&(a.append(this.dataset.name,this.files[0]),++n)}),0===n)return l.prototype.submitRequest.call(s,e,t);this.$el.addClass("is-uploading");var r=this.ajax({type:"POST",url:"/kaizen/orders;upload",data:a,processData:!1,contentType:!1});r.done(function(i){t.attachments=i,l.prototype.submitRequest.call(s,e,t)}),r.fail(function(){s.showErrorMessage(i("kaizenOrders","FORM:ERROR:upload")),e.attr("disabled",!1)}),r.always(function(){s.$el.removeClass("is-uploading")})},handleSuccess:function(){!this.options.editMode&&this.backTo?this.broker.publish("router.navigate",{url:"/"+this.backTo.type+(this.backTo.data._id?"/"+this.backTo.data._id+";edit":";add")+"?nearMiss="+this.model.get("rid"),trigger:!0}):this.broker.publish("router.navigate",{url:this.model.genClientUrl()+"?"+(this.options.editMode?"":"&thank=you")+(this.options.standalone?"&standalone=1":""),trigger:!0})},serializeToForm:function(){var e=this.model.toJSON(),t=e.eventDate?s.getMoment(e.eventDate):null;return t?(e.eventDate=t.format("YYYY-MM-DD"),e.eventTime=t.format("H")):(e.eventDate="",e.eventTime=""),c.DATE_PROPERTIES.forEach(function(t){e[t]&&(e[t]=s.format(e[t],"YYYY-MM-DD"))}),e.subscribers="",e},serializeForm:function(t){var i=this,a=this.$id("confirmer").select2("data");delete t.attachments,t.confirmer=a?{id:a.id,label:a.text}:null,t.types=e.values(u.types).filter(function(e){return this.isPanelExpanded(e)},this),t.nearMissOwners=p("nearMiss"),t.suggestionOwners=u.multiType?p("suggestion"):[],t.kaizenOwners=u.multiType?p("kaizen"):[],t.subscribers=this.$id("subscribers").select2("data").map(function(e){return{id:e.id,label:e.text}}),c.DATE_PROPERTIES.forEach(function(e){var i=s.getMoment(t[e],"YYYY-MM-DD");t[e]=i.isValid()?i.toISOString():null});var n=(t.eventTime||"").match(/([0-9]{1,2})[^0-9]*([0-9]{1,2})?/),r="00:00";if(delete t.eventTime,this.$(".select2-container + input").each(function(){t[this.name]||(t[this.name]=null)}),n){var o=n[1],l=n[2];r=(1===o.length?"0":"")+o+":",r+=l?(1===l.length?"0":"")+l:"00"}var d=s.getMoment(t.eventDate+" "+r,"YYYY-MM-DD HH:mm");return d.isValid()||(d=s.getMoment(t.eventDate,"YYYY-MM-DD")),t.eventDate=d.isValid()?d.toISOString():null,this.model.supportsRelatedSuggestion()?(t.stdReturn=!!t.stdReturn,t.relatedSuggestion=parseInt(t.relatedSuggestion,10)||null):(t.stdReturn=null,t.relatedSuggestion=null),t;function p(e){var t=i.$id(e+"Owners").select2("data");return Array.isArray(t)||(t=[t]),t.map(function(e){return{id:e.id,label:e.text,company:e.company||e.user&&e.user.company||null}}).filter(function(e){return!!e.id})}},afterRender:function(){l.prototype.afterRender.call(this);var e=o.bind(null,"text","description");this.$id("cause").select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",data:u.causes.map(g),formatResult:e}),this.$id("risk").select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",data:u.risks.map(g),formatResult:e}),n.toggle(this.$id("status")),d(this.$id("subscribers"),{multiple:!0,textFormatter:f,activeOnly:!this.options.editMode}),this.setUpSectionSelect2(),this.setUpAreaSelect2(),this.setUpCategorySelect2("nearMissCategory","inNearMiss"),this.setUpCategorySelect2("suggestionCategory","inSuggestion"),this.setUpConfirmerSelect2(),this.setUpOwnerSelect2(),this.toggleStatuses(),this.toggleSubmit(),this.toggleRequiredToFinishFlags(),this.togglePanels(),this.toggleRelatedSuggestion(),this.$("input[autofocus]").focus()},setUpSectionSelect2:function(){var t=this.model.get("section"),i=u.sections.get(t),s={};u.sections.forEntryType("kaizenOrders").forEach(function(e){e.get("active")&&(s[e.id]=r(e))}),t&&(s[t]=i?r(i):{id:t,text:t}),this.$id("section").select2({data:e.values(s)})},setUpAreaSelect2:function(){var t=this.model.get("area"),i=u.areas.get(t),s={};u.areas.forEach(function(e){e.get("active")&&(s[e.id]=r(e))}),t&&(s[t]=i?r(i):{id:t,text:t}),this.$id("area").select2({data:e.values(s)})},setUpCategorySelect2:function(t,i){var s=this.model.get("category"),a=u.categories.get(s),n={};u.categories.forEach(function(e){e.get("active")&&e.get(i)&&(n[e.id]=g(e))}),s&&(n[s]=a?g(a):{id:s,text:s}),this.$id(t).select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",multiple:!1,data:e.values(n),formatResult:o.bind(null,"text","description")})},setUpConfirmerSelect2:function(){var e=this.model.get("confirmer"),t=d(this.$id("confirmer"),{textFormatter:f,activeOnly:!this.options.editMode});e&&t.select2("data",{id:e.id,text:e.label})},setUpOwnerSelect2:function(){var e=this.options.editMode,t=this.isMultiOwner(),i=!e,s=this.model,n=null;function r(t,i){if(!e)return n?i?[n]:n:null;var a=s.get(t+"Owners");return Array.isArray(a)&&a.length?(a=a.map(function(e){return{id:e.id,text:e.label,company:e.company}}),i?a:a.length?a[0]:null):i?[]:null}this.options.operator?n=this.options.operator:a.isLoggedIn()&&(n={id:a.data._id,text:a.getLabel()}),d(this.$id("nearMissOwners"),{multiple:t,textFormatter:f,activeOnly:i}).select2("data",r("nearMiss",t)),d(this.$id("suggestionOwners"),{multiple:!0,textFormatter:f,activeOnly:i}).select2("data",r("suggestion",!0)),d(this.$id("kaizenOwners"),{multiple:!0,textFormatter:f,activeOnly:i}).select2("data",r("kaizen",!0))},isPanelExpanded:function(e){return this.$id("panel-"+e).hasClass("is-expanded")},collapsePanel:function(e){var t=this.$id("panel-"+e);return t.removeClass("is-expanded "+t.attr("data-expanded-class")).addClass("panel-default is-collapsed"),this.toggleSubmit(),this.toggleRequiredFlags(),this.toggleChooseTypesMsg(),t.find(".panel-body").stop(!1,!1).slideUp("fast"),t},expandPanel:function(e,t){var i=this.$id("panel-"+e);i.removeClass("is-collapsed panel-default").addClass("is-expanded "+i.attr("data-expanded-class")),this.toggleSubmit(),this.toggleRequiredFlags(),this.toggleChooseTypesMsg();var s=i.find(".panel-body").stop(!1,!1);return!1===t?s.css("display","block"):s.slideDown("fast",function(){i.find("input, textarea").first().focus()}),i},toggleRequiredToFinishFlags:function(){var e="finished"===this.$('input[name="status"]:checked').val(),t=this;this.$(".is-requiredToFinish").toggleClass("is-required",e).each(function(){if(this.dataset.required)return t.handleRequiredToFinishFlags(this.dataset.required,e);this.nextElementSibling.classList.contains("select2-container")&&this.parentNode.classList.toggle("has-required-select2",e),e||t.$("#"+this.htmlFor).prop("required",!1)}),this.$(".kaizenOrders-form-msg-optional").toggleClass("hidden",e),e&&this.toggleRequiredFlags()},handleRequiredToFinishFlags:function(e){"preventiveMeasures"===e&&this.togglePreventiveMeasuresValidity()},togglePreventiveMeasuresValidity:function(){var e=this.$('.control-label[data-required="preventiveMeasures"]');if(e.length){var t=e.hasClass("is-required"),i=this.$id("stdReturn"),s=this.$id("relatedSuggestion");if(t){var a=s.find('input[type="checkbox"]'),n=s.find('input[name="relatedSuggestion"]');a.prop("checked",!!n.val()),i.prop("required",!a.prop("checked"))}else i.prop("required",!1),s.prop("required",!1)}},toggleRequiredFlags:function(){var e=this;e.$(".kaizenOrders-form-typePanel").each(function(){var i=t(this),s=i.hasClass("is-expanded");i.find(".is-required").each(function(){if(this.dataset.required)return e.handleRequiredToFinishFlags(this.dataset.required,s);i.find("#"+this.htmlFor).prop("required",s)})})},toggleChooseTypesMsg:function(){this.$id("chooseTypes").toggleClass("hidden",this.$(".kaizenOrders-form-typePanel.is-expanded").length>0)},toggleStatuses:function(){if(this.options.editMode){if(a.isAllowedTo("KAIZEN:MANAGE"))return;var e=["new"],t=!this.model.isConfirmer();t&&e.push("accepted","finished"),this.model.isCreator()&&"new"===this.model.get("status")||!t||e.push("cancelled");var i=this.el;e.forEach(function(e){var t=i.querySelector('input[name="status"][value="'+e+'"]');t.parentNode.classList.toggle("disabled",!t.checked)})}else this.$id("status").find(".btn").each(function(){this.classList.toggle("disabled","new"!==this.querySelector("input").value)})},toggleSubmit:function(){this.$id("submit").prop("disabled",0===this.$(".panel.is-expanded").length)},togglePanels:function(){(this.model.get("types")||[]).forEach(function(e){this.expandPanel(e,!1)},this)},showRidEditor:function(e,t){var i=this,s=i.$(t);if(s.next(".popover").length)s.popover("destroy");else{s.popover({placement:"auto top",html:!0,trigger:"manual",content:this.renderPartialHtml(h,{property:e,rid:this.model.get(e)||""})}).popover("show");var a=s.next(".popover"),n=a.find(".form-control").select(),r=a.find(".btn-default"),o=a.find(".btn-link");o.on("click",function(){s.popover("destroy")}),n.on("keydown",function(e){if(13===e.keyCode)return!1}),n.on("keyup",function(e){if(13===e.keyCode)return r.click(),!1}),r.on("click",function(){n.prop("disabled",!0),r.prop("disabled",!0),o.prop("disabled",!0);var t=parseInt(n.val(),10)||0;if(t<=0)return l(null);var s=(/suggestion/i.test(e)?"/suggestions":"/kaizen/orders")+"/"+t,a=i.ajax({url:s});return a.fail(function(e){i.showErrorMessage(i.t("FORM:ridEditor:"+(404===e.status?"notFound":"failure"))),n.prop("disabled",!1),r.prop("disabled",!1),o.prop("disabled",!1),(404===e.status?n:r).focus()}),a.done(function(){l(t)}),!1})}function l(t){s.popover("destroy").parent().html(i.t("FORM:"+e+":"+(t?"edit":"add"),{rid:t})),i.model.attributes[e]=t,i.$("input[name="+e+"]").val(t||""),"relatedSuggestion"===e&&(i.toggleRelatedSuggestion(),i.togglePreventiveMeasuresValidity())}},toggleRelatedSuggestion:function(){var e=this.$id("relatedSuggestion"),t=e.find('input[name="relatedSuggestion"]').val();e.find('input[type="checkbox"]').prop("checked",!!t)}})});