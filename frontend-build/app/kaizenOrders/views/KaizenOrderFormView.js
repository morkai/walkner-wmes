// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/util/formatResultWithDescription","app/core/views/FormView","app/users/util/setUpUserSelect2","../dictionaries","../KaizenOrder","app/kaizenOrders/templates/form"],function(e,t,i,s,a,n,r,l,o,d,u,c,p){"use strict";function h(e){return{id:e.id,text:e.getLabel(),description:e.get("description")}}function g(e,t){return t}return o.extend({template:p,events:e.extend({'keydown [role="togglePanel"]':function(e){window.KAIZEN_MULTI&&13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),e.currentTarget.click())},'click [role="togglePanel"]':function(e){if(window.KAIZEN_MULTI){var t=this.$(e.currentTarget).closest(".panel"),i=t.attr("data-type");t.hasClass("is-collapsed")?this.expandPanel(i):this.collapsePanel(i)}},'change [name="status"]':"toggleRequiredToFinishFlags",'change [type="date"]':function(e){var n=s.getMoment(e.target.value,"YYYY-MM-DD"),r=n.isValid()?n.diff(new Date,"days"):0,l=Math.abs(r),o=this.$(e.target).closest(".form-group"),d=o.find(".help-block");if(l<=7)return e.target.setCustomValidity(""),void d.remove();!a.isAllowedTo("KAIZEN:MANAGE")&&l>60&&e.target.setCustomValidity(i("kaizenOrders","FORM:ERROR:date",{days:60})),d.length||(d=t('<p class="help-block"></p>')),d.text(i("kaizenOrders","FORM:help:date:diff",{dir:r>0?"future":"past",days:l})).appendTo(o)}},o.prototype.events),serialize:function(){var t={};return this.options.editMode&&this.model.get("attachments").forEach(function(e){t[e.description]=e}),e.assign(o.prototype.serialize.call(this),{multiType:!!window.KAIZEN_MULTI||this.model.isMulti(),multiOwner:this.isMultiOwner(),today:s.format(new Date,"YYYY-MM-DD"),statuses:u.statuses,types:u.types,attachments:t,backTo:this.serializeBackTo()})},serializeBackTo:function(){var e="behaviorObsCards",t=JSON.parse(localStorage.getItem("BOC_LAST")||"null");if(!t){if(!(t=JSON.parse(localStorage.getItem("MFS_LAST")||"null")))return null;e="minutesForSafetyCards"}return{submitLabel:this.t("FORM:backTo:"+e+":"+(t._id?"edit":"add")),cancelLabel:this.t("FORM:backTo:"+e+":cancel"),cancelUrl:"#"+e+(t._id?"/"+t._id+";edit":";add")}},isMultiOwner:function(){return this.options.editMode&&this.model.hasMultipleOwners("nearMiss")},checkValidity:function(){return!0},submitRequest:function(e,t){var s=this,a=new FormData,n=0;if(this.$('input[type="file"]').each(function(){this.files.length&&(a.append(this.dataset.name,this.files[0]),++n)}),0===n)return o.prototype.submitRequest.call(s,e,t);this.$el.addClass("is-uploading");var r=this.ajax({type:"POST",url:"/kaizen/orders;upload",data:a,processData:!1,contentType:!1});r.done(function(i){t.attachments=i,o.prototype.submitRequest.call(s,e,t)}),r.fail(function(){s.showErrorMessage(i("kaizenOrders","FORM:ERROR:upload")),e.attr("disabled",!1)}),r.always(function(){s.$el.removeClass("is-uploading")})},handleSuccess:function(){var e=JSON.parse(localStorage.getItem("BOC_LAST")||"null"),t=JSON.parse(localStorage.getItem("MFS_LAST")||"null"),i=e?"behaviorObsCards":t?"minutesForSafetyCards":null,s=e||t;!this.options.editMode&&i?this.broker.publish("router.navigate",{url:"/"+i+(s._id?"/"+s._id+";edit":";add")+"?nearMiss="+this.model.get("rid"),trigger:!0}):this.broker.publish("router.navigate",{url:this.model.genClientUrl()+"?"+(this.options.editMode?"":"&thank=you")+(this.options.standalone?"&standalone=1":""),trigger:!0})},serializeToForm:function(){var e=this.model.toJSON(),t=e.eventDate?s.getMoment(e.eventDate):null;return t?(e.eventDate=t.format("YYYY-MM-DD"),e.eventTime=t.format("H")):(e.eventDate="",e.eventTime=""),c.DATE_PROPERTIES.forEach(function(t){e[t]&&(e[t]=s.format(e[t],"YYYY-MM-DD"))}),e.subscribers="",e},serializeForm:function(t){function i(e){var t=a.$id(e+"Owners").select2("data");return Array.isArray(t)||(t=[t]),t.map(function(e){return{id:e.id,label:e.text}}).filter(function(e){return!!e.id})}var a=this,n=this.$id("confirmer").select2("data");delete t.attachments,t.confirmer=n?{id:n.id,label:n.text}:null,t.types=e.values(u.types).filter(function(e){return this.isPanelExpanded(e)},this),t.nearMissOwners=i("nearMiss"),t.suggestionOwners=u.multiType?i("suggestion"):[],t.kaizenOwners=u.multiType?i("kaizen"):[],t.subscribers=this.$id("subscribers").select2("data").map(function(e){return{id:e.id,label:e.text}}),c.DATE_PROPERTIES.forEach(function(e){var i=s.getMoment(t[e],"YYYY-MM-DD");t[e]=i.isValid()?i.toISOString():null});var r=(t.eventTime||"").match(/([0-9]{1,2})[^0-9]*([0-9]{1,2})?/),l="00:00";if(delete t.eventTime,this.$(".select2-container + input").each(function(){t[this.name]||(t[this.name]=null)}),r){var o=r[1],d=r[2];l=(1===o.length?"0":"")+o+":",l+=d?(1===d.length?"0":"")+d:"00"}var p=s.getMoment(t.eventDate+" "+l,"YYYY-MM-DD HH:mm");return p.isValid()||(p=s.getMoment(t.eventDate,"YYYY-MM-DD")),t.eventDate=p.isValid()?p.toISOString():null,t},afterRender:function(){o.prototype.afterRender.call(this),this.$id("section").select2({data:u.sections.map(r)}),this.$id("area").select2({allowClear:!0,placeholder:" ",data:u.areas.map(r)});var e=l.bind(null,"text","description");this.$id("cause").select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",data:u.causes.map(h),formatResult:e}),this.$id("nearMissCategory").select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",data:u.categories.where({inNearMiss:!0}).map(h),formatResult:e}),this.$id("suggestionCategory").select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",data:u.categories.where({inSuggestion:!0}).map(h),formatResult:e}),this.$id("risk").select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",data:u.risks.map(h),formatResult:e}),n.toggle(this.$id("status")),d(this.$id("subscribers"),{multiple:!0,textFormatter:g,activeOnly:!this.options.editMode}),this.setUpConfirmerSelect2(),this.setUpOwnerSelect2(),this.toggleStatuses(),this.toggleSubmit(),this.toggleRequiredToFinishFlags(),this.togglePanels(),this.$("input[autofocus]").focus()},setUpConfirmerSelect2:function(){var e=this.model.get("confirmer"),t=d(this.$id("confirmer"),{textFormatter:g,activeOnly:!this.options.editMode});e&&t.select2("data",{id:e.id,text:e.label})},setUpOwnerSelect2:function(){function e(e,i){if(!t)return r?i?[r]:r:null;var s=n.get(e+"Owners");return Array.isArray(s)&&s.length?(s=s.map(function(e){return{id:e.id,text:e.label}}),i?s:s.length?s[0]:null):i?[]:null}var t=this.options.editMode,i=this.isMultiOwner(),s=!t,n=this.model,r=null;this.options.operator?r=this.options.operator:a.isLoggedIn()&&(r={id:a.data._id,text:a.getLabel()}),d(this.$id("nearMissOwners"),{multiple:i,textFormatter:g,activeOnly:s}).select2("data",e("nearMiss",i)),d(this.$id("suggestionOwners"),{multiple:!0,textFormatter:g,activeOnly:s}).select2("data",e("suggestion",!0)),d(this.$id("kaizenOwners"),{multiple:!0,textFormatter:g,activeOnly:s}).select2("data",e("kaizen",!0))},isPanelExpanded:function(e){return this.$id("panel-"+e).hasClass("is-expanded")},collapsePanel:function(e){var t=this.$id("panel-"+e);return t.removeClass("is-expanded "+t.attr("data-expanded-class")).addClass("panel-default is-collapsed"),this.toggleSubmit(),this.toggleRequiredFlags(),this.toggleChooseTypesMsg(),t.find(".panel-body").stop(!1,!1).slideUp("fast"),t},expandPanel:function(e,t){var i=this.$id("panel-"+e);i.removeClass("is-collapsed panel-default").addClass("is-expanded "+i.attr("data-expanded-class")),this.toggleSubmit(),this.toggleRequiredFlags(),this.toggleChooseTypesMsg();var s=i.find(".panel-body").stop(!1,!1);return!1===t?s.css("display","block"):s.slideDown("fast",function(){i.find("input, textarea").first().focus()}),i},toggleRequiredToFinishFlags:function(){var e=this.$('input[name="status"]:checked').val(),t="finished"===e,i=this;this.$(".is-requiredToFinish").toggleClass("is-required",t).each(function(){this.nextElementSibling.classList.contains("select2-container")&&this.parentNode.classList.toggle("has-required-select2",t),t||i.$("#"+this.htmlFor).prop("required",!1)}),this.$(".kaizenOrders-form-msg-optional").toggleClass("hidden",t),t&&this.toggleRequiredFlags()},toggleRequiredFlags:function(){this.$(".kaizenOrders-form-typePanel").each(function(){var e=t(this),i=e.hasClass("is-expanded");e.find(".is-required").each(function(){e.find("#"+this.htmlFor).prop("required",i)})})},toggleChooseTypesMsg:function(){this.$id("chooseTypes").toggleClass("hidden",this.$(".kaizenOrders-form-typePanel.is-expanded").length>0)},toggleStatuses:function(){if(this.options.editMode){if(a.isAllowedTo("KAIZEN:MANAGE"))return;var e=["new"],t=!this.model.isConfirmer();t&&e.push("accepted","finished"),this.model.isCreator()&&"new"===this.model.get("status")||!t||e.push("cancelled");var i=this.el;e.forEach(function(e){var t=i.querySelector('input[name="status"][value="'+e+'"]');t.parentNode.classList.toggle("disabled",!t.checked)})}else this.$id("status").find(".btn").each(function(){this.classList.toggle("disabled","new"!==this.querySelector("input").value)})},toggleSubmit:function(){this.$id("submit").prop("disabled",0===this.$(".panel.is-expanded").length)},togglePanels:function(){(this.model.get("types")||[]).forEach(function(e){this.expandPanel(e,!1)},this)}})});