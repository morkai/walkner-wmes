// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","../dictionaries","app/kaizenOrders/templates/form"],function(e,s,t,a,i,d,l,r,n,o){"use strict";return l.extend({template:o,events:e.extend({'keydown [role="togglePanel"]':function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),e.currentTarget.click())},'click [role="togglePanel"]':function(e){var s=this.$(e.currentTarget).closest(".panel"),t=s.attr("data-type");s.hasClass("is-collapsed")?this.expandPanel(t):this.collapsePanel(t)}},l.prototype.events),serialize:function(){return e.extend(l.prototype.serialize.call(this),{today:t.format(new Date,"YYYY-MM-DD"),statuses:n.statuses,types:n.types})},afterRender:function(){l.prototype.afterRender.call(this),this.$id("area").select2({allowClear:!0,placeholder:" ",data:n.areas.map(d)}),this.$id("cause").select2({allowClear:!0,placeholder:" ",data:n.causes.map(d)}),this.$id("nearMissCategory").select2({allowClear:!0,placeholder:" ",data:n.categories.where({inNearMiss:!0}).map(d)}),this.$id("suggestionCategory").select2({allowClear:!0,placeholder:" ",data:n.categories.where({inSuggestion:!0}).map(d)}),this.$id("risk").select2({allowClear:!0,placeholder:" ",data:n.risks.map(d)});var e={id:a.data._id,text:a.getLabel()};r(this.$id("nearMissOwners"),{multiple:!0}).select2("data",e),r(this.$id("suggestionOwners"),{multiple:!0}).select2("data",e),r(this.$id("kaizenOwners"),{multiple:!0}).select2("data",e),i.toggle(this.$id("status")),this.$("input[autofocus]").focus()},isPanelExpanded:function(e){return this.$id("panel-"+e).hasClass("is-expanded")},collapsePanel:function(e){var s=this.$id("panel-"+e);return s.removeClass("is-expanded "+s.attr("data-expanded-class")).addClass("panel-default is-collapsed"),this.toggleRequiredFlags(s,!1),("nearMiss"===e||"suggestion"===e)&&this.moveFields(),s.find(".panel-body").stop(!1,!1).slideUp("fast"),s},expandPanel:function(e){var s=this.$id("panel-"+e);return s.removeClass("is-collapsed panel-default").addClass("is-expanded "+s.attr("data-expanded-class")),this.toggleRequiredFlags(s,!0),("nearMiss"===e||"suggestion"===e)&&this.moveFields(),s.find(".panel-body").stop(!1,!1).slideDown("fast",function(){s.find("input, textarea").first().focus()}),s},toggleRequiredFlags:function(e,s){e.find(".is-required").each(function(){this.control.required=s})},moveFields:function(){var e=this.isPanelExpanded("nearMiss"),s=this.isPanelExpanded("suggestion"),t=this.$id("nearMissOwnersFormGroup"),a=this.$id("suggestionOwnersFormGroup"),i=this.$id("eventDateAreaRow"),d=this.$id("descriptionsRow"),l=this.$id("causeCategoryRiskRow"),r=this.$id("suggestionCategoryFormGroup"),n=this.$id("suggestionFormGroup"),o=this.$id("suggestionPanelBody"),c="nearMiss"===i.closest(".panel").attr("data-type");if(e){if(c)return;i.detach(),d.detach(),l.detach(),n.detach(),r.detach(),r.removeClass("col-md-3").appendTo(o),n.removeClass("col-md-4").insertAfter(a),i.insertAfter(t),d.insertAfter(i).find(".col-md-4").removeClass("col-md-4").addClass("col-md-6"),l.insertAfter(d).find(".col-md-3").removeClass("col-md-3").addClass("col-md-4")}else if(s){if(!c)return;i.detach(),d.detach(),l.detach(),n.detach(),r.detach(),i.insertAfter(a),d.insertAfter(i).find(".col-md-6").removeClass("col-md-6").addClass("col-md-4"),n.addClass("col-md-4").appendTo(d),l.insertAfter(d).find(".col-md-4").removeClass("col-md-4").addClass("col-md-3"),r.addClass("col-md-3").appendTo(l)}}})});