define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","../data/localStorage","./dictionaries"],function(t,e,n,r,o,i,s){"use strict";return r.extend({urlRoot:"/kaizen/reports/metrics",nlsDomain:"kaizenOrders",defaults:function(){return{from:0,to:0,interval:"none",sections:[]}},fetch:function(e){return t.isObject(e)||(e={}),e.data=t.assign(e.data||{},t.pick(this.attributes,["from","to","interval","sections"])),e.data.sections=e.data.sections.join(","),r.prototype.fetch.call(this,e)},genClientUrl:function(){return"/kaizenMetricsReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")},getMetricGrouping:function(t){var e=i.getItem("WMES:KAIZEN:METRIC_GROUPING:"+t);return"fte"===t?e||"byCompany":("none"===this.get("interval")?null:e)||"bySection"},setMetricGrouping:function(t,e){i.setItem("WMES:KAIZEN:METRIC_GROUPING:"+t,e),this.trigger("grouping:"+t,e)},parse:function(t){var e={total:t.totals,companies:t.companies};return this.parseMetrics(t,e),this.parseCount(t,e),this.parseUsers(t,e),this.parseFte(t,e),e},parseMetrics:function(t,n){var r=Object.keys(t.sections).filter(function(e){var n=t.bySection[e]||{};return n.ipr||n.ips||n.ipc}).sort(function(t,e){return t.localeCompare(e)}),i=r.map(function(e){return t.sections[e]});["ipr","ips","ipc"].forEach(function(s){if(t.byInterval){var a=[];r.forEach(function(e){a.push({id:e,name:t.sections[e],color:o.getColor("section",e),data:t.byInterval.map(function(t){var n=t.bySection[e];return{x:t.key,y:n?n[s]:0}})})}),n[s]={categories:null,series:a,seriesTotal:[{id:s,name:e.bound("kaizenOrders","report:series:"+s),color:o.getColor("kaizen:metric",s),data:t.byInterval.map(function(t){return{x:t.key,y:t[s]}})}]}}else n[s]={categories:i,series:[{id:s,name:e.bound("kaizenOrders","report:series:"+s),data:r.map(function(e){return{y:t.bySection[e][s],color:o.getColor("section",e)}})}]}})},parseFte:function(t,n){var r=Object.keys(t.sections).filter(function(e){return(t.bySection[e]||{fte:{avg:0}}).fte.avg>0}).sort(function(t,e){return t.localeCompare(e)}),i=Object.keys(t.companies).filter(function(e){return(t.totals.fteByCompany[e]||{total:0}).total>0}).sort(function(t,e){return t.localeCompare(e)}),s=r.map(function(e){return t.sections[e]});n.fte={categories:s,series:i.map(function(e){return{id:e,name:t.companies[e].name,data:r.map(function(n){return{y:t.bySection[n].fteByCompany[e].avg}}),color:t.companies[e].color}}),seriesTotal:[{id:"fte",name:e.bound("kaizenOrders","report:series:fte"),data:r.map(function(e){return{y:t.bySection[e].fte.avg,color:o.getColor("section",e)}})}]}},parseCount:function(t,n){var r=Object.keys(t.sections).filter(function(e){var n=t.bySection[e]||{};return n.nearMissCount||n.suggestionCount||n.observationCount||n.minutesCount}).sort(function(t,e){return t.localeCompare(e)}),o=r.map(function(e){return t.sections[e]});n.count={categories:o,series:["nearMiss","suggestion","observation","minutes"].map(function(n){return{id:n,name:e.bound("kaizenOrders","report:series:"+n),color:s.colors[n],data:r.map(function(e){return{y:t.bySection[e][n+"Count"]}})}})}},parseUsers:function(t,n){var r=Object.keys(t.sections).filter(function(e){return(t.bySection[e]||{}).userCount>0}).sort(function(t,e){return t.localeCompare(e)}),i=r.map(function(e){return t.sections[e]});n.users={categories:i,series:[{id:"users",name:e.bound("kaizenOrders","report:series:users"),data:r.map(function(e){return{y:t.bySection[e].userCount,color:o.getColor("section",e)}})}]}}},{fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=n.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+e.from||void 0,to:+e.to||void 0,interval:e.interval,sections:t.isEmpty(e.sections)?[]:e.sections.split(",")})}})});