// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","./dictionaries"],function(t,e,r,n,o,i){"use strict";return n.extend({urlRoot:"/kaizen/reports/metrics",nlsDomain:"kaizenOrders",defaults:function(){return{from:0,to:0,interval:"none",sections:[]}},fetch:function(e){return t.isObject(e)||(e={}),e.data=t.extend(e.data||{},t.pick(this.attributes,["from","to","interval","sections"])),e.data.sections=e.data.sections.join(","),n.prototype.fetch.call(this,e)},genClientUrl:function(){return"/kaizenMetricsReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")},getMetricGrouping:function(t){return"none"===this.get("interval")?"bySection":localStorage.getItem("WMES:KAIZEN:METRIC_GROUPING:"+t)||"bySection"},setMetricGrouping:function(t,e){localStorage.setItem("WMES:KAIZEN:METRIC_GROUPING:"+t,e),this.trigger("grouping:"+t,e)},parse:function(t){var e={total:t.totals};return this.parseMetrics(t,e),this.parseCount(t,e),this.parseUsers(t,e),this.parseFte(t,e),e},parseMetrics:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{};return r.ipr||r.ips||r.ipc}).sort(function(t,e){return t.localeCompare(e)}),i=n.map(function(e){return t.sections[e]});["ipr","ips","ipc"].forEach(function(s){if(!t.byInterval)return void(r[s]={categories:i,series:[{id:s,name:e.bound("kaizenOrders","report:series:"+s),data:n.map(function(e){return{y:t.bySection[e][s],color:o.getColor("section",e)}})}]});var a=[];n.forEach(function(e){a.push({id:e,name:t.sections[e],color:o.getColor("section",e),data:t.byInterval.map(function(t){var r=t.bySection[e];return{x:t.key,y:r?r[s]:0}})})}),r[s]={categories:null,series:a,seriesTotal:[{id:s,name:e.bound("kaizenOrders","report:series:"+s),color:o.getColor("kaizen:metric",s),data:t.byInterval.map(function(t){return{x:t.key,y:t[s]}})}]}})},parseFte:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{fte:{avg:0}};return r.fte.avg>0}).sort(function(t,e){return t.localeCompare(e)}),i=n.map(function(e){return t.sections[e]});r.fte={categories:i,series:[{id:"fte",name:e.bound("kaizenOrders","report:series:fte"),data:n.map(function(e){return{y:t.bySection[e].fte.avg,color:o.getColor("section",e)}})}]}},parseCount:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{};return r.nearMissCount||r.suggestionCount||r.observationCount||r.minutesCount}).sort(function(t,e){return t.localeCompare(e)}),o=n.map(function(e){return t.sections[e]});r.count={categories:o,series:["nearMiss","suggestion","observation","minutes"].map(function(r){return{id:r,name:e.bound("kaizenOrders","report:series:"+r),color:i.colors[r],data:n.map(function(e){return{y:t.bySection[e][r+"Count"]}})}})}},parseUsers:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{};return r.userCount>0}).sort(function(t,e){return t.localeCompare(e)}),i=n.map(function(e){return t.sections[e]});r.users={categories:i,series:[{id:"users",name:e.bound("kaizenOrders","report:series:users"),data:n.map(function(e){return{y:t.bySection[e].userCount,color:o.getColor("section",e)}})}]}}},{fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=r.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+e.from||void 0,to:+e.to||void 0,interval:e.interval,sections:t.isEmpty(e.sections)?[]:e.sections.split(",")})}})});