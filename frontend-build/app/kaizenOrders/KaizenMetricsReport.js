// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","./dictionaries"],function(t,e,r,n,o,s){"use strict";return n.extend({urlRoot:"/kaizen/reports/metrics",nlsDomain:"kaizenOrders",defaults:function(){return{from:0,to:0,sections:[]}},fetch:function(e){return t.isObject(e)||(e={}),e.data=t.extend(e.data||{},t.pick(this.attributes,["from","to","sections"])),e.data.sections=e.data.sections.join(","),n.prototype.fetch.call(this,e)},genClientUrl:function(){return"/kaizenMetricsReport?from="+this.get("from")+"&to="+this.get("to")+"&sections="+this.get("sections")},parse:function(t){var e={total:t.totals};return this.parseMetrics(t,e),this.parseCount(t,e),this.parseUsers(t,e),this.parseFte(t,e),e},parseMetrics:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{};return r.ipr||r.ips||r.ipc}).sort(function(t,e){return t.localeCompare(e)}),s=n.map(function(e){return t.sections[e]});["ipr","ips","ipc"].forEach(function(i){r[i]={categories:s,series:[{id:i,name:e.bound("kaizenOrders","report:series:"+i),data:n.map(function(e){return{y:t.bySection[e][i],color:o.getColor("section",e)}})}]}})},parseFte:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{fte:{avg:0}};return r.fte.avg>0}).sort(function(t,e){return t.localeCompare(e)}),s=n.map(function(e){return t.sections[e]});r.fte={categories:s,series:[{id:"fte",name:e.bound("kaizenOrders","report:series:fte"),data:n.map(function(e){return{y:t.bySection[e].fte.avg,color:o.getColor("section",e)}})}]}},parseCount:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{};return r.nearMissCount||r.suggestionCount||r.observationCount||r.minutesCount}).sort(function(t,e){return t.localeCompare(e)}),o=n.map(function(e){return t.sections[e]});r.count={categories:o,series:["nearMiss","suggestion","observation","minutes"].map(function(r){return{id:r,name:e.bound("kaizenOrders","report:series:"+r),color:s.colors[r],data:n.map(function(e){return{y:t.bySection[e][r+"Count"]}})}})}},parseUsers:function(t,r){var n=Object.keys(t.sections).filter(function(e){var r=t.bySection[e]||{};return r.userCount>0}).sort(function(t,e){return t.localeCompare(e)}),s=n.map(function(e){return t.sections[e]});r.users={categories:s,series:[{id:"users",name:e.bound("kaizenOrders","report:series:users"),data:n.map(function(e){return{y:t.bySection[e].userCount,color:o.getColor("section",e)}})}]}}},{fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=r.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+e.from||void 0,to:+e.to||void 0,sections:t.isEmpty(e.sections)?[]:e.sections.split(",")})}})});