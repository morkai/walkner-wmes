define(["jquery","../broker","../pubsub","../user","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection","../kaizenBehaviours/KaizenBehaviourCollection","../kaizenProductFamilies/KaizenProductFamilyCollection"],function(e,s,i,n,a,r,o,t,u,l,c){"use strict";var d={section:"sections",area:"areas",nearMissCategory:"categories",suggestionCategory:"categories",category:"categories",cause:"causes",risk:"risks",behaviour:"behaviours",productFamily:"productFamilies"},b=null,k=null,f=null,g=null,z=null,y={multiType:!!window.KAIZEN_MULTI,colors:{nearMiss:"#d9534f",suggestion:"#f0ad4e",kaizen:"#5cb85c",observation:"#31b0d5",minutes:"#5cb85c"},types:[],statuses:[],sections:new a,areas:new r,categories:new o,causes:new t,risks:new u,behaviours:new l,productFamilies:new c,loaded:!1,load:function(){return null!==k&&(clearTimeout(k),k=null),y.loaded?null:null!==b?b:((b=e.ajax({url:"/kaizen/dictionaries"})).done(function(e){y.loaded=!0,y.types=e.types,y.statuses=e.statuses,p(e)}),b.fail(h),b.always(function(){b=null}),(f=i.sandbox()).subscribe("kaizen.sections.**",v),f.subscribe("kaizen.areas.**",v),f.subscribe("kaizen.categories.**",v),f.subscribe("kaizen.causes.**",v),f.subscribe("kaizen.risks.**",v),f.subscribe("kaizen.productFamilies.**",v),f.subscribe("kaizen.behaviours.**",v),m(),b)},unload:function(){null!==k&&clearTimeout(k),k=setTimeout(h,3e4)},getLabel:function(e,s){if("string"==typeof e&&(e=this.forProperty(e)||y[e]),!e||Array.isArray(e))return s;var i=e.get(s);return i?i.getLabel():s},forProperty:function(e){return this[d[e]]||null}};function p(e){["sections","areas","categories","causes","risks","productFamilies","behaviours"].forEach(function(s){y[s].reset(e?e[s]:[])})}function m(){f&&(g=f.subscribe("kaizen.orders.seen."+n.data._id,C),z=f.subscribe("suggestions.seen."+n.data._id,w))}function h(){k=null,null!==f&&(f.destroy(),f=null,g=null,z=null),y.loaded=!1,y.types=[],y.statuses=[],p()}function v(e,i){var n=i.split("."),a=y[n[1]];if(a){switch(n[2]){case"added":a.add(e.model);break;case"edited":var r=a.get(e.model._id);r&&r.set(e.model);break;case"deleted":a.remove(a.get(e.model._id))}s.publish(i,e)}}function C(e){s.publish("kaizen.orders.seen",e.orderId)}function w(e){s.publish("suggestions.seen",e.orderId)}return s.subscribe("user.reloaded",function(){g&&(g.cancel(),g=null),z&&(z.cancel(),z=null),m()}),y});