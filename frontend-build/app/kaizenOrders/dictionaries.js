define(["jquery","../broker","../pubsub","../user","../data/createSettings","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection","../kaizenBehaviours/KaizenBehaviourCollection","../kaizenProductFamilies/KaizenProductFamilyCollection","./KaizenSettingCollection"],function(e,s,n,i,t,a,o,r,u,l,c,d,g){"use strict";var b=["sections","areas","categories","causes","risks","productFamilies","behaviours"],f={section:"sections",area:"areas",nearMissCategory:"categories",suggestionCategory:"categories",category:"categories",cause:"causes",risk:"risks",behaviour:"behaviours",productFamily:"productFamilies"},k=null,z=null,m=null,y=null,p=null,h=t(g),C={multiType:!!window.KAIZEN_MULTI,colors:{nearMiss:"#d9534f",suggestion:"#f0ad4e",kaizen:"#5cb85c",observation:"#31b0d5",minutes:"#5cb85c"},settings:h.acquire(),types:[],nmStatuses:[],kzStatuses:[],sections:new a,areas:new o,categories:new r,causes:new u,risks:new l,behaviours:new c,productFamilies:new d,loaded:!1,load:function(){return null!==z&&(clearTimeout(z),z=null),C.loaded?null:null!==k?k:((k=e.ajax({url:"/kaizen/dictionaries"})).done(function(e){C.loaded=!0,v(e)}),k.fail(w),k.always(function(){k=null}),m=n.sandbox(),b.forEach(function(e){m.subscribe("kaizen."+e+".**",K)}),S(),k)},unload:function(){null!==z&&clearTimeout(z),z=setTimeout(w,3e4)},getLabel:function(e,s){if("string"==typeof e&&(e=this.forProperty(e)||C[e]),!e||Array.isArray(e))return s;var n=e.get(s);return n?n.getLabel():s},forProperty:function(e){return this[f[e]]||null}};function v(e){b.forEach(function(s){C[s].reset(e?e[s]:[])}),C.types=e?e.types:[],C.nmStatuses=e?e.nmStatuses:[],C.kzStatuses=e?e.kzStatuses:[],C.settings.reset(e?e.settings:[])}function S(){m&&(y=m.subscribe("kaizen.orders.seen."+i.data._id,F),p=m.subscribe("suggestions.seen."+i.data._id,A))}function w(){z=null,null!==m&&(m.destroy(),m=null,y=null,p=null),C.loaded=!1,C.types=[],C.nmStatuses=[],C.kzStatuses=[],v(),h.release()}function K(e,n){var i=n.split("."),t=C[i[1]];if(t){switch(i[2]){case"added":t.add(e.model);break;case"edited":var a=t.get(e.model._id);a&&a.set(e.model);break;case"deleted":t.remove(t.get(e.model._id))}s.publish(n,e)}}function F(e){s.publish("kaizen.orders.seen",e.orderId)}function A(e){s.publish("suggestions.seen",e.orderId)}return s.subscribe("user.reloaded",function(){y&&(y.cancel(),y=null),p&&(p.cancel(),p=null),S()}),C});