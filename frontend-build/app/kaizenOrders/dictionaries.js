// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","../broker","../pubsub","../user","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection","../kaizenProductFamilies/KaizenProductFamilyCollection"],function(e,s,i,n,a,t,r,o,u,l){"use strict";function c(e){["sections","areas","categories","causes","risks","productFamilies"].forEach(function(s){h[s].reset(e?e[s]:[])})}function d(){m&&(C=m.subscribe("kaizen.orders.seen."+n.data._id,f),w=m.subscribe("suggestions.seen."+n.data._id,g))}function b(){p=null,null!==m&&(m.destroy(),m=null,C=null,w=null),h.loaded=!1,h.types=[],h.statuses=[],c()}function k(e,i){var n=i.split("."),a=h[n[1]];if(a){switch(n[2]){case"added":a.add(e.model);break;case"edited":var t=a.get(e.model._id);t&&t.set(e.model);break;case"deleted":a.remove(a.get(e.model._id))}s.publish(i,e)}}function f(e){s.publish("kaizen.orders.seen",e.orderId)}function g(e){s.publish("suggestions.seen",e.orderId)}var z={section:"sections",area:"areas",nearMissCategory:"categories",suggestionCategory:"categories",category:"categories",cause:"causes",risk:"risks",productFamily:"productFamilies"},y=null,p=null,m=null,C=null,w=null,h={multiType:!!window.KAIZEN_MULTI,types:[],statuses:[],sections:new a,areas:new t,categories:new r,causes:new o,risks:new u,productFamilies:new l,loaded:!1,load:function(){return null!==p&&(clearTimeout(p),p=null),h.loaded?null:null!==y?y:(y=e.ajax({url:"/kaizen/dictionaries"}),y.done(function(e){h.loaded=!0,h.types=e.types,h.statuses=e.statuses,c(e)}),y.fail(b),y.always(function(){y=null}),m=i.sandbox(),m.subscribe("kaizen.sections.**",k),m.subscribe("kaizen.areas.**",k),m.subscribe("kaizen.categories.**",k),m.subscribe("kaizen.causes.**",k),m.subscribe("kaizen.risks.**",k),m.subscribe("kaizen.productFamilies.**",k),d(),y)},unload:function(){null!==p&&clearTimeout(p),p=setTimeout(b,3e4)},getLabel:function(e,s){if("string"==typeof e&&(e=this.forProperty(e)||h[e]),!e||Array.isArray(e))return s;var i=e.get(s);return i?i.getLabel():s},forProperty:function(e){return this[z[e]]||null}};return s.subscribe("user.reloaded",function(){C&&(C.cancel(),C=null),w&&(w.cancel(),w=null),d()}),h});