define(["jquery","../broker","../pubsub","../user","../data/createSettings","../data/companies","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection","../kaizenBehaviours/KaizenBehaviourCollection","../kaizenProductFamilies/KaizenProductFamilyCollection","./KaizenSettingCollection"],function(e,n,s,i,a,t,o,r,u,l,c,d,b,f){"use strict";var g=["sections","areas","categories","causes","risks","productFamilies","behaviours"],k={section:"sections",area:"areas",nearMissCategory:"categories",suggestionCategory:"categories",category:"categories",cause:"causes",risk:"risks",behaviour:"behaviours",productFamily:"productFamilies",company:"companies"},m=null,z=null,p=null,y=null,h=null,v=a(f),C={multiType:!!window.KAIZEN_MULTI,colors:{nearMiss:"#d9534f",suggestion:"#f0ad4e",kaizen:"#5cb85c",observation:"#31b0d5",minutes:"#5cb85c"},settings:v.acquire(),types:[],nmStatuses:[],kzStatuses:[],sections:new o,areas:new r,categories:new u,causes:new l,risks:new c,behaviours:new d,productFamilies:new b,companies:t,loaded:!1,load:function(){return null!==z&&(clearTimeout(z),z=null),C.loaded?null:null!==m?m:((m=e.ajax({url:"/kaizen/dictionaries"})).done(function(e){C.loaded=!0,S(e)}),m.fail(K),m.always(function(){m=null}),p=s.sandbox(),g.forEach(function(e){p.subscribe("kaizen."+e+".**",F)}),w(),m)},unload:function(){null!==z&&clearTimeout(z),z=setTimeout(K,3e4)},getLabel:function(e,n){if("string"==typeof e&&(e=this.forProperty(e)),!e||Array.isArray(e))return n;var s=e.get(n);return s?s.getLabel():n},forProperty:function(e){return this[k[e]]||this[e]||null},bind:function(e){var n=this;return e.on("beforeLoad",function(e,s){s.push(n.load())}),e.on("afterRender",n.load.bind(n)),e.once("remove",n.unload.bind(n)),e}};function S(e){g.forEach(function(n){C[n].reset(e?e[n]:[])}),C.types=e?e.types:[],C.nmStatuses=e?e.nmStatuses:[],C.kzStatuses=e?e.kzStatuses:[],C.settings.reset(e?e.settings:[])}function w(){p&&(y=p.subscribe("kaizen.orders.seen."+i.data._id,A),h=p.subscribe("suggestions.seen."+i.data._id,T))}function K(){z=null,null!==p&&(p.destroy(),p=null,y=null,h=null),C.loaded=!1,C.types=[],C.nmStatuses=[],C.kzStatuses=[],S(),v.release()}function F(e,s){var i=s.split("."),a=C[i[1]];if(a){switch(i[2]){case"added":a.add(e.model);break;case"edited":var t=a.get(e.model._id);t&&t.set(e.model);break;case"deleted":a.remove(a.get(e.model._id))}n.publish(s,e)}}function A(e){n.publish("kaizen.orders.seen",e.orderId)}function T(e){n.publish("suggestions.seen",e.orderId)}return n.subscribe("user.reloaded",function(){y&&(y.cancel(),y=null),h&&(h.cancel(),h=null),w()}),C});