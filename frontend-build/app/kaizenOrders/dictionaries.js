// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../broker","../pubsub","../user","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection","../kaizenBehaviours/KaizenBehaviourCollection","../kaizenProductFamilies/KaizenProductFamilyCollection"],function(e,s,i,n,a,r,o,t,u,l,c){"use strict";function d(e){["sections","areas","categories","causes","risks","productFamilies","behaviours"].forEach(function(s){w[s].reset(e?e[s]:[])})}function b(){h&&(C=h.subscribe("kaizen.orders.seen."+n.data._id,f),v=h.subscribe("suggestions.seen."+n.data._id,g))}function k(){m=null,null!==h&&(h.destroy(),h=null,C=null,v=null),w.loaded=!1,w.types=[],w.statuses=[],d()}function z(e,i){var n=i.split("."),a=w[n[1]];if(a){switch(n[2]){case"added":a.add(e.model);break;case"edited":var r=a.get(e.model._id);r&&r.set(e.model);break;case"deleted":a.remove(a.get(e.model._id))}s.publish(i,e)}}function f(e){s.publish("kaizen.orders.seen",e.orderId)}function g(e){s.publish("suggestions.seen",e.orderId)}var y={section:"sections",area:"areas",nearMissCategory:"categories",suggestionCategory:"categories",category:"categories",cause:"causes",risk:"risks",behaviour:"behaviours",productFamily:"productFamilies"},p=null,m=null,h=null,C=null,v=null,w={multiType:!!window.KAIZEN_MULTI,types:[],statuses:[],sections:new a,areas:new r,categories:new o,causes:new t,risks:new u,behaviours:new l,productFamilies:new c,loaded:!1,load:function(){return null!==m&&(clearTimeout(m),m=null),w.loaded?null:null!==p?p:(p=e.ajax({url:"/kaizen/dictionaries"}),p.done(function(e){w.loaded=!0,w.types=e.types,w.statuses=e.statuses,d(e)}),p.fail(k),p.always(function(){p=null}),h=i.sandbox(),h.subscribe("kaizen.sections.**",z),h.subscribe("kaizen.areas.**",z),h.subscribe("kaizen.categories.**",z),h.subscribe("kaizen.causes.**",z),h.subscribe("kaizen.risks.**",z),h.subscribe("kaizen.productFamilies.**",z),h.subscribe("kaizen.behaviours.**",z),b(),p)},unload:function(){null!==m&&clearTimeout(m),m=setTimeout(k,3e4)},getLabel:function(e,s){if("string"==typeof e&&(e=this.forProperty(e)||w[e]),!e||Array.isArray(e))return s;var i=e.get(s);return i?i.getLabel():s},forProperty:function(e){return this[y[e]]||null}};return s.subscribe("user.reloaded",function(){C&&(C.cancel(),C=null),v&&(v.cancel(),v=null),b()}),w});