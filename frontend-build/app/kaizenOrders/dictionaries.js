// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","../broker","../pubsub","../user","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection"],function(e,s,n,i,a,t,r,l,u){"use strict";function o(){k=null,null!==z&&(z.destroy(),z=null,f=null),g.loaded=!1,g.types=[],g.statuses=[],g.sections.reset(),g.areas.reset(),g.categories.reset(),g.causes.reset(),g.risks.reset()}function c(e,n){var i=n.split("."),a=g[i[1]];if(a){switch(i[1]){case"added":a.add(e.model);break;case"edited":var t=a.get(e.model._id);t&&t.set(e.model);break;case"deleted":a.remove(a.get(e.model._id))}s.publish(n,e)}}function d(e){s.publish("kaizen.orders.seen",e.orderId)}var b=null,k=null,z=null,f=null,g={multiType:!!window.KAIZEN_MULTI,types:[],statuses:[],sections:new a,areas:new t,categories:new r,causes:new l,risks:new u,loaded:!1,load:function(){return null!==k&&(clearTimeout(k),k=null),g.loaded?null:null!==b?b:(b=e.ajax({url:"/kaizen/dictionaries"}),b.done(function(e){g.loaded=!0,g.types=e.types,g.statuses=e.statuses,g.sections.reset(e.sections),g.areas.reset(e.areas),g.categories.reset(e.categories),g.causes.reset(e.causes),g.risks.reset(e.risks)}),b.fail(o),b.always(function(){b=null}),z=n.sandbox(),z.subscribe("kaizen.sections.**",c),z.subscribe("kaizen.areas.**",c),z.subscribe("kaizen.categories.**",c),z.subscribe("kaizen.causes.**",c),z.subscribe("kaizen.risks.**",c),f=z.subscribe("kaizen.orders.seen."+i.data._id,d),b)},unload:function(){null!==k&&clearTimeout(k),k=setTimeout(o,3e4)},getLabel:function(e,s){if(!g[e])return s;var n=g[e].get(s);return n?n.getLabel():s}};return s.subscribe("user.reloaded",function(){f&&(f.cancel(),f=null),z&&(f=z.subscribe("kaizen.orders.seen."+i.data._id,d))}),g});