define(["jquery","../broker","../pubsub","../user","../data/createSettings","../data/companies","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection","../kaizenBehaviours/KaizenBehaviourCollection","../kaizenProductFamilies/KaizenProductFamilyCollection","../kaizenTopics/KaizenTopicCollection","../kaizenControlLists/KaizenControlListCollection","../kaizenControlCategories/KaizenControlCategoryCollection","./KaizenSettingCollection"],function(e,n,i,o,t,s,a,r,l,u,c,d,g,f,z,k,p){"use strict";var b=["sections","areas","categories","causes","risks","productFamilies","behaviours","topics","controlLists","controlCategories"],m={section:"sections",area:"areas",nearMissCategory:"categories",suggestionCategory:"categories",category:"categories",cause:"causes",risk:"risks",behaviour:"behaviours",productFamily:"productFamilies",company:"companies",topic:"topics",controlList:"controlLists",controlCategory:"controlCategories"},C=null,y=null,_=null,h=null,w=null,v=null,S=t(p),K={multiType:!!window.KAIZEN_MULTI,colors:{nearMiss:"#d9534f",suggestion:"#f0ad4e",kaizen:"#5cb85c",observation:"#31b0d5",minutes:"#5cb85c"},settings:S.acquire(),types:[],nmStatuses:[],kzStatuses:[],sections:new a,areas:new r,categories:new l,causes:new u,risks:new c,behaviours:new d,productFamilies:new g,topics:new f,controlLists:new z,controlCategories:new k,companies:s,loaded:!1,load:function(){return null!==y&&(clearTimeout(y),y=null),K.loaded?null:null!==C?C:((C=e.ajax({url:"/kaizen/dictionaries"})).done(function(e){K.loaded=!0,L(e)}),C.fail(A),C.always(function(){C=null}),_=i.sandbox(),b.forEach(function(e){_.subscribe("kaizen."+e+".**",F)}),T(),C)},unload:function(){null!==y&&clearTimeout(y),y=setTimeout(A,3e4)},getLabel:function(e,n){if("string"==typeof e&&(e=this.forProperty(e)),!e||Array.isArray(e))return n;var i=e.get(n);return i?i.getLabel():n},forProperty:function(e){return this[m[e]]||this[e]||null},bind:function(e){var n=this;return e.__kaizenDictionariesBound__?e:(e.__kaizenDictionariesBound__=!0,e.on("beforeLoad",function(e,i){i.push({priority:!0,promise:n.load()})}),e.on("afterRender",function(){n.load()}),e.once("remove",function(){n.unload(),e.__kaizenDictionariesBound__=!1}),e)},isAuditor:function(){return null===v&&(v=o.isAllowedTo("OSH_AUDITS:AUDITOR")||K.sections.some(e=>e.get("auditors").some(e=>e.id===o.data._id))),v}};function L(e){b.forEach(function(n){K[n].reset(e?e[n]:[])}),K.types=e?e.types:[],K.nmStatuses=e?e.nmStatuses:[],K.kzStatuses=e?e.kzStatuses:[],K.settings.reset(e?e.settings:[])}function T(){_&&(h=_.subscribe("kaizen.orders.seen."+o.data._id,I),w=_.subscribe("suggestions.seen."+o.data._id,B))}function A(){y=null,null!==_&&(_.destroy(),_=null,h=null,w=null),K.loaded=!1,K.types=[],K.nmStatuses=[],K.kzStatuses=[],L(),S.release()}function F(e,i){var o=i.split("."),t=K[o[1]];if(t){switch(o[2]){case"added":t.add(e.model);break;case"edited":var s=t.get(e.model._id);s&&s.set(e.model);break;case"deleted":t.remove(t.get(e.model._id))}n.publish(i,e)}}function I(e){n.publish("kaizen.orders.seen",e.orderId)}function B(e){n.publish("suggestions.seen",e.orderId)}return n.subscribe("user.reloaded",function(){h&&(h.cancel(),h=null),w&&(w.cancel(),w=null),T()}),K.sections.on("reset change:auditors",function(){v=null}),K});