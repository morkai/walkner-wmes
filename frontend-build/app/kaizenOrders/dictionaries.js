define(["jquery","../broker","../pubsub","../user","../data/createSettings","../kaizenSections/KaizenSectionCollection","../kaizenAreas/KaizenAreaCollection","../kaizenCategories/KaizenCategoryCollection","../kaizenCauses/KaizenCauseCollection","../kaizenRisks/KaizenRiskCollection","../kaizenBehaviours/KaizenBehaviourCollection","../kaizenProductFamilies/KaizenProductFamilyCollection","./KaizenSettingCollection"],function(e,n,s,i,t,a,o,r,u,l,c,d,b){"use strict";var f=["sections","areas","categories","causes","risks","productFamilies","behaviours"],g={section:"sections",area:"areas",nearMissCategory:"categories",suggestionCategory:"categories",category:"categories",cause:"causes",risk:"risks",behaviour:"behaviours",productFamily:"productFamilies"},k=null,z=null,m=null,y=null,p=null,h=t(b),v={multiType:!!window.KAIZEN_MULTI,colors:{nearMiss:"#d9534f",suggestion:"#f0ad4e",kaizen:"#5cb85c",observation:"#31b0d5",minutes:"#5cb85c"},settings:h.acquire(),types:[],nmStatuses:[],kzStatuses:[],sections:new a,areas:new o,categories:new r,causes:new u,risks:new l,behaviours:new c,productFamilies:new d,loaded:!1,load:function(){return null!==z&&(clearTimeout(z),z=null),v.loaded?null:null!==k?k:((k=e.ajax({url:"/kaizen/dictionaries"})).done(function(e){v.loaded=!0,C(e)}),k.fail(w),k.always(function(){k=null}),m=s.sandbox(),f.forEach(function(e){m.subscribe("kaizen."+e+".**",K)}),S(),k)},unload:function(){null!==z&&clearTimeout(z),z=setTimeout(w,3e4)},getLabel:function(e,n){if("string"==typeof e&&(e=this.forProperty(e)||v[e]),!e||Array.isArray(e))return n;var s=e.get(n);return s?s.getLabel():n},forProperty:function(e){return this[g[e]]||null},bind:function(e){var n=this;return e.on("beforeLoad",function(e,s){s.push(n.load())}),e.on("afterRender",n.load.bind(n)),e.once("remove",n.unload.bind(n)),e}};function C(e){f.forEach(function(n){v[n].reset(e?e[n]:[])}),v.types=e?e.types:[],v.nmStatuses=e?e.nmStatuses:[],v.kzStatuses=e?e.kzStatuses:[],v.settings.reset(e?e.settings:[])}function S(){m&&(y=m.subscribe("kaizen.orders.seen."+i.data._id,F),p=m.subscribe("suggestions.seen."+i.data._id,A))}function w(){z=null,null!==m&&(m.destroy(),m=null,y=null,p=null),v.loaded=!1,v.types=[],v.nmStatuses=[],v.kzStatuses=[],C(),h.release()}function K(e,s){var i=s.split("."),t=v[i[1]];if(t){switch(i[2]){case"added":t.add(e.model);break;case"edited":var a=t.get(e.model._id);a&&a.set(e.model);break;case"deleted":t.remove(t.get(e.model._id))}n.publish(s,e)}}function F(e){n.publish("kaizen.orders.seen",e.orderId)}function A(e){n.publish("suggestions.seen",e.orderId)}return n.subscribe("user.reloaded",function(){y&&(y.cancel(),y=null),p&&(p.cancel(),p=null),S()}),v});