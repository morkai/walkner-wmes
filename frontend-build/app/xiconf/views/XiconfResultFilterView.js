// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/time","app/core/views/FilterView","app/xiconf/templates/filter"],function(e,t,r){"use strict";return t.extend({template:r,defaultFormData:function(){return{from:"",to:"",srcId:"",serviceTag:"",orderNo:"",nc12Type:"program",nc12:"",result:["success","failure"]}},termToForm:{startedAt:function(t,r,s){var a="datetime-local"===this.$id("from").prop("type")?"YYYY-MM-DDTHH:mm:ss":"YYYY-MM-DD HH:mm";s["ge"===r.name?"from":"to"]=e.format(r.args[1],a)},orderNo:function(e,t,r){r[e]=t.args[1].replace(/[^0-9]/g,"")},result:function(e,t,r){("success"===t.args[1]||"failure"===t.args[1])&&(r.result=[t.args[1]])},nc12:function(e,t,r){r.nc12Type="program",r.nc12=t.args[1].replace(/[^0-9A-Z]/g,"")},"program._id":function(e,t,r){r.nc12Type="program",r.nc12=t.args[1].replace(/[^0-9A-Za-z]/g,"")},"leds.nc12":function(e,t,r){r.nc12Type="led",r.nc12=t.args[1].replace(/[^0-9A-Z]/g,"")},srcId:function(e,t,r){r[e]=t.args[1]},serviceTag:"srcId"},initialize:function(){this.collection&&this.listenTo(this.collection,"change:srcIds",this.setUpSrcIdSelect2)},afterRender:function(){t.prototype.afterRender.call(this),1===this.formData.result.length?this.$(".xiconf-filter-"+this.formData.result[0]).addClass("active"):this.$(".xiconf-filter-result > label").addClass("active"),this.setUpSrcIdSelect2()},setUpSrcIdSelect2:function(){this.$id("srcId").select2({width:"200px",allowClear:!0,data:(this.collection.srcIds||[]).map(function(e){return{id:e,text:e}})})},serializeFormToQuery:function(t){var r=e.getMoment(this.$id("from").val()),s=e.getMoment(this.$id("to").val()),a=this.$('input[name="nc12Type"]:checked').val(),i=this.$id("nc12").val().trim(),n=this.$id("serviceTag").val().trim(),c=this.$id("srcId").val(),l=this.$('input[name="result[]"]:checked');if(c.length&&t.push({name:"eq",args:["srcId",c]}),this.serializeRegexTerm(t,"orderNo",9,null,!1,!0),/^[0-9A-Z]{9,}$/.test(i)){var o="led"===a?"leds.nc12":/[A-Z]/.test(i)?"program._id":"nc12";12===i.length?t.push({name:"eq",args:[o,i]}):t.push({name:"regex",args:[o,"^"+i]})}/^P[0-9]+$/.test(n)&&t.push({name:"eq",args:["serviceTag",n]}),r.isValid()&&t.push({name:"ge",args:["startedAt",r.valueOf()]}),s.isValid()&&t.push({name:"lt",args:["startedAt",s.valueOf()]}),1===l.length&&t.push({name:"eq",args:["result",l.val()]})}})});