// Copyright (c) 2014, Łukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","highlight","app/i18n","app/highcharts","app/core/View","app/xiconf/views/ProgramStepsView","app/xiconf/templates/details"],function(t,e,i,r,n,a,s){return n.extend({template:s,events:{"click .history-tabs a":function(t){t.preventDefault();var e=this.$(t.target).tab("show").parent().attr("data-tab");this.broker.publish("router.navigate",{url:this.model.genClientUrl()+"?tab="+e,trigger:!1,replace:!0})},"shown.bs.tab":function(t){var e=t.target.parentNode.dataset.tab;"feature"===e?this.highlightFeature():"program"===e&&this.renderMetrics()}},initialize:function(){this.featureHighlighted=!1,this.metricsChart=null,this.setView(".xiconf-details-steps",new a({model:this.model}))},destroy:function(){null!==this.metricsChart&&(this.metricsChart.destroy(),this.metricsChart=null)},serialize:function(){return{idPrefix:this.idPrefix,model:this.model.toJSON(),log:this.model.getDecoratedLog()}},beforeRender:function(){this.featureHighlighted=!1,null!==this.metricsChart&&(this.metricsChart.destroy(),this.metricsChart=null),this.stopListening(this.model,"change",this.render)},afterRender:function(){this.listenTo(this.model,"change",this.render),this.activateTab(this.options.tab||"log")},activateTab:function(t){this.$('.nav-tabs > li[data-tab="'+t+'"] > a').tab("show")},highlightFeature:function(){this.featureHighlighted||(this.model.hasFeatureData()&&e.highlightBlock(this.$id("feature").find("code")[0]),this.featureHighlighted=!0)},renderMetrics:function(){if(null!==this.metricsChart)return void this.metricsChart.reflow();var t=this.model.get("metrics")||{uSet:[],uGet:[],i:[]},e={uSet:t.uSet,uGet:t.uGet,i:t.i,r:t.uGet.map(function(e,i){return t.i[i]?e/t.i[i]:0}),p:t.uGet.map(function(e,i){return t.i[i]?e*t.i[i]:0})};this.metricsChart=new r.Chart({chart:{renderTo:this.el.querySelector(".xiconf-details-metrics"),zoomType:"x",height:400},title:{text:i("xiconf","metrics:title")},noData:{},xAxis:{type:"category"},yAxis:[{title:{text:i("xiconf","metrics:u")},tickAmount:6},{title:{text:i("xiconf","metrics:i")},tickAmount:6},{title:{text:i("xiconf","metrics:r")},opposite:!0,tickAmount:6},{title:{text:i("xiconf","metrics:p")},opposite:!0,tickAmount:6}],tooltip:{shared:!0,valueDecimals:2},legend:{enabled:!0},plotOptions:{line:{lineWidth:1.5,pointInterval:1,pointStart:0,marker:{radius:0,symbol:"circle",lineWidth:0,states:{hover:{radius:4}}}}},series:[{id:"uSet",name:i.bound("xiconf","metrics:uSet"),type:"line",yAxis:0,data:e.uSet,min:0,tooltip:{valueSuffix:"V"},zIndex:1},{id:"uGet",name:i.bound("xiconf","metrics:uGet"),type:"line",yAxis:0,data:e.uGet,min:0,tooltip:{valueSuffix:"V"},zIndex:2},{id:"i",name:i.bound("xiconf","metrics:i"),type:"line",yAxis:1,data:e.i,min:0,tooltip:{valueSuffix:"A"},zIndex:3},{id:"r",name:i.bound("xiconf","metrics:r"),type:"line",yAxis:2,data:e.r,min:0,tooltip:{valueSuffix:"Ω"},zIndex:4},{id:"p",name:i.bound("xiconf","metrics:p"),type:"line",yAxis:3,data:e.p,min:0,tooltip:{valueSuffix:"W"},zIndex:5}]})}})});