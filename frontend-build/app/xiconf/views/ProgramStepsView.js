// Copyright (c) 2014, Łukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/time","app/core/View","app/xiconf/templates/programSteps"],function(e,t,a,r){"use strict";return a.extend({template:r,serialize:function(){return{idPrefix:this.idPrefix,steps:this.serializeSteps()}},serializeSteps:function(){var e=this.model.get("program");return e?e.steps.map(this.serializeStep,this).filter(function(e){return null!==e}):[]},serializeStep:function(e,a){if(!e.enabled)return null;var r=(this.model.get("steps")||[])[a],s={index:a,type:e.type,progressBarWidth:"0%",stepClassName:"is-idle",progressBarClassName:"progress-bar-default",value:"",unit:null,minValue:null,maxValue:null};switch(r&&(s.value=this.prepareStepValue(r.value),s.progressBarWidth=r.progress+"%",s.stepClassName="is-"+r.status,s.progressBarClassName=this.getProgressBarClassName(r.status)),e.type){case"pe":s.unit="Ω",s.maxValue=e.resistanceMax.toLocaleString(),s.totalTime=t.toString(e.startTime+e.duration),s.voltage=e.voltage.toLocaleString(),s.resistanceMax=s.maxValue;break;case"sol":s.unit="V",s.voltage=e.voltage.toLocaleString();break;case"fn":s.unit="W",s.minValue=e.powerMin.toLocaleString(),s.maxValue=e.powerMax.toLocaleString(),s.totalTime=t.toString(e.startTime+e.duration),s.voltage=e.voltage.toLocaleString(),s.powerReq=e.powerReq.toLocaleString(),s.powerMin=s.minValue,s.powerMax=s.maxValue;break;case"wait":s.value="",s.voltage=e.voltage.toLocaleString(),"auto"===e.kind&&(s.totalTime=t.toString(e.duration))}return s},getProgressBarClassName:function(e){var t="success"===e?"progress-bar-success":"failure"===e?"progress-bar-danger":"";return"active"===e&&(t+=" progress-bar-striped active"),t},prepareStepValue:function(e){return e?(e>9999&&(e=9999),e.toLocaleString().replace(/\s+/g,"").substr(0,4).replace(/(\.|,)$/,"")):"0"}})});