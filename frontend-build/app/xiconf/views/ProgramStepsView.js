// Copyright (c) 2014, Łukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/time","app/core/View","app/xiconf/templates/programSteps"],function(e,t,a){"use strict";return t.extend({template:a,serialize:function(){return{idPrefix:this.idPrefix,steps:this.serializeSteps()}},serializeSteps:function(){var e=this.model.get("program");return e?e.steps.map(this.serializeStep,this).filter(function(e){return null!==e}):[]},serializeStep:function(t,a){if(!t.enabled)return null;var r=(this.model.get("steps")||[])[a],s={index:a,type:t.type,progressBarWidth:"0%",stepClassName:"is-idle",progressBarClassName:"progress-bar-default",value:"",unit:null,minValue:null,maxValue:null};switch(r&&(s.value=this.prepareStepValue(r.value),s.progressBarWidth=r.progress+"%",s.stepClassName="is-"+r.status,s.progressBarClassName=this.getProgressBarClassName(r.status)),t.type){case"pe":s.unit="Ω",s.maxValue=t.resistanceMax.toLocaleString(),s.totalTime=e.toString(t.startTime+t.duration),s.voltage=t.voltage.toLocaleString(),s.resistanceMax=s.maxValue;break;case"sol":s.unit="V",s.voltage=t.voltage.toLocaleString();break;case"fn":s.unit="W",s.minValue=t.powerMin.toLocaleString(),s.maxValue=t.powerMax.toLocaleString(),s.totalTime=e.toString(t.startTime+t.duration),s.voltage=t.voltage.toLocaleString(),s.powerReq=t.powerReq.toLocaleString(),s.powerMin=s.minValue,s.powerMax=s.maxValue}return s},getProgressBarClassName:function(e){var t="success"===e?"progress-bar-success":"failure"===e?"progress-bar-danger":"";return"active"===e&&(t+=" progress-bar-striped active"),t},prepareStepValue:function(e){return e?(e>9999&&(e=9999),e.toLocaleString().replace(/\s+/g,"").substr(0,4).replace(/(\.|,)$/,"")):"0"}})});