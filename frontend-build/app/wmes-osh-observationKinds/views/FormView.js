define(["jquery","app/core/views/FormView","app/wmes-osh-common/dictionaries","app/wmes-osh-observationKinds/templates/form","app/wmes-osh-observationKinds/templates/formCategoryRow"],function(t,e,i,o,n){"use strict";return e.extend({template:o,events:Object.assign({"change #-addCategory-behaviors":function(t){t.added&&(this.addCategory("behaviors",t.added.id),this.setUpAddCategorySelect2("behaviors"))},"change #-addCategory-workConditions":function(t){t.added&&(this.addCategory("workConditions",t.added.id),this.setUpAddCategorySelect2("workConditions"))},'click .btn[data-action="up"]':function(t){const e=this.$(t.currentTarget).closest("tr");e.prev().length?e.insertBefore(e.prev()):e.insertAfter(e.parent().children().last()),t.currentTarget.focus()},'click .btn[data-action="down"]':function(t){const e=this.$(t.currentTarget).closest("tr");e.next().length?e.insertAfter(e.next()):e.insertBefore(e.parent().children().first()),t.currentTarget.focus()},'click .btn[data-action="remove"]':function(e){this.$(e.currentTarget).closest("tr").fadeOut("fast",function(){t(this).remove()})}},e.prototype.events),initialize:function(){e.prototype.initialize.apply(this,arguments),this.categoryI=0},afterRender:function(){e.prototype.afterRender.apply(this,arguments),this.options.editMode&&((this.model.get("behaviors")||[]).forEach(this.addCategory.bind(this,"behaviors")),(this.model.get("workConditions")||[]).forEach(this.addCategory.bind(this,"workConditions"))),this.setUpAddCategorySelect2("behaviors"),this.setUpAddCategorySelect2("workConditions")},setUpAddCategorySelect2:function(t){const e=this.$id(`addCategory-${t}`).val(""),o=new Set;this.$id(t).find('input[type="hidden"]').each(function(){o.add(+this.value)}),e.select2({width:"100%",placeholder:this.t("FORM:categories:add"),data:i.observationCategories.filter(t=>t.get("active")&&!o.has(t.id)).map(t=>({id:t.id,text:t.getLabel({long:!0})}))})},addCategory:function(t,e){const o=i.observationCategories.get(e);this.$id(t).append(this.renderPartialHtml(n,{no:this.$id(t).children().length+1,property:t,i:this.categoryI++,category:o?{_id:o.id,label:o.getLabel({long:!0})}:{_id:e,label:`?${e}?`}}))},serializeForm:function(t){return t.behaviors=t.behaviors?t.behaviors.map(t=>+t):[],t.workConditions=t.workConditions?t.workConditions.map(t=>+t):[],t}})});