// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./PaintShopOrder"],function(e,t,r,n,i,s){"use strict";return i.extend({model:s,rqlQuery:"sort(group,no)&limit(0)",parse:function(e){return i.prototype.parse.call(this,e).map(s.parse)},genClientUrl:function(){return"/paintShop/"+(this.isDateFilter("current")?"current":this.getDateFilter())},isDateFilter:function(t){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&e.args[1]===t})},getDateFilter:function(e){var t;return this.rqlQuery.selector.args.forEach(function(n){"eq"===n.name&&"date"===n.args[0]&&"current"!==n.args[1]&&(t=r.getMoment(n.args[1],"YYYY-MM-DD").format(e||"YYYY-MM-DD"))}),t||(t=n(Date.now()).moment.format(e||"YYYY-MM-DD")),t},setDateFilter:function(e){var t=n(Date.now()).moment.format("YYYY-MM-DD");e===t&&(e="current"),this.rqlQuery.selector.args.forEach(function(t){"eq"===t.name&&"date"===t.args[0]&&(t.args[1]=e)})},serializeGroups:function(){var e=[],t={};return this.forEach(function(r){var n=r.get("group").replace(/[^A-Za-z0-9]+/g,""),i=t[n];i||(i=t[n]={_id:n,name:r.get("group"),orders:[]},e.push(i)),i.orders.push(r.serialize())}),e},act:function(e,r){var n=this,i=n.url;e.requestId&&(i="/isaActiveRequests/"+this.get(e.requestId).getProdLineId());var s=t.ajax({method:"PATCH",url:i,data:JSON.stringify(e)});return n.trigger("request",this,s,{}),s.fail(function(e){var t=e.responseJSON?e.responseJSON.error:null;t||(t={message:e.statusText}),t.statusCode=e.status,r(t),n.trigger("error",s)}),s.done(function(e){r(null,e),n.trigger("sync",e,s)}),s},pickup:function(e,t){return this.act({action:"requestPickup",secretKey:e},t)},deliver:function(e,t,r){return this.act({action:"requestDelivery",secretKey:t,palletKind:e},r)},cancel:function(e,t,r){return this.act({action:"cancelRequest",secretKey:t,requestId:e},r)},accept:function(e,t,r){return this.act({action:"acceptRequest",responder:t,requestId:e},r)},finish:function(e,t){return this.act({action:"finishRequest",requestId:e},t)}},{forCurrentDate:function(){return this.forDate("current")},forDate:function(e){return new this(null,{rqlQuery:"sort(group,no)&limit(0)&date="+e})}})});