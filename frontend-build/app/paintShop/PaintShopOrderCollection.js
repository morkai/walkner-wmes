// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./PaintShopOrder"],function(e,r,t,n,i,s){"use strict";return i.extend({model:s,comparator:"no",initialize:function(){this.selectedMrp="all",this.allMrps=null,this.serialized=null,this.on("request",function(){this.serialized=null})},parse:function(e){return i.prototype.parse.call(this,e).map(s.parse)},genClientUrl:function(){return"/paintShop/"+(this.isDateFilter("current")?"current":this.getDateFilter())},isDateFilter:function(r){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&e.args[1]===r})},isDateCurrent:function(){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&"current"===e.args[1]})},getDateFilter:function(e){var r;return this.rqlQuery.selector.args.forEach(function(n){"eq"===n.name&&"date"===n.args[0]&&"current"!==n.args[1]&&(r=t.getMoment(n.args[1],"YYYY-MM-DD").format(e||"YYYY-MM-DD"))}),r||(r=this.constructor.getCurrentDate(e)),r},setDateFilter:function(e){var r=this.constructor.getCurrentDate();e===r&&(e="current"),this.rqlQuery.selector.args.forEach(function(r){"eq"===r.name&&"date"===r.args[0]&&(r.args[1]=e)})},selectMrp:function(e){this.selectedMrp=this.selectedMrp===e?"all":e,this.trigger("mrpSelected")},isVisible:function(e){return"all"===this.selectedMrp||e.get("mrp")===this.selectedMrp},getFirstByOrderNo:function(e){return this.find(function(r){return r.get("order")===e})},serialize:function(){var e=this;if(e.serialized)return e.serialized;var r=[],t={};return e.forEach(function(n){n=n.serialize(),n.followups=n.followups.map(function(r){return{id:r,no:e.get(r).get("no")}}),r.push(n),t[n.mrp]=1}),t[e.selectedMrp]||(e.selectedMrp="all"),e.serialized=r,e.allMrps=Object.keys(t).sort(),r},act:function(e,t){var n=this,i=n.url;e.orderId&&(i="/paintShop/orders/"+e.orderId);var s=r.ajax({method:"PATCH",url:i,data:JSON.stringify(e)});return n.trigger("request",this,s,{}),s.fail(function(e){var r=e.responseJSON?e.responseJSON.error:null;r||(r={message:e.statusText}),r.statusCode=e.status,t(r),n.trigger("error",s)}),s.done(function(e){t(null,e),n.trigger("sync",e,s)}),s},applyChanges:function(e){var r=this,t=e.removed.length>0||e.added.length>0;if(!t)for(var n=0;n<e.changed.length;++n)if(e.changed[n].no>0){t=!0;break}r.remove(e.removed,{silent:t}),e.added.forEach(function(e){r.add(s.parse(e),{silent:t})}),e.changed.forEach(function(e){var n=r.get(e._id);n&&n.set(s.parse(e),{silent:t})}),t&&(r.serialized=null,r.trigger("reset",r))}},{getCurrentDate:function(e){var r=t.getMoment();return r.hours()<17?r.startOf("day").subtract(1,"days"):r.startOf("day").add(1,"days"),t.utc.getMoment(r.format("YYYY-MM-DD"),"YYYY-MM-DD").format(e||"YYYY-MM-DD")},forCurrentDate:function(){return this.forDate("current")},forDate:function(e){return new this(null,{rqlQuery:"sort(date,no)&limit(0)&date="+e})}})});