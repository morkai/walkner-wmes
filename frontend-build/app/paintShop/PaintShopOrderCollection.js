define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./PaintShopOrder"],function(e,t,r,i,s,n){"use strict";return s.extend({model:n,comparator:"no",initialize:function(t,r){var i=this;i.settings=r?r.settings:null,i.paints=r?r.paints:null,i.dropZones=r?r.dropZones:null,i.drillingOrders=r?r.drillingOrders:null,i.user=r?r.user:null,i.selectedMrp=r&&r.selectedMrp?r.selectedMrp:"all",i.selectedPaint=r&&r.selectedPaint?r.selectedPaint:"all",i.allMrps=null,i.serializedList=null,i.serializedMap=null,i.byOrderNo=null,i.totalQuantities={},i.on("reset request",function(){i.serializedList=null,i.serializedMap=null,i.byOrderNo=null}),i.on("change",function(t){i.serializedMap&&i.serializedMap[t.id]&&e.assign(i.serializedMap[t.id],t.serialize(!0,i.paints,i))}),i.drillingOrders&&i.listenTo(i.drillingOrders,"add remove change",function(e){if(i.byOrderNo){var t=i.byOrderNo[e.get("order")];t&&t.forEach(function(e){i.trigger("change",e,{drilling:!0})})}})},parse:function(e){return s.prototype.parse.call(this,e).map(n.parse)},genClientUrl:function(){return"/paintShop/"+this.getDateFilter()},isDateFilter:function(t){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&e.args[1]===t})},getDateFilter:function(e){var t=null;return this.rqlQuery.selector.args.forEach(function(i){"eq"===i.name&&"date"===i.args[0]&&(t=r.utc.getMoment(i.args[1],"YYYY-MM-DD").format(e||"YYYY-MM-DD"))}),t},setDateFilter:function(e){this.rqlQuery.selector.args.forEach(function(t){"eq"===t.name&&"date"===t.args[0]&&(t.args[1]=e)})},selectMrp:function(e){this.selectedMrp=this.selectedMrp===e?"all":e,this.trigger("mrpSelected")},selectPaint:function(e){e!==this.selectedPaint&&(this.selectedPaint=this.selectedPaint===e?"all":e,this.trigger("paintSelected"))},isVisible:function(e){return this.isMrpVisible(e)&&this.isPaintVisible(e)},isMrpVisible:function(e){return"all"===this.selectedMrp||e.mrp===this.selectedMrp||this.isDrillingMrpSelected()&&-1!==e.mrps.indexOf(this.selectedMrp)},isDrillingMrp:function(e){return e===n.DRILLING_MRP},isDrillingMrpSelected:function(){return this.selectedMrp===n.DRILLING_MRP},isPaintVisible:function(e){if("all"===this.selectedPaint)return!0;if("msp"!==this.selectedPaint)return e.paints[this.selectedPaint]>0;var t=this.settings.getValue("mspPaints");if(!t&&!t.length)return!1;for(var r=0;r<t.length;++r)if(e.paints[t[r]])return!0;return!1},getFirstByOrderNo:function(t){return this.find(function(r){return r.get("order")===t||e.some(r.get("childOrders"),function(e){return e.order===t})})},getChildOrderDropZoneClass:function(e,t){if(!this.dropZones||!this.settings||"cancelled"===t.status)return"";var r=this.selectedPaint;if("all"===r){for(var i=0;i<e.paintList.length;++i)if(this.dropZones.getState(e.paintList[i]))return"is-dropped";return""}if("msp"===r){for(var s=this.settings.getValue("mspPaints"),n=!1,a=0;a<s.length;++a)if(e.paints[s[a]]){n=!0;break}return n?this.dropZones.getState("msp")?"is-dropped":"is-droppable":"is-undroppable"}return e.paints[r]?this.dropZones.getState(r)?"is-dropped":"is-droppable":"is-undroppable"},serialize:function(e){var t=this;if(!e&&t.serializedList)return t.serializedList;var r=[],i={},s={},a={},l={all:{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}};return t.forEach(function(e){var d=i[e.id]=e.serialize(!0,t.paints,t);s[d.order]||(s[d.order]=[]),s[d.order].push(e),r.push(d),a[d.mrp]=1,d.drilling&&(a[n.DRILLING_MRP]=1),t.recountOrder(l,d)}),t.serializedList=r,t.serializedMap=i,t.byOrderNo=s,t.allMrps=Object.keys(a).sort(),t.totalQuantities=l,"all"===t.selectedMrp||a[t.selectedMrp]||t.selectMrp("all"),r},serializeTotals:function(){return"all"===this.selectedPaint?this.totalQuantities[this.selectedMrp]:"msp"===this.selectedPaint?this.serializeMspTotals():"all"===this.selectedMrp?this.totalQuantities[this.selectedPaint]||{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}:this.totalQuantities[this.selectedMrp+this.selectedPaint]||{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}},serializeMspTotals:function(){var e=this,t={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0},r=e.settings.getValue("mspPaints")||[];if(0===r.length)return t;var i="all"===e.selectedMrp?"":e.selectedMrp,s=Object.keys(t);return r.forEach(function(r){var n=e.totalQuantities[i+r];n&&s.forEach(function(e){t[e]+=n[e]})}),t},recountTotals:function(){this.totalQuantities={all:{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}},this.serializedList.forEach(this.recountOrder.bind(this,this.totalQuantities)),this.trigger("totalsRecounted")},recountOrder:function(e,t){var r=t.mrp,i=t.status,s="started"===i&&t.cabin?"started"+t.cabin:null,n=t.qtyPaint,a=t.qtyPaint/t.qty,l=0;"finished"===i&&t.qtyDlv&&(n-=l=a*t.qtyDlv),e[r]||(e[r]={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}),e.all[i]+=n,e[r][i]+=n,e.all.delivered+=l,e[r].delivered+=l,s&&(e.all[s]+=n,e[r][s]+=n),Object.keys(t.paints).forEach(function(n){var a=t.paints[n],l=r+n;e[n]||(e[n]={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}),e[l]||(e[l]={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}),e[n][i]+=a,e[l][i]+=a,e[n].delivered+=a,e[l].delivered+=a,s&&(e[n][s]+=a,e[l][s]+=a)})},act:function(e,r){var i=this,s=i.url;e.orderId&&(s="/paintShop/orders/"+e.orderId),i.user&&(e.user=i.user);var n=t.ajax({method:"PATCH",url:s,data:JSON.stringify(e)});return i.trigger("request",this,n,{}),n.fail(function(e){var t=e.responseJSON?e.responseJSON.error:null;t||(t={message:e.statusText}),t.statusCode=e.status,r(t),i.trigger("error",n)}),n.done(function(e){r(null,e),i.trigger("sync",e,n)}),n},applyChanges:function(e){var t=this,r=e.removed.length>0||e.added.length>0,i=r;if(!r)for(var s=0;s<e.changed.length;++s)if(e.changed[s].no>0){r=!0;break}t.remove(e.removed,{silent:r}),e.added.forEach(function(e){t.add(n.parse(e),{silent:r})}),e.changed.forEach(function(e){var s=t.get(e._id);s&&(s.set(n.parse(e),{silent:r}),(e.qtyPaint||e.status)&&(i=!0))}),r?(t.allMrps=null,t.serializedList=null,t.serializedMap=null,t.byOrderNo=null,t.sort({silent:!0}),t.trigger("reset",t)):i&&t.recountTotals()}},{forDate:function(t,r){return new this(null,e.assign({rqlQuery:"sort(date,no)&limit(0)&date="+t},r))}})});