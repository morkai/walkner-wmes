// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./PaintShopOrder"],function(r,t,e,n,s,i){"use strict";return s.extend({model:i,rqlQuery:"sort(group,no)&limit(0)",initialize:function(){this.selectedMrp="all",this.allMrps=[],this.groups=null,this.on("request",function(){this.allMrps=[],this.groups=null})},parse:function(r){return s.prototype.parse.call(this,r).map(i.parse)},genClientUrl:function(){return"/paintShop/"+(this.isDateFilter("current")?"current":this.getDateFilter())},isDateFilter:function(t){return r.some(this.rqlQuery.selector.args,function(r){return"eq"===r.name&&"date"===r.args[0]&&r.args[1]===t})},isDateCurrent:function(){return r.some(this.rqlQuery.selector.args,function(r){return"eq"===r.name&&"date"===r.args[0]&&"current"===r.args[1]})},getDateFilter:function(r){var t;return this.rqlQuery.selector.args.forEach(function(n){"eq"===n.name&&"date"===n.args[0]&&"current"!==n.args[1]&&(t=e.getMoment(n.args[1],"YYYY-MM-DD").format(r||"YYYY-MM-DD"))}),t||(t=this.constructor.getCurrentDate(r)),t},setDateFilter:function(r){var t=this.constructor.getCurrentDate();r===t&&(r="current"),this.rqlQuery.selector.args.forEach(function(t){"eq"===t.name&&"date"===t.args[0]&&(t.args[1]=r)})},selectMrp:function(r){this.selectedMrp=this.selectedMrp===r?"all":r,this.trigger("mrpSelected")},isVisible:function(r){return"all"===this.selectedMrp||r.get("mrp")===this.selectedMrp},serializeGroups:function(r){if(this.groups)return r?this.groups.map(function(t){return{_id:t._id,name:t.name,orders:t.orders.filter(r)}}).filter(function(r){return r.orders.length>0}):this.groups;var t=[],e={},n={};return this.forEach(function(r){n[r.get("mrp")]=1;var s=r.get("group").replace(/[^A-Za-z0-9]+/g,""),i=e[s];i||(i=e[s]={_id:s,name:r.get("group"),orders:[]},t.push(i)),i.orders.push(r.serialize())}),n[this.selectedMrp]||(this.selectedMrp="all"),this.allMrps=Object.keys(n).sort(),this.groups=t,this.serializeGroups(r)},act:function(r,e){var n=this,s=n.url;r.orderId&&(s="/paintShop/orders/"+r.orderId);var i=t.ajax({method:"PATCH",url:s,data:JSON.stringify(r)});return n.trigger("request",this,i,{}),i.fail(function(r){var t=r.responseJSON?r.responseJSON.error:null;t||(t={message:r.statusText}),t.statusCode=r.status,e(t),n.trigger("error",i)}),i.done(function(r){e(null,r),n.trigger("sync",r,i)}),i}},{getCurrentDate:function(r){return n(Date.now()).moment.format(r||"YYYY-MM-DD")},forCurrentDate:function(){return this.forDate("current")},forDate:function(r){return new this(null,{rqlQuery:"sort(group,no)&limit(0)&date="+r})}})});