// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./PaintShopOrder"],function(t,e,i,s,r,n){"use strict";function a(){return{new:0,started:0,partial:0,finished:0,cancelled:0}}return r.extend({model:n,comparator:"no",initialize:function(e,i){this.settings=i?i.settings:null,this.paints=i?i.paints:null,this.dropZones=i?i.dropZones:null,this.selectedMrp=i&&i.selectedMrp?i.selectedMrp:"all",this.selectedPaint=i&&i.selectedPaint?i.selectedPaint:"all",this.allMrps=null,this.serializedList=null,this.serializedMap=null,this.totalQuantities={},this.on("request",function(){this.serializedList=null,this.serializedMap=null}),this.on("change",function(e){this.serializedMap&&this.serializedMap[e.id]&&t.assign(this.serializedMap[e.id],e.serialize(!0,this.paints,this))})},parse:function(t){return r.prototype.parse.call(this,t).map(n.parse)},genClientUrl:function(){return"/paintShop/"+this.getDateFilter()},isDateFilter:function(e){return t.some(this.rqlQuery.selector.args,function(t){return"eq"===t.name&&"date"===t.args[0]&&t.args[1]===e})},getDateFilter:function(t){var e=null;return this.rqlQuery.selector.args.forEach(function(s){"eq"===s.name&&"date"===s.args[0]&&(e=i.utc.getMoment(s.args[1],"YYYY-MM-DD").format(t||"YYYY-MM-DD"))}),e},setDateFilter:function(t){this.rqlQuery.selector.args.forEach(function(e){"eq"===e.name&&"date"===e.args[0]&&(e.args[1]=t)})},selectMrp:function(t){this.selectedMrp=this.selectedMrp===t?"all":t,this.trigger("mrpSelected")},selectPaint:function(t){t!==this.selectedPaint&&(this.selectedPaint=this.selectedPaint===t?"all":t,this.trigger("paintSelected"))},isVisible:function(t){return this.isMrpVisible(t)&&this.isPaintVisible(t)},isMrpVisible:function(t){return"all"===this.selectedMrp||t.mrp===this.selectedMrp},isPaintVisible:function(t){if("all"===this.selectedPaint)return!0;if("msp"!==this.selectedPaint)return t.paints[this.selectedPaint]>0;var e=this.settings.getValue("mspPaints");if(!e&&!e.length)return!1;for(var i=0;i<e.length;++i)if(t.paints[e[i]])return!0;return!1},getFirstByOrderNo:function(e){return this.find(function(i){return i.get("order")===e||t.some(i.get("childOrders"),function(t){return t.order===e})})},getChildOrderDropZoneClass:function(t){if(!this.dropZones||!this.settings)return"";var e=this.selectedPaint;if("all"===e){for(var i=0;i<t.paintList.length;++i)if(this.dropZones.getState(t.paintList[i]))return"is-dropped";return""}if("msp"===e){for(var s=this.settings.getValue("mspPaints"),r=!1,n=0;n<s.length;++n)if(t.paints[s[n]]){r=!0;break}return r?this.dropZones.getState("msp")?"is-dropped":"is-droppable":"is-undroppable"}return t.paints[e]?this.dropZones.getState(e)?"is-dropped":"is-droppable":"is-undroppable"},serialize:function(t){var e=this;if(!t&&e.serializedList)return e.serializedList;var i=[],s={},r={},n={all:a()};return e.forEach(function(t){var a=s[t.id]=t.serialize(!0,e.paints,e);i.push(a),r[a.mrp]=1,e.recountOrder(n,a)}),e.serializedList=i,e.serializedMap=s,e.allMrps=Object.keys(r).sort(),e.totalQuantities=n,"all"===e.selectedMrp||r[e.selectedMrp]||e.selectMrp("all"),i},serializeTotals:function(){return"all"===this.selectedPaint?this.totalQuantities[this.selectedMrp]:"msp"===this.selectedPaint?this.serializeMspTotals():"all"===this.selectedMrp?this.totalQuantities[this.selectedPaint]||a():this.totalQuantities[this.selectedMrp+this.selectedPaint]||a()},serializeMspTotals:function(){var t=this,e=a(),i=t.settings.getValue("mspPaints")||[];if(0===i.length)return e;var s="all"===t.selectedMrp?"":t.selectedMrp,r=Object.keys(e);return i.forEach(function(i){var n=t.totalQuantities[s+i];n&&r.forEach(function(t){e[t]+=n[t]})}),e},recountTotals:function(){this.totalQuantities={all:a()},this.serializedList.forEach(this.recountOrder.bind(this,this.totalQuantities)),this.trigger("totalsRecounted")},recountOrder:function(t,e){var i=e.mrp,s=e.status,r=e.qtyPaint;t[i]||(t[i]=a()),t.all[s]+=r,t[i][s]+=r,Object.keys(e.paints).forEach(function(r){var n=e.paints[r],l=i+r;t[r]||(t[r]=a()),t[l]||(t[l]=a()),t[r][s]+=n,t[l][s]+=n})},act:function(t,i){var s=this,r=s.url;t.orderId&&(r="/paintShop/orders/"+t.orderId);var n=e.ajax({method:"PATCH",url:r,data:JSON.stringify(t)});return s.trigger("request",this,n,{}),n.fail(function(t){var e=t.responseJSON?t.responseJSON.error:null;e||(e={message:t.statusText}),e.statusCode=t.status,i(e),s.trigger("error",n)}),n.done(function(t){i(null,t),s.trigger("sync",t,n)}),n},applyChanges:function(t){var e=this,i=t.removed.length>0||t.added.length>0,s=i;if(!i)for(var r=0;r<t.changed.length;++r)if(t.changed[r].no>0){i=!0;break}e.remove(t.removed,{silent:i}),t.added.forEach(function(t){e.add(n.parse(t),{silent:i})}),t.changed.forEach(function(t){var r=e.get(t._id);r&&(r.set(n.parse(t),{silent:i}),(t.qtyPaint||t.status)&&(s=!0))}),i?(e.allMrps=null,e.serializedList=null,e.serializedMap=null,e.sort({silent:!0}),e.trigger("reset",e)):s&&e.recountTotals()}},{forDate:function(e,i){return new this(null,t.assign({rqlQuery:"sort(date,no)&limit(0)&date="+e},i))}})});