define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./PaintShopOrder"],function(e,t,i,s,r,a){"use strict";return r.extend({model:a,comparator:"no",initialize:function(t,i){this.settings=i?i.settings:null,this.paints=i?i.paints:null,this.dropZones=i?i.dropZones:null,this.user=i?i.user:null,this.selectedMrp=i&&i.selectedMrp?i.selectedMrp:"all",this.selectedPaint=i&&i.selectedPaint?i.selectedPaint:"all",this.allMrps=null,this.serializedList=null,this.serializedMap=null,this.totalQuantities={},this.on("request",function(){this.serializedList=null,this.serializedMap=null}),this.on("change",function(t){this.serializedMap&&this.serializedMap[t.id]&&e.assign(this.serializedMap[t.id],t.serialize(!0,this.paints,this))})},parse:function(e){return r.prototype.parse.call(this,e).map(a.parse)},genClientUrl:function(){return"/paintShop/"+this.getDateFilter()},isDateFilter:function(t){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&e.args[1]===t})},getDateFilter:function(e){var t=null;return this.rqlQuery.selector.args.forEach(function(s){"eq"===s.name&&"date"===s.args[0]&&(t=i.utc.getMoment(s.args[1],"YYYY-MM-DD").format(e||"YYYY-MM-DD"))}),t},setDateFilter:function(e){this.rqlQuery.selector.args.forEach(function(t){"eq"===t.name&&"date"===t.args[0]&&(t.args[1]=e)})},selectMrp:function(e){this.selectedMrp=this.selectedMrp===e?"all":e,this.trigger("mrpSelected")},selectPaint:function(e){e!==this.selectedPaint&&(this.selectedPaint=this.selectedPaint===e?"all":e,this.trigger("paintSelected"))},isVisible:function(e){return this.isMrpVisible(e)&&this.isPaintVisible(e)},isMrpVisible:function(e){return"all"===this.selectedMrp||e.mrp===this.selectedMrp},isPaintVisible:function(e){if("all"===this.selectedPaint)return!0;if("msp"!==this.selectedPaint)return e.paints[this.selectedPaint]>0;var t=this.settings.getValue("mspPaints");if(!t&&!t.length)return!1;for(var i=0;i<t.length;++i)if(e.paints[t[i]])return!0;return!1},getFirstByOrderNo:function(t){return this.find(function(i){return i.get("order")===t||e.some(i.get("childOrders"),function(e){return e.order===t})})},getChildOrderDropZoneClass:function(e,t){if(!this.dropZones||!this.settings||"cancelled"===t.status)return"";var i=this.selectedPaint;if("all"===i){for(var s=0;s<e.paintList.length;++s)if(this.dropZones.getState(e.paintList[s]))return"is-dropped";return""}if("msp"===i){for(var r=this.settings.getValue("mspPaints"),a=!1,n=0;n<r.length;++n)if(e.paints[r[n]]){a=!0;break}return a?this.dropZones.getState("msp")?"is-dropped":"is-droppable":"is-undroppable"}return e.paints[i]?this.dropZones.getState(i)?"is-dropped":"is-droppable":"is-undroppable"},serialize:function(e){var t=this;if(!e&&t.serializedList)return t.serializedList;var i=[],s={},r={},a={all:{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}};return t.forEach(function(e){var n=s[e.id]=e.serialize(!0,t.paints,t);i.push(n),r[n.mrp]=1,t.recountOrder(a,n)}),t.serializedList=i,t.serializedMap=s,t.allMrps=Object.keys(r).sort(),t.totalQuantities=a,"all"===t.selectedMrp||r[t.selectedMrp]||t.selectMrp("all"),i},serializeTotals:function(){return"all"===this.selectedPaint?this.totalQuantities[this.selectedMrp]:"msp"===this.selectedPaint?this.serializeMspTotals():"all"===this.selectedMrp?this.totalQuantities[this.selectedPaint]||{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}:this.totalQuantities[this.selectedMrp+this.selectedPaint]||{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}},serializeMspTotals:function(){var e=this,t={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0},i=e.settings.getValue("mspPaints")||[];if(0===i.length)return t;var s="all"===e.selectedMrp?"":e.selectedMrp,r=Object.keys(t);return i.forEach(function(i){var a=e.totalQuantities[s+i];a&&r.forEach(function(e){t[e]+=a[e]})}),t},recountTotals:function(){this.totalQuantities={all:{new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}},this.serializedList.forEach(this.recountOrder.bind(this,this.totalQuantities)),this.trigger("totalsRecounted")},recountOrder:function(e,t){var i=t.mrp,s=t.status,r="started"===s&&t.cabin?"started"+t.cabin:null,a=t.qtyPaint,n=t.qtyPaint/t.qty,l=0;"finished"===s&&t.qtyDlv&&(a-=l=n*t.qtyDlv),e[i]||(e[i]={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}),e.all[s]+=a,e[i][s]+=a,e.all.delivered+=l,e[i].delivered+=l,r&&(e.all[r]+=a,e[i][r]+=a),Object.keys(t.paints).forEach(function(a){var n=t.paints[a],l=i+a;e[a]||(e[a]={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}),e[l]||(e[l]={new:0,started:0,started1:0,started2:0,partial:0,finished:0,delivered:0,cancelled:0}),e[a][s]+=n,e[l][s]+=n,e[a].delivered+=n,e[l].delivered+=n,r&&(e[a][r]+=n,e[l][r]+=n)})},act:function(e,i){var s=this,r=s.url;e.orderId&&(r="/paintShop/orders/"+e.orderId),s.user&&(e.user=s.user);var a=t.ajax({method:"PATCH",url:r,data:JSON.stringify(e)});return s.trigger("request",this,a,{}),a.fail(function(e){var t=e.responseJSON?e.responseJSON.error:null;t||(t={message:e.statusText}),t.statusCode=e.status,i(t),s.trigger("error",a)}),a.done(function(e){i(null,e),s.trigger("sync",e,a)}),a},applyChanges:function(e){var t=this,i=e.removed.length>0||e.added.length>0,s=i;if(!i)for(var r=0;r<e.changed.length;++r)if(e.changed[r].no>0){i=!0;break}t.remove(e.removed,{silent:i}),e.added.forEach(function(e){t.add(a.parse(e),{silent:i})}),e.changed.forEach(function(e){var r=t.get(e._id);r&&(r.set(a.parse(e),{silent:i}),(e.qtyPaint||e.status)&&(s=!0))}),i?(t.allMrps=null,t.serializedList=null,t.serializedMap=null,t.sort({silent:!0}),t.trigger("reset",t)):s&&t.recountTotals()}},{forDate:function(t,i){return new this(null,e.assign({rqlQuery:"sort(date,no)&limit(0)&date="+t},i))}})});