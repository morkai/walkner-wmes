// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./PaintShopOrder"],function(e,t,r,i,n,s){"use strict";return n.extend({model:s,comparator:"no",initialize:function(){this.selectedMrp="all",this.allMrps=null,this.serializedList=null,this.serializedMap=null,this.on("request",function(){this.serializedList=null,this.serializedMap=null}),this.on("change",function(e){this.serializedMap&&(this.serializedMap[e.id]=e.serialize())})},parse:function(e){return n.prototype.parse.call(this,e).map(s.parse)},genClientUrl:function(){return"/paintShop/"+(this.isDateFilter("current")?"current":this.getDateFilter())},isDateFilter:function(t){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&e.args[1]===t})},isDateCurrent:function(){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&"current"===e.args[1]})},getDateFilter:function(e){var t;return this.rqlQuery.selector.args.forEach(function(i){"eq"===i.name&&"date"===i.args[0]&&"current"!==i.args[1]&&(t=r.getMoment(i.args[1],"YYYY-MM-DD").format(e||"YYYY-MM-DD"))}),t||(t=this.constructor.getCurrentDate(e)),t},setDateFilter:function(e){var t=this.constructor.getCurrentDate();e===t&&(e="current"),this.rqlQuery.selector.args.forEach(function(t){"eq"===t.name&&"date"===t.args[0]&&(t.args[1]=e)})},selectMrp:function(e){this.selectedMrp=this.selectedMrp===e?"all":e,this.trigger("mrpSelected")},isVisible:function(e){return"all"===this.selectedMrp||e.get("mrp")===this.selectedMrp},getFirstByOrderNo:function(e){return this.find(function(t){return t.get("order")===e})},serialize:function(){var e=this;if(e.serializedList)return e.serializedList;var t=[],r={},i={};return e.forEach(function(n){var s=r[n.id]=n.serialize();s.followups=s.followups.map(function(t){return{id:t,no:e.get(t).get("no")}}),t.push(s),i[s.mrp]=1}),i[e.selectedMrp]||(e.selectedMrp="all"),e.serializedList=t,e.serializedMap=r,e.allMrps=Object.keys(i).sort(),t},act:function(e,r){var i=this,n=i.url;e.orderId&&(n="/paintShop/orders/"+e.orderId);var s=t.ajax({method:"PATCH",url:n,data:JSON.stringify(e)});return i.trigger("request",this,s,{}),s.fail(function(e){var t=e.responseJSON?e.responseJSON.error:null;t||(t={message:e.statusText}),t.statusCode=e.status,r(t),i.trigger("error",s)}),s.done(function(e){r(null,e),i.trigger("sync",e,s)}),s},applyChanges:function(e){var t=this,r=e.removed.length>0||e.added.length>0;if(!r)for(var i=0;i<e.changed.length;++i)if(e.changed[i].no>0){r=!0;break}t.remove(e.removed,{silent:r}),e.added.forEach(function(e){t.add(s.parse(e),{silent:r})}),e.changed.forEach(function(e){var i=t.get(e._id);i&&i.set(s.parse(e),{silent:r})}),r&&(t.serializedList=null,t.serializedMap=null,t.trigger("reset",t))}},{getCurrentDate:function(e){var t=r.getMoment();return t.hours()<17?t.startOf("day").subtract(1,"days"):t.startOf("day").add(1,"days"),r.utc.getMoment(t.format("YYYY-MM-DD"),"YYYY-MM-DD").format(e||"YYYY-MM-DD")},forCurrentDate:function(){return this.forDate("current")},forDate:function(e){return new this(null,{rqlQuery:"sort(date,no)&limit(0)&date="+e})}})});