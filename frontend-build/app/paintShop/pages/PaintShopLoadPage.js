define(["jquery","app/i18n","app/core/View","app/core/util/bindLoadingMessage","app/core/util/embedded","../PaintShopSettingCollection","../PaintShopLoadStats","../PaintShopLoadRecent","../PaintShopLoadReport","../views/PaintShopLoadFilterView","../views/PaintShopLoadReportView","../views/PaintShopLoadStatsView","../views/PaintShopLoadRecentView","app/paintShop/templates/load/page","i18n!app/nls/reports"],function(t,e,i,s,n,o,d,r,a,h,p,c,l,u){"use strict";var f=window.parent!==window;return i.extend({template:u,layoutName:f?"blank":"page",pageId:"paintShopLoad",breadcrumbs:function(){return[{href:"#paintShop/"+(window.WMES_LAST_PAINT_SHOP_DATE||"0d"),label:e.bound("paintShop","BREADCRUMBS:base")},e.bound("paintShop","BREADCRUMBS:load")]},actions:[{href:"#paintShop;settings?tab=load",icon:"cogs",label:e.bound("paintShop","PAGE_ACTIONS:settings"),privileges:"PAINT_SHOP:MANAGE"}],localTopics:{"socket.connected":function(){this.promised(this.settings.fetch()),this.promised(this.stats.fetch()),this.promised(this.recent.fetch())}},remoteTopics:{"paintShop.load.updated":function(t){this.stats.set(t.stats),this.recent.update(t.items)}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.report&&(this.setView("#-filter",this.filterView),this.setView("#-report",this.reportView)),this.setView("#-stats",this.statsView),this.setView("#-recent",this.recentView)},destroy:function(){t(document).off("."+this.idPrefix),t(document.body).css("overflow","").removeClass("paintShopLoad-page paintShop-is-embedded")},defineModels:function(){this.settings=s(new o(null,{pubsub:this.pubsub}),this),this.report=f?null:s(new a(this.options.query),this),this.stats=s(new d,this),this.recent=s(new r,this)},defineViews:function(){this.report&&(this.filterView=new h({model:this.report}),this.reportView=new p({settings:this.settings,model:this.report})),this.statsView=new c({settings:this.settings,stats:this.stats}),this.recentView=new l({settings:this.settings,recent:this.recent,embedded:f})},defineBindings:function(){var e=this;e.once("afterRender",function(){f&&window.parent.postMessage({type:"ready",app:"ps-load"},"*")}),e.listenTo(e.stats,"change",function(){clearTimeout(e.timers.reloadStats),e.timers.reloadStats=setTimeout(e.stats.fetch.bind(e.stats,{showLoadingMessage:!1}),6e4)}),e.report&&e.listenTo(e.report,"filtered",this.onReportFiltered),t(document).on("click",e.onDocumentClick.bind(e))},load:function(t){return t(this.settings.fetch(),this.stats.fetch(),this.recent.fetch(),this.report?this.report.fetch():null)},serialize:function(){return{idPrefix:this.idPrefix,embedded:f}},beforeRender:function(){f&&(document.body.style.overflow="hidden"),document.body.classList.toggle("paintShop-is-embedded",f),document.body.classList.add("paintShopLoad-page")},afterRender:function(){n.render(this),this.showEmbeddedActions()},showEmbeddedActions:function(){var t=this.$(".embedded-actions");t.length&&(t.fadeIn("fast"),clearTimeout(this.timers.hideEmbeddedActions),this.timers.hideEmbeddedActions=setTimeout(function(){t.fadeOut("fast")},15e3))},onDocumentClick:function(){this.showEmbeddedActions()},onReportFiltered:function(){this.broker.publish("router.navigate",{url:this.report.genClientUrl(),trigger:!1,replace:!0}),this.promised(this.report.fetch())}})});