define(["jquery","app/i18n","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/embedded","../PaintShopSettingCollection","../PaintShopLoadStats","../PaintShopLoadRecent","../PaintShopLoadReport","../views/PaintShopLoadFilterView","../views/PaintShopLoadReportView","../views/PaintShopLoadStatsView","../views/PaintShopLoadRecentView","../views/ExportLoadDialogView","app/paintShop/templates/load/page","i18n!app/nls/reports"],function(t,e,i,s,o,n,a,d,r,h,p,c,l,u,f,w){"use strict";return s.extend({template:w,layoutName:n.isEnabled()?"blank":"page",pageId:"paintShopLoad",modelProperty:"report",breadcrumbs:function(){return[{href:"#paintShop/"+(window.WMES_LAST_PAINT_SHOP_DATE||"0d"),label:this.t("BREADCRUMB:base")},this.t("BREADCRUMB:load")]},actions:function(){return n.isEnabled()?[]:[{icon:"download",label:this.t("exportLoad:pageAction"),callback:this.showExportLoadDialog.bind(this)},{href:"#paintShop;settings?tab=load",icon:"cogs",label:this.t("PAGE_ACTION:settings"),privileges:"PAINT_SHOP:MANAGE"}]},localTopics:{"socket.connected":function(){this.promised(this.settings.fetch()),this.promised(this.stats.fetch()),this.promised(this.recent.fetch())}},remoteTopics:{"paintShop.load.updated":function(t){this.stats.set(t.stats),this.recent.update(t.items)}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.report&&(this.setView("#-filter",this.filterView),this.setView("#-report",this.reportView)),this.setView("#-stats",this.statsView),this.setView("#-recent",this.recentView)},destroy:function(){t(document).off("."+this.idPrefix),t(document.body).css("overflow","").removeClass("paintShopLoad-page paintShop-is-embedded")},defineModels:function(){this.settings=o(new a(null,{pubsub:this.pubsub}),this),this.report=n.isEnabled()?null:o(new h(this.options.query),this),this.stats=o(new d,this),this.recent=o(new r,this)},defineViews:function(){this.report&&(this.filterView=new p({model:this.report}),this.reportView=new c({settings:this.settings,model:this.report})),this.statsView=new l({settings:this.settings,stats:this.stats}),this.recentView=new u({settings:this.settings,recent:this.recent,embedded:n.isEnabled()})},defineBindings:function(){var e=this;e.once("afterRender",function(){n.isEnabled()&&window.parent.postMessage({type:"ready",app:"ps-load"},"*")}),e.listenTo(e.stats,"change",function(){clearTimeout(e.timers.reloadStats),e.timers.reloadStats=setTimeout(e.stats.fetch.bind(e.stats,{showLoadingMessage:!1}),6e4)}),e.report&&e.listenTo(e.report,"filtered",this.onReportFiltered),t(document).on("click",e.onDocumentClick.bind(e))},load:function(t){return t(this.settings.fetch(),this.stats.fetch(),this.recent.fetch(),this.report?this.report.fetch():null)},getTemplateData:function(){return{embedded:n.isEnabled()}},beforeRender:function(){n.isEnabled()&&(document.body.style.overflow="hidden"),document.body.classList.toggle("paintShop-is-embedded",n.isEnabled()),document.body.classList.add("paintShopLoad-page")},afterRender:function(){n.render(this),this.showEmbeddedActions()},showEmbeddedActions:function(){var t=this.$(".embedded-actions");t.length&&(t.fadeIn("fast"),clearTimeout(this.timers.hideEmbeddedActions),this.timers.hideEmbeddedActions=setTimeout(function(){t.fadeOut("fast")},15e3))},showExportLoadDialog:function(){var t=new f({model:this.report});i.showDialog(t,this.t("exportLoad:title"))},onDocumentClick:function(){this.showEmbeddedActions()},onReportFiltered:function(){this.broker.publish("router.navigate",{url:this.report.genClientUrl(),trigger:!1,replace:!0}),this.promised(this.report.fetch())}})});