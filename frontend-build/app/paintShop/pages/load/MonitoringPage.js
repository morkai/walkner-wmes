define(["jquery","app/i18n","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/embedded","app/data/localStorage","app/planning/util/contextMenu","app/paintShop/PaintShopSettingCollection","app/paintShop/PaintShopLoadStats","app/paintShop/PaintShopLoadRecent","app/paintShop/views/load/StatsView","app/paintShop/views/load/RecentView","app/paintShop/views/load/ReasonEditorView","app/paintShop/templates/load/monitoring","i18n!app/nls/reports"],function(t,e,i,s,n,o,a,r,h,c,d,p,u,l,f){"use strict";return s.extend({template:f,layoutName:o.isEnabled()?"blank":"page",pageClassName:"psLoad-monitoring",nlsDomain:"paintShop",breadcrumbs:function(){var t=this;return[{href:"#paintShop/"+(window.WMES_LAST_PAINT_SHOP_DATE||"0d"),label:t.t("BREADCRUMB:base")},this.t("BREADCRUMB:load"),{href:"#paintShop/load/monitoring?counter="+t.counter,label:t.t("load:counters:"+t.counter),template:function(e){return'<a id="'+t.idPrefix+'-pickCounter" href="'+e.href+'">'+e.label+"</a>"}}]},actions:function(){return o.isEnabled()?[]:[{icon:"warning",label:this.t("load:reasons:pageAction"),callback:this.showReasonEditor.bind(this),privileges:["PAINT_SHOP:MANAGE","PAINT_SHOP:PAINTER"]},{href:"#paintShop/load/history",icon:"list",label:this.t("load:history:pageAction")},{href:"#paintShop/load/report",icon:"line-chart",label:this.t("load:report:pageAction")},{href:"#paintShop;settings?tab=load",icon:"cogs",label:this.t("PAGE_ACTION:settings"),privileges:"PAINT_SHOP:MANAGE"}]},localTopics:{"socket.connected":function(){this.promised(this.settings.fetch()),this.promised(this.stats.fetch()),this.promised(this.recent.fetch())}},remoteTopics:{"paintShop.load.updated":function(t){t.counter===this.counter&&(this.stats.set(t.stats),this.recent.update(t.items))}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.setView("#-stats",this.statsView),this.setView("#-recent",this.recentView)},destroy:function(){t(document).off("."+this.idPrefix)},defineModels:function(){this.counter=this.options.counter>0?this.options.counter:(o.isEnabled()?+a.getItem("WMES_PS_LOAD_COUNTER"):0)||1,this.settings=n(new h(null,{pubsub:this.pubsub}),this),this.stats=n(new c({counter:this.counter}),this),this.recent=n(new d({counter:this.counter}),this)},defineViews:function(){this.statsView=new p({settings:this.settings,stats:this.stats}),this.recentView=new u({settings:this.settings,recent:this.recent,embedded:o.isEnabled()})},defineBindings:function(){var e=this;e.once("afterRender",function(){o.isEnabled()&&window.parent.postMessage({type:"ready",app:"ps-load"},"*"),t(document).on("click."+e.idPrefix,e.onDocumentClick.bind(e)).on("click."+e.idPrefix,"#"+e.idPrefix+"-pickCounter",e.onBreadcrumbsClick.bind(e))}),e.listenTo(e.stats,"change",function(){clearTimeout(e.timers.reloadStats),e.timers.reloadStats=setTimeout(e.stats.fetch.bind(e.stats,{showLoadingMessage:!1}),6e4)})},load:function(t){return t(this.settings.fetch(),this.stats.fetch(),this.recent.fetch())},getTemplateData:function(){return{counterLabel:o.isEnabled()?this.t("load:counters:"+this.counter):null}},afterRender:function(){o.render(this,{actions:{showReasonEditor:{icon:"fa-warning",title:this.t("load:reasons:action"),handler:this.showReasonEditor.bind(this),separator:!0}}}),this.showEmbeddedActions()},showReasonEditor:function(){var t=new l({settings:this.settings,model:{counter:this.counter}});i.showDialog(t,this.t("load:reasons:title"))},showEmbeddedActions:function(){var t=this.$(".embedded-actions");t.length&&(t.fadeIn("fast"),clearTimeout(this.timers.hideEmbeddedActions),this.timers.hideEmbeddedActions=setTimeout(function(){t.fadeOut("fast")},15e3))},showCounterPicker:function(t,e){var i=this,s=[1,2,3].map(function(t){return{label:i.t("load:counters:"+t),handler:i.setCounter.bind(i,t),disabled:t===i.counter}});r.show(i,t,e,s)},setCounter:function(t){this.counter=t,this.layout&&this.layout.setBreadcrumbs&&this.layout.setBreadcrumbs(this.breadcrumbs,this),this.stats.set("counter",this.counter),this.recent.set("counter",this.counter),this.promised(this.stats.fetch()),this.promised(this.recent.fetch()),o.isEnabled()?(a.setItem("WMES_PS_LOAD_COUNTER",this.counter.toString()),this.$id("pickCounter").text(this.t("load:counters:"+this.counter))):this.broker.publish("router.navigate",{url:"/paintShop/load/monitoring?counter="+this.counter,replace:!0,trigger:!1})},setUpLayout:function(t){this.layout=t},onDocumentClick:function(){this.showEmbeddedActions()},onBreadcrumbsClick:function(t){return this.showCounterPicker(t.pageY,t.pageX),!1}})});