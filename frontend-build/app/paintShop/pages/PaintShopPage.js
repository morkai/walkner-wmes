// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/getShiftStartInfo","app/production/views/VkbView","../PaintShopOrder","../views/PaintShopQueueView","../views/PaintShopListView","../views/PaintShopDatePickerView","app/paintShop/templates/page"],function(t,e,i,s,n,o,r,a,h,c,d,u,l,p){"use strict";var w=!0;return o.extend({template:p,layoutName:"page",pageId:"paintShop",breadcrumbs:function(){return[i.bound("paintShop","BREADCRUMBS:base"),i.bound("paintShop","BREADCRUMBS:queue"),{href:"#paintShop/"+this.orders.getDateFilter(),label:this.orders.getDateFilter("L")}]},actions:function(){var t=[];return w||t.push({type:"link",icon:"arrows-alt",callback:this.toggleFullscreen.bind(this)}),t},localTopics:{"socket.connected":function(){this.$el.removeClass("paintShop-is-disconnected")},"socket.disconnected":function(){this.$el.addClass("paintShop-is-disconnected")}},remoteTopics:{"paintShop.orders.changed.*":function(t){var e=this.orders.getDateFilter(),i=s.utc.format(t.date,"YYYY-MM-DD");i===e&&this.orders.applyChanges(t.changes)},"paintShop.orders.updated.*":function(t){var e=this.orders.get(t._id);e&&e.set(c.parse(t))}},events:{"click .paintShop-tab[data-mrp]":function(t){this.orders.selectMrp(t.currentTarget.dataset.mrp)},"mousedown #-switchApps":function(t){this.startActionTimer("switchApps",t)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(t){this.startActionTimer("reboot",t)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(t){this.startActionTimer("shutdown",t)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},initialize:function(){this.onResize=t.debounce(this.resize.bind(this),30),this.actionTimer={action:null,time:null},this.defineModels(),this.defineViews(),this.defineBindings(),this.setView("#-queue",this.queueView),this.setView("#-list-all",this.allListView),this.setView("#-list-work",this.workListView),w&&this.setView("#-vkb",this.vkbView)},setUpLayout:function(t){this.layout=t},destroy:function(){e(".modal").addClass("fade"),e(document.body).css("overflow","").removeClass("paintShop-is-fullscreen paintShop-is-embedded"),e(window).off("."+this.idPrefix),e(document).off("."+this.idPrefix)},defineModels:function(){this.orders=r(this.model.orders,this)},defineViews:function(){this.vkbView=w?new h:null,this.queueView=new d({model:this.orders,vkb:this.vkbView}),this.allListView=new u({model:this.orders,showTimes:!1,showSearch:!0,vkb:this.vkbView}),this.workListView=new u({model:this.orders,showTimes:!0,showSearch:!1,filter:function(t){return"started"===t.status||"finished"===t.status},sort:function(t,e){return"started"===t.status?t.status===e.status?t.startedAt-e.startedAt:-1:e.startedAt-t.startedAt}})},defineBindings:function(){var t=this,i=t.idPrefix;t.listenTo(t.orders,"reset",this.onOrdersReset),t.listenTo(t.orders,"mrpSelected",this.onMrpSelected),e(document).on("click."+i,".page-breadcrumbs",this.onBreadcrumbsClick.bind(this)),e(window).on("resize."+i,this.onResize),w&&t.once("afterRender",function(){window.parent.postMessage({type:"ready",app:"paintShop"},"*")})},load:function(t){return t(this.orders.fetch({reset:!0}))},serialize:function(){return{idPrefix:this.idPrefix,embedded:w,height:this.calcInitialHeight()+"px",tabs:this.serializeTabs()}},serializeTabs:function(){var t=this.orders;return t.allMrps.map(function(e){return{mrp:e,label:e,active:t.selectedMrp===e}})},beforeRender:function(){document.body.style.overflow="hidden",document.body.classList.toggle("paintShop-is-fullscreen",this.isFullscreen()),document.body.classList.toggle("paintShop-is-embedded",w)},afterRender:function(){e(".modal.fade").removeClass("fade"),this.options.selectedMrp&&(this.$('.paintShop-tab[data-mrp="'+this.options.selectedMrp+'"]').click(),this.options.selectedMrp=null),this.resize()},resize:function(){this.el.style.height=this.calcHeight()+"px"},isFullscreen:function(){return w||this.options.fullscreen||window.innerWidth<=800||window.outerWidth===window.screen.width&&window.outerHeight===window.screen.height},calcInitialHeight:function(){var t=window.innerHeight-15;return t-=this.isFullscreen()?64:151},calcHeight:function(){var t=this.isFullscreen(),i=window.innerHeight-15;return document.body.classList.toggle("paintShop-is-fullscreen",t),i-=t?e(".hd").outerHeight(!0)+30:e(".hd").outerHeight(!0)+e(".ft").outerHeight(!0)},toggleFullscreen:function(){this.options.fullscreen=!this.options.fullscreen,this.updateUrl(),this.resize()},renderTabs:function(){var t="";this.serializeTabs().forEach(function(e){t+='<div class="paintShop-tab '+(e.active?"is-active":"")+'" data-mrp="'+e.mrp+'">'+e.label+"</div>"}),t+='<div class="paintShop-tab"></div>',this.$id("tabs").html(t)},updateUrl:function(){this.broker.publish("router.navigate",{url:this.genClientUrl(),replace:!0,trigger:!1})},genClientUrl:function(){var t=[];return"all"!==this.orders.selectedMrp&&t.push("mrp="+this.orders.selectedMrp),this.options.fullscreen&&t.push("fullscreen=1"),this.orders.genClientUrl()+"?"+t.join("&")},onOrdersReset:function(){var t=this;t.layout&&t.layout.setBreadcrumbs(t.breadcrumbs,t),t.broker.publish("router.navigate",{url:this.genClientUrl(),trigger:!1,replace:!0}),this.renderTabs()},onMrpSelected:function(){this.updateUrl(),this.$(".paintShop-tab.is-active").removeClass("is-active"),"all"!==this.orders.selectedMrp&&this.$('.paintShop-tab[data-mrp="'+this.orders.selectedMrp+'"]').addClass("is-active")},onBreadcrumbsClick:function(t){if("A"===t.target.tagName)return this.showDatePickerDialog(),!1},showDatePickerDialog:function(){var t=new l({model:{date:this.orders.getDateFilter()},vkb:this.vkbView});this.listenTo(t,"picked",function(t){n.closeDialog(),t!==this.orders.getDateFilter()&&(this.orders.setDateFilter(t),this.orders.fetch({reset:!0}))}),n.showDialog(t)},startActionTimer:function(t,e){this.actionTimer.action=t,this.actionTimer.time=Date.now(),e&&e.preventDefault()},stopActionTimer:function(t){if(this.actionTimer.action===t){var e=Date.now()-this.actionTimer.time>3e3;"switchApps"===t?e?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"mrl"},"*"):"reboot"===t?e?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):e&&"shutdown"===t&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}}})});