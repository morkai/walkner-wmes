// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/getShiftStartInfo","../PaintShopOrder","../views/PaintShopQueueView","app/paintShop/templates/page"],function(e,s,t,i,n,r,a,o,d,u,h){"use strict";return r.extend({template:h,layoutName:"page",pageId:"paintShop",breadcrumbs:function(){return[t.bound("paintShop","BREADCRUMBS:base"),t.bound("paintShop","BREADCRUMBS:queue"),this.orders.getDateFilter("L")]},actions:[],localTopics:{"socket.connected":function(){this.$el.removeClass("paintShop-is-disconnected")},"socket.disconnected":function(){this.$el.addClass("paintShop-is-disconnected")}},remoteTopics:{"paintShopOrders.updated.**":function(e){}},events:{},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.setView("#"+this.idPrefix+"-queue",this.queueView)},setUpLayout:function(e){this.layout=e},destroy:function(){document.body.style.overflow="",document.body.classList.remove("paintShop-is-fullscreen"),s(window).off("."+this.idPrefix),s(document).off("."+this.idPrefix)},defineModels:function(){this.orders=a(this.model.orders,this)},defineViews:function(){this.queueView=new u({model:this.orders})},defineBindings:function(){var e=this,t=e.idPrefix;e.listenTo(e.orders,"sync",this.onOrdersSync);var i=e.handleDragEvent.bind(e);s(document).on("dragstart."+t,i).on("dragenter."+t,i).on("dragleave."+t,i).on("dragover."+t,i).on("drop."+t,e.onDrop.bind(e))},load:function(e){return e(this.orders.fetch({reset:!0}))},applyPendingChanges:function(){this.pendingChanges&&(this.pendingChanges.forEach(this.applyChanges,this),this.pendingChanges=null)},applyChanges:function(e){if(e instanceof d){var s=e,t=this.orders.get(s.id);t?s.get("updatedAt")>t.get("updatedAt")&&t.set(s.attributes):this.requests.add(s)}else{var i=this.requests.get(e._id);if(!i)return this.scheduleOrdersReload();e.updatedAt>i.get("updatedAt")&&i.set(e)}},scheduleOrdersReload:function(){clearTimeout(this.timers.reloadOrders),this.timers.reloadOrders=setTimeout(function(e){e.promised(e.orders.fetch({reset:!0}))},1,this)},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){},acceptRequest:function(e,s){var t=this;this.requests.accept(e.id,{id:s.id,label:s.getLabel()},function(i){i?t.showMessage("error",5e3,acceptFailureMessage({error:i.message})):t.showMessage("info",1e4,acceptSuccessMessage({whman:s.getLabel(),requestType:e.get("type"),orgUnit:e.get("orgUnit"),palletKind:e.getFullPalletKind()}))})},finishResponse:function(e){var s=this,t=e.get("type");this.requests.finish(e.id,function(i){i?s.showMessage("error",5e3,finishFailureMessage({error:i.message})):s.showMessage("success",2500,finishSuccessMessage({type:t,line:e.getProdLineId()}))})},showMessage:function(e,s,t){this.timers.hideMessage&&clearTimeout(this.timers.hideMessage);var i=this.$id("messageOverlay"),n=this.$id("message");i.css("display","block"),n.html(t).css({display:"block",marginLeft:"-5000px"}).removeClass("message-error message-warning message-success message-info").addClass("message-"+e),n.css({display:"none",marginTop:n.outerHeight()/2*-1+"px",marginLeft:n.outerWidth()/2*-1+"px"}),n.fadeIn(),this.timers.hideMessage=setTimeout(this.hideMessage.bind(this),s)},hideMessage:function(){if(this.timers.hideMessage){clearTimeout(this.timers.hideMessage);var e=this,s=e.$id("messageOverlay"),t=e.$id("message");t.fadeOut(function(){s.css("display","none"),t.css("display","none"),e.timers.hideMessage=null})}},toggleFullscreen:function(){this.options.fullscreen=!this.options.fullscreen,this.broker.publish("router.navigate",{url:"#paintShop"+(this.options.fullscreen?"?fullscreen=1":""),replace:!0,trigger:!1}),this.resize()},handleDragEvent:function(e){e.preventDefault(),e.stopPropagation()},onDrop:function(s){if(s=s.originalEvent,s.preventDefault(),s.stopPropagation(),!s.dataTransfer.files.length)return n.msg.show({type:"warning",time:3e3,text:t("paintShop","msg:filesOnly")});var r=e.find(s.dataTransfer.files,function(e){return/vnd.ms-excel.sheet|spreadsheetml.sheet/.test(e.type)&&/\.xls[xm]$/.test(e.name)});if(!r)return n.msg.show({type:"warning",time:3e3,text:t("paintShop","msg:invalidFile")});n.msg.loading();var a=new FormData;a.append("queue",r);var o=this,d=o.ajax({type:"POST",url:"/paintShop/orders;import",data:a,processData:!1,contentType:!1});d.fail(function(){n.msg.loadingFailed()}),d.done(function(e){n.msg.loaded(),o.orders.setDateFilter(i.utc.format(e.date,"YYYY-MM-DD")),o.promised(o.orders.fetch({reset:!0}))})},onOrdersSync:function(){var e=this;e.layout&&e.layout.setBreadcrumbs(e.breadcrumbs,e),e.broker.publish("router.navigate",{url:"/paintShop/"+(e.orders.isDateFilter("current")?"current":e.orders.getDateFilter()),trigger:!1,replace:!0})}})});