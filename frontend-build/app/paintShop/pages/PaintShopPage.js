// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/getShiftStartInfo","../PaintShopOrder","../views/PaintShopQueueView","app/paintShop/templates/page"],function(e,t,i,s,n,r,o,a,d,h,l){"use strict";return r.extend({template:l,layoutName:"page",pageId:"paintShop",breadcrumbs:function(){return[i.bound("paintShop","BREADCRUMBS:base"),i.bound("paintShop","BREADCRUMBS:queue"),this.orders.getDateFilter("L")]},actions:function(){return[{type:"link",icon:"arrows-alt",callback:this.toggleFullscreen.bind(this)}]},localTopics:{"socket.connected":function(){this.$el.removeClass("paintShop-is-disconnected")},"socket.disconnected":function(){this.$el.addClass("paintShop-is-disconnected")}},remoteTopics:{"paintShopOrders.updated.**":function(e){}},events:{},initialize:function(){this.onResize=e.debounce(this.resize.bind(this),30),this.defineModels(),this.defineViews(),this.defineBindings(),this.setView("#"+this.idPrefix+"-queue",this.queueView)},setUpLayout:function(e){this.layout=e},destroy:function(){document.body.style.overflow="",document.body.classList.remove("paintShop-is-fullscreen"),t(window).off("."+this.idPrefix),t(document).off("."+this.idPrefix)},defineModels:function(){this.orders=o(this.model.orders,this)},defineViews:function(){this.queueView=new h({model:this.orders})},defineBindings:function(){var e=this,i=e.idPrefix;e.listenTo(e.orders,"sync",this.onOrdersSync);var s=e.handleDragEvent.bind(e);t(document).on("dragstart."+i,s).on("dragenter."+i,s).on("dragleave."+i,s).on("dragover."+i,s).on("drop."+i,e.onDrop.bind(e)),t(window).on("resize."+this.idPrefix,this.onResize)},load:function(e){return e(this.orders.fetch({reset:!0}))},applyPendingChanges:function(){this.pendingChanges&&(this.pendingChanges.forEach(this.applyChanges,this),this.pendingChanges=null)},applyChanges:function(e){if(e instanceof d){var t=e,i=this.orders.get(t.id);i?t.get("updatedAt")>i.get("updatedAt")&&i.set(t.attributes):this.requests.add(t)}else{var s=this.requests.get(e._id);if(!s)return this.scheduleOrdersReload();e.updatedAt>s.get("updatedAt")&&s.set(e)}},scheduleOrdersReload:function(){clearTimeout(this.timers.reloadOrders),this.timers.reloadOrders=setTimeout(function(e){e.promised(e.orders.fetch({reset:!0}))},1,this)},serialize:function(){return{idPrefix:this.idPrefix,height:this.calcInitialHeight()+"px"}},beforeRender:function(){document.body.style.overflow="hidden",document.body.classList.toggle("paintShop-is-fullscreen",this.isFullscreen())},afterRender:function(){this.resize();var e=this.$(".paintShop-groups");e.length&&(e[0].style.display="")},resize:function(){this.el.style.height=this.calcHeight()+"px"},isFullscreen:function(){return this.options.fullscreen||window.innerWidth<=800||window.outerWidth===window.screen.width&&window.outerHeight===window.screen.height},calcInitialHeight:function(){var e=window.innerHeight-15;return e-=this.isFullscreen()?64:151},calcHeight:function(){var e=this.isFullscreen(),i=window.innerHeight-15;return document.body.classList.toggle("paintShop-is-fullscreen",e),i-=e?t(".hd").outerHeight(!0)+30:t(".hd").outerHeight(!0)+t(".ft").outerHeight(!0)},acceptRequest:function(e,t){var i=this;this.requests.accept(e.id,{id:t.id,label:t.getLabel()},function(s){s?i.showMessage("error",5e3,acceptFailureMessage({error:s.message})):i.showMessage("info",1e4,acceptSuccessMessage({whman:t.getLabel(),requestType:e.get("type"),orgUnit:e.get("orgUnit"),palletKind:e.getFullPalletKind()}))})},finishResponse:function(e){var t=this,i=e.get("type");this.requests.finish(e.id,function(s){s?t.showMessage("error",5e3,finishFailureMessage({error:s.message})):t.showMessage("success",2500,finishSuccessMessage({type:i,line:e.getProdLineId()}))})},showMessage:function(e,t,i){this.timers.hideMessage&&clearTimeout(this.timers.hideMessage);var s=this.$id("messageOverlay"),n=this.$id("message");s.css("display","block"),n.html(i).css({display:"block",marginLeft:"-5000px"}).removeClass("message-error message-warning message-success message-info").addClass("message-"+e),n.css({display:"none",marginTop:n.outerHeight()/2*-1+"px",marginLeft:n.outerWidth()/2*-1+"px"}),n.fadeIn(),this.timers.hideMessage=setTimeout(this.hideMessage.bind(this),t)},hideMessage:function(){if(this.timers.hideMessage){clearTimeout(this.timers.hideMessage);var e=this,t=e.$id("messageOverlay"),i=e.$id("message");i.fadeOut(function(){t.css("display","none"),i.css("display","none"),e.timers.hideMessage=null})}},toggleFullscreen:function(){this.options.fullscreen=!this.options.fullscreen,this.broker.publish("router.navigate",{url:this.genClientUrl(),replace:!0,trigger:!1}),this.resize()},handleDragEvent:function(e){e.preventDefault(),e.stopPropagation()},onDrop:function(t){if(t=t.originalEvent,t.preventDefault(),t.stopPropagation(),!t.dataTransfer.files.length)return n.msg.show({type:"warning",time:3e3,text:i("paintShop","msg:filesOnly")});var r=e.find(t.dataTransfer.files,function(e){return/vnd.ms-excel.sheet|spreadsheetml.sheet/.test(e.type)&&/\.xls[xm]$/.test(e.name)});if(!r)return n.msg.show({type:"warning",time:3e3,text:i("paintShop","msg:invalidFile")});n.msg.loading();var o=new FormData;o.append("queue",r);var a=this,d=a.ajax({type:"POST",url:"/paintShop/orders;import",data:o,processData:!1,contentType:!1});d.fail(function(){n.msg.loadingFailed()}),d.done(function(e){n.msg.loaded(),a.orders.setDateFilter(s.utc.format(e.date,"YYYY-MM-DD")),a.promised(a.orders.fetch({reset:!0}))})},genClientUrl:function(){return this.orders.genClientUrl()+(this.options.fullscreen?"?fullscreen=1":"")},onOrdersSync:function(){var e=this;e.layout&&e.layout.setBreadcrumbs(e.breadcrumbs,e),e.broker.publish("router.navigate",{url:this.genClientUrl(),trigger:!1,replace:!0})}})});