// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/getShiftStartInfo","../PaintShopOrder","../views/PaintShopQueueView","app/paintShop/templates/page"],function(e,s,t,i,n,r,a,o,d,h,u){"use strict";return r.extend({template:u,layoutName:"page",pageId:"paintShop",breadcrumbs:function(){var e=[t.bound("paintShop","BREADCRUMBS:base"),t.bound("paintShop","BREADCRUMBS:queue")];return this.orders.rqlQuery.selector.args.forEach(function(s){"eq"===s.name&&"date"===s.args[0]&&("current"===s.args[1]?e.push(o(Date.now()).moment.format("L")):e.push(i.getMoment(s.args[1]).format("L")))}),e},actions:[],localTopics:{"socket.connected":function(){this.promised(this.orders.fetch({reset:!0})),this.$el.removeClass("paintShop-is-disconnected")},"socket.disconnected":function(){this.$el.addClass("paintShop-is-disconnected")}},remoteTopics:{"paintShopOrders.updated.**":function(e){}},events:{},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings(),this.setView("#"+this.idPrefix+"-queue",this.queueView)},setUpLayout:function(e){this.layout=e},destroy:function(){document.body.style.overflow="",document.body.classList.remove("paintShop-is-fullscreen"),s(window).off("."+this.idPrefix)},defineModels:function(){this.orders=a(this.model.orders,this)},defineViews:function(){this.queueView=new h({model:this.orders})},defineBindings:function(){this.listenTo(this.orders,"sync",this.onOrdersSync)},load:function(e){return e(this.orders.fetch({reset:!0}))},applyPendingChanges:function(){this.pendingChanges&&(this.pendingChanges.forEach(this.applyChanges,this),this.pendingChanges=null)},applyChanges:function(e){if(e instanceof d){var s=e,t=this.orders.get(s.id);t?s.get("updatedAt")>t.get("updatedAt")&&t.set(s.attributes):this.requests.add(s)}else{var i=this.requests.get(e._id);if(!i)return this.scheduleOrdersReload();e.updatedAt>i.get("updatedAt")&&i.set(e)}},scheduleOrdersReload:function(){clearTimeout(this.timers.reloadOrders),this.timers.reloadOrders=setTimeout(function(e){e.promised(e.orders.fetch({reset:!0}))},1,this)},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){},acceptRequest:function(e,s){var t=this;this.requests.accept(e.id,{id:s.id,label:s.getLabel()},function(i){i?t.showMessage("error",5e3,acceptFailureMessage({error:i.message})):t.showMessage("info",1e4,acceptSuccessMessage({whman:s.getLabel(),requestType:e.get("type"),orgUnit:e.get("orgUnit"),palletKind:e.getFullPalletKind()}))})},finishResponse:function(e){var s=this,t=e.get("type");this.requests.finish(e.id,function(i){i?s.showMessage("error",5e3,finishFailureMessage({error:i.message})):s.showMessage("success",2500,finishSuccessMessage({type:t,line:e.getProdLineId()}))})},showMessage:function(e,s,t){this.timers.hideMessage&&clearTimeout(this.timers.hideMessage);var i=this.$id("messageOverlay"),n=this.$id("message");i.css("display","block"),n.html(t).css({display:"block",marginLeft:"-5000px"}).removeClass("message-error message-warning message-success message-info").addClass("message-"+e),n.css({display:"none",marginTop:n.outerHeight()/2*-1+"px",marginLeft:n.outerWidth()/2*-1+"px"}),n.fadeIn(),this.timers.hideMessage=setTimeout(this.hideMessage.bind(this),s)},hideMessage:function(){if(this.timers.hideMessage){clearTimeout(this.timers.hideMessage);var e=this,s=e.$id("messageOverlay"),t=e.$id("message");t.fadeOut(function(){s.css("display","none"),t.css("display","none"),e.timers.hideMessage=null})}},toggleFullscreen:function(){this.options.fullscreen=!this.options.fullscreen,this.broker.publish("router.navigate",{url:"#paintShop"+(this.options.fullscreen?"?fullscreen=1":""),replace:!0,trigger:!1}),this.resize()},onOrdersSync:function(){this.layout&&this.layout.setBreadcrumbs(this.breadcrumbs,this)}})});