// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/getShiftStartInfo","../PaintShopOrder","../views/PaintShopQueueView","../views/PaintShopListView","app/paintShop/templates/page"],function(e,t,i,n,s,o,r,a,d,c,u,h){"use strict";var l=window.parent!==window;return o.extend({template:h,layoutName:"page",pageId:"paintShop",breadcrumbs:function(){return[i.bound("paintShop","BREADCRUMBS:base"),i.bound("paintShop","BREADCRUMBS:queue"),{href:"#paintShop/"+this.orders.getDateFilter(),label:this.orders.getDateFilter("L")}]},actions:function(){var e=[{type:"link",icon:"filter",className:"disabled",callback:function(){}},{type:"link",icon:"paint-brush",className:"disabled",callback:function(){}},{type:"link",icon:"truck",className:"disabled",callback:function(){}}];return l||e.push({type:"link",icon:"arrows-alt",callback:this.toggleFullscreen.bind(this)}),e},localTopics:{"socket.connected":function(){this.$el.removeClass("paintShop-is-disconnected")},"socket.disconnected":function(){this.$el.addClass("paintShop-is-disconnected")}},remoteTopics:{shiftChanged:function(e){1===e.no&&this.orders.isDateCurrent()&&this.orders.fetch({reset:!0})},"paintShop.orders.imported":function(e){var t=this.orders.getDateFilter(),i=n.format(e.date,"YYYY-MM-DD");i===t&&this.orders.fetch({reset:!0})},"paintShop.orders.updated.**":function(e){var t=this.orders.get(e._id);t&&t.set(d.parse(e))}},events:{"mousedown #-switchApps":function(e){this.startActionTimer("switchApps",e)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(e){this.startActionTimer("reboot",e)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(e){this.startActionTimer("shutdown",e)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},initialize:function(){this.onResize=e.debounce(this.resize.bind(this),30),this.actionTimer={action:null,time:null},this.defineModels(),this.defineViews(),this.defineBindings(),this.setView("#-queue",this.queueView),this.setView("#-list-all",this.allListView),this.setView("#-list-work",this.workListView)},setUpLayout:function(e){this.layout=e},destroy:function(){t(".modal").addClass("fade"),t(document.body).css("overflow","").removeClass("paintShop-is-fullscreen paintShop-is-embedded"),t(window).off("."+this.idPrefix),t(document).off("."+this.idPrefix)},defineModels:function(){this.orders=r(this.model.orders,this)},defineViews:function(){this.queueView=new c({model:this.orders}),this.allListView=new u({model:this.orders,showTimes:!1,filter:null}),this.workListView=new u({model:this.orders,showTimes:!0,filter:function(e){return"started"===e.status||"finished"===e.status},sort:function(e,t){return"started"===e.status?e.status===t.status?e.startedAt-t.startedAt:-1:t.startedAt-e.startedAt}})},defineBindings:function(){var e=this,i=e.idPrefix,n=e.handleDragEvent.bind(e);e.listenTo(e.orders,"reset",this.onOrdersReset),t(document).on("dragstart."+i,n).on("dragenter."+i,n).on("dragleave."+i,n).on("dragover."+i,n).on("drop."+i,e.onDrop.bind(e)).on("click."+i,".page-breadcrumbs",this.onBreadcrumbsClick.bind(this)),t(window).on("resize."+i,this.onResize),l&&e.once("afterRender",function(){window.parent.postMessage({type:"ready",app:"paintShop"},"*")})},load:function(e){return e(this.orders.fetch({reset:!0}))},applyPendingChanges:function(){this.pendingChanges&&(this.pendingChanges.forEach(this.applyChanges,this),this.pendingChanges=null)},applyChanges:function(e){if(e instanceof d){var t=e,i=this.orders.get(t.id);i?t.get("updatedAt")>i.get("updatedAt")&&i.set(t.attributes):this.requests.add(t)}else{var n=this.requests.get(e._id);if(!n)return this.scheduleOrdersReload();e.updatedAt>n.get("updatedAt")&&n.set(e)}},scheduleOrdersReload:function(){clearTimeout(this.timers.reloadOrders),this.timers.reloadOrders=setTimeout(function(e){e.promised(e.orders.fetch({reset:!0}))},1,this)},serialize:function(){return{idPrefix:this.idPrefix,embedded:l,height:this.calcInitialHeight()+"px"}},beforeRender:function(){document.body.style.overflow="hidden",document.body.classList.toggle("paintShop-is-fullscreen",this.isFullscreen()),document.body.classList.toggle("paintShop-is-embedded",l)},afterRender:function(){t(".modal.fade").removeClass("fade"),this.resize()},resize:function(){this.el.style.height=this.calcHeight()+"px"},isFullscreen:function(){return l||this.options.fullscreen||window.innerWidth<=800||window.outerWidth===window.screen.width&&window.outerHeight===window.screen.height},calcInitialHeight:function(){var e=window.innerHeight-15;return e-=this.isFullscreen()?64:151},calcHeight:function(){var e=this.isFullscreen(),i=window.innerHeight-15;return document.body.classList.toggle("paintShop-is-fullscreen",e),i-=e?t(".hd").outerHeight(!0)+30:t(".hd").outerHeight(!0)+t(".ft").outerHeight(!0)},toggleFullscreen:function(){this.options.fullscreen=!this.options.fullscreen,this.broker.publish("router.navigate",{url:this.genClientUrl(),replace:!0,trigger:!1}),this.resize()},handleDragEvent:function(e){e.preventDefault(),e.stopPropagation()},onDrop:function(t){if(t=t.originalEvent,t.preventDefault(),t.stopPropagation(),!t.dataTransfer.files.length)return s.msg.show({type:"warning",time:3e3,text:i("paintShop","msg:filesOnly")});var o=e.find(t.dataTransfer.files,function(e){return/vnd.ms-excel.sheet|spreadsheetml.sheet/.test(e.type)&&/\.xls[xm]$/.test(e.name)});if(!o)return s.msg.show({type:"warning",time:3e3,text:i("paintShop","msg:invalidFile")});s.msg.loading();var r=new FormData;r.append("queue",o);var a=this,d=a.ajax({type:"POST",url:"/paintShop/orders;import",data:r,processData:!1,contentType:!1});d.fail(function(){s.msg.loadingFailed()}),d.done(function(e){s.msg.loaded(),a.orders.setDateFilter(n.utc.format(e.date,"YYYY-MM-DD")),a.promised(a.orders.fetch({reset:!0}))})},genClientUrl:function(){return this.orders.genClientUrl()+(this.options.fullscreen?"?fullscreen=1":"")},onOrdersReset:function(){var e=this;e.layout&&e.layout.setBreadcrumbs(e.breadcrumbs,e),e.broker.publish("router.navigate",{url:this.genClientUrl(),trigger:!1,replace:!0})},onBreadcrumbsClick:function(e){function i(e){""===e&&(e=a(Date.now()).moment.format("YYYY-MM-DD"));var t=n.getMoment(e,"YYYY-MM-DD");d.remove(),t.isValid()&&e!==r?(o.orders.setDateFilter(e),o.orders.fetch({reset:!0})):e=r,s.innerHTML='<a href="#paintShop/'+e+'">'+n.getMoment(e,"YYYY-MM-DD").format("L")+"</a>"}if("A"===e.target.tagName){var s=e.target.parentNode;s.innerHTML="";var o=this,r=o.orders.getDateFilter("YYYY-MM-DD"),d=t('<input type="date" class="form-control paintShop-dateBreadcrumb">').val(r).appendTo(s).focus().on("keyup",function(e){return 13===e.keyCode?(i(d.val()),!1):27===e.keyCode?(i(null),!1):void 0}).on("blur",function(){i(d.val())});return!1}},startActionTimer:function(e,t){this.actionTimer.action=e,this.actionTimer.time=Date.now(),t&&t.preventDefault()},stopActionTimer:function(e){if(this.actionTimer.action===e){var t=Date.now()-this.actionTimer.time>3e3;"switchApps"===e?t?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"mrl"},"*"):"reboot"===e?t?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):t&&"shutdown"===e&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}}})});