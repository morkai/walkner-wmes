define(["jquery","app/i18n","app/time","app/core/View","app/paintShop/templates/paintPicker"],function(i,t,n,e,a){"use strict";return e.extend({template:a,dialogClassName:"paintShop-paintPicker-dialog",events:{"focus [data-vkb]":function(i){this.options.vkb&&this.options.vkb.show(i.target,this.onVkbValueChange)},"click .paintShop-paintPicker-paint":function(i){this.$(".active").removeClass("active"),i.currentTarget.classList.add("active")},"input #-filter":"onVkbValueChange",submit:function(){return!1},"click #-select":function(){this.trigger("picked",this.$(".active").val())},"click #-msp":function(){this.trigger("picked","msp")},"click #-all":function(){this.trigger("picked","all")}},modelProperty:"orders",initialize:function(){this.onVkbValueChange=this.onVkbValueChange.bind(this),i(window).on("resize."+this.idPrefix,this.resize.bind(this))},destroy:function(){i(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide()},getTemplateData:function(){var i=this.orders,t=this.dropZones,n={},e=[],a={},s={};i.serialize().forEach(function(i){Object.keys(i.paints).forEach(function(i){n[i]=1}),i.childOrders.forEach(function(i){var t=0;i.components.forEach(function(i){t+="G"!==i.unit&&"KG"!==i.unit?0:1}),i.components.forEach(function(n){"G"!==n.unit&&"KG"!==n.unit||(a[n.nc12]||(a[n.nc12]=0,s[n.nc12]=0),a[n.nc12]+=n.qty,s[n.nc12]+=i.manHours/t)})})});var r=i.settings.getValue("mspPaints")||[];return Object.keys(n).forEach(function(n){if(-1===r.indexOf(n)){var o=i.paints.get(n),c=i.totalQuantities[n],p=c?c.new+c.started+c.partial:0;e.push({nc12:n,name:o?o.get("name"):"",dropped:t.getState(n),totals:c,remaining:p,weight:a[n]||0,manHours:Math.round(100*(s[n]||0))/100,className:c&&0!==p?"default":"success"})}}),e.sort(function(i,t){return i.remaining===t.remaining?i.nc12.localeCompare(t.nc12):t.remaining-i.remaining}),{paints:e,mspDropped:t.getState("msp")}},afterRender:function(){this.resize();var i=this.$('.paintShop-paintPicker-paint[value="'+this.orders.selectedPaint+'"]');i.length||(i=this.$(".paintShop-paintPicker-paint").first()),i.click().focus(),this.$id("filter").focus()},resize:function(){var i=window.innerHeight-this.$(".paintShop-paintPicker-filter").outerHeight()-this.$(".paintShop-paintPicker-buttons").outerHeight()-60-62;this.$(".paintShop-paintPicker-paints").css("height",i+"px")},onVkbValueChange:function(){var i=this.$id("filter").val().trim();if(""===i)this.$(".hidden").removeClass("hidden");else{var t=null;this.$(".paintShop-paintPicker-paint").each(function(){var n=-1===this.value.indexOf(i);this.classList.toggle("hidden",n),t||n||(t=this)}),t&&t.click()}}})});