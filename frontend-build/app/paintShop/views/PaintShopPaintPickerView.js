define(["jquery","app/i18n","app/time","app/core/View","app/paintShop/templates/paintPicker"],function(i,t,e,n,a){"use strict";return n.extend({template:a,dialogClassName:"paintShop-paintPicker-dialog",events:{"focus [data-vkb]":function(i){this.options.vkb&&this.options.vkb.show(i.target,this.onVkbValueChange)},"click .paintShop-paintPicker-paint":function(i){this.$(".active").removeClass("active"),i.currentTarget.classList.add("active")},"input #-filter":"onVkbValueChange",submit:function(){return!1},"click #-select":function(){this.trigger("picked",this.$(".active").val())},"click #-msp":function(){this.trigger("picked","msp")},"click #-all":function(){this.trigger("picked","all")}},initialize:function(){this.onVkbValueChange=this.onVkbValueChange.bind(this),i(window).on("resize."+this.idPrefix,this.resize.bind(this))},destroy:function(){i(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide()},getTemplateData:function(){var i=this.orders,t=this.dropZones,e={},n=[],a={};i.serialize().forEach(function(i){Object.keys(i.paints).forEach(function(i){e[i]=1}),i.childOrders.forEach(function(i){i.components.forEach(function(i){"G"!==i.unit&&"KG"!==i.unit||(a[i.nc12]||(a[i.nc12]=0),a[i.nc12]+=i.qty)})})});var s=i.settings.getValue("mspPaints")||[];return Object.keys(e).forEach(function(e){if(-1===s.indexOf(e)){var r=i.paints.get(e),c=i.totalQuantities[e],o=c?c.new+c.started+c.partial:0;n.push({nc12:e,name:r?r.get("name"):"",dropped:t.getState(e),totals:c,remaining:o,weight:a[e]||0,className:c&&0!==o?"default":"success"})}}),n.sort(function(i,t){return i.remaining===t.remaining?i.nc12.localeCompare(t.nc12):t.remaining-i.remaining}),{paints:n,mspDropped:t.getState("msp")}},afterRender:function(){this.resize();var i=this.$('.paintShop-paintPicker-paint[value="'+this.orders.selectedPaint+'"]');i.length||(i=this.$(".paintShop-paintPicker-paint").first()),i.click().focus(),this.$id("filter").focus()},resize:function(){var i=window.innerHeight-this.$(".paintShop-paintPicker-filter").outerHeight()-this.$(".paintShop-paintPicker-buttons").outerHeight()-60-62;this.$(".paintShop-paintPicker-paints").css("height",i+"px")},onVkbValueChange:function(){var i=this.$id("filter").val().trim();if(""===i)this.$(".hidden").removeClass("hidden");else{var t=null;this.$(".paintShop-paintPicker-paint").each(function(){var e=-1===this.value.indexOf(i);this.classList.toggle("hidden",e),t||e||(t=this)}),t&&t.click()}}})});