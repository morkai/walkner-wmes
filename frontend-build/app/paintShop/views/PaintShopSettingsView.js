define(["underscore","jquery","app/core/util/idAndLabel","app/data/orgUnits","app/settings/views/SettingsView","app/mrpControllers/util/setUpMrpSelect2","app/paintShop/templates/loadStatusRow","app/paintShop/templates/settings"],function(t,e,s,a,i,n,o,r){"use strict";return i.extend({clientUrl:"#paintShop;settings",template:r,events:t.assign({"change input[data-setting]":function(t){this.updateSetting(t.target.name,t.target.value)},'change select[data-property="icon"]':function(t){var e=this.$(t.target).closest("tr"),s="fa-"+t.target.value;e.find(".fa[data-bg]").removeClass().addClass("fa "+s),this.scheduleLoadStatusesSave()},'change input[data-property="color"]':function(t){this.$(t.target).closest("tr").find(".fa[data-bg]").css("color",t.target.value),this.scheduleLoadStatusesSave()},'change input[data-property="from"]':"scheduleLoadStatusesSave",'change input[data-property="to"]':"scheduleLoadStatusesSave","click #-load-addStatus":function(){this.addLoadStatus({from:999,to:9999,icon:"question",color:"#00AAFF"}),this.scheduleLoadStatusesSave()},'click .btn[data-status-action="remove"]':function(t){var e=this.$(t.currentTarget).closest("tr");e.fadeOut("fast",function(){e.find(".colorpicker-component").colorpicker("destroy"),e.remove()}),this.scheduleLoadStatusesSave()}},i.prototype.events),destroy:function(){i.prototype.destroy.apply(this,arguments),this.saveLoadStatusesTimer&&(clearTimeout(this.saveLoadStatusesTimer),this.saveLoadStatuses())},afterRender:function(){i.prototype.afterRender.apply(this,arguments),this.setUpWorkCenters("workCenters"),this.setUpWorkCenters("drillingWorkCenters"),this.setUpUnpaintedMrps(),this.setUpMspPaints(),this.setUpLoadStatuses()},setUpWorkCenters:function(t){this.$id("planning-"+t).select2({width:"100%",allowClear:!0,multiple:!0,data:a.getAllByType("workCenter").filter(function(t){return!t.get("deactivatedAt")}).map(s)}),this.updateSettingField(this.settings.get("paintShop."+t))},setUpUnpaintedMrps:function(){n(this.$id("planning-unpaintedMrps"),{width:"100%"}),this.updateSettingField(this.settings.get("paintShop.unpaintedMrps"))},setUpMspPaints:function(){this.$id("planning-mspPaints").select2({width:"100%",allowClear:!0,multiple:!0,data:this.paints.map(s)}),this.updateSettingField(this.settings.get("paintShop.mspPaints"))},setUpLoadStatuses:function(){this.$id("load-statuses").find(".colorpicker-component").each(function(){e(this).colorpicker("destroy")}),this.$id("load-statuses").empty(),(this.settings.getValue("load.statuses")||[]).forEach(this.addLoadStatus,this)},addLoadStatus:function(t){var s=e(o({idPrefix:this.idPrefix,status:t}));this.$id("load-statuses").append(s),s.find(".colorpicker-component").colorpicker()},scheduleLoadStatusesSave:function(){clearTimeout(this.saveLoadStatusesTimer),this.lastLoadStatuses=this.serializeLoadStatuses(),this.saveLoadStatusesTimer=setTimeout(this.saveLoadStatuses.bind(this),3333)},serializeLoadStatuses:function(){if(!this.el.parentNode)return null;var t=[];return this.$id("load-statuses").find("tr").each(function(){var e=this.querySelector('[data-property="color"]').value;t.push({from:Math.max(0,parseInt(this.querySelector('[data-property="from"]').value,10)||0),to:Math.max(0,parseInt(this.querySelector('[data-property="to"]').value,10)||0),icon:this.querySelector('[data-property="icon"]').value,color:/^#[A-Fa-f0-9]{6}$/.test(e)?e:"#00AAFF"})}),t},saveLoadStatuses:function(){var t=this.serializeLoadStatuses()||this.lastLoadStatuses;this.lastLoadStatuses=null,this.saveLoadStatusesTimer=null,this.updateSetting("paintShop.load.statuses",t)},shouldAutoUpdateSettingField:function(t){return"paintShop.workCenters"!==t.id&&"paintShop.unpaintedMrps"!==t.id&&"paintShop.drillingWorkCenters"!==t.id&&"paintShop.mspPaints"!==t.id&&"paintShop.load.statuses"!==t.id},updateSettingField:function(t){if(t)return/(workCenters|unpaintedMrps|mspPaints)$/i.test(t.id)?this.$id(t.id.replace(".","-")).select2("data",t.getValue().map(function(t){return{id:t,text:t}})):"paintShop.load.statuses"===t.id?this.setUpLoadStatuses():void 0}})});