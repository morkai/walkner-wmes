define(["underscore","jquery","app/core/util/idAndLabel","app/data/orgUnits","app/settings/views/SettingsView","app/mrpControllers/util/setUpMrpSelect2","app/paintShop/templates/loadStatusRow","app/paintShop/templates/settings"],function(t,e,a,s,i,o,n,r){"use strict";return i.extend({clientUrl:"#paintShop;settings",template:r,events:t.assign({"change input[data-setting]":function(t){this.updateSetting(t.target.name,t.target.value)},'change select[data-property="icon"]':function(t){var e=this.$(t.target).closest("tr"),a="fa-"+t.target.value;e.find(".fa[data-bg]").removeClass().addClass("fa "+a),this.scheduleLoadStatusesSave()},'change input[data-property="color"]':function(t){this.$(t.target).closest("tr").find(".fa[data-bg]").css("color",t.target.value),this.scheduleLoadStatusesSave()},'change input[data-property="from"]':"scheduleLoadStatusesSave",'change input[data-property="to"]':"scheduleLoadStatusesSave","click #-load-addStatus":function(){this.addLoadStatus({from:999,to:9999,icon:"question",color:"#00AAFF"}),this.scheduleLoadStatusesSave()},'click .btn[data-status-action="remove"]':function(t){var e=this.$(t.currentTarget).closest("tr");e.fadeOut("fast",function(){e.find(".colorpicker-component").colorpicker("destroy"),e.remove()}),this.scheduleLoadStatusesSave()},"change #-load-counter":function(){this.timers.saveLoadStatuses&&this.saveLoadStatuses(),this.setUpLoadStatuses()}},i.prototype.events),destroy:function(){this.timers.saveLoadStatuses&&(clearTimeout(this.timers.saveLoadStatuses),this.saveLoadStatuses()),i.prototype.destroy.apply(this,arguments)},afterRender:function(){i.prototype.afterRender.apply(this,arguments),this.setUpWorkCenters(),this.setUpMspPaints(),this.setUpLoadStatuses()},setUpWorkCenters:function(){this.$id("planning-workCenters").select2({width:"100%",allowClear:!0,multiple:!0,data:s.getAllByType("workCenter").filter(function(t){return!t.get("deactivatedAt")}).map(a)}),this.updateSettingField(this.settings.get("paintShop.workCenters"))},setUpMspPaints:function(){this.$id("planning-mspPaints").select2({width:"100%",allowClear:!0,multiple:!0,data:this.paints.map(a)}),this.updateSettingField(this.settings.get("paintShop.mspPaints"))},setUpLoadStatuses:function(){this.$id("load-statuses").find(".colorpicker-component").each((t,a)=>e(a).colorpicker("destroy")),this.$id("load-statuses").empty();const t=this.getLoadCounter();this.$id("load-addStatus").prop("disabled",!t),this.$id("load-delayedDuration").prop("disabled",!t).prop("name",`paintShop.load.delayedDuration.${t}`).val(this.settings.getValue(`load.delayedDuration.${t}`,0)),this.settings.getValue(`load.statuses.${t}`,[]).forEach(this.addLoadStatus,this)},addLoadStatus:function(t){const e=this.renderPartial(n,{status:t});this.$id("load-statuses").append(e),e.find(".colorpicker-component").colorpicker()},scheduleLoadStatusesSave:function(){clearTimeout(this.timers.saveLoadStatuses),this.lastLoadStatuses=this.serializeLoadStatuses(),this.lastLoadCounter=this.getLoadCounter(),this.timers.saveLoadStatuses=setTimeout(this.saveLoadStatuses.bind(this),1337)},serializeLoadStatuses:function(){if(!this.el.parentNode)return null;var t=[];return this.$id("load-statuses").find("tr").each(function(){var e=this.querySelector('[data-property="color"]').value;t.push({from:Math.max(0,parseInt(this.querySelector('[data-property="from"]').value,10)||0),to:Math.max(0,parseInt(this.querySelector('[data-property="to"]').value,10)||0),icon:this.querySelector('[data-property="icon"]').value,color:/^#[A-Fa-f0-9]{6}$/.test(e)?e:"#00AAFF"})}),t},saveLoadStatuses:function(){clearTimeout(this.timers.saveLoadStatuses),this.timers.saveLoadStatuses=null;let t=this.getLoadCounter(),e=this.serializeLoadStatuses();e||(t=this.lastLoadCounter,e=this.lastLoadStatuses),this.lastLoadCounter=0,this.lastLoadStatuses=null,t&&e&&this.updateSetting(`paintShop.load.statuses.${t}`,e)},shouldAutoUpdateSettingField:function(t){return"paintShop.workCenters"!==t.id&&"paintShop.mspPaints"!==t.id&&!t.id.startsWith("paintShop.load.statuses")},updateSettingField:function(t){if(t)return"paintShop.workCenters"===t.id?this.$id("planning-workCenters").select2("data",t.getValue().map(t=>({id:t,text:t}))):t.id.startsWith("paintShop.load.statuses")?this.setUpLoadStatuses():void 0},getLoadCounter:function(){return+this.$id("load-counter").val()||0}})});