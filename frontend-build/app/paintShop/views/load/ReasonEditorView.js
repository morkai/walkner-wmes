define(["jquery","app/time","app/viewport","app/core/View","app/core/util/getShiftStartInfo","app/paintShop/PaintShopLoad","app/paintShop/PaintShopLoadCollection","app/paintShop/PaintShopLoadReasonCollection","app/paintShop/templates/load/reasonEditor"],function(e,t,i,a,n,s,o,r,d){"use strict";return a.extend({template:d,events:{"click .psLoad-reasonEditor-load":function(e){this.updating||(this.$id("loads").find(".active").removeClass("active"),e.currentTarget.classList.add("active"))},"click .btn[data-key]":function(e){var t=this;if(!t.updating){var a=t.$id("loads").find(".active");if(a.length){var n="0"===e.currentTarget.dataset.key?null:e.currentTarget.dataset.reason,s=t.loads.get(a[0].dataset.id);if(s.get("reason")!==n){t.updating=!0,t.$(".btn").prop("disabled",!0);var o=a.find(".psLoad-reasonEditor-reason");o.html('<i class="fa fa-spinner fa-spin"></i>');var r=t.ajax({method:"PATCH",url:"/paintShop/load",data:JSON.stringify({time:s.get("time"),counter:s.get("counter"),reason:n})});r.fail(function(){t.updating=!1,i.msg.show({type:"error",time:2500,text:t.t("core","MSG:SAVING_FAILURE")})}),r.done(function(){t.updating=!1,t.selectNext()}),r.always(function(){o.find(".fa-spin").removeClass("fa-spin"),t.$(".btn").prop("disabled",!1)})}else t.selectNext()}}}},remoteTopics:{"paintShop.load.updated":function(e){var t=this;e.counter===t.model.counter&&e.items.forEach(function(e){t.loads.add(s.parse(e))})},"paintShop.load.edited":function(e){var t=this.loads.get(Date.parse(e.model._id.ts)+":"+e.model._id.c);t&&t.set(t.parse(e.model))}},initialize:function(){this.loading=!0,this.updating=!1,this.reasons=new r(null,{rqlQuery:"sort(position)"}),this.loads=new o(null,{rqlQuery:this.buildLoadsRql()}),this.once("afterRender",function(){this.load(),e(window).on("resize."+this.idPrefix,this.resize.bind(this)).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("keyup."+this.idPrefix,this.onKeyUp.bind(this))}),this.listenTo(this.loads,"change:reason",this.onReasonChanged)},destroy:function(){e(window).off("."+this.idPrefix)},getTemplateData:function(){return{height:this.calcHeight(),loading:this.loading,loads:this.serializeLoads(),reasons:this.serializeReasons()}},afterRender:function(){this.$(".psLoad-reasonEditor-load").first().click()},serializeLoads:function(){var e=this,i=[];return e.loads.forEach(function(a){var n=a.get("reason");if(!n){var s=e.reasons.get(n);i.push({id:a.id,time:t.format(a.get("time"),"HH:mm:ss"),duration:t.toString(a.get("duration")/1e3,!1,!1),reason:s?s.getLabel():n})}}),i},serializeReasons:function(){return this.reasons.filter(function(e){return e.get("active")}).map(function(e){return e.toJSON()})},calcHeight:function(){var e=this.$el.closest(".modal-dialog");return window.innerHeight-2*parseInt(e.css("margin-top")||30,10)-(e.find(".modal-header").outerHeight(!0)||55)-76-45},resize:function(){this.$id("loads").css("height",this.calcHeight()+"px")},buildLoadsRql:function(){var e=Date.now(),t=1e3*this.settings.getValue(`load.delayedDuration.${this.model.counter}`,28800),i=n(e),a=i.startTime;return e<i.startTime+18e5&&(a-=288e5),"sort(_id.c,_id.ts)&_id.c="+this.model.counter+"&_id.ts=ge="+a+"&d=gt="+t},load:function(){var t=this,i=e.when(t.promised(t.reasons.fetch({reset:!0})),t.promised(t.loads.fetch({reset:!0})));i.fail(function(){t.$(".fa-spin").removeClass("fa-spin")}),i.done(function(){t.loading=!1,t.render()})},selectPrev:function(){if(!this.updating){var e=this.$id("loads"),t=e.find(".active");if(t.length){var i=t.prev();i.length||(i=e.children().last()),i.click().focus()}}},selectNext:function(){if(!this.updating){var e=this.$id("loads"),t=e.find(".active");if(t.length){var i=t.next();i.length||(i=e.children().first()),i.click().focus()}}},onKeyDown:function(e){switch(e.key.toUpperCase()){case"W":case"A":case"ARROWUP":case"ARROWLEFT":return this.selectPrev(),!1;case"S":case"D":case"ARROWDOWN":case"ARROWRIGHT":return this.selectNext(),!1;case"TAB":return e.shiftKey?this.selectPrev():this.selectNext(),!1}var t=this.$('.btn[data-key="'+e.key+'"]');t.length&&!t.prop("disabled")&&t.addClass("active")},onKeyUp:function(e){var t=this.$('.active[data-key="'+e.key+'"]');t.length&&t.removeClass("active").click()},onReasonChanged:function(e){var t=this.$('.psLoad-reasonEditor-load[data-id="'+e.id+'"]'),i=e.get("reason")||"?",a=this.reasons.get(i);t.find(".psLoad-reasonEditor-reason").text(a?a.getLabel():i)}})});