define(["underscore","app/time","app/highcharts","app/core/View","app/reports/util/formatTooltipHeader","app/reports/util/formatXAxis"],function(t,i,e,s,o,r){"use strict";return s.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.invisibleSeries=[],this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups change:load",t.debounce(this.render.bind(this),1)),this.listenTo(this.model,"legendToggled",this.onLegendToggled)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this;this.chart=new e.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:400},exporting:{filename:this.t("load:report:duration:filename",{counter:this.options.counter}),chartOptions:{title:{text:this.t("load:report:duration:title",{counter:this.t("load:counters:"+this.options.counter)})}}},title:!1,noData:{},xAxis:{type:"datetime",labels:r.labels(this)},yAxis:[{title:!1,min:0,allowDecimals:!1,labels:{format:"{value}s"}},{title:!1,min:0,allowDecimals:!1,opposite:!0}],tooltip:{shared:!0,valueDecimals:0,headerFormatter:o.bind(this),extraRowsProvider:(t,i)=>{var e=i.find(t=>"avg"===t.point.series.userOptions.id),s=i.find(t=>"count"===t.point.series.userOptions.id);return i=[],e&&i.push(e,{point:null,color:"transparent",name:this.t("load:report:duration:min"),suffix:"s",decimals:0,value:e.point.data.min},{point:null,color:"transparent",name:this.t("load:report:duration:max"),suffix:"s",decimals:0,value:e.point.data.max}),s&&i.push(s),i}},legend:{enabled:!0},series:this.serializeSeries(),plotOptions:{series:{events:{legendItemClick:function(){return t.model.trigger("legendToggled",this.userOptions.id,!this.visible),!1}}}}})},serializeSeries:function(){var t=this.serializeChartData();return[{id:"avg",name:this.t("load:report:duration:avg"),data:t.avg,type:"column",color:"#0af",yAxis:0,tooltip:{valueSuffix:"s"},turboThreshold:1501,visible:!this.invisibleSeries.includes("avg")},{id:"count",name:this.t("load:report:duration:count"),data:t.count,type:"line",color:"#000",lineWidth:t.count.length>30?1:2,yAxis:1,tooltip:{valueSuffix:this.t("reports","quantitySuffix")},marker:{radius:0,states:{hover:{radius:4}}},turboThreshold:1501,visible:!this.invisibleSeries.includes("count")}]},serializeChartData:function(){var t=this,i=t.options.counter,e={avg:[],count:[]};return"min"===t.model.get("interval")?t.model.get("load")[i].forEach(function(s){e.avg.push({x:s.key,y:s.avg,color:t.settings.getLoadStatus(i,s.avg).color,data:s}),e.count.push([s.key,s.count])}):t.model.get("groups").forEach(function(s){var o=s.counters[i];e.avg.push({x:s.key,y:o.avg,color:t.settings.getLoadStatus(i,o.avg).color,data:o}),e.count.push([s.key,o.count])}),e},updateChart:function(){this.invisibleSeries=this.chart.series.filter(t=>!t.visible).map(t=>t.userOptions.id),this.chart.destroy(),this.createChart()},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onLegendToggled:function(t,i){if(console.log(t,i),this.chart){var e=this.chart.series.find(i=>i.userOptions.id===t);e&&e.visible!==i&&(i?e.show():e.hide())}}})});