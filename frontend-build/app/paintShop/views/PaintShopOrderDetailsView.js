define(["underscore","jquery","app/i18n","app/viewport","app/user","app/core/View","app/core/util/uuid","app/core/util/getShiftStartInfo","app/paintShop/PaintShopEventCollection","app/paintShop/templates/orderDetails","app/paintShop/templates/orderChanges","app/paintShop/templates/orderChange","app/paintShop/templates/queueOrder","app/paintShop/templates/whOrders","app/paintShop/templates/workOrderEditor","app/paintShop/templates/removeWorkOrderConfirmer"],function(e,t,r,i,n,o,s,d,a,h,c,l,p,u,f,g){"use strict";var m=null,k=null;return o.extend({template:h,dialogClassName:"paintShop-orderDetails-dialog",events:{"keydown .form-control":function(e){if("Enter"===e.key)return this.$(e.currentTarget).next().click(),!1},"focus [data-vkb]":function(e){this.hideWorkOrderEditor(),this.vkb&&(clearTimeout(this.timers.hideVkb),this.vkb.show(e.currentTarget)&&(this.vkb.$el.css({top:"auto",bottom:"30px"}),this.resizeChanges()))},"blur [data-vkb]":"scheduleHideVkb","click .btn[data-action]":function(e){this.handleAction(e.currentTarget.dataset)},'click a[data-action="openDocument"]':function(e){var t=e.currentTarget;return"1"!==t.dataset.checking&&(t.textContent.trim()===m&&k&&!k.closed?(k.focus(),!1):"1"!==t.dataset.checked?(this.tryOpenDocument(t),!1):(this.openDocumentWindow(t),!1))},"click .paintShop-order-childOrder":function(e){this.$(e.target).closest('td[data-property="actions"]').length?this.hideWorkOrderEditor():this.canAct()&&this.showWorkOrderEditor(+e.currentTarget.dataset.childOrderIndex)},'click a[data-action="removeWorkOrder"]':function(e){return this.hideWorkOrderEditor(),this.showRemoveWorkOrderConfirmer(this.$(e.currentTarget).closest("tr")[0].dataset.workOrderId),!1}},initialize:function(){this.vkb=this.options.vkb,this.psEvents=a.forOrder(this.model.id),this.listenTo(this.psEvents,"add",this.onEventAdded),this.listenTo(this.orders,"change",this.onChange),this.orders.whOrders&&(this.listenTo(this.orders.whOrders,"reset",this.onWhOrdersReset),this.listenTo(this.orders.whOrders,"change",this.onWhOrdersChange)),this.vkb&&this.listenTo(this.vkb,"keyFocused",this.onVkbFocused),t(window).on("resize."+this.idPrefix,this.onWindowResize.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),this.vkb&&this.vkb.hide(),this.$changes&&(this.$changes.remove(),this.$changes=null),this.hideWorkOrderEditor()},closeDialog:function(){},getTemplateData:function(){var e=this.model.serialize();return{order:e,fillerHeight:this.calcFillerHeight(),renderQueueOrder:p,renderWhOrders:u,canAct:this.canAct(),mrpDropped:this.dropZones.getState(e.mrp),getChildOrderDropZoneClass:this.orders.getChildOrderDropZoneClass.bind(this.orders)}},canAct:function(){var e=this.options.embedded,t=n.isAllowedTo("LOCAL"),r=!!this.orders.user,i=n.isAllowedTo("PAINT_SHOP:PAINTER"),o=n.isAllowedTo("PAINT_SHOP:MANAGE");return e&&t&&r||i||o},beforeRender:function(){this.$changes&&(this.$changes.remove(),this.$changes=null)},afterRender:function(){0===this.options.height&&(this.options.height=this.$("tbody")[0].clientHeight,this.resizeFiller()),this.renderChanges(),this.reloadChanges(),this.toggleActions()},renderChanges:function(){var e=this,t=this.renderPartial(c,{canAct:e.canAct()});t.find(".paintShop-orderChanges-comment").on("focus",function(){e.options.vkb&&(clearTimeout(e.timers.hideVkb),e.hideWorkOrderEditor(),e.options.vkb.show(this),e.resizeChanges())}).on("blur",function(){e.options.vkb&&e.scheduleHideVkb()}),t.find(".btn-primary").on("click",function(){e.handleAction({action:"comment"})}),t.appendTo(e.$el.parent()),e.$changes=t,e.resizeChanges()},reloadChanges:function(){var e=this;e.promised(e.psEvents.fetch({reset:!0})).done(function(){if(e.$changes&&e.$changes.length){var t=e.psEvents.map(function(t){return e.renderPartialHtml(l,{change:t.serialize()})}).join("");e.$changes.find(".paintShop-orderChanges-changes").html(t).prop("scrollTop",99999)}})},onEventAdded:function(e){this.$changes&&this.$changes.length&&this.$changes.find(".paintShop-orderChanges-changes").append(this.renderPartialHtml(l,{change:e.serialize()})).prop("scrollTop",99999)},toggleActions:function(){var t=e.some(this.model.serialize().childOrders,function(e){return e.drilling&&"finished"!==e.drilling});this.$('.btn[data-action="start"]').prop("disabled",t)},scheduleHideVkb:function(){clearTimeout(this.timers.hideVkb),this.timers.hideVkb=setTimeout(this.hideVkb.bind(this),250)},hideVkb:function(){clearTimeout(this.timers.hideVkb),this.vkb&&(this.vkb.hide(),this.resizeChanges())},resizeChanges:function(){this.$changes.css("height",this.calcChangesHeight()+"px").find(".paintShop-orderChanges-changes").prop("scrollTop",99999),this.positionWorkOrderEditor()},resizeFiller:function(){this.$id("filler").css("height",this.calcFillerHeight()+"px")},calcFillerHeight:function(){var e=window.innerHeight-60-25-75-this.options.height-24-25*this.model.serialize().whOrders.length-19*this.model.get("workOrders").length;return Math.max(e,0)},calcChangesHeight:function(){var e=this.vkb?this.vkb.$el.outerHeight():0;return e||(e=-30),Math.max(window.innerHeight-2-60-30-e,0)},handleAction:function(e){var t=this,r=e.action,n=t.$changes.find(".paintShop-orderChanges-comment"),o=n.val().trim(),s={qtyDone:parseInt(t.$id("qtyDone").val(),10),qtyDlv:parseInt(t.$id("qtyDlv").val(),10),cabin:parseInt(e.cabin,10)||void 0};if("start"===r&&0===t.model.get("qtyDone")&&t.orders.settings.isMspOrder(t.model)&&(r="startMsp"),"comment"!==r||o){var d=t.$(".btn").prop("disabled",!0);t.act(r,o,s).fail(function(){d.prop("disabled",!1)}).done(function(){"comment"===r?(n.val(""),d.prop("disabled",!1)):t.closeDialog()})}else i.closeDialog()},act:function(t,n,o){var s=e.assign({action:t,orderId:this.model.id,comment:n},o);return this.orders.act(s,function(e){if(e)return i.msg.show({type:"error",time:3e3,text:r("paintShop","MSG:"+t+":failure")})})},onChange:function(e){if(e===this.model){var t=this.renderPartialHtml(p,{order:e.serialize(),visible:!0,first:!1,last:!1,commentVisible:!1,canAct:this.canAct(),rowSpan:"rowSpanDetails",mrpDropped:this.dropZones.getState(e.get("mrp")),getChildOrderDropZoneClass:this.orders.getChildOrderDropZoneClass.bind(this.orders),details:!0});this.$(".paintShop-order").replaceWith(t),this.toggleActions(),i.adjustDialogBackdrop()}},onVkbFocused:function(){clearTimeout(this.timers.hideVkb)},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e)},onWindowResize:function(){this.resizeFiller(),this.resizeChanges()},onWhOrdersReset:function(){this.renderWhOrders(),this.resizeFiller()},onWhOrdersChange:function(e){e.get("order")===this.model.get("order")&&this.renderWhOrders()},renderWhOrders:function(){var e=this.renderPartialHtml(u,{order:this.model.serialize()});this.$id("whOrders").html(e)},tryOpenDocument:function(e){var t=this;i.msg.loading(),e.dataset.checking="1",t.ajax({method:"HEAD",url:e.href}).done(function(){t.openDocumentWindow(e)}).always(function(){e.parentElement.textContent=e.textContent,e.dataset.checking="0",e.dataset.checked="1",i.msg.loaded()})},openDocumentWindow:function(e){var t=this,r=!1,i=e.textContent.trim(),n=window.screen,o=n.availHeight;n.availWidth===window.innerWidth&&n.availHeight!==window.innerHeight&&(o*=.9);var s=.8*n.availWidth,d=.9*o,a=Math.floor((n.availWidth-s)/2),h="resizable,scrollbars,location=no,top="+Math.floor((o-d)/2)+",left="+a+",width="+Math.floor(s)+",height="+Math.floor(d),c="WMES_ORDER_DOCUMENT_PREVIEW",l=window.open(e.href,c,h);l&&(m=i,k=l,clearInterval(t.timers[c]),t.timers[c]=setInterval(function(){l.closed?(m=null,k=null,clearInterval(t.timers[c])):!r&&l.ready&&(r=!0,l.focus())},250))},showWorkOrderEditor:function(e){var t=this.model.get("childOrders")[e];if(t){this.hideVkb();var r=this.$id("workOrderEditor");if(!r.length){var i=[null,{no:1,value:0,current:!1},{no:2,value:0,current:!1},{no:3,value:0,current:!1}],n=d(Date.now()),o=d(n.startTime-144e5);i[n.no].current=!0,i[n.no].value=n.moment.utc(!0).valueOf(),i[o.no].value=o.moment.utc(!0).valueOf(),(r=this.renderPartial(f,{shifts:i,currentShift:n.no})).on("submit",this.submitWorkOrderEditor.bind(this)),r.find("#"+this.idPrefix+"-woe-cancel").on("click",this.hideWorkOrderEditor.bind(this)),this.vkb&&r.find("input[data-vkb]").on("blur",this.scheduleHideVkb.bind(this)).on("focus",this.showWorkOrderEditorVkb.bind(this)),r.appendTo(document.body)}r.data("childOrderI",e),r.css({top:"0",left:"-1000px"});var s=r.find('input[name="qtyDone"]').val(this.calcWorkOrderQuantity(t));r.removeClass("hidden"),this.positionWorkOrderEditor(),s.focus()}},calcWorkOrderQuantity:function(e){for(var t=[],r=0;r<e.paintCount;++r)t.push(e.qty);return this.model.get("workOrders").forEach(function(r){if(r.childOrder===e.order)for(var i=r.qtyDone;t.length;){if(t[0]-=i,0===t[0]){t.shift();break}if(!(t[0]<0))break;i=-1*t[0],t.shift()}}),t.length?t[0]:0},positionWorkOrderEditor:function(){var e=this.$id("workOrderEditor"),t=e.data("childOrderI"),r=this.$('.paintShop-order-childOrder[data-child-order-index="'+t+'"]').first();if(r.length){var i=r.find('.paintShop-property[data-property="order"]')[0].getBoundingClientRect(),n=i.top+24,o=e.outerHeight()+15;n+o>window.innerHeight&&(n-=n+o-window.innerHeight),e.css({top:n+"px",left:i.left+5+"px"})}},hideWorkOrderEditor:function(){this.$id("workOrderEditor").remove(),this.$id("removeWorkOrderConfirmer").remove()},showWorkOrderEditorVkb:function(e){clearTimeout(this.timers.hideVkb),this.vkb.show(e.currentTarget);var t=this.$id("workOrderEditor")[0].getBoundingClientRect(),r=e.currentTarget.getBoundingClientRect().top,i=this.vkb.$el.outerHeight()+15;r+i>window.innerHeight&&(r-=r+i-window.innerHeight),this.vkb.$el.css({top:r+"px",left:t.left+t.width+15+"px"})},submitWorkOrderEditor:function(e){e.preventDefault();var t=this,r=t.$id("workOrderEditor"),i=t.model.get("childOrders")[r.data("childOrderI")];if(t.hideVkb(),!i)return t.hideWorkOrderEditor();var o=n.getInfo(),d={_id:s(),createdAt:new Date,creator:o,childOrder:i.order,qtyDone:parseInt(r.find('input[name="qtyDone"]').val(),10)||0,shift:new Date(+r.find('input[name="shift"]:checked').val()),workers:[t.orders.user||o]};if(d.qtyDone<=0)return t.hideWorkOrderEditor();var a=t.$(".form-actions .btn").prop("disabled",!0);t.act("addWorkOrder","",{workOrder:d}).fail(function(){a.prop("disabled",!1)}).done(function(){t.hideWorkOrderEditor()})},showRemoveWorkOrderConfirmer:function(e){var t=this.renderPartial(g);t.find(".btn-danger").on("click",this.removeWorkOrder.bind(this,e)),t.find(".btn-default").on("click",this.hideWorkOrderEditor.bind(this));var r=this.$('.is-workOrder[data-work-order-id="'+e+'"]').find('a[data-action="removeWorkOrder"]')[0].getBoundingClientRect();t.css({top:r.top+"px",left:r.left+"px"}),t.appendTo(document.body)},removeWorkOrder:function(e){var t=this,r=t.model.get("workOrders").find(function(t){return t._id===e});if(!r)return t.hideWorkOrderEditor();var i=t.$id("removeWorkOrderConfirmer").find(".btn").prop("disabled",!0);t.act("removeWorkOrder","",{workOrder:r}).fail(function(){i.prop("disabled",!1)}).done(function(){t.hideWorkOrderEditor()})}})});