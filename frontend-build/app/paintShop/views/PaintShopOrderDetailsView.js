// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/user","app/core/View","app/paintShop/PaintShopEventCollection","app/paintShop/templates/orderDetails","app/paintShop/templates/orderChanges","app/paintShop/templates/orderChange","app/paintShop/templates/queueOrder"],function(e,i,t,n,o,s,h,r,a,c){"use strict";return o.extend({template:h,dialogClassName:"paintShop-orderDetails-dialog",events:{"click .btn[data-action]":function(e){var i=this,t=i.$changes.find(".paintShop-orderChanges-comment"),n=t.val().trim(),o=e.currentTarget.dataset.action;if("comment"===o&&0===n.length)return void t.focus();var s=i.$(".btn").prop("disabled",!0);i.act(o,n).fail(function(){s.prop("disabled",!1)}).done(function(){i.closeDialog()})}},initialize:function(){this.psEvents=s.forOrder(this.model.id),this.listenTo(this.model,"change",this.reloadChanges.bind(this)),e(window).on("resize."+this.idPrefix,this.onWindowResize.bind(this))},destroy:function(){e(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide(),this.$changes&&(this.$changes.remove(),this.$changes=null)},closeDialog:function(){},serialize:function(){var e=window.parent!==window,i=n.isAllowedTo("LOCAL"),t=n.isAllowedTo("PAINT_SHOP:PAINTER"),o=n.isAllowedTo("PAINT_SHOP:MANAGE");return{idPrefix:this.idPrefix,order:this.model.serialize(),fillerHeight:this.calcFillerHeight(),renderQueueOrder:c,canAct:e&&i||t||o}},beforeRender:function(){this.$changes&&(this.$changes.remove(),this.$changes=null)},afterRender:function(){0===this.options.height&&(this.options.height=this.$("tbody")[0].clientHeight,this.$id("filler").css("height",this.calcFillerHeight()+"px")),this.renderChanges(),this.reloadChanges()},renderChanges:function(){var i=this,t=e(r());t.find(".paintShop-orderChanges-comment").on("focus",function(){i.options.vkb&&(clearTimeout(i.timers.hideVkb),i.options.vkb.show(this),i.resizeChanges())}).on("blur",function(){i.options.vkb&&i.scheduleHideVkb()}),t.appendTo(this.$el.parent()),this.$changes=t,this.resizeChanges()},reloadChanges:function(){var e=this;e.promised(e.psEvents.fetch({reset:!0})).done(function(){var i=e.psEvents.map(function(e){return a({change:e.serialize()})});e.$changes.find(".paintShop-orderChanges-changes").html(i).prop("scrollTop",99999)})},scheduleHideVkb:function(){var e=this;clearTimeout(e.timers.hideVkb),e.timers.hideVkb=setTimeout(function(){e.options.vkb.hide(),e.resizeChanges()},500)},resizeChanges:function(){this.$changes.css("height",this.calcChangesHeight()+"px").find(".paintShop-orderChanges-changes").prop("scrollTop",99999)},calcFillerHeight:function(){return Math.max(window.innerHeight-60-25-75-this.options.height,0)},calcChangesHeight:function(){var e=this.options.vkb?this.options.vkb.$el.outerHeight():0;return e||(e=-30),Math.max(window.innerHeight-2-60-30-e,0)},act:function(e,n){var o={action:e,orderId:this.model.id,comment:n};return this.model.collection.act(o,function(n){if(n)return t.msg.show({type:"error",time:3e3,text:i("paintShop","MSG:"+e+":failure")})})},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e)},onWindowResize:function(){this.$id("filler").css("height",this.calcFillerHeight()+"px"),this.resizeChanges()}})});