define(["underscore","jquery","app/i18n","app/viewport","app/user","app/core/View","app/paintShop/PaintShopEventCollection","app/paintShop/templates/orderDetails","app/paintShop/templates/orderChanges","app/paintShop/templates/orderChange","app/paintShop/templates/queueOrder","app/paintShop/templates/whOrders"],function(e,t,i,n,s,r,o,h,a,d,l,c){"use strict";var p=null,u=null;return r.extend({template:h,dialogClassName:"paintShop-orderDetails-dialog",events:{"keydown .form-control":function(e){if("Enter"===e.key)return this.$(e.currentTarget).next().click(),!1},"focus [data-vkb]":function(e){this.vkb&&(clearTimeout(this.timers.hideVkb),this.vkb.show(e.currentTarget)&&(this.vkb.$el.css({top:"auto",bottom:"30px"}),this.resizeChanges()))},"blur [data-vkb]":"scheduleHideVkb","click .btn[data-action]":function(e){this.handleAction(e.currentTarget.dataset)},'click a[data-action="openDocument"]':function(e){var t=e.currentTarget;return"1"!==t.dataset.checking&&(t.textContent.trim()===p&&u&&!u.closed?(u.focus(),!1):"1"!==t.dataset.checked?(this.tryOpenDocument(t),!1):(this.openDocumentWindow(t),!1))}},initialize:function(){this.vkb=this.options.vkb,this.psEvents=o.forOrder(this.model.id),this.listenTo(this.orders,"change",this.onChange),this.orders.whOrders&&(this.listenTo(this.orders.whOrders,"reset",this.onWhOrdersReset),this.listenTo(this.orders.whOrders,"change",this.onWhOrdersChange)),this.vkb&&this.listenTo(this.vkb,"keyFocused",this.onVkbFocused),t(window).on("resize."+this.idPrefix,this.onWindowResize.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),this.vkb&&this.vkb.hide(),this.$changes&&(this.$changes.remove(),this.$changes=null)},closeDialog:function(){},getTemplateData:function(){var e=this.model.serialize();return{order:e,fillerHeight:this.calcFillerHeight(),renderQueueOrder:l,renderWhOrders:c,canAct:this.canAct(),mrpDropped:this.dropZones.getState(e.mrp),getChildOrderDropZoneClass:this.orders.getChildOrderDropZoneClass.bind(this.orders)}},canAct:function(){var e=this.options.embedded,t=s.isAllowedTo("LOCAL"),i=!!this.orders.user,n=s.isAllowedTo("PAINT_SHOP:PAINTER"),r=s.isAllowedTo("PAINT_SHOP:MANAGE");return e&&t&&i||n||r},beforeRender:function(){this.$changes&&(this.$changes.remove(),this.$changes=null)},afterRender:function(){0===this.options.height&&(this.options.height=this.$("tbody")[0].clientHeight,this.resizeFiller()),this.renderChanges(),this.reloadChanges(),this.toggleActions()},renderChanges:function(){var e=this,i=t(a({canAct:e.canAct()}));i.find(".paintShop-orderChanges-comment").on("focus",function(){e.options.vkb&&(clearTimeout(e.timers.hideVkb),e.options.vkb.show(this),e.resizeChanges())}).on("blur",function(){e.options.vkb&&e.scheduleHideVkb()}),i.find(".btn-primary").on("click",function(){e.handleAction({action:"comment"})}),i.appendTo(e.$el.parent()),e.$changes=i,e.resizeChanges()},reloadChanges:function(){var e=this;e.promised(e.psEvents.fetch({reset:!0})).done(function(){if(e.$changes&&e.$changes.length){var t=e.psEvents.map(function(e){return d({change:e.serialize()})});e.$changes.find(".paintShop-orderChanges-changes").html(t).prop("scrollTop",99999)}})},toggleActions:function(){var t=e.some(this.model.serialize().childOrders,function(e){return e.drilling&&"finished"!==e.drilling});this.$('.btn[data-action="start"]').prop("disabled",t)},scheduleHideVkb:function(){clearTimeout(this.timers.hideVkb),this.timers.hideVkb=setTimeout(this.hideVkb.bind(this),250)},hideVkb:function(){clearTimeout(this.timers.hideVkb),this.vkb&&(this.vkb.hide(),this.resizeChanges())},resizeChanges:function(){this.$changes.css("height",this.calcChangesHeight()+"px").find(".paintShop-orderChanges-changes").prop("scrollTop",99999)},resizeFiller:function(){this.$id("filler").css("height",this.calcFillerHeight()+"px")},calcFillerHeight:function(){var e=window.innerHeight-60-25-75-this.options.height-24-25*this.model.serialize().whOrders.length;return Math.max(e,0)},calcChangesHeight:function(){var e=this.vkb?this.vkb.$el.outerHeight():0;return e||(e=-30),Math.max(window.innerHeight-2-60-30-e,0)},handleAction:function(e){var t=this,i=e.action,s=t.$changes.find(".paintShop-orderChanges-comment"),r=s.val().trim(),o={qtyDone:parseInt(t.$id("qtyDone").val(),10),qtyDlv:parseInt(t.$id("qtyDlv").val(),10),cabin:parseInt(e.cabin,10)||void 0};if("comment"!==i||r){var h=t.$(".btn").prop("disabled",!0);t.act(i,r,o).fail(function(){h.prop("disabled",!1)}).done(function(){"comment"===i?(s.val(""),h.prop("disabled",!1)):t.closeDialog()})}else n.closeDialog()},act:function(t,s,r){var o=e.assign({action:t,orderId:this.model.id,comment:s},r);return this.orders.act(o,function(e){if(e)return n.msg.show({type:"error",time:3e3,text:i("paintShop","MSG:"+t+":failure")})})},onChange:function(e,t){if(e===this.model){var i=this.renderPartialHtml(l,{order:e.serialize(),visible:!0,first:!1,last:!1,commentVisible:!1,rowSpan:"rowSpanDetails",mrpDropped:this.dropZones.getState(e.get("mrp")),getChildOrderDropZoneClass:this.orders.getChildOrderDropZoneClass.bind(this.orders),details:!0});this.$(".paintShop-order").replaceWith(i),t.drilling||t.wh||this.reloadChanges(),this.toggleActions()}},onVkbFocused:function(){clearTimeout(this.timers.hideVkb)},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e)},onWindowResize:function(){this.resizeFiller(),this.resizeChanges()},onWhOrdersReset:function(){this.renderWhOrders(),this.resizeFiller()},onWhOrdersChange:function(e){e.get("order")===this.model.get("order")&&this.renderWhOrders()},renderWhOrders:function(){var e=this.renderPartialHtml(c,{order:this.model.serialize()});this.$id("whOrders").html(e)},tryOpenDocument:function(e){var t=this;n.msg.loading(),e.dataset.checking="1",t.ajax({method:"HEAD",url:e.href}).done(function(){t.openDocumentWindow(e)}).always(function(){e.parentElement.textContent=e.textContent,e.dataset.checking="0",e.dataset.checked="1",n.msg.loaded()})},openDocumentWindow:function(e){var t=this,i=!1,n=e.textContent.trim(),s=window.screen,r=s.availHeight;s.availWidth===window.innerWidth&&s.availHeight!==window.innerHeight&&(r*=.9);var o=.8*s.availWidth,h=.9*r,a=Math.floor((s.availWidth-o)/2),d="resizable,scrollbars,location=no,top="+Math.floor((r-h)/2)+",left="+a+",width="+Math.floor(o)+",height="+Math.floor(h),l="WMES_ORDER_DOCUMENT_PREVIEW",c=window.open(e.href,l,d);c&&(p=n,u=c,clearInterval(t.timers[l]),t.timers[l]=setInterval(function(){c.closed?(p=null,u=null,clearInterval(t.timers[l])):!i&&c.ready&&(i=!0,c.focus())},250))}})});