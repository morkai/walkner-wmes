// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/paintShop/templates/list"],function(t,e,i,s,o,n,r){"use strict";return n.extend({template:r,events:{"mousedown .paintShop-list-item":function(t){this.lastClickEvent=t},"mouseup .paintShop-list-item":function(t){var e=this.lastClickEvent;e&&0===t.button&&((window.parent===window||e.offsetY===t.offsetY&&e.offsetX===t.offsetX&&e.screenX===t.screenX&&e.screenY===t.screenY)&&this.handleItemClick(t.currentTarget.dataset.orderId),this.lastClickEvent=null)},scroll:"onScroll","focus #-search":function(t){this.options.vkb&&(clearTimeout(this.timers.hideVkb),this.options.vkb.show(t.target,this.onVkbValueChange),this.options.vkb.$el.css({left:"195px",bottom:"67px",marginLeft:"0"}))},"blur #-search":function(){this.options.vkb&&this.scheduleHideVkb()},"input #-search":"onVkbValueChange"},initialize:function(){this.lastClickEvent=null,this.lastVisibleItem=null,this.onScroll=t.debounce(this.onScroll.bind(this),100,!1),this.onVkbValueChange=this.onVkbValueChange.bind(this),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"change",this.onChange),this.listenTo(this.model,"mrpSelected",this.onMrpSelected)},destroy:function(){this.options.vkb&&this.options.vkb.hide()},serialize:function(){return{idPrefix:this.idPrefix,showTimes:this.options.showTimes,showSearch:this.options.showSearch,selectedMrp:this.model.selectedMrp,orders:this.serializeOrders()}},serializeOrders:function(){var t=this.options.filter,e=this.options.sort,i=this.model.serialize();return t&&(i=i.filter(t)),e&&(i=i.sort(e)),i},afterRender:function(){var t=this.$item(this.lastVisibleItem);t.length&&(this.el.scrollTop=t[0].offsetTop)},$item:function(t){return this.$('.paintShop-list-item[data-order-id="'+t+'"]')},handleItemClick:function(t){t&&this.model.trigger("focus",t)},scheduleHideVkb:function(){var t=this;clearTimeout(t.timers.hideVkb),t.options.vkb.isVisible()&&(t.timers.hideVkb=setTimeout(function(){t.options.vkb.hide(),t.options.vkb.$el.css({left:"",bottom:"",marginLeft:""}),t.$id("search").val("").addClass("is-empty").css("background","")},250))},searchOrder:function(t){function e(){o.msg.show({type:"warning",time:2500,text:i("paintShop","MSG:search:failure")}),r.css("background","#f2dede"),setTimeout(function(){r.prop("disabled",!1).val("").addClass("is-empty").css("background","").focus()},1337)}var n=this;n.options.vkb&&n.options.vkb.hide();var r=n.$id("search").blur(),l=n.model.getFirstByOrderNo(t);if(l)return r.val("").addClass("is-empty").css("background",""),l.get("mrp")!==n.model.selectedMrp&&n.model.selectMrp(l.get("mrp")),void n.model.trigger("focus",l.id,{showDetails:!0});r.prop("disabled",!0),o.msg.loading();var a=this.ajax({url:"/paintShop/orders?order="+t+"&select(date,mrp)&limit(1)"});a.fail(e),a.done(function(t){if(0===t.totalCount)return e();var i=t.collection[0];n.model.setDateFilter(s.utc.format(i.date,"YYYY-MM-DD"));var o=n.model.fetch({reset:!0});o.fail(e),o.done(function(){n.model.selectedMrp!==i.mrp&&(n.model.selectMrp(i.mrp),n.model.trigger("focus",i._id,{showDetails:!0}))})}),a.always(function(){o.msg.loaded()})},onVkbValueChange:function(){var t=this.$id("search"),e=t.val();t.toggleClass("is-empty",""===e).css("background",/[^0-9]+/.test(e)?"#f2dede":""),/^[0-9]{9}$/.test(e)&&this.searchOrder(e)},onScroll:function(){var t=this.$(".visible");if(t.length){this.lastVisibleItem=t[0].dataset.orderId;for(var e=this.el.scrollTop,i=0;i<t.length;++i){var s=t[i];if(s.offsetTop>e)break;this.lastVisibleItem=s.dataset.orderId,e>s.offsetTop+25&&t[i+1]&&(this.lastVisibleItem=t[i+1].dataset.orderId)}}},onChange:function(t){var e=this.options.filter,i=this.options.sort,s=this.$item(t.id);return e||i?s.length&&!e(t.serialize())?void s.remove():void this.render():void s.attr("data-status",t.get("status"))},onMrpSelected:function(){var t=this.model.selectedMrp,e="all"!==t;this.$(".paintShop-list-item").each(function(){var i=e&&this.dataset.mrp!==t;this.nextElementSibling&&(this.classList.toggle("hidden",i),this.classList.toggle("visible",!i))})}})});