// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/paintShop/templates/list"],function(t,i,e,s,o,n,l){"use strict";return n.extend({template:l,events:{"mousedown .paintShop-list-item":function(t){this.lastClickEvent=t},"mouseup .paintShop-list-item":function(t){var i=this.lastClickEvent;i&&0===t.button&&((window.parent===window||i.offsetY===t.offsetY&&i.offsetX===t.offsetX&&i.screenX===t.screenX&&i.screenY===t.screenY)&&this.handleItemClick(t.currentTarget.dataset.orderId),this.lastClickEvent=null)}},initialize:function(){this.onScroll=t.debounce(this.onScroll.bind(this),100,!1),this.lastClickEvent=null,this.lastVisibleItem=null,this.listenTo(this.model,"reset",t.after(2,this.render)),this.listenTo(this.model,"change",this.onChange),this.listenTo(this.model,"mrpSelected paintSelected",this.toggleVisibility)},serialize:function(){return{idPrefix:this.idPrefix,showTimes:this.options.showTimes,isVisible:this.model.isVisible.bind(this.model),orders:this.serializeOrders()}},serializeOrders:function(){var t=this.options.filter,i=this.options.sort,e=this.model.serialize();return t&&(e=e.filter(t)),i&&(e=e.sort(i)),e},afterRender:function(){var t=this.$item(this.lastVisibleItem);t.length&&(this.el.parentNode.scrollTop=t[0].offsetTop)},$item:function(t){return this.$('.paintShop-list-item[data-order-id="'+t+'"]')},handleItemClick:function(t){t&&this.model.trigger("focus",t)},onScroll:function(){var t=this.$(".visible");if(t.length){this.lastVisibleItem=t[0].dataset.orderId;for(var i=this.el.parentNode.scrollTop,e=0;e<t.length;++e){var s=t[e];if(s.offsetTop>i)break;this.lastVisibleItem=s.dataset.orderId,i>s.offsetTop+25&&t[e+1]&&(this.lastVisibleItem=t[e+1].dataset.orderId)}}},onChange:function(t){var i=this.options.filter,e=this.options.sort,s=this.$item(t.id);return i||e?s.length&&!i(t.serialize())?void s.remove():void this.render():void s.attr("data-status",t.get("status"))},toggleVisibility:function(){var t=this.model;this.$(".paintShop-list-item").each(function(){if(this.nextElementSibling){var i=t.get(this.dataset.orderId).serialize(),e=!t.isVisible(i);this.classList.toggle("hidden",e),this.classList.toggle("visible",!e)}})}})});