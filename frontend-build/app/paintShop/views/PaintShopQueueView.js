// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/planning/util/contextMenu","./PaintShopOrderDetailsView","app/paintShop/templates/queue","app/paintShop/templates/queueOrder"],function(e,t,i,r,s,o,n,a,d,l){"use strict";return o.extend({template:d,events:{"mousedown .paintShop-order":function(e){this.lastClickEvent=e},"mouseup .paintShop-order":function(e){var t=this.lastClickEvent;this.lastClickEvent=null,t&&0===e.button&&""===window.getSelection().toString()&&(window.parent===window||t.offsetY===e.offsetY&&t.offsetX===e.offsetX&&t.screenX===e.screenX&&t.screenY===e.screenY)&&this.handleOrderClick(e.currentTarget.dataset.orderId,this.$(e.target).closest("td")[0].dataset.property)},"contextmenu .visible":function(e){return this.showMenu(e),!1}},initialize:function(){this.onScroll=e.debounce(this.onScroll.bind(this),100,!1),this.lastClickEvent=null,this.lastFocusedOrder=null,this.listenTo(this.orders,"reset",e.after(2,this.render)),this.listenTo(this.orders,"change",this.onChange),this.listenTo(this.orders,"focus",this.onFocus),this.listenTo(this.orders,"mrpSelected paintSelected",this.toggleVisibility)},serialize:function(){var e=null,t=null,i=this.orders,r=i.serialize().map(function(r){return r={order:r,visible:i.isVisible(r),first:!1,last:!1,commentVisible:!0,rowSpan:"rowSpan"},r.visible&&(e||(e=r),t=r),r});return e&&(e.first=!0),t&&(t.last=!0),{idPrefix:this.idPrefix,orders:r,renderQueueOrder:l}},afterRender:function(){var e=this.$order(this.lastFocusedOrder);e.length&&(this.el.parentNode.scrollTop=e[0].offsetTop+1)},$order:function(e){return this.$('.paintShop-order[data-order-id="'+e+'"]')},handleOrderClick:function(e,t){if(!s.currentDialog){var i=this.orders.get(e);if(i){var r=i.get("followups");if(r.length&&("no"===t||"order"===t))return void this.onFocus(r[0]);var o=this.$order(e)[0];o&&(this.$el.parent().animate({scrollTop:o.offsetTop+1},200),this.lastFocusedOrder=e);var n=new a({model:i,height:o?o.clientHeight:0,vkb:this.options.vkb});s.showDialog(n)}}},showMenu:function(e){var t=this.orders.get(e.currentTarget.dataset.orderId),s=t.get("order"),o=t.get("mrp"),a=[t.get("order"),{icon:"fa-print",label:i("paintShop","menu:printOrder"),handler:this.trigger.bind(this,"actionRequested","printOrders","order",s)},"-",i("paintShop","menu:header:mrp",{mrp:o}),{icon:"fa-clipboard",label:i("paintShop","menu:copyOrders"),handler:this.trigger.bind(this,"actionRequested","copyOrders",e,o)},{icon:"fa-clipboard",label:i("paintShop","menu:copyChildOrders"),handler:this.trigger.bind(this,"actionRequested","copyChildOrders",e,o)},{icon:"fa-print",label:i("paintShop","menu:printOrders"),handler:this.trigger.bind(this,"actionRequested","printOrders","mrp",o)},{icon:"fa-download",label:i("paintShop","menu:exportOrders"),handler:this.trigger.bind(this,"actionRequested","exportOrders",o)}];r.isAllowedTo("PAINT_SHOP:DROP_ZONES")&&a.push({icon:"fa-level-down",label:i("paintShop","menu:dropZone:"+this.dropZones.getState(o)),handler:this.trigger.bind(this,"actionRequested","dropZone",o)}),a.push("-",i("paintShop","menu:header:all"),{icon:"fa-clipboard",label:i("paintShop","menu:copyOrders"),handler:this.trigger.bind(this,"actionRequested","copyOrders",e)},{icon:"fa-clipboard",label:i("paintShop","menu:copyChildOrders"),handler:this.trigger.bind(this,"actionRequested","copyChildOrders",e)},{icon:"fa-print",label:i("paintShop","menu:printOrders"),handler:this.trigger.bind(this,"actionRequested","printOrders",null,null)},{icon:"fa-download",label:i("paintShop","menu:exportOrders"),handler:this.trigger.bind(this,"actionRequested","exportOrders",null)}),r.isAllowedTo("PAINT_SHOP:DROP_ZONES")&&"all"!==this.orders.selectedPaint&&a.push({icon:"fa-level-down",label:i("paintShop","menu:dropZone:"+this.dropZones.getState(this.orders.selectedPaint)),handler:this.trigger.bind(this,"actionRequested","dropZone",this.orders.selectedPaint,!0)}),n.show(this,e.pageY,e.pageX,a)},hideMenu:function(){n.hide(this)},onScroll:function(){var e=this.$(".visible");if(e.length){this.lastFocusedOrder=e[0].dataset.orderId;for(var t=this.el.parentNode.scrollTop,i=0;i<e.length;++i){var r=e[i];if(r.offsetTop>t)break;this.lastFocusedOrder=r.dataset.orderId,t>r.offsetTop+26&&e[i+1]&&(this.lastFocusedOrder=e[i+1].dataset.orderId)}}},onChange:function(e){var t=this.$order(e.id),i=e.serialize();t.replaceWith(l({order:i,visible:this.orders.isVisible(i),first:t.hasClass("is-first"),last:t.hasClass("is-last"),commentVisible:!0,rowSpan:"rowSpan"}))},onFocus:function(e,t){var i=this.$order(e)[0];i?(this.$el.parent().animate({scrollTop:i.offsetTop+1},200),this.lastFocusedOrder=e,t&&t.showDetails&&this.handleOrderClick(e)):this.handleOrderClick(e)},toggleVisibility:function(){var e=this.orders;this.$(".paintShop-order").each(function(){var t=e.get(this.dataset.orderId).serialize(),i=!e.isVisible(t);this.classList.toggle("hidden",i),this.classList.toggle("visible",!i)}),this.$(".paintShop-order.is-first, .paintShop-order.is-last").removeClass("is-first is-last");var t=this.$(".visible");t.first().addClass("is-first"),t.last().addClass("is-last"),this.el.scrollTop=0}})});