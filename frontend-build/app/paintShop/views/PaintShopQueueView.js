// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/core/View","./PaintShopOrderDetailsView","app/paintShop/templates/queue","app/paintShop/templates/queueOrder"],function(e,t,i,r,s,o,n){"use strict";return r.extend({template:o,events:{"mousedown .paintShop-order":function(e){this.lastClickEvent=e},"mouseup .paintShop-order":function(e){var t=this.lastClickEvent;this.lastClickEvent=null,t&&0===e.button&&(window.parent===window||t.offsetY===e.offsetY&&t.offsetX===e.offsetX&&t.screenX===e.screenX&&t.screenY===e.screenY)&&this.handleOrderClick(e.currentTarget.dataset.orderId,this.$(e.target).closest("td")[0].dataset.property)}},initialize:function(){this.lastClickEvent=null,this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"change",this.onChange),this.listenTo(this.model,"focus",this.onFocus),this.listenTo(this.model,"mrpSelected",this.onMrpSelected)},serialize:function(){return{idPrefix:this.idPrefix,groups:this.model.serializeGroups(),selectedMrp:this.model.selectedMrp,renderQueueOrder:n}},afterRender:function(){var e=this.$(".paintShop-groups");e.length&&(e[0].style.display="")},$order:function(e){return this.$('.paintShop-order[data-order-id="'+e+'"]')},handleOrderClick:function(e,t){if(!i.currentDialog){var r=this.model.get(e);if(r){var o=r.get("followupId");if(o&&("no"===t||"order"===t))return void this.onFocus(o);var n=this.$order(e)[0];n&&this.$el.animate({scrollTop:n.offsetTop+1},200);var l=new s({model:r,height:n?n.clientHeight:0,vkb:this.options.vkb});i.showDialog(l)}}},onChange:function(e){this.$order(e.id).replaceWith(n({order:e.serialize(),visible:this.model.isVisible(e),commentVisible:!0}))},onFocus:function(e){var t=this.$order(e)[0];t?this.$el.animate({scrollTop:t.offsetTop+1},200):this.handleOrderClick(e)},onMrpSelected:function(){var e=this.model.selectedMrp;this.$(".paintShop-order").each(function(){this.style.display="all"===e||this.dataset.mrp===e?"":"none"})}})});