define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/planning/util/contextMenu","./PaintShopOrderDetailsView","app/paintShop/templates/queue","app/paintShop/templates/queueOrder"],function(e,t,i,r,s,o,d,l,n,a){"use strict";return o.extend({template:n,modelProperty:"orders",events:{"mousedown .paintShop-order":function(e){this.lastClickEvent=e,this.options.embedded&&(this.timers.showMenu&&clearTimeout(this.timers.showMenu),this.timers.showMenu=setTimeout(this.showMenu.bind(this,e),300))},"mouseup .paintShop-order":function(e){if(!this.options.embedded||this.timers.showMenu){clearTimeout(this.timers.showMenu),this.timers.showMenu=null;var t=this.lastClickEvent;this.lastClickEvent=null,t&&0===e.button&&""===window.getSelection().toString()&&(window.parent===window||t.offsetY===e.offsetY&&t.offsetX===e.offsetX&&t.screenX===e.screenX&&t.screenY===e.screenY)&&this.handleOrderClick(e.currentTarget.dataset.orderId,this.$(e.target).closest("td")[0].dataset.property)}},"contextmenu .visible":function(e){return this.showMenu(e),!1}},initialize:function(){this.onScroll=e.debounce(this.onScroll.bind(this),100,!1),this.lastClickEvent=null,this.lastFocusedOrder=null,this.listenTo(this.orders,"reset",e.after(2,this.render)),this.listenTo(this.orders,"change",this.onChange),this.listenTo(this.orders,"focus",this.onFocus),this.listenTo(this.orders,"mrpSelected paintSelected",this.toggleVisibility),this.listenTo(this.orders,"paintSelected",this.toggleChildOrderDropZones),this.listenTo(this.dropZones,"updated",this.onDropZoneUpdated)},getTemplateData:function(){var e=this,t=null,i=null,r=e.orders.getChildOrderDropZoneClass.bind(e.orders),s=e.orders.serialize().map(function(s){return(s={order:s,visible:e.orders.isVisible(s),first:!1,last:!1,commentVisible:!0,rowSpan:"rowSpan",mrpDropped:e.dropZones.getState(s.mrp),getChildOrderDropZoneClass:r}).visible&&(t||(t=s),i=s),s});return t&&(t.first=!0),i&&(i.last=!0),{orders:s,renderQueueOrder:a}},afterRender:function(){var e=this.$order(this.lastFocusedOrder);e.length&&(this.el.parentNode.scrollTop=e[0].offsetTop+1)},$order:function(e){return this.$('.paintShop-order[data-order-id="'+e+'"]')},handleOrderClick:function(e,t){if(!s.currentDialog){var i=this.orders.get(e);if(i){var r=i.get("followups");if(!r.length||"no"!==t&&"order"!==t){var o=this.$order(e)[0];o&&(this.$el.parent().animate({scrollTop:o.offsetTop+1},200),this.lastFocusedOrder=e);var d=new l({model:i,orders:this.orders,dropZones:this.dropZones,height:o?o.clientHeight:0,vkb:this.options.vkb,embedded:this.options.embedded});s.showDialog(d)}else this.onFocus(r[0])}}},showMenu:function(e){this.timers.showMenu&&(clearTimeout(this.timers.showMenu),this.timers.showMenu=null);var t=this.orders.get(e.currentTarget.dataset.orderId),i=t.get("order"),s=t.get("mrp"),o=this.orders.isDrillingMrpSelected(),l=[t.get("order"),{icon:"fa-print",label:this.t("menu:printOrder"),handler:this.trigger.bind(this,"actionRequested","printOrders",{filterProperty:"order",filterValue:i,drilling:o})},{icon:"fa-clipboard",label:this.t("menu:copyOrder"),handler:this.trigger.bind(this,"actionRequested","copyOrders",e,{filterProperty:"order",filterValue:i,drilling:o}),visible:!this.options.embedded},{label:this.t("menu:copyChildOrders"),handler:this.trigger.bind(this,"actionRequested","copyChildOrders",e,{filterProperty:"order",filterValue:i,drilling:o}),visible:!this.options.embedded},"-",this.t("menu:header:mrp",{mrp:s}),{icon:"fa-print",label:this.t("menu:printOrders"),handler:this.trigger.bind(this,"actionRequested","printOrders",{filterProperty:"mrp",filterValue:s,drilling:o})},{icon:"fa-clipboard",label:this.t("menu:copyOrders"),handler:this.trigger.bind(this,"actionRequested","copyOrders",e,{filterProperty:"mrp",filterValue:s,drilling:o}),visible:!this.options.embedded},{label:this.t("menu:copyChildOrders"),handler:this.trigger.bind(this,"actionRequested","copyChildOrders",e,{filterProperty:"mrp",filterValue:s,drilling:o}),visible:!this.options.embedded},{icon:"fa-download",label:this.t("menu:exportOrders"),handler:this.trigger.bind(this,"actionRequested","exportOrders",{filterProperty:"mrp",filterValue:s,drilling:o}),visible:!this.options.embedded}];!o&&r.isAllowedTo("PAINT_SHOP:DROP_ZONES")&&l.push({icon:"fa-level-down",label:this.t("menu:dropZone:"+this.dropZones.getState(s)),handler:this.trigger.bind(this,"actionRequested","dropZone",s,!1)}),l.push("-",this.t("menu:header:all"),{icon:"fa-print",label:this.t("menu:printOrders"),handler:this.trigger.bind(this,"actionRequested","printOrders",{filterProperty:null,filterValue:null,drilling:o})},{icon:"fa-clipboard",label:this.t("menu:copyOrders"),handler:this.trigger.bind(this,"actionRequested","copyOrders",e,{filterProperty:null,filterValue:null,drilling:o}),visible:!this.options.embedded},{label:this.t("menu:copyChildOrders"),handler:this.trigger.bind(this,"actionRequested","copyChildOrders",e,{filterProperty:null,filterValue:null,drilling:o}),visible:!this.options.embedded},{icon:"fa-download",label:this.t("menu:exportOrders"),handler:this.trigger.bind(this,"actionRequested","exportOrders",{filterProperty:null,filterValue:null,drilling:o}),visible:!this.options.embedded});var n=this.orders.selectedPaint;r.isAllowedTo("PAINT_SHOP:DROP_ZONES")&&"all"!==n&&l.push({icon:"fa-level-down",label:this.t("menu:dropZone:"+this.dropZones.getState(n)),handler:this.trigger.bind(this,"actionRequested","dropZone",n,!0)}),d.show(this,e.pageY,e.pageX,l)},hideMenu:function(){d.hide(this)},toggleVisibility:function(){var e=this.orders;this.$(".paintShop-order").each(function(){var t=e.get(this.dataset.orderId),i=!t||!e.isVisible(t.serialize());this.classList.toggle("hidden",i),this.classList.toggle("visible",!i)}),this.$(".paintShop-order.is-first, .paintShop-order.is-last").removeClass("is-first is-last");var t=this.$(".visible");t.first().addClass("is-first"),t.last().addClass("is-last"),this.el.scrollTop=0},toggleChildOrderDropZones:function(){var e=this;e.$(".paintShop-childOrder-dropZone").each(function(){this.classList.remove("is-dropped","is-undroppable","is-droppable");var t=e.orders.get(this.dataset.orderId);if(t){var i=(t=t.serialize()).childOrders[this.dataset.childOrderIndex];if(i){var r=e.orders.getChildOrderDropZoneClass(i,t);r&&this.classList.add(r)}}})},onScroll:function(){var e=this.$(".visible");if(e.length){var t=this.el.parentNode;if(t){this.lastFocusedOrder=e[0].dataset.orderId;for(var i=t.scrollTop,r=0;r<e.length;++r){var s=e[r];if(s.offsetTop>i)break;this.lastFocusedOrder=s.dataset.orderId,i>s.offsetTop+26&&e[r+1]&&(this.lastFocusedOrder=e[r+1].dataset.orderId)}}}},onChange:function(e){var t=this.$order(e.id),i=e.serialize();t.replaceWith(a({order:i,visible:this.orders.isVisible(i),first:t.hasClass("is-first"),last:t.hasClass("is-last"),commentVisible:!0,rowSpan:"rowSpan",mrpDropped:this.dropZones.getState(i.mrp),getChildOrderDropZoneClass:this.orders.getChildOrderDropZoneClass.bind(this.orders)}))},onFocus:function(e,t){var i=this.$order(e)[0];i?(i.classList.contains("hidden")&&this.orders.selectMrp(i.dataset.mrp),this.$el.parent().animate({scrollTop:i.offsetTop+1},200),this.lastFocusedOrder=e,t&&t.showDetails&&this.handleOrderClick(e)):this.handleOrderClick(e)},onDropZoneUpdated:function(e){var t=e.get("mrp"),i=e.get("state"),r=this.$('.paintShop-property-mrp[data-mrp="'+t+'"]');r.length?r.toggleClass("is-dropped",i):this.toggleChildOrderDropZones()}})});