define(["underscore","../time","../i18n","../core/Model"],function(t,n,i,e){"use strict";var s={777777777777:!0};function a(t){return["date","startedAt","finishedAt"].forEach(function(n){"string"==typeof t[n]&&(t[n]=new Date(t[n]))}),t}return e.extend({urlRoot:"/paintShop/orders",clientUrlRoot:"#paintShop/orders",topicPrefix:"paintShop.orders",privilegePrefix:"PAINT_SHOP",nlsDomain:"paintShop",parse:a,serialize:function(e,a,r){if(r||(r=this.collection),!e&&r&&r.serializedMap&&r.serializedMap[this.id])return r.serializedMap[this.id];!a&&r&&r.paints&&(a=r.paints);var o=this.toJSON(),p=o.childOrders.length,l=p-1;if(o.rowSpan=p+1,o.rowSpanDetails=o.rowSpan,o.paints={},o.mrps={},o.mrps[o.mrp]=1,o.drilling="000000000000"===o.paint.nc12,o.drilling&&(o.mrps.KSJ=1,o.paints["000000000000"]=o.qty),o.childOrders=o.childOrders.map(function(n,i){o.mrps[n.mrp]=1;var e=[];o.paintCount=0,n.paints={},n.paintList=[],n.components.forEach(function(t){if(!s[t.nc12]){"G"!==t.unit&&"KG"!==t.unit||(o.paintCount+=1,o.paints[t.nc12]||(o.paints[t.nc12]=0),n.paints[t.nc12]||(n.paints[t.nc12]=0,n.paintList.push(t.nc12)),o.paints[t.nc12]+=n.qty,n.paints[t.nc12]+=n.qty);var i=a?a.get(t.nc12):null;i?(t.name=i.get("name"),t.placement=i.get("shelf")+", "+i.get("bin")):t.placement="",e.push(t)}});var r=e.length,p=r+(1!==o.paintCount?1:0);return o.rowSpan+=r,o.rowSpanDetails+=p,t.assign({rowSpan:r+1,rowSpanDetails:p+1,last:i===l},n,{components:e})}),o.mrps=Object.keys(o.mrps).join(" "),r&&o.followups.length){var m=o.followups;o.followups=[],m.forEach(function(t){var n=r.get(t);n&&o.followups.push({id:t,no:n.get("no")})})}if(o.startTime&&(o.startTimeTime=n.utc.format(o.startTime,"HH:mm:ss")),o.startedAt){var c=n.getMoment(o.startedAt);o.startedAtTime=c.format("HH:mm:ss"),o.startedAtDate=c.format("DD.MM, HH:mm:ss")}if(o.finishedAt){var d=n.getMoment(o.finishedAt);o.finishedAtTime=d.format("HH:mm:ss"),o.finishedAtDate=d.format("DD.MM, HH:mm:ss")}return"finished"===o.status&&o.qtyDlv>=o.qty&&(o.status="delivered"),o.statusText=i("paintShop","status:"+o.status),o}},{DRILLING_MRP:"KSJ",parse:a,isComponentBlacklisted:function(t){return s[t.nc12]}})});