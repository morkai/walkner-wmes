// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../i18n","../core/Model"],function(t,e,n,i){"use strict";function a(t){return["date","startedAt","finishedAt"].forEach(function(e){"string"==typeof t[e]&&(t[e]=new Date(t[e]))}),t}var r={777777777777:!0};return i.extend({urlRoot:"/paintShop/orders",clientUrlRoot:"#paintShop/orders",topicPrefix:"paintShop.orders",privilegePrefix:"PAINT_SHOP",nlsDomain:"paintShop",parse:a,serialize:function(i,a){var o=this;if(!i&&o.collection&&o.collection.serializedMap&&o.collection.serializedMap[o.id])return o.collection.serializedMap[o.id];!a&&o.collection&&o.collection.paints&&(a=o.collection.paints);var s=o.toJSON(),c=s.childOrders.length,p=c-1;if(s.rowSpan=c+1,s.rowSpanDetails=s.rowSpan,s.paints={},s.childOrders=s.childOrders.map(function(e,n){var i=[];s.paintCount=0,e.components.forEach(function(t){if(!r[t.nc12]){"G"!==t.unit&&"KG"!==t.unit||(s.paintCount+=1,s.paints[t.nc12]||(s.paints[t.nc12]=0),s.paints[t.nc12]+=e.qty);var n=a?a.get(t.nc12):null;n?(t.name=n.get("name"),t.placement=n.get("shelf")+", "+n.get("bin")):t.placement="",i.push(t)}});var o=i.length,c=o+(s.paintCount>1?1:0);return s.rowSpan+=o,s.rowSpanDetails+=c,t.assign({rowSpan:o+1,rowSpanDetails:c+1,last:n===p},e,{components:i})}),s.startTime&&(s.startTimeTime=e.utc.format(s.startTime,"HH:mm:ss")),s.startedAt){var l=e.getMoment(s.startedAt);s.startedAtTime=l.format("HH:mm:ss"),s.startedAtDate=l.format("DD.MM, HH:mm:ss")}if(s.finishedAt){var m=e.getMoment(s.finishedAt);s.finishedAtTime=m.format("HH:mm:ss"),s.finishedAtDate=m.format("DD.MM, HH:mm:ss")}return s.statusText=n("paintShop","status:"+s.status),s}},{parse:a,isComponentBlacklisted:function(t){return r[t.nc12]}})});