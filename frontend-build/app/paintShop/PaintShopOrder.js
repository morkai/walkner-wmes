define(["underscore","app/time","app/i18n","app/core/Model","app/planning/util/shift"],function(t,n,r,e,i){"use strict";var s={new:"warning",started:"info",partial:"warning",finished:"success",cancelled:"danger"},a={777777777777:!0};function o(t){return["date","startedAt","finishedAt"].forEach(function(n){"string"==typeof t[n]&&(t[n]=new Date(t[n]))}),t}return e.extend({urlRoot:"/paintShop/orders",clientUrlRoot:"#paintShop/orders",topicPrefix:"paintShop.orders",privilegePrefix:"PAINT_SHOP",nlsDomain:"paintShop",parse:o,serialize:function(e,o,l){var p=this;if(l||(l=p.collection),!e&&l&&l.serializedMap&&l.serializedMap[p.id])return l.serializedMap[p.id];!o&&l&&l.paints&&(o=l.paints);var d=p.toJSON(),c=l&&l.drillingOrders&&l.drillingOrders.getAllByOrderNo(d.order)||[],u=l&&l.whOrders&&l.whOrders.byOrderNo[d.order]||[],f=d.childOrders.length,h=f-1;d.rowSpanDetails=f+1,d.notes.length&&(d.rowSpanDetails+=1),d.rowSpanList=d.rowSpanDetails,d.paints={},d.mrps={},d.mrps[d.mrp]=1,d.drilling="000000000000"===d.paint.nc12,d.drilling&&(d.mrps.KSJ=1,d.paints["000000000000"]=d.qty);var m={};if(d.workOrders.forEach(function(t){m[t.childOrder]||(m[t.childOrder]=[]),m[t.childOrder].push(t);var e=Date.parse(t.shift),s=i.getShiftNo(e,!0);t.shiftText=n.utc.format(e,"L")+", "+r("core","SHIFT:"+s),t.workersText=t.workers[0].label,t.workers.length>1&&(t.workersText+=" +"+(t.workers.length-1))}),d.childOrders=d.childOrders.map(function(n,e){d.mrps[n.mrp]=1;var i=[];n.paints={},n.paintList=[],n.noteList=n.nc12===d.nc12?[]:Array.prototype.slice.call(n.notes),n.paintCount=0,n.drilling=p.getDrillingStatus(n,c),n.components.forEach(function(t){if(!a[t.nc12]){"G"!==t.unit&&"KG"!==t.unit||(n.paintCount+=1,d.paints[t.nc12]||(d.paints[t.nc12]=0),n.paints[t.nc12]||(n.paints[t.nc12]=0,n.paintList.push(t.nc12)),d.paints[t.nc12]+=n.qty,n.paints[t.nc12]+=n.qty);var r=o?o.get(t.nc12):null;r?(t.name=r.get("name"),t.placement=r.get("shelf")+", "+r.get("bin")):t.placement="",i.push(t)}});var l=i.length,u=0;return 1!==n.paintCount&&(0===n.paintCount?n.noteList.unshift({icon:"fa-circle-o",priority:"warning",text:r("paintShop","drilling")}):n.noteList.unshift({icon:"fa-paint-brush",priority:"danger",text:r("paintShop","multiPaint",{count:n.paintCount})})),n.drilling&&n.noteList.unshift({icon:"fa-circle-o",priority:s[n.drilling],text:r("paintShop","drilling:"+n.drilling)}),n.noteList.length&&(l+=1),n.workOrders=m[n.order]||[],u+=n.workOrders.length,d.rowSpanList+=l+0,d.rowSpanDetails+=l+u,t.assign({rowSpanList:l+0+1,rowSpanDetails:l+u+1,last:e===h},n,{components:i})}),d.mrps=Object.keys(d.mrps).join(" "),l&&d.followups.length){var g=d.followups;d.followups=[],g.forEach(function(t){var n=l.get(t);n&&d.followups.push({id:t,no:n.get("no")})})}if(d.startTime&&(d.startTimeTime=n.utc.format(d.startTime,"HH:mm:ss")),d.startedAt){var w=n.getMoment(d.startedAt);d.startedAtTime=w.format("HH:mm:ss"),d.startedAtDate=w.format("DD.MM, HH:mm:ss")}if(d.finishedAt){var S=n.getMoment(d.finishedAt);d.finishedAtTime=S.format("HH:mm:ss"),d.finishedAtDate=S.format("DD.MM, HH:mm:ss")}return"startedMsp"===d.status?d.status="started":"finished"===d.status&&d.qtyDlv>=d.qty&&(d.status="delivered"),d.statusText=r("paintShop","status:"+d.status),d.whOrders=u.map(function(t){return t.serialize()}),d},getDrillingStatus:function(t,n){if(0===n.length)return null;var r={},e={};t.components.forEach(function(t){e[t.nc12]=!0}),n.forEach(function(t){if(t.hasAnyChildOrderForComponents(e)){var n=t.get("status");n[n]?r[n]+=1:r[n]=1}});var i=Object.keys(r);return 0===i.length?null:(delete r.cancelled,1===(i=Object.keys(r)).length?i[0]:"started")}},{DRILLING_MRP:"KSJ",parse:o,isComponentBlacklisted:function(t){return a[t.nc12]}})});