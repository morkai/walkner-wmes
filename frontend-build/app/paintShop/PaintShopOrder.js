define(["underscore","../time","../i18n","../core/Model"],function(t,n,i,e){"use strict";var r={new:"warning",started:"info",partial:"warning",finished:"success",cancelled:"danger"},s={777777777777:!0};function a(t){return["date","startedAt","finishedAt"].forEach(function(n){"string"==typeof t[n]&&(t[n]=new Date(t[n]))}),t}return e.extend({urlRoot:"/paintShop/orders",clientUrlRoot:"#paintShop/orders",topicPrefix:"paintShop.orders",privilegePrefix:"PAINT_SHOP",nlsDomain:"paintShop",parse:a,serialize:function(e,a,o){var l=this;if(o||(o=l.collection),!e&&o&&o.serializedMap&&o.serializedMap[l.id])return o.serializedMap[l.id];!a&&o&&o.paints&&(a=o.paints);var p=l.toJSON(),c=o&&o.drillingOrders&&o.drillingOrders.getAllByOrderNo(p.order)||[],d=o&&o.whOrders&&o.whOrders.byOrderNo[p.order]||[],u=p.childOrders.length,f=u-1;if(p.rowSpanDetails=u+1,p.notes.length&&(p.rowSpanDetails+=1),p.paints={},p.mrps={},p.mrps[p.mrp]=1,p.drilling="000000000000"===p.paint.nc12,p.drilling&&(p.mrps.KSJ=1,p.paints["000000000000"]=p.qty),p.childOrders=p.childOrders.map(function(n,e){p.mrps[n.mrp]=1;var o=[];n.paints={},n.paintList=[],n.noteList=n.nc12===p.nc12?[]:Array.prototype.slice.call(n.notes),n.paintCount=0,n.drilling=l.getDrillingStatus(n,c),n.components.forEach(function(t){if(!s[t.nc12]){"G"!==t.unit&&"KG"!==t.unit||(n.paintCount+=1,p.paints[t.nc12]||(p.paints[t.nc12]=0),n.paints[t.nc12]||(n.paints[t.nc12]=0,n.paintList.push(t.nc12)),p.paints[t.nc12]+=n.qty,n.paints[t.nc12]+=n.qty);var i=a?a.get(t.nc12):null;i?(t.name=i.get("name"),t.placement=i.get("shelf")+", "+i.get("bin")):t.placement="",o.push(t)}});var d=o.length;return 1!==n.paintCount&&(0===n.paintCount?n.noteList.unshift({icon:"fa-circle-o",priority:"warning",text:i("paintShop","drilling")}):n.noteList.unshift({icon:"fa-paint-brush",priority:"danger",text:i("paintShop","multiPaint",{count:n.paintCount})})),n.drilling&&n.noteList.unshift({icon:"fa-circle-o",priority:r[n.drilling],text:i("paintShop","drilling:"+n.drilling)}),n.noteList.length&&(d+=1),p.rowSpanDetails+=d,t.assign({rowSpanDetails:d+1,last:e===f},n,{components:o})}),p.mrps=Object.keys(p.mrps).join(" "),o&&p.followups.length){var h=p.followups;p.followups=[],h.forEach(function(t){var n=o.get(t);n&&p.followups.push({id:t,no:n.get("no")})})}if(p.startTime&&(p.startTimeTime=n.utc.format(p.startTime,"HH:mm:ss")),p.startedAt){var m=n.getMoment(p.startedAt);p.startedAtTime=m.format("HH:mm:ss"),p.startedAtDate=m.format("DD.MM, HH:mm:ss")}if(p.finishedAt){var g=n.getMoment(p.finishedAt);p.finishedAtTime=g.format("HH:mm:ss"),p.finishedAtDate=g.format("DD.MM, HH:mm:ss")}return"startedMsp"===p.status?p.status="started":"finished"===p.status&&p.qtyDlv>=p.qty&&(p.status="delivered"),p.statusText=i("paintShop","status:"+p.status),p.whOrders=d.map(function(t){return t.serialize()}),p},getDrillingStatus:function(t,n){if(0===n.length)return null;var i={},e={};t.components.forEach(function(t){e[t.nc12]=!0}),n.forEach(function(t){if(t.hasAnyChildOrderForComponents(e)){var n=t.get("status");n[n]?i[n]+=1:i[n]=1}});var r=Object.keys(i);return 0===r.length?null:(delete i.cancelled,1===(r=Object.keys(i)).length?r[0]:"started")}},{DRILLING_MRP:"KSJ",parse:a,isComponentBlacklisted:function(t){return s[t.nc12]}})});