define(["underscore","../time","../i18n","../core/Model"],function(t,n,e,i){"use strict";var r={777777777777:!0};function s(t){return["date","startedAt","finishedAt"].forEach(function(n){"string"==typeof t[n]&&(t[n]=new Date(t[n]))}),t}return i.extend({urlRoot:"/paintShop/orders",clientUrlRoot:"#paintShop/orders",topicPrefix:"paintShop.orders",privilegePrefix:"PAINT_SHOP",nlsDomain:"paintShop",parse:s,serialize:function(i,s,a){var o=this;if(a||(a=o.collection),!i&&a&&a.serializedMap&&a.serializedMap[o.id])return a.serializedMap[o.id];!s&&a&&a.paints&&(s=a.paints);var l=o.toJSON(),p=a.drillingOrders&&a.drillingOrders.getAllByOrderNo(l.order),c=l.childOrders.length,d=c-1;if(l.rowSpan=c+1,l.rowSpanDetails=l.rowSpan,l.paints={},l.mrps={},l.mrps[l.mrp]=1,l.drilling="000000000000"===l.paint.nc12,l.drilling&&(l.mrps.KSJ=1,l.paints["000000000000"]=l.qty),l.childOrders=l.childOrders.map(function(n,e){l.mrps[n.mrp]=1;var i=[];n.paints={},n.paintList=[],n.paintCount=0,n.drilling=o.getDrillingStatus(n,p),n.components.forEach(function(t){if(!r[t.nc12]){"G"!==t.unit&&"KG"!==t.unit||(n.paintCount+=1,l.paints[t.nc12]||(l.paints[t.nc12]=0),n.paints[t.nc12]||(n.paints[t.nc12]=0,n.paintList.push(t.nc12)),l.paints[t.nc12]+=n.qty,n.paints[t.nc12]+=n.qty);var e=s?s.get(t.nc12):null;e?(t.name=e.get("name"),t.placement=e.get("shelf")+", "+e.get("bin")):t.placement="",i.push(t)}});var a=i.length,c=a+(1!==n.paintCount?1:0)+(n.drilling?1:0);return l.rowSpan+=a,l.rowSpanDetails+=c,t.assign({rowSpan:a+1,rowSpanDetails:c+1,last:e===d},n,{components:i})}),l.mrps=Object.keys(l.mrps).join(" "),a&&l.followups.length){var u=l.followups;l.followups=[],u.forEach(function(t){var n=a.get(t);n&&l.followups.push({id:t,no:n.get("no")})})}if(l.startTime&&(l.startTimeTime=n.utc.format(l.startTime,"HH:mm:ss")),l.startedAt){var f=n.getMoment(l.startedAt);l.startedAtTime=f.format("HH:mm:ss"),l.startedAtDate=f.format("DD.MM, HH:mm:ss")}if(l.finishedAt){var m=n.getMoment(l.finishedAt);l.finishedAtTime=m.format("HH:mm:ss"),l.finishedAtDate=m.format("DD.MM, HH:mm:ss")}return"finished"===l.status&&l.qtyDlv>=l.qty&&(l.status="delivered"),l.statusText=e("paintShop","status:"+l.status),l},getDrillingStatus:function(t,n){if(0===n.length)return null;var e={},i={};t.components.forEach(function(t){i[t.nc12]=!0}),n.forEach(function(t){if(t.hasAnyChildOrderForComponents(i)){var n=t.get("status");n[n]?e[n]+=1:e[n]=1}});var r=Object.keys(e);return 0===r.length?null:(delete e.cancelled,1===(r=Object.keys(e)).length?r[0]:"started")}},{DRILLING_MRP:"KSJ",parse:s,isComponentBlacklisted:function(t){return r[t.nc12]}})});