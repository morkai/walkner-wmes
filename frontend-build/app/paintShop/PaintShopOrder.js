// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../time","../i18n","../core/Model"],function(t,n,e,i){"use strict";function a(t){return["date","startedAt","finishedAt"].forEach(function(n){"string"==typeof t[n]&&(t[n]=new Date(t[n]))}),t}var s={777777777777:!0};return i.extend({urlRoot:"/paintShop/orders",clientUrlRoot:"#paintShop/orders",topicPrefix:"paintShop.orders",privilegePrefix:"PAINT_SHOP",nlsDomain:"paintShop",parse:a,serialize:function(i,a,r){var o=this;if(r||(r=o.collection),!i&&r&&r.serializedMap&&r.serializedMap[o.id])return r.serializedMap[o.id];!a&&r&&r.paints&&(a=r.paints);var p=o.toJSON(),c=p.childOrders.length,l=c-1;if(p.rowSpan=c+1,p.rowSpanDetails=p.rowSpan,p.paints={},p.childOrders=p.childOrders.map(function(n,e){var i=[];p.paintCount=0,n.paints={},n.paintList=[],n.components.forEach(function(t){if(!s[t.nc12]){"G"!==t.unit&&"KG"!==t.unit||(p.paintCount+=1,p.paints[t.nc12]||(p.paints[t.nc12]=0),n.paints[t.nc12]||(n.paints[t.nc12]=0,n.paintList.push(t.nc12)),p.paints[t.nc12]+=n.qty,n.paints[t.nc12]=!0);var e=a?a.get(t.nc12):null;e?(t.name=e.get("name"),t.placement=e.get("shelf")+", "+e.get("bin")):t.placement="",i.push(t)}});var o=i.length,c=o+(p.paintCount>1?1:0);if(p.rowSpan+=o,p.rowSpanDetails+=c,r&&p.followups.length){var f=p.followups;p.followups=[],f.forEach(function(t){var n=r.get(t);n&&p.followups.push({id:t,no:n.get("no")})})}return t.assign({rowSpan:o+1,rowSpanDetails:c+1,last:e===l},n,{components:i})}),p.startTime&&(p.startTimeTime=n.utc.format(p.startTime,"HH:mm:ss")),p.startedAt){var f=n.getMoment(p.startedAt);p.startedAtTime=f.format("HH:mm:ss"),p.startedAtDate=f.format("DD.MM, HH:mm:ss")}if(p.finishedAt){var u=n.getMoment(p.finishedAt);p.finishedAtTime=u.format("HH:mm:ss"),p.finishedAtDate=u.format("DD.MM, HH:mm:ss")}return p.statusText=e("paintShop","status:"+p.status),p}},{parse:a,isComponentBlacklisted:function(t){return s[t.nc12]}})});