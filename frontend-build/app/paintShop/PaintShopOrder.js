define(["underscore","../time","../i18n","../core/Model"],function(t,n,e,r){"use strict";var i={777777777777:!0};function s(t){return["date","startedAt","finishedAt"].forEach(function(n){"string"==typeof t[n]&&(t[n]=new Date(t[n]))}),t}return r.extend({urlRoot:"/paintShop/orders",clientUrlRoot:"#paintShop/orders",topicPrefix:"paintShop.orders",privilegePrefix:"PAINT_SHOP",nlsDomain:"paintShop",parse:s,serialize:function(r,s,a){var o=this;if(a||(a=o.collection),!r&&a&&a.serializedMap&&a.serializedMap[o.id])return a.serializedMap[o.id];!s&&a&&a.paints&&(s=a.paints);var l=o.toJSON(),p=a.drillingOrders&&a.drillingOrders.getAllByOrderNo(l.order),d=a.whOrders&&a.whOrders.byOrderNo[l.order]||[],c=l.childOrders.length,u=c-1;if(l.rowSpan=c+1,l.rowSpanDetails=l.rowSpan,l.paints={},l.mrps={},l.mrps[l.mrp]=1,l.drilling="000000000000"===l.paint.nc12,l.drilling&&(l.mrps.KSJ=1,l.paints["000000000000"]=l.qty),l.childOrders=l.childOrders.map(function(n,e){l.mrps[n.mrp]=1;var r=[];n.paints={},n.paintList=[],n.paintCount=0,n.drilling=o.getDrillingStatus(n,p),n.components.forEach(function(t){if(!i[t.nc12]){"G"!==t.unit&&"KG"!==t.unit||(n.paintCount+=1,l.paints[t.nc12]||(l.paints[t.nc12]=0),n.paints[t.nc12]||(n.paints[t.nc12]=0,n.paintList.push(t.nc12)),l.paints[t.nc12]+=n.qty,n.paints[t.nc12]+=n.qty);var e=s?s.get(t.nc12):null;e?(t.name=e.get("name"),t.placement=e.get("shelf")+", "+e.get("bin")):t.placement="",r.push(t)}});var a=r.length,d=a+(1!==n.paintCount?1:0)+(n.drilling?1:0);return l.rowSpan+=a,l.rowSpanDetails+=d,t.assign({rowSpan:a+1,rowSpanDetails:d+1,last:e===u},n,{components:r})}),l.mrps=Object.keys(l.mrps).join(" "),a&&l.followups.length){var f=l.followups;l.followups=[],f.forEach(function(t){var n=a.get(t);n&&l.followups.push({id:t,no:n.get("no")})})}if(l.startTime&&(l.startTimeTime=n.utc.format(l.startTime,"HH:mm:ss")),l.startedAt){var m=n.getMoment(l.startedAt);l.startedAtTime=m.format("HH:mm:ss"),l.startedAtDate=m.format("DD.MM, HH:mm:ss")}if(l.finishedAt){var h=n.getMoment(l.finishedAt);l.finishedAtTime=h.format("HH:mm:ss"),l.finishedAtDate=h.format("DD.MM, HH:mm:ss")}return"finished"===l.status&&l.qtyDlv>=l.qty&&(l.status="delivered"),l.statusText=e("paintShop","status:"+l.status),l.whOrders=d.map(function(t){return t.serialize()}),l},getDrillingStatus:function(t,n){if(0===n.length)return null;var e={},r={};t.components.forEach(function(t){r[t.nc12]=!0}),n.forEach(function(t){if(t.hasAnyChildOrderForComponents(r)){var n=t.get("status");n[n]?e[n]+=1:e[n]=1}});var i=Object.keys(e);return 0===i.length?null:(delete e.cancelled,1===(i=Object.keys(e)).length?i[0]:"started")}},{DRILLING_MRP:"KSJ",parse:s,isComponentBlacklisted:function(t){return i[t.nc12]}})});