// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/time","app/core/views/FilterView","app/icpo/templates/filter"],function(e,t,s){"use strict";return t.extend({template:s,defaultFormData:function(){return{from:"",to:"",srcId:"",no:"",nc12:"",result:["success","failure"]}},termToForm:{startedAt:function(t,s,r){var i="datetime-local"===this.$id("from").prop("type")?"YYYY-MM-DDTHH:mm:ss":"YYYY-MM-DD HH:mm";r["ge"===s.name?"from":"to"]=e.format(s.args[1],i)},serviceTag:function(e,t,s){s[e]=t.args[1]},result:function(e,t,s){("success"===t.args[1]||"failure"===t.args[1])&&(s.result=[t.args[1]])},order:"serviceTag",gprs:"serviceTag",led:"serviceTag",srcId:"serviceTag"},initialize:function(){this.collection&&this.listenTo(this.collection,"change:srcIds",this.setUpSrcIdSelect2)},afterRender:function(){t.prototype.afterRender.call(this),1===this.formData.result.length?this.$(".icpo-filter-"+this.formData.result[0]).addClass("active"):this.$(".icpo-filter-result > label").addClass("active"),this.setUpSrcIdSelect2()},setUpSrcIdSelect2:function(){this.$id("srcId").select2({width:"200px",allowClear:!0,data:(this.collection.srcIds||[]).map(function(e){return{id:e,text:e}})})},serializeFormToQuery:function(t){var s=e.getMoment(this.$id("from").val()),r=e.getMoment(this.$id("to").val()),i=this.$id("serviceTag").val().trim(),a=this.$id("driver").val().trim(),l=this.$id("srcId").val(),c=this.$('input[name="result[]"]:checked');l.length&&t.push({name:"eq",args:["srcId",l]}),/^P000[0-9]{12}$/.test(i)&&t.push({name:"eq",args:["serviceTag",i]}),/^[0-9]{12}$/.test(a)&&t.push({name:"eq",args:["driver",a]}),s.isValid()&&t.push({name:"ge",args:["startedAt",s.valueOf()]}),r.isValid()&&t.push({name:"lt",args:["startedAt",r.valueOf()]}),1===c.length&&t.push({name:"eq",args:["result",c.val()]})}})});