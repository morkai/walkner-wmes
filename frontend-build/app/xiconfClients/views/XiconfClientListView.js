// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/user","app/viewport","app/core/views/ListView","app/core/views/DialogView","app/licenses/views/LicensePickerView","../XiconfClientCollection","app/xiconfClients/templates/restartDialog","app/xiconfClients/templates/updateDialog"],function(e,i,t,n,s,o,l,c,a,r,d){"use strict";return o.extend({className:"xiconfClients-list is-colored",remoteTopics:{"xiconf.clients.**":"refreshCollection"},events:e.extend({"click a.licenses-id":function(e){e.currentTarget.blur();var t=this.getModelFromEvent(e),n=t.get("license");n&&n._id&&(n=n._id);var o=new c({model:{appId:"walkner-xiconf",unused:!0,currentLicenseId:n,usedLicenses:new a(null,{rqlQuery:"select(license)&limit(999)"})}});return this.listenToOnce(o,"licensePicked",function(e){s.closeDialog(),this.socket.emit("xiconf.configure",{socket:t.get("socket"),settings:{licenseKey:e.get("key")}})}),s.showDialog(o,i("xiconfClients","licensePicker:title")),!1},"click .action-restart":function(e){e.currentTarget.blur();var t=this.getModelFromEvent(e),n=new l({template:r,model:{client:t.id}});return this.listenTo(n,"answered",function(i){"yes"===i&&(e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.restart",{socket:t.get("socket")}))}),s.showDialog(n,i("xiconfClients","restartDialog:title")),!1},"click .action-update":function(e){var t=this.getModelFromEvent(e);if(!e.originalEvent)return e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.update",{socket:t.get("socket")}),!1;e.currentTarget.blur();var n=new l({template:d,model:{client:t.id}});return this.listenTo(n,"answered",function(i){"yes"===i&&(e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.update",{socket:t.get("socket")}))}),s.showDialog(n,i("xiconfClients","updateDialog:title")),!1}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.listenTo(this.settings,"change",function(e){"xiconf.appVersion"===e.id&&this.render()})},columns:[{id:"_id",className:"is-min"},{id:"prodLine",className:"is-min"},{id:"orderLink",className:"is-min",label:i.bound("xiconfClients","PROPERTY:order")},{id:"lastSeenAt",className:"is-min"},{id:"appVersion",className:"is-min"},{id:"mowVersion",className:"is-min"},{id:"coreScannerDriver",className:"is-min"},{id:"shortLicense",className:"is-min",label:i.bound("xiconfClients","PROPERTY:license")},"features"],serializeActions:function(){var e=this.collection,t=n.isAllowedTo("XICONF:MANAGE");return function(n){var s=e.get(n._id),l=s.url(),c=null!==n.connectedAt,a=[{href:l+";downloadVNC",icon:"desktop",label:i.bound("xiconfClients","list:downloadVNC")},{href:l+";goTo?page=",icon:"external-link",label:i.bound("xiconfClients","list:goToDashboard")},{id:"goToSettings",href:l+";goTo?page=settings",icon:"cog",label:i.bound("xiconfClients","list:goToSettings")},{id:"update",icon:"forward",label:i.bound("xiconfClients","list:update"),className:c&&n.appVersionCmp===-1?"":"disabled"}];return t&&(c?a.push({id:"restart",icon:"refresh",label:i.bound("xiconfClients","list:restart")}):a.push(o.actions.delete(s))),a}},serializeRows:function(){return this.collection.invoke("serialize",{appVersion:this.settings.getValue("appVersion")})}})});