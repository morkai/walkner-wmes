define(["underscore","app/i18n","app/time","app/user","app/viewport","app/core/views/ListView","app/core/views/DialogView","app/licenses/views/LicensePickerView","../XiconfClientCollection","app/xiconfClients/templates/restartDialog","app/xiconfClients/templates/updateDialog"],function(e,i,t,s,n,o,l,a,c,r,d){"use strict";return o.extend({className:"xiconfClients-list is-colored",remoteTopics:{"xiconf.clients.**":"refreshCollection"},events:e.assign({"click a.licenses-id":function(e){e.currentTarget.blur();var t=this.getModelFromEvent(e),s=t.get("license");s&&s._id&&(s=s._id);var o=new a({model:{appId:"walkner-xiconf",unused:!0,currentLicenseId:s,usedLicenses:new c(null,{rqlQuery:"select(license)&limit(999)"})}});return this.listenToOnce(o,"licensePicked",function(e){n.closeDialog(),this.socket.emit("xiconf.configure",{socket:t.get("socket"),settings:{licenseKey:e.get("key")}})}),n.showDialog(o,i("xiconfClients","licensePicker:title")),!1},"click .action-restart":function(e){e.currentTarget.blur();var t=this.getModelFromEvent(e),s=new l({template:r,model:{client:t.id,nlsDomain:t.getNlsDomain()}});return this.listenTo(s,"answered",function(i){"yes"===i&&(e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.restart",{socket:t.get("socket")}))}),n.showDialog(s,i("xiconfClients","restartDialog:title")),!1},"click .action-update":function(e){var t=this.getModelFromEvent(e);if(!e.originalEvent)return e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.update",{socket:t.get("socket")}),!1;e.currentTarget.blur();var s=new l({template:d,model:{client:t.id,nlsDomain:t.getNlsDomain()}});return this.listenTo(s,"answered",function(i){"yes"===i&&(e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.update",{socket:t.get("socket")}))}),n.showDialog(s,i("xiconfClients","updateDialog:title")),!1}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.listenTo(this.settings,"change",function(e){"xiconf.appVersion"===e.id&&this.render()})},columns:[{id:"_id",className:"is-min",tdClassName:"text-mono"},{id:"prodLine",className:"is-min",tdClassName:"text-mono"},{id:"orderLink",className:"is-min",label:i.bound("xiconfClients","PROPERTY:order")},{id:"lastSeenAt",className:"is-min"},{id:"appVersion",className:"is-min"},{id:"mowVersion",className:"is-min"},{id:"coreScannerDriver",className:"is-min"},{id:"shortLicense",className:"is-min",label:i.bound("xiconfClients","PROPERTY:license")},"features",{id:"remoteAddress",className:"is-min",tdClassName:"text-mono"}],serializeActions:function(){var e=this.collection,t=s.isAllowedTo("XICONF:MANAGE");return function(s){var n=e.get(s._id),l=n.url(),a=null!==s.connectedAt,c=[{href:l+";downloadVNC",icon:"desktop",label:i.bound("xiconfClients","list:downloadVNC")},{href:l+";goTo?page=",icon:"external-link",label:i.bound("xiconfClients","list:goToDashboard")},{id:"goToSettings",href:l+";goTo?page=settings",icon:"cog",label:i.bound("xiconfClients","list:goToSettings")},{id:"update",icon:"forward",label:i.bound("xiconfClients","list:update"),className:!a||-1!==s.appVersionCmp||/^rpi/.test(s._id)?"disabled":""}];return t&&(a?c.push({id:"restart",icon:"refresh",label:i.bound("xiconfClients","list:restart")}):c.push(o.actions.delete(n))),c}},serializeRows:function(){return this.collection.invoke("serialize",{appVersion:this.settings.getValue("appVersion")})}})});