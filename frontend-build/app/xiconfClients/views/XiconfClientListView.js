// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/user","app/viewport","app/core/views/ListView","app/core/views/DialogView","app/xiconfClients/templates/restartDialog","app/xiconfClients/templates/updateDialog"],function(e,i,t,s,n,o,a,l,r){"use strict";return o.extend({className:"xiconfClients-list is-colored",remoteTopics:{"xiconf.clients.**":"refreshCollection"},events:e.extend({"click .action-restart":function(e){e.currentTarget.blur();var t=this.getModelFromEvent(e),s=new a({template:l,model:{client:t.id}});return this.listenTo(s,"answered",function(i){"yes"===i&&(e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.restart",{socket:t.get("socket")}))}),n.showDialog(s,i("xiconfClients","restartDialog:title")),!1},"click .action-update":function(e){var t=this.getModelFromEvent(e);if(!e.originalEvent)return e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.update",{socket:t.get("socket")}),!1;e.currentTarget.blur();var s=new a({template:r,model:{client:t.id}});return this.listenTo(s,"answered",function(i){"yes"===i&&(e.currentTarget.classList.add("disabled"),this.socket.emit("xiconf.update",{socket:t.get("socket")}))}),n.showDialog(s,i("xiconfClients","updateDialog:title")),!1}},o.prototype.events),columns:[{id:"_id",className:"is-min"},{id:"prodLine",className:"is-min"},{id:"shortLicense",className:"is-min",label:i.bound("xiconfClients","PROPERTY:license")},{id:"features",className:"is-min"},{id:"appVersion",className:"is-min"},{id:"mowVersion",className:"is-min"},{id:"orderLink",className:"is-min",label:i.bound("xiconfClients","PROPERTY:order")},"lastSeenAt"],serializeActions:function(){var e=this.collection,t=s.isAllowedTo("XICONF:MANAGE");return function(s){var n=e.get(s._id),a=n.url(),l=null!==s.connectedAt,r=[{href:a+";downloadVNC",icon:"desktop",label:i.bound("xiconfClients","list:downloadVNC")},{href:a+";goTo?page=",icon:"external-link",label:i.bound("xiconfClients","list:goToDashboard")},{id:"goToSettings",href:a+";goTo?page=settings",icon:"cog",label:i.bound("xiconfClients","list:goToSettings")},{id:"update",icon:"forward",label:i.bound("xiconfClients","list:update"),className:l&&-1===s.appVersionCmp?"":"disabled"}];return t&&r.push(l?{id:"restart",icon:"refresh",label:i.bound("xiconfClients","list:restart")}:o.actions["delete"](n)),r}},serializeRows:function(){return this.collection.invoke("serialize",{appVersion:this.settings.getValue("appVersion")})}})});