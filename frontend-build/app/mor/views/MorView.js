// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/broker","app/i18n","app/user","app/viewport","app/core/View","app/core/views/DialogView","app/data/prodFunctions","./SectionFormView","./WatchFormView","./MrpFormView","./EditProdFunctionFormView","app/mor/templates/mor","app/mor/templates/removeSection","app/mor/templates/removeWatch","app/mor/templates/removeMrp","app/mor/templates/userPopover"],function(e,t,i,o,n,r,s,a,d,c,l,h,u,m,p,g,f,v){"use strict";return s.extend({template:m,dialogClassName:"mor-dialog",events:{"click h3":function(e){if("I"===e.target.tagName||"SPAN"===e.target.tagName){var t=this.$(e.target).closest(".mor-section").toggleClass("is-collapsed");this.model.toggleSection(t[0].dataset.sectionId,t.hasClass("is-collapsed"))}},"click .mor-user":function(e){return this.toggleUserPopover(this.$(e.currentTarget)),!1},"click .btn[data-action]":function(e){var t=this.$(e.currentTarget),i=t[0].dataset.action,o=[],n=function(e){return t.closest("[data-"+e+"]").attr("data-"+e)};switch(i){case"addSection":o.push();break;case"removeSection":o.push(n("section-id"));break;case"editSection":o.push(n("section-id"));break;case"addWatch":o.push(n("section-id"));break;case"removeWatch":o.push(n("section-id"),n("user-id"));break;case"editWatch":o.push(n("section-id"),n("user-id"));break;case"addMrp":o.push(n("section-id"));break;case"removeMrp":o.push(n("section-id"),n("mrp-id"));break;case"editMrp":o.push(n("section-id"),n("mrp-id"));break;case"editProdFunction":o.push(n("section-id"),n("mrp-id"),n("prod-function-id"))}e.currentTarget.blur(),e.preventDefault(),e.stopPropagation(),this.redirectIfNeeded(i,o)||this[i].apply(this,o)},"mouseenter tr[data-mrp-id]":function(e){this.$(e.currentTarget).closest("tbody").find(".mor-is-common").addClass("mor-mrps-highlight")},"mouseleave tr[data-mrp-id]":function(e){this.$(e.currentTarget).closest("tbody").find(".mor-is-common").removeClass("mor-mrps-highlight")},"dragenter .mor-section":function(e){this.hoveredSectionId=e.currentTarget.dataset.sectionId},"click #-editMode":function(){r.closeDialog(),this.broker.publish("router.navigate",{url:"/mor?edit=1",trigger:!0,replace:!1})}},initialize:function(){this.editing=String(!!this.options.editing),this.$userPopover=null,this.$dndIndicator=null,this.draggedSectionId=null,this.hoveredSectionId=null,this.model.subscribe(this.pubsub),this.listenTo(this.model,"update:presence",this.onPresenceUpdated),t(window).on("click."+this.idPrefix,this.onClick.bind(this)).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)),t(document).on("dragstart."+this.idPrefix,this.onDragStart.bind(this)).on("dragend."+this.idPrefix,this.onDragEnd.bind(this)).on("dragenter."+this.idPrefix,this.onDragEnter.bind(this)).on("dragover."+this.idPrefix,this.onDragOver.bind(this)).on("drop."+this.idPrefix,this.onDrop.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),t(document).off("."+this.idPrefix),this.hideUserPopover(),this.$id("jumpList").remove()},serialize:function(){var e=this.serializeProdFunctions(),t=n.isAllowedTo("FN:manager"),i=n.isAllowedTo("MOR:MANAGE");return{idPrefix:this.idPrefix,draggable:this.editing,editModeVisible:this.options.editable!==!1&&r.currentDialog===this,linkEmails:this.options.editable!==!1,sectionActionsVisible:i,watchActionsVisible:t||i,mrpActionsVisible:i,sections:this.serializeSections(e),prodFunctions:e}},serializeSections:function(e){return(this.model.get("sections")||[]).map(this.serializeSection.bind(this,e))},serializeSection:function(t,i){i.prodFunctions.length&&(t=this.serializeProdFunctions(i.prodFunctions));var o=this.model,r=this.serializeWatches(i),s=this.serializeMrps(t,i);return{_id:i._id,collapsed:o.isSectionCollapsed(i._id),label:i.name,addWatchVisible:i.watchEnabled,watchVisible:i.watchEnabled&&r.length>0,watchAvailabilityVisible:e.some(r,function(e){return""!==e.user.availability}),watch:r,mrpsVisible:i.mrpsEnabled&&(s.length>0||this.options.editable!==!1&&n.isAllowedTo("MOR:MANAGE")),mrpColumnVisible:!0,mrps:s,prodFunctions:t}},serializeWatches:function(e){var t=this.model;return e.watch.filter(function(e){return!!t.users.get(e.user)}).sort(function(e,i){return e=t.users.get(e.user),i=t.users.get(i.user),e.get("prodFunction")===i.get("prodFunction")?e.getLabel().localeCompare(i.getLabel()):"manager"===e.get("prodFunction")?-1:"manager"===i.get("prodFunction")?1:e.getLabel().localeCompare(i.getLabel())}).map(this.serializeWatch,this)},serializeWatch:function(e){return{user:this.serializeUser(e,e.user,-1)}},serializeMrps:function(t,i){var o={};return i.commonProdFunctions.forEach(function(e){o[e._id]=e.users}),e.forEach(this.model.get("globalProdFunctions"),function(e){o[e._id]=e.users}),i.mrps.sort(function(e,t){return e._id.localeCompare(t._id)}).map(this.serializeMrp.bind(this,t,o,i.mrps.length))},serializeMrp:function(e,t,i,o,n){return{_id:o._id,name:/^[A-Za-z0-9]/.test(o._id)?o._id:"",description:o.description,prodFunctions:this.serializeMrpProdFunctions(e,o.prodFunctions,0===n?t:{},0===n,i)}},serializeMrpProdFunctions:function(e,t,i,o,n){var r=this,s={};return t.forEach(function(e){s[e._id]=e}),e.map(function(e){var t=s[e._id]||{_id:e._id,users:[]},a=(i[e._id]||t.users).map(function(t,i){var o=r.serializeUser(null,t,i);return e.ordered||(o.no=""),o});return e.ordered||a.sort(function(e,t){return e.label.localeCompare(t.label)}),{_id:e._id,common:e.common||e.global,users:a,rowspan:(e.common||e.global)&&o?n:0}}).filter(function(e){return o||!e.common})},serializeUser:function(e,t,i){var o=this.model.users.get(t),n=d.get(o.get("prodFunction"));return{_id:o.id,no:i+1+". ",label:o.getLabel(),prodFunction:n?n.getLabel():"?",email:o.get("email")||"?",mobile:o.getMobile()||"?",presence:o.get("presence"),availability:e&&e.from&&e.to&&e.from!==e.to?e.from+"-"+e.to:""}},serializeProdFunctions:function(t){var i=this.model.get("settings")||{},o=i.globalProdFunctions||[],n=i.commonProdFunctions||[],r=i.orderedProdFunctions||[];return t||(t=i.prodFunctions||[]),e.map(t,function(t){var i=d.get(t);return{_id:i?i.id:t,label:i?i.getLabel():t,global:e.contains(o,t),common:e.contains(n,t),ordered:e.contains(r,t)}})},beforeRender:function(){this.stopListening(this.model,"change update",this.render),this.$id("jumpList").remove()},afterRender:function(){this.listenTo(this.model,"change update",this.render),this.$id("jumpList").on("click","a",this.onJumpListClick.bind(this)),r.currentDialog===this&&this.$id("jumpList").addClass("hidden mor-jumpList-modal")},onDialogShown:function(){this.$id("jumpList").appendTo(document.body).removeClass("hidden")},onJumpListClick:function(e){var i=this.$id("jumpList").hasClass("mor-jumpList-modal"),o=e.currentTarget.dataset.sectionId,n=this.$('.mor-section[data-section-id="'+o+'"]');this.model.isSectionCollapsed(o)&&n.find(".mor-section-name").click();var r=0;if(i)r=n.position().top+30;else{r=n.offset().top-14;var s=t(".navbar-fixed-top");s.length&&(r-=s.outerHeight())}return t(i?".modal":"html, body").stop(!0,!1).animate({scrollTop:r}),!1},toggleEditing:function(e){this.editing=String(e),this.$("[draggable]").attr("draggable",this.editing)},onDragStart:function(e){e.target.draggable&&e.target.classList.contains("mor-section-name")&&n.isAllowedTo("MOR:MANAGE")&&(e.originalEvent.dataTransfer.dropEffect="move",this.draggedSectionId=this.$(e.target).closest("[data-section-id]").attr("data-section-id"),this.hoveredSectionId=this.draggedSectionId,this.$dndIndicator=t('<hr class="mor-dnd-indicator">'),this.positionDndIndicator(e),this.$dndIndicator.appendTo(document.body))},onDragEnter:function(e){this.draggedSectionId&&e.preventDefault()},onDragEnd:function(){this.$dndIndicator&&(this.$dndIndicator.remove(),this.$dndIndicator=null),this.draggedSectionId=null},onDragOver:function(e){this.draggedSectionId&&this.hoveredSectionId&&(e.preventDefault(),this.positionDndIndicator(e))},onDrop:function(){if(this.draggedSectionId){var e={source:this.draggedSectionId,target:this.hoveredSectionId,position:this.$dndIndicator.attr("data-position")};this.draggedSectionId=null,this.hoveredSectionId=null,setTimeout(this.model.moveSection.bind(this.model,e),1)}},positionDndIndicator:function(e){var t=this.$('.mor-section[data-section-id="'+this.hoveredSectionId+'"]'),i=e.originalEvent.pageY,o=t.offset().top,n=t.outerHeight(!0),r="before";if(i>o+n/2){r="after";var s=t.next();s.length?o=s.offset().top:o+=n+8}else t.prev().length||(o-=10);this.$dndIndicator.css("top",o+"px").attr("data-position",r)},redirectIfNeeded:function(e,t){return!!r.currentDialog&&(i.subscribe("viewport.dialog.hidden").setLimit(1).on("message",function(){i.subscribe("viewport.page.shown").setLimit(1).on("message",function(){"mor"===r.currentPage.pageId&&r.currentPage.view[e].apply(r.currentPage.view,t)}),i.publish("router.navigate",{url:"/mor",trigger:!0,replace:!1})}),r.closeAllDialogs(),!0)},addSection:function(){r.showDialog(new c({model:{nlsSuffix:"add",mor:this.model,section:null}}),o("mor","sectionForm:title:add"))},removeSection:function(e){var t=new a({template:p,autoHide:!1,model:{section:this.model.getSection(e).name}});this.listenTo(t,"answered",function(){this.model.removeSection({section:e}).fail(function(){r.msg.show({type:"error",time:3e3,text:o("mor","removeSection:failure")})}).done(function(){r.closeDialog()}).always(function(){t.enableAnswers()})}),r.showDialog(t,o("mor","removeSection:title"))},editSection:function(e){r.showDialog(new c({model:{nlsSuffix:"edit",mor:this.model,section:this.model.getSection(e)}}),o("mor","sectionForm:title:edit"))},addWatch:function(e){r.showDialog(new l({model:{mode:"add",mor:this.model,section:this.model.getSection(e),watch:null}}),o("mor","watchForm:title:add"))},removeWatch:function(e,t){var i=new a({template:g,autoHide:!1,model:{user:this.model.users.get(t).getLabel()}});this.listenTo(i,"answered",function(){this.model.removeWatch({section:e,user:t}).fail(function(){r.msg.show({type:"error",time:3e3,text:o("mor","removeWatch:failure")})}).done(function(){r.closeDialog()}).always(function(){i.enableAnswers()})}),r.showDialog(i,o("mor","removeWatch:title"))},editWatch:function(e,t){r.showDialog(new l({model:{mode:"edit",mor:this.model,section:this.model.getSection(e),watch:this.model.getWatch(e,t)}}),o("mor","watchForm:title:edit"))},addMrp:function(e){r.showDialog(new h({model:{mode:"add",mor:this.model,section:this.model.getSection(e),mrp:null}}),o("mor","mrpForm:title:add"))},removeMrp:function(e,t){var i=new a({template:f,autoHide:!1,model:{section:this.model.getSection(e).name,mrp:t}});this.listenTo(i,"answered",function(){this.model.removeMrp({section:e,mrp:t}).fail(function(){r.msg.show({type:"error",time:3e3,text:o("mor","removeMrp:failure")})}).done(function(){r.closeDialog()}).always(function(){i.enableAnswers()})}),r.showDialog(i,o("mor","removeMrp:title"))},editMrp:function(e,t){r.showDialog(new h({model:{mode:"edit",mor:this.model,section:this.model.getSection(e),mrp:this.model.getMrp(e,t)}}),o("mor","mrpForm:title:edit"))},editProdFunction:function(e,t,i){r.showDialog(new u({model:{mor:this.model,section:this.model.getSection(e),mrp:this.model.getMrp(e,t),prodFunction:d.get(i)}}),o("mor","editProdFunction:title"))},toggleUserPopover:function(e){this.$userPopover?this.$userPopover[0]===e[0]?this.hideUserPopover():(this.hideUserPopover(),this.showUserPopover(e)):this.showUserPopover(e)},hideUserPopover:function(){this.$userPopover&&(this.$userPopover.popover("destroy"),this.$userPopover=null)},showUserPopover:function(e){if(!this.$userPopover){var t=this.model.users.get(e[0].dataset.userId);this.$userPopover=e.popover({placement:"right",trigger:"manual",html:!0,title:t.getLabel(),content:this.getUserPopoverContent(t)}).popover("show")}},getUserPopoverContent:function(e){var t=d.get(e.get("prodFunction"));return v({editable:this.options.editable!==!1,user:{name:e.getLabel(),prodFunction:t?t.getLabel():"",email:e.get("email"),mobile:e.getMobile()}})},onClick:function(e){t(e.target).closest(".popover").length||this.hideUserPopover()},onKeyDown:function(e){27===e.keyCode&&this.hideUserPopover()},onPresenceUpdated:function(t){var i=this;e.forEach(t,function(e,t){i.$('.mor-user-presence[data-user-id="'+t+'"]').removeClass("mor-user-present mor-user-notPresent").addClass("mor-user-"+(e?"present":"notPresent"))})}})});