define(["underscore","jquery","Sortable","app/i18n","app/viewport","app/core/View","app/core/util/idAndLabel","app/data/orgUnits","app/data/prodFunctions","app/users/User","app/mor/templates/editProdFunctionForm"],function(e,t,i,o,n,r,s,c,l,d,u){"use strict";return r.extend({template:u,events:{submit:function(){var e=this,t=e.$id("submit").prop("disabled",!0),i={section:e.model.section._id,mrp:e.model.mrp._id,prodFunction:e.model.prodFunction.id,users:e.$id("users").val().split(",").map(function(t){return e.users[t]}).filter(function(e){return!!e})};return e.model.mor.editProdFunction(i).fail(function(){n.msg.show({type:"error",time:3e3,text:o("mor","editProdFunction:failure")}),t.prop("disabled",!1)}).done(function(){e.closeDialog()}),!1}},initialize:function(){this.users={}},destroy:function(){this.sortable.destroy(),this.sortable=null},serialize:function(){var e=this.model,t=e.prodFunction,i=e.mor.isGlobalProdFunction(t.id),n=e.mor.isCommonProdFunction(t.id);return{idPrefix:this.idPrefix,section:i?o("mor","editProdFunction:section:all"):e.section.name,mrp:i||n?o("mor","editProdFunction:mrp:all"):e.mrp._id,prodFunction:t.getLabel()}},afterRender:function(){var t=this,i=t.model,o=i.mor,n=o.getUsers(i.section._id,i.mrp._id,i.prodFunction.id).map(function(e){return o.users.get(e)}).filter(function(e){return!!e}),r=n.map(function(e){return e.id}),c=n.map(s),l=t.$id("users");n.forEach(function(e){t.users[e.id]=e.toJSON()}),l.val(r.join(",")),t.setUpUsersSelect2(c),t.ajax({url:"/users?exclude(privileges)&sort(searchName)&limit(999)&prodFunction="+i.prodFunction.id}).done(function(i){e.forEach(i.collection,function(i){t.users[i._id]=i,e.contains(r,i._id)||c.push(s(new d(i)))}),c.length>r.length&&t.setUpUsersSelect2(c)})},setUpUsersSelect2:function(e){this.sortable&&this.sortable.destroy();var t=this.$id("users").select2({allowClear:!0,multiple:!0,data:e});this.sortable=new i(t.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){t.select2("onSortStart")},onEnd:function(){t.select2("onSortEnd").select2("focus")}}),t.select2("focus")},onDialogShown:function(){this.closeDialog=n.closeDialog.bind(n),this.$id("users").select2("focus")},closeDialog:function(){}})});