// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/user","app/core/Model","app/data/orgUnits","app/data/prodFunctions","app/users/UserCollection"],function(t,e,i,n,r,s,o){"use strict";function c(){return e.Deferred().resolve().promise()}function u(){return e.Deferred().reject().promise()}return n.extend({defaults:function(){return{users:[],settings:{},globalProdFunctions:[],sections:[]}},initialize:function(){this.collapsedSections=JSON.parse(localStorage.MOR_COLLAPSED_SECTIONS||"{}"),this.users=new o(this.attributes.users,{paginate:!1}),this.on("change:users",function(){this.users.reset(this.attributes.users)})},url:function(){return"/mor"},subscribe:function(t){t.subscribe("mor.updated",this.onMorUpdated.bind(this)),t.subscribe("users.edited",this.onUserEdited.bind(this)),t.subscribe("users.deleted",this.onUserDeleted.bind(this)),t.subscribe("users.presence.updated",this.onPresenceUpdated.bind(this)),t.subscribe("settings.updated.mor.**",this.onSettingUpdated.bind(this))},getSection:function(e){return t.findWhere(this.get("sections"),{_id:e})||null},getWatch:function(e,i){var n=this.getSection(e);return n?t.findWhere(n.watch,{user:i}):null},getMrp:function(e,i){var n=this.getSection(e);return n?t.findWhere(n.mrps,{_id:i}):null},getUsers:function(e,i,n){var r;r=this.isGlobalProdFunction(n)?this.get("globalProdFunctions"):this.isCommonProdFunction(n)?(this.getSection(e)||{}).commonProdFunctions:(this.getMrp(e,i)||{}).prodFunctions;var s=t.findWhere(r,{_id:n});return s?s.users:[]},toggleSection:function(t,e){e?this.collapsedSections[t]=!0:delete this.collapsedSections[t],localStorage.MOR_COLLAPSED_SECTIONS=JSON.stringify(this.collapsedSections)},isSectionCollapsed:function(t){return!!this.collapsedSections[t]},isGlobalProdFunction:function(e){return t.contains((this.get("settings")||{}).globalProdFunctions,e)},isCommonProdFunction:function(e){return t.contains((this.get("settings")||{}).commonProdFunctions,e)},reload:function(){this.fetch()},act:function(t,i){return e.ajax({method:"POST",url:"/mor",data:JSON.stringify({instanceId:window.INSTANCE_ID,action:t,params:i})})},addSection:function(e,i){var n=this,r=n.getSection(e._id);return r?c():(r=t.assign({},e,{watch:[],commonProdFunctions:[],mrps:[]}),n.attributes.sections.push(r),n.trigger("update"),i===!1?c():n.act("addSection",e).fail(function(){n.attributes.sections=t.without(n.attributes.sections,r),n.trigger("update")}))},removeSection:function(e,i){var n=this,r=n.getSection(e.section);if(!r)return c();var s=[].concat(n.attributes.sections);return n.attributes.sections=t.without(s,r),n.trigger("update"),i===!1?c():n.act("removeSection",e).done(function(){delete n.collapsedSections[r.id]}).fail(function(){n.attributes.sections=s,n.trigger("update")})},editSection:function(e,i){var n=this,r=n.getSection(e._id);if(!r)return u();var s=t.clone(r);return t.assign(r,e),n.trigger("update"),i===!1?c():n.act("editSection",e).fail(function(){t.assign(r,s),n.trigger("update")})},moveSection:function(t,e){var i=this,n=i.getSection(t.source),r=i.getSection(t.target);if(n===r)return c();if(!n||!r)return u();var s=i.get("sections"),o=[].concat(s);return s.splice(s.indexOf(n),1),s.splice(s.indexOf(r)+("after"===t.position?1:0),0,n),i.trigger("update"),e===!1?c():i.act("moveSection",t).fail(function(){i.attributes.sections=o,i.trigger("update")})},addWatch:function(e,i){var n=this,r=n.getWatch(e.section,e.user);if(r)return c();var s=n.getSection(e.section);return s?(r=t.pick(e,["user","days","from","to"]),s.watch.push(r),n.trigger("update"),i===!1?c():n.act("addWatch",e).fail(function(){s.watch=t.without(s.watch,r),n.trigger("update")})):u()},removeWatch:function(e,i){var n=this,r=n.getWatch(e.section,e.user);if(!r)return c();var s=n.getSection(e.section);return s.watch=t.without(s.watch,r),n.trigger("update"),i===!1?c():n.act("removeWatch",e).fail(function(){s.watch.push(r),n.trigger("update")})},editWatch:function(e,i){var n=this,r=n.getWatch(e.section,e.user);if(!r)return u();var s=t.clone(r);return t.assign(r,t.pick(e,["user","days","from","to"])),n.trigger("update"),i===!1?c():n.act("editWatch",e).fail(function(){t.assign(r,s),n.trigger("update")})},addMrp:function(e,i){var n=this,r=n.getSection(e.section);if(!r)return u();var s=t.findWhere(r.mrps,{_id:e.mrp});return s?u():(s={_id:e.mrp,description:"",iptCheck:!1,iptCheckRecipients:[],prodFunctions:[]},t.assign(s,t.pick(e,["description","iptCheck"]),{iptCheckRecipients:t.pick(e.iptCheckRecipients,"_id")}),n.users.add(e.iptCheckRecipients),r.mrps.push(s),n.trigger("update"),i===!1?c():n.act("addMrp",t.assign({},e,{iptCheckRecipients:t.pick(e.iptCheckRecipients,"_id")})).fail(function(){r.mrps=t.without(r.mrps,s),n.trigger("update")}))},removeMrp:function(e,i){var n=this,r=n.getSection(e.section);if(!r)return c();var s=t.findWhere(r.mrps,{_id:e.mrp});return s?(r.mrps=t.without(r.mrps,s),n.trigger("update"),i===!1?c():n.act("removeMrp",e).fail(function(){r.mrps.push(s),n.trigger("update")})):c()},editMrp:function(e,i){var n=this,r=n.getSection(e.section);if(!r)return u();var s=t.findWhere(r.mrps,{_id:e.mrp});if(!s)return u();var o=t.clone(s);return t.assign(s,t.pick(e,["description","iptCheck"]),{iptCheckRecipients:t.pluck(e.iptCheckRecipients,"_id")}),n.users.add(e.iptCheckRecipients),n.trigger("update"),i===!1?c():n.act("editMrp",t.assign({},e,{iptCheckRecipients:t.pluck(e.iptCheckRecipients,"_id")})).fail(function(){t.assign(s,o),n.trigger("update")})},editProdFunction:function(e,i){var n,r=this;if(r.isGlobalProdFunction(e.prodFunction))e.section=null,e.mrp=null,n=this.get("globalProdFunctions");else if(r.isCommonProdFunction(e.prodFunction)){e.mrp=null;var s=this.getSection(e.section);if(!s)return u();n=s.commonProdFunctions}else{var o=r.getMrp(e.section,e.mrp);if(!o)return u();n=o.prodFunctions}var a=t.findWhere(n,{_id:e.prodFunction});a||(a={_id:e.prodFunction,users:[]},n.push(a));var d=[].concat(a.users);return a.users=e.users.map(function(t){return t._id}),r.users.add(e.users),r.trigger("update"),i===!1?c():r.act("editProdFunction",t.assign({},e,{users:a.users})).fail(function(){a.users=d,r.trigger("update")})},onMorUpdated:function(t){this[t.action]&&t.instanceId!==window.INSTANCE_ID&&this[t.action](t.params,!1)},onUserEdited:function(t){var e=this.users.get(t.model._id);e&&(e.set(t.model),this.trigger("update"))},onUserDeleted:function(t){var e=this.users.get(t.model._id);e&&(this.users.remove(e),this.trigger("update"))},onPresenceUpdated:function(e){var i=this.users,n={};t.forEach(e,function(t,e){var r=i.get(e);r&&(r.attributes.presence=t,n[e]=t)}),this.trigger("update:presence",n)},onSettingUpdated:function(t){this.attributes.settings[t._id.replace("mor.","")]=t.value,this.trigger("update")}})});