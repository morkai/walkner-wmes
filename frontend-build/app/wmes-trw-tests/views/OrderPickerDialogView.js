define(["underscore","jquery","app/viewport","app/core/View","app/wmes-trw-tests/templates/orderPicker"],function(t,e,i,o,n){"use strict";return o.extend({template:n,events:{"focus [data-vkb]":function(t){this.options.vkb&&this.options.vkb.show(t.currentTarget)},"click .trw-testing-list .btn":function(t){this.$id("order").val(t.currentTarget.dataset.id),this.validateOrder()},"input #-order":function(){this.validateOrder()},submit:function(t){t.preventDefault();var e=this.$id("order"),i={order:e.val(),qtyTodo:e.data("qty")};this.options.vkb&&this.options.vkb.hide(),this.trigger("picked",i)}},initialize:function(){e(window).on("resize."+this.idPrefix,this.resize.bind(this))},destroy:function(){e(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide()},onDialogShown:function(){this.resize(),this.$id("order").focus()},afterRender:function(){this.$id("order").val(this.model.get("order")||""),this.loadOrders(),this.validateOrder()},resize:function(){this.heightOffset||(this.heightOffset=this.$el.closest(".modal-content").outerHeight()-this.$id("doneGroup").outerHeight()+25+60);var t=window.innerHeight-this.heightOffset;this.$(".trw-testing-list").css("height",t+"px")},loadOrders:function(){var t=this,e=t.ajax({url:"/production/planExecution/"+encodeURIComponent(this.model.get("line"))+"?queue=0"});function i(e,i){var o="";i.forEach(function(t){o+='<button type="button" class="btn btn-lg btn-block btn-default" data-id="'+t.orderId+'">'+t.orderId.match(/[0-9]{3}/g).join(" ")+"</button>"}),o+='<div class="trw-testing-list-last"></div>',t.$id(e).html(o)}e.fail(function(){t.$(".fa-spin").removeClass("fa-spin")}),e.done(function(t){i("done",t.execution.doneOrders),i("todo",t.execution.todoOrders)})},validateOrder:function(){var t=this,e=t.$(".btn-primary").prop("disabled",!0),i=t.$id("order"),o=i.val();i[0].setCustomValidity(""),/^[0-9]{9}$/.test(o)?(t.validateReq&&t.validateReq.abort(),t.validateReq=t.ajax({url:"/orders/"+o+"?select(_id,qty)"}),t.validateReq.fail(function(){404===t.validateReq.status&&i[0].setCustomValidity(t.t("orderPicker:notFound"))}),t.validateReq.done(function(t){i.data("qty",t.qty)}),t.validateReq.always(function(){"abort"!==t.validateReq.statusText&&(e.prop("disabled",!1),t.validateReq=null)})):e.prop("disabled",!1)}})});