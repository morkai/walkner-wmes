define(["underscore","jquery","app/viewport","app/core/View","app/core/util/transliterate","app/wmes-trw-tests/templates/testerPicker"],function(t,e,i,s,n,r){"use strict";return s.extend({template:r,events:{"focus [data-vkb]":function(t){this.options.vkb&&this.options.vkb.show(t.currentTarget,this.onVkbValueChange.bind(this))},"click .trw-testing-list .btn":function(t){this.$(".active").removeClass("active"),t.currentTarget.classList.add("active"),this.toggleSubmit()},"input #-filter":function(t){this.filterPhrase=this.prepareFilter(t.currentTarget.value),this.filterList()},submit:function(t){t.preventDefault();var e={tester:this.testers[this.$(".active").attr("data-id")]};this.options.vkb&&this.options.vkb.hide(),this.trigger("picked",e)}},initialize:function(){this.filterPhrase="",this.testers={},e(window).on("resize."+this.idPrefix,this.resize.bind(this))},destroy:function(){e(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide()},onDialogShown:function(){this.resize(),this.$id("filter").focus()},onVkbValueChange:function(){this.$id("filter").trigger("input")},afterRender:function(){this.toggleSubmit(),this.loadTesters()},resize:function(){this.heightOffset||(this.heightOffset=this.$el.closest(".modal-content").outerHeight()-this.$id("testerGroup").outerHeight()+25+60);var t=window.innerHeight-this.heightOffset;this.$(".trw-testing-list").css("height",t+"px")},toggleSubmit:function(){this.$(".btn-primary").prop("disabled",0===this.$(".active").length)},loadTesters:function(){var e=this,i=e.ajax({url:"/trw/testers?limit(0)"});e.testers={},i.fail(function(){e.$(".fa-spin").removeClass("fa-spin")}),i.done(function(i){var s="",n=e.model.tester.id;i.collection.sort(function(t,e){return t.name.localeCompare(e.name,void 0,{numeric:!0,ignorePunctuation:!0})}),i.collection.forEach(function(i){e.testers[i._id]=i;var r=e.prepareFilter(i.name),a="btn btn-lg btn-block btn-default";e.filterPhrase.length&&-1===r.indexOf(e.filterPhrase)&&(a+=" hidden"),i._id===n&&(a+=" active"),s+='<button type="button" class="'+a+'" data-id="'+i._id+'" data-filter="'+r+'">'+t.escape(i.name)+"</button>"}),s+='<div class="trw-testing-list-last"></div>',e.$id("testers").html(s);var r=e.$(".active");r.length&&r[0].scrollIntoView({block:"center"}),e.toggleSubmit()})},prepareFilter:function(t){return n(t).replace(/[^a-zA-Z0-9]+/g,"").toUpperCase()},filterList:function(){var t=this;t.$id("testers").find(".btn-lg").each(function(){var e=t.filterPhrase.length>0&&-1===this.dataset.filter.indexOf(t.filterPhrase);this.classList.toggle("hidden",e),e&&this.classList.remove("active")}),this.toggleSubmit()}})});