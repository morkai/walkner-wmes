define(["underscore","jquery","app/viewport","app/core/View","app/core/util/transliterate","app/wmes-trw-tests/templates/programPicker"],function(t,i,e,r,s,n){"use strict";return r.extend({template:n,events:{"focus [data-vkb]":function(t){this.options.vkb&&this.options.vkb.show(t.currentTarget,this.onVkbValueChange.bind(this))},"click .trw-testing-list .btn":function(t){this.$(".active").removeClass("active"),t.currentTarget.classList.add("active"),this.toggleSubmit()},"input #-filter":function(t){this.filterPhrase=this.prepareFilter(t.currentTarget.value),this.filterList()},submit:function(t){t.preventDefault();var i={program:this.programs[this.$(".active").attr("data-id")]};i.program.tester=this.model.tester.toJSON(),this.options.vkb&&this.options.vkb.hide(),this.trigger("picked",i)}},initialize:function(){this.filterPhrase="",this.programs={},i(window).on("resize."+this.idPrefix,this.resize.bind(this))},destroy:function(){i(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide()},onDialogShown:function(){this.resize(),this.$id("filter").focus()},onVkbValueChange:function(){this.$id("filter").trigger("input")},afterRender:function(){this.toggleSubmit(),this.loadPrograms()},resize:function(){this.heightOffset||(this.heightOffset=this.$el.closest(".modal-content").outerHeight()-this.$id("programGroup").outerHeight()+25+60);var t=window.innerHeight-this.heightOffset;this.$(".trw-testing-list").css("height",t+"px")},toggleSubmit:function(){this.$(".btn-primary").prop("disabled",0===this.$(".active").length)},loadPrograms:function(){var i=this,e=i.ajax({url:"/trw/programs?tester="+encodeURIComponent(this.model.tester.id)+"&limit(0)"});i.programs={},e.fail(function(){i.$(".fa-spin").removeClass("fa-spin")}),e.done(function(e){var r="",s=i.model.program.id;e.collection.sort(function(t,i){return t.name.localeCompare(i.name,void 0,{numeric:!0,ignorePunctuation:!0})}),e.collection.forEach(function(e){i.programs[e._id]=e;var n=i.prepareFilter(e.name),o="btn btn-lg btn-block btn-default";i.filterPhrase.length&&-1===n.indexOf(i.filterPhrase)&&(o+=" hidden"),e._id===s&&(o+=" active"),r+='<button type="button" class="'+o+'" data-id="'+e._id+'" data-filter="'+n+'">'+t.escape(e.name)+"</button>"}),r+='<div class="trw-testing-list-last"></div>',i.$id("programs").html(r);var n=i.$(".active");n.length&&n[0].scrollIntoView({block:"center"}),i.toggleSubmit()})},prepareFilter:function(t){return s(t).replace(/[^a-zA-Z0-9]+/g,"").toUpperCase()},filterList:function(){var t=this;t.$id("programs").find(".btn-lg").each(function(){var i=t.filterPhrase.length>0&&-1===this.dataset.filter.indexOf(t.filterPhrase);this.classList.toggle("hidden",i),i&&this.classList.remove("active")}),this.toggleSubmit()}})});