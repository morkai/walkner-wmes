define(["underscore","jquery","app/viewport","app/core/View","app/core/util/transliterate","app/wmes-trw-tests/templates/basePicker"],function(t,i,e,s,n,r){"use strict";return s.extend({template:r,events:{"focus [data-vkb]":function(t){this.options.vkb&&this.options.vkb.show(t.currentTarget,this.onVkbValueChange.bind(this))},"click .trw-testing-list .btn":function(t){this.$(".active").removeClass("active"),t.currentTarget.classList.add("active"),this.toggleSubmit()},"input #-filter":function(t){this.filterPhrase=this.prepareFilter(t.currentTarget.value),this.filterList()},submit:function(t){t.preventDefault();var i={base:this.bases[this.$(".active").attr("data-id")]};this.options.vkb&&this.options.vkb.hide(),this.trigger("picked",i)}},initialize:function(){this.filterPhrase="",this.bases={},i(window).on("resize."+this.idPrefix,this.resize.bind(this))},destroy:function(){i(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide()},onDialogShown:function(){this.resize(),this.$id("filter").focus()},onVkbValueChange:function(){this.$id("filter").trigger("input")},afterRender:function(){this.toggleSubmit(),this.loadBases()},resize:function(){this.heightOffset||(this.heightOffset=this.$el.closest(".modal-content").outerHeight()-this.$id("testerGroup").outerHeight()+25+60);var t=window.innerHeight-this.heightOffset;this.$(".trw-testing-list").css("height",t+"px")},toggleSubmit:function(){this.$(".btn-primary").prop("disabled",0===this.$(".active").length)},loadBases:function(){var i=this,e=i.ajax({url:"/trw/bases?limit(0)&populate(tester)"});i.bases={},e.fail(function(){i.$(".fa-spin").removeClass("fa-spin")}),e.done(function(e){var s="",n=i.model.base.id;e.collection.sort(function(t,i){return t.name.localeCompare(i.name,void 0,{numeric:!0,ignorePunctuation:!0})}),e.collection.forEach(function(e){i.bases[e._id]=e;var r=i.prepareFilter(e.name),a="btn btn-lg btn-block btn-default";i.filterPhrase.length&&-1===r.indexOf(i.filterPhrase)&&(a+=" hidden"),e._id===n&&(a+=" active"),s+='<button type="button" class="'+a+'" data-id="'+e._id+'" data-filter="'+r+'">'+t.escape(e.name)+"</button>"}),s+='<div class="trw-testing-list-last"></div>',i.$id("bases").html(s);var r=i.$(".active");r.length&&r[0].scrollIntoView({block:"center"}),i.toggleSubmit()})},prepareFilter:function(t){return n(t).replace(/[^a-zA-Z0-9]+/g,"").toUpperCase()},filterList:function(){var t=this;t.$id("bases").find(".btn-lg").each(function(){var i=t.filterPhrase.length>0&&-1===this.dataset.filter.indexOf(t.filterPhrase);this.classList.toggle("hidden",i),i&&this.classList.remove("active")}),this.toggleSubmit()}})});