define(["underscore","jquery","jsplumb","app/i18n","app/viewport","app/data/localStorage","app/core/Model","app/core/View","app/core/util/embedded","app/core/util/uuid","app/production/views/VkbView","app/planning/util/contextMenu","app/wmes-trw-testers/Tester","app/wmes-trw-bases/Base","app/wmes-trw-bases/templates/cluster","app/wmes-trw-programs/Program","../Test","../views/WorkstationPickerDialogView","../views/OrderPickerDialogView","../views/BasePickerDialogView","../views/ProgramPickerDialogView","app/wmes-trw-tests/templates/testing","app/wmes-trw-tests/templates/debug"],function(e,t,s,o,i,r,n,a,l,d,h,u,c,g,m,p,f,b,w,v,T,I,k){"use strict";return a.extend({layoutName:"blank",template:I,pageId:"trw-testing",events:{'click [data-prop="workstation"]':function(e){e.currentTarget.classList.contains("is-unclickable")||this.showWorkstationPickerDialog()},'click [data-prop="order"]':function(){this.model.get("line")?this.showOrderPickerDialog():this.showWorkstationPickerDialog()},'click [data-prop="program"]':function(){this.model.base.get("name")?this.showProgramPickerDialog():this.showBasePickerDialog()},"click #-menu":function(){u.show(this,60,window.innerWidth-60,{className:"trw-testing-menu",menu:[{label:this.t("testing:menu:workstation"),handler:this.showWorkstationPickerDialog.bind(this)},{label:this.t("testing:menu:base"),handler:this.showBasePickerDialog.bind(this)},{label:this.t("testing:menu:debug:"+this.model.get("debug")),handler:this.toggleDebugMode.bind(this)}]})},"click .trw-testing-ft":function(){var e=this.model.get("state");("error"===e||/^test/.test(e))&&this.startTest()},"mouseenter .trw-base-cell":function(e){var t=this;if(t.model.get("debug")){var s=(t.model.get("endpointIo")||{})[e.currentTarget.id.replace("TRW:","")];if(s){var o=t.$id("debug");s.inputs.concat(s.outputs).forEach(function(e){t.debug.highlightedRows[e._id]=!0,o.find('.trw-testing-debug-row[data-id="'+e._id+'"]').addClass("is-highlighted")})}}},"mouseleave .trw-base-cell":function(){this.model.get("debug")&&(this.debug.highlightedRows={},this.$id("debug").find(".is-highlighted").removeClass("is-highlighted"))},"mouseenter .trw-testing-debug-row":function(e){var t=this,s=(t.model.get("cellIo")||{})[e.currentTarget.dataset.id];s&&s.length&&s.forEach(function(e){t.debug.highlightedCells[e]=!0,document.getElementById("TRW:"+e).classList.add("is-highlighted")})},"mouseleave .trw-testing-debug-row":function(){this.model.get("debug")&&(this.debug.highlightedCells={},this.$id("preview").find(".is-highlighted").removeClass("is-highlighted"))},"mouseenter .trw-base-cluster":function(e){var t=this;clearTimeout(t.timers.showImage),t.timers.showImage=setTimeout(function(){var s=t.model.program.getCluster(e.currentTarget.dataset.id);s&&t.$id("image").prop("src",s.image)},666)},"mouseleave .trw-base-cluster":function(){clearTimeout(this.timers.showImage),this.$id("image").prop("src","")}},localTopics:{"socket.connected":function(){this.loadModels()}},remoteTopics:{"trw.testers.edited":function(e){e.model._id===this.model.tester.id&&this.model.tester.set(e.model)},"trw.testers.deleted":function(e){e.model._id===this.model.tester.id&&(this.model.base.clear(),this.model.tester.clear())},"trw.bases.edited":function(e){e.model._id===this.model.base.id&&this.model.base.set(e.model)},"trw.bases.deleted":function(e){e.model._id===this.model.base.id&&this.model.base.clear()},"trw.programs.edited":function(e){var t=Object.assign({},e.model),s=this.model.program;t._id===s.id&&(t.base===this.model.base.id?(t.base=this.model.base.toJSON(),s.set(t)):s.clear())},"trw.programs.deleted":function(e){e.model._id===this.model.program.id&&this.model.program.clear()}},initialize:function(){var e=this.model=Object.assign(new n({debug:!1,ready:!1,state:"unknown",error:null,step:1,test:null,line:r.getItem("TRW:LINE")||"",workstation:parseInt(r.getItem("TRW:WORKSTATION"),10)||0,order:sessionStorage.getItem("TRW:ORDER")||"",qtyTodo:parseInt(sessionStorage.getItem("TRW:QTY_TODO"),10)||0,qtyDone:-1}),{nlsDomain:"wmes-trw-tests",tester:new c({_id:r.getItem("TRW:TESTER")||null}),base:new g({_id:r.getItem("TRW:BASE")||null}),program:new p({_id:sessionStorage.getItem("TRW:PROGRAM")||null}),test:new f});this.jsPlumb=null,this.debug={lastValues:{},highlightedRows:{},highlightedCells:{}},this.vkbView=new h,this.listenTo(e,"change:debug",this.updateDebugInfo),this.listenTo(e,"change:state",this.updateState),this.listenTo(e,"change:step",this.updateMessage),this.listenTo(e,"change:qtyTodo change:qtyDone",this.updateOrder),this.listenTo(e,"change:order",this.onOrderChange),this.listenTo(e,"change:line change:workstation",this.onLineChange),this.listenTo(e.tester,"error",this.onTesterError),this.listenTo(e.tester,"change",this.onTesterChange),this.listenTo(e.base,"error",this.onBaseError),this.listenTo(e.base,"change",this.onBaseChange),this.listenTo(e.program,"error",this.onProgramError),this.listenTo(e.program,"change",this.onProgramChange),this.setView("#-vkb",this.vkbView),t(window).on("resize."+this.idPrefix,this.resizePreview.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),document.body.classList.remove("trw-testing-page"),t(".modal.fade").addClass("fade"),this.jsPlumb&&(this.jsPlumb.reset(),this.jsPlumb=null)},beforeRender:function(){document.body.classList.add("trw-testing-page")},afterRender:function(){t(".modal.fade").removeClass("fade"),l.render(this),this.resizePreview(),this.updateWorkstation(),this.updateOrder(),this.updateProgramName(),this.updateMessage(),this.loadModels(),window.IS_EMBEDDED?(window.parent.postMessage({type:"ready",app:"trw"},"*"),this.scheduleAction(function(){this.model.set("ready",!0),this.startTest()},3333)):(this.model.set("ready",!0),this.startTest()),this.model.get("debug")&&(this.model.set("debug",!1,{silent:!0}),this.model.toggleDebugMode())},resizePreview:function(){var e=window.innerHeight-this.$(".trw-testing-hd").outerHeight()-this.$(".trw-testing-ft").outerHeight();this.$id("preview").css("height",e+"px")},loadModels:function(){var e=this;if(!e.model.tester.id||!e.model.base.id)return e.model.program.clear(),e.model.base.clear(),void e.model.tester.clear();var t=e.model.program.id,s=e.model.base.fetch();s.fail(function(){404===s.status&&(e.model.base.clear(),e.model.tester.clear())}),s.done(function(o){e.model.tester.set(o.tester),e.model.base.set(o),t&&(e.model.program.set({_id:t}),(s=e.model.program.fetch()).fail(function(){404===s.status&&e.model.program.clear()}),s.done(function(){var t=e.model.program.get("base");t&&t._id===e.model.base.id||e.model.program.clear()}))})},updateWorkstation:function(){var t,s=this.model.get("line"),o=this.model.get("workstation"),i=!1;s&&o?t=e.escape(s)+" • "+o:(t=this.t("testing:noWorkstation"),i=!0),this.$prop("workstation",t).toggleClass("is-unclickable",!i)},updateOrder:function(){var e=this.model.get("order"),t=this.model.get("qtyTodo"),s=this.model.get("qtyDone");this.model.get("line")?e?"000000000"===e?e=this.t("testing:woOrder"):t&&(e+=" • "+(s>=0?s:"?")+"/"+t):e=this.t("testing:noOrder"):e=this.t("testing:noWorkstation"),this.$prop("order",e)},updateProgramName:function(){var e=this.model.program.get("name");this.model.base.get("name")?e||(e=this.t("testing:noProgram")):e=this.t("testing:noBase"),this.$prop("program",e)},updateProgramPreview:function(){var e=this.$id("canvas");this.jsPlumb&&this.jsPlumb.reset(!0),e.empty();var t=this.model.program,s=this.model.base;t.get("name")&&s.get("name")&&(this.setUpJsPlumb(),this.renderCanvas())},setUpJsPlumb:function(){this.jsPlumb||(this.jsPlumb=s.getInstance({Container:this.$(".trw-base-canvas-inner")[0],ConnectionOverlays:[["Arrow",{id:"ARROW",location:-6,cssClass:"trw-base-canvas-arrow",visible:!0,width:22,length:22}],["Label",{id:"LABEL",location:.5,cssClass:"trw-base-canvas-label",visible:!1}]]}),this.jsPlumb.bind("beforeDrag",function(){return!1}))},renderCanvas:function(){var e=this,t=e.model.base.get("clusters"),s=t.map(function(t){return e.renderPartialHtml(m,{cluster:t})});e.$id("canvas").html(s),t.forEach(function(t){t.rows.forEach(function(s,o){s.forEach(function(s,i){var r=e.$('.trw-base-cluster[data-id="'+t._id+'"]').find('.trw-base-cell[data-row="'+o+'"][data-col="'+i+'"]')[0],n=t._id+":"+o+":"+i;s.endpoints.forEach(function(t){e.jsPlumb.addEndpoint(r,{uuid:n+":"+t,anchor:p.ENDPOINT_TO_ANCHOR[t],isSource:!1,isTarget:!1,allowLoopback:!1,maxConnections:-1,endpoint:["Dot",{radius:10}],cssClass:"trw-base-canvas-endpoint",connector:"Bezier",connectorClass:"trw-base-canvas-connector"})})})})})},updateState:function(){this.el.dataset.state=this.model.get("state"),this.updateMessage()},updateMessage:function(){var e=this.model.get("state"),t=e+"?";if(o.has(this.model.nlsDomain,"state:"+e))t=this.t("state:"+e);else if("test"===e){var s=this.model.test.get("program"),i=this.model.get("step");s.steps[i-1]&&(this.updateStepMessage(),t="")}else"error"===e&&(t=this.model.get("error"));this.$id("message").html(t)},updateStepMessage:function(){var e=this.model.test.get("program"),t=this.model.get("step"),s=e.steps[t-1];this.$id("step").text(this.t("state:step",{no:t})),this.updateStepProp("source",p.formatEndpoint(s.source,e.base)),this.updateStepProp("target",p.formatEndpoint(s.target,e.base)),this.updateStepProp("color",p.formatColor(s.color,"?")),this.updateStepProp("length",p.formatLength(s.length,"?"))},updateStepProp:function(e,t){this.$('.trw-testing-prop[data-prop="'+e+'"]').find(".trw-testing-prop-value").text(t)},showWorkstationPickerDialog:function(){var e=new b({model:this.model,vkb:this.vkbView});this.listenTo(e,"picked",function(e){this.model.set({line:e.line,workstation:e.workstation}),i.closeDialog()}),i.showDialog(e,this.t("workstationPicker:title"))},showOrderPickerDialog:function(){var e=new w({model:this.model,vkb:this.vkbView});this.listenTo(e,"picked",function(e){this.model.set({order:e.order,qtyTodo:e.qtyTodo}),i.closeDialog()}),i.showDialog(e,this.t("orderPicker:title"))},showBasePickerDialog:function(){var e=new v({model:this.model,vkb:this.vkbView});this.listenTo(e,"picked",function(e){this.model.tester.set(e.base.tester),this.model.base.set(e.base),i.closeDialog()}),i.showDialog(e,this.t("basePicker:title"))},showProgramPickerDialog:function(){var e=new T({model:this.model,vkb:this.vkbView});this.listenTo(e,"picked",function(e){this.model.program.set(e.program),i.closeDialog()}),i.showDialog(e,this.t("programPicker:title"))},$prop:function(e,t){var s=this.$('.trw-testing-prop[data-prop="'+e+'"]');return 2===arguments.length&&s.find(".trw-testing-prop-value").html(t),s},onTesterError:function(){this.model.base.clear(),this.model.tester.clear()},onTesterChange:function(){this.model.tester.id?r.setItem("TRW:TESTER",this.model.tester.id):r.removeItem("TRW:TESTER"),this.model.base.clear(),this.model.program.clear(),this.updateProgramName(),this.updateMessage(),this.startTest()},onBaseError:function(){this.model.base.clear()},onBaseChange:function(){this.model.base.id?r.setItem("TRW:BASE",this.model.base.id):r.removeItem("TRW:BASE"),this.model.program.id?this.model.program.clear():(this.updateProgramName(),this.updateProgramPreview()),this.updateMessage(),this.startTest()},onProgramError:function(){this.model.program.clear()},onProgramChange:function(){this.model.program.id?sessionStorage.setItem("TRW:PROGRAM",this.model.program.id):sessionStorage.removeItem("TRW:PROGRAM"),this.updateProgramName(),this.updateProgramPreview(),this.loadCounter(),this.startTest()},onOrderChange:function(){this.model.get("line")?(sessionStorage.setItem("TRW:ORDER",this.model.get("order")),sessionStorage.setItem("TRW:QTY_TODO",this.model.get("qtyTodo"))):(sessionStorage.removeItem("TRW:ORDER"),sessionStorage.removeItem("TRW:QTY_TODO")),this.model.program.clear(),this.loadCounter(),this.updateOrder(),this.startTest()},onLineChange:function(){this.model.get("line")?(r.setItem("TRW:LINE",this.model.get("line")),r.setItem("TRW:WORKSTATION",this.model.get("workstation"))):(r.removeItem("TRW:LINE"),r.removeItem("TRW:WORKSTATION")),this.updateWorkstation(),this.updateOrder(),this.startTest()},loadCounter:function(){var e=this;e.counterSub&&(e.counterSub.cancel(),e.counterSub=null),e.counterReq&&(e.counterReq.abort(),e.counterReq=null);var t=e.model.get("order"),s=e.model.program.id;if(e.model.set("qtyDone",0),"000000000"===t&&(t=""),t&&s){e.counterSub=e.pubsub.subscribe("trw.counters.updated."+t+"."+s,function(t){e.model.set("qtyDone",t.count)});var o=e.counterReq=e.ajax({url:"/trw/counters?limit(1)&populate(order,(qty))&order="+t+"&program="+s});e.counterReq.done(function(t){if(1===t.totalCount){var s=t.collection[0];e.model.set({qtyTodo:s.order?s.order.qty:0,qtyDone:s.count})}}),e.counterReq.always(function(){e.counterReq===o&&(e.counterReq=null)})}},scheduleAction:function(e,t){var s=this,o=s.model.get("test");s.timers.nextAction&&(clearTimeout(s.timers.nextAction),s.timers.nextAction=null),s.timers.nextAction=setTimeout(function(){s.model.get("test")===o&&e.call(s)},t||1)},startTest:function(){return this.model.get("ready")?(this.timers.nextAction&&(clearTimeout(this.timers.nextAction),this.timers.nextAction=null),this.model.get("line")?this.model.base.get("name")?this.model.get("order")?this.model.program.get("name")?void this.scheduleAction(this.runTest):this.model.set({state:"no-program"}):this.model.set({state:"no-order"}):this.model.set({state:"no-base"}):this.model.set({state:"no-line"})):this.model.set({state:"not-ready"})},runTest:function(){var e=this.model.program.toJSON();e.base=this.model.base.toJSON(),e.base.tester=this.model.tester.toJSON(),this.model.get("debug")&&console.log("runTest",{program:e});var t={};e.base.tester.io.forEach(function(e){t[e._id]=e});var s={},o={},i=[];if(e.base.clusters.forEach(function(e){e.rows.forEach(function(r,n){r.forEach(function(r,a){var l=[],d=[],h=e._id+":"+n+":"+a;r.io.forEach(function(e){var s=t[e];s?("output"===s.type?d.push(s):l.push(s),o[e]||(o[e]=[]),o[e].push(h)):i.push(e)}),s[h]={inputs:l,outputs:d}})})}),i.length)return this.error("missingIo",{io:i.join(", ")});this.model.test.clear(),this.model.test.set({startedAt:new Date,finishedAt:null,line:this.model.get("line"),workstation:this.model.get("workstation"),order:this.model.get("order"),pce:-1,program:e}),this.model.set({state:"test",pass:1,step:1,error:null,test:d(),endpointIo:s,cellIo:o,allIo:t,setIo:{},checkIo:{}}),this.updateMessage(),this.model.get("debug")&&console.log({endpointIo:s,allIo:t}),this.setIo(!0,this.runStep)},error:function(e,t){return this.model.set({state:"error",error:this.t("testing:error:"+e,t||{})}),this.scheduleAction(this.startTest,1e4)},runStep:function(){var e=this.model.test.get("program"),t=this.model.get("step"),s=e.steps[t-1],o=this.model.get("endpointIo"),i={},r={},n=[];if(this.model.get("debug")&&console.log("runStep",{stepNo:t,step:s}),s.source.cluster){var a=s.source.cluster+":"+s.source.row+":"+s.source.col,l=o[a];l?l.outputs.forEach(function(e){i[e._id]=e}):n.push(a)}if(s.target.cluster){var d=s.target.cluster+":"+s.target.row+":"+s.target.col,h=o[d];h?h.inputs.forEach(function(e){r[e._id]=e}):n.push(d)}if(n.length)return this.error("missingEndpoints",{endpoints:n.join(", ")});this.model.set({setIo:i,checkIo:r,lastValidCheckAt:0}),this.model.get("debug")&&console.log({setIo:i,checkIo:r}),"test"===this.model.get("state")&&this.updateConnections(),this.setIo(!1,this.checkIo,150)},setIo:function(t,s,o){var i=this,r=[],n=i.model.get("allIo"),a=i.model.get("setIo"),l=8e3,d=0;i.model.get("line").includes("LM-41")&&(l=0,d=8e3),e.forEach(n,function(e){"output"===e.type&&r.push({device:e.device,channel:e.channel,value:!t&&a[e._id]?l:d})}),i.model.get("debug")&&console.log("setIo",{outputs:r}),i.runCommand("setIo",{outputs:r},function(e){if(e)return i.error("setIo",{error:e.message});i.scheduleAction(s,o)})},checkIo:function(){var t=this,s=[],o=t.model.get("checkIo");e.forEach(o,function(e){"output"!==e.type&&s.push({device:e.device,channel:e.channel})}),t.model.get("debug")&&console.log("checkIo",{inputs:s}),t.runCommand("getIo",{inputs:s},function(s,i){if(s)return t.error("getIo",{error:s.message});var r=[],n=[],a="test"===t.model.get("state"),l=!1;if(e.forEach(o,function(e){var t=i[e.device][e.channel],s=e.min,o=e.max;0===s&&0===o&&(s=900,o=1024),t>=s&&t<=o?(a?r:n).push(e._id):(a?n:r).push(e._id),"analog"===e.type&&(l=!0)}),t.model.get("debug")&&console.log("getIo",{success:0===n.length,ok:r,nok:n,res:i}),n.length)return t.model.set("lastValidCheckAt",0),void t.scheduleAction(t.checkIo,150);var d=Date.now(),h=t.model.get("lastValidCheckAt"),u=d-h;h||t.model.set("lastValidCheckAt",d);var c=150*(l?6:3);if(t.model.get("pass")>1&&(c/=3),a&&(!h||u<c))t.scheduleAction(t.checkIo,150);else{var g=t.model.get("step");t.model.test.get("program").steps[g]?(t.model.set("step",g+1),t.scheduleAction(t.runStep)):t.scheduleAction(t.nextPass)}})},nextPass:function(){var e=this.model.get("pass");if(e>1)return this.tearDown();this.model.get("debug")&&console.log("nextPass",{currentPass:e}),this.model.set({pass:e+1,step:1,setIo:{},checkIo:{}}),this.setIo(!0,this.runStep)},tearDown:function(){return/^TEST/.test(this.model.get("line"))?(this.model.get("debug")&&console.log("tearDown skipped"),void this.setIo(!0,this.saveTest)):"test-teardown"===this.model.get("state")?(this.model.get("debug")&&console.log("tearDown completed"),void this.setIo(!0,this.saveTest)):(this.model.get("debug")&&console.log("tearDown started"),this.model.set({state:"test-teardown",step:1,setIo:{},checkIo:{}}),void this.setIo(!0,this.runStep,150))},saveTest:function(){this.model.get("debug")&&console.log("saveTest"),this.model.test.set({finishedAt:new Date}),this.model.set({state:"test-saving"}),this.scheduleAction(this.trySaveTest.bind(this,1))},trySaveTest:function(e){this.model.get("debug")&&console.log("trySaveTest",{tryNo:e});var t=this,s=t.ajax({method:"POST",url:"/trw/tests",data:JSON.stringify(t.model.test.toJSON())});s.fail(function(){if(3===e){var o=s.responseJSON&&s.responseJSON.error&&s.responseJSON.error.message||s.statusText;return t.model.set({state:"error",error:t.t("testing:error:save",{error:o})})}t.scheduleAction(t.trySaveTest.bind(t,e+1),1e3*e)}),s.done(function(){t.scheduleAction(t.finishTest)})},finishTest:function(){this.model.get("debug")&&console.log("finishTest"),this.model.test.clear(),this.model.set({state:"test-success"}),/^TEST/.test(this.model.get("line"))||this.scheduleAction(this.startTest,5e3)},runCommand:function(e,t,s){var o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)},i="development"===window.ENV?"https://dev.wmes.pl":"http://localhost";fetch(i+"/trw/"+e,o).then(function(e){if(e.ok)return e.json();throw new Error("status code: "+e.status)}).then(function(e){if(e.error)throw e.error;s(null,e)}).catch(s)},updateConnections:function(){if(this.jsPlumb){this.jsPlumb.deleteEveryConnection();for(var e=this.model.program.get("steps"),t=this.model.get("step"),s=0;s<t;++s){var o=e[s];if(o.source.cluster&&o.target.cluster){var i=s<t-1,r=["trw-base-canvas-connector"];i&&r.push("trw-base-canvas-faded");var n=this.jsPlumb.connect({uuids:[p.formatEndpointUuid(o.source),p.formatEndpointUuid(o.target)],parameters:{step:o._id},detachable:!1,cssClass:r.join(" ")});if(!n)return;var a=n.getOverlay("LABEL");a.setLabel((s+1).toString()),a.setVisible(!0),i&&a.addClass("trw-base-canvas-faded")}}}},ioSet:function(e,t,s,o){this.runCommand("setIo",{outputs:[{device:e,channel:t,value:s}]},function(i){if(o&&o(i),i)return console.warn("Failed to set IO: %s",i.message);console.info("IO %s:%s set to: %s",e,t,s)})},toggleDebugMode:function(){this.debug.lastValues={},this.debug.highlightedRows={},this.debug.highlightedCells={},this.model.set("debug",!this.model.get("debug")),this.$el.toggleClass("trw-testing-debugging",this.model.get("debug"))},updateDebugInfo:function(){var t=this;if(clearTimeout(t.timers.updateDebugInfo),t.model.get("debug")){var s=[],o={},i=t.model.get("cellIo")||{};e.forEach(t.model.get("allIo"),function(e){o[e.device+":"+e.channel]=e,s.push({device:e.device,channel:e.channel})}),t.runCommand("getIo",{inputs:s},function(s,r){if(t.model.get("debug")){var n=t.$id("debug");if(s)n.html("???");else if(!e.isEqual(r,t.debug.lastValues)){t.debug.lastValues=r;var a=[],l={};e.forEach(r,function(s,r){e.forEach(s,function(s,n){var d=o[r+":"+n];(i[d._id]||[]).forEach(function(e){var t=l[e];t&&t.value>0&&"output"!==t.io.type||(t&&"output"!==t.io.type&&"output"===d.type||(l[e]={value:s,io:d},document.getElementById("TRW:"+e).querySelector(".trw-base-cell-subLabel").textContent=s.toString()))}),a.push(e.assign({value:s,highlighted:t.debug.highlightedRows[d._id]},d))})}),n.html(t.renderPartialHtml(k,{rows:a}))}n.removeClass("hidden"),t.timers.updateDebugInfo=setTimeout(t.updateDebugInfo.bind(t),1e3)}})}else t.$id("debug").addClass("hidden")}})});