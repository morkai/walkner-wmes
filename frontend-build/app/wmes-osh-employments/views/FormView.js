define(["jquery","app/time","app/viewport","app/core/views/FormView","app/wmes-osh-common/dictionaries","app/wmes-osh-employments/templates/form","jquery.stickytableheaders"],function(e,t,i,n,a,s){"use strict";return n.extend({template:s,events:Object.assign({"change #-month":"loadExisting","change #-blur":"loadExistingNow","change #-enableRecount":function(e){this.$id("doRecount").prop("disabled",!e.target.checked)},"click #-doRecount":"recount",'change input[type="number"]':function(e){const t=this.$(e.target).closest("tr"),i=t[0].dataset.division,n=t[0].dataset.workplace;clearTimeout(this.timers[`recount${n}`]),this.timers[`recount${n}`]=setTimeout(()=>{this.recountWorkplace(n),this.recountDivision(i)},333)}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),this.setUpStickyTable()},getTemplateData:function(){const e=new Map,t=new Map,i=new Set;return(this.model.get("departments")||[]).forEach(n=>{if(e.has(n.division)||e.set(n.division,{key:`d${n.division}w0d0`,_id:n.division,label:a.getLabel("divisions",n.division),workplaces:[]}),!n.workplace)return;const s=e.get(n.division);if(!t.has(n.workplace)){const e={key:`d${n.division}w${n.workplace}d0`,_id:n.workplace,label:a.getLabel("workplaces",n.workplace),departments:[]};t.set(n.workplace,e),s.workplaces.push(e)}n.department&&(t.get(n.workplace).departments.push({key:`d${n.division}w${n.workplace}d${n.department}`,_id:n.department,label:a.getLabel("departments",n.department),internal:n.internal,external:n.external,absent:n.absent,total:n.total,observers:n.observers}),i.add(n.department))}),a.departments.forEach(n=>{if(i.has(n.id))return;const s=n.get("workplace");let o=0;if(!t.has(s)){const i=a.workplaces.get(s);if(!i)return;if(o=i.get("division"),!a.divisions.get(o))return;const n={key:`d${o}w${s}d0`,_id:s,label:a.getLabel("workplaces",s),departments:[]};t.set(s,n),e.has(o)||e.set(o,{key:`d${o}w0d0`,_id:o,label:a.getLabel("divisions",o),workplaces:[]}),e.get(o).workplaces.push(n)}t.get(s).departments.push({key:`d${o}w${s}d${n.id}`,_id:n.id,label:n.getLabel(),internal:0,external:0,absent:0,total:0,observers:0})}),this.departments={},e.forEach(e=>{e.workplaces.sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0})),this.departments[e.key]={division:e._id,workplace:0,department:0,internal:0,external:0,absent:0,total:0,observers:0},e.workplaces.forEach(t=>{t.departments.sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0})),this.departments[t.key]={division:e._id,workplace:t._id,department:0,internal:0,external:0,absent:0,total:0,observers:0},t.departments.forEach(i=>{this.departments[i.key]={division:e._id,workplace:t._id,department:i._id,internal:i.internal,external:i.external,absent:i.absent,total:i.total,observers:i.observers}})})}),{divisions:Array.from(e.values()).sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}))}},serializeToForm:function(){return{month:this.options.editMode?t.utc.format(this.model.id,"YYYY-MM"):this.month||"",departments:this.departments}},checkValidity:()=>!0,serializeForm:function(e){return this.options.editMode||(e._id=e.month+"-01T00:00:00Z"),delete e.month,e.departments=Object.values(e.departments||{}),e.departments.forEach(e=>{e.division=+e.division,e.workplace=+e.workplace,e.department=+e.department,e.internal=parseInt(e.internal,10)||0,e.external=parseInt(e.external,10)||0,e.absent=parseInt(e.absent,10)||0,e.total=e.internal+e.external-e.absent,e.observers=parseInt(e.observers,10)||0}),e},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.recountWorkplaces(),this.recountDivisions()},setUpStickyTable:function(){this.on("afterRender",()=>{this.$(".table").stickyTableHeaders({fixedOffset:e(".navbar-fixed-top"),scrollableAreaX:this.$el})}),this.on("beforeRender remove",()=>{this.$(".table").stickyTableHeaders("destroy")})},loadExisting:function(){clearTimeout(this.timers.loadExisting),this.timers.loadExisting=setTimeout(this.loadExistingNow.bind(this),333)},loadExistingNow:function(){clearTimeout(this.timers.loadExisting);const e=this.$id("month").val();if(!e)return;const n=t.utc.getMoment(`${e}-01`,"YYYY-MM-DD");if(!n.isValid())return;i.msg.loading();const a=this.ajax({url:`/osh/employments?_id<=${n.valueOf()}&sort(-_id)&limit(1)`});a.fail(()=>{i.msg.loadingFailed()}),a.done(e=>{i.msg.loaded();const t=e.collection&&e.collection[0]||{};t._id!==n.toISOString()&&(t._id=void 0),this.month=n.format("YYYY-MM"),this.model.set(t,{silent:!0}),this.render()})},recount:function(){i.msg.loading(),this.$id("enableRecount").prop("disabled",!0),this.$id("doRecount").prop("disabled",!0);const e=this.ajax({url:"/osh/employments;recount"});e.fail(()=>{i.msg.loadingFailed()}),e.done(e=>{i.msg.loaded(),this.$(".js-department").each((t,i)=>{const n=e[i.dataset.department]||{internal:0,external:0,observers:0};i.querySelector('input[name$="internal"]').value=n.internal,i.querySelector('input[name$="external"]').value=n.external,i.querySelector('input[name$="observers"]').value=n.observers}),this.recountWorkplaces(),this.recountDivisions()}),e.always(()=>{this.$id("enableRecount").prop("disabled",!1),this.$id("doRecount").prop("disabled",!1)})},recountDivisions:function(){this.$(".js-division").each((e,t)=>{this.recountDivision(t.dataset.division)})},recountWorkplaces:function(){this.$(".js-workplace").each((e,t)=>{this.recountWorkplace(t.dataset.workplace)})},recountDivision:function(e){const t=this.$(`.js-division[data-division="${e}"]`),i={internal:0,external:0,absent:0,observers:0},n=Object.keys(i);this.$(`.js-workplace[data-division="${e}"]`).each((e,t)=>{n.forEach(e=>{i[e]+=parseInt(t.querySelector(`input[name$="${e}"]`).value,10)||0})}),n.forEach(e=>{t.find(`input[name$="${e}"]`).val(i[e])})},recountWorkplace:function(e){const t=this.$(`.js-workplace[data-workplace="${e}"]`),i={internal:0,external:0,absent:0,observers:0},n=Object.keys(i);this.$(`.js-department[data-workplace="${e}"]`).each((e,t)=>{n.forEach(e=>{i[e]+=parseInt(t.querySelector(`input[name$="${e}"]`).value,10)||0})}),n.forEach(e=>{t.find(`input[name$="${e}"]`).val(i[e])})}})});