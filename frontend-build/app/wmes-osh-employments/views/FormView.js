define(["app/time","app/viewport","app/core/views/FormView","app/wmes-osh-common/dictionaries","app/wmes-osh-employments/templates/form"],function(e,t,i,o,n){"use strict";return i.extend({template:n,events:Object.assign({"change #-month":"loadExisting","change #-blur":"loadExistingNow"},i.prototype.events),getTemplateData:function(){const e=new Map,t=new Set;return(this.model.get("departments")||[]).forEach(i=>{e.has(i.workplace)||e.set(i.workplace,{_id:i.workplace,label:o.getLabel("workplaces",i.workplace),division:o.workplaces.get(i.workplace).get("division"),departments:[]}),e.get(i.workplace).departments.push({_id:i.department,label:o.getLabel("departments",i.department),count:i.count}),t.add(i.department)}),o.departments.forEach(i=>{if(t.has(i.id))return;const n=i.get("workplace");e.has(n)||e.set(n,{_id:n,label:o.getLabel("workplaces",n),division:o.workplaces.get(n).get("division"),departments:[]}),e.get(n).departments.push({_id:i.id,label:i.getLabel(),count:0})}),this.departments={},e.forEach(e=>{e.departments.sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0})),e.departments.forEach(t=>{this.departments[`d${t._id}`]={division:e.division,workplace:e._id,department:t._id,count:t.count}})}),{workplaces:Array.from(e.values()).sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}))}},serializeToForm:function(){return{month:this.options.editMode?e.utc.format(this.model.id,"YYYY-MM"):this.month||"",departments:this.departments}},checkValidity:()=>!0,serializeForm:function(e){return this.options.editMode||(e._id=e.month+"-01T00:00:00Z"),delete e.month,e.departments=Object.values(e.departments||{}),e.departments.forEach(e=>{e.division=+e.division,e.workplace=+e.workplace,e.department=+e.department,e.count=parseInt(e.count,10)||0}),e},loadExisting:function(){clearTimeout(this.timers.loadExisting),this.timers.loadExisting=setTimeout(this.loadExistingNow.bind(this),333)},loadExistingNow:function(){clearTimeout(this.timers.loadExisting);const i=this.$id("month").val();if(!i)return;const o=e.utc.getMoment(`${i}-01`,"YYYY-MM-DD");if(!o.isValid())return;t.msg.loading();const n=this.ajax({url:`/osh/employments?_id<=${o.valueOf()}&sort(-_id)&limit(1)`});n.fail(()=>{t.msg.loadingFailed()}),n.done(e=>{t.msg.loaded();const i=e.collection&&e.collection[0]||{};i._id!==o.toISOString()&&(i._id=void 0),this.month=o.format("YYYY-MM"),this.model.set(i,{silent:!0}),this.render()})}})});