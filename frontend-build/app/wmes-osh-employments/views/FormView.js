define(["app/time","app/viewport","app/core/views/FormView","app/wmes-osh-common/dictionaries","app/wmes-osh-employments/templates/form"],function(i,e,o,t,s){"use strict";return o.extend({template:s,events:Object.assign({"change #-month":"loadExisting"},o.prototype.events),getTemplateData:function(){const i=new Map,e=new Set;let o=0;return(this.model.get("divisions")||[]).forEach(s=>{i.has(s.workplace)||i.set(s.workplace,{_id:s.workplace,label:t.getLabel("workplaces",s.workplace),divisions:[]}),i.get(s.workplace).divisions.push({i:o++,_id:s.division,label:t.getLabel("divisions",s.division),count:s.count}),e.add(s.division)}),t.divisions.forEach(s=>{if(e.has(s.id))return;const n=s.get("workplace");i.has(n)||i.set(n,{_id:n,label:t.getLabel("workplaces",n),divisions:[]}),i.get(n).divisions.push({i:o++,_id:s.id,label:s.getLabel(),count:0})}),this.divisions=[],i.forEach(i=>{i.divisions.sort((i,e)=>i.label.localeCompare(e.label,void 0,{numeric:!0,ignorePunctuation:!0})),i.divisions.forEach(e=>{this.divisions.push({workplace:i._id,division:e._id,count:e.count})})}),{workplaces:Array.from(i.values()).sort((i,e)=>i.label.localeCompare(e.label,void 0,{numeric:!0,ignorePunctuation:!0}))}},serializeToForm:function(){return{month:this.options.editMode?i.utc.format(this.id,"YYYY-MM"):this.month||"",divisions:this.divisions}},serializeForm:function(i){return this.options.editMode||(i._id=i.month+"-01T00:00:00Z"),delete i.month,i},loadExisting:function(){const o=this.$id("month").val();if(!o)return;const t=i.utc.getMoment(`${o}-01`,"YYYY-MM-DD");if(!t.isValid())return;e.msg.loading();const s=this.ajax({url:`/osh/employments?_id<=${t.valueOf()}&sort(-_id)&limit(1)`});s.fail(()=>{e.msg.loadingFailed()}),s.done(i=>{e.msg.loaded();const o=i.collection&&i.collection[0]||{};o._id!==t.toISOString()&&(o._id=void 0),this.month=t.format("YYYY-MM"),this.model.set(o,{silent:!0}),this.render()})}})});