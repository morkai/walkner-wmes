define(["app/time","app/viewport","app/core/views/FormView","app/wmes-osh-common/dictionaries","app/wmes-osh-employments/templates/form"],function(e,t,o,a,n){"use strict";return o.extend({template:n,events:Object.assign({"change #-month":"loadExisting"},o.prototype.events),getTemplateData:function(){const e=new Map,t=new Set;let o=0;return(this.model.get("departments")||[]).forEach(n=>{e.has(n.workplace)||e.set(n.workplace,{_id:n.workplace,label:a.getLabel("workplaces",n.workplace),departments:[]}),e.get(n.workplace).departments.push({i:o++,_id:n.department,label:a.getLabel("departments",n.department),count:n.count}),t.add(n.department)}),a.departments.forEach(n=>{if(t.has(n.id))return;const i=n.get("workplace");e.has(i)||e.set(i,{_id:i,label:a.getLabel("workplaces",i),departments:[]}),e.get(i).departments.push({i:o++,_id:n.id,label:n.getLabel(),count:0})}),this.departments=[],e.forEach(e=>{e.departments.sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0})),e.departments.forEach(t=>{this.departments.push({workplace:e._id,department:t._id,count:t.count})})}),{workplaces:Array.from(e.values()).sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}))}},serializeToForm:function(){return{month:this.options.editMode?e.utc.format(this.id,"YYYY-MM"):this.month||"",departments:this.departments}},serializeForm:function(e){return this.options.editMode||(e._id=e.month+"-01T00:00:00Z"),delete e.month,e},loadExisting:function(){const o=this.$id("month").val();if(!o)return;const a=e.utc.getMoment(`${o}-01`,"YYYY-MM-DD");if(!a.isValid())return;t.msg.loading();const n=this.ajax({url:`/osh/employments?_id<=${a.valueOf()}&sort(-_id)&limit(1)`});n.fail(()=>{t.msg.loadingFailed()}),n.done(e=>{t.msg.loaded();const o=e.collection&&e.collection[0]||{};o._id!==a.toISOString()&&(o._id=void 0),this.month=a.format("YYYY-MM"),this.model.set(o,{silent:!0}),this.render()})}})});