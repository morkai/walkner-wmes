define(["app/time","app/viewport","app/core/views/FormView","app/wmes-osh-common/dictionaries","app/wmes-osh-employments/templates/form"],function(e,t,o,i,n){"use strict";return o.extend({template:n,events:Object.assign({"change #-month":"loadExisting"},o.prototype.events),getTemplateData:function(){const e=new Map,t=new Set;return(this.model.get("departments")||[]).forEach(o=>{e.has(o.workplace)||e.set(o.workplace,{_id:o.workplace,label:i.getLabel("workplaces",o.workplace),division:i.workplaces.get(o.workplace).get("division"),departments:[]}),e.get(o.workplace).departments.push({_id:o.department,label:i.getLabel("departments",o.department),count:o.count}),t.add(o.department)}),i.departments.forEach(o=>{if(t.has(o.id))return;const n=o.get("workplace");e.has(n)||e.set(n,{_id:n,label:i.getLabel("workplaces",n),division:i.workplaces.get(n).get("division"),departments:[]}),e.get(n).departments.push({_id:o.id,label:o.getLabel(),count:0})}),this.departments={},e.forEach(e=>{e.departments.sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0})),e.departments.forEach(t=>{this.departments[`d${t._id}`]={division:e.division,workplace:e._id,department:t._id,count:t.count}})}),{workplaces:Array.from(e.values()).sort((e,t)=>e.label.localeCompare(t.label,void 0,{numeric:!0,ignorePunctuation:!0}))}},serializeToForm:function(){return{month:this.options.editMode?e.utc.format(this.id,"YYYY-MM"):this.month||"",departments:this.departments}},checkValidity:()=>!0,serializeForm:function(e){return this.options.editMode||(e._id=e.month+"-01T00:00:00Z"),delete e.month,e.departments=Object.values(e.departments||{}),e.departments.forEach(e=>{e.division=+e.division,e.workplace=+e.workplace,e.department=+e.department,e.count=parseInt(e.count,10)||0}),e},loadExisting:function(){const o=this.$id("month").val();if(!o)return;const i=e.utc.getMoment(`${o}-01`,"YYYY-MM-DD");if(!i.isValid())return;t.msg.loading();const n=this.ajax({url:`/osh/employments?_id<=${i.valueOf()}&sort(-_id)&limit(1)`});n.fail(()=>{t.msg.loadingFailed()}),n.done(e=>{t.msg.loaded();const o=e.collection&&e.collection[0]||{};o._id!==i.toISOString()&&(o._id=void 0),this.month=i.format("YYYY-MM"),this.model.set(o,{silent:!0}),this.render()})}})});