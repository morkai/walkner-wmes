define(["underscore","jquery","app/viewport","app/wmes-osh-common/dictionaries","app/wmes-osh-common/pages/DetailsPage","app/wmes-osh-common/views/AttachmentsView","app/wmes-osh-common/views/PanelView","../Kaizen","../views/VerificationFormView","app/wmes-osh-kaizens/templates/details/page","app/wmes-osh-kaizens/templates/details/props"],function(e,t,i,s,n,o,a,r,l,d,p){"use strict";return n.extend({template:d,propsTemplate:p,actions:function(){const e=n.prototype.actions.apply(this,arguments);return e.unshift(this.createNextStepAction()),e},initialize:function(){n.prototype.initialize.apply(this,arguments),this.once("afterRender",()=>{const i=e.debounce(this.resizePanels.bind(this),33);t(window).on(`resize.${this.idPrefix}`,i)})},defineViews:function(){n.prototype.defineViews.apply(this,arguments),this.setView("#-problem",new a({model:this.model,property:"problem",panelType:"danger"})),this.setView("#-reason",new a({model:this.model,property:"reason",panelType:"warning"})),this.setView("#-before",new o({model:this.model,kind:"before"})),this.setView("#-suggestion",new a({model:this.model,property:"suggestion",panelType:"secondary"})),this.setView("#-solution",new a({model:this.model,property:"solution",panelType:"success"})),this.setView("#-after",new o({model:this.model,kind:"after"}))},getAttachmentsViewOptions:function(){return Object.assign(n.prototype.getAttachmentsViewOptions.apply(this,arguments),{kind:"other"})},afterRender:function(){this.resizePanels()},resizePanels:function(){const e=this.$id("problem").find(".panel-body"),t=this.$id("reason").find(".panel-body"),i=this.$id("suggestion").find(".panel-body"),s=this.$id("solution").find(".panel-body");[e,t,i,s].forEach(e=>{e.css("height","")}),window.innerWidth<1200||[[e,i],[t,s]].forEach(e=>{const t=Math.max.apply(Math,e.map(e=>e.outerHeight()));e.forEach(e=>e.css("height",`${t}px`))})},createNextStepAction:function(){const e=this.model.get("status");return"new"===e&&r.can.inProgress(this.model)?{icon:"check",type:"info",label:this.t("nextStep:inProgress:action"),callback:this.handleInProgressAction.bind(this)}:"inProgress"===e&&r.can.verification(this.model)?{icon:"gavel",type:"secondary",label:this.t("nextStep:verification:action"),callback:this.handleVerificationAction.bind(this)}:"verification"===e&&r.can.finished(this.model)?{icon:"thumbs-up",type:"success",label:this.t("nextStep:finished:action"),callback:this.handleFinishedAction.bind(this)}:null},handleInProgressAction:function(e){const s=t(e.target).closest(".btn").prop("disabled",!0);i.msg.saving();const n=this.ajax({method:"PATCH",url:this.model.url(),data:JSON.stringify({status:"inProgress"})});n.fail(()=>i.msg.savingFailed()),n.done(()=>i.msg.saved()),n.always(()=>s.prop("disabled",!1))},handleVerificationAction:function(){document.activeElement&&document.activeElement.blur();const e=new l({model:new r(JSON.parse(JSON.stringify(this.model.attributes)))});i.showDialog(e,this.t("nextStep:verification:title"))},handleFinishedAction:function(e){const n=t(e.target).closest(".btn").prop("disabled",!0);i.msg.saving();const o=this.ajax({method:"PATCH",url:this.model.url(),data:JSON.stringify({status:"finished",reward:s.settings.getValue("rewards.kaizens.default",0)})});o.fail(()=>i.msg.savingFailed()),o.done(()=>i.msg.saved()),o.always(()=>n.prop("disabled",!1))}})});