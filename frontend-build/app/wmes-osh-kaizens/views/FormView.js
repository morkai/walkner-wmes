define(["underscore","app/user","app/time","app/viewport","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/util/userInfoDecorator","app/wmes-osh-common/views/FormView","../Kaizen","app/wmes-osh-kaizens/templates/form"],function(e,t,i,s,a,o,l,n,d,c,r){"use strict";return d.extend({template:r,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDepartment").val(""),this.setUpUserDepartmentSelect2()},"change #-workplace":function(){this.$id("department").val(""),this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-department":function(){this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-building":function(){this.$id("location").val(""),this.$id("station").val(""),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()},'change input[name="kind"]':function(){this.$id("kaizenCategory").val(""),this.setUpKaizenCategorySelect2()},'change input[type="file"][data-max]':function(e){const t=e.currentTarget,i=+t.dataset.max;t.setCustomValidity(t.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const e=this.$id("comment");if("verification"===this.model.get("status")&&!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-verification":function(){this.newStatus="verification";const e=this.$id("solution");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-finished":function(){this.newStatus="finished";const e=this.$id("solution");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-paused":function(){this.newStatus="paused";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)}},d.prototype.events),getTemplateData:function(){return{today:i.getMoment().format("YYYY-MM-DD"),kinds:l.kinds.serialize("kaizen",this.model.get("kind")),can:{inProgress:c.can.inProgress(this.model),verification:c.can.verification(this.model),finished:c.can.finished(this.model),paused:c.can.paused(this.model),cancelled:c.can.cancelled(this.model)},relation:this.options.relation}},serializeToForm:function(){const e=this.model.toJSON();return e.plannedAt&&(e.plannedAt=i.utc.format(e.plannedAt,"YYYY-MM-DD")),delete e.coordinators,delete e.attachments,delete e.users,delete e.changes,e},serializeForm:function(e){this.newStatus&&(e.status=this.newStatus);const t=this.$id("userWorkplace").select2("data");e.userDivision=t.model.get("division"),e.userWorkplace=t.id,e.userDepartment=this.$id("userDepartment").select2("data").id,e.implementers=o.getUserInfo(this.$id("implementers"));const s=this.options.relation;if(s)e.relation={_id:s.id,rid:s.get("rid"),type:s.getModelType()};else{const t=this.$id("workplace").select2("data");e.division=t.model.get("division"),e.workplace=t.id,e.department=this.$id("department").select2("data").id,e.building=this.$id("building").select2("data").id,e.location=this.$id("location").select2("data").id,e.station=parseInt(this.$id("station").val(),10)||0}e.kaizenCategory=this.$id("kaizenCategory").select2("data").id;const a=this.$id("plannedAt");return a.length&&!a.prop("disabled")?e.plannedAt=e.plannedAt?i.utc.getMoment(e.plannedAt,"YYYY-MM-DD").toISOString():null:delete e.plannedAt,e.kind&&(e.kind=parseInt(e.kind,10)),e},afterRender:function(){d.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpKaizenCategorySelect2(),this.setUpImplementersSelect2(),this.toggleKind()},setUpUserWorkplaceSelect2:function(){const e=this.$id("userWorkplace");if(this.options.editMode){const t=this.model.get("creator").oshWorkplace,i=l.workplaces.get(t);return e.val(t).select2({width:"100%",placeholder:" ",data:i?[{id:t,text:i?i.getLabel({long:!0}):`?${t}?`,model:i}]:[]}),void e.select2("enable",!1)}e.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let i=l.workplaces.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s={};l.workplaces.forEach(e=>{e.get("active")&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!s[i.id]&&(s[i.id]=i),e.select2({width:"100%",data:Object.values(s).sort((e,t)=>e.text.localeCompare(t.text))});const a=l.workplaces.get(t.data.oshWorkplace);this.options.editMode&&i?e.select2("enable",!1).select2("data",i):a?e.select2("enable",!1).select2("data",{id:a.id,text:a.getLabel({long:!0}),model:a}):e.select2("enable",!0)},setUpUserDepartmentSelect2:function(){const e=this.$id("userDepartment");if(this.options.editMode){const t=this.model.get("creator").oshDepartment,i=l.departments.get(t);return e.val(t).select2({width:"100%",placeholder:" ",data:i?[{id:t,text:i?i.getLabel({long:!0}):`?${t}?`,model:i}]:[]}),void e.select2("enable",!1)}const i=+this.$id("userWorkplace").val();let s=l.departments.get(+e.val());s&&(s={id:s.id,text:s.getLabel({long:!0}),model:s});const a={};l.departments.forEach(e=>{e.get("active")&&e.get("workplace")===i&&(a[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),s&&!a[s.id]&&s.model.get("workplace")===i&&(a[s.id]=s);const o=Object.values(a).sort((e,t)=>e.text.localeCompare(t.text));let n=" ",d=!0;i||0!==o.length||(n=this.t("FORM:placeholder:noUserWorkplace"),d=!1),e.select2({width:"100%",placeholder:n,data:o});const c=l.departments.get(t.data.oshDepartment);this.options.editMode&&s?e.select2("enable",!1).select2("data",s):c?e.select2("enable",!1).select2("data",{id:c.id,text:c.getLabel({long:!0}),model:c}):(e.select2("enable",d),1===o.length?e.select2("data",o[0]):a[e.val()]||e.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");e.val()||!t.data.oshWorkplace||this.options.editMode||e.val(t.data.oshWorkplace);let i=l.workplaces.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s={};l.workplaces.forEach(e=>{e.get("active")&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!s[i.id]&&(s[i.id]=i),e.select2({width:"100%",data:Object.values(s).sort((e,t)=>e.text.localeCompare(t.text))}),e.select2("enable",!this.options.editMode||c.can.manage()||this.model.isCoordinator())},setUpDepartmentSelect2:function(){const e=this.$id("department");e.val()||!t.data.oshDepartment||this.options.editMode||e.val(t.data.oshDepartment);let i=l.departments.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s=+this.$id("workplace").val(),a={};l.departments.forEach(e=>{e.get("active")&&e.hasWorkplace(s)&&(a[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!a[i.id]&&(a[i.id]=i);const o=Object.values(a).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:s?" ":this.t("FORM:placeholder:noWorkplace"),data:o}),1===o.length?e.select2("data",o[0]):a[e.val()]||e.val("").select2("data",null),e.select2("enable",!!s&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(){const e=this.$id("building"),t=+this.$id("department").val(),i={};l.buildings.forEach(e=>{e.get("active")&&e.hasDepartment(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const s=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noDepartment"),data:s}),1===s.length&&e.select2("data",s[0]),e.select2("enable",!!t&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const e=this.$id("location"),t=+this.$id("building").val(),i={};l.locations.forEach(e=>{e.get("active")&&e.hasBuilding(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const s=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noBuilding"),data:s}),1===s.length&&e.select2("data",s[0]),e.select2("enable",!!t&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const e=this.$id("station"),t=+this.$id("location").val(),i={};l.stations.forEach(e=>{e.get("active")&&e.hasLocation(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const s=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noLocation"),allowClear:!0,data:s}),this.options.editMode||1!==s.length||e.select2("data",s[0]),e.select2("enable",s.length>0&&!!t&&(!this.options.editMode||c.can.manage()||this.model.isCoordinator()))},setUpKaizenCategorySelect2:function(){const e=this.$id("kaizenCategory"),t=+this.$('input[name="kind"]:checked').val()||this.model.get("kind"),i={};l.kaizenCategories.forEach(e=>{e.get("active")&&e.hasKind(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const s=this.model.get("kaizenCategory"),o=l.kaizenCategories.get(s);s&&!i[s]&&(o?o.hasKind(t)&&(i[s]={id:s,text:o.getLabel({long:!0}),description:o.get("description"),model:o}):i[s]={id:s,text:`?${s}?`});const n=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",allowClear:!1,placeholder:" ",data:n,dropdownCssClass:"select2-with-description",formatResult:a.bind(null,"text","description")}),1===n.length&&e.val(n[0].id).select2("data",n[0])},setUpImplementersSelect2:function(){const e=this.model.isCoordinator()||c.can.manage(),i=this.$id("implementers");o(i,{width:"100%",multiple:!0,maximumSelectionSize:2,noPersonnelId:!0,userInfoDecorators:[n]});const s=[];if(this.options.editMode)(this.model.get("implementers")||[]).forEach(e=>{s.push({id:e.id,text:e.label,user:e})});else{const i=this.model.get("creator")||n(t.getInfo(),t.data),a=(this.model.get("implementers")||[]).find(e=>e.id!==i.id);s.push({id:i.id,text:i.label,locked:!e,user:i}),a&&s.push({id:a.id,text:a.label,user:a})}i.select2("data",s).select2("enable",!this.options.editMode||e);const a=this.$id("plannedAt");a.length&&a.prop("disabled",!!a.val()&&!e)},toggleKind:function(){const e=this.$('input[name="kind"]');e.length&&!e.filter(":checked").length&&e.first().click(),e.prop("disabled",!c.can.editKind(this.model,this.options.editMode))},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var e=d.prototype.request.apply(this,arguments);return e.always(function(){s.msg.saved()}),e},submitRequest:function(e,t){const i=this,a=new FormData;let o=0;if(i.$('input[type="file"]').each(function(){const e=this.name.replace("attachments.","");for(let t=0;t<this.files.length;++t)a.append(e,this.files[t]),o+=1}),0===o)return d.prototype.submitRequest.call(i,e,t);s.msg.saving();const l=i.ajax({type:"POST",url:"/osh/attachments",data:a,processData:!1,contentType:!1});l.done(a=>{t.attachments={added:a},d.prototype.submitRequest.call(i,e,t),s.msg.saved()}),l.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),e.attr("disabled",!1)})},onDialogShown:function(){this.$id("subject").focus()}})});