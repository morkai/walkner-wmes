define(["underscore","app/user","app/time","app/viewport","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/util/userInfoDecorator","app/wmes-osh-common/views/FormView","../Kaizen","app/wmes-osh-kaizens/templates/form"],function(e,t,i,s,n,a,o,r,l,d,c){"use strict";return l.extend({template:c,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-userWorkplace":function(){this.$id("userDepartment").val(""),this.setUpUserDepartmentSelect2()},'change input[name="kind[]"]':function(){const e=this.$id("kaizenCategory").val()||null;this.$id("kaizenCategory").val(""),this.setUpKaizenCategorySelect2(e),this.$('input[name="kind[]"]').first()[0].required=!this.$('input[name="kind[]"]:checked').length},'change input[type="file"][data-max]':function(e){const t=e.currentTarget,i=+t.dataset.max;t.setCustomValidity(t.files.length>i?this.t("wmes-osh-common","FORM:ERROR:tooManyFiles",{max:i}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const e=this.$id("comment");if("verification"===this.model.get("status")&&!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-verification":function(){this.newStatus="verification";const e=this.$id("solution");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-finished":function(){this.newStatus="finished";const e=this.$id("solution");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-paused":function(){this.newStatus="paused";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},'change input[name="kom"]':function(e){e.target.checked&&this.$(`input[name="kom"][value="${"1"===e.target.value?2:1}"]`).prop("checked",!1),this.updateRewardPlaceholder(),this.$id("reward").val("").focus()}},l.prototype.events),getKinds:function(){const e=this.$('input[name="kind[]"]');return e.length?e.filter(":checked").get().map(e=>+e.value):this.model.get("kind")||[]},getTemplateData:function(){return{today:i.getMoment().format("YYYY-MM-DD"),kinds:o.kinds.serialize("kaizen",this.model.get("kind")),can:{inProgress:d.can.inProgress(this.model),verification:d.can.verification(this.model),finished:d.can.finished(this.model),paused:d.can.paused(this.model),cancelled:d.can.cancelled(this.model)},relation:this.options.relation,komIcons:d.KOM_ICONS}},serializeToForm:function(){const e=this.model.toJSON();return e.plannedAt&&(e.plannedAt=i.utc.format(e.plannedAt,"YYYY-MM-DD")),e.reward||(e.reward=""),delete e.coordinators,delete e.attachments,delete e.users,delete e.changes,e},serializeForm:function(e){this.newStatus&&(e.status=this.newStatus);const t=this.$id("userWorkplace").select2("data");e.userDivision=t.model.get("division"),e.userWorkplace=t.id,e.userDepartment=this.$id("userDepartment").select2("data").id,e.implementers=a.getUserInfo(this.$id("implementers"));const s=this.options.relation;if(s)e.relation={_id:s.id,rid:s.get("rid"),type:s.getModelType()};else{const t=this.$id("workplace").select2("data");e.division=t.model.get("division"),e.workplace=t.id,e.department=this.$id("department").select2("data").id,e.building=parseInt(this.$id("building").val(),10)||0,e.location=parseInt(this.$id("location").val(),10)||0,e.station=parseInt(this.$id("station").val(),10)||0}e.kaizenCategory=this.$id("kaizenCategory").select2("data").id;const n=this.$id("plannedAt");return n.length&&!n.prop("disabled")?e.plannedAt=e.plannedAt?i.utc.getMoment(e.plannedAt,"YYYY-MM-DD").toISOString():null:delete e.plannedAt,Array.isArray(e.kind)&&(e.kind=e.kind.map(e=>+e)),this.$('input[name="kom"]').length?(e.kom=parseInt(e.kom,10)||0,e.reward>=0?e.reward=Math.round(100*parseFloat(e.reward))/100:e.reward=this.getDefaultRewardAmount()):(e.kom=0,e.reward=0),e},afterRender:function(){l.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.setUpDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(!1),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpKaizenCategorySelect2(),this.setUpImplementersSelect2(),this.toggleKind(),this.updateRewardPlaceholder()},setUpKaizenCategorySelect2:function(e){const t=this.$id("kaizenCategory"),i=this.getKinds(),s={};o.kaizenCategories.forEach(e=>{e.get("active")&&e.hasKind(i)&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const a=this.model.get("kaizenCategory"),r=o.kaizenCategories.get(a);a&&!s[a]&&(r?r.hasKind(i)&&(s[a]={id:a,text:r.getLabel({long:!0}),description:r.get("description"),model:r}):s[a]={id:a,text:`?${a}?`});const l=Object.values(s).sort((e,t)=>e.text.localeCompare(t.text));t.select2({width:"100%",allowClear:!1,placeholder:" ",data:l,dropdownCssClass:"select2-with-description",formatResult:n.bind(null,"text","description")}),e&&s[e]?t.val(e).select2("data",s[e]):1===l.length&&t.val(l[0].id).select2("data",l[0])},setUpImplementersSelect2:function(){const e=this.model.isCoordinator()||d.can.manage(),i=this.$id("implementers");a(i,{width:"100%",multiple:!0,maximumSelectionSize:2,noPersonnelId:!0,userInfoDecorators:[r]});const s=[];if(this.options.editMode)(this.model.get("implementers")||[]).forEach(e=>{s.push({id:e.id,text:e.label,user:e})});else{const i=this.model.get("creator")||r(t.getInfo(),t.data),n=(this.model.get("implementers")||[]).find(e=>e.id!==i.id);s.push({id:i.id,text:i.label,locked:!e,user:i}),n&&s.push({id:n.id,text:n.label,user:n})}i.select2("data",s).select2("enable",!this.options.editMode||e);const n=this.$id("plannedAt");n.length&&n.prop("disabled",!!n.val()&&!e)},toggleKind:function(){const e=this.$('input[name="kind[]"]');e.length&&!e.filter(":checked").length&&e.first().click(),e.prop("disabled",!d.can.editKind(this.model,this.options.editMode))},updateRewardPlaceholder:function(){this.$id("reward").attr("placeholder",this.getDefaultRewardAmount().toLocaleString())},getDefaultRewardAmount:function(){const e=this.$('input[name="kom"]:checked').val(),t="1"===e?"nom":"2"===e?"kom":"default";return o.settings.getValue(`rewards.kaizens.${t}`,0)},getFailureText:function(e){const{code:t}=e.responseJSON&&e.responseJSON.error||{};return this.t.has(`FORM:ERROR:${t}`)?this.t(`FORM:ERROR:${t}`):l.prototype.getFailureText.apply(this,arguments)},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var e=l.prototype.request.apply(this,arguments);return e.always(function(){s.msg.saved()}),e},submitRequest:function(e,t){const i=this,n=new FormData;let a=0;if(i.$('input[type="file"]').each(function(){const e=this.name.replace("attachments.","");for(let t=0;t<this.files.length;++t)n.append(e,this.files[t]),a+=1}),0===a)return l.prototype.submitRequest.call(i,e,t);s.msg.saving();const o=i.ajax({type:"POST",url:"/osh/attachments",data:n,processData:!1,contentType:!1});o.done(n=>{t.attachments={added:n},l.prototype.submitRequest.call(i,e,t),s.msg.saved()}),o.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),e.attr("disabled",!1)})},onDialogShown:function(){this.$id("subject").focus()}})});