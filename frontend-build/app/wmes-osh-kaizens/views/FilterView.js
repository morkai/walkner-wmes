define(["underscore","jquery","app/user","app/core/views/FilterView","app/core/util/forms/dateTimeRange","app/core/util/forms/dropdownRadio","app/core/util/idAndLabel","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-kaizens/templates/filter","app/core/util/ExpandableSelect"],function(e,t,a,i,l,s,n,r,o,p){"use strict";return i.extend({filterList:["createdAt","workplace","department","building","location","station","kind","kaizenCategory","limit"],filterMap:{createdAt:"date",startedAt:"date",implementedAt:"date",plannedAt:"date",finishedAt:"date"},template:p,events:Object.assign({"click a[data-date-time-range]":l.handleRangeEvent,'change input[name="userType"]':function(){this.toggleUserSelect2(!0)}},i.prototype.events),defaultFormData:function(){return{userType:"others",dateFilter:"createdAt"}},termToForm:{createdAt:l.rqlToForm,startedAt:l.rqlToForm,implementedAt:l.rqlToForm,plannedAt:l.rqlToForm,finishedAt:l.rqlToForm,workplace:(e,t,a)=>{a[e]="in"===t.name?t.args[1].join(","):t.args[1]},department:"workplace",building:"workplace",location:"workplace",station:"station",kaizenCategory:"workplace",kind:(e,t,a)=>{a[e]="in"===t.name?t.args[1]:[t.args[1]]},status:"kind",kom:(e,t,a)=>{a.status||(a.status=[]),a.status.push("kom")},"creator.id":(e,t,a)=>{a.userType=e.split(".")[0],a.user=t.args[1]},"implementers.id":"creator.id","coordinators.id":"creator.id","users.user.id":(e,t,a)=>{"mine"===t.args[1]?(a.userType="mine",a.user=null):"unseen"===t.args[1]?(a.userType="unseen",a.user=null):(a.userType="others",a.user=t.args[1])}},getTemplateData:function(){return{statuses:o.statuses.kaizen.concat("kom").map(e=>({value:e,label:o.getLabel("status",e)})),kinds:o.kinds.map(e=>({value:e.id,label:e.getLabel({long:!0})}))}},serializeFormToQuery:function(e,t){const a=this.$('input[name="dateFilter"]:checked').val();t.sort={},t.sort[a]=-1,l.formToRql(this,e);const i=this.$id("status").val();if(i&&i.length){const t=[];let a=!1;i.forEach(e=>{"kom"===e?a=!0:t.push(e)}),1===t.length?e.push({name:"eq",args:["status",t[0]]}):t.length>1&&e.push({name:"in",args:["status",t]}),a&&e.push({name:"eq",args:["kom",a]})}["workplace","department","building","location","station","kind","activityKind"].forEach(t=>{const a=this.$id(t);let i=a.val();i&&i.length&&("string"==typeof i&&(i=i.split(",")),"SELECT"===a[0].tagName&&a[0].options.length===i.length||(1===(i=i.map(e=>/^[0-9]+$/.test(e)?parseInt(e,10):e)).length?e.push({name:"eq",args:[t,i[0]]}):e.push({name:"in",args:[t,i]})))});const s=this.$id("user").val();let n=this.$('input[name="userType"]').val();"mine"===n||"unseen"===n?e.push({name:"eq",args:["users.user.id",n]}):s&&("others"===n&&(n="users.user"),e.push({name:"eq",args:[n+".id",s]}))},afterRender:function(){i.prototype.afterRender.call(this),this.$(".is-expandable").expandableSelect(),r(this.$id("user"),{view:this,width:"100%"}),this.setUpUserType(),this.toggleUserSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpKaizenCategorySelect2()},setUpUserType:function(){const e=this,t=["mine","unseen","others","creator","implementers","coordinators"].map(function(t){return{value:t,title:e.t(`filter:user:${t}:title`),optionLabel:e.t(`filter:user:${t}`)}});s(e.$id("userType"),{label:e.t("filter:user:others"),options:t})},toggleUserSelect2:function(e){const t=this.$('input[name="userType"]').val(),i="mine"===t||"unseen"===t,l=this.$id("user").select2("enable",!i);(i||e&&!l.val())&&l.select2("data",{id:a.data._id,text:a.getLabel()})},setUpWorkplaceSelect2:function(){this.$id("workplace").select2({width:"250px",multiple:!0,placeholder:" ",data:o.workplaces.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,a)=>a(e.getLabel())})},setUpDepartmentSelect2:function(){this.$id("department").select2({width:"250px",multiple:!0,placeholder:" ",data:o.workplaces.filter(e=>e.get("active")).map(e=>({text:e.getLabel({long:!0}),children:o.departments.filter(t=>t.get("active")&&t.get("workplace")===e.id).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e}))})),formatSelection:({model:e},t,a)=>a(e.getLabel())})},setUpBuildingSelect2:function(){this.$id("building").select2({width:"250px",multiple:!0,placeholder:" ",data:o.buildings.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,a)=>a(e.getLabel())})},setUpLocationSelect2:function(){this.$id("location").select2({width:"250px",multiple:!0,placeholder:" ",data:o.locations.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,a)=>a(e.getLabel())})},setUpStationSelect2:function(){const e=[];o.locations.forEach(t=>{if(!t.get("active"))return;const a=o.stations.getByLocation(t.id).filter(e=>e.get("active"));a.length&&e.push({text:t.getLabel({long:!0}),children:a.map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e}))})}),this.$id("station").select2({width:"250px",multiple:!0,placeholder:" ",data:e,formatSelection:({model:e},t,a)=>a(e.getLabel({path:!0}))})},setUpKaizenCategorySelect2:function(){this.$id("kaizenCategory").select2({width:"250px",multiple:!0,placeholder:" ",data:o.kaizenCategories.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,a)=>a(e.getLabel())})},destroy:function(){i.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},filterHasValue:function(e){if("date"===e){const e=this.$id("from-date"),t=this.$id("to-date");return e.val().length>0||t.val().length>0}return i.prototype.filterHasValue.apply(this,arguments)},showFilter:function(e){if("creator"===e||"implementers"===e||"coordinators"===e)return this.$id("userType").val(e).trigger("change"),void this.$id("user").select2("focus");const t=this.$('.dateTimeRange-label-input[value="'+e+'"]');t.length&&(t.prop("checked",!0),l.toggleLabel(this)),i.prototype.showFilter.apply(this,arguments)}})});