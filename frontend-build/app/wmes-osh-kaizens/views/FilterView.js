define(["underscore","jquery","app/user","app/core/views/FilterView","app/core/util/forms/dateTimeRange","app/core/util/idAndLabel","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-kaizens/templates/filter","app/core/util/ExpandableSelect"],function(e,t,i,a,l,s,o,n,r){"use strict";return a.extend({filterList:["createdAt","workplace","division","building","location","station","kind","eventCategory","limit"],filterMap:{},template:r,events:Object.assign({"click a[data-date-time-range]":l.handleRangeEvent,'change input[name="userType"]':function(){"mine"===this.$('input[name="userType"]:checked').val()&&this.$id("user").select2("data",{id:i.data._id,text:i.getLabel()})}},a.prototype.events),defaultFormData:function(){return{userType:"others"}},termToForm:{createdAt:l.rqlToForm,workplace:(e,t,i)=>{i[e]="in"===t.name?t.args[1].join(","):t.args[1]},division:"workplace",building:"workplace",location:"workplace",station:"station",eventCategory:"workplace",kind:(e,t,i)=>{i[e]="in"===t.name?t.args[1]:[t.args[1]]},status:"kind","users.user.id":(e,t,a)=>{const l=t.args[1];a.userType=l===i.data._id?"mine":"others",a.user=l},kom:(e,t,i)=>{i.status||(i.status=[]),i.status.push("kom")}},getTemplateData:function(){return{statuses:n.statuses.kaizen.concat("kom").map(e=>({value:e,label:n.getLabel("status",e)})),kinds:n.kinds.map(e=>({value:e.id,label:e.getLabel({long:!0})}))}},serializeFormToQuery:function(e){l.formToRql(this,e);const t=this.$id("status").val();if(t&&t.length){const i=[];let a=!1;t.forEach(e=>{"kom"===e?a=!0:i.push(e)}),1===i.length?e.push({name:"eq",args:["status",i[0]]}):i.length>1&&e.push({name:"in",args:["status",i]}),a&&e.push({name:"eq",args:["kom",a]})}["workplace","division","building","location","station","kind","activityKind"].forEach(t=>{const i=this.$id(t);let a=i.val();a&&a.length&&("string"==typeof a&&(a=a.split(",")),"SELECT"===i[0].tagName&&i[0].options.length===a.length||(1===(a=a.map(e=>/^[0-9]+$/.test(e)?parseInt(e,10):e)).length?e.push({name:"eq",args:[t,a[0]]}):e.push({name:"in",args:[t,a]})))});const i=this.$id("user").val();i&&e.push({name:"eq",args:["users.user.id",i]})},afterRender:function(){a.prototype.afterRender.call(this),this.$(".is-expandable").expandableSelect(),o(this.$id("user"),{view:this,width:"100%"}),this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpEventCategorySelect2()},setUpWorkplaceSelect2:function(){this.$id("workplace").select2({width:"250px",multiple:!0,placeholder:" ",data:n.workplaces.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,i)=>i(e.getLabel())})},setUpDivisionSelect2:function(){this.$id("division").select2({width:"250px",multiple:!0,placeholder:" ",data:n.workplaces.filter(e=>e.get("active")).map(e=>({text:e.getLabel({long:!0}),children:n.divisions.filter(t=>t.get("active")&&t.get("workplace")===e.id).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e}))})),formatSelection:({model:e},t,i)=>i(e.getLabel())})},setUpBuildingSelect2:function(){this.$id("building").select2({width:"250px",multiple:!0,placeholder:" ",data:n.buildings.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,i)=>i(e.getLabel())})},setUpLocationSelect2:function(){this.$id("location").select2({width:"250px",multiple:!0,placeholder:" ",data:n.locations.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,i)=>i(e.getLabel())})},setUpStationSelect2:function(){const e=[];n.locations.forEach(t=>{if(!t.get("active"))return;const i=n.stations.getByLocation(t.id).filter(e=>e.get("active"));i.length&&e.push({text:t.getLabel({long:!0}),children:i.map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e}))})}),this.$id("station").select2({width:"250px",multiple:!0,placeholder:" ",data:e,formatSelection:({model:e},t,i)=>i(e.getLabel({path:!0}))})},setUpEventCategorySelect2:function(){this.$id("eventCategory").select2({width:"250px",multiple:!0,placeholder:" ",data:n.eventCategories.filter(e=>e.get("active")).map(e=>({id:e.id,text:e.getLabel({long:!0}),model:e})),formatSelection:({model:e},t,i)=>i(e.getLabel())})},destroy:function(){a.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},filterHasValue:function(e){if("createdAt"===e){var t=this.$id("from-date"),i=this.$id("to-date");return t.val().length>0||i.val().length>0}return a.prototype.filterHasValue.apply(this,arguments)},showFilter:function(e){"creator"===e||"implementers"===e||"coordinators"===e?this.$id("user").select2("focus"):a.prototype.showFilter.apply(this,arguments)}})});