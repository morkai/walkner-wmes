define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/idAndLabel","app/core/util/buttonGroup","app/core/views/FormView","app/users/util/setUpUserSelect2","app/data/prodLines","app/data/localStorage","app/kaizenOrders/dictionaries","../MinutesForSafetyCard","app/minutesForSafetyCards/templates/form","app/minutesForSafetyCards/templates/_formCause","app/minutesForSafetyCards/templates/_formObservation","app/minutesForSafetyCards/templates/_formProposition","app/minutesForSafetyCards/templates/_formRidEditor"],function(t,e,i,o,r,n,s,a,d,c,p,l,h,u,f,m,v,g){"use strict";return a.extend({template:u,events:t.assign({"click #-addObservation":function(){this.$id("observations").append(m({observation:{what:"",why:""},i:++this.rowIndex}))},"click #-addOrgProposition":function(){var t=e(this.createProposition("orgPropositions",{what:"",who:"",when:""}));this.$id("orgPropositions").append(t),this.setUpWhoSelect2(t)},"click #-addTechProposition":function(){var t=e(this.createProposition("techPropositions",{what:"",who:"",when:""}));this.$id("techPropositions").append(t),this.setUpWhoSelect2(t)},"click .btn[data-remove]":function(t){this.$(t.target).closest("tr").fadeOut("fast",function(){e(this).remove()})},"click .mfs-form-rid-message > a":function(){p.setItem("MFS_LAST",JSON.stringify(t.assign(this.model.toJSON(),this.getFormData())))},"click a[role=rid]":function(t){return this.showRidEditor(t.currentTarget.dataset.kind,t.currentTarget),!1}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),this.rowIndex=0,e("body").on("click."+this.idPrefix,this.onDocumentClick.bind(this))},destroy:function(){a.prototype.destroy.apply(this,arguments),this.$id("causes").popover("destroy"),e("body").off("click."+this.idPrefix)},checkValidity:function(t){return(t.causes||[]).length||(t.observations||[]).length||(t.risks||[]).length||(t.difficulties||[]).length},handleInvalidity:function(){this.model.getVersion()>1?this.$('textarea[name*="why"]').first().focus():this.$id("addObservation").focus()},serializeToForm:function(){var t=this.model.toJSON();return t.date=o.format(t.date,"YYYY-MM-DD"),t},serializeForm:function(t){var i=this.$id("owner").select2("data"),r=this.$id("confirmer").select2("data"),n=o.getMoment(t.date,"YYYY-MM-DD"),s=this.$id("orgPropositions").find('input[name$="who"]'),a=this.$id("techPropositions").find('input[name$="who"]'),d=function(t){return t&&t.length?(t.select2("data")||[]).map(function(t){return{id:t.id,label:t.text}}):[]};return t.owner={id:i.id,label:i.text},t.confirmer=r?{id:r.id,label:r.text}:null,t.date=n.isValid()?n.toISOString():null,t.risks=t.risks||"",t.causes=t.causes||[],t.causes.forEach(function(t){for(t.why||(t.why=[]);t.why.length<5;)t.why.push("")}),t.observations=(t.observations||[]).filter(this.filterObservation),t.orgPropositions=(t.orgPropositions||[]).map(function(t,i){return t.who=d(e(s[i])),t}).filter(this.filterProposition),t.techPropositions=(t.techPropositions||[]).map(function(t,i){return t.who=d(e(a[i])),t}).filter(this.filterProposition),t.participants=d(this.$id("participants")),t},filterObservation:function(t){return t.what=(t.what||"").trim(),t.why=(t.why||"").trim(),t.what.length>0&&t.why.length>0},filterProposition:function(t){return t.what=(t.what||"").trim(),t.when=(t.when||"").trim()||null,t.what.length>0},getTemplateData:function(){return{version:this.model.getVersion()}},afterRender:function(){a.prototype.afterRender.call(this),this.$id("section").select2({data:l.sections.map(n)}),this.setUpUserSelect2("owner"),this.setUpParticipantsSelect2(),this.model.getVersion()>1?(this.setUpUserSelect2("confirmer"),this.renderCauses()):(this.renderObservations(),this.renderPropositions("orgPropositions"),this.renderPropositions("techPropositions")),this.$id("owner").focus()},setUpUserSelect2:function(t){var e=this.model.get(t),i=d(this.$id(t),{textFormatter:function(t,e){return e},activeOnly:!this.options.editMode});e&&i.select2("data",{id:e.id,text:e.label})},setUpParticipantsSelect2:function(){var t=this.model.get("participants"),e=d(this.$id("participants"),{multiple:!0,textFormatter:function(t,e){return e},activeOnly:!this.options.editMode});t&&t.length&&e.select2("data",t.map(function(t){return{id:t.id,text:t.label}}))},setUpWhoSelect2:function(t,e){var i=d(t.find('input[name$="who"]'),{multiple:!0,textFormatter:function(t,e){return e},activeOnly:!this.options.editMode});e&&e.length&&i.select2("data",e.map(function(t){return{id:t.id,text:t.label}}))},renderCauses:function(){var t=this,e=t.model.get("causes")||[{category:"tech",why:["","","","",""]},{category:"org",why:["","","","",""]},{category:"human",why:["","","","",""]}],i=t.$id("causes");i.html(e.map(function(e){return t.renderPartialHtml(f,{cause:e,i:++t.rowIndex})}).join("")),i.popover({container:t.el,selector:".control-label[data-cause]",placement:"bottom",trigger:"click",html:!0,content:function(){if(this.querySelector(".fa"))return t.$('div[data-cause-help="'+this.dataset.cause+'"]').html()},className:"mfs-form-cause-popover"}),i.on("show.bs.popover",function(){i.find('.control-label[aria-describedby^="popover"]').popover("hide")})},renderObservations:function(){var t=this;t.$id("observations").html((t.model.get("observations")||[]).map(function(e){return t.renderPartialHtml(m,{observation:e,i:++t.rowIndex})}).join(""))},renderPropositions:function(t){var i=this,r=i.model.get(t)||[];i.$id(t).html(r.map(function(e){return i.createProposition(t,{what:e.what,who:"",when:e.when?o.format(e.when,"YYYY-MM-DD"):""})}).join("")),i.$id(t).find("tr").each(function(t){i.setUpWhoSelect2(e(this),r[t].who)})},createProposition:function(t,e){return this.renderPartialHtml(v,{type:t,proposition:e,i:++this.rowIndex})},handleSuccess:function(){return p.removeItem("MFS_LAST"),a.prototype.handleSuccess.apply(this,arguments)},showRidEditor:function(t,e){var o=this,r=o.$(e);if(r.next(".popover").length)r.popover("destroy");else{r.popover({placement:"auto top",html:!0,trigger:"manual",content:g({idPrefix:this.idPrefix,helpers:this.getTemplateHelpers(),property:t,rid:this.model.get(t)||""})}).popover("show");var n=r.next(".popover"),s=n.find(".form-control").select(),a=n.find(".btn-default"),d=n.find(".btn-link");d.on("click",function(){r.popover("destroy")}),s.on("keydown",function(t){if(13===t.keyCode)return!1}),s.on("keyup",function(t){if(13===t.keyCode)return a.click(),!1}),a.on("click",function(){s.prop("disabled",!0),a.prop("disabled",!0),d.prop("disabled",!0);var e=parseInt(s.val(),10)||0;if(e<=0)return c(null);var r=("nearMiss"===t?"/kaizen/orders":"/suggestions")+"/"+e,n=o.ajax({url:r});return n.fail(function(t){o.showErrorMessage(i("minutesForSafetyCards","FORM:ridEditor:"+(404===t.status?"notFound":"failure"))),s.prop("disabled",!1),a.prop("disabled",!1),d.prop("disabled",!1),(404===t.status?s:a).focus()}),n.done(function(){c(e)}),!1})}function c(e){r.popover("destroy").closest(".message").find(".mfs-form-rid-message").html(o.t("FORM:MSG:"+t+":"+(e?"edit":"add"),{rid:e})),o.model.attributes[t]=e,o.$("input[name="+t+"]").val(e||"")}},onDocumentClick:function(t){var e=this.$(t.target);e.closest(".mfs-form-cause-popover").length||e.closest(".control-label[data-cause]").length||this.$id("causes").popover("hide")}})});