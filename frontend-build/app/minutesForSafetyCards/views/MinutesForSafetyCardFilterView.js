// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/time","app/core/views/FilterView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","app/minutesForSafetyCards/templates/filter","app/core/util/ExpandableSelect"],function(e,t,s,r,n,i){"use strict";return s.extend({template:i,events:e.extend({'change input[name="userType"]':"toggleUserSelect2","keyup select":function(e){if(27===e.keyCode)return e.target.selectedIndex=-1,!1},"dblclick select":function(e){e.target.selectedIndex=-1}},s.prototype.events),defaultFormData:function(){return{section:[],userType:"others",user:null,from:"",to:""}},termToForm:{"owner.id":function(e,t,s){s.userType="owner",s.user=t.args[1]},users:function(e,t,s){"mine"===t.args[1]?(s.userType="mine",s.user=null):(s.userType="others",s.user=t.args[1])},date:function(e,s,r){r["ge"===s.name?"from":"to"]=t.format(s.args[1],"YYYY-MM-DD")},section:function(e,t,s){s[e]="in"===t.name?t.args[1]:[t.args[1]]}},serialize:function(){return e.extend(s.prototype.serialize.call(this),{sections:n.sections.toJSON()})},serializeFormToQuery:function(s){var r=t.getMoment(this.$id("from").val(),"YYYY-MM-DD"),n=t.getMoment(this.$id("to").val(),"YYYY-MM-DD"),i=this.$('input[name="userType"]:checked').val(),a=this.$id("user").val();r.isValid()&&s.push({name:"ge",args:["date",r.valueOf()]}),n.isValid()&&(n.valueOf()===r.valueOf()&&this.$id("to").val(n.add(1,"days").format("YYYY-MM-DD")),s.push({name:"lt",args:["date",n.valueOf()]})),"owner"===i?s.push({name:"eq",args:["owner.id",a]}):"mine"===i?s.push({name:"eq",args:["users","mine"]}):a&&s.push({name:"eq",args:["users",a]}),["section"].forEach(function(t){var r=(this.$id(t).val()||[]).filter(function(t){return!e.isEmpty(t)});1===r.length?s.push({name:"eq",args:[t,r[0]]}):r.length&&s.push({name:"in",args:[t,r]})},this)},afterRender:function(){s.prototype.afterRender.call(this),this.$(".is-expandable").expandableSelect(),r(this.$id("user"),{width:"300px",view:this}),this.toggleUserSelect2()},destroy:function(){s.prototype.destroy.call(this),this.$(".is-expandable").expandableSelect("destroy")},toggleUserSelect2:function(){var e=this.$('input[name="userType"]:checked').val();this.$id("user").select2("enable","others"===e||"owner"===e)}})});