define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(e,t,r,o,n){"use strict";var a=["total","countBySection","owners","participants","engaged"],s={owners:!0,participants:!0,engaged:!0};return o.extend({urlRoot:"/minutesForSafetyCards/reports/count",nlsDomain:"minutesForSafetyCards",defaults:function(){return{from:0,to:0,interval:"month",sections:[],owner:""}},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.extend(t.data||{},e.pick(this.attributes,["from","to","interval","sections","owner"])),t.data.sections=t.data.sections.join(","),o.prototype.fetch.call(this,t)},genClientUrl:function(){return"/minutesForSafetyCardCountReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&owner="+this.get("owner")},parse:function(t){var r=this,o=t.totals,n={total:{rows:r.prepareTotalRows(o),series:r.prepareTotalSeries()}};return e.forEach(a,function(e){n[e]||(n[e]=s[e]?{categories:r.prepareUserCategories(t.users,o[e]),series:r.prepareOwnerSeries(o[e],t.groups)}:{rows:r.prepareRows(o[e.replace("BySection","")],o[e],"sections",t.sections),series:{}})}),e.forEach(t.groups,function(t){var o;"number"==typeof t?t={key:o=t,type:{}}:o=t.key,n.total.series.minutesForSafetyCard.data.push({x:o,y:t.count||null}),e.forEach(a,function(e){r.createSeriesFromRows(e,n,t)})}),n},prepareTotalRows:function(e){return[{id:"minutesForSafetyCard",abs:e.count,rel:1,color:"#5cb85c"}]},prepareTotalSeries:function(){return{minutesForSafetyCard:{data:[],color:"#5cb85c"}}},prepareRows:function(e,r,o,a){var s={id:"total",abs:0,rel:1,color:"#DDD",label:t("minutesForSafetyCards","report:series:total")},i=r.map(function(t){return s.abs+=t[1],{id:t[0],abs:t[1],rel:t[1]/e,color:n.getColor("minutesForSafetyCards/count/"+o,t[0]),label:a[t[0]]}});return i.push(s),i},createSeriesFromRows:function(t,r,o){var n=r[t].series;e.forEach(r[t].rows,function(e){n[e.id]||(n[e.id]={name:e.label,data:[],color:e.color}),n[e.id].data.push({x:o.key,y:o[t]&&o[t][e.id]||null})})},prepareUserCategories:function(e,t){return t.map(function(t){var r=t[0];return e[r]||r})},prepareOwnerSeries:function(r){var o=[{id:"minutesForSafetyCards",name:t.bound("minutesForSafetyCards","report:series:card"),data:[],color:"#5cb85c"}];return e.forEach(r,function(e){o[0].data.push(e[1])}),o}},{TABLE_AND_CHART_METRICS:a,USERS_METRICS:s,fromQuery:function(t){return void 0===t.from&&void 0===t.to&&(t.from=r.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+t.from||void 0,to:+t.to||void 0,interval:t.interval||void 0,sections:e.isEmpty(t.sections)?[]:t.sections.split(","),owner:t.owner||""})}})});