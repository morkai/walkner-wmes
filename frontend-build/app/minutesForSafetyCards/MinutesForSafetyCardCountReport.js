define(["underscore","../i18n","../time","../core/Model","../data/colorFactory"],function(r,e,t,o,n){"use strict";var s=["total","countBySection","owners","confirmers","participants","engaged"],i={owners:!0,confirmers:!0,participants:!0,engaged:!0};return o.extend({urlRoot:"/minutesForSafetyCards/reports/count",nlsDomain:"minutesForSafetyCards",defaults:function(){return{from:0,to:0,interval:"month",sections:[],owner:"",confirmer:""}},fetch:function(e){return r.isObject(e)||(e={}),e.data=r.assign(e.data||{},r.pick(this.attributes,["from","to","interval","sections","owner","confirmer"])),e.data.sections=e.data.sections.join(","),o.prototype.fetch.call(this,e)},genClientUrl:function(){return"/minutesForSafetyCards/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&owner="+this.get("owner")+"&confirmer="+this.get("confirmer")},parse:function(e){var t=this,o=e.totals,n={total:{rows:t.prepareTotalRows(o),series:t.prepareTotalSeries()}};return r.forEach(s,function(r){n[r]||(n[r]=i[r]?{categories:t.prepareUserCategories(e.users,o[r]),series:t.prepareOwnerSeries(o[r],e.groups)}:{rows:t.prepareRows(o[r.replace("BySection","")],o[r],"sections",e.sections),series:{}})}),r.forEach(e.groups,function(e){var o;"number"==typeof e?e={key:o=e,type:{}}:o=e.key,n.total.series.minutesForSafetyCard.data.push({x:o,y:e.count||null}),r.forEach(s,function(r){t.createSeriesFromRows(r,n,e)})}),n},prepareTotalRows:function(r){return[{id:"minutesForSafetyCard",abs:r.count,rel:1,color:"#5cb85c"}]},prepareTotalSeries:function(){return{minutesForSafetyCard:{data:[],color:"#5cb85c"}}},prepareRows:function(r,t,o,s){var i={id:"total",abs:0,rel:1,color:"#DDD",label:e(this.nlsDomain,"report:series:total")},a=t.map(function(e){return i.abs+=e[1],{id:e[0],abs:e[1],rel:e[1]/r,color:n.getColor("minutesForSafetyCards/count/"+o,e[0]),label:s[e[0]]}});return a.push(i),a},createSeriesFromRows:function(e,t,o){var n=t[e].series;r.forEach(t[e].rows,function(r){n[r.id]||(n[r.id]={name:r.label,data:[],color:r.color}),n[r.id].data.push({x:o.key,y:o[e]&&o[e][r.id]||null})})},prepareUserCategories:function(r,e){return e.map(function(e){var t=e[0];return r[t]||t})},prepareOwnerSeries:function(t){var o=[{id:"minutesForSafetyCards",name:e.bound(this.nlsDomain,"report:series:card"),data:[],color:"#5cb85c"}];return r.forEach(t,function(r){o[0].data.push(r[1])}),o}},{TABLE_AND_CHART_METRICS:s,USERS_METRICS:i,fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=t.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+e.from||void 0,to:+e.to||void 0,interval:e.interval||void 0,sections:r.isEmpty(e.sections)?[]:e.sections.split(","),owner:e.owner||"",confirmer:e.confirmer||""})}})});