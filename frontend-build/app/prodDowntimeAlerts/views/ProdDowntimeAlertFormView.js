define(["underscore","jquery","app/i18n","app/time","app/core/views/FormView","app/core/util/idAndLabel","app/users/util/setUpUserSelect2","app/data/orgUnits","app/data/downtimeReasons","app/data/aors","../ProdDowntimeAlert","app/prodDowntimeAlerts/templates/formAction","app/prodDowntimeAlerts/templates/form"],function(t,i,n,e,o,s,r,a,d,c,l,u,h){"use strict";var p={reason:function(){return d.map(s)},aor:function(){return c.map(s)},division:function(){return f("division")},subdivision:function(){return f("subdivision",function(t){return{id:t.id,text:t.get("division")+" \\ "+t.get("name")}})},mrpController:function(){return f("mrpController")},prodFlow:function(){return f("prodFlow")},workCenter:function(){return f("workCenter")},prodLine:function(){return f("prodLine")}};function f(t,i){return a.getAllByType(t).filter(function(t){return!t.get("deactivatedAt")}).map(i||s)}function m(t,i){return i}return o.extend({template:h,events:t.assign({"click #-conditions-add":function(){var t=this.$id("conditionTypes"),i=t.val();if(""!==i){var n=this.$id("conditions-"+i);n.closest(".form-group").removeClass("hidden"),n.select2("data",null).select2("focus");var e=t[0].selectedOptions[0];e.selected=!1,e.disabled=!0,e.hidden=!0,t.val(""),this.onConditionsChange()}},"click .prodDowntimeAlerts-form-condition-remove":function(t){var i=this.$(t.target).closest(".form-group").addClass("hidden").attr("data-type");this.$id("conditions-"+i).select2("data",null),this.$id("conditionTypes").find('option[value="'+i+'"]').prop({disabled:!1,hidden:!1}),this.onConditionsChange()},'change input[name$="values"]':"onConditionsChange","click #-actions-add":function(){var t=i(u({i:++this.actionCounter,action:{delaySeconds:0}}));this.$id("actions").append(t),this.setUpActionSelect2(t),this.onActionsChange(),t.find('[name$="delay"]').focus()},"change .prodDowntimeAlerts-form-action-delay":function(t){var i=t.target,n=e.toSeconds(t.target.value)||0;i.value=e.toString(n),i.parentNode.dataset.delay=n,this.sortActions(),this.recountActions()},"click .prodDowntimeAlerts-form-action-remove":function(t){this.$(t.target).closest(".prodDowntimeAlerts-form-action").remove(),this.sortActions(),this.recountActions(),this.onActionsChange()},"keyup #-actions-validity":function(t){return 32===t.keyCode&&this.$id("actions-add").click(),!1},"keydown #-actions-validity":function(t){return 13===t.keyCode&&this.$id("actions-add").click(),!1},"change .js-actionsValidity":"toggleActionsValidity","change #-repeatInterval":function(t){t.target.value=e.toString(e.toSeconds(t.target.value)||0)}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.actionCounter=0},serialize:function(){return t.assign(o.prototype.serialize.call(this),{renderAction:u,conditions:this.serializeConditions(),actions:this.serializeActions()})},serializeConditions:function(){var i=this.model.get("conditions")||[],n={},e=[];return t.forEach(i,function(t){n[t.type]=t}),t.forEach(l.CONDITION_TYPES,function(t){var i=n[t];e.push({hidden:!i,mode:i?i.mode:"include",type:t,values:i?i.values.join(","):""})}),this.conditions=e,e},serializeActions:function(){return this.actions=t.map(this.model.get("actions"),function(i,n){return t.assign({},i,{no:n+1,delaySeconds:i.delay,delay:e.toString(i.delay),userWhitelist:t.pluck(i.userWhitelist,"id").join(","),userBlacklist:t.pluck(i.userBlacklist,"id").join(",")})}),this.actions},serializeToForm:function(){var i=this.model.toJSON();return i.repeatInterval=e.toString(i.repeatInterval),i.conditions=this.conditions,i.actions=this.actions,i.userWhitelist=t.pluck(i.userWhitelist,"id").join(","),i.userBlacklist=t.pluck(i.userBlacklist,"id").join(","),i},serializeForm:function(i){var n=this,o=n.$(".prodDowntimeAlerts-form-action"),s=function(i){return t.map(i.select2("data"),function(t){return{id:t.id,label:t.text}})};return i.repeatInterval=e.toSeconds(i.repeatInterval)||0,i.conditions=i.conditions.filter(function(i){return!t.isEmpty(i.values)}).map(function(i){var e={mode:i.mode,type:i.type,labels:[],values:[]};return t.forEach(n.$id("conditions-"+i.type).select2("data"),function(t){e.labels.push(t.text),e.values.push(t.id)}),e}),i.actions=(i.actions||[]).map(function(t,i){return{delay:e.toSeconds(t.delay),sendEmail:!!t.sendEmail,sendSms:!!t.sendSms,informAor:!!t.informAor,informManager:!!t.informManager,informMaster:!!t.informMaster,informLeader:!!t.informLeader,userWhitelist:s(n.$(o[i]).find('[name$="userWhitelist"]')),userBlacklist:s(n.$(o[i]).find('[name$="userBlacklist"]'))}}),i.userWhitelist=s(n.$id("userWhitelist")),i.userBlacklist=s(n.$id("userBlacklist")),i},afterRender:function(){o.prototype.afterRender.call(this),t.forEach(l.CONDITION_TYPES,this.setUpConditionSelect2.bind(this)),this.setUpActionsSelect2(),this.onConditionsChange(),this.onActionsChange(),r(this.$id("userWhitelist"),{view:this,multiple:!0,textFormatter:m}),r(this.$id("userBlacklist"),{view:this,multiple:!0,textFormatter:m})},setUpConditionSelect2:function(t){this.$id("conditions-"+t).select2({multiple:!0,data:p[t](this)})},setUpActionsSelect2:function(){var i=this,n=i.model.get("actions");if(!t.isEmpty(n)){var e=i.$(".prodDowntimeAlerts-form-action");t.forEach(n,function(t,n){i.setUpActionSelect2(i.$(e[n]),t)}),this.actionCounter=e.length}},setUpActionSelect2:function(i,n){var e=r(i.find('input[name$="userWhitelist"]'),{multiple:!0,textFormatter:m}),o=r(i.find('input[name$="userBlacklist"]'),{multiple:!0,textFormatter:m});n&&(e.select2("data",t.map(n.userWhitelist,function(t){return{id:t.id,text:t.label}})),o.select2("data",t.map(n.userBlacklist,function(t){return{id:t.id,text:t.label}})))},onConditionsChange:function(){this.toggleConditionsValidity(),this.toggleEmptyConditionsMessage()},hasAnyValidConditions:function(){return t.some(l.CONDITION_TYPES,function(t){return""!==this.$id("conditions-"+t).val()},this)},hasAnyAddedConditions:function(){return this.$id("conditionTypes").children().filter("[disabled]").length>1},toggleConditionsValidity:function(){this.$id("conditionTypes")[0].setCustomValidity(this.hasAnyValidConditions()?"":n("prodDowntimeAlerts","FORM:ERROR:conditions"))},toggleEmptyConditionsMessage:function(){this.$id("conditions-empty").toggleClass("hidden",this.hasAnyAddedConditions())},onActionsChange:function(){this.toggleActionsValidity(),this.toggleEmptyActionsMessage(),this.recountActions()},hasAnyValidActions:function(){var n=!!this.$id("userWhitelist").val().length;return t.some(this.$(".prodDowntimeAlerts-form-action"),function(t){var e=i(t);if("0"===e.attr("data-delay"))return!1;var o=e.find('[name$="sendEmail"]').prop("checked"),s=e.find('[name$="sendSms"]').prop("checked");return!(!o&&!s)&&(!(!n&&!e.find('[name$="userWhitelist"]').val().length)||(e.find('[name$="informAor"]').prop("checked")||e.find('[name$="informManager"]').prop("checked")||e.find('[name$="informMaster"]').prop("checked")||e.find('[name$="informLeader"]').prop("checked")))},this)},hasAnyAddedActions:function(){return this.$(".prodDowntimeAlerts-form-action").length>0},toggleActionsValidity:function(){var t=this.$id("actions-validity"),i=this.$id("actions-add");t.css({width:i.outerWidth()+"px",height:i.outerHeight()+"px"}),t[0].setCustomValidity(this.hasAnyValidActions()?"":n("prodDowntimeAlerts","FORM:ERROR:actions"))},toggleEmptyActionsMessage:function(){this.$id("actions-empty").toggleClass("hidden",this.hasAnyAddedActions())},recountActions:function(){this.$(".prodDowntimeAlerts-form-action-no").each(function(t,i){i.innerText=t+1+"."})},sortActions:function(){var t=document.activeElement;this.$(".prodDowntimeAlerts-form-action").sort(function(t,i){return t.dataset.delay-i.dataset.delay}).appendTo(this.$id("actions")),t.focus()}})});