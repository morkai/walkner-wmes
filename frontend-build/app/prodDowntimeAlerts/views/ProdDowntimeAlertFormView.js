// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/core/views/FormView","app/core/util/idAndLabel","app/users/util/setUpUserSelect2","app/data/orgUnits","app/data/downtimeReasons","app/data/aors","../ProdDowntimeAlert","app/prodDowntimeAlerts/templates/formAction","app/prodDowntimeAlerts/templates/form"],function(t,i,e,n,o,s,r,a,d,c,l,u,h){"use strict";function p(t,i){return a.getAllByType(t).filter(function(t){return!t.get("deactivatedAt")}).map(i||s)}function m(t,i){return i}var f={reason:function(){return d.map(s)},aor:function(){return c.map(s)},division:function(){return p("division")},subdivision:function(){return p("subdivision",function(t){return{id:t.id,text:t.get("division")+" \\ "+t.get("name")}})},mrpController:function(){return p("mrpController")},prodFlow:function(){return p("prodFlow")},workCenter:function(){return p("workCenter")},prodLine:function(){return p("prodLine")}};return o.extend({template:h,events:t.extend({"click #-conditions-add":function(){var t=this.$id("conditionTypes"),i=t.val();if(""!==i){var e=this.$id("conditions-"+i);e.closest(".form-group").removeClass("hidden"),e.select2("data",null).select2("focus");var n=t[0].selectedOptions[0];n.selected=!1,n.disabled=!0,n.hidden=!0,t.val(""),this.onConditionsChange()}},"click .prodDowntimeAlerts-form-condition-remove":function(t){var i=this.$(t.target).closest(".form-group").addClass("hidden"),e=i.attr("data-type");this.$id("conditions-"+e).select2("data",null),this.$id("conditionTypes").find('option[value="'+e+'"]').prop({disabled:!1,hidden:!1}),this.onConditionsChange()},'change input[name$="values"]':"onConditionsChange","click #-actions-add":function(){var t=i(u({i:++this.actionCounter,action:{delaySeconds:0}}));this.$id("actions").append(t),this.setUpActionSelect2(t),this.onActionsChange(),t.find('[name$="delay"]').focus()},"change .prodDowntimeAlerts-form-action-delay":function(t){var i=t.target,e=n.toSeconds(t.target.value)||0;i.value=n.toString(e),i.parentNode.dataset.delay=e,this.sortActions(),this.recountActions()},"click .prodDowntimeAlerts-form-action-remove":function(t){this.$(t.target).closest(".prodDowntimeAlerts-form-action").remove(),this.sortActions(),this.recountActions(),this.onActionsChange()},"keyup #-actions-validity":function(t){return 32===t.keyCode&&this.$id("actions-add").click(),!1},"keydown #-actions-validity":function(t){return 13===t.keyCode&&this.$id("actions-add").click(),!1},"change .js-actionsValidity":"toggleActionsValidity","change #-repeatInterval":function(t){t.target.value=n.toString(n.toSeconds(t.target.value)||0)}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.actionCounter=0},serialize:function(){return t.extend(o.prototype.serialize.call(this),{renderAction:u,conditions:this.serializeConditions(),actions:this.serializeActions()})},serializeConditions:function(){var i=this.model.get("conditions")||[],e={},n=[];return t.forEach(i,function(t){e[t.type]=t}),t.forEach(l.CONDITION_TYPES,function(t){var i=e[t];n.push({hidden:!i,mode:i?i.mode:"include",type:t,values:i?i.values.join(","):""})}),this.conditions=n,n},serializeActions:function(){return this.actions=t.map(this.model.get("actions"),function(i,e){return t.extend({},i,{no:e+1,delaySeconds:i.delay,delay:n.toString(i.delay),userWhitelist:t.pluck(i.userWhitelist,"id").join(","),userBlacklist:t.pluck(i.userBlacklist,"id").join(",")})}),this.actions},serializeToForm:function(){var i=this.model.toJSON();return i.repeatInterval=n.toString(i.repeatInterval),i.conditions=this.conditions,i.actions=this.actions,i.userWhitelist=t.pluck(i.userWhitelist,"id").join(","),i.userBlacklist=t.pluck(i.userBlacklist,"id").join(","),i},serializeForm:function(i){var e=this,o=e.$(".prodDowntimeAlerts-form-action"),s=function(i){return t.map(i.select2("data"),function(t){return{id:t.id,label:t.text}})};return i.repeatInterval=n.toSeconds(i.repeatInterval)||0,i.conditions=i.conditions.filter(function(i){return!t.isEmpty(i.values)}).map(function(i){var n={mode:i.mode,type:i.type,labels:[],values:[]};return t.forEach(e.$id("conditions-"+i.type).select2("data"),function(t){n.labels.push(t.text),n.values.push(t.id)}),n}),i.actions=(i.actions||[]).map(function(t,i){return{delay:n.toSeconds(t.delay),sendEmail:!!t.sendEmail,sendSms:!!t.sendSms,informAor:!!t.informAor,informManager:!!t.informManager,informMaster:!!t.informMaster,informLeader:!!t.informLeader,userWhitelist:s(e.$(o[i]).find('[name$="userWhitelist"]')),userBlacklist:s(e.$(o[i]).find('[name$="userBlacklist"]'))}}),i.userWhitelist=s(e.$id("userWhitelist")),i.userBlacklist=s(e.$id("userBlacklist")),i},afterRender:function(){o.prototype.afterRender.call(this),t.forEach(l.CONDITION_TYPES,this.setUpConditionSelect2.bind(this)),this.setUpActionsSelect2(),this.onConditionsChange(),this.onActionsChange(),r(this.$id("userWhitelist"),{view:this,multiple:!0,textFormatter:m}),r(this.$id("userBlacklist"),{view:this,multiple:!0,textFormatter:m})},setUpConditionSelect2:function(t){this.$id("conditions-"+t).select2({multiple:!0,data:f[t](this)})},setUpActionsSelect2:function(){var i=this,e=i.model.get("actions");if(!t.isEmpty(e)){var n=i.$(".prodDowntimeAlerts-form-action");t.forEach(e,function(t,e){i.setUpActionSelect2(i.$(n[e]),t)}),this.actionCounter=n.length}},setUpActionSelect2:function(i,e){var n=r(i.find('input[name$="userWhitelist"]'),{multiple:!0,textFormatter:m}),o=r(i.find('input[name$="userBlacklist"]'),{multiple:!0,textFormatter:m});e&&(n.select2("data",t.map(e.userWhitelist,function(t){return{id:t.id,text:t.label}})),o.select2("data",t.map(e.userBlacklist,function(t){return{id:t.id,text:t.label}})))},onConditionsChange:function(){this.toggleConditionsValidity(),this.toggleEmptyConditionsMessage()},hasAnyValidConditions:function(){return t.some(l.CONDITION_TYPES,function(t){return""!==this.$id("conditions-"+t).val()},this)},hasAnyAddedConditions:function(){return this.$id("conditionTypes").children().filter("[disabled]").length>1},toggleConditionsValidity:function(){this.$id("conditionTypes")[0].setCustomValidity(this.hasAnyValidConditions()?"":e("prodDowntimeAlerts","FORM:ERROR:conditions"))},toggleEmptyConditionsMessage:function(){this.$id("conditions-empty").toggleClass("hidden",this.hasAnyAddedConditions())},onActionsChange:function(){this.toggleActionsValidity(),this.toggleEmptyActionsMessage(),this.recountActions()},hasAnyValidActions:function(){var e=!!this.$id("userWhitelist").val().length;return t.some(this.$(".prodDowntimeAlerts-form-action"),function(t){var n=i(t);if("0"===n.attr("data-delay"))return!1;var o=n.find('[name$="sendEmail"]').prop("checked"),s=n.find('[name$="sendSms"]').prop("checked");return o||s?e||n.find('[name$="userWhitelist"]').val().length?!0:n.find('[name$="informAor"]').prop("checked")||n.find('[name$="informManager"]').prop("checked")||n.find('[name$="informMaster"]').prop("checked")||n.find('[name$="informLeader"]').prop("checked"):!1},this)},hasAnyAddedActions:function(){return this.$(".prodDowntimeAlerts-form-action").length>0},toggleActionsValidity:function(){var t=this.$id("actions-validity"),i=this.$id("actions-add");t.css({width:i.outerWidth()+"px",height:i.outerHeight()+"px"}),t[0].setCustomValidity(this.hasAnyValidActions()?"":e("prodDowntimeAlerts","FORM:ERROR:actions"))},toggleEmptyActionsMessage:function(){this.$id("actions-empty").toggleClass("hidden",this.hasAnyAddedActions())},recountActions:function(){this.$(".prodDowntimeAlerts-form-action-no").each(function(t,i){i.innerText=t+1+"."})},sortActions:function(){var t=document.activeElement;this.$(".prodDowntimeAlerts-form-action").sort(function(t,i){return t.dataset.delay-i.dataset.delay}).appendTo(this.$id("actions")),t.focus()}})});