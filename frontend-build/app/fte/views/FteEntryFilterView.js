define(["underscore","moment","js2form","app/i18n","app/user","app/data/divisions","app/data/subdivisions","app/data/views/OrgUnitDropdownsView","app/core/Model","app/core/View","app/fte/templates/filter"],function(i,e,s,t,n,r,a,o,d,l,u){var p=o.ORG_UNIT;return l.extend({template:u,events:{"submit .filter-form":function(i){i.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=i.uniqueId("fteFilter"),this.orgUnitDropdownsView=new o({orgUnit:this.options.divisionOnly?p.DIVISION:p.SUBDIVISION,allowClear:!0,noGrid:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView)},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var i=this.serializeRqlQuery();s(this.el.querySelector(".filter-form"),i),this.listenToOnce(this.orgUnitDropdownsView,"afterRender",function(){var e=null,s=null;""!==i.subdivision?(s=p.SUBDIVISION,e=new d({subdivision:i.subdivision})):""!==i.division&&(s=p.DIVISION,e=new d({division:i.division})),this.orgUnitDropdownsView.selectValue(e,s)})},serializeRqlQuery:function(){var i=this.model.rqlQuery,s={division:"",subdivision:"",date:"",shift:0,limit:i.limit<5?5:i.limit>100?100:i.limit};return i.selector.args.forEach(function(i){var t=i.args[0];switch(t){case"division":case"subdivision":s[t]=i.args[1],("division"===t?r:a).get(s[t])||(s[t]="");break;case"date":s.date=e(i.args[1]).format("YYYY-MM-DD");break;case"shift":s.shift=parseInt(i.args[1],10),(s.shift<0||s.shift>3)&&(s.shift=0)}}),s},changeFilter:function(){var s=this.model.rqlQuery,t=[],n=this.orgUnitDropdownsView.$id("division").val(),r=this.orgUnitDropdownsView.$id("subdivision").val(),a=e(this.$id("date").val()),o=parseInt(this.$("input[name=shift]:checked").val(),10);i.isEmpty(r)?i.isEmpty(n)||t.push({name:"eq",args:["division",n]}):t.push({name:"eq",args:["subdivision",r]}),a.isValid()&&t.push({name:"eq",args:["date",a.valueOf()]}),o>0&&t.push({name:"eq",args:["shift",o]}),s.selector={name:"and",args:t},s.limit=parseInt(this.$id("limit").val(),10)||15,s.skip=0,this.trigger("filterChanged",s)}})});