define(["underscore","moment","js2form","app/i18n","app/user","app/data/divisions","app/data/subdivisions","app/data/views/OrgUnitDropdownsView","app/core/Model","app/core/View","app/fte/templates/filter","i18n!app/nls/fte"],function(e,t,n,i,r,s,o,a,l,c,u){var d=a.ORG_UNIT;return c.extend({template:u,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("fteFilter"),this.orgUnitDropdownsView=new a({orgUnit:this.options.divisionOnly?d.DIVISION:d.SUBDIVISION,allowClear:!0,noGrid:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView)},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();n(this.el.querySelector(".filter-form"),e),this.listenToOnce(this.orgUnitDropdownsView,"afterRender",function(){var t=null,n=null;""!==e.subdivision?(n=d.SUBDIVISION,t=new l({subdivision:e.subdivision})):""!==e.division&&(n=d.DIVISION,t=new l({division:e.division})),this.orgUnitDropdownsView.selectValue(t,n)})},serializeRqlQuery:function(){var e=this.model.rqlQuery,n={division:"",subdivision:"",date:"",shift:0,limit:e.limit<5?5:e.limit>100?100:e.limit};return e.selector.args.forEach(function(e){var i=e.args[0];switch(i){case"division":case"subdivision":n[i]=e.args[1],("division"===i?s:o).get(n[i])||(n[i]="");break;case"date":n.date=t(e.args[1]).format("YYYY-MM-DD");break;case"shift":n.shift=parseInt(e.args[1],10),(n.shift<0||n.shift>3)&&(n.shift=0)}}),n},changeFilter:function(){var n=this.model.rqlQuery,i=[],r=this.orgUnitDropdownsView.$id("division").val(),s=this.orgUnitDropdownsView.$id("subdivision").val(),o=t(this.$id("date").val()),a=parseInt(this.$("input[name=shift]:checked").val(),10);e.isEmpty(s)?e.isEmpty(r)||i.push({name:"eq",args:["division",r]}):i.push({name:"eq",args:["subdivision",s]}),o.isValid()&&i.push({name:"eq",args:["date",o.valueOf()]}),a>0&&i.push({name:"eq",args:["shift",a]}),n.selector={name:"and",args:i},n.limit=parseInt(this.$id("limit").val(),10)||15,n.skip=0,this.trigger("filterChanged",n)}})});