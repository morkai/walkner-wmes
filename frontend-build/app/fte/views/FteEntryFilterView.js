define(["underscore","js2form","app/i18n","app/user","app/time","app/data/divisions","app/data/subdivisions","app/data/views/OrgUnitDropdownsView","app/core/Model","app/core/View","app/fte/templates/filter"],function(e,t,n,i,r,o,s,a,l,u,c){var d=a.ORG_UNIT;return u.extend({template:c,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("fteFilter"),this.orgUnitDropdownsView=new a({orgUnit:this.options.divisionOnly?d.DIVISION:d.SUBDIVISION,divisionFilter:this.options.divisionFilter||null,allowClear:!0,noGrid:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView)},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();t(this.el.querySelector(".filter-form"),e),this.listenToOnce(this.orgUnitDropdownsView,"afterRender",function(){var t=null,n=null;""!==e.subdivision?(n=d.SUBDIVISION,t=new l({subdivision:e.subdivision})):""!==e.division&&(n=d.DIVISION,t=new l({division:e.division})),this.orgUnitDropdownsView.selectValue(t,n)})},serializeRqlQuery:function(){var e=this.model.rqlQuery,t={division:"",subdivision:"",date:"",shift:0,limit:e.limit<5?5:e.limit>100?100:e.limit},n=this;return e.selector.args.forEach(function(e){if("eq"===e.name||"in"===e.name){var i=e.args[0];switch(i){case"division":case"subdivision":t[i]=e.args[1],("division"===i?o:s).get(t[i])||(t[i]="");break;case"date":if("in"===e.name)t.date=r.format(e.args[1][0],"YYYY-MM-DD");else{var a=r.getMoment(e.args[1]);t.date=a.format("YYYY-MM-DD"),t.shift=n.getShiftNoFromMoment(a)}break;case"shift":t.shift=e.args[1]}}}),t},changeFilter:function(){var t=this.model.rqlQuery,n=[],i=this.orgUnitDropdownsView.$id("division").val(),o=this.orgUnitDropdownsView.$id("subdivision").val(),s=r.getMoment(this.$id("date").val()),a=parseInt(this.$("input[name=shift]:checked").val(),10);if(this.setHoursByShiftNo(s,a),e.isEmpty(o)?e.isEmpty(i)||n.push({name:"eq",args:["division",i]}):n.push({name:"eq",args:["subdivision",o]}),s.isValid())if(0===a){var l=s.valueOf();n.push({name:"in",args:["date",[l+216e5,l+504e5,l+792e5]]})}else n.push({name:"eq",args:["date",s.valueOf()]});else 0!==a&&n.push({name:"eq",args:["shift",a]});t.selector={name:"and",args:n},t.limit=parseInt(this.$id("limit").val(),10)||15,t.skip=0,this.trigger("filterChanged",t)},getShiftNoFromMoment:function(e){var t=e.hours();return 6===t?1:14===t?2:22===t?3:0},setHoursByShiftNo:function(e,t){1===t?e.hours(6):2===t?e.hours(14):3===t?e.hours(22):e.hours(0)}})});