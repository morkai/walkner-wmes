// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/core/util/idAndLabel","app/data/orgUnits","app/data/prodFunctions","app/data/companies","app/settings/views/SettingsView","app/fte/templates/settings","app/fte/templates/structureRow"],function(t,e,i,r,u,s,n,c,a,d){"use strict";return c.extend({clientUrl:"#fte;settings",template:a,events:t.extend({"change #-structure-subdivision":function(t){t.removed&&this.updateStructure(t.removed.id),this.selectSubdivision(t.added?t.added.id:null)},"change #-structure-prodFunction":function(t){this.addProdFunction(t.added.id).find('[data-name="companies"]').select2("focus"),this.$(t.target).select2("data",null)},'change input[data-name="companies"]':function(){this.scheduleStructureUpdate()},'click .btn[data-structure-action="remove"]':function(t){var i=this.$(t.currentTarget).closest("tr"),r=this;i.fadeOut("fast",function(){e(this).remove(),r.recountStructureRows(),r.scheduleStructureUpdate()})},'click .btn[data-structure-action="up"]':function(t){var e=this.$(t.currentTarget),i=e.closest("tr"),r=i.prev();if(r.length)i.insertBefore(r);else{var u=i.parent().children();u.length>1&&i.insertAfter(u.last())}this.recountStructureRows(),this.scheduleStructureUpdate(),e.focus()},'click .btn[data-structure-action="down"]':function(t){var e=this.$(t.currentTarget),i=e.closest("tr"),r=i.next();if(r.length)i.insertAfter(r);else{var u=i.parent().children();u.length>1&&i.insertBefore(u.first())}this.recountStructureRows(),this.scheduleStructureUpdate(),e.focus()}},c.prototype.events),afterRender:function(){c.prototype.afterRender.call(this),this.$id("structure-subdivision").select2({placeholder:i("fte","settings:structure:subdivision:placeholder"),data:u.getAllByType("subdivision").map(function(t){return{id:t.id,text:t.get("division")+" \\ "+t.getLabel()}}).sort(function(t,e){return t.text.localeCompare(e.text)})}),this.$id("structure-prodFunction").select2({placeholder:i("fte","settings:structure:prodFunction:placeholder"),data:s.map(r)})},updateSettingField:function(e){if(/^fte\.structure/.test(e.id)){var i=e.id.split(".")[2];i!==this.$id("structure-subdivision").val()||t.isEqual(e.getValue(),this.serializeStructure())||this.recreateStructure()}},selectSubdivision:function(t){this.$id("structure-subdivision").select2("val",t),this.recreateStructure(),this.$id("structure-prodFunction").select2("focus")},clearStructure:function(){this.$id("structure").empty()},recreateStructure:function(){this.clearStructure();var e=this.settings.getValue("structure."+this.$id("structure-subdivision").val());t.forEach(e,function(t){this.addProdFunction(t.id,t.companies)},this)},addProdFunction:function(e,u){var c=s.get(e);if(c){var a=this.$id("structure"),o=a.find('[data-prod-function="'+e+'"]');return a.find('[data-prod-function="'+e+'"]').length?(o.find('[data-name="companies"]').select2("focus"),o):(a.append(d({idPrefix:this.idPrefix,no:a.children().length+1,prodFunction:r(c),companies:t.isArray(u)?u.join(","):""})),o=a.children().last(),o.find('[data-name="companies"]').select2({placeholder:i("fte","settings:structure:companies:placeholder"),multiple:!0,data:n.map(r)}),o)}},recountStructureRows:function(){this.$id("structure").find(".is-number").each(function(t){this.textContent=t+1+"."})},scheduleStructureUpdate:function(){this.timers.updateStructure&&clearTimeout(this.timers.updateStructure),this.timers.updateStructure=setTimeout(this.updateStructure.bind(this),1e3)},updateStructure:function(e){clearTimeout(this.timers.updateStructure),this.timers.updateStructure=null,e||(e=this.$id("structure-subdivision").val());var i=this.serializeStructure();t.isEmpty(e)||t.isEmpty(i)||this.updateSetting("fte.structure."+e,i)},serializeStructure:function(){var e={};return this.$id("structure").children().each(function(){var t={id:this.dataset.prodFunction,companies:this.querySelector('[data-name="companies"]').value.split(",")};t.companies.length&&(e[t.id]=t)}),t.values(e)}})});