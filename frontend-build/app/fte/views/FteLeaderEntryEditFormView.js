// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/user","app/core/View","app/core/util/onModelDeleted","app/fte/templates/leaderEntry","../util/fractions"],function(e,t,n,a,o,i,d,r){return o.extend({template:d,idPrefix:"leaderEntryForm",events:{"change .fte-leaderEntry-count":"updateCount","keyup .fte-leaderEntry-count":"updateCount","focus .fte-leaderEntry-count":function(e){var n=e.target,a=n.dataset;this.focused=[n.parentNode,n.parentNode.parentNode.children[0],this.theadEl.querySelector('.fte-leaderEntry-column-company[data-column="'+a.company+'"]'),this.theadEl.querySelector('.fte-leaderEntry-total-company[data-column="'+a.company+'"]')],void 0===n.dataset.division?this.focused.push.apply(this.focused,this.theadEl.querySelectorAll('.fte-leaderEntry-column-division[data-column^="'+a.company+'"]')):this.focused.push(this.theadEl.querySelector('.fte-leaderEntry-column-division[data-column="'+a.company+":"+a.division+'"]')),t(this.focused).addClass("is-focused")},"blur .fte-leaderEntry-count":function(){t(this.focused).removeClass("is-focused")}},remoteTopics:function(){var e={};return e["fte.leader.updated."+this.model.id]="onRemoteEdit",e["fte.leader.deleted"]="onModelDeleted",e},initialize:function(){this.focused=null,this.theadEl=null},destroy:function(){this.focused=null,this.theadEl=null},beforeRender:function(){this.stopListening(this.model,"change",this.render)},afterRender:function(){this.listenToOnce(this.model,"change",this.render),this.theadEl=this.el.getElementsByTagName("thead")[0],this.$(".fte-leaderEntry-count").first().select()},serialize:function(){return e.extend(this.model.serializeWithTotals(),{editable:!0,round:r.round})},focusNextInput:function(e){var t=e.closest("td").next("td");if(t.length)return t.find("input").select();var n=e.closest("tr").next();return n.length?n.find(".fte-leaderEntry-count").first().select():void this.el.querySelector(".fte-leaderEntry-count").select()},updateCount:function(e){if(13===e.which)return this.focusNextInput(this.$(e.target));var t=e.target.dataset,n=r.parse(t.value)||0,a=r.parse(e.target.value)||0;if(n!==a){var o=t.task+":"+t.company+":"+t.division;this.timers[o]&&clearTimeout(this.timers[o]),this.timers[o]=setTimeout(this.doUpdateCount.bind(this),250,e.target,o,n,a)}},doUpdateCount:function(e,t,n,a){delete this.timers[t];var o=e.dataset,i=o.remote,d={socketId:this.socket.getId(),_id:this.model.id,newCount:a,taskIndex:parseInt(o.task,10),companyIndex:parseInt(o.company,10)},r=parseInt(o.division,10);isNaN(r)||(d.divisionIndex=r),o.value=d.newCount,o.remote="false";var s=this;this.socket.emit("fte.leader.updateCount",d,function(t){t&&("true"!==o.remote&&(e.value=n,o.value=n,o.remote=i,s.recount(e,d.taskIndex,d.companyIndex),d.newCount=n,s.model.handleUpdateMessage(d,!0)),s.trigger("remoteError",t))}),this.recount(e,d.taskIndex,d.companyIndex),this.model.handleUpdateMessage(d,!0)},recount:function(e,t,n){var a=0,o=0,i=0,d=this.$(e).closest("tr");d.find(".fte-leaderEntry-count").each(function(){a+=r.parse(this.value)||0}),d.find(".fte-leaderEntry-total-task").text(r.round(a)),this.$(".fte-leaderEntry-count[data-company="+n+"]").each(function(){o+=r.parse(this.value)||0}),this.$(".fte-leaderEntry-total-company[data-column="+n+"]").text(r.round(o)),this.$(".fte-leaderEntry-total-company").each(function(){i+=r.parse(this.innerHTML)||0}),this.$(".fte-leaderEntry-total-overall").text(r.round(i))},onRemoteEdit:function(e){if(e.socketId!==this.socket.getId()){var t=".fte-leaderEntry-count[data-company="+e.companyIndex+"][data-task="+e.taskIndex+"]";"number"==typeof e.divisionIndex&&(t+='[data-division="'+e.divisionIndex+'"]');var n=this.$(t);0!==n.length&&(n.val(e.newCount),n.attr({"data-value":e.newCount,"data-remote":"true"}),this.recount(n[0],e.taskIndex,e.companyIndex),this.model.handleUpdateMessage(e,!0))}},onModelDeleted:function(e){i(this.broker,this.model,e)}})});