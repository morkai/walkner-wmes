// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/user","app/core/View","app/core/util/onModelDeleted","app/fte/templates/leaderEntry","app/fte/templates/focusInfoBar","../util/fractions","jquery.stickytableheaders"],function(t,e,n,a,o,i,s,r){return a.extend({template:i,events:{"change .fte-leaderEntry-count":"updateCount","keyup .fte-leaderEntry-count":"updateCount","keydown .fte-leaderEntry-count":function(t){return 13===t.which?(this.focusNextInput(this.$(t.target)),!1):void 0},"focus .fte-leaderEntry-count":function(t){var e=t.target,n=e.parentNode.parentNode,a=this.theadEl,o=e.dataset,i=o.function+":"+o.company;this.focused=[e.parentNode,n.children[0]],this.withFunctions?this.focused.push(a.querySelector('.fte-leaderEntry-column-prodFunction[data-column="'+o.function+'"]'),a.querySelector('.fte-leaderEntry-total-prodFunction[data-column="'+o.function+'"]'),a.querySelector('.fte-leaderEntry-column-company[data-column="'+i+'"]'),a.querySelector('.fte-leaderEntry-total-prodFunction-company[data-column="'+i+'"]')):this.focused.push(a.querySelector('.fte-leaderEntry-column-company[data-column="'+o.company+'"]'),a.querySelector('.fte-leaderEntry-total-company[data-column="'+o.company+'"]')),void 0===e.dataset.division?this.withFunctions?(this.focused.push(n.querySelector('.fte-leaderEntry-total-company-task[data-company="'+o.company+'"]')),this.focused.push.apply(this.focused,a.querySelectorAll('.fte-leaderEntry-column-division[data-column^="'+i+'"]')),this.focused.push.apply(this.focused,a.querySelectorAll('.fte-leaderEntry-total-prodFunction-division[data-column^="'+i+'"]'))):this.focused.push.apply(this.focused,a.querySelectorAll('.fte-leaderEntry-column-division[data-column^="'+o.company+'"]')):this.withFunctions?this.focused.push(n.querySelector('.fte-leaderEntry-total-company-task[data-company="'+o.company+'"][data-division="'+o.division+'"]'),a.querySelector('.fte-leaderEntry-column-division[data-column="'+i+":"+o.division+'"]'),a.querySelector('.fte-leaderEntry-total-prodFunction-division[data-column="'+i+":"+o.division+'"]')):this.focused.push(a.querySelector('.fte-leaderEntry-column-division[data-column="'+o.company+":"+o.division+'"]')),this.$(this.focused).addClass("is-focused"),this.showFocusInfoBar(t.target)},"blur .fte-leaderEntry-count":function(){this.$(this.focused).removeClass("is-focused"),this.hideFocusInfoBar()},"click .fte-leaderEntry-toggleComment":function(t){var e=this.$(t.currentTarget),n=e.closest("tr"),a=n.next();a.toggleClass("hidden"),n.toggleClass("has-visible-comment"),a.hasClass("hidden")?e.find(".fa").removeClass("fa-comment-o").addClass("fa-comment"):(e.find(".fa").removeClass("fa-comment").addClass("fa-comment-o"),a.find("textarea").focus())},"keyup textarea.fte-leaderEntry-comment":function(t){this.updateComment(t.target)},"change textarea.fte-leaderEntry-comment":function(t){this.doUpdateComment(t.target)}},remoteTopics:function(){var t={};return t["fte.leader.updated."+this.model.id]="onRemoteEdit",t["fte.leader.deleted"]="onModelDeleted",t},initialize:function(){this.focused=null,this.theadEl=null,this.withFunctions=!1},destroy:function(){this.$(".fte-leaderEntry").stickyTableHeaders("destroy"),e("body").removeClass("is-with-fte-focusInfoBar"),this.focused=null,this.theadEl=null},beforeRender:function(){this.stopListening(this.model,"change",this.render)},afterRender:function(){this.listenToOnce(this.model,"change",this.render),this.theadEl=this.el.getElementsByTagName("thead")[0],this.withFunctions=this.model.isWithFunctions(),this.withDivisions=this.model.isWithDivisions(),this.$focusInfoBar=e('<div class="fte-focusInfoBar"></div>').hide().appendTo(this.$el),this.$(".fte-leaderEntry-count").first().select()},serialize:function(){return t.extend(this.model.serializeWithTotals(),{editable:!0,round:r.round})},focusNextInput:function(t){var e=t.closest("td").next("td");if(e.length&&!e.hasClass("fte-leaderEntry-actions"))return this.scrollIntoView(e.find("input").select()[0]);for(var n=t.closest("tr").next();n.length;){if(!n.hasClass("is-parent")&&!n.hasClass("fte-leaderEntry-comment"))return this.scrollIntoView(n.find(".fte-leaderEntry-count").first().select()[0]);n=n.next()}var a=this.el.querySelector(".fte-leaderEntry-count");a.select(),this.scrollIntoView(a)},scrollIntoView:function(t){t.scrollIntoViewIfNeeded?t.scrollIntoViewIfNeeded():t.scrollIntoView(!0)},updateCount:function(t){var e=t.target.dataset,n=r.parse(e.value)||0,a=r.parse(t.target.value)||0;if(n!==a){var o=e.task+":"+e.function+":"+e.company+":"+e.division;this.timers[o]&&clearTimeout(this.timers[o]),this.timers[o]=setTimeout(this.doUpdateCount.bind(this),250,t.target,o,n,a)}},doUpdateCount:function(t,e,n,a){delete this.timers[e];var o=t.dataset,i=o.remote,s={socketId:this.socket.getId(),_id:this.model.id,newCount:a,taskIndex:parseInt(o.task,10),functionIndex:parseInt(o.function,10)||0,companyIndex:parseInt(o.company,10),companyIndexServer:parseInt(o.companyServer,10)},r=parseInt(o.division,10);isNaN(r)||(s.divisionIndex=r),o.value=s.newCount,o.remote="false";var d=this;this.socket.emit("fte.leader.updateCount",s,function(e){e&&("true"!==o.remote&&(t.value=n,o.value=n,o.remote=i,d.recount(t,s.taskIndex,s.functionIndex,s.companyIndex),s.newCount=n,d.model.handleUpdateMessage(s,!0)),d.trigger("remoteError",e))}),this.recount(t,s.taskIndex,s.functionIndex,s.companyIndex),this.model.handleUpdateMessage(s,!0)},recount:function(t,e,n,a){if(this.withFunctions)return this.recountWithFunctions(t,e,n,a);var o=0,i=0,s=0,d=this.$(t).closest("tr");d.find(".fte-leaderEntry-count").each(function(){o+=r.parse(this.value)}),d.find(".fte-leaderEntry-total-task").text(r.round(o)),this.$(".fte-leaderEntry-count[data-company="+a+"]").each(function(){i+=r.parse(this.value)}),this.$(".fte-leaderEntry-total-company[data-column="+a+"]").text(r.round(i)),this.$(".fte-leaderEntry-total-company").each(function(){s+=r.parse(this.innerHTML)}),this.$(".fte-leaderEntry-total-overall").text(r.round(s))},recountWithFunctions:function(t,e,n,a){var o=this.$(t).closest("tr"),i=o.hasClass("is-child"),s=null,r=[],d=parseInt(t.dataset.division,10);if(isNaN(d)&&(d=-1),i){for(s=o.prev().prev();s.length&&s.hasClass("is-child");)s=s.prev().prev();for(var c=s.next().next();c.length&&c.hasClass("is-child");)r.push(c),c=c.next().next()}var l=this.recalcTaskCompanyTotals(a,d,o);i&&this.recalcParentTotals(l,n,s,r),this.withDivisions&&this.recalcDivisionTotals(n,a),this.recalcCompanyTotals(n,a),this.recalcFunctionTotals(n)},recalcTaskCompanyTotals:function(t,e,n){var a=0,o='[data-company="'+t+'"]';return-1!==e&&(o+='[data-division="'+e+'"]'),n.find(".fte-leaderEntry-count"+o).each(function(){a+=r.parse(this.value)}),n.find(".fte-leaderEntry-total-company-task"+o).text(r.round(a)),o},recalcParentTotals:function(t,e,n,a){var o=0,i=t+'[data-function="'+e+'"]';a.forEach(function(t){o+=r.parse(t.find(".fte-leaderEntry-count"+i).val())}),n.find(".fte-leaderEntry-parent-count"+i).text(r.round(o));var s=0;n.find(".fte-leaderEntry-parent-count"+t).each(function(){s+=r.parse(this.innerText)}),n.find(".fte-leaderEntry-total-company-task"+t).text(r.round(s))},recalcDivisionTotals:function(t,n){var a=this,o=this.model.get("fteDiv"),i='[data-function="'+t+'"][data-company="'+n+'"]',s={};o.forEach(function(t){s[t]=0}),this.$(".fte-leaderEntry-parent-count"+i).each(function(){var t=r.parse(this.innerText);void 0===this.dataset.division?(t/=o.length,o.forEach(function(e){s[e]+=t})):s[o[this.dataset.division]]+=t}),this.$("is-single .fte-leaderEntry-count"+i).each(function(){var t=r.parse(this.value);void 0===this.dataset.division?(t/=o.length,o.forEach(function(e){s[e]+=t})):s[o[this.dataset.division]]+=t}),o.forEach(function(e,o){var i=t+":"+n+":"+o,d='.fte-leaderEntry-total-prodFunction-division[data-column="'+i+'"]';a.$(d).text(r.round(s[e]))});var d={};e(this.theadEl).find(".fte-leaderEntry-total-prodFunction-division").each(function(){var t=this.dataset.company+":"+this.dataset.division;void 0===d[t]&&(d[t]=0),d[t]+=r.parse(this.innerText)}),Object.keys(d).forEach(function(t){a.$('.fte-leaderEntry-total-division[data-column="'+t+'"]').text(r.round(d[t]))})},recalcCompanyTotals:function(t,e){var n,a=0,o=t+":"+e,i=this.$(this.theadEl);this.withDivisions?(n='[data-column^="'+o+'"]',i.find(".fte-leaderEntry-total-prodFunction-division"+n).each(function(){a+=r.parse(this.innerText)})):(n='[data-function="'+t+'"][data-company="'+e+'"]',this.$(".fte-leaderEntry-count"+n).each(function(){a+=r.parse(this.value)})),this.$('.fte-leaderEntry-total-prodFunction-company[data-column="'+o+'"]').text(r.round(a));var s=0;i.find('.fte-leaderEntry-total-prodFunction-company[data-company="'+e+'"]').each(function(){s+=r.parse(this.innerText)}),this.$('.fte-leaderEntry-total-company[data-company="'+e+'"]').text(r.round(s))},recalcFunctionTotals:function(t){var e=0,n=this.$(this.theadEl);n.find('.fte-leaderEntry-total-prodFunction-company[data-function="'+t+'"]').each(function(){e+=r.parse(this.innerText)}),this.$('.fte-leaderEntry-total-prodFunction[data-column="'+t+'"]').text(r.round(e));var a=0;n.find(".fte-leaderEntry-total-prodFunction").each(function(){a+=r.parse(this.innerText)}),this.$(".fte-leaderEntry-total").text(r.round(a))},onRemoteEdit:function(t){if(t.socketId!==this.socket.getId()){if(void 0!==t.comment)return this.onRemoteCommentEdit(t);var e=".fte-leaderEntry-count[data-company="+t.companyIndex+"][data-task="+t.taskIndex+"]";this.withFunctions&&(e+='[data-function="'+t.functionIndex+'"]'),"number"==typeof t.divisionIndex&&(e+='[data-division="'+t.divisionIndex+'"]');var n=this.$(e);0!==n.length&&(n.val(t.newCount),n.attr({"data-value":t.newCount,"data-remote":"true"}),this.recount(n[0],t.taskIndex,t.functionIndex,t.companyIndex),this.model.handleUpdateMessage(t,!0))}},onRemoteCommentEdit:function(t){var e=this.$('textarea.fte-leaderEntry-comment[data-task="'+t.taskIndex+'"]');if(e.length){e.val(t.comment);var n=e.closest("tr"),a=n.prev(),o=a.find(".fte-leaderEntry-toggleComment > .fa");e.comment?(n.addClass("hidden"),a.removeClass("has-visible-comment"),o.removeClass("fa-comment-o").addClass("fa-comment")):(n.removeClass("hidden"),a.addClass("has-visible-comment"),o.removeClass("fa-comment").addClass("fa-comment-o")),this.model.handleUpdateMessage(t,!0)}},onModelDeleted:function(t){o(this.broker,this.model,t)},showFocusInfoBar:function(t){null!==this.timers.hideFocusInfoBar&&(clearTimeout(this.timers.hideFocusInfoBar),this.timers.hideFocusInfoBar=null);var n=t.parentNode.parentNode,a=n.children[0].innerText;if(n.classList.contains("is-child")){for(var o=n.previousElementSibling.previousElementSibling;o&&o.classList.contains("is-child");)o=o.previousElementSibling.previousElementSibling;a=o.children[0].innerText+" \\ "+a.substr(1)}var i=t.dataset.function,r=t.dataset.company,d=t.dataset.division,c=i+":"+r,l='.fte-leaderEntry-column-prodFunction[data-column="'+i+'"]',u='.fte-leaderEntry-column-company[data-column="'+c+'"]',h=void 0===d?null:'.fte-leaderEntry-column-division[data-column="'+c+":"+d+'"]';this.$focusInfoBar.html(s({prodTask:a,prodFunction:this.theadEl.querySelector(l).innerText,company:this.theadEl.querySelector(u).innerText,division:h?this.theadEl.querySelector(h).innerText:null})),e("body").addClass("is-with-fte-focusInfoBar"),this.$focusInfoBar.fadeIn("fast")},hideFocusInfoBar:function(){var t=this;this.timers.hideFocusInfoBar=setTimeout(function(){t.timers&&(t.timers.hideFocusInfoBar=null,t.$focusInfoBar.fadeOut("fast",function(){e("body").removeClass("is-with-fte-focusInfoBar")}))},1)},updateComment:function(t){var e=parseInt(t.dataset.task,10),n="updateComment"+e;this.timers[n]&&clearTimeout(this.timers[n]),this.timers[n]=setTimeout(this.doUpdateComment.bind(this),5e3,t)},doUpdateComment:function(t){var e=parseInt(t.dataset.task,10),n="updateComment"+e;this.timers[n]&&(clearTimeout(this.timers[n]),delete this.timers[n]),this.socket.emit("fte.leader.updateComment",{socketId:this.socket.getId(),_id:this.model.id,taskIndex:e,comment:t.value})}})});