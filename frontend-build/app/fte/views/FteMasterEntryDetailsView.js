// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/core/View","app/core/util/onModelDeleted","app/fte/templates/masterEntry","app/fte/templates/absentUserRow","../util/fractions"],function(t,e,n,i,o,s,a){"use strict";return n.extend({template:o,remoteTopics:function(){var t={};return t["fte.master.updated."+this.model.id]="onModelUpdated",t["fte.master.deleted"]="onModelDeleted",t},events:{"click .fte-count-container":function(t){this.showCountEditor(this.$(t.currentTarget).attr("data-key"))},"blur #-countEditor":function(){this.saveCountEdit()},"keydown #-countEditor":function(t){13===t.keyCode?this.$id("countEditor").blur():27===t.keyCode&&this.hideCountEditor()}},initialize:function(){this.changing=!1,this.changeKey=null,this.pendingChanges={}},serialize:function(){return t.extend(this.model.serializeWithTotals(),{idPrefix:this.idPrefix,editable:!1,renderAbsentUserRow:s,round:a.round})},beforeRender:function(){this.stopListening(this.model,"change",this.render)},afterRender:function(){this.listenToOnce(this.model,"change",this.render);var e=this.$(".fte-masterEntry-absence-entries"),n=this.$(".fte-masterEntry-absence-noEntries");e.children().length?n.hide():e.hide(),t.forEach(this.pendingChanges,function(t,e){this.renderPendingChange(e)},this)},onModelUpdated:function(t){this.model.handleUpdateMessage(t)},onModelDeleted:function(t){i(this.broker,this.model,t)},toggleCountEditing:function(e){var n=this.$id("comment"),i=n.val(),o=this.pendingChanges;return this.pendingChanges={},this.changing=e,e?n.focus():this.resetCountEditing(),{comment:i,changes:t.values(o)}},resetCountEditing:function(){this.hideCountEditor(),this.$(".fte-count.is-changed").removeClass("is-changed").each(function(){this.textContent=this.dataset.oldValue}),this.$id("comment").val("")},showCountEditor:function(t){if(this.changing){this.hideCountEditor(),this.changeKey=t;var n=this.pendingChanges[t],i=this.getCountByKey(t),o=e("<input>").attr({id:this.idPrefix+"-countEditor","class":"form-control no-controls fte-count-editor",type:"number",min:0,max:9999,value:n?n.newValue:i,"data-old-value":i});o.appendTo(this.$id("entryPanel")).select(),this.positionCountEditor()}},positionCountEditor:function(t){t||(t=this.getCountContainerByKey(this.changeKey));var e=t.position();this.$id("countEditor").css({position:"absolute",top:e.top+"px",left:e.left+"px",width:t.outerWidth()+1+"px",height:t.outerHeight()+1+"px"})},hideCountEditor:function(){this.$id("countEditor").remove(),this.changeKey=null},getCountContainerByKey:function(t){return this.$('.fte-count-container[data-key="'+t+'"]')},getCountByKey:function(t){var e=t.split(":").map(Number),n=+e[0],i=+e[1],o=+e[2],s=this.model.get("tasks");return s&&s[n]&&s[n].functions[i]&&s[n].functions[i].companies[o]?s[n].functions[i].companies[o].count:0},saveCountEdit:function(){delete this.pendingChanges[this.changeKey];var t=this.$id("countEditor"),e=+t.attr("data-old-value"),n=+t.val();(isNaN(n)||0>n)&&(n=0),n!==e&&(this.pendingChanges[this.changeKey]=this.createPendingChange(e,n)),this.renderPendingChange(this.changeKey),this.hideCountEditor()},createPendingChange:function(t,e){var n=this.changeKey.split(":"),i=+n[0],o=+n[1],s=+n[2],a=this.model.get("tasks"),d=a[i],r=d.functions[o],h=r.companies[s];return{taskIndex:i,taskId:d.id,taskName:d.name,functionIndex:o,functionId:r.id,companyIndex:s,companyId:h.id,oldValue:t,newValue:e}},renderPendingChange:function(t){var e=this.getCountContainerByKey(t),n=e.find(".fte-count"),i=this.pendingChanges[t],o="?";if(i){var s=a.round(i.oldValue);o=s+' <i class="fa fa-arrow-right"></i> '+a.round(i.newValue),n.addClass("is-changed").attr("data-old-value",s)}else o=a.round(this.getCountByKey(t)),n.removeClass("is-changed");n.html(o)}})});