// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/core/util/onModelDeleted","app/fte/templates/masterEntry","app/fte/templates/absentUserRow","../util/fractions"],function(e,t,n,i,o,a,d){"use strict";return n.extend({template:o,remoteTopics:function(){var e={};return e["fte.master.updated."+this.model.id]="onModelUpdated",e["fte.master.deleted"]="onModelDeleted",e},events:{"click .fte-count-container":function(e){this.showCountEditor(this.$(e.currentTarget).attr("data-key"))},"blur #-countEditor":function(){this.saveCountEdit()},"keydown #-countEditor":function(e){13===e.keyCode?this.$id("countEditor").blur():27===e.keyCode&&this.hideCountEditor()}},initialize:function(){this.changing=!1,this.changeKey=null,this.pendingChanges={}},serialize:function(){return e.extend(this.model.serializeWithTotals(),{idPrefix:this.idPrefix,editable:!1,renderAbsentUserRow:a,round:d.round})},beforeRender:function(){this.stopListening(this.model,"change",this.render)},afterRender:function(){this.listenToOnce(this.model,"change",this.render);var t=this.$(".fte-masterEntry-absence-entries"),n=this.$(".fte-masterEntry-absence-noEntries");t.children().length?n.hide():t.hide(),e.forEach(this.pendingChanges,function(e,t){this.renderPendingChange(t)},this)},onModelUpdated:function(e){this.model.handleUpdateMessage(e)},onModelDeleted:function(e){i(this.broker,this.model,e)},toggleCountEditing:function(t){var n=this.$id("comment"),i=n.val(),o=this.pendingChanges;return this.pendingChanges={},this.changing=t,t?n.focus():this.resetCountEditing(),{comment:i,changes:e.values(o)}},resetCountEditing:function(){this.hideCountEditor(),this.$(".fte-count.is-changed").removeClass("is-changed").each(function(){this.textContent=this.dataset.oldValue}),this.$id("comment").val("")},showCountEditor:function(e){if(this.changing){this.hideCountEditor(),this.changeKey=e;var n=this.pendingChanges[e],i=this.getCountByKey(e),o=t("<input>").attr({id:this.idPrefix+"-countEditor",class:"form-control no-controls fte-count-editor",type:"number",min:0,max:9999,value:n?n.newValue:i,"data-old-value":i});o.appendTo(this.$id("entryPanel")).select(),this.positionCountEditor()}},positionCountEditor:function(e){e||(e=this.getCountContainerByKey(this.changeKey));var t=e.position();this.$id("countEditor").css({position:"absolute",top:t.top+"px",left:t.left+"px",width:e.outerWidth()+1+"px",height:e.outerHeight()+1+"px"})},hideCountEditor:function(){this.$id("countEditor").remove(),this.changeKey=null},getCountContainerByKey:function(e){return this.$('.fte-count-container[data-key="'+e+'"]')},getCountByKey:function(e){var t,n,i,o=e.split(":"),a=this.model.get("tasks");return"demand"===o[0]?(t=+o[1],i=+o[2],a&&a[t]&&a[t].demand&&a[t].demand[i]?a[t].demand[i].count:0):(t=+o[0],n=+o[1],i=+o[2],a&&a[t]&&a[t].functions[n]&&a[t].functions[n].companies[i]?a[t].functions[n].companies[i].count:0)},saveCountEdit:function(){delete this.pendingChanges[this.changeKey];var e=this.$id("countEditor"),t=+e.attr("data-old-value"),n=+e.val();(isNaN(n)||n<0)&&(n=0),n!==t&&(this.pendingChanges[this.changeKey]=this.createPendingChange(t,n)),this.renderPendingChange(this.changeKey),this.hideCountEditor()},createPendingChange:function(e,t){var n=this.changeKey.split(":");return"demand"===n[0]?this.createPendingDemandChange(e,t,n):this.createPendingSupplyChange(e,t,n)},createPendingDemandChange:function(e,t,n){var i=+n[1],o=+n[2],a=this.model.get("tasks"),d=a[i],s=d.demand[o];return{demand:!0,taskIndex:i,taskId:d.id,taskName:d.name,companyIndex:o,companyId:s.id,oldValue:e,newValue:t}},createPendingSupplyChange:function(e,t,n){var i=+n[0],o=+n[1],a=+n[2],d=this.model.get("tasks"),s=d[i],r=s.functions[o],h=r.companies[a];return{demand:!1,taskIndex:i,taskId:s.id,taskName:s.name,functionIndex:o,functionId:r.id,companyIndex:a,companyId:h.id,oldValue:e,newValue:t}},renderPendingChange:function(e){var t=this.getCountContainerByKey(e),n=t.find(".fte-count"),i=this.pendingChanges[e],o="?";if(i){var a=d.round(i.oldValue);o=a+' <i class="fa fa-arrow-right"></i> '+d.round(i.newValue),n.addClass("is-changed").attr("data-old-value",a)}else o=d.round(this.getCountByKey(e)),n.removeClass("is-changed");n.html(o)}})});