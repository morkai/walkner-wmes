define(["app/i18n","app/viewport","app/user","app/data/divisions","app/data/subdivisions","app/data/views/OrgUnitDropdownsView","app/core/Model","app/core/View","app/fte/templates/currentEntry","i18n!app/nls/fte"],function(e,t,n,i,r,s,o,a,l){var c=s.ORG_UNIT;return a.extend({template:l,idPrefix:"currentEntry",events:{"click .btn-primary":"onSubmit"},initialize:function(){this.readonlyDivision=!1,this.$submit=null,this.oudView=new s({orgUnit:c.SUBDIVISION,allowClear:!0,noGrid:!0}),this.setView(".orgUnitDropdowns-container",this.oudView)},destroy:function(){null!==this.$submit&&(this.$submit.remove(),this.$submit=null)},afterRender:function(){var e=this,t=n.getDivision(),i=n.getSubdivision();this.$submit=this.$(".btn-primary").attr("disabled",!0),this.listenToOnce(this.oudView,"afterRender",function(){e.oudView.$id("subdivision").on("change",function(t){e.$submit.attr("disabled",""===t.val||null===t.val)});var r=null,s=null;null!==i?(s=c.SUBDIVISION,r=new o({subdivision:i.id})):null!==t&&(s=c.DIVISION,r=new o({division:t.id})),e.oudView.selectValue(r,s),e.readonlyDivision=!(n.isAllowedTo(e.model.getPrivilegePrefix()+":ALL")&&!t),e.oudView.$id("division").select2("readonly",e.readonlyDivision),e.oudView.$id(e.readonlyDivision?"subdivision":"division").select2("focus")})},onSubmit:function(){if(!this.socket.isConnected())return t.msg.show({type:"error",time:5e3,text:e(this.model.getNlsDomain(),"currentEntry:msg:offline")});var n=this,i=this.oudView.$id("division"),r=this.oudView.$id("subdivision"),s=this.$submit.find("i").removeClass("fa-edit").addClass("fa-spinner fa-spin");i.select2("readonly",!0),r.select2("readonly",!0),this.$submit.attr("disabled",!0),this.socket.emit(this.model.getTopicPrefix()+".getCurrentEntryId",r.select2("val"),function(o,a){return a&&n.model.set("_id",a),o?"LOCKED"===o.message?n.broker.publish("router.navigate",{url:n.model.genClientUrl(),trigger:!0}):(s.removeClass("fa-spinner fa-spin").addClass("fa-edit"),i.select2("readonly",n.readonlyDivision),r.select2("readonly",!1),n.$submit.attr("disabled",!1).focus(),console.error(o),t.msg.show({type:"error",time:5e3,text:e(n.model.getNlsDomain(),"currentEntry:msg:failure")})):(n.broker.publish("router.navigate",{url:n.model.genClientUrl("edit"),trigger:!0}),void 0)})}})});