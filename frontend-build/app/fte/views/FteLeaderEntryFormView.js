define(["underscore","moment","app/i18n","app/user","app/core/View","app/fte/templates/leaderEntry","./fractionsUtil"],function(e,t,n,i,r,o,s){return r.extend({template:o,idPrefix:"leaderEntryForm",events:{"change .fte-leaderEntry-count":"updateCount","keyup .fte-leaderEntry-count":"updateCount"},initialize:function(){var e=this;this.listenToOnce(this.model,"sync",function(){var t=e.redirectToDetails.bind(e);e.pubsub.subscribe("fte.leader.updated."+e.model.id,e.onRemoteEdit.bind(e)),e.pubsub.subscribe("fte.leader.locked."+e.model.id,t),e.pubsub.subscribe("shiftChanged",t)})},afterRender:function(){this.listenToOnce(this.model,"change",this.render),this.$(".fte-leaderEntry-count").first().select(),this.model.get("locked")&&this.broker.publish("router.navigate",{url:this.model.genClientUrl(),replace:!0,trigger:!0})},serialize:function(){return e.extend(this.model.serializeWithTotals(),{editable:!0,round:s.round})},focusNextInput:function(e){var t=e.closest("td").next("td");if(t.length)return t.find("input").select();var n=e.closest("tr").next();return n.length?n.find(".fte-leaderEntry-count").first().select():(this.el.querySelector(".fte-leaderEntry-count").select(),void 0)},updateCount:function(e){if(13===e.which)return this.focusNextInput(this.$(e.target));var t=s.parse(e.target.getAttribute("data-value"))||0,n=s.parse(e.target.value)||0;if(t!==n){var i=e.target.getAttribute("data-task")+":"+e.target.getAttribute("data-company")+":"+e.target.getAttribute("data-division");this.timers[i]&&clearTimeout(this.timers[i]),this.timers[i]=setTimeout(this.doUpdateCount.bind(this),250,e.target,i,t,n)}},doUpdateCount:function(e,t,n,i){delete this.timers[t];var r=e.getAttribute("data-remote"),o={socketId:this.socket.getId(),_id:this.model.id,newCount:i,taskIndex:parseInt(e.getAttribute("data-task"),10),companyIndex:parseInt(e.getAttribute("data-company"),10)},s=parseInt(e.getAttribute("data-division"),10);isNaN(s)||(o.divisionIndex=s),e.setAttribute("data-value",o.newCount),e.setAttribute("data-remote","false");var a=this;this.socket.emit("fte.leader.updateCount",o,function(t){t&&(console.error(t),"true"!==e.getAttribute("data-remote")&&(e.value=n,e.setAttribute("data-value",n),e.setAttribute("data-remote",r),a.recount(e,o.taskIndex,o.companyIndex)))}),this.recount(e,o.taskIndex,o.companyIndex)},recount:function(e,t,n){var i=0,r=0,o=0,a=this.$(e).closest("tr");a.find(".fte-leaderEntry-count").each(function(){i+=s.parse(this.value)||0}),a.find(".fte-leaderEntry-total-task").text(s.round(i)),this.$(".fte-leaderEntry-count[data-company="+n+"]").each(function(){r+=s.parse(this.value)||0}),this.$(".fte-leaderEntry-total-company[data-company="+n+"]").text(s.round(r)),this.$(".fte-leaderEntry-total-company").each(function(){o+=s.parse(this.innerHTML)||0}),this.$(".fte-leaderEntry-total-overall").text(s.round(o))},onRemoteEdit:function(e){if(e.socketId!==this.socket.getId()){var t=".fte-leaderEntry-count[data-company="+e.companyIndex+"]"+"[data-task="+e.taskIndex+"]";"number"==typeof e.divisionIndex&&(t+='[data-division="'+e.divisionIndex+'"]');var n=this.$(t);0!==n.length&&(n.val(e.newCount),n.attr({"data-value":e.newCount,"data-remote":"true"}),this.recount(n[0],e.taskIndex,e.companyIndex))}},redirectToDetails:function(){this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!0})}})});