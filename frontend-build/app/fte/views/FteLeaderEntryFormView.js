define(["underscore","moment","app/i18n","app/user","app/core/View","app/fte/templates/leaderEntry","./fractionsUtil"],function(t,e,n,a,i,r,o){return i.extend({template:r,idPrefix:"leaderEntryForm",events:{"change .fte-leaderEntry-count":"updateCount","keyup .fte-leaderEntry-count":"updateCount"},initialize:function(){var t=this;this.listenToOnce(this.model,"sync",function(){var e=t.redirectToDetails.bind(t);t.pubsub.subscribe("fte.leader.updated."+t.model.id,t.onRemoteEdit.bind(t)),t.pubsub.subscribe("fte.leader.locked."+t.model.id,e),t.pubsub.subscribe("shiftChanged",e)})},afterRender:function(){this.listenToOnce(this.model,"change",this.render),this.$(".fte-leaderEntry-count").first().select(),this.model.get("locked")&&this.broker.publish("router.navigate",{url:this.model.genClientUrl(),replace:!0,trigger:!0})},serialize:function(){return t.extend(this.model.serializeWithTotals(),{editable:!0,round:o.round})},focusNextInput:function(t){var e=t.closest("td").next("td");if(e.length)return e.find("input").select();var n=t.closest("tr").next();return n.length?n.find(".fte-leaderEntry-count").first().select():void this.el.querySelector(".fte-leaderEntry-count").select()},updateCount:function(t){if(13===t.which)return this.focusNextInput(this.$(t.target));var e=o.parse(t.target.getAttribute("data-value"))||0,n=o.parse(t.target.value)||0;if(e!==n){var a=t.target.getAttribute("data-task")+":"+t.target.getAttribute("data-company")+":"+t.target.getAttribute("data-division");this.timers[a]&&clearTimeout(this.timers[a]),this.timers[a]=setTimeout(this.doUpdateCount.bind(this),250,t.target,a,e,n)}},doUpdateCount:function(t,e,n,a){delete this.timers[e];var i=t.getAttribute("data-remote"),r={socketId:this.socket.getId(),_id:this.model.id,newCount:a,taskIndex:parseInt(t.getAttribute("data-task"),10),companyIndex:parseInt(t.getAttribute("data-company"),10)},o=parseInt(t.getAttribute("data-division"),10);isNaN(o)||(r.divisionIndex=o),t.setAttribute("data-value",r.newCount),t.setAttribute("data-remote","false");var s=this;this.socket.emit("fte.leader.updateCount",r,function(e){e&&"true"!==t.getAttribute("data-remote")&&(t.value=n,t.setAttribute("data-value",n),t.setAttribute("data-remote",i),s.recount(t,r.taskIndex,r.companyIndex))}),this.recount(t,r.taskIndex,r.companyIndex)},recount:function(t,e,n){var a=0,i=0,r=0,s=this.$(t).closest("tr");s.find(".fte-leaderEntry-count").each(function(){a+=o.parse(this.value)||0}),s.find(".fte-leaderEntry-total-task").text(o.round(a)),this.$(".fte-leaderEntry-count[data-company="+n+"]").each(function(){i+=o.parse(this.value)||0}),this.$(".fte-leaderEntry-total-company[data-company="+n+"]").text(o.round(i)),this.$(".fte-leaderEntry-total-company").each(function(){r+=o.parse(this.innerHTML)||0}),this.$(".fte-leaderEntry-total-overall").text(o.round(r))},onRemoteEdit:function(t){if(t.socketId!==this.socket.getId()){var e=".fte-leaderEntry-count[data-company="+t.companyIndex+"][data-task="+t.taskIndex+"]";"number"==typeof t.divisionIndex&&(e+='[data-division="'+t.divisionIndex+'"]');var n=this.$(e);0!==n.length&&(n.val(t.newCount),n.attr({"data-value":t.newCount,"data-remote":"true"}),this.recount(n[0],t.taskIndex,t.companyIndex))}},redirectToDetails:function(){this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!0})}})});