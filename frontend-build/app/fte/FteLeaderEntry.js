// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../data/subdivisions","../data/prodFunctions","../orgUnits/util/renderOrgUnitPath","../core/Model","./util/isEditable"],function(t,i,n,e,o,a,s,r){"use strict";function c(t,i){var n=1-i;return[Math.round(t[0]*n),Math.round(t[1]*n),Math.round(t[2]*n)]}function u(t){return"rgb("+t+")"}var d=[[242,222,222],[217,237,247],[223,240,216],[252,248,227],[238,238,238],[254,229,254]];return s.extend({TYPE:"leader",urlRoot:"/fte/leader",clientUrlRoot:"#fte/leader",topicPrefix:"fte.leader",privilegePrefix:"FTE:LEADER",nlsDomain:"fte",getLabel:function(){return i(this.nlsDomain,"label",{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:i("core","SHIFT:"+this.get("shift"))})},getSubdivisionPath:function(){var t=e.get(this.get("subdivision"));return t?a(t,!1,!1):"?"},isWithFunctions:function(){var t=this.get("tasks");if(!t||!t.length)return!1;var i=t[0];return Array.isArray(i.functions)&&i.functions.length>0},isWithDivisions:function(){var t=this.get("fteDiv");return Array.isArray(t)&&t.length>0},serializeWithTotals:function(){return this.isWithFunctions()?this.serializeWithFunctions():this.serializeWithoutFunctions()},serializeWithFunctions:function(){var e={},a={total:0,byCompany:{},byProdFunction:{}},s=0,r=this.get("fteDiv")||[],c=this.get("tasks")[0];c&&c.functions.forEach(function(t){var i=o.get(t.id);a.byProdFunction[t.id]={name:i?i.getLabel():t.id,total:0,companies:{}},t.companies.forEach(function(i){e[i.id]||(e[i.id]={index:Object.keys(e).length,name:i.name}),a.byProdFunction[t.id].companies[i.id]={total:0,divisions:{}},a.byCompany[i.id]={total:0,divisions:{}},r.length||(s+=1),r.forEach(function(n){a.byProdFunction[t.id].companies[i.id].divisions[n]=0,a.byCompany[i.id].divisions[n]=0,s+=1})})});var u=Object.keys(e).length,d=this.serializeTasksWithFunctions(a,e),l=this.get("totals");return{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:i("core","SHIFT:"+this.get("shift")),divisions:r,companyCount:u,companies:e,demand:{columnCount:u+1,overallTotal:l.demand.total,totalByCompany:l.demand},supply:{columnCount:s+u*(r.length||1),overallTotal:a.total,totalByProdFunction:a.byProdFunction,totalByCompany:a.byCompany},shortage:{columnCount:u+1,overallTotal:l.shortage.total,totalByCompany:l.shortage},absence:{available:!t.isEmpty(this.get("absenceTasks")),overallTotal:l.absence.total,totalByCompany:l.absence},tasks:d}},serializeTasksWithFunctions:function(i,n){function e(t,i){h.push(t),t.level=i,t.children=l[t.id]||[],t.hasChildren=t.children.length>0,0===i&&++f,f===d.length&&(f=0),t.backgroundColor=u(c(d[f],.1*i)),t.hasChildren&&(t.children[t.children.length-1].lastChild=!0,t.children.forEach(function(t){e(t,i+1)}))}var o=this.get("fteDiv")||[],a=this.get("absenceTasks"),s=[],r={},l={};t.forEach(this.get("tasks"),function(e,c){e.index=c,e.fteDiv=!1,e.totalByCompany={},e.backgroundColor=null,e.level=0,e.last=!1,e.absence=a[e.id]>=0;var u=0===e.childCount;if(t.forEach(e.functions,function(a){t.forEach(a.companies,function(s){s.index=n[s.id].index,void 0===e.totalByCompany[s.id]&&(e.totalByCompany[s.id]={index:s.index,total:0,divisions:{}});var r=0,c=e.totalByCompany[s.id].divisions;if(Array.isArray(s.count))e.fteDiv=!0,t.forEach(s.count,function(t){r+=t.value,void 0===c[t.division]&&(c[t.division]=0),c[t.division]+=t.value,u&&!e.absence&&(i.byCompany[s.id].divisions[t.division]+=t.value,i.byProdFunction[a.id].companies[s.id].divisions[t.division]+=t.value)});else{r=s.count;var d=s.count/o.length;t.forEach(o,function(t){void 0===c[t]&&(c[t]=0),c[t]+=d,u&&!e.absence&&(i.byCompany[s.id].divisions[t]+=d,i.byProdFunction[a.id].companies[s.id].divisions[t]+=d)})}e.totalByCompany[s.id].total+=r,u&&!e.absence&&(i.total+=r,i.byCompany[s.id].total+=r,i.byProdFunction[a.id].total+=r,i.byProdFunction[a.id].companies[s.id].total+=r)})}),r[e.id]=e,!e.parent)return void s.push(e);l[e.parent]?l[e.parent].push(e):l[e.parent]=[e]});var h=[],f=-1;return s.forEach(function(t){e(t,0)}),h.length&&(h[h.length-1].last=!0),h},serializeWithoutFunctions:function(){var t=this.serializeCompanies();return{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:i("core","SHIFT:"+this.get("shift")),total:t.reduce(function(t,i){return t+i.total},0),totalByCompany:null,totalByProdFunction:null,companies:t,divisions:this.get("fteDiv")||[],tasks:this.serializeTasksWithoutFunctions()}},serializeCompanies:function(){var i=this.get("tasks");return i&&i.length?t.map(i[0].companies,function(t,n){return t.total=i.reduce(function(t,i){return Array.isArray(i.companies[n].count)?i.companies[n].count.forEach(function(i){t+=i.value}):t+=i.companies[n].count,t},0),t}):[]},serializeTasksWithoutFunctions:function(){return t.map(this.get("tasks"),function(t){return t.total=t.companies.reduce(function(t,i){return Array.isArray(i.count)?i.count.forEach(function(i){t+=i.value}):t+=i.count,t},0),t})},isEditable:function(t){return r(this,t)},handleUpdateMessage:function(t,i){"count"===t.type?this.handleCountMessage(t,i):"comment"===t.type?this.handleCommentMessage(t,i):"edit"===t.type&&this.handleEditMessage(t,i)},handleCountMessage:function(t,i){var n=this.get("tasks");if(n){n[t.taskIndex]&&(t.tasks.forEach(function(t,i){n[i]=t}),this.set(t.data,{silent:!!i}),i||(this.trigger("change:tasks"),this.trigger("change")))}},handleCommentMessage:function(t,i){var n=this.get("tasks");if(n){var e=n[t.taskIndex];e&&void 0!==t.comment&&(e.comment=t.comment,i||(this.trigger("change:tasks"),this.trigger("change")))}},handleEditMessage:function(t,i){var n=this.get("tasks");n&&(t.tasks.forEach(function(t){n[t.index]=t.data}),this.set(t.data,{silent:i}),i||(this.trigger("change:tasks"),this.trigger("change")))}})});