// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../time","../data/subdivisions","../data/prodFunctions","../data/views/renderOrgUnitPath","../core/Model","./util/isEditable"],function(i,t,n,e,s,o,a,r){return a.extend({urlRoot:"/fte/leader",clientUrlRoot:"#fte/leader",topicPrefix:"fte.leader",privilegePrefix:"FTE:LEADER",nlsDomain:"fte",defaults:{subdivision:null,date:null,shift:null,fteDiv:null,tasks:null,createdAt:null,creator:null,updatedAt:null,updater:null},getLabel:function(){return t(this.nlsDomain,"label",{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:t("core","SHIFT:"+this.get("shift"))})},getSubdivisionPath:function(){var i=e.get(this.get("subdivision"));return i?o(i,!1,!1):"?"},isWithFunctions:function(){var i=this.get("tasks"),t=i[0];return Array.isArray(t.functions)&&t.functions.length>0},isWithDivisions:function(){var i=this.get("fteDiv");return Array.isArray(i)&&i.length>0},serializeWithTotals:function(){return this.isWithFunctions()?this.serializeWithFunctions():this.serializeWithoutFunctions()},serializeWithFunctions:function(){var e={},s={};this.prepareTotalsWithFunctions(e,s);var o=this.serializeTasksWithFunctions(e,s),a=0;return i.forEach(e,function(i){a+=i.total}),{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:t("core","SHIFT:"+this.get("shift")),divisions:this.get("fteDiv")||[],companyCount:Object.keys(e).length,total:a,totalByCompany:e,totalByProdFunction:s,tasks:o}},prepareTotalsWithFunctions:function(t,n){var e=this.get("tasks");if(this.get("tasks").length){var o={},a=this.get("fteDiv")||[];i.forEach(e[0].functions,function(t){i.forEach(t.companies,function(i){void 0===o[i.id]&&(o[i.id]=Object.keys(o).length)})}),i.forEach(e[0].functions,function(e){var r=s.get(e.id);n[e.id]={prodFunction:r?r.getLabel():e.id,total:0,companies:{}},i.forEach(e.companies,function(s){var r=o[s.id];n[e.id].companies[s.id]={index:r,total:0,divisions:{}},t[s.id]={index:r,name:s.name,total:0,divisions:{}},i.forEach(a,function(i){n[e.id].companies[s.id].divisions[i]=0,t[s.id].divisions[i]=0})})})}},serializeTasksWithFunctions:function(t,n){var e=Object.keys(t),s=this.get("fteDiv")||[],o={};i.forEach(this.get("tasks"),function(a,r){a.index=r,a.fteDiv=!1,a.totalByCompany={};var u=0===a.childCount;i.forEach(a.functions,function(o){i.forEach(o.companies,function(r){r.index=e.indexOf(r.id),void 0===a.totalByCompany[r.id]&&(a.totalByCompany[r.id]={index:r.index,total:0,divisions:{}});var c=0;if(Array.isArray(r.count))a.fteDiv=!0,i.forEach(r.count,function(i){c+=i.value,a.totalByCompany[r.id].divisions[i.division]=i.value,u&&(t[r.id].divisions[i.division]+=i.value,n[o.id].companies[r.id].divisions[i.division]+=i.value)});else{c=r.count;var d=r.count/s.length;i.forEach(s,function(i){a.totalByCompany[r.id].divisions[i]=d,u&&(t[r.id].divisions[i]+=d,n[o.id].companies[r.id].divisions[i]+=d)})}a.totalByCompany[r.id].total+=c,u&&(t[r.id].total+=c,n[o.id].total+=c,n[o.id].companies[r.id].total+=c)})}),a.parent?(o[a.parent]||(o[a.parent]={parent:null,children:[]}),o[a.parent].children.push(a)):o[a.id]?o[a.id].parent||(o[a.id].parent=a):o[a.id]={parent:a,children:[]}});var a=[];return Object.keys(o).forEach(function(i){var t=o[i];t.parent.hasChildren=t.children.length>0,a.push(t.parent),a.push.apply(a,t.children),t.parent.hasChildren&&(t.children[t.children.length-1].lastChild=!0)}),a},serializeWithoutFunctions:function(){var i=this.serializeCompanies();return{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:t("core","SHIFT:"+this.get("shift")),total:i.reduce(function(i,t){return i+t.total},0),totalByCompany:null,totalByProdFunction:null,companies:i,divisions:this.get("fteDiv")||[],tasks:this.serializeTasksWithoutFunctions()}},serializeCompanies:function(){var t=this.get("tasks");return t.length?i.map(t[0].companies,function(i,n){return i.total=t.reduce(function(i,t){return Array.isArray(t.companies[n].count)?t.companies[n].count.forEach(function(t){i+=t.value}):i+=t.companies[n].count,i},0),i}):[]},serializeTasksWithoutFunctions:function(){return i.map(this.get("tasks"),function(i){return i.total=i.companies.reduce(function(i,t){return Array.isArray(t.count)?t.count.forEach(function(t){i+=t.value}):i+=t.count,i},0),i})},isEditable:function(i){return r(this,i)},handleUpdateMessage:function(i,t){var n=this.get("tasks");if(n){var e=n[i.taskIndex];if(e){if(void 0===i.comment){var s;if(this.isWithFunctions()){var o=e.functions[i.functionIndex];if(!o)return;s=o.companies[i.companyIndex]}else s=e.companies[i.companyIndex];if(!s)return;if("number"==typeof i.divisionIndex){var a=s.count[i.divisionIndex];if(!a)return;a.value=i.newCount}else s.count=i.newCount}else e.comment=i.comment;t||(this.trigger("change:tasks"),this.trigger("change"))}}}})});