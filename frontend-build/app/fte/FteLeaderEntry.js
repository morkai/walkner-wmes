// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["../i18n","../time","../data/subdivisions","../data/views/renderOrgUnitPath","../core/Model"],function(t,i,e,n,r){return r.extend({urlRoot:"/fte/leader",clientUrlRoot:"#fte/leader",topicPrefix:"fte.leader",privilegePrefix:"FTE:LEADER",nlsDomain:"fte",defaults:{subdivision:null,date:null,shift:null,fteDiv:null,tasks:null,createdAt:null,creator:null,updatedAt:null,updater:null},getLabel:function(){return t(this.nlsDomain,"label",{subdivision:this.getSubdivisionPath(),date:i.format(this.get("date"),"LL"),shift:t("core","SHIFT:"+this.get("shift"))})},getSubdivisionPath:function(){var t=e.get(this.get("subdivision"));return t?n(t,!1,!1):"?"},serializeWithTotals:function(){var e=this.serializeCompanies();return{subdivision:this.getSubdivisionPath(),date:i.format(this.get("date"),"LL"),shift:t("core","SHIFT:"+this.get("shift")),total:e.reduce(function(t,i){return t+i.total},0),companies:e,divisions:this.get("fteDiv")||[],tasks:this.serializeTasks()}},serializeCompanies:function(){var t=this.get("tasks");return t.length?t[0].companies.map(function(i,e){return i.total=t.reduce(function(t,i){return Array.isArray(i.companies[e].count)?i.companies[e].count.forEach(function(i){t+=i.value}):t+=i.companies[e].count,t},0),i}):[]},serializeTasks:function(){return this.get("tasks").map(function(t){return t.total=t.companies.reduce(function(t,i){return Array.isArray(i.count)?i.count.forEach(function(i){t+=i.value}):t+=i.count,t},0),t})},isEditable:function(t){if(t.isAllowedTo("PROD_DATA:MANAGE"))return!0;if(!t.isAllowedTo(this.privilegePrefix+":MANAGE"))return!1;var i=this.get("creator");if(i&&t.data._id!==i.id)return!1;var n=t.getDivision();if(!t.isAllowedTo(this.privilegePrefix+":ALL")&&n){var r=e.get(this.get("subdivision"));if(!r||r.get("division")!==n.id)return!1}var s=Date.parse(this.get("createdAt"));return Date.now()<s+288e5},handleUpdateMessage:function(t,i){var e=this.get("tasks");if(e){var n=e[t.taskIndex];if(n){var r=n.companies[t.companyIndex];if(r){if("number"==typeof t.divisionIndex){var s=r.count[t.divisionIndex];if(!s)return;s.value=t.newCount}else r.count=t.newCount;i||(this.trigger("change:tasks"),this.trigger("change"))}}}}})});