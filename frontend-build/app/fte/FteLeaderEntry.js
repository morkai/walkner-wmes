define(["underscore","../i18n","../time","../data/subdivisions","../data/prodFunctions","../orgUnits/util/renderOrgUnitPath","../core/Model","./util/isEditable"],function(t,i,n,e,o,a,s,r){"use strict";var c=[[242,222,222],[217,237,247],[223,240,216],[252,248,227],[238,238,238],[254,229,254]];return s.extend({TYPE:"leader",urlRoot:"/fte/leader",clientUrlRoot:"#fte/leader",topicPrefix:"fte.leader",privilegePrefix:"FTE:LEADER",nlsDomain:"fte",getLabel:function(){return i(this.nlsDomain,"label",{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:i("core","SHIFT:"+this.get("shift"))})},getSubdivisionPath:function(){var t=e.get(this.get("subdivision"));return t?a(t,!1,!1):"?"},isWithFunctions:function(){var t=this.get("tasks");if(!t||!t.length)return!1;var i=t[0];return Array.isArray(i.functions)&&i.functions.length>0},isWithDivisions:function(){var t=this.get("fteDiv");return Array.isArray(t)&&t.length>0},serializeWithTotals:function(){return this.isWithFunctions()?this.serializeWithFunctions():this.serializeWithoutFunctions()},serializeWithFunctions:function(){var e={},a={total:0,byCompany:{},byProdFunction:{}},s=0,r=this.get("fteDiv")||[],c=this.get("tasks")[0];c&&c.functions.forEach(function(t){var i=o.get(t.id);a.byProdFunction[t.id]={name:i?i.getLabel():t.id,total:0,companies:{}},t.companies.forEach(function(i){e[i.id]||(e[i.id]={index:Object.keys(e).length,name:i.name}),a.byProdFunction[t.id].companies[i.id]={total:0,divisions:{}},a.byCompany[i.id]={total:0,divisions:{}},r.length||(s+=1),r.forEach(function(n){a.byProdFunction[t.id].companies[i.id].divisions[n]=0,a.byCompany[i.id].divisions[n]=0,s+=1})})});var u=Object.keys(e).length,d=this.serializeTasksWithFunctions(a,e),l=this.get("totals");return{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:i("core","SHIFT:"+this.get("shift")),divisions:r,companyCount:u,companies:e,demand:{columnCount:u+1,overallTotal:l.demand.total,totalByCompany:l.demand},supply:{columnCount:s+u*(r.length||1),overallTotal:a.total,totalByProdFunction:a.byProdFunction,totalByCompany:a.byCompany},shortage:{columnCount:u+1,overallTotal:l.shortage.total,totalByCompany:l.shortage},absence:{available:!t.isEmpty(this.get("absenceTasks")),overallTotal:l.absence.total,totalByCompany:l.absence},tasks:d}},serializeTasksWithFunctions:function(i,n){var e=this.get("fteDiv")||[],o=this.get("absenceTasks"),a=[],s={},r={};t.forEach(this.get("tasks"),function(c,u){c.index=u,c.fteDiv=!1,c.totalByCompany={},c.backgroundColor=null,c.level=0,c.last=!1,c.absence=o[c.id]>=0;var d=0===c.childCount;t.forEach(c.functions,function(o){t.forEach(o.companies,function(a){a.index=n[a.id].index,void 0===c.totalByCompany[a.id]&&(c.totalByCompany[a.id]={index:a.index,total:0,divisions:{}});var s=0,r=c.totalByCompany[a.id].divisions;if(Array.isArray(a.count))c.fteDiv=!0,t.forEach(a.count,function(t){s+=t.value,void 0===r[t.division]&&(r[t.division]=0),r[t.division]+=t.value,d&&!c.absence&&(i.byCompany[a.id].divisions[t.division]+=t.value,i.byProdFunction[o.id].companies[a.id].divisions[t.division]+=t.value)});else{s=a.count;var u=a.count/e.length;t.forEach(e,function(t){void 0===r[t]&&(r[t]=0),r[t]+=u,d&&!c.absence&&(i.byCompany[a.id].divisions[t]+=u,i.byProdFunction[o.id].companies[a.id].divisions[t]+=u)})}c.totalByCompany[a.id].total+=s,d&&!c.absence&&(i.total+=s,i.byCompany[a.id].total+=s,i.byProdFunction[o.id].total+=s,i.byProdFunction[o.id].companies[a.id].total+=s)})}),s[c.id]=c,c.parent?r[c.parent]?r[c.parent].push(c):r[c.parent]=[c]:a.push(c)});var u=[],d=-1;return a.forEach(function(t){!function t(i,n){u.push(i);i.level=n;i.children=r[i.id]||[];i.hasChildren=i.children.length>0;0===n&&++d;d===c.length&&(d=0);i.backgroundColor=function(t){return"rgb("+t+")"}((e=c[d],o=.1*n,a=1-o,[Math.round(e[0]*a),Math.round(e[1]*a),Math.round(e[2]*a)]));var e,o,a;i.hasChildren&&(i.children[i.children.length-1].lastChild=!0,i.children.forEach(function(i){t(i,n+1)}))}(t,0)}),u.length&&(u[u.length-1].last=!0),u},serializeWithoutFunctions:function(){var t=this.serializeCompanies();return{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:i("core","SHIFT:"+this.get("shift")),total:t.reduce(function(t,i){return t+i.total},0),totalByCompany:null,totalByProdFunction:null,companies:t,divisions:this.get("fteDiv")||[],tasks:this.serializeTasksWithoutFunctions()}},serializeCompanies:function(){var i=this.get("tasks");return i&&i.length?t.map(i[0].companies,function(t,n){return t.total=i.reduce(function(t,i){return Array.isArray(i.companies[n].count)?i.companies[n].count.forEach(function(i){t+=i.value}):t+=i.companies[n].count,t},0),t}):[]},serializeTasksWithoutFunctions:function(){return t.map(this.get("tasks"),function(t){return t.total=t.companies.reduce(function(t,i){return Array.isArray(i.count)?i.count.forEach(function(i){t+=i.value}):t+=i.count,t},0),t})},isEditable:function(t){return r(this,t)},handleUpdateMessage:function(t,i){"count"===t.type?this.handleCountMessage(t,i):"comment"===t.type?this.handleCommentMessage(t,i):"edit"===t.type&&this.handleEditMessage(t,i)},handleCountMessage:function(t,i){var n=this.get("tasks");n&&(n[t.taskIndex]&&(t.tasks.forEach(function(t,i){n[i]=t}),this.set(t.data,{silent:!!i}),i||(this.trigger("change:tasks"),this.trigger("change"))))},handleCommentMessage:function(t,i){var n=this.get("tasks");if(n){var e=n[t.taskIndex];e&&void 0!==t.comment&&(e.comment=t.comment,i||(this.trigger("change:tasks"),this.trigger("change")))}},handleEditMessage:function(t,i){var n=this.get("tasks");n&&(t.tasks.forEach(function(t){n[t.index]=t.data}),this.set(t.data,{silent:i}),i||(this.trigger("change:tasks"),this.trigger("change")))}})});