// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","../i18n","../time","../data/subdivisions","../data/prodFunctions","../data/views/renderOrgUnitPath","../core/Model"],function(t,e,n,i,s,a,r){return r.extend({urlRoot:"/fte/master",clientUrlRoot:"#fte/master",topicPrefix:"fte.master",privilegePrefix:"FTE:MASTER",nlsDomain:"fte",defaults:{subdivision:null,date:null,shift:null,flows:null,tasks:null,createdAt:null,creator:null,updatedAt:null,updater:null,absentUsers:null},getLabel:function(){return e(this.nlsDomain,"label",{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:e("core","SHIFT:"+this.get("shift"))})},getSubdivisionPath:function(){var t=i.get(this.get("subdivision"));return t?a(t,!1,!1):"?"},serializeWithTotals:function(){var t={},i={};this.get("tasks").length&&this.get("tasks")[0].functions.forEach(function(e){var n=s.get(e.id);i[e.id]={prodFunction:n?n.getLabel():e.id,total:0,companies:{}},e.companies.forEach(function(n){i[e.id].companies[n.id]=0,t[n.id]={name:n.name,total:0}})});var a=this.serializeTasks(t,i),r=0;return Object.keys(t).forEach(function(e){r+=t[e].total}),{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:e("core","SHIFT:"+this.get("shift")),companyCount:Object.keys(t).length,totalByCompany:t,totalByProdFunction:i,total:r,tasks:a,absentUsers:(this.get("absentUsers")||[]).filter(function(t){return!!t})}},serializeTasks:function(t,e){return this.get("tasks").map(function(n){return n.totalByCompany={},n.functions.forEach(function(i){i.companies.forEach(function(s){"number"!=typeof n.totalByCompany[s.id]&&(n.totalByCompany[s.id]=0),n.totalByCompany[s.id]+=s.count,t&&(t[s.id].total+=s.count),e&&(e[i.id].total+=s.count,e[i.id].companies[s.id]+=s.count)})}),n})},isEditable:function(t){if(t.isAllowedTo("PROD_DATA:MANAGE"))return!0;if(!t.isAllowedTo(this.privilegePrefix+":MANAGE"))return!1;var e=this.get("creator");if(e&&t.data._id!==e.id)return!1;var n=t.getDivision();if(!t.isAllowedTo(this.privilegePrefix+":ALL")&&n){var s=i.get(this.get("subdivision"));if(!s||s.get("division")!==n.id)return!1}var a=Date.parse(this.get("createdAt"));return Date.now()<a+288e5},handleUpdateMessage:function(t,e){"count"===t.type?this.handleCountMessage(t,e):"plan"===t.type?this.handlePlanMessage(t,e):"addAbsentUser"===t.type?this.handleAddAbsentUserMessage(t,e):"removeAbsentUser"===t.type&&this.handleRemoveAbsentUserMessage(t,e)},handleCountMessage:function(t,e){var n=this.get("tasks");if(n){var i=n[t.taskIndex];if(i){var s=i.functions[t.functionIndex];if(s){var a=s.companies[t.companyIndex];a&&(a.count=t.newCount,e||(this.trigger("change:tasks"),this.trigger("change")))}}}},handlePlanMessage:function(e,n){var i=t.find(this.get("tasks"),function(t){return t.id===e.taskId});i&&(i.noPlan=e.newValue,i.noPlan&&i.functions.forEach(function(t){t.companies.forEach(function(t){t.count=0})}),n||(this.trigger("change:tasks"),this.trigger("change")))},handleAddAbsentUserMessage:function(t,e){var n=this.get("absentUsers")||[];n.push(t.user),e||(this.trigger("change:absentUsers"),this.trigger("change"))},handleRemoveAbsentUserMessage:function(t,e){for(var n=this.get("absentUsers")||[],i=-1,s=0,a=n.length;a>s;++s)if(n[s].id===t.userId){i=s;break}-1!==i&&(n.splice(i,1),e||(this.trigger("change:absentUsers"),this.trigger("change")))}})});