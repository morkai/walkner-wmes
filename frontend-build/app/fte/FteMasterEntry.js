// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../data/subdivisions","../data/prodFunctions","../orgUnits/util/renderOrgUnitPath","../core/Model","./util/isEditable"],function(t,a,e,n,s,o,i,r){"use strict";return i.extend({urlRoot:"/fte/master",clientUrlRoot:"#fte/master",topicPrefix:"fte.master",privilegePrefix:"FTE:MASTER",nlsDomain:"fte",defaults:{subdivision:null,date:null,shift:null,flows:null,tasks:null,createdAt:null,creator:null,updatedAt:null,updater:null,absentUsers:null},getLabel:function(){return a(this.nlsDomain,"label",{subdivision:this.getSubdivisionPath(),date:e.format(this.get("date"),"LL"),shift:a("core","SHIFT:"+this.get("shift"))})},getSubdivisionPath:function(){var t=n.get(this.get("subdivision"));return t?o(t,!1,!1):"?"},serializeWithTotals:function(){var n={demand:0,demandByCompany:{},supply:0,supplyByCompany:{},supplyByProdFunction:{},shortage:0,shortageByCompany:{}},o=0,i=this.get("tasks")[0];i&&(t.forEach(i.demand,function(t){n.demandByCompany[t.id]={id:t.id,name:t.name,total:0}}),i.functions.forEach(function(t){var a=s.get(t.id);n.supplyByProdFunction[t.id]={prodFunction:a?a.getLabel():t.id,total:0,companies:{}},t.companies.forEach(function(a){n.supplyByProdFunction[t.id].companies[a.id]=0,n.supplyByCompany[a.id]={name:a.name,total:0},o+=1})}),t.forEach(i.shortage,function(t){n.shortageByCompany[t.id]={id:t.id,name:t.name,total:0}}));var r=this.serializeTasks(n);Object.keys(n.supplyByCompany).forEach(function(t){n.supply+=n.supplyByCompany[t].total,o+=1}),t.forEach(n.demandByCompany,function(t){n.demand+=t.total}),t.forEach(n.shortageByCompany,function(t){n.shortage+=t.total});var l=Object.keys(n.supplyByCompany).length,d=this.get("companyTotals"),u={};return Object.keys(n.shortageByCompany).forEach(function(t){u[t]=d[t]?d[t].absence:0}),{subdivision:this.getSubdivisionPath(),date:e.format(this.get("date"),"LL"),shift:a("core","SHIFT:"+this.get("shift")),companyCount:l,demand:{available:!t.isEmpty(n.demandByCompany),columnCount:l+1,overallTotal:n.demand,totalByCompany:n.demandByCompany},supply:{columnCount:o,overallTotal:n.supply,totalByProdFunction:n.supplyByProdFunction,totalByCompany:n.supplyByCompany},shortage:{available:!t.isEmpty(n.shortageByCompany),columnCount:l+1,overallTotal:n.shortage,totalByCompany:n.shortageByCompany,overallAbsence:d.total.absence,absenceByCompany:u},tasks:r,absentUsers:(this.get("absentUsers")||[]).filter(function(t){return!!t})}},serializeTasks:function(a){var e=this.get("absenceTasks")||{};return this.get("tasks").map(function(n){n.totalDemand=0,n.total=0,n.totalShortage=0,n.totalByCompany={};var s=e[n.id]>=0,o={};return t.isEmpty(n.shortage)&&(n.demand=[],n.shortage=[]),t.forEach(n.demand,function(t,e){var s=t.count;o[t.id]=e,n.shortage[e].count=s,n.totalDemand+=s,n.totalShortage+=s,a.demandByCompany[t.id].total+=s,a.shortageByCompany[t.id].total+=s}),n.functions.forEach(function(t){t.companies.forEach(function(e){var i=e.id,r=e.count;n.total+=r,"number"!=typeof n.totalByCompany[i]&&(n.totalByCompany[i]=0),n.totalByCompany[i]+=r,a.supplyByCompany[i]&&(a.supplyByCompany[i].total+=r),a.supplyByProdFunction&&(a.supplyByProdFunction[t.id].total+=r,a.supplyByProdFunction[t.id].companies[i]+=r),(s||n.totalDemand)&&(n.shortage[o[i]]&&(n.shortage[o[i]].count-=r),n.totalShortage-=r),n.totalDemand&&(a.shortageByCompany[i].total-=r)})}),s&&(n.totalShortage=Math.abs(n.totalShortage),n.shortage.forEach(function(t){t.count=Math.abs(t.count)})),n})},isEditable:function(t){return r(this,t)},handleUpdateMessage:function(t,a){"count"===t.type||"plan"===t.type?this.handleCountOrPlanMessage(t,a):"addAbsentUser"===t.type?this.handleAddAbsentUserMessage(t,a):"removeAbsentUser"===t.type?this.handleRemoveAbsentUserMessage(t,a):"edit"===t.type&&this.handleEditMessage(t,a)},handleCountOrPlanMessage:function(a,e){var n=this.get("tasks");if(n){var s=t.findIndex(n,function(t){return t.id===a.task.id});s!==-1&&(n[s]=a.task,this.set(a.data,{silent:!!e}),e||(this.trigger("change:tasks"),this.trigger("change")))}},handleAddAbsentUserMessage:function(t,a){var e=this.get("absentUsers")||[];e.push(t.user),a||(this.trigger("change:absentUsers"),this.trigger("change"))},handleRemoveAbsentUserMessage:function(t,a){for(var e=this.get("absentUsers")||[],n=-1,s=0,o=e.length;s<o;++s)if(e[s].id===t.userId){n=s;break}n!==-1&&(e.splice(n,1),a||(this.trigger("change:absentUsers"),this.trigger("change")))},handleEditMessage:function(t,a){var e=this.get("tasks");t.tasks.forEach(function(t){e[t.index]=t.data}),this.set(t.data,{silent:a}),a||(this.trigger("change:tasks"),this.trigger("change"))}})});