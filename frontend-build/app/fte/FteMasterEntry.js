define(["underscore","../i18n","../time","../data/orgUnits","../data/prodFunctions","../orgUnits/util/renderOrgUnitPath","../core/Model","../core/util","./util/isEditable"],function(t,e,n,a,s,i,o,r,d){"use strict";return o.extend({TYPE:"master",urlRoot:"/fte/master",clientUrlRoot:"#fte/master",topicPrefix:"fte.master",privilegePrefix:"FTE:MASTER",nlsDomain:"fte",getLabel:function(){return e(this.nlsDomain,"label",{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:e("core","SHIFT:"+this.get("shift"))})},getSubdivisionPath:function(){var t=a.getByTypeAndId("subdivision",this.get("subdivision"));return t?i(t,!1,!1):"?"},serializeWithTotals:function(){var a={},i={total:0,byCompany:{},byProdFunction:{}},o=0,r=this.get("tasks")[0];r&&r.functions.forEach(function(t){var e=s.get(t.id);i.byProdFunction[t.id]={name:e?e.getLabel():t.id,total:0,companies:{}},t.companies.forEach(function(e){i.byProdFunction[t.id].companies[e.id]=0,i.byCompany[e.id]={name:e.name,total:0},a[e.id]=e.name,o+=1})});var d=this.serializeTasks(i),l=Object.keys(a).length,c=this.get("totals");return o+=l,{subdivision:this.getSubdivisionPath(),date:n.format(this.get("date"),"LL"),shift:e("core","SHIFT:"+this.get("shift")),companyCount:l,companies:a,demand:{columnCount:l+1,overallTotal:c.demand.total,totalByCompany:c.demand},supply:{columnCount:o,overallTotal:i.total,totalByProdFunction:i.byProdFunction,totalByCompany:i.byCompany},shortage:{columnCount:l+1,overallTotal:c.shortage.total,totalByCompany:c.shortage},absence:{available:!t.isEmpty(this.get("absenceTasks")),overallTotal:c.absence.total,totalByCompany:c.absence},tasks:d,absentUsers:(this.get("absentUsers")||[]).filter(function(t){return!!t})}},serializeTasks:function(t){var e=this.get("absenceTasks");return this.get("tasks").map(function(n){var s,i;return n.lines=(s=n.id,i=[],a.getChildren(a.getByTypeAndId("prodFlow",s)).forEach(function(t){a.getChildren(t).forEach(function(t){i.push(t.id)})}),i),n.name=" "+n.name+" ",n.lines.forEach(function(t){var e=new RegExp("[s\\-,]*"+r.escapeRegExp(t)+"[s\\-,]*");n.name=n.name.replace(e,"")}),n.name=n.name.trim().replace(/[s\-,.]+$/,""),n.absence=e[n.id]>=0,n.totalByCompany={},n.functions.forEach(function(e){e.companies.forEach(function(a){var s=a.id,i=a.count;n.totalByCompany[s]||(n.totalByCompany[s]=0),n.totalByCompany[s]+=i,n.absence||(t.total+=i,t.byCompany[s].total+=i,t.byProdFunction[e.id].total+=i,t.byProdFunction[e.id].companies[s]+=i)})}),n})},isEditable:function(t){return d(this,t)},handleUpdateMessage:function(t,e){"count"===t.type||"plan"===t.type?this.handleCountOrPlanMessage(t,e):"addAbsentUser"===t.type?this.handleAddAbsentUserMessage(t,e):"removeAbsentUser"===t.type?this.handleRemoveAbsentUserMessage(t,e):"edit"===t.type&&this.handleEditMessage(t,e)},handleCountOrPlanMessage:function(e,n){var a=this.get("tasks");if(a){if(e.task){var s=t.findIndex(a,function(t){return t.id===e.task.id});if(-1===s)return;a[s]=e.task}this.set(e.data,{silent:!!n}),n||(this.trigger("change:tasks"),this.trigger("change"))}},handleAddAbsentUserMessage:function(t,e){(this.get("absentUsers")||[]).push(t.user),e||(this.trigger("change:absentUsers"),this.trigger("change"))},handleRemoveAbsentUserMessage:function(t,e){for(var n=this.get("absentUsers")||[],a=-1,s=0,i=n.length;s<i;++s)if(n[s].id===t.userId){a=s;break}-1!==a&&(n.splice(a,1),e||(this.trigger("change:absentUsers"),this.trigger("change")))},handleEditMessage:function(t,e){var n=this.get("tasks");n&&(t.tasks.forEach(function(t){n[t.index]=t.data}),this.set(t.data,{silent:e}),e||(this.trigger("change:tasks"),this.trigger("change")))}})});