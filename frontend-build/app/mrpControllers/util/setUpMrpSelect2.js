define(["underscore","select2","Sortable","app/broker","app/user","app/i18n","app/data/orgUnits","./ownMrps"],function(e,t,r,n,i,o,a,c){"use strict";var l=0,s=null;function u(){var e=(i.data.mrps||[]).filter(function(e){return!a.getByTypeAndId("mrpController",e)}).map(function(e){return{id:e,text:""}});l=0,s=a.getAllByType("mrpController").filter(function(e){return-1===e.id.indexOf("~")}).map(function(e){return e.id.length>l&&e.id.length<6&&(l=e.id.length),{id:e.id,text:e.get("description")}}).concat(e).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})})}return n.subscribe("mrpControllers.synced",u),function(n,i){if(!n)throw new Error("Unspecified $input!");if(!n.length)return n;i||(i={}),null===s&&u();var a=i.itemDecorator?s.map(function(t){return i.itemDecorator(e.clone(t),!1)}):s;if(i.filter&&(a=a.filter(i.filter)),n.select2(e.assign({width:"300px",allowClear:!0,multiple:!0,data:a,minimumResultsForSearch:1,matcher:function(e,t,r){return e=e.toUpperCase(),r.id.toUpperCase().indexOf(e)>=0||r.text.toUpperCase().indexOf(e)>=0},formatNoMatches:function(e){return/^[A-Z0-9]{3,}$/i.test(e)?o("mrpControllers","select2:noMatches:virtual",{mrp:e.toUpperCase()}):o("mrpControllers","select2:noMatches")},formatSelection:function(t){return e.escape(t.id)},formatResult:function(e,r,n,i){var o=e.id,a=o.length>=6&&e.text.length>=6,c=[];if(!a){for(;o.length<l;)o+=" ";c.push('<span class="text-mono">'),t.util.markMatch(o,n.term,c,i)}return""===e.text?c.push("</span>"):(a||c.push("</span>"),c.push('<span class="text-small">'),a||c.push(": "),e.icon&&c.push('<i class="fa '+e.icon.id+'" style="color: '+(e.icon.color||"#000")+'"></i> '),t.util.markMatch(e.text,n.term,c,i),c.push("</span>")),c.join("")},tokenizer:function(e,t,r){if(""===e||e===i.placeholder)return null;var n=e,o={};return t.forEach(function(e){o[e.id]=!0}),(e.match(/[A-Z0-9]{3,}[^A-Z0-9]/gi)||[]).forEach(function(e){if(n=n.replace(e,""),e=e.toUpperCase().replace(/[^A-Z0-9]+/g,""),!o[e]){var t={id:e,text:e};i.itemDecorator&&(t=i.itemDecorator(t,!0)),t.locked||t.disabled||(r(t),o[e]=!0)}}),e===n?null:n.replace(/\s+/," ").trim()}},i)),i.sortable){var p=new r(n.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){n.select2("onSortStart")},onEnd:function(){n.select2("onSortEnd").select2("focus")}});if(i.view){var f=i.view.destroy;i.view.destroy=function(){f.apply(i.view,arguments),p.destroy()}}}i.own&&i.view&&c.attach(i.view,n);var d=n.val().split(",").filter(function(e){return e.length}).map(function(e){var t={id:e,text:e};return i.itemDecorator&&(t=i.itemDecorator(t,!0)),t});return n.select2("data",d.length&&!1===i.multiple?d[0]:d),n}});