// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","select2","Sortable","app/broker","app/user","app/data/orgUnits","./ownMrps"],function(e,t,n,r,i,o,a){"use strict";function c(){var e=(i.data.mrps||[]).filter(function(e){return!o.getByTypeAndId("mrpController",e)}).map(function(e){return{id:e,text:""}});l=0,s=o.getAllByType("mrpController").filter(function(e){return-1===e.id.indexOf("~")}).map(function(e){return e.id.length>l&&(l=e.id.length),{id:e.id,text:e.get("description")}}).concat(e).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})})}var l=0,s=null;return r.subscribe("mrpControllers.synced",c),function(r,i){if(null===s&&c(),r.select2(e.assign({width:"300px",allowClear:!0,multiple:!0,data:s,minimumResultsForSearch:1,matcher:function(e,t,n){return e=e.toUpperCase(),n.id.toUpperCase().indexOf(e)>=0||n.text.toUpperCase().indexOf(e)>=0},formatSelection:function(t){return e.escape(t.id)},formatResult:function(e,n,r,i){for(var o=e.id;o.length<l;)o+=" ";var a=['<span class="text-mono">'];return t.util.markMatch(o,r.term,a,i),""===e.text?a.push("</span>"):(a.push('</span><span class="text-small">: '),t.util.markMatch(e.text,r.term,a,i),a.push("</span>")),a.join("")},tokenizer:function(e,t,n){var r=e,i={};return t.forEach(function(e){i[e.id]=!0}),(e.match(/[A-Z0-9]{3,}[^A-Z0-9]/gi)||[]).forEach(function(e){r=r.replace(e,""),e=e.toUpperCase().replace(/[^A-Z0-9]+/g,""),i[e]||(n({id:e,text:e}),i[e]=!0)}),e===r?null:r.replace(/\s+/," ").trim()}},i)),i&&i.sortable){var o=new n(r.select2("container").find(".select2-choices")[0],{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){r.select2("onSortStart")},onEnd:function(){r.select2("onSortEnd").select2("focus")}});if(i.view){var u=i.view.destroy;i.view.destroy=function(){u.apply(i.view,arguments),o.destroy()}}}return i&&i.own&&i.view&&a.attach(i.view,r),r.select2("data",r.val().split(",").filter(function(e){return e.length}).map(function(e){return{id:e,text:e}})),r}});