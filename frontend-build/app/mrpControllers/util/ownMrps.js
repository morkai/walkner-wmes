define(["underscore","jquery","app/i18n","app/user","app/viewport","i18n!app/nls/mrpControllers"],function(n,t,r,e,o){"use strict";function a(a,p,s){var l=(e.data.mrps||[]).map(function(n){return{id:n,text:n}});if(!l.length||s)return function(a,p){var s=0===p.val().length?"disabled":"",l=["<p>"+r("mrpControllers","ownMrps:info",{link:"#users/"+e.data._id})+"</p>",'<p><button class="btn btn-primary" '+s+">"+r("mrpControllers","ownMrps:save")+"</button></p>"];n.isEmpty(e.data.mrps)&&l.unshift("<p>"+r("mrpControllers","ownMrps:empty")+"</p>");var d=a.$id("ownMrps").popover({trigger:"manual",html:!0,placement:"right",content:l.join("")});d.popover("show"),d.next(".popover").click(function(n){"BUTTON"!==n.target.tagName||n.target.disabled||(n.preventDefault(),function(n,t){o.msg.saving();var r=t.val().split(",").filter(function(n){return n.length>0}),a=n.ajax({method:"PUT",url:"/users/"+e.data._id,data:JSON.stringify({mrps:r})});a.fail(function(){o.msg.savingFailed()}),a.done(function(){o.msg.saved(),e.noReload=!0})}(a,p))}),p.one("select2-focus",i.bind(a)),t(document.body).one("click.ownMrps."+a.idPrefix,i.bind(a))}(a,p);p.select2("data",l),p.change()}function i(){this.$id("ownMrps").popover("destroy"),t(document.body).off(".ownMrps")}return{attach:function(n,e){var o=n.$id("ownMrps");o.attr("data-input-id")||(o.length||t(e[0].labels[0]).append(' (<a id="'+n.idPrefix+'-ownMrps" href="#">'+r("mrpControllers","ownMrps:trigger")+"</a>)"),n.$id("ownMrps").attr("data-input-id",e.prop("id")).on("click",function(t){return a(n,e,t.ctrlKey),!1}),n.off("cleanup",i,n),n.once("cleanup",i,n))}}});