// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/viewport","i18n!app/nls/mrpControllers"],function(n,t,r,e,o){"use strict";function a(n,t,r){var o=(e.data.mrps||[]).map(function(n){return{id:n,text:n}});if(!o.length||r)return i(n,t);t.select2("data",o),t.change()}function i(o,a){var i=0===a.val().length?"disabled":"",l=["<p>"+r("mrpControllers","ownMrps:info",{link:"#users/"+e.data._id})+"</p>",'<p><button class="btn btn-primary" '+i+">"+r("mrpControllers","ownMrps:save")+"</button></p>"];n.isEmpty(e.data.mrps)&&l.unshift("<p>"+r("mrpControllers","ownMrps:empty")+"</p>");var d=o.$id("ownMrps").popover({trigger:"manual",html:!0,placement:"right",content:l.join("")});d.popover("show"),d.next(".popover").click(function(n){"BUTTON"!==n.target.tagName||n.target.disabled||(n.preventDefault(),p(o,a))}),a.one("select2-focus",s.bind(o)),t(document.body).one("click.ownMrps."+o.idPrefix,s.bind(o))}function p(n,t){o.msg.saving();var r=t.val().split(",").filter(function(n){return n.length>0}),a=n.ajax({method:"PUT",url:"/users/"+e.data._id,data:JSON.stringify({mrps:r})});a.fail(function(){o.msg.savingFailed()}),a.done(function(){o.msg.saved(),e.noReload=!0})}function s(){this.$id("ownMrps").popover("destroy"),t(document.body).off(".ownMrps")}return{attach:function(n,e){var o=n.$id("ownMrps");o.attr("data-input-id")||(o.length||t(e[0].labels[0]).append(' (<a id="'+n.idPrefix+'-ownMrps" href="#">'+r("mrpControllers","ownMrps:trigger")+"</a>)"),n.$id("ownMrps").attr("data-input-id",e.prop("id")).on("click",function(t){return a(n,e,t.ctrlKey),!1}),n.off("cleanup",s,n),n.once("cleanup",s,n))}}});