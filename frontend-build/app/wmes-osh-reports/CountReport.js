define(["underscore","h5.rql/index","app/i18n","app/time","app/core/Model","app/data/colorFactory","app/wmes-osh-common/dictionaries","./util/createDefaultFilter"],function(e,t,o,r,s,i,a,n){"use strict";const l={total:"#ddd",entry:"#666",observation:"#666",new:"#999",inProgress:"#0af",open:"#e00",verification:"#aa00ff",finished:"#00af00",paused:"#fa0",cancelled:"#e00"},c={nearMiss:["count","duration","finished","status","kind","eventCategory","reasonCategory","priority","creator"].concat(a.ORG_UNITS),kaizen:["count","duration","finished","status","kind","kaizenCategory","creator","implementer"].concat(a.ORG_UNITS),action:["count","duration","finished","status","kind","activityKind","creator","implementer","participant"].concat(a.ORG_UNITS),observation:["count","duration","finished","status","observationKind","company","creator","observation","observationCategory","safe","safeCategory","risky","riskyCategory","easy","easyCategory","hard","hardCategory"].concat(a.ORG_UNITS)},d={observationCategory:"observation",safeCategory:"observation",riskyCategory:"observation",easyCategory:"observation",hardCategory:"observation"},u={creator:!0,implementer:!0,participant:!0},h={creator:"users",implementer:"users",participant:"users",kind:!0,activityKind:!0,observationKind:!0,eventCategory:!0,reasonCategory:!0,kaizenCategory:!0,observationCategory:!0,safeCategory:"observationCategory",riskyCategory:"observationCategory",easyCategory:"observationCategory",hardCategory:"observationCategory"};return s.extend({urlRoot:function(){return`/osh/reports/count/${this.type}`},nlsDomain:"wmes-osh-reports",defaults:function(){return{}},initialize:function(e,t){this.rqlQuery=t.rqlQuery&&!t.rqlQuery.isEmpty()?t.rqlQuery:n({dateProperty:"createdAt",interval:"day"}),this.type=t.type,this.metrics=c[this.type]},fetch:function(t){return e.isObject(t)||(t={}),t.data=this.rqlQuery.toString(),s.prototype.fetch.call(this,t)},genClientUrl:function(){return`/osh/reports/count/${this.type}?${this.rqlQuery.toString()}`},parse:function(e){const t=e.totals,r=o(this.nlsDomain,"series:entry"),s="observation"===this.type,i={count:{rows:[{id:"entry",abs:t.count,rel:1,color:l.entry,label:r}],series:{entry:{data:[],color:l.entry}}},finished:{rows:[{id:"open",abs:t.count-t.finished,rel:(t.count-t.finished)/t.count,color:l.open,label:o(this.nlsDomain,"series:open")},{id:"finished",abs:t.finished,rel:t.finished/t.count,color:l.finished,label:o(this.nlsDomain,"series:finished")},{id:"total",abs:t.count,rel:1,color:l.total,label:o(this.nlsDomain,"series:total")}],series:{open:{data:[],color:l.open,stacking:"percent"},finished:{data:[],color:l.finished,stacking:"percent"}}},duration:{rows:[{id:"entry",abs:t.duration[2],rel:1,color:l.entry,label:o(this.nlsDomain,"series:duration")}],series:{entry:{data:[],color:l.entry,tooltip:{valueSuffix:"h"}}}}},a=["count"];if(s){const e=o(this.nlsDomain,"series:observation");["observation","safe","risky","easy","hard"].forEach(o=>{a.push(o),i[o]={rows:[{id:"observation",abs:t[o],rel:1,color:l.observation,label:e}],series:{observation:{data:[],color:l.observation}}}})}return this.metrics.forEach(o=>{!i[o]&&t[o]&&(i[o]=u[o]?{categories:t[o].map(t=>e.users[t[0]]||t[0]),series:[{id:"count",name:r,color:l.entry,data:t[o].map(e=>e[1])}]}:{rows:this.prepareRows(o,e),series:{}})}),e.groups.forEach(e=>{let o;"number"==typeof e?e={key:o=e}:o=e.key,i.duration.series.entry.data.push({x:o,y:e.duration&&e.duration[2]?e.duration[2]:null}),i.finished.series.open.data.push({x:o,y:e.count-e.finished||0}),i.finished.series.finished.data.push({x:o,y:e.finished||0}),a.forEach(t=>{Object.values(i[t].series)[0].data.push({x:o,y:0===e[t]?0:e[t]||null})}),this.metrics.forEach(o=>{null!=t[o]&&this.createSeriesFromRows(o,i,e)})}),e.groups.length||this.metrics.forEach(e=>{i[e]=u[e]?{categories:[],series:[]}:{rows:[],series:{}}}),i},prepareRows:function(e,t){const r=t.totals[d[e]||"count"],s=[].concat(t.totals[e]),n={id:"total",abs:0,rel:1,color:"#DDD",label:o(this.nlsDomain,"series:total")},c=s.map(s=>{const c=s[0],d=s[1];let u;if(h[e]){const o=h[e];u=t[o]?t[o][c]||c:a.getLabel("string"==typeof o?o:e,c,{long:!1})}else u=o.has(this.nlsDomain,`${e}:${c}:${this.type}`)?o(this.nlsDomain,`${e}:${c}:${this.type}`):o.has(this.nlsDomain,`${e}:${c}`)?o(this.nlsDomain,`${e}:${c}`):o.has("wmes-osh-common",`${e}:${c}`)?o("wmes-osh-common",`${e}:${c}`):"0"===c?o(this.nlsDomain,"unspecified"):a.getLabel(e,c,{long:!1});return n.abs+=d,{id:c,abs:d,rel:d/r,color:l[c]||i.getColor(`wmes-osh/count/${e}`,c),label:u}});return c.push(n),c},createSeriesFromRows:function(t,o,r){o[t]||(o[t]={rows:[],series:{}});const{rows:s,series:i}=o[t];Array.isArray(s)&&(s.length&&i[s[0].id]&&i[s[0].id].data.length||e.forEach(s,e=>{"total"!==e.id&&(i[e.id]||(i[e.id]={name:e.label,data:[],color:e.color}),i[e.id].data.push({x:r.key,y:r[t]&&r[t][e.id]||null}))}))},getInterval:function(){const e=this.rqlQuery.selector.args.find(e=>"eq"===e.name&&"interval"===e.args[0]);return e?e.args[1]:"none"}},{USER_METRICS:u})});