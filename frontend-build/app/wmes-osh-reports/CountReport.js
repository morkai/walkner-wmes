define(["underscore","h5.rql/index","app/i18n","app/time","app/core/Model","app/data/colorFactory","app/wmes-osh-common/dictionaries","./util/createDefaultFilter"],function(e,t,r,o,s,i,a,n){"use strict";const c={total:"#ddd",entry:"#666",observation:"#666",new:"#999",inProgress:"#0af",open:"#e00",verification:"#aa00ff",finished:"#00af00",paused:"#fa0",cancelled:"#e00"},l={nearMiss:["count","duration","finished","status","kind","eventCategory","reasonCategory","priority","creator"].concat(a.ORG_UNITS),kaizen:["count","duration","finished","status","kind","kaizenCategory","creator","implementer"].concat(a.ORG_UNITS),action:["count","duration","finished","status","kind","activityKind","creator","implementer","participant"].concat(a.ORG_UNITS),observation:["count","duration","finished","status","observationKind","company","creator","observation","observationCategory","safe","safeCategory","risky","riskyCategory","easy","easyCategory","hard","hardCategory"].concat(a.ORG_UNITS)},d={observationCategory:"observation",safeCategory:"observation",riskyCategory:"observation",easyCategory:"observation",hardCategory:"observation"},u={creator:!0,implementer:!0,participant:!0},h={creator:"users",implementer:"users",participant:"users",kind:!0,activityKind:!0,observationKind:!0,eventCategory:!0,reasonCategory:!0,kaizenCategory:!0,observationCategory:!0,safeCategory:"observationCategory",riskyCategory:"observationCategory",easyCategory:"observationCategory",hardCategory:"observationCategory"};return s.extend({urlRoot:function(){return`/osh/reports/count/${this.type}`},nlsDomain:"wmes-osh-reports",defaults:function(){return{}},initialize:function(e,t){this.rqlQuery=t.rqlQuery&&!t.rqlQuery.isEmpty()?t.rqlQuery:n({dateProperty:"createdAt",interval:"day"}),this.type=t.type,this.metrics=l[this.type]},fetch:function(t){return e.isObject(t)||(t={}),t.data=this.rqlQuery.toString(),s.prototype.fetch.call(this,t)},genClientUrl:function(){return`/osh/reports/count/${this.type}?${this.rqlQuery.toString()}`},parse:function(t){const o=t.totals,s=r(this.nlsDomain,"series:entry"),i="observation"===this.type,a={interval:t.options.interval,count:{rows:[{id:"entry",abs:o.count,rel:1,color:c.entry,label:s}],series:{entry:{data:[],color:c.entry}}},finished:{rows:[{id:"open",abs:o.count-o.finished,rel:(o.count-o.finished)/o.count,color:c.open,label:r(this.nlsDomain,"series:open")},{id:"finished",abs:o.finished,rel:o.finished/o.count,color:c.finished,label:r(this.nlsDomain,"series:finished")},{id:"total",abs:o.count,rel:1,color:c.total,label:r(this.nlsDomain,"series:total")}],series:{open:{data:[],color:c.open,stacking:"percent"},finished:{data:[],color:c.finished,stacking:"percent"}}},duration:{rows:[{id:"entry",abs:o.duration[2],rel:1,color:c.entry,label:r(this.nlsDomain,"series:duration")}],series:{entry:{data:[],color:c.entry,tooltip:{valueSuffix:"h"}}}}},n=["count"];if(i){const e=r(this.nlsDomain,"series:observation");["observation","safe","risky","easy","hard"].forEach(t=>{n.push(t),a[t]={rows:[{id:"observation",abs:o[t],rel:1,color:c.observation,label:e}],series:{observation:{data:[],color:c.observation}}}})}this.metrics.forEach(e=>{a[e]||(u[e]?o[e]?a[e]={categories:o[e].map(e=>t.users[e[0]]||e[0]),series:[{id:"count",name:s,color:c.entry,data:o[e].map(e=>e[1])}]}:a[e]={categories:[],series:[]}:a[e]={rows:this.prepareRows(e,t),series:{}})});var l={};return t.groups.forEach(t=>{let r;"number"==typeof t?t={key:r=t}:r=t.key,a.duration.series.entry.data.push({x:r,y:t.duration&&t.duration[2]?t.duration[2]:null}),a.finished.series.open.data.push({x:r,y:t.count-t.finished||0}),a.finished.series.finished.data.push({x:r,y:t.finished||0}),n.forEach(e=>{Object.values(a[e].series)[0].data.push({x:r,y:0===t[e]?0:t[e]||null})}),this.metrics.forEach(r=>{(l[r]||!a[r]||e.isEmpty(a[r].series))&&(l[r]=!0,this.createSeriesFromRows(r,a,t))})}),t.groups.length||this.metrics.forEach(e=>{a[e]=u[e]?{categories:[],series:[]}:{rows:[],series:{}}}),a},prepareRows:function(e,t){const o=t.totals[d[e]||"count"],s=[].concat(t.totals[e]||[]),n={id:"total",abs:0,rel:1,color:"#DDD",label:r(this.nlsDomain,"series:total")},l=s.map(s=>{const l=s[0],d=s[1];let u;if(h[e]){const r=h[e];u=t[r]?t[r][l]||l:a.getLabel("string"==typeof r?r:e,l,{long:!1})}else u=r.has(this.nlsDomain,`${e}:${l}:${this.type}`)?r(this.nlsDomain,`${e}:${l}:${this.type}`):r.has(this.nlsDomain,`${e}:${l}`)?r(this.nlsDomain,`${e}:${l}`):r.has("wmes-osh-common",`${e}:${l}`)?r("wmes-osh-common",`${e}:${l}`):"0"===l?r(this.nlsDomain,"unspecified"):a.getLabel(e,l,{long:!1});return n.abs+=d,{id:l,abs:d,rel:d/o,color:c[l]||i.getColor(`wmes-osh/count/${e}`,l),label:u}});return l.push(n),l},createSeriesFromRows:function(t,r,o){r[t]||(r[t]={rows:[],series:{}});const{rows:s,series:i}=r[t];Array.isArray(s)&&e.forEach(s,(e,r)=>{"total"!==e.id&&(i[e.id]||(i[e.id]={index:r,name:e.label,data:[],color:e.color}),i[e.id].data.push({x:o.key,y:o[t]&&o[t][e.id]||null}))})},getInterval:function(){const e=this.rqlQuery.selector.args.find(e=>"eq"===e.name&&"interval"===e.args[0]);return e?e.args[1]:"none"}},{USER_METRICS:u})});