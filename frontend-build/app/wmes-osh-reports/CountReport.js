define(["underscore","h5.rql/index","app/i18n","app/time","app/core/Model","app/data/colorFactory","app/wmes-osh-common/dictionaries"],function(t,e,r,o,a,s,i){"use strict";const n={entry:"#666",observation:"#666",new:"#999",inProgress:"#0af",verification:"#aa00ff",finished:"#00af00",paused:"#fa0",cancelled:"#e00"},c={nearMiss:["count","duration","status","kind","eventCategory","reasonCategory","priority","creator"].concat(i.ORG_UNITS),kaizen:["count","duration","status","kind","kaizenCategory","creator","implementer"].concat(i.ORG_UNITS),action:["count","duration","status","kind","activityKind","creator","implementer","participant"].concat(i.ORG_UNITS),observation:["count","duration","status","observationKind","company","creator","observation","observationCategory","safe","safeCategory","risky","riskyCategory","easy","easyCategory","hard","hardCategory"].concat(i.ORG_UNITS)},l={observationCategory:"observation",safeCategory:"observation",riskyCategory:"observation",easyCategory:"observation",hardCategory:"observation"},y={creator:!0,implementer:!0,participant:!0},u={creator:"users",implementer:"users",participant:"users",kind:!0,activityKind:!0,observationKind:!0,eventCategory:!0,reasonCategory:!0,kaizenCategory:!0,observationCategory:!0,safeCategory:"observationCategory",riskyCategory:"observationCategory",easyCategory:"observationCategory",hardCategory:"observationCategory"};return a.extend({urlRoot:function(){return`/osh/reports/count/${this.type}`},nlsDomain:"wmes-osh-reports",defaults:function(){return{}},initialize:function(t,r){this.rqlQuery=r.rqlQuery&&!r.rqlQuery.isEmpty()?r.rqlQuery:e.parse(`interval=day&createdAt>=${o.getMoment().startOf("day").subtract(7,"days").valueOf()}`),this.type=r.type,this.metrics=c[this.type]},fetch:function(e){return t.isObject(e)||(e={}),e.data=this.rqlQuery.toString(),a.prototype.fetch.call(this,e)},genClientUrl:function(){return`/osh/reports/count/${this.type}?${this.rqlQuery.toString()}`},parse:function(t){const e=t.totals,o=r(this.nlsDomain,"series:entry"),a="observation"===this.type,s={count:{rows:[{id:"entry",abs:e.count,rel:1,color:n.entry,label:o}],series:{entry:{data:[],color:n.entry}}},duration:{rows:[{id:"entry",abs:e.duration[2],rel:1,color:n.entry,label:o}],series:{entry:{data:[],color:n.entry,tooltip:{valueSuffix:"h"}}}}},i=["count"];if(a){const t=r(this.nlsDomain,"series:observation");["observation","safe","risky","easy","hard"].forEach(r=>{i.push(r),s[r]={rows:[{id:"observation",abs:e[r],rel:1,color:n.observation,label:t}],series:{observation:{data:[],color:n.observation}}}})}return this.metrics.forEach(r=>{!s[r]&&e[r]&&(s[r]=y[r]?{categories:e[r].map(e=>t.users[e[0]]||e[0]),series:[{id:"count",name:o,color:n.entry,data:e[r].map(t=>t[1])}]}:{rows:this.prepareRows(r,t),series:{}})}),t.groups.forEach(t=>{let r;"number"==typeof t?t={key:r=t}:r=t.key,s.duration.series.entry.data.push({x:r,y:t.duration&&t.duration[2]?t.duration[2]:null}),i.forEach(e=>{Object.values(s[e].series)[0].data.push({x:r,y:t[e]||null})}),this.metrics.forEach(r=>{e[r]&&this.createSeriesFromRows(r,s,t)})}),t.groups.length||this.metrics.forEach(t=>{s[t]=y[t]?{categories:[],series:[]}:{rows:[],series:{}}}),s},prepareRows:function(t,e){const o=e.totals[l[t]||"count"],a=[].concat(e.totals[t]),c={id:"total",abs:0,rel:1,color:"#DDD",label:r(this.nlsDomain,"series:total")},y=a.map(a=>{const l=a[0],y=a[1];let d;if(u[t]){const r=u[t];d=e[r]?e[r][l]||l:i.getLabel("string"==typeof r?r:t,l,{long:!1})}else d=r.has(this.nlsDomain,`${t}:${l}:${this.type}`)?r(this.nlsDomain,`${t}:${l}:${this.type}`):r.has(this.nlsDomain,`${t}:${l}`)?r(this.nlsDomain,`${t}:${l}`):r.has("wmes-osh-common",`${t}:${l}`)?r("wmes-osh-common",`${t}:${l}`):"0"===l?r(this.nlsDomain,"unspecified"):i.getLabel(t,l,{long:!1});return c.abs+=y,{id:l,abs:y,rel:y/o,color:n[l]||s.getColor(`wmes-osh/count/${t}`,l),label:d}});return y.push(c),y},createSeriesFromRows:function(e,r,o){const a=r[e].series;t.forEach(r[e].rows,t=>{"total"!==t.id&&(a[t.id]||(a[t.id]={name:t.label,data:[],color:t.color}),a[t.id].data.push({x:o.key,y:o[e]&&o[e][t.id]||null}))})}},{USER_METRICS:y})});