define(["jquery","app/core/View","app/wmes-osh-common/dictionaries","app/wmes-osh-departments/Department","app/wmes-osh-reports/templates/engagement/orgUnits","jquery.stickytableheaders"],function(e,t,i,n,o){"use strict";return t.extend({template:o,initialize:function(){this.listenTo(this.model,"change:orgUnits",this.render)},destroy:function(){this.$(".table").stickyTableHeaders("destroy")},getTemplateData:function(){return{rows:this.serializeRows(),n:e=>e>=0?(Math.round(100*e)/100).toLocaleString():""}},afterRender:function(){this.$(".table").stickyTableHeaders({fixedOffset:e(".navbar-fixed-top")})},serializeRows:function(){const e=this.createRow("total"),t={},o={},s=[],a=new n({_id:0,longName:"?"});return this.model.get("orgUnits").forEach(n=>{const r=i.departments.get(n.department)||a,d=r?i.workplaces.get(r.get("workplace")):null,c=d?i.divisions.get(d.get("division")):null;if(c){if(!t[c.id]){const e=this.createRow("division",c);t[c.id]=e,s.push(e)}this.incRow(t[c.id],n),t[c.id].children+=1}if(d){if(!o[d.id]){const e=this.createRow("workplace",c,d);o[d.id]=e,s.push(e),c&&(t[c.id].children+=1)}this.incRow(o[d.id],n),o[d.id].children+=1}const l=r===a?"unknown":"department",g=this.createRow(l,c,d,r,n);s.push(this.summarizeRow(g)),this.incRow(e,n)}),Object.values(t).forEach(this.summarizeRow,this),Object.values(o).forEach(this.summarizeRow,this),s.sort((e,t)=>e.division.localeCompare(t.division)||e.workplace.localeCompare(t.workplace)||e.department.localeCompare(t.department)),s.push(this.summarizeRow(e)),s},createRow:function(e,t,i,n,o){return o||(o={employed:0,engaged:0,metrics:[0,0,0,0]}),{type:e,children:1,division:t?t.getLabel({long:!1}):"",workplace:i?i.getLabel({long:!1}):"",department:n?n.getLabel({long:!0}):"",employed:o.employed,engaged:o.engaged,engagedPercent:0,metrics:o.metrics}},incRow:function(e,t){e.employed+=t.employed,e.engaged+=t.engaged,t.metrics.forEach((t,i)=>{e.metrics[i]+=t})},summarizeRow:function(e){const{minEngagement:t}=this.model.get("settings");return e.engagedPercent=Math.round(e.engaged/e.employed*100),isFinite(e.engagedPercent)||(e.engagedPercent=-1),e.engagedInvalid=e.engagedPercent>=0&&e.engagedPercent<t,e}})});