define(["require","underscore","app/core/View","app/reports/util/formatTooltipHeader","app/reports/util/formatXAxis","app/wmes-osh-reports/templates/table","app/wmes-osh-reports/templates/tableAndChart"],function(t,e,i,s,a,o,n){"use strict";return i.extend({template:n,initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.once("afterRender",()=>{this.listenTo(this.model,`change:${this.options.metric}`,this.render)})},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading()),this.updateTable(),this.$el.toggleClass("has-many-series",this.chart.series.length>10)},createChart:function(){const e=this.serializeChartSeries(),i=this.options.yAxisUnit||this.options.unit||"";let o=this.options.valueDecimals>=0?this.options.valueDecimals:0;"duration"===this.options.metric&&(o=1);let n=o;i&&2===n&&(e[0].data.length>52?n=0:e[0].data.length>39&&(n=1));const r={};"none"===this.model.getInterval()?(r.type="category",r.categories=this.serializeCategories()):(r.type="datetime",r.labels=a.labels(this));const h=t("app/highcharts");this.chart=new h.Chart({chart:{renderTo:this.$id("chart")[0],plotBorderWidth:1,spacing:[10,1,1,0]},exporting:{filename:this.options.filename,chartOptions:{title:{text:this.options.title},legend:{enabled:!0}},buttons:{contextButton:{align:"left"}},noDataLabels:!!e.length&&e.length*e[0].data.length>30},title:!1,noData:{},xAxis:r,yAxis:{title:!1,min:0,allowDecimals:!0===this.options.allowDecimals,opposite:!0,labels:{format:"{value}"+i}},tooltip:{shared:!0,valueDecimals:o,valueSuffix:i,headerFormatter:"datetime"===r.type?s.bind(this):void 0},legend:{enabled:!1},plotOptions:{column:{borderWidth:0,stacking:e.length>this.options.stackingLimit?"normal":null,dataLabels:{enabled:!!e.length&&e.length*e[0].data.length<=(1===e[0].data.length?40:35),format:"{y:."+n+"f}"}}},series:e})},updateChart:function(){this.chart.destroy(),this.createChart()},updateTable:function(){let t=this.options.absDecimals;!0===t&&(t=this.options.valueDecimals);let e=this.options.absUnit;!0===e&&(e=this.options.unit),this.$id("table").html(this.renderPartialHtml(o,{rows:(this.model.get(this.options.metric)||{rows:[]}).rows,relColumn:!1!==this.options.relColumn,absUnit:e||"",absDecimals:Math.pow(10,t||0)}))},serializeCategories:function(){const{rows:t}=this.model.get(this.options.metric)||{rows:[]},e=[];for(let i=0,s=Math.min(15,t.length);i<s;++i){const s=t[i];"total"!==s.id&&e.push(s.label)}return e},serializeChartSeries:function(){const{rows:t,series:i}=this.model.get(this.options.metric)||{rows:[],series:{}};if("none"===this.model.getInterval()){const e={id:this.options.metric,type:"column",name:this.t("series:entry"),data:[]};for(let i=0,s=Math.min(15,t.length);i<s;++i){const s=t[i];"total"!==s.id&&e.data.push({y:s.abs,color:s.color})}return[e]}return Object.keys(i).map(t=>{var s=i[t];return e.defaults(s,{id:t,type:"column",name:s.name||this.t(`series:${t}`),data:[]})})},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});