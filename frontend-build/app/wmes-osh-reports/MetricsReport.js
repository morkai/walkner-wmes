define(["underscore","h5.rql/index","app/i18n","app/time","app/core/Model","app/core/templates/userInfo","app/data/colorFactory","app/wmes-osh-common/dictionaries","./util/createDefaultFilter"],function(e,s,t,r,a,i,o,n,c){"use strict";return a.extend({urlRoot:"/osh/reports/metrics",nlsDomain:"wmes-osh-reports",defaults:function(){return{}},initialize:function(e,s){this.rqlQuery=s.rqlQuery&&!s.rqlQuery.isEmpty()?s.rqlQuery:c({orgUnitProperty:null,dateProperty:"month"})},fetch:function(s){return e.isObject(s)||(s={}),s.data=this.rqlQuery.toString(),a.prototype.fetch.call(this,s)},genClientUrl:function(){return`/osh/reports/metrics?${this.rqlQuery.toString()}`},parse:function(e){const s={interval:e.options.interval};return this.parseYearlyAccidents(s,e),this.parseTrc(s,e),this.parseIpr(s,e),this.parseIpp(s,e),this.parseObsPlan(s,e),this.parseContact(s,e),this.parseRiskyObs(s,e),this.parseObservers(s,e),s},parseYearlyAccidents:function(e,s){e.yearlyAccidents={categories:[],series:[{id:"total",name:t(this.nlsDomain,"metrics:yearlyAccidents:total"),data:[]}]},s.options.orgUnitId&&e.yearlyAccidents.series.push({id:"orgUnit",name:n.getLabel(s.options.orgUnitType,s.options.orgUnitId),data:[]}),s.yearlyAccidents.forEach(t=>{e.yearlyAccidents.categories.push(t.year),e.yearlyAccidents.series[0].data.push(t.total),s.options.orgUnitId&&e.yearlyAccidents.series[1].data.push(t.orgUnit)})},parseTrc:function(e,s){e.trc={months:[],fte:[],series:{itm:{name:t(this.nlsDomain,"metrics:trc:itm"),data:[],type:"column",color:"#d9534f",tooltip:{valueDecimals:0},zIndex:1},target:{name:t(this.nlsDomain,"metrics:trc:target"),data:[],color:"#ec971f",yAxis:1,marker:{enabled:!1},zIndex:2},mat:{name:t(this.nlsDomain,"metrics:trc:mat"),data:[],color:"#5cb85c",yAxis:1,zIndex:3}}},s.groups.forEach(s=>{e.trc.months.push(s.key),e.trc.fte.push(s.fte.itm),e.trc.series.itm.data.push({x:s.key,y:s.trc.itm}),e.trc.series.target.data.push({x:s.key,y:s.trc.target}),e.trc.series.mat.data.push({x:s.key,y:s.trc.mat})})},parseIpr:function(e,s){e.ipr={months:[],fte:[],nearMisses:[],kaizens:[],actions:[],observations:[],series:{target:{name:t(this.nlsDomain,"metrics:ipr:target"),data:[],color:"#ec971f",marker:{enabled:!1},zIndex:2},itm:{name:t(this.nlsDomain,"metrics:ipr:itm"),data:[],type:"column",color:"#31b0d5",zIndex:1},mat:{name:t(this.nlsDomain,"metrics:ipr:mat"),data:[],color:"#5cb85c",zIndex:3}}},s.groups.forEach(s=>{e.ipr.months.push(s.key),e.ipr.fte.push(s.fte.itm),e.ipr.nearMisses.push(s.nearMissCount),e.ipr.kaizens.push(s.kaizenCount),e.ipr.actions.push(s.actionCount),e.ipr.observations.push(s.obs.cards),e.ipr.series.target.data.push({x:s.key,y:s.ipr.target}),e.ipr.series.itm.data.push({x:s.key,y:s.ipr.itm}),e.ipr.series.mat.data.push({x:s.key,y:s.ipr.mat})})},parseIpp:function(e,s){e.ipp={months:[],totalFte:[],activeFte:[],totalObservers:[],activeObservers:[],series:{observers:{name:t(this.nlsDomain,"metrics:ipp:observers"),data:[],type:"column",color:"#31b0d5"},observersTarget:{name:t(this.nlsDomain,"metrics:ipp:observersTarget"),data:[],color:"#31b0d5",marker:{enabled:!1},zIndex:1},itm:{name:t(this.nlsDomain,"metrics:ipp:itm"),data:[],type:"column",color:"#5cb85c"},target:{name:t(this.nlsDomain,"metrics:ipp:target"),data:[],color:"#5cb85c",marker:{enabled:!1},zIndex:1}}},s.groups.forEach(s=>{e.ipp.months.push(s.key),e.ipp.totalFte.push(s.fte.itm),e.ipp.activeFte.push(s.userCount),e.ipp.totalObservers.push(s.fte.observers),e.ipp.activeObservers.push(s.obs.observerCount),e.ipp.series.itm.data.push({x:s.key,y:s.ipp.itm}),e.ipp.series.target.data.push({x:s.key,y:s.ipp.target}),e.ipp.series.observers.data.push({x:s.key,y:s.ipp.observers}),e.ipp.series.observersTarget.data.push({x:s.key,y:s.ipp.observersTarget})})},parseObsPlan:function(e,s){e.obsPlan={months:[],series:{plan:{name:t(this.nlsDomain,"metrics:obsPlan:plan"),data:[],type:"column",color:"#ec971f",tooltip:{valueDecimals:0}},done:{name:t(this.nlsDomain,"metrics:obsPlan:done"),data:[],type:"column",color:"#d9534f",tooltip:{valueDecimals:0}},percent:{name:t(this.nlsDomain,"metrics:obsPlan:percent"),data:[],color:"#31b0d5",yAxis:1,tooltip:{valueDecimals:1,valueSuffix:"%"}}}},s.groups.forEach(s=>{e.obsPlan.months.push(s.key),e.obsPlan.series.plan.data.push({x:s.key,y:s.obs.plan}),e.obsPlan.series.done.data.push({x:s.key,y:s.obs.cards,color:s.obs.cards>=s.obs.plan?"#5cb85c":"#d9534f"}),e.obsPlan.series.percent.data.push({x:s.key,y:s.obs.cardsPercent})})},parseContact:function(e,s){if(e.contact={months:[],fte:[],cards:[],series:{itm:{name:t(this.nlsDomain,"metrics:contact:itm"),data:[],type:"column",color:"#31b0d5",tooltip:{valueDecimals:3}},trend:{name:t(this.nlsDomain,"metrics:contact:trend"),data:[],color:"#2f7ed8",tooltip:{valueDecimals:3},marker:{enabled:!1},states:{hover:{lineWidth:0}},enableMouseTracking:!1},target:{name:t(this.nlsDomain,"metrics:contact:target"),data:[],color:"#ec971f",tooltip:{valueDecimals:3},marker:{enabled:!1}}}},s.groups.length>1){const t=s.groups[0],r=s.groups[s.groups.length-1];e.contact.series.trend.data.push({x:t.key,y:t.contact.itm},{x:r.key,y:r.contact.itm})}s.groups.forEach(s=>{e.contact.months.push(s.key),e.contact.fte.push(s.fte.itm),e.contact.cards.push(s.obs.cards),e.contact.series.itm.data.push({x:s.key,y:s.contact.itm,color:s.contact.itm>=s.contact.target?"#5cb85c":"#d9534f"}),e.contact.series.target.data.push({x:s.key,y:s.contact.target})})},parseRiskyObs:function(e,s){e.riskyObs={months:[],fte:[],cards:[],behaviors:[],workConditions:[],risky:[],series:{itm:{name:t(this.nlsDomain,"metrics:riskyObs:itm"),data:[],type:"column",color:"#31b0d5",tooltip:{valueDecimals:1,valueSuffix:"%"}},min:{name:t(this.nlsDomain,"metrics:riskyObs:min"),data:[],color:"#ec971f",tooltip:{valueDecimals:0,valueSuffix:"%"},marker:{enabled:!1}},max:{name:t(this.nlsDomain,"metrics:riskyObs:max"),data:[],color:"#ec971f",tooltip:{valueDecimals:0,valueSuffix:"%"},marker:{enabled:!1}}}},s.groups.forEach(s=>{e.riskyObs.months.push(s.key),e.riskyObs.cards.push(s.obs.cards),e.riskyObs.behaviors.push(s.obs.behaviors),e.riskyObs.workConditions.push(s.obs.workConditions),e.riskyObs.risky.push(s.obs.risky),e.riskyObs.series.itm.data.push({x:s.key,y:s.obs.riskyPercent,color:s.obs.riskyPercent>=s.obs.minRisky&&s.obs.riskyPercent<=s.obs.maxRisky?"#5cb85c":"#d9534f"}),e.riskyObs.series.min.data.push({x:s.key,y:s.obs.minRisky}),e.riskyObs.series.max.data.push({x:s.key,y:s.obs.maxRisky})})},parseObservers:function(e,s){if(e.observers={users:[],categories:[],series:{count:{name:t(this.nlsDomain,"metrics:observers:count"),data:[],type:"column",color:"#31b0d5"},target:{name:t(this.nlsDomain,"metrics:observers:target"),data:[],color:"#ec971f",marker:{enabled:!1}}}},!s.groups.length)return;const r=s.groups[s.groups.length-1];Object.keys(r.obs.observers).forEach(t=>{e.observers.users.push({label:s.users[t],userInfo:i({id:t,label:s.users[t]}),count:r.obs.observers[t]})}),e.observers.users.sort((e,s)=>{let t=e.count-s.count;return t||(t=e.label.localeCompare(s.label)),t}),e.observers.users.forEach(t=>{e.observers.categories.push(t.label),e.observers.series.count.data.push({y:t.count,color:t.count>=s.settings.minObsCards?"#5cb85c":"#d9534f"}),e.observers.series.target.data.push(s.settings.minObsCards)})}})});