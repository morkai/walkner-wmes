// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/data/localStorage","app/core/View","app/mrl/templates/page"],function(t,e,i,s,o,n,a,r,l){"use strict";function d(t,e,i){for(;t.length<e;)t=i+t;return t}function c(t){return d((t||0).toString(2),16,"0").split("").map(function(t){return+t}).reverse()}var u="production"===window.ENV?"192.168.21.110":"192.168.1.250:1337",p=[null,null,"probe1","probe1x","probe2","probe2x","probe3","probe3x","probe4","probe4x"],m={0:"off",1:"progress",2:"success",3:"failure"};return r.extend({template:l,events:{"click #-connection":function(){a.removeItem("MRL:LINE",""),window.location.reload()},"click #-start":function(){this.ws.send("start"),this.lockButtons()},"click #-reset":function(){this.ws.send("reset"),this.lockButtons()},"mousedown #-switchApps":function(t){this.startActionTimer("switchApps",t)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(t){this.startActionTimer("reboot",t)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(t){this.startActionTimer("shutdown",t)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},initialize:function(){this.actionTimer={action:null,time:null},this.tags={},this.once("afterRender",function(){this.model.prodLineId&&this.setUpWebSocket(),window.parent!==window&&window.parent.postMessage({type:"ready",app:"mrl"},"*")})},destroy:function(){e(window).off("."+this.idPrefix),this.ws.close(),this.ws=null},serialize:function(){return{idPrefix:this.idPrefix,embedded:window.parent!==window}},afterRender:function(){},setUpWebSocket:function(){var t=this,e=new WebSocket("ws://"+u+"/vis?line="+encodeURIComponent(t.model.prodLineId)),i=t.$id("connection").addClass("offline");e.onclose=function(){i.removeClass("online").addClass("offline"),Object.keys(t.tags).forEach(function(e){t.tags[e]=null}),t.render(),setTimeout(t.setUpWebSocket.bind(t),1e3)},e.onmessage=function(e){i.removeClass("offline").addClass("online"),t.change(JSON.parse(e.data))},t.ws=e},lockButtons:function(){var t=this.$id("buttons").find(".btn").prop("disabled",!0);setTimeout(function(){t.prop("disabled",!1)},2e3)},change:function(t){Object.assign(this.tags,t),this.update(t)},update:function(t){var e=this;Object.keys(t).forEach(function(t){var i=e.tags[t],s=null;"number"==typeof i&&(s=c(i),e.updateBits(t,s),e.updateLeds(t,s)),e.updaters[t]&&e.updaters[t].call(e,i,s,t),/^orderQty/.test(t)?e.updateOrderQty():/^probe/.test(t)&&e.updateProbeValidity(t)}),(void 0!==t.pe&&3===t.pe||void 0!==t.iso&&(2===t.iso||3===t.iso))&&e.updateOverallValidity()},updateBits:function(t,e){var i=this.$('.mrl-bits[data-tag="'+t+'"]');i.length&&i.text("["+e.slice(0,/^probe/.test(t)?7:11).reverse().join(" ")+"]")},updateLeds:function(t,e){this.$('.mrl-led[data-tag="'+t+'"]').each(function(){this.classList.remove("mrl-on","mrl-off"),this.classList.add(e[this.dataset.bit]?"mrl-on":"mrl-off")})},updateTest:function(t,e){this.$('[data-tag="'+t+'"]').removeClass("mrl-off mrl-progress mrl-success mrl-failure").addClass("mrl-"+m[e||0])},updateProbeValidity:function(t){var e=t.match(/^probe([0-9]+)x?$/)[1],i=this.$id("probe"+e),s=i.find('.mrl-led[data-tag="'+t+'"]'),o=this.$el.hasClass("core7")?7:5,n=7===o?s.filter(".mrl-on").length:0;if(5===o)for(var a=1;a<6;++a)n+=s[a].classList.contains("mrl-on")?1:0;i.find('tr[data-tag="'+t+'"]').removeClass("mrl-valid mrl-invalid").addClass(n===o?"mrl-valid":"mrl-invalid");var r=!0;i.find("tr[data-tag]").each(function(){this.classList.contains("mrl-inactive")||(r=r&&this.classList.contains("mrl-valid"))}),i.removeClass("mrl-invalid mrl-valid").addClass(r?"mrl-valid":"mrl-invalid")},updateOverallValidity:function(){var t=this;t.timers.clearOverallValidity||clearTimeout(t.timers.clearOverallValidity),document.body.classList.remove("mrl-valid","mrl-invalid"),2===this.tags.pe&&2===this.tags.iso&&0===this.$(".probe.mrl-invalid").length?document.body.classList.add("mrl-valid"):3!==this.tags.pe&&3!==this.tags.iso&&0===this.$(".probe.mrl-invalid").length||document.body.classList.add("mrl-invalid"),t.timers.clearOverallValidity=setTimeout(function(){document.body.classList.remove("mrl-valid","mrl-invalid")},5e3)},updateOrderQty:function(){this.$('.mrl-prop-value[data-tag="orderQty"]').text((this.tags.orderQtyLineDone||"0")+" / "+(this.tags.orderQtyTotalDone||"0")+" / "+(this.tags.orderQtyTodo||"0"))},updaters:{activeProbes:function(t,e){this.$el.removeClass("core5 core7").addClass(e[10]?"core7":"core5");for(var i=2;i<=9;++i)this.$('tr[data-tag="'+p[i]+'"]').removeClass("mrl-inactive mrl-active").addClass(0===e[i]?"mrl-inactive":"mrl-active"),this.updateProbeValidity(p[i])},sn:function(t){this.$('[data-tag="sn"]').text(t||"-")},order:function(t){this.$('[data-tag="order"]').text(t||"-")},action:function(t){this.$('[data-tag="action"]').text(i("mrl","action:"+(t||0)))},result:function(t){this.$('[data-tag="result"]').text(i("mrl","result:"+(t||0)))},pe:function(t){this.updateTest("pe",t)},iso:function(t){this.updateTest("iso",t)}},startActionTimer:function(t,e){this.actionTimer.action=t,this.actionTimer.time=Date.now(),e&&e.preventDefault()},stopActionTimer:function(t){if(this.actionTimer.action===t){var e=Date.now()-this.actionTimer.time>3e3;"switchApps"===t?e?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"mrl"},"*"):"reboot"===t?e?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):e&&"shutdown"===t&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}}})});