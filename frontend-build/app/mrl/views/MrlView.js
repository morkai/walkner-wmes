// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/data/localStorage","app/core/View","app/mrl/templates/page"],function(t,e,o,i,n,s,a,r,c){"use strict";function p(t,e,o){for(;t.length<e;)t=o+t;return t}function u(t){return p((t||0).toString(2),16,"0").split("").map(function(t){return+t}).reverse()}var d=[null,null,"probe1","probe1x","probe2","probe2x","probe3","probe3x","probe4","probe4x"],h={0:"off",1:"active",2:"success",3:"failure"};return r.extend({template:c,events:{"click #-connection":function(){a.removeItem("MRL:LINE",""),window.location.reload()},"mousedown #-switchApps":function(t){this.startActionTimer("switchApps",t)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(t){this.startActionTimer("reboot",t)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(t){this.startActionTimer("shutdown",t)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},initialize:function(){this.actionTimer={action:null,time:null},this.tags={}},destroy:function(){e(window).off("."+this.idPrefix)},serialize:function(){return{idPrefix:this.idPrefix,showParentControls:window.parent!==window}},afterRender:function(){this.model.prodLineId&&this.setUpWebSocket(),window.parent!==window&&window.parent.postMessage({type:"ready",app:"mrl"},"*")},setUpWebSocket:function(){var t=this,e="production"===window.ENV?"192.168.21.110":"192.168.1.250:1337",o=new WebSocket("ws://"+e+"/vis?line="+encodeURIComponent(t.model.prodLineId)),i=t.$id("connection").addClass("offline");o.onclose=function(){i.removeClass("online").addClass("offline"),Object.keys(t.tags).forEach(function(e){t.tags[e]=null}),setTimeout(t.setUpWebSocket.bind(t),1e3)},o.onmessage=function(e){i.removeClass("offline").addClass("online"),t.change(JSON.parse(e.data))}},change:function(t){Object.assign(this.tags,t),this.update(Object.keys(t))},update:function(t){var e=this;t.forEach(function(t){var o=e.tags[t],i=u(o);e.updateBits(t,i),e.updateLeds(t,i),e.updaters[t]&&e.updaters[t].call(e,o,i)})},updateBits:function(t,e){var o=this.$('.mrl-bits[data-tag="'+t+'"]');o.length&&o.text("["+e.slice(0,/^probe/.test(t)?7:11).reverse().join(" ")+"]")},updateLeds:function(t,e){this.$('.mrl-led[data-tag="'+t+'"]').each(function(){this.classList.remove("mrl-on","mrl-off"),this.classList.add(e[this.dataset.bit]?"mrl-on":"mrl-off")})},updateTest:function(t,e){this.$('[data-tag="'+t+'"]').removeClass("mrl-off mrl-active mrl-success mrl-failure").addClass("mrl-"+h[e||0])},updaters:{activeProbes:function(t,e){this.$el.removeClass("core5 core7").addClass(e[10]?"core7":"core5");for(var o=2;o<=9;++o)this.$('tr[data-tag="'+d[o]+'"]').toggleClass("inactive",0===e[o])},sn:function(t){this.$('[data-tag="sn"]').text(t||"-")},order:function(t){this.$('[data-tag="order"]').text(t||"-")},action:function(t){this.$('[data-tag="action"]').text(o("mrl","action:"+(t||0)))},result:function(t){this.$('[data-tag="result"]').text(o("mrl","result:"+(t||0)))},pe:function(t){this.updateTest("pe",t)},iso:function(t){this.updateTest("iso",t)}},startActionTimer:function(t,e){this.actionTimer.action=t,this.actionTimer.time=Date.now(),e&&e.preventDefault()},stopActionTimer:function(t){if(this.actionTimer.action===t){var e=Date.now()-this.actionTimer.time>3e3;"switchApps"===t?e?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"mrl"},"*"):"reboot"===t?e?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):e&&"shutdown"===t&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}}})});