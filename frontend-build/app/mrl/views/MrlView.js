// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/data/localStorage","app/core/View","app/mrl/templates/page"],function(t,i,e,s,o,n,a,r,c){"use strict";function l(t,i,e){for(;t.length<i;)t=e+t;return t}function d(t){return l((t||0).toString(2),16,"0").split("").map(function(t){return+t}).reverse()}var u="production"===window.ENV?"192.168.21.110":"192.168.1.250:1337",p=[null,null,"probe1","probe1x","probe2","probe2x","probe3","probe3x","probe4","probe4x"],m={0:"off",1:"progress",2:"success",3:"failure"};return r.extend({template:c,events:{"click #-connection":function(){a.removeItem("MRL:LINE",""),window.location.reload()},"click #-start":function(){this.ws.send("start"),this.lockButtons()},"click #-reset":function(){this.ws.send("reset"),this.lockButtons()},"mousedown #-switchApps":function(t){this.startActionTimer("switchApps",t)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(t){this.startActionTimer("reboot",t)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(t){this.startActionTimer("shutdown",t)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},initialize:function(){this.actionTimer={action:null,time:null},this.tags={},this.once("afterRender",function(){this.model.prodLineId&&this.setUpWebSocket(),window.parent!==window&&window.parent.postMessage({type:"ready",app:"mrl"},"*")})},destroy:function(){i(window).off("."+this.idPrefix),this.ws.close(),this.ws=null},serialize:function(){return{idPrefix:this.idPrefix,embedded:window.parent!==window}},afterRender:function(){},setUpWebSocket:function(){var t=this,i=new WebSocket("ws://"+u+"/vis?line="+encodeURIComponent(t.model.prodLineId)),e=t.$id("connection").addClass("offline");i.onclose=function(){e.removeClass("online").addClass("offline"),Object.keys(t.tags).forEach(function(i){t.tags[i]=null}),t.render(),setTimeout(t.setUpWebSocket.bind(t),1e3)},i.onmessage=function(i){e.removeClass("offline").addClass("online"),t.change(JSON.parse(i.data))},t.ws=i},lockButtons:function(){var t=this.$id("buttons").find(".btn").prop("disabled",!0);setTimeout(function(){t.prop("disabled",!1)},2e3)},change:function(t){Object.assign(this.tags,t),this.update(t)},update:function(t){var i=this;Object.keys(t).forEach(function(t){var e=i.tags[t],s=d(e);i.updateBits(t,s),i.updateLeds(t,s),i.updaters[t]&&i.updaters[t].call(i,e,s,t),/^probe/.test(t)&&i.updateProbeValidity(t)}),(void 0!==t.pe&&3===t.pe||void 0!==t.iso&&(2===t.iso||3===t.iso))&&i.updateOverallValidity()},updateBits:function(t,i){var e=this.$('.mrl-bits[data-tag="'+t+'"]');e.length&&e.text("["+i.slice(0,/^probe/.test(t)?7:11).reverse().join(" ")+"]")},updateLeds:function(t,i){this.$('.mrl-led[data-tag="'+t+'"]').each(function(){this.classList.remove("mrl-on","mrl-off"),this.classList.add(i[this.dataset.bit]?"mrl-on":"mrl-off")})},updateTest:function(t,i){this.$('[data-tag="'+t+'"]').removeClass("mrl-off mrl-progress mrl-success mrl-failure").addClass("mrl-"+m[i||0])},updateProbeValidity:function(t){var i=t.match(/^probe([0-9]+)x?$/)[1],e=this.$id("probe"+i),s=this.$el.hasClass("core7")?7:5,o=e.find('.mrl-on[data-tag="'+t+'"]').length;e.find('tr[data-tag="'+t+'"]').removeClass("mrl-valid mrl-invalid").addClass(o===s?"mrl-valid":"mrl-invalid");var n=!0;e.find("tr[data-tag]").each(function(){this.classList.contains("mrl-inactive")||(n=n&&this.classList.contains("mrl-valid"))}),e.removeClass("mrl-invalid mrl-valid").addClass(n?"mrl-valid":"mrl-invalid")},updateOverallValidity:function(){var t=this;t.timers.clearOverallValidity||clearTimeout(t.timers.clearOverallValidity),document.body.classList.remove("mrl-valid","mrl-invalid"),2===this.tags.pe&&2===this.tags.iso&&0===this.$(".probe.mrl-invalid").length?document.body.classList.add("mrl-valid"):3!==this.tags.pe&&3!==this.tags.iso&&0===this.$(".probe.mrl-invalid").length||document.body.classList.add("mrl-invalid"),t.timers.clearOverallValidity=setTimeout(function(){document.body.classList.remove("mrl-valid","mrl-invalid")},5e3)},updaters:{activeProbes:function(t,i){this.$el.removeClass("core5 core7").addClass(i[10]?"core7":"core5");for(var e=2;e<=9;++e)this.$('tr[data-tag="'+p[e]+'"]').removeClass("mrl-inactive mrl-active").addClass(0===i[e]?"mrl-inactive":"mrl-active"),this.updateProbeValidity(p[e])},sn:function(t){this.$('[data-tag="sn"]').text(t||"-")},order:function(t){this.$('[data-tag="order"]').text(t||"-")},action:function(t){this.$('[data-tag="action"]').text(e("mrl","action:"+(t||0)))},result:function(t){this.$('[data-tag="result"]').text(e("mrl","result:"+(t||0)))},pe:function(t){this.updateTest("pe",t)},iso:function(t){this.updateTest("iso",t)}},startActionTimer:function(t,i){this.actionTimer.action=t,this.actionTimer.time=Date.now(),i&&i.preventDefault()},stopActionTimer:function(t){if(this.actionTimer.action===t){var i=Date.now()-this.actionTimer.time>3e3;"switchApps"===t?i?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"mrl"},"*"):"reboot"===t?i?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):i&&"shutdown"===t&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}}})});