define(["underscore","app/user","app/viewport","app/core/views/FormView","app/core/util/idAndLabel","app/users/util/setUpUserSelect2","app/wmes-dummyPaint-jobs/DpJobCollection","app/wmes-dummyPaint-workers/DpWorkerCollection","../dictionaries","app/wmes-dummyPaint-orders/templates/startJob"],function(e,t,s,i,r,o,a,n,d,l){"use strict";return i.extend({template:l,nlsDomain:"wmes-dummyPaint-orders",remoteTopics:{"dummyPaint.jobs.updated":"onJobUpdated","dummyPaint.workers.updated":"onWorkerUpdated"},events:Object.assign({"click #-codes-all":function(){var e=this.$id("codes");window.$codes=e,e.select2("data",e.data("select2").opts.data.filter(function(e){return!e.disabled}))}},i.prototype.events),initialize:function(){i.prototype.initialize.apply(this,arguments),this.jobs=new a(null,{rqlQuery:"status=inProgress"}),this.workers=new n(null,{rqlQuery:"sort(name)&lastSeenAt=gte=0"}),this.listenTo(this.jobs,"reset",this.setUpCodesSelect2),this.listenTo(this.workers,"reset",this.setUpWorkerSelect2),this.timers.setUpNotifySelect2=setInterval(this.setUpWorkerSelect2.bind(this),12e4)},afterRender:function(){i.prototype.afterRender.apply(this,arguments),this.setUpCodesSelect2(),this.setUpWorkerSelect2(),this.setUpNotifySelect2(),this.loadJobs(),this.loadWorkers()},loadJobs:function(){this.$id("codes").select2("disable"),this.promised(this.jobs.fetch({reset:!0}))},loadWorkers:function(){this.$id("workers").select2("disable"),this.workers.rqlQuery.selector.args[1].args[1]=Date.now()-3e5,this.promised(this.workers.fetch({reset:!0}))},setUpCodesSelect2:function(){var e=this.$id("codes"),t={};this.jobs.forEach(function(e){"inProgress"===e.get("status")&&e.get("codes").forEach(function(e){t[e]=!0})});var s=e.val().split(",").filter(function(e){return e.length>0&&!t[e]}).join(",");e.val(s),e.select2({multiple:!0,data:d.codes.map(function(e){return{id:e.id,text:e.getLabel(),disabled:!0===t[e.id]}})}),e.select2("enable")},setUpWorkerSelect2:function(){var e=this.$id("worker"),t=Date.now()-3e5,s=this.workers.filter(function(e){return Date.parse(e.get("lastSeenAt"))>=t}),i=e.val();i&&!s.find(function(e){return e.id===i})&&e.val("");var o=s.map(r);e.select2({data:o}),e.select2("enable"),e.val()||1!==o.length||e.select2("data",o[0])},setUpNotifySelect2:function(){o(this.$id("notify"),{view:this,multiple:!0,noPersonnelId:!0}),t.data.email&&this.$id("notify").select2("data",[{id:t.data._id,text:t.getLabel()}])},onJobUpdated:function(e){var t=this,s=!1;[].concat(e.added||[],e.updated||[]).forEach(function(e){var i=t.jobs.get(e._id);i?"inProgress"!==e.status?(t.jobs.remove(i),s=!0):"inProgress"!==i.get("status")&&(i.set(e),s=!0):"inProgress"===e.status&&(t.workers.add(e),s=!0)}),s&&t.setUpCodesSelect2()},onWorkerUpdated:function(e){var t=this,s=!1,i=Date.now()-3e5;[].concat(e.added||[],e.updated||[]).forEach(function(e){var r=t.workers.get(e._id);if(r){if(!s){var o=Date.parse(r.get("lastSeenAt"))>=i,a=Date.parse(e.lastSeenAt)>=i;s=!o&&a||o&&!a}r.set(e)}else t.workers.add(e),s=!0}),s&&t.setUpWorkerSelect2()},serializeForm:function(e){return e.codes=e.codes.split(","),e.notify=o.getUserInfo(this.$id("notify")),e},submitRequest:function(){return this.hideErrorMessage(),this.$errorMessage=s.msg.show({type:"warning",text:this.t("startJob:msg:starting")}),i.prototype.submitRequest.apply(this,arguments)},getFailureText:function(t){var s=t.responseJSON&&t.responseJSON.error||{},i=s.code||"",r={};return"CODE_IN_PROGRESS"===i&&(r.code=e.intersection(s.newJob.codes,s.inProgressJob.codes).join(", ")),this.t.has("startJob:msg:"+i)?this.t("startJob:msg:"+i,r):this.t("startJob:msg:failure")},handleSuccess:function(){this.hideErrorMessage(),s.msg.show({type:"success",time:2500,text:this.t("startJob:msg:success")}),s.closeDialog()}})});