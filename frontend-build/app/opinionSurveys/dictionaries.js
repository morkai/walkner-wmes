// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","../broker","../pubsub","../user","../opinionSurveyDivisions/OpinionSurveyDivisionCollection","../opinionSurveyEmployers/OpinionSurveyEmployerCollection","../opinionSurveyQuestions/OpinionSurveyQuestionCollection"],function(e,n,o,i,l,u,t){"use strict";function r(){c=null,null!==f&&(f.destroy(),f=null),p.loaded=!1,a.forEach(function(e){p[e].reset()})}function s(e,o){var i=o.split("."),l=p[i[1]];if(l){switch(i[1]){case"added":l.add(e.model);break;case"edited":var u=l.get(e.model._id);u&&u.set(e.model);break;case"deleted":l.remove(l.get(e.model._id))}n.publish(o,e)}}var a=["divisions","employers","questions"],d=null,c=null,f=null,p={actionStatuses:["planned","progress","done","failed","late"],divisions:new l,employers:new u,questions:new t,loaded:!1,load:function(){return null!==c&&(clearTimeout(c),c=null),p.loaded?null:null!==d?d:(d=e.ajax({url:"/opinionSurveys/dictionaries"}),d.done(function(e){p.loaded=!0,a.forEach(function(n){p[n].reset(e[n])})}),d.fail(r),d.always(function(){d=null}),f=o.sandbox(),a.forEach(function(e){f.subscribe("opinionSurveys."+e+".**",s)}),d)},unload:function(){null!==c&&clearTimeout(c),c=setTimeout(r,3e4)},getLabel:function(e,n){if(!p[e])return n;var o=p[e].get(n);return o?o.getLabel():n}};return p});