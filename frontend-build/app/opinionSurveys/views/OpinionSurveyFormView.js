// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/data/orgUnits","app/users/util/setUpUserSelect2","../dictionaries","../OpinionSurvey","../util/formatQuestionResult","app/opinionSurveys/templates/form","app/opinionSurveys/templates/formSuperiorTr","app/opinionSurveys/templates/formQuestionTr"],function(e,t,i,s,n,r,o,a,u,l,d,p,c,f,m,h){"use strict";return a.extend({template:f,superiorCounter:0,questionCounter:0,events:e.extend({"click .opinionSurveys-form-deleteRow":function(e){var i=this.$(e.currentTarget).closest("tr"),s=i.closest("table");i.fadeOut("fast",function(){t(this).remove(),s.find("tbody").children().length||s.css("display","none")}),s.hasClass("opinionSurveys-form-questionsTable")&&this.setUpQuestionsSelect2(!0)},"click .opinionSurveys-form-moveRowUp":function(e){var t=this.$(e.currentTarget),i=t.closest("tr"),s=i.prev();if(s.length)i.insertBefore(s);else{var n=i.parent().children();n.length>1&&i.insertAfter(n.last())}t.focus()},"click .opinionSurveys-form-moveRowDown":function(e){var t=this.$(e.currentTarget),i=t.closest("tr"),s=i.next();if(s.length)i.insertAfter(s);else{var n=i.parent().children();n.length>1&&i.insertBefore(n.first())}t.focus()}},a.prototype.events),checkValidity:function(){return!0},serializeToForm:function(){var e=this.model.toJSON();return e.startDate&&(e.startDate=s.format(e.startDate,"YYYY-MM-DD")),e.endDate&&(e.endDate=s.format(e.endDate,"YYYY-MM-DD")),e.employers=(e.employers||[]).map(function(e){return e._id}).join(","),e},serializeForm:function(e){return e.employers=this.$id("employers").select2("data").map(function(e){return d.employers.get(e.id).toJSON()}),e.superiors||(e.superiors=[]),e.superiors.sort(function(e,t){if(e.division===t.division)return e.full.localeCompare(t.full);var i=e.division.match(/([a-z])$/),s=t.division.match(/([a-z])$/);return i&&!s?-1:!i&&s?1:i||s?i[1].localeCompare(s[1]):e.division.localeCompare(t.division)}),e},afterRender:function(){a.prototype.afterRender.call(this),this.renderSuperiorsTable(),this.renderQuestionsTable(),this.setUpEmployersSelect2(),this.setUpSuperiorsSelect2(),this.setUpQuestionsSelect2(),this.$("input[autofocus]").focus()},setUpEmployersSelect2:function(){this.$id("employers").select2({multiple:!0,data:d.employers.map(o)})},setUpSuperiorsSelect2:function(){var e=this.$id("superiorsTable"),i=e.find("tbody"),s=l(this.$id("superiors")),n=this;i.children().length||e.css("display","none"),s.on("change",function(r){if(s.select2("data",null),r.added){var o=r.added.user;if(!i.find('[value="'+o._id+'"]').length){var a="";"division"===o.orgUnitType?a=o.orgUnitId:"subdivision"===o.orgUnitType&&(a=u.getByTypeAndId("subdivision",o.orgUnitId).get("division"));var l=d.divisions.get(a);l||(l=d.divisions.at(0));var p=t(m({i:++n.superiorCounter,superior:{_id:o._id,full:o.lastName+" "+o.firstName,"short":o.lastName+" "+o.firstName.substring(0,1)+".",division:l?l.id:""}}));i.append(p),e.css("display",""),n.setUpSuperiorsDivisionSelect2(p),p.find('[name$="short"]').select()}}})},setUpSuperiorsDivisionSelect2:function(e){e.find('[name$="division"]').select2({minimumResultsForSearch:-1,data:d.divisions.map(function(e){return{id:e.id,text:e.get("full")+" ("+e.get("short")+")"}})})},setUpQuestionsSelect2:function(e){function i(e,t){var i=t.find('input[name$="_id"]').map(function(){return this.value}).get();return e.select2({formatResult:c,minimumResultsForSearch:-1,data:d.questions.map(function(e){return{id:e.id,text:e.get("short"),question:e}}).filter(function(e){return-1===i.indexOf(e.id)})})}var s=this.$id("questionsTable"),n=s.find("tbody"),r=i(this.$id("questions"),n);if(!e){var o=this;n.children().length||s.css("display","none"),r.on("change",function(e){if(r.select2("data",null),e.added){var a=e.added.question,u=t(h({i:++o.questionCounter,question:{_id:a.id,"short":a.get("short"),full:a.get("full")}}));u.appendTo(n),s.css("display",""),u.find('[name$="short"]').select(),i(r,n)}})}},renderSuperiorsTable:function(){var e=this,i=this.$id("superiorsTable").find("tbody");(this.model.get("superiors")||[]).forEach(function(s){var n=t(m({i:++e.superiorCounter,superior:s}));i.append(n),e.setUpSuperiorsDivisionSelect2(n)})},renderQuestionsTable:function(){var e=this,i=this.$id("questionsTable").find("tbody");(this.model.get("questions")||[]).forEach(function(s){var n=t(h({i:++e.questionCounter,question:s}));i.append(n)})}})});