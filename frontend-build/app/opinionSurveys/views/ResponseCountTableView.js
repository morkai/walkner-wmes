// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/core/View","../dictionaries","app/opinionSurveys/templates/responseCountTable"],function(e,t,o,n,r){"use strict";return o.extend({template:r,beforeRender:function(){this.stopListening(this.model.report,"change:responseCountTotal",this.render)},afterRender:function(){this.listenToOnce(this.model.report,"change:responseCountTotal",this.render)},serialize:function(){var t={},o=[],r=this.model.report,s=r.get("responseCountTotal");e.forEach(r.get("usedDivisions"),function(o,r){var i=s[r];i&&(t[r]={},e.forEach(i,function(e,o){t[r][o]=n.divisions.get(r).get("short")+" \\ "+n.employers.get(o).get("short")}))});var i=this.model.surveys;return e.forEach(this.model.report.get("responseCountBySurvey"),function(t,n){var r=i.get(n);if(r){var s=r.cacheMaps.employeeCount,a={survey:r.getLabel()};e.forEach(t,function(t,o){var n=s[o]||{};a[o]={},e.forEach(t,function(e,t){var r=n[t]||0;a[o][t]={responseCount:e,employeeCount:r,percent:0!==r?Math.round(e/r*100):0}})}),o.push(a)}}),{idPrefix:this.idPrefix,columns:t,rows:o}}})});