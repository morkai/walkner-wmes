// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/core/View","app/core/util/bindLoadingMessage","../dictionaries","../OpinionSurveyCollection","../OpinionSurveyReport","../OpinionSurveyReportQuery","../views/OpinionSurveyReportFilterView","../views/ResponseCountTableView","../views/ResponseCountByDivisionChartView","../views/ResponseCountBySuperiorChartView","../views/ResponsePercentBySurveyChartView","../views/ResponsePercentByDivisionChartView","../views/AnswerCountBySurveyChartView","../views/AnswerCountBySuperiorChartView","../views/PositiveAnswerPercentBySurveyChartView","../views/PositiveAnswerPercentByDivisionChartView","app/opinionSurveys/templates/reportPage"],function(e,i,r,s,t,n,o,u,y,p,h,w,v,a,c,l,C,f,S){"use strict";return r.extend({layoutName:"page",template:S,breadcrumbs:[i.bound("opinionSurveys","BREADCRUMBS:base"),i.bound("opinionSurveys","BREADCRUMBS:report")],actions:function(){return[{label:i.bound("opinionSurveys","PAGE_ACTION:settings"),icon:"cogs",privileges:"OPINION_SURVEYS:MANAGE",href:"#opinionSurveys;settings?tab=reports"}]},initialize:function(){this.defineModels(),this.defineViews(),this.setView(".filter-container",this.filterView),["responseCount","responseCountByDivision","responseCountBySuperior","responsePercentBySurvey","responsePercentByDivision","answerCountBySurvey","answerCountBySuperior","positiveAnswerPercentBySurvey","positiveAnswerPercentByDivision"].forEach(function(e){this.setView(".opinionSurveys-report-"+e+"-container",this[e+"View"])},this)},defineModels:function(){this.surveys=s(new n(null,{rqlQuery:"sort(-startDate)"}),this),this.query=u.fromQuery(this.options.query),this.report=s(new o(null,{query:this.query}),this),this.listenTo(this.surveys,"reset",this.surveys.buildCacheMaps.bind(this.surveys)),this.listenTo(this.query,"change",this.onQueryChange)},defineViews:function(){var e={model:{surveys:this.surveys,report:this.report}};this.filterView=new y({surveys:this.surveys,query:this.query}),this.responseCountView=new p({model:{surveys:this.surveys,query:this.query,report:this.report}}),this.responseCountByDivisionView=new h(e),this.responseCountBySuperiorView=new w(e),this.responsePercentBySurveyView=new v(e),this.responsePercentByDivisionView=new a(e),this.answerCountBySurveyView=new c(e),this.answerCountBySuperiorView=new l(e),this.positiveAnswerPercentBySurveyView=new C(e),this.positiveAnswerPercentByDivisionView=new f(e)},destroy:function(){t.unload()},load:function(i){if(t.loaded)return i(this.surveys.fetch({reset:!0}),this.report.fetch());var r=this;return t.load().then(function(){return e.when(r.surveys.fetch({reset:!0}),r.report.fetch())})},afterRender:function(){t.load()},onQueryChange:function(e,i){i&&i.reset&&(this.broker.publish("router.navigate",{url:this.report.genClientUrl(),replace:!0,trigger:!1}),this.promised(this.report.fetch()))}})});