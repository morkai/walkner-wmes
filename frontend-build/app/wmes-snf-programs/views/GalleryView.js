define(["underscore","app/i18n","app/viewport","app/core/View","app/core/views/DialogView","./ImageView","./ImageFormView","app/wmes-snf-programs/templates/gallery","app/wmes-snf-programs/templates/galleryThumbnail","app/wmes-snf-programs/templates/yesNoDialog"],function(e,t,a,i,n,s,r,l,o,d){"use strict";return i.extend({template:l,events:{"click #-upload":function(){this.$id("files").click()},"change #-files":function(e){this.handleFiles(e.target.files)},dragenter:function(){return this.enterCount<=0?this.enterCount=1:++this.enterCount,!1},dragleave:function(){--this.enterCount,this.enterCount<=0&&this.$el.removeClass("is-valid is-invalid")},dragover:function(e){return this.$el.addClass(this.findImages(e.originalEvent.dataTransfer.items).length?"is-valid":"is-invalid"),!1},drop:function(e){return this.enterCount=0,this.$el.removeClass("is-valid is-invalid"),this.handleFiles(e.originalEvent.dataTransfer.files),!1},"click .snf-programs-image-edit":function(t){var i=this.$(t.target).closest(".thumbnail").attr("data-id"),n=new r({model:{nlsDomain:this.model.nlsDomain,programId:this.model.id,image:e.find(this.model.get("images"),function(e){return e._id===i})}});a.showDialog(n,this.t("gallery:edit:title"))},"click .snf-programs-image-delete":function(e){var t=this.$(e.target).closest(".thumbnail"),i=this,s=new n({template:d.bind(null,{severity:"danger",message:i.t("gallery:delete:message"),yes:i.t("gallery:delete:yes"),no:i.t("gallery:delete:no")})});s.on("answered",function(e){"yes"===e&&i.deleteImage(t)}),a.showDialog(s,i.t("gallery:delete:title"))},"click .thumbnail > a":function(t){var i=this.$(t.target).closest(".thumbnail").attr("data-id"),n=e.find(this.model.get("images"),function(e){return e._id===i});if(!n)return!1;var r=new s({model:{nlsDomain:this.model.nlsDomain,programId:this.model.id,image:n}});return a.showDialog(r),!1}},remoteTopics:{"snf.programs.*.images.*":function(e,t){var a=this.model;if(e.program===a.id){var i=a.get("images"),n=t.split(".").pop();switch(n){case"added":i=[].concat(i,e.images);break;case"deleted":i=i.filter(function(t){return t._id!==e.image});break;case"edited":for(var s=0;s<i.length;++s){if(i[s]._id===e.image._id){(i=[].concat(i))[s]=e.image;break}}}a.set("images",i,{action:n,message:e})}}},initialize:function(){this.enterCount=0,this.listenTo(this.model,"change:images",this.onImagesChanged)},getTemplateData:function(){return{program:this.model.toJSON()}},findImages:function(e){for(var t=[],a=0;a<e.length;++a){var i=e[a];/^image\/(jpeg|png|gif)$/.test(i.type)&&t.push(i)}return t},findThumbnail:function(e){return this.$('.thumbnail[data-id="'+e+'"]')},deleteImage:function(e){e.fadeOut("fast"),e.find(".btn").attr("disabled",!0);var t=e.attr("data-id");this.ajax({type:"DELETE",url:"/snf/programs/"+this.model.id+"/images/"+t}).fail(function(){e.find(".btn").attr("disabled",!1),e.fadeIn("fast")})},handleFiles:function(e){var t=this.findImages(e);if(t.length){for(var a={},i=0;i<t.length;++i){var n=t[i],s=Date.now().toString(36).toUpperCase()+(1e9+1e9*Math.random()).toString(36).replace(".","").substr(0,10).toUpperCase();this.createImageThumbnail(n,s),a[s]=n}this.uploadImageFiles(a)}},createImageThumbnail:function(e,t){if(!this.findThumbnail(t).length){var a=this.renderPartial(o,{program:{_id:this.model.id},image:{_id:t,type:this.resolveImageType(e.type),label:e.name.replace(/\..*?$/,"")}}),i=a.find("img")[0];if(e.size){i.src="";var n=new FileReader;n.onload=function(e){i.src=e.target.result},n.readAsDataURL(e),a.addClass("is-uploading").appendTo(this.$(".panel-body"))}else a.hide().appendTo(this.$(".panel-body")).fadeIn("fast").find("a")}},resolveImageType:function(e){switch(e){case"image/jpeg":return"jpg";case"image/png":return"png";case"image/gif":return"gif";default:return e}},uploadImageFiles:function(t){var a=new FormData;e.forEach(t,function(e,t){a.append(t,e)});var i=this.ajax({type:"POST",url:"/snf/programs/"+this.model.id+"/images",data:a,processData:!1,contentType:!1}),n=this;i.fail(function(){Object.keys(t).forEach(function(e){var t=n.findThumbnail(e);t.fadeOut("fast",function(){t.remove()})})}),i.done(function(){Object.keys(t).forEach(function(e){n.findThumbnail(e).removeClass("is-uploading")})})},onImagesChanged:function(e,t,a){var i,n=a.message;switch(a.action){case"added":n.images.forEach(function(e){var t={type:e.type,name:e.label+"."+e.type};this.createImageThumbnail(t,e._id)},this);break;case"deleted":(i=this.findThumbnail(n.image._id)).length&&i.fadeOut("fast",function(){i.remove()});break;case"edited":this.findThumbnail(n.image._id).find(".thumbnail-label").text(n.image.label)}}})});