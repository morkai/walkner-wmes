// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","app/router","../View","app/core/templates/actionForm"],function(e,t,o,i,r,n){"use strict";var s={formMethod:"POST",formAction:"/",formActionText:t.bound("core","ACTION_FORM:BUTTON"),formActionSeverity:"primary",messageText:t.bound("core","ACTION_FORM:MESSAGE"),successUrl:null,cancelUrl:"#",failureText:t.bound("core","ACTION_FORM:MESSAGE_FAILURE"),requestData:null},a=r.extend({template:n,events:{submit:"submitForm"},$errorMessage:null,initialize:function(){e.defaults(this.options,s),this.$errorMessage=null},destroy:function(){this.hideErrorMessage()},serialize:function(){return{formMethod:this.options.formMethod,formAction:this.options.formAction,formActionText:this.options.formActionText,formActionSeverity:this.options.formActionSeverity,messageText:this.options.messageText,cancelUrl:this.options.cancelUrl,model:this.model}},afterRender:function(){this.model&&this.listenToOnce(this.model,"change",this.render)},submitForm:function(){this.hideErrorMessage();var t=this.$('[type="submit"]').attr("disabled",!0),i=this.options,r=i.requestData;r=null==r?void 0:e.isFunction(r)?r.call(this):JSON.stringify(r);var n=this.ajax({type:i.formMethod,url:i.formAction,data:r}),s=this;return n.done(function(t){s.trigger("success",t),e.isString(i.successUrl)&&s.broker.publish("router.navigate",{url:i.successUrl,trigger:!0,replace:!0})}),n.fail(function(e){s.trigger("failure",e),i.failureText&&(s.$errorMessage=o.msg.show({type:"error",time:5e3,text:i.failureText}))}),n.always(function(){t.attr("disabled",!1)}),!1},hideErrorMessage:function(){null!==this.$errorMessage&&(o.msg.hide(this.$errorMessage),this.$errorMessage=null)}},{showDialog:function(i){var r=null;if(i.nlsDomain||(i.nlsDomain=i.model.getNlsDomain()),i.nlsDomain){r=t.bound(i.nlsDomain,"ACTION_FORM:DIALOG_TITLE:"+i.actionKey);var n=i.labelAttribute?i.model.get(i.labelAttribute):i.model.getLabel();i.messageText||(n?i.messageText=t.bound(i.nlsDomain,"ACTION_FORM:MESSAGE_SPECIFIC:"+i.actionKey,{label:n}):i.messageText=t.bound(i.nlsDomain,"ACTION_FORM:MESSAGE:"+i.actionKey)),i.formActionText||(i.formActionText=t.bound(i.nlsDomain,"ACTION_FORM:BUTTON:"+i.actionKey)),i.failureText||(i.failureText=t.bound(i.nlsDomain,"ACTION_FORM:MESSAGE_FAILURE:"+i.actionKey))}!i.formAction&&e.isFunction(i.model.url)&&(i.formAction=i.model.url()),e.isObject(i.requestData)||(i.requestData={}),e.isString(i.requestData.action)||(i.requestData.action=i.actionKey);var s=new a(i);return s.on("success",function(){o.closeDialog()}),o.showDialog(s,r),s},showDeleteDialog:function(e){return e.actionKey="delete",e.formMethod="DELETE",e.formActionSeverity="danger",a.showDialog(e)}});return a});