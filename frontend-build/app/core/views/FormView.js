define(["jquery","underscore","form2js","js2form","app/viewport","../View"],function(e,t,n,i,r,o){return o.extend({events:{submit:"submitForm"},idPrefix:"formView",$errorMessage:null,initialize:function(){this.idPrefix=t.uniqueId(this.idPrefix),this.$errorMessage=null,this.listenTo(this.model,"change",function(){this.isRendered()&&i(this.el,this.serializeToForm())})},destroy:function(){this.hideErrorMessage()},serialize:function(){return{idPrefix:this.idPrefix,formMethod:this.options.formMethod,formAction:this.options.formAction,formActionText:this.options.formActionText,panelTitleText:this.options.panelTitleText,model:this.model.toJSON()}},afterRender:function(){i(this.el,this.serializeToForm())},serializeToForm:function(){return this.model.toJSON()},serializeForm:function(e){return e},submitForm:function(){if(this.hideErrorMessage(),!this.el.checkValidity())return!1;var e=this.serializeForm(n(this.el));if(!this.checkValidity(e))return!1;var t=this.$('[type="submit"]').attr("disabled",!0),i=this.promised(this.model.save(e,{wait:!0})),o=this;return i.done(function(){o.broker.publish("router.navigate",{url:o.model.genClientUrl(),trigger:!0})}),i.fail(function(){o.$errorMessage=r.msg.show({type:"error",text:o.options.failureText})}),i.always(function(){t.attr("disabled",!1)}),!1},hideErrorMessage:function(){null!==this.$errorMessage&&(r.msg.hide(this.$errorMessage),this.$errorMessage=null)},checkValidity:function(e){return!!e}})});