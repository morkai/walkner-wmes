// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user","../View","app/core/templates/navbar"],function(t,e,a,i,n){var s=i.extend({template:n,localTopics:{"router.executing":function(t){this.activateNavItem(this.getModuleNameFromPath(t.req.path))},"socket.connected":function(){this.setConnectionStatus("online")},"socket.connecting":function(){this.setConnectionStatus("connecting")},"socket.connectFailed":function(){this.setConnectionStatus("offline")},"socket.disconnected":function(){this.setConnectionStatus("offline")}},events:{"click .disabled a":function(t){t.preventDefault()},"click .navbar-account-locale":function(t){t.preventDefault(),this.changeLocale(t.currentTarget.getAttribute("data-locale"))},"click .navbar-account-logIn":function(t){t.preventDefault(),this.trigger("logIn")},"click .navbar-account-logOut":function(t){t.preventDefault(),this.trigger("logOut")},"click .navbar-feedback":function(t){t.preventDefault(),t.target.disabled=!0,this.trigger("feedback",function(){t.target.disabled=!1})}}});return s.DEFAULT_OPTIONS={currentPath:"/",activeItemClassName:"active",offlineStatusClassName:"navbar-status-offline",onlineStatusClassName:"navbar-status-online",connectingStatusClassName:"navbar-status-connecting"},s.prototype.initialize=function(){t.defaults(this.options,s.DEFAULT_OPTIONS),this.activeModuleName="",this.navItems=null,this.$activeNavItem=null,this.activateNavItem(this.getModuleNameFromPath(this.options.currentPath))},s.prototype.beforeRender=function(){this.navItems=null,this.$activeNavItem=null},s.prototype.afterRender=function(){this.selectActiveNavItem(),this.setConnectionStatus(this.socket.isConnected()?"online":"offline"),this.hideNotAllowedEntries(),this.hideEmptyEntries()},s.prototype.serialize=function(){return{user:a}},s.prototype.activateNavItem=function(t){t!==this.activeModuleName&&(this.activeModuleName=t,this.selectActiveNavItem())},s.prototype.changeLocale=function(t){e.reload(t)},s.prototype.setConnectionStatus=function(t){if(this.isRendered()){var e=this.$(".navbar-account-status");e.removeClass(this.options.offlineStatusClassName).removeClass(this.options.onlineStatusClassName).removeClass(this.options.connectingStatusClassName),e.addClass(this.options[t+"StatusClassName"]),this.toggleConnectionStatusEntries("online"===t)}},s.prototype.getModuleNameFromPath=function(t){if("/"===t[0]&&(t=t.substr(1)),""===t)return"";var e=t.match(/^([a-z0-9][a-z0-9\-]*[a-z0-9]*)/i);return e?e[1]:null},s.prototype.selectActiveNavItem=function(){if(this.isRendered()){null===this.navItems&&this.cacheNavItems();var e=this.options.activeItemClassName;null!==this.$activeNavItem&&this.$activeNavItem.removeClass(e);var a=this.navItems[this.activeModuleName];t.isUndefined(a)?this.$activeNavItem=null:(a.addClass(e),this.$activeNavItem=a)}},s.prototype.cacheNavItems=function(){this.navItems={},this.$(".nav > li").each(this.cacheNavItem.bind(this))},s.prototype.cacheNavItem=function(t,e){var a=this.$(e);a.hasClass(this.options.activeItemClassName)&&(this.$activeNavItem=a);var i=a.find("a").attr("href");if(i&&"#"===i[0]){var n=this.getModuleNameFromPath(i.substr(1));this.navItems[n]=a}else if(a.hasClass("dropdown")){var s=this;a.find(".dropdown-menu > li > a").each(function(){var t=this.getAttribute("href");if(t&&"#"===t[0]){var e=s.getModuleNameFromPath(t.substr(1));s.navItems[e]=a}})}},s.prototype.hideNotAllowedEntries=function(){var t=this;this.$("li[data-privilege]").each(function(){var e=t.$(this),i=e.attr("data-privilege").split(" ");e[a.isAllowedTo(i)?"show":"hide"]()}),this.$("li[data-loggedin]").each(function(){var e=t.$(this),i=e.attr("data-loggedin"),n="false"===i?!a.isLoggedIn():a.isLoggedIn();e[n?"show":"hide"]()})},s.prototype.hideEmptyEntries=function(){var t=this;this.$(".dropdown > .dropdown-menu").each(function(){var e=t.$(this),a=!1;e.children().each(function(){a=a||"none"!==this.style.display}),e.parent().toggle(a)})},s.prototype.toggleConnectionStatusEntries=function(t){var e=this;this.$("li[data-online]").each(function(){var a=e.$(this);if("undefined"!=typeof a.attr("data-disabled"))return a.addClass("disabled");switch(a.attr("data-online")){case"show":a[t?"show":"hide"]();break;case"hide":a[t?"hide":"show"]();break;default:a[t?"removeClass":"addClass"]("disabled")}})},s});