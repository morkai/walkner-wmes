// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","../View","app/core/templates/messages","app/core/templates/message"],function(i,e,t,s,o,n){"use strict";var a=0,r=s.extend({template:o,events:{"click .message":function(i){i.currentTarget.parentNode===this.el&&i.currentTarget.getAttribute("data-view")===this.idPrefix&&this.hide(e(i.currentTarget))}},localTopics:{"router.executing":function(){this.hide()}}});return r.prototype.initialize=function(){this.$loadingMessage=null,this.loadingTimer=null,this.loadingCounter=0,this.hideTimers=[],this.loading=this.loading.bind(this),this.loaded=this.loaded.bind(this)},r.prototype.destroy=function(){this.$loadingMessage=null,null!==this.loadingTimer&&(clearTimeout(this.loadingTimer),this.loadingTimer=null),this.hideTimers.length>0&&(this.hideTimers.forEach(clearTimeout),this.hideTimers=null),this.$('.message[data-view="'+this.idPrefix+'"]').remove()},r.prototype.show=function(i){var t=e(n({type:i.type||"info",text:i.text}));return this.$el.append(t.attr("data-view",this.idPrefix)),this.moveDown(t),t.attr("data-top",t.position().top).css("margin-left",-(t.width()/2)+"px"),i.immediate?t.css("opacity",1):t.animate({opacity:1}),this.scheduleHiding(t,i.time),t},r.prototype.hide=function(i,e){if(i){if(i.hasClass("message-hiding"))return;i.addClass("message-hiding")}else i=this.$('.message[data-view="'+this.idPrefix+'"]'),this.$loadingMessage=null;1===i.length&&(this.moveUp(i),this.removeHideTimer(i)),e?i.remove():i.animate({opacity:0},function(){i.remove()})},r.prototype.loading=function(){this.loadingCounter+=1,null===this.loadingTimer&&(this.loadingTimer=setTimeout(this.showLoadingMessage.bind(this),a))},r.prototype.loaded=function(){this.hideLoadingMessage()},r.prototype.loadingFailed=function(e){this.hideLoadingMessage(),this.show({type:"error",text:i.isString(e)?e:t("core","MSG:LOADING_FAILURE")})},r.prototype.showLoadingMessage=function(){this.loadingTimer=null,null===this.$loadingMessage&&(this.$loadingMessage=this.show({type:"warning",text:'<i class="fa fa-spinner fa-spin"></i><span>'+t("core","MSG:LOADING")+"</span>",immediate:!0}))},r.prototype.hideLoadingMessage=function(){this.loadingCounter>0&&--this.loadingCounter,0===this.loadingCounter&&(null!==this.loadingTimer&&(clearTimeout(this.loadingTimer),this.loadingTimer=null),null!==this.$loadingMessage&&(this.hide(this.$loadingMessage),this.$loadingMessage=null))},r.prototype.moveDown=function(i){this.moveTopBy(this.$('.message[data-view="'+this.idPrefix+'"]'),i,this.getMoveOffset(i))},r.prototype.moveUp=function(i){this.moveTopBy(i.prevAll(".message"),i,-this.getMoveOffset(i))},r.prototype.moveTopBy=function(i,t,s){i.each(function(){if(this!==t[0]){var i=e(this),o=parseInt(i.attr("data-top"),10)+s;i.attr("data-top",o),i.animate({top:o+"px"})}})},r.prototype.getMoveOffset=function(i){return i.outerHeight()+8},r.prototype.scheduleHiding=function(e,t){if(i.isNumber(t)){1e3>t&&(t=1e3);var s=setTimeout(this.hide.bind(this,e),t);e.data("hideTimer",s),this.hideTimers.push(s)}},r.prototype.removeHideTimer=function(e){var t=e.data("hideTimer");i.isUndefined(t)||(clearTimeout(t),e.data("hideTimer",void 0),this.hideTimers.splice(this.hideTimers.indexOf(t),1))},r});