define(["underscore","jquery","app/i18n","../View","app/core/templates/messages","app/core/templates/message","i18n!app/nls/core"],function(e,t,i,n,r,o){var s=0,a=n.extend({template:r,events:{"click .message":function(e){e.currentTarget.parentNode===this.el&&this.hide(t(e.currentTarget))}},localTopics:{"router.executing":function(){this.hide()}}});return a.prototype.initialize=function(){this.$loadingMessage=null,this.loadingTimer=null,this.loadingCounter=0,this.hideTimers=[],this.loading=this.loading.bind(this),this.loaded=this.loaded.bind(this)},a.prototype.destroy=function(){this.$loadingMessage=null,null!==this.loadingTimer&&(clearTimeout(this.loadingTimer),this.loadingTimer=null),this.hideTimers.length>0&&(this.hideTimers.forEach(clearTimeout),this.hideTimers=null),this.$(".message").remove()},a.prototype.show=function(e){var i=t(o({type:e.type||"info",text:e.text}));return this.$el.append(i),this.moveDown(i),i.attr("data-top",i.position().top).css("margin-left",-(i.width()/2)+"px"),e.immediate?i.css("opacity",1):i.animate({opacity:1}),this.scheduleHiding(i,e.time),i},a.prototype.hide=function(e,t){if(e){if(e.hasClass("message-hiding"))return;e.addClass("message-hiding")}else e=this.$(".message"),this.$loadingMessage=null;1===e.length&&(this.moveUp(e),this.removeHideTimer(e)),t?e.remove():e.animate({opacity:0},function(){e.remove()})},a.prototype.loading=function(){this.loadingCounter+=1,null===this.loadingTimer&&(this.loadingTimer=setTimeout(this.showLoadingMessage.bind(this),s))},a.prototype.loaded=function(){this.hideLoadingMessage()},a.prototype.loadingFailed=function(t){this.hideLoadingMessage(),this.show({type:"error",text:e.isString(t)?t:i("core","MSG:LOADING_FAILURE")})},a.prototype.showLoadingMessage=function(){this.loadingTimer=null,null===this.$loadingMessage&&(this.$loadingMessage=this.show({type:"warning",text:'<i class="fa fa-spinner fa-spin"></i><span>'+i("core","MSG:LOADING")+"</span>",immediate:!0}))},a.prototype.hideLoadingMessage=function(){this.loadingCounter>0&&--this.loadingCounter,0===this.loadingCounter&&(null!==this.loadingTimer&&(clearTimeout(this.loadingTimer),this.loadingTimer=null),null!==this.$loadingMessage&&(this.hide(this.$loadingMessage),this.$loadingMessage=null))},a.prototype.moveDown=function(e){this.moveTopBy(this.$(".message"),e,this.getMoveOffset(e))},a.prototype.moveUp=function(e){this.moveTopBy(e.prevAll(".message"),e,-this.getMoveOffset(e))},a.prototype.moveTopBy=function(e,i,n){e.each(function(){if(this!==i[0]){var e=t(this),r=parseInt(e.attr("data-top"),10)+n;e.attr("data-top",r),e.animate({top:r+"px"})}})},a.prototype.getMoveOffset=function(e){return e.outerHeight()+8},a.prototype.scheduleHiding=function(t,i){if(e.isNumber(i)){1e3>i&&(i=1e3);var n=setTimeout(this.hide.bind(this,t),i);t.data("hideTimer",n),this.hideTimers.push(n)}},a.prototype.removeHideTimer=function(t){var i=t.data("hideTimer");e.isUndefined(i)||(clearTimeout(i),t.data("hideTimer",void 0),this.hideTimers.splice(this.hideTimers.indexOf(i),1))},a});