// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","../View","app/core/templates/messages","app/core/templates/message"],function(e,i,t,s,o,n){var a=0,h=s.extend({template:o,events:{"click .message":function(e){e.currentTarget.parentNode===this.el&&this.hide(i(e.currentTarget))}},localTopics:{"router.executing":function(){this.hide()}}});return h.prototype.initialize=function(){this.$loadingMessage=null,this.loadingTimer=null,this.loadingCounter=0,this.hideTimers=[],this.loading=this.loading.bind(this),this.loaded=this.loaded.bind(this)},h.prototype.destroy=function(){this.$loadingMessage=null,null!==this.loadingTimer&&(clearTimeout(this.loadingTimer),this.loadingTimer=null),this.hideTimers.length>0&&(this.hideTimers.forEach(clearTimeout),this.hideTimers=null),this.$(".message").remove()},h.prototype.show=function(e){var t=i(n({type:e.type||"info",text:e.text}));return this.$el.append(t),this.moveDown(t),t.attr("data-top",t.position().top).css("margin-left",-(t.width()/2)+"px"),e.immediate?t.css("opacity",1):t.animate({opacity:1}),this.scheduleHiding(t,e.time),t},h.prototype.hide=function(e,i){if(e){if(e.hasClass("message-hiding"))return;e.addClass("message-hiding")}else e=this.$(".message"),this.$loadingMessage=null;1===e.length&&(this.moveUp(e),this.removeHideTimer(e)),i?e.remove():e.animate({opacity:0},function(){e.remove()})},h.prototype.loading=function(){this.loadingCounter+=1,null===this.loadingTimer&&(this.loadingTimer=setTimeout(this.showLoadingMessage.bind(this),a))},h.prototype.loaded=function(){this.hideLoadingMessage()},h.prototype.loadingFailed=function(i){this.hideLoadingMessage(),this.show({type:"error",text:e.isString(i)?i:t("core","MSG:LOADING_FAILURE")})},h.prototype.showLoadingMessage=function(){this.loadingTimer=null,null===this.$loadingMessage&&(this.$loadingMessage=this.show({type:"warning",text:'<i class="fa fa-spinner fa-spin"></i><span>'+t("core","MSG:LOADING")+"</span>",immediate:!0}))},h.prototype.hideLoadingMessage=function(){this.loadingCounter>0&&--this.loadingCounter,0===this.loadingCounter&&(null!==this.loadingTimer&&(clearTimeout(this.loadingTimer),this.loadingTimer=null),null!==this.$loadingMessage&&(this.hide(this.$loadingMessage),this.$loadingMessage=null))},h.prototype.moveDown=function(e){this.moveTopBy(this.$(".message"),e,this.getMoveOffset(e))},h.prototype.moveUp=function(e){this.moveTopBy(e.prevAll(".message"),e,-this.getMoveOffset(e))},h.prototype.moveTopBy=function(e,t,s){e.each(function(){if(this!==t[0]){var e=i(this),o=parseInt(e.attr("data-top"),10)+s;e.attr("data-top",o),e.animate({top:o+"px"})}})},h.prototype.getMoveOffset=function(e){return e.outerHeight()+8},h.prototype.scheduleHiding=function(i,t){if(e.isNumber(t)){1e3>t&&(t=1e3);var s=setTimeout(this.hide.bind(this,i),t);i.data("hideTimer",s),this.hideTimers.push(s)}},h.prototype.removeHideTimer=function(i){var t=i.data("hideTimer");e.isUndefined(t)||(clearTimeout(t),i.data("hideTimer",void 0),this.hideTimers.splice(this.hideTimers.indexOf(t),1))},h});