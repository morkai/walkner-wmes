// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/user","../View","app/core/templates/pageLayout"],function(e,t,i,s,r){"use strict";var n=s.extend({pageContainerSelector:".bd",template:r});return n.prototype.initialize=function(){this.model={id:null,actions:[],breadcrumbs:[],title:null},this.$header=null,this.$breadcrumbs=null,this.$actions=null,this.onWindowResize=e.debounce(this.onWindowResize.bind(this),1e3/15),t(window).on("resize",this.onWindowResize)},n.prototype.destroy=function(){t(window).off("resize",this.onWindowResize),this.el.ownerDocument&&this.el.ownerDocument.body.classList.remove("page"),this.$breadcrumbs=null,this.$actions=null},n.prototype.serialize=function(){return e.extend(s.prototype.serialize.call(this),{version:this.options.version})},n.prototype.afterRender=function(){this.el.ownerDocument&&this.el.ownerDocument.body.classList.add("page"),this.$header=this.$(".page-header").first(),this.$breadcrumbs=this.$(".page-breadcrumbs").first(),this.$actions=this.$(".page-actions").first(),this.changeTitle(),this.renderBreadcrumbs(),this.renderActions(),null!==this.model.id&&this.setId(this.model.id)},n.prototype.reset=function(){this.setId(null),this.model.title=null,this.$header&&this.$header.hide(),this.$breadcrumbs&&(this.model.breadcrumbs=[],this.$breadcrumbs.empty()),this.$actions&&(this.model.actions=[],this.$actions.empty()),this.removeView(this.pageContainerSelector)},n.prototype.setUpPage=function(e){e.pageId&&this.setId(e.pageId),e.breadcrumbs?this.setBreadcrumbs(e.breadcrumbs,e):e.title?this.setTitle(e.title,e):this.changeTitle(),e.actions&&this.setActions(e.actions,e)},n.prototype.setId=function(e){return this.isRendered()&&this.$el.attr("data-id",e),this.model.id=e,this},n.prototype.setBreadcrumbs=function(e,t){return null==e?this:("function"==typeof e&&(e=e.call(t,this)),Array.isArray(e)||(e=[e]),this.model.breadcrumbs=e.map(function(e){var t=typeof e;return("string"===t||"function"===t)&&(e={label:e,href:null}),"string"==typeof e.href&&"#"!==e.href[0]&&(e.href="#"+e.href),e}),this.$breadcrumbs&&this.renderBreadcrumbs(),this.changeTitle(),this)},n.prototype.setTitle=function(e,t){return null==e?this:("function"==typeof e&&(e=e.call(t,this)),Array.isArray(e)||(e=[e]),this.model.title=e,this.changeTitle(),this)},n.prototype.setActions=function(e,t){return null==e?this:("function"==typeof e&&(e=e.call(t,this)),e?(Array.isArray(e)||(e=[e]),this.model.actions=e.map(this.prepareAction.bind(this)),this.$actions&&this.renderActions(),this):this)},n.prototype.onWindowResize=function(){this.adjustBreadcrumbsPosition()},n.prototype.prepareAction=function(e){if(e.prepared)return e;if("string"==typeof e.href){var t=e.href.charAt(0);"#"!==t&&"/"!==t&&(e.href="#"+e.href)}else e.href=null;return"string"==typeof e.icon&&(e.icon="fa-"+e.icon.split(" ").join(" fa-")),"string"!=typeof e.className&&(e.className=""),e.className="btn btn-"+(e.type||"default")+" "+e.className,e.prepared=!0,e},n.prototype.renderBreadcrumbs=function(){for(var e=this.model.breadcrumbs,t="",i=0,s=e.length;s>i;++i){var r=e[i];t+="<li>",t+=i!==s-1&&r.href?'<a href="'+r.href+'">'+r.label+"</a>":r.label}this.$breadcrumbs.html(t),this.$header.show(),this.adjustBreadcrumbsPosition()},n.prototype.adjustBreadcrumbsPosition=function(){if(window.innerWidth<768){var e=(this.$(".navbar-header").outerHeight()-this.$breadcrumbs.outerHeight())/2;this.$breadcrumbs.css("top",e+"px")}},n.prototype.renderActions=function(){for(var t=this.model.actions,s={},r={},n="",o=0,a=t.length;a>o;++o){var h=t[o];if(h.privileges)if(e.isFunction(h.privileges)){if(!h.privileges())continue}else if(!i.isAllowedTo(h.privileges))continue;"function"==typeof h.callback&&(s[o]=h.callback.bind(this)),"function"==typeof h.afterRender&&(r[o]=h.afterRender.bind(this)),n+='<li data-index="'+o+'">',"function"==typeof h.template?n+=h.template(h):(n+=null===h.href?'<button class="'+h.className+'">':'<a class="'+h.className+'" href="'+h.href+'">',"string"==typeof h.icon&&(n+='<i class="fa '+h.icon+'"></i>'),n+="<span>"+h.label+"</span>"+(h.href?"</a>":"</button>"))}this.$actions.html(n);var l=this.$actions.find("li");Object.keys(s).forEach(function(e){l.filter('li[data-index="'+e+'"]').click(t[e].callback)}),Object.keys(r).forEach(function(e){r[e](l.filter('li[data-index="'+e+'"]'),t[e])}),this.$header.show()},n.prototype.changeTitle=function(){if(this.isRendered()){var t=Array.isArray(this.model.title)?[].concat(this.model.title):e.pluck(this.model.breadcrumbs,"label");this.broker.publish("page.titleChanged",t)}},n});