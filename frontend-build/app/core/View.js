// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","backbone.layout","app/broker","app/socket","app/pubsub","app/i18n","./util"],function(t,e,i,o,s,r,n,c){"use strict";function p(e){var n=this;n.idPrefix=t.uniqueId("v"),n.options=e||{},n.timers={},n.promises=[],t.forEach(n.sections,function(t,e){n.sections[e]="string"!=typeof t||"#"===t?"#"+n.idPrefix+"-"+e:t.replace("#-","#"+n.idPrefix+"-")}),c.defineSandboxedProperty(n,"broker",o),c.defineSandboxedProperty(n,"pubsub",r),c.defineSandboxedProperty(n,"socket",s),i.call(n,e),c.subscribeTopics(n,"broker",n.localTopics,!0),c.subscribeTopics(n,"pubsub",n.remoteTopics,!0)}return c.inherits(p,i),p.prototype.delegateEvents=function(e){if(e||(e=t.result(this,"events")),!e)return this;this.undelegateEvents(),Object.keys(e).forEach(function(i){var o=e[i];if(t.isFunction(o)||(o=this[o]),t.isFunction(o)){var s=i.match(/^(\S+)\s*(.*)$/),r=s[1]+".delegateEvents"+this.cid,n=s[2];""===n?this.$el.on(r,o.bind(this)):(t.isString(this.idPrefix)&&(n=n.replace(/#-/g,"#"+this.idPrefix+"-")),this.$el.on(r,n,o.bind(this)))}},this)},p.prototype.getViews=function(t){return"string"==typeof t&&/^#-/.test(t)&&(t=t.replace("#-","#"+this.idPrefix+"-")),i.prototype.getViews.call(this,t)},p.prototype.setView=function(t,e,o,s){return"string"==typeof t&&/^#-/.test(t)&&(t=t.replace("#-","#"+this.idPrefix+"-")),i.prototype.setView.call(this,t,e,o,s)},p.prototype.cleanup=function(){this.trigger("cleanup",this),this.destroy(),this.cleanupSelect2(),c.cleanupSandboxedProperties(this),t.isObject(this.timers)&&(t.each(this.timers,clearTimeout),this.timers=null),this.cancelRequests()},p.prototype.destroy=function(){},p.prototype.cleanupSelect2=function(){var t=this;this.$(".select2-container").each(function(){t.$("#"+this.id.replace("s2id_","")).select2("destroy")})},p.prototype.beforeRender=function(){},p.prototype.serialize=function(){return{idPrefix:this.idPrefix}},p.prototype.afterRender=function(){},p.prototype.isRendered=function(){return!0===this.hasRendered},p.prototype.isDetached=function(){return!e.contains(document.documentElement,this.el)},p.prototype.ajax=function(t){return this.promised(e.ajax(t))},p.prototype.promised=function(e){if(!e||!t.isFunction(e.abort))return e;this.promises.push(e);var i=this;return e.always(function(){Array.isArray(i.promises)&&i.promises.splice(i.promises.indexOf(e),1)}),e},p.prototype.cancelRequests=function(){this.promises.forEach(function(t){t.abort()}),this.promises=[]},p.prototype.cancelAnimations=function(t,e){this.$el.stop(!1!==t,!1!==e),this.$(":animated").stop(!1!==t,!1!==e)},p.prototype.$id=function(i){var o="#";return t.isString(this.idPrefix)&&(o+=this.idPrefix+"-"),e(o+i)},p.prototype.t=function(t,e,i){if("string"==typeof e||i)return n(t,e,i);var o=this.model&&this.model.nlsDomain?this.model.nlsDomain:this.collection&&this.collection.nlsDomain?this.collection.nlsDomain:"core";return"object"==typeof e?n(o,t,e):n(o,t)},p});