// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","backbone.layout","app/broker","app/socket","app/pubsub","./util"],function(e,t,i,s,r,o,n){"use strict";function c(t){var c=this;c.idPrefix=e.uniqueId("v"),c.options=t||{},c.timers={},c.promises=[],e.forEach(c.sections,function(e,t){"string"!=typeof e||"#"===e?c.sections[t]="#"+c.idPrefix+"-"+t:c.sections[t]=e.replace("#-","#"+c.idPrefix+"-")}),n.defineSandboxedProperty(c,"broker",s),n.defineSandboxedProperty(c,"pubsub",o),n.defineSandboxedProperty(c,"socket",r),i.call(c,t),n.subscribeTopics(c,"broker",c.localTopics,!0),n.subscribeTopics(c,"pubsub",c.remoteTopics,!0)}return n.inherits(c,i),c.prototype.delegateEvents=function(t){return t||(t=e.result(this,"events")),t?(this.undelegateEvents(),void Object.keys(t).forEach(function(i){var s=t[i];if(e.isFunction(s)||(s=this[s]),e.isFunction(s)){var r=i.match(/^(\S+)\s*(.*)$/),o=r[1]+".delegateEvents"+this.cid,n=r[2];""===n?this.$el.on(o,s.bind(this)):(e.isString(this.idPrefix)&&(n=n.replace(/#-/g,"#"+this.idPrefix+"-")),this.$el.on(o,n,s.bind(this)))}},this)):this},c.prototype.getViews=function(e){return"string"==typeof e&&/^#-/.test(e)&&(e=e.replace("#-","#"+this.idPrefix+"-")),i.prototype.getViews.call(this,e)},c.prototype.setView=function(e,t,s,r){return"string"==typeof e&&/^#-/.test(e)&&(e=e.replace("#-","#"+this.idPrefix+"-")),i.prototype.setView.call(this,e,t,s,r)},c.prototype.cleanup=function(){this.trigger("cleanup",this),this.destroy(),this.cleanupSelect2(),n.cleanupSandboxedProperties(this),e.isObject(this.timers)&&(e.each(this.timers,clearTimeout),this.timers=null),this.cancelRequests()},c.prototype.destroy=function(){},c.prototype.cleanupSelect2=function(){var e=this;this.$(".select2-container").each(function(){e.$("#"+this.id.replace("s2id_","")).select2("destroy")})},c.prototype.beforeRender=function(){},c.prototype.serialize=function(){return{idPrefix:this.idPrefix}},c.prototype.afterRender=function(){},c.prototype.isRendered=function(){return this.hasRendered===!0},c.prototype.isDetached=function(){return!t.contains(document.documentElement,this.el)},c.prototype.ajax=function(e){return this.promised(t.ajax(e))},c.prototype.promised=function(t){if(!t||!e.isFunction(t.abort))return t;this.promises.push(t);var i=this;return t.always(function(){Array.isArray(i.promises)&&i.promises.splice(i.promises.indexOf(t),1)}),t},c.prototype.cancelRequests=function(){this.promises.forEach(function(e){e.abort()}),this.promises=[]},c.prototype.cancelAnimations=function(e,t){this.$(":animated").stop(e!==!1,t!==!1)},c.prototype.$id=function(i){var s="#";return e.isString(this.idPrefix)&&(s+=this.idPrefix+"-"),t(s+i)},c});