define(["underscore","jquery","backbone.layout","app/broker","app/socket","app/pubsub","app/i18n","./util"],function(e,t,i,r,o,s,n,p){"use strict";function a(t){var a=this;a.idPrefix=e.uniqueId("v"),a.options=t||{},a.timers={},a.promises=[],e.forEach(a.sections,function(e,t){a.sections[t]="string"!=typeof e||"#"===e?"#"+a.idPrefix+"-"+t:e.replace("#-","#"+a.idPrefix+"-")}),p.defineSandboxedProperty(a,"broker",r),p.defineSandboxedProperty(a,"pubsub",s),p.defineSandboxedProperty(a,"socket",o),Object.defineProperty(a,"t",{enumerable:!0,configurable:!0,get:function(){return delete a.t,a.t=n.forDomain(a.getDefaultNlsDomain()),a.t}}),i.call(a,t),p.subscribeTopics(a,"broker",a.localTopics,!0),a.remoteTopicsAfterSync?(!0===a.remoteTopicsAfterSync&&(a.remoteTopicsAfterSync="model"),"string"==typeof a.remoteTopicsAfterSync&&a[a.remoteTopicsAfterSync]&&a.listenToOnce(a[a.remoteTopicsAfterSync],"sync",p.subscribeTopics.bind(p,a,"pubsub",a.remoteTopics,!0))):p.subscribeTopics(a,"pubsub",a.remoteTopics,!0)}return p.inherits(a,i),a.prototype.delegateEvents=function(t){if(t||(t=e.result(this,"events")),!t)return this;this.undelegateEvents(),Object.keys(t).forEach(function(i){var r=t[i];if(e.isFunction(r)||(r=this[r]),e.isFunction(r)){var o=i.match(/^(\S+)\s*(.*)$/),s=o[1]+".delegateEvents"+this.cid,n=o[2];""===n?this.$el.on(s,r.bind(this)):(e.isString(this.idPrefix)&&(n=n.replace(/#-/g,"#"+this.idPrefix+"-")),this.$el.on(s,n,r.bind(this)))}},this)},a.prototype.getViews=function(e){return"string"==typeof e&&/^#-/.test(e)&&(e=e.replace("#-","#"+this.idPrefix+"-")),i.prototype.getViews.call(this,e)},a.prototype.setView=function(e,t,r,o){return"string"==typeof e&&/^#-/.test(e)&&(e=e.replace("#-","#"+this.idPrefix+"-")),i.prototype.setView.call(this,e,t,r,o)},a.prototype.cleanup=function(){this.destroy(),this.cleanupSelect2(),p.cleanupSandboxedProperties(this),e.isObject(this.timers)&&(e.forEach(this.timers,clearTimeout),this.timers={}),this.cancelRequests()},a.prototype.destroy=function(){},a.prototype.cleanupSelect2=function(){var e=this;this.$(".select2-container").each(function(){e.$("#"+this.id.replace("s2id_","")).select2("destroy")})},a.prototype.beforeRender=function(){},a.prototype.serialize=function(){return e.assign(this.getCommonTemplateData(),this.getTemplateData())},a.prototype.getCommonTemplateData=function(){var e=this.getTemplateHelpers();return{idPrefix:this.idPrefix,helpers:e,t:e.t}},a.prototype.getTemplateData=function(){return{}},a.prototype.getTemplateHelpers=function(){return{t:this.t,props:this.props.bind(this)}},a.prototype.renderPartial=function(e,i){return t(this.renderPartialHtml(e,i))},a.prototype.renderPartialHtml=function(t,i){return t(e.assign(this.getCommonTemplateData(),i))},a.prototype.afterRender=function(){},a.prototype.isRendered=function(){return!0===this.hasRendered},a.prototype.isDetached=function(){return!t.contains(document.documentElement,this.el)},a.prototype.ajax=function(e){return this.promised(t.ajax(e))},a.prototype.promised=function(t){if(!t||!e.isFunction(t.abort))return t;this.promises.push(t);var i=this;return t.always(function(){Array.isArray(i.promises)&&i.promises.splice(i.promises.indexOf(t),1)}),t},a.prototype.cancelRequests=function(){this.promises.forEach(function(e){e.abort()}),this.promises=[]},a.prototype.cancelAnimations=function(e,t){this.$el.stop(!1!==e,!1!==t),this.$(":animated").stop(!1!==e,!1!==t)},a.prototype.$id=function(i){var r="#";return e.isString(this.idPrefix)&&(r+=this.idPrefix+"-"),t(r+i)},a.prototype.getDefaultModel=function(){return this[this.modelProperty]||this.model||this.collection},a.prototype.getDefaultNlsDomain=function(){if(this.nlsDomain)return this.nlsDomain;var e=this.getDefaultModel();if(e){if(e.getNlsDomain)return e.getNlsDomain();if(e.nlsDomain)return e.nlsDomain}return"core"},a.prototype.props=function(t,i){var r=this;i||(t=(i=t).data);var o='<div class="props '+(i.first?"first":"")+'">',s=r.getDefaultNlsDomain();return[].concat(e.isArray(i)?i:i.props).forEach(function(p){"string"==typeof p&&(p={id:p});var a=!1!==p.escape&&"!"!==p.id.charAt(0),c=a?p.id:p.id.substring(1),u=p.className||"",l=p.valueClassName||"",f=p.nlsDomain||i.nlsDomain||s,d=p.label||n(f,"PROPERTY:"+c),h=e.isFunction(p.value)?p.value(t[c],p,r):e.isUndefined(p.value)?t[c]:p.value;e.isFunction(p.visible)&&!p.visible(h,p,r)||(null==p.visible||p.visible)&&(a&&(h=e.escape(h)),o+='<div class="prop '+u+'" data-prop="'+c+'"><div class="prop-name">'+d+'</div><div class="prop-value '+l+'">'+h+"</div></div>")}),o+"</div>"},a});