// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","backbone.layout","app/broker","app/socket","app/pubsub","./util"],function(t,i,e,s,r,n,o){function c(i){this.idPrefix=t.uniqueId("v"),this.options=i||{},this.timers={},this.promises=[],o.defineSandboxedProperty(this,"broker",s),o.defineSandboxedProperty(this,"pubsub",n),o.defineSandboxedProperty(this,"socket",r),e.call(this,i),o.subscribeTopics(this,"broker",this.localTopics,!0),o.subscribeTopics(this,"pubsub",this.remoteTopics,!0)}return o.inherits(c,e),c.prototype.delegateEvents=function(i){return i||(i=t.result(this,"events")),i?(this.undelegateEvents(),void Object.keys(i).forEach(function(e){var s=i[e];if(t.isFunction(s)||(s=this[s]),t.isFunction(s)){var r=e.match(/^(\S+)\s*(.*)$/),n=r[1]+".delegateEvents"+this.cid,o=r[2];""===o?this.$el.on(n,s.bind(this)):(t.isString(this.idPrefix)&&(o=o.replace(/#-/g,"#"+this.idPrefix+"-")),this.$el.on(n,o,s.bind(this)))}},this)):this},c.prototype.cleanup=function(){t.isFunction(this.destroy)&&this.destroy(),o.cleanupSandboxedProperties(this),t.isObject(this.timers)&&(t.each(this.timers,clearTimeout),this.timers=null),this.cancelRequests()},c.prototype.serialize=function(){return{idPrefix:this.idPrefix}},c.prototype.isRendered=function(){return this.hasRendered===!0},c.prototype.isDetached=function(){return!i.contains(document.documentElement,this.el)},c.prototype.ajax=function(t){return this.promised(i.ajax(t))},c.prototype.promised=function(i){if(!i||!t.isFunction(i.abort))return i;this.promises.push(i);var e=this;return i.always(function(){Array.isArray(e.promises)&&e.promises.splice(e.promises.indexOf(i),1)}),i},c.prototype.cancelRequests=function(){this.promises.forEach(function(t){t.abort()}),this.promises=[]},c.prototype.cancelAnimations=function(t,i){this.$(":animated").stop(t!==!1,i!==!1)},c.prototype.$id=function(i){var e="#";return t.isString(this.idPrefix)&&(e+=this.idPrefix+"-"),this.$(e+i)},c});