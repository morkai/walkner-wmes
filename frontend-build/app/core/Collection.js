// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","backbone","h5.rql/index","./util","./PaginationData"],function(t,i,e,r,n){"use strict";function o(e,r){t.isObject(r)||(r={}),this.rqlQuery=this.createRqlQuery(r.rqlQuery||this.rqlQuery),this.paginationData=!1!==r.paginate&&!1!==this.paginate?new n:null,this.url||(this.url=this.model.prototype.urlRoot),i.Collection.call(this,e,r),this.paginationData&&this.listenTo(this.paginationData,"change:page",this.onPageChanged)}return r.inherits(o,i.Collection),o.prototype.parse=function(t){return this.paginationData&&this.paginationData.set(this.getPaginationData(t)),Array.isArray(t.collection)?t.collection:[]},o.prototype.sync=function(t,e,r){return"read"!==t||r.data||(r.data=this.rqlQuery.toString()),i.Collection.prototype.sync.call(this,t,e,r)},o.prototype.genClientUrl=function(t){if(null===this.model.prototype.clientUrlRoot)throw new Error("Model's `clientUrlRoot` was not specified");var i=this.model.prototype.clientUrlRoot;return"string"==typeof t&&(i+=";"+t),i},o.prototype.getTopicPrefix=function(){return this.topicPrefix||this.model.prototype.topicPrefix},o.prototype.getPrivilegePrefix=function(){return this.privilegePrefix||this.model.prototype.privilegePrefix},o.prototype.getNlsDomain=function(){return this.nlsDomain||this.model.prototype.nlsDomain},o.prototype.getLabel=function(t){var i=this.get(t);return i?i.getLabel():null},o.prototype.createRqlQuery=function(i){return t.isString(i)?i=e.parse(i):t.isFunction(i)?i=i.call(this,e):t.isObject(i)&&(i=e.Query.fromObject(i)),i&&!i.isEmpty()?i:t.isString(this.rqlQuery)?e.parse(this.rqlQuery):t.isFunction(this.rqlQuery)?this.rqlQuery.call(this,e):t.isObject(this.rqlQuery)?e.Query.fromObject(this.rqlQuery):new e.Query},o.prototype.getPaginationData=function(t){return{totalCount:t.totalCount,urlTemplate:this.genPaginationUrlTemplate(),skip:this.rqlQuery.skip,limit:this.rqlQuery.limit}},o.prototype.genPaginationUrlTemplate=function(){var t=this.rqlQuery,i=t.skip,e=t.limit;t.skip="${skip}",t.limit="${limit}";var r=this.genClientUrl()+"?"+t.toString();return t.skip=i,t.limit=e,r},o.prototype.onPageChanged=function(t,i){this.rqlQuery.skip=(i-1)*this.rqlQuery.limit,this.fetch({reset:!0})},o});