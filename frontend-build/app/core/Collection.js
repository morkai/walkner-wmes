define(["underscore","backbone","h5.rql/index","./util","./PaginationData","./Model"],function(t,i,e,r,o,n){"use strict";function l(e,r){t.isObject(r)||(r={}),this.rqlQuery=this.createRqlQuery(r.rqlQuery||this.rqlQuery),-1337===this.rqlQuery.limit&&(this.rqlQuery.limit=this.getDefaultPageLimit()),this.paginationData=!1!==r.paginate&&!1!==this.paginate?new o:null,this.url||(this.url=this.model.prototype.urlRoot),i.Collection.call(this,e,r),this.paginationData&&this.listenTo(this.paginationData,"change:page",this.onPageChanged)}return r.inherits(l,i.Collection),l.prototype.model=n,l.prototype.parse=function(t){return t||(t={totalCount:0,collection:[]}),this.paginationData&&this.paginationData.set(this.getPaginationData(t)),Array.isArray(t.collection)?t.collection:[]},l.prototype.sync=function(t,e,r){return"read"!==t||r.data||(r.data=this.rqlQuery.toString()),i.Collection.prototype.sync.call(this,t,e,r)},l.prototype.genClientUrl=function(t){if(null===this.model.prototype.clientUrlRoot)throw new Error("Model's `clientUrlRoot` was not specified");var i=this.model.prototype.clientUrlRoot;return"string"==typeof t&&(i+=";"+t),i},l.prototype.getTopicPrefix=function(){return this.topicPrefix||this.model.prototype.topicPrefix},l.prototype.getPrivilegePrefix=function(){return this.privilegePrefix||this.model.prototype.privilegePrefix},l.prototype.getNlsDomain=function(){return this.nlsDomain||this.model.prototype.nlsDomain},l.prototype.getLabel=function(t,i){var e=this.get(t);return e?e.getLabel(i):t},l.prototype.getLabels=function(t,i){return t.map(function(t){return this.getLabel(t,i)},this)},l.prototype.createRqlQuery=function(i){return t.isString(i)?i=e.parse(i):t.isFunction(i)?i=i.call(this,e):t.isObject(i)&&(i=e.Query.fromObject(i)),i&&!i.isEmpty()?i:t.isString(this.rqlQuery)?e.parse(this.rqlQuery):t.isFunction(this.rqlQuery)?this.rqlQuery.call(this,e):t.isObject(this.rqlQuery)?e.Query.fromObject(this.rqlQuery):new e.Query},l.prototype.getPaginationData=function(t){return{totalCount:t.totalCount||0,urlTemplate:this.genPaginationUrlTemplate(),skip:this.rqlQuery.skip,limit:this.rqlQuery.limit}},l.prototype.genPaginationUrlTemplate=function(){var t=this.rqlQuery,i=t.skip,e=t.limit;t.skip="${skip}",t.limit="${limit}";var r=this.genClientUrl()+"?"+t.toString();return t.skip=i,t.limit=e,r},l.prototype.onPageChanged=function(t,i){this.rqlQuery.skip=(i-1)*this.rqlQuery.limit,this.fetch({reset:!0})},l.prototype.getDefaultPageLimit=function(){var t=32,i=34;t=this.theadHeight>8?this.theadHeight:32+20*((this.theadHeight||1)-1),"number"==typeof this.rowHeight?i=this.rowHeight>8?this.rowHeight:31+20*(this.rowHeight-1):!1===this.rowHeight&&(i=31);var e=window.innerHeight-99-106-54-t;return Math.max(10,Math.floor(e/i))},l.prototype.findRqlTerm=function(i,e){return t.find(this.rqlQuery.selector.args,function(t){return t.args[0]===i&&(Array.isArray(e)?-1!==e.indexOf(t.name):!e||t.name===e)})},l});