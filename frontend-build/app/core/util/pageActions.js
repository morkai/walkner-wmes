// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction"],function(e,n,t,r,a){"use strict";function i(e,n,t){return n===!1?null:n||e.getPrivilegePrefix()+":"+(t||"MANAGE")}function l(e){return e.paginationData?e.paginationData.get("totalCount"):e.length}function o(r,a,i){var l=i[0].rid;if(l.readOnly)return!1;var o=parseInt(l.value,10);if(isNaN(o)||0>=o)return l.value="",!1;l.readOnly=!0,l.value=o;var s=i.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),u=r.ajax({url:e.result(a,"url")+";rid",data:{rid:o}});return u.done(function(e){r.broker.publish("router.navigate",{url:a.genClientUrl()+"/"+e,trigger:!0})}),u.fail(function(){t.msg.show({type:"error",time:2e3,text:n(a.getNlsDomain(),"MSG:jump:404",{rid:o})}),s.removeClass("fa-spinner fa-spin").addClass("fa-search"),l.readOnly=!1,l.select()}),!1}return{add:function(e,t){return{label:n.bound(e.getNlsDomain(),"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:i(e,t)}},edit:function(e,t){return{label:n.bound(e.getNlsDomain(),"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:i(e,t)}},"delete":function(e,t){return{label:n.bound(e.getNlsDomain(),"PAGE_ACTION:delete"),icon:"times",href:e.genClientUrl("delete"),privileges:i(e,t),callback:function(n){0===n.button&&(n.preventDefault(),r.showDeleteDialog({model:e}))}}},"export":function(t,r,a,o){return r.listenTo(a,"sync",function(){var n=l(a),r=t.$(".page-actions .export").attr("href",e.result(a,"url")+";export?"+a.rqlQuery).toggleClass("disabled",!n).removeClass("btn-default btn-warning");n>=1e4?r.removeClass("btn-default").addClass("btn-warning"):r.removeClass("btn-warning").addClass("btn-default")}),{label:n.bound(a.getNlsDomain(),"PAGE_ACTION:export"),icon:"download",type:l(a)>=1e4?"warning":"default",href:e.result(a,"url")+";export?"+a.rqlQuery,privileges:i(a,o,"VIEW"),className:"export"+(a.length?"":" disabled")}},jump:function(e,n){return{template:function(){return a({nlsDomain:n.getNlsDomain()})},afterRender:function(t){var r=t.find("form");r.submit(o.bind(null,e,n,r))}}}}});