// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction","app/core/templates/exportAction"],function(e,t,n,r,l,i){"use strict";function a(e,t,n){return t===!1?null:t||e.getPrivilegePrefix()+":"+(n||"MANAGE")}function o(e){return e.paginationData?e.paginationData.get("totalCount"):e.length}function u(r,l,i){var a=i[0].rid;if(a.readOnly)return!1;var o=parseInt(a.value,10);if(isNaN(o)||o<=0)return a.value="",!1;a.readOnly=!0,a.value=o;var u=i.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),c=r.ajax({url:e.result(l,"url")+";rid",data:{rid:o}});return c.done(function(e){r.broker.publish("router.navigate",{url:l.genClientUrl()+"/"+e,trigger:!0})}),c.fail(function(){n.msg.show({type:"error",time:2e3,text:t(l.getNlsDomain(),"MSG:jump:404",{rid:o})}),u.removeClass("fa-spinner fa-spin").addClass("fa-search"),a.readOnly=!1,a.select()}),!1}return{add:function(e,n){return{label:t.bound(e.getNlsDomain(),"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:a(e,n)}},edit:function(e,n){return{label:t.bound(e.getNlsDomain(),"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:a(e,n)}},delete:function(n,l,i){return i||(i={}),{label:t.bound(n.getNlsDomain(),"PAGE_ACTION:delete"),icon:"times",href:n.genClientUrl("delete"),privileges:a(n,l),callback:function(t){t&&0!==t.button||(t&&t.preventDefault(),r.showDeleteDialog(e.defaults({model:n},i)))}}},export:function(n,r,l,u){var c={layout:n,page:r,collection:l,privilege:u};1===arguments.length&&(c=n);var s=function(){var n=o(c.collection),r=e.result(c.collection,"url")+";export.${format}?"+c.collection.rqlQuery,l=[{type:"csv",href:r.replace("${format}","csv")}];return window.XLSX_EXPORT&&l.push({type:"xlsx",href:r.replace("${format}","xlsx")}),i({type:n>=3e4?"danger":n>=15e3?"warning":"default",formats:l,disabled:0===c.collection.length,label:c.label||t(c.collection.getNlsDomain(),"PAGE_ACTION:export")})};return c.page.listenTo(c.collection,"sync",function(){c.layout.$(".page-actions-export").replaceWith(s())}),{template:s,privileges:a(c.collection,c.privilege,"VIEW"),callback:c.callback}},jump:function(e,t){return{template:function(){return l({nlsDomain:t.getNlsDomain()})},afterRender:function(n){var r=n.find("form");r.submit(u.bind(null,e,t,r))}}}}});