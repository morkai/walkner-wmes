define(["underscore","jquery","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction","app/core/templates/exportAction"],function(e,t,r,n,a,o,i){"use strict";function l(e,t,r,n){if(!1===r)return null;var a=t.model||t.constructor,o=a.can&&(a.can[e]||a.can.manage);return o?o.bind(a,t,e):r||t.getPrivilegePrefix()+":"+(n||"MANAGE")}function u(e){var a=n.msg.show({type:"warning",text:r("core","MSG:EXPORTING"),sticky:!0}),o=t.ajax({url:e});return o.fail(function(){n.msg.show({type:"error",time:2500,text:r("core","MSG:EXPORTING_FAILURE")})}),o.done(function(e){window.open("/express/exports/"+e)}),o.always(function(){n.msg.hide(a)}),!1}function c(e,t,n){var a=e.getNlsDomain();return r.bound(r.has(a,t)?a:"core",t,n)}return{add:function(e,t){return{label:c(e,"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:l("add",e,t)}},edit:function(e,t){return{label:c(e,"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:l("edit",e,t)}},delete:function(t,r,n){return n||(n={}),{label:c(t,"PAGE_ACTION:delete"),icon:"times",href:t.genClientUrl("delete"),privileges:l("delete",t,r),callback:function(r){r&&0!==r.button||(r&&r.preventDefault(),a.showDeleteDialog(e.defaults({model:t},n)))}}},export:function(t,r,n,a){var o={layout:t,page:r,collection:n,privilege:a,maxCount:6e4};1===arguments.length&&e.assign(o,t);var p=function(){var t,r=(t=o.collection).paginationData?t.paginationData.get("totalCount"):t.length,n=e.result(o.collection,"url")+";export.${format}?"+o.collection.rqlQuery,a=[{type:"csv",href:n.replace("${format}","csv")}];return window.XLSX_EXPORT&&r<o.maxCount/2&&a.push({type:"xlsx",href:n.replace("${format}","xlsx")}),i({type:r>=o.maxCount/2?"danger":r>=o.maxCount/4?"warning":"default",formats:a,disabled:r>=o.maxCount||0===r,label:o.label||c(o.collection,"PAGE_ACTION:export")})};return o.page.listenTo(o.collection,"sync",function(){o.layout.$(".page-actions-export").replaceWith(p()),s(o.layout.$(".page-actions-export"))}),{template:p,privileges:l("view",o.collection,o.privilege,"VIEW"),callback:o.callback,afterRender:s};function s(e){var t=e.find('a[data-export-type="xlsx"]');if(t.length){var r=t.prop("href");t.prop("href","javascript:void(0)"),t.on("click",function(e){e.preventDefault(),u(r)})}}},exportXlsx:u,jump:function(t,r,a){return a=e.assign({mode:"rid",pattern:"^ *[0-9]+ *$",autoFocus:!window.IS_MOBILE},a),{template:function(){return o({title:a.title||c(r,"PAGE_ACTION:jump:title"),placeholder:a.placeholder||c(r,"PAGE_ACTION:jump:placeholder"),autoFocus:a.autoFocus,pattern:a.pattern})},afterRender:function(o){var i=o.find("form");i.submit(function(t,r,a,o){var i=a[0].phrase;if(i.readOnly)return!1;var l=i.value;i.readOnly=!0;var u=a.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),p=t.ajax("rid"===o.mode?{url:e.result(r,"url")+";rid",data:{rid:l}}:{method:"HEAD",url:e.result(r,"url")+"/"+l});return p.done(function(e){t.broker.publish("router.navigate",{url:r.genClientUrl()+"/"+(e||l),trigger:!0})}),p.fail(function(){n.msg.show({type:"error",time:2e3,text:c(r,"MSG:jump:404",{rid:l})}),u.removeClass("fa-spinner fa-spin").addClass("fa-search"),i.readOnly=!1,i.select()}),!1}.bind(null,t,r,i,a))}}}}});