// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction","app/core/templates/exportAction"],function(e,t,r,n,l,a){"use strict";function i(e,t,r){return t===!1?null:t||e.getPrivilegePrefix()+":"+(r||"MANAGE")}function o(e){return e.paginationData?e.paginationData.get("totalCount"):e.length}function u(n,l,a,i){var o=a[0].phrase;if(o.readOnly)return!1;var u=o.value;o.readOnly=!0;var c=a.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),s=n.ajax("rid"===i.mode?{url:e.result(l,"url")+";rid",data:{rid:u}}:{method:"HEAD",url:e.result(l,"url")+"/"+u});return s.done(function(e){n.broker.publish("router.navigate",{url:l.genClientUrl()+"/"+(e||u),trigger:!0})}),s.fail(function(){r.msg.show({type:"error",time:2e3,text:t(l.getNlsDomain(),"MSG:jump:404",{rid:u})}),c.removeClass("fa-spinner fa-spin").addClass("fa-search"),o.readOnly=!1,o.select()}),!1}return{add:function(e,r){return{label:t.bound(e.getNlsDomain(),"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:i(e,r)}},edit:function(e,r){return{label:t.bound(e.getNlsDomain(),"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:i(e,r)}},delete:function(r,l,a){return a||(a={}),{label:t.bound(r.getNlsDomain(),"PAGE_ACTION:delete"),icon:"times",href:r.genClientUrl("delete"),privileges:i(r,l),callback:function(t){t&&0!==t.button||(t&&t.preventDefault(),n.showDeleteDialog(e.defaults({model:r},a)))}}},export:function(r,n,l,u){var c={layout:r,page:n,collection:l,privilege:u};1===arguments.length&&(c=r);var s=function(){var r=o(c.collection),n=e.result(c.collection,"url")+";export.${format}?"+c.collection.rqlQuery,l=[{type:"csv",href:n.replace("${format}","csv")}];return window.XLSX_EXPORT&&r<3e4&&l.push({type:"xlsx",href:n.replace("${format}","xlsx")}),a({type:r>=3e4?"danger":r>=15e3?"warning":"default",formats:l,disabled:r>=6e4||0===r,label:c.label||t(c.collection.getNlsDomain(),"PAGE_ACTION:export")})};return c.page.listenTo(c.collection,"sync",function(){c.layout.$(".page-actions-export").replaceWith(s())}),{template:s,privileges:i(c.collection,c.privilege,"VIEW"),callback:c.callback}},jump:function(r,n,a){return a=e.assign({mode:"rid",pattern:"^ *[0-9]+ *$",autoFocus:!0},a),{template:function(){var e=n.getNlsDomain();return l({title:a.title||t(e,"PAGE_ACTION:jump:title"),placeholder:a.placeholder||t(e,"PAGE_ACTION:jump:placeholder"),autoFocus:a.autoFocus,pattern:a.pattern})},afterRender:function(e){var t=e.find("form");t.submit(u.bind(null,r,n,t,a))}}}}});