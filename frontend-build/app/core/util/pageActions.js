define(["underscore","jquery","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction","app/core/templates/exportAction"],function(e,t,n,r,a,o,i){"use strict";function l(e,t,n,r){if(!1===n)return null;var a=t.model||t.constructor,o=a.can&&(a.can[e]||a.can.manage);return o?o.bind(a,t,e):n||t.getPrivilegePrefix()+":"+(r||"MANAGE")}function u(e){var a=r.msg.show({type:"warning",text:n("core","MSG:EXPORTING"),sticky:!0}),o=t.ajax({url:e});return o.fail(function(){r.msg.show({type:"error",time:2500,text:n("core","MSG:EXPORTING_FAILURE")})}),o.done(function(e){window.open("/express/exports/"+e)}),o.always(function(){r.msg.hide(a)}),o}function c(e,t,r){var a=e.getNlsDomain();return n.bound(n.has(a,t)?a:"core",t,r)}return{add:function(e,t){return{label:c(e,"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:l("add",e,t)}},edit:function(e,t){return{label:c(e,"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:l("edit",e,t)}},delete:function(t,n,r){return r||(r={}),{label:c(t,"PAGE_ACTION:delete"),icon:"times",href:t.genClientUrl("delete"),privileges:l("delete",t,n),callback:function(n){n&&0!==n.button||(n&&n.preventDefault(),a.showDeleteDialog(e.defaults({model:t},r)))}}},export:function(t,n,r,a){var o={layout:t,page:n,collection:r,privilege:a,maxCount:6e4};1===arguments.length&&e.assign(o,t);var p=function(){var t,n=(t=o.collection).paginationData?t.paginationData.get("totalCount"):t.length,r=e.result(o.collection,"url")+";export.${format}?"+o.collection.rqlQuery,a=[{type:"csv",href:r.replace("${format}","csv")}];return window.XLSX_EXPORT&&n<o.maxCount/2&&a.push({type:"xlsx",href:r.replace("${format}","xlsx")}),i({type:n>=o.maxCount/2?"danger":n>=o.maxCount/4?"warning":"default",formats:a,disabled:n>=o.maxCount||0===n,label:o.label||c(o.collection,"PAGE_ACTION:export")})};return o.page.listenTo(o.collection,"sync",function(){o.layout.$(".page-actions-export").replaceWith(p()),s(o.layout.$(".page-actions-export"))}),{template:p,privileges:l("view",o.collection,o.privilege,"VIEW"),callback:o.callback,afterRender:s};function s(e){!function(e){var t=e.find(".page-actions-export");t.hasClass("btn-group")&&(t=t.find('a[data-export-type="csv"]'));if(!t.length)return;var n=t.prop("href");t.prop("href","javascript:void(0)"),t.on("click",function(e){e.preventDefault(),window.open(n)})}(e),function(e){var t=e.find('a[data-export-type="xlsx"]');if(!t.length)return;var n=t.prop("href");t.prop("href","javascript:void(0)"),t.on("click",function(e){e.preventDefault(),u(n)})}(e)}},exportXlsx:u,jump:function(t,n,a){return a=e.assign({mode:"rid",pattern:"^ *[0-9]+ *$",autoFocus:!window.IS_MOBILE},a),{template:function(){return o({title:a.title||c(n,"PAGE_ACTION:jump:title"),placeholder:a.placeholder||c(n,"PAGE_ACTION:jump:placeholder"),autoFocus:a.autoFocus,pattern:a.pattern})},afterRender:function(o){var i=o.find("form");i.submit(function(t,n,a,o){var i=a[0].phrase;if(i.readOnly)return!1;var l=i.value;i.readOnly=!0;var u=a.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),p=t.ajax("rid"===o.mode?{url:e.result(n,"url")+";rid",data:{rid:l}}:{method:"HEAD",url:e.result(n,"url")+"/"+l});return p.done(function(e){t.broker.publish("router.navigate",{url:n.genClientUrl()+"/"+(e||l),trigger:!0})}),p.fail(function(){r.msg.show({type:"error",time:2e3,text:c(n,"MSG:jump:404",{rid:l})}),u.removeClass("fa-spinner fa-spin").addClass("fa-search"),i.readOnly=!1,i.select()}),!1}.bind(null,t,n,i,a))}}}}});