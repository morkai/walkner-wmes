define(["underscore","jquery","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction","app/core/templates/exportAction"],function(e,t,n,r,a,i,o){"use strict";function l(e,t,n,r){if(!1===n)return null;var a=t.model||t.constructor,i=a.can&&(a.can[e]||a.can.manage);return i?i.bind(a,t,e):n||t.getPrivilegePrefix()+":"+(r||"MANAGE")}function u(e){var a=r.msg.show({type:"warning",text:n("core","MSG:EXPORTING"),sticky:!0}),i=t.ajax({url:e});return i.fail(function(){r.msg.show({type:"error",time:2500,text:n("core","MSG:EXPORTING_FAILURE")})}),i.done(function(e){window.open("/express/exports/"+e)}),i.always(function(){r.msg.hide(a)}),i}function c(e,t,r){var a=e.getNlsDomain();return n.bound(n.has(a,t)?a:"core",t,r)}return{add:function(e,t){return{label:c(e,"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:l("add",e,t)}},edit:function(e,t){return{label:c(e,"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:l("edit",e,t)}},delete:function(t,n,r){return r||(r={}),{label:c(t,"PAGE_ACTION:delete"),icon:"times",href:t.genClientUrl("delete"),privileges:l("delete",t,n),callback:function(n){n&&0!==n.button||(n&&n.preventDefault(),a.showDeleteDialog(e.defaults({model:t},r)))}}},export:function(t,n,r,a){var i={layout:t,page:n,collection:r,privilege:a,maxCount:6e4};1===arguments.length&&e.assign(i,t);var p=function(){var t,n=(t=i.collection).paginationData?t.paginationData.get("totalCount"):t.length,r=e.result(i.collection,"url")+";export.${format}?"+i.collection.rqlQuery,a=[{type:"csv",href:r.replace("${format}","csv")}];return window.XLSX_EXPORT&&n<i.maxCount/2&&a.push({type:"xlsx",href:r.replace("${format}","xlsx")}),o({type:n>=i.maxCount/2?"danger":n>=i.maxCount/4?"warning":"default",formats:a,disabled:n>=i.maxCount||0===n,label:i.label||c(i.collection,"PAGE_ACTION:export")})};return i.page.listenTo(i.collection,"sync",function(){i.layout.$(".page-actions-export").replaceWith(p()),s(i.layout.$(".page-actions-export"))}),{template:p,privileges:l("view",i.collection,i.privilege,"VIEW"),callback:i.callback,afterRender:s};function s(e){!function(e){var t=e.find(".page-actions-export");t.hasClass("btn-group")&&(t=t.find('a[data-export-type="csv"]'));if(!t.length)return;var n=t.prop("href");t.prop("href","javascript:void(0)"),t.on("click",function(e){e.preventDefault(),window.open(n)})}(e),function(e){var t=e.find('a[data-export-type="xlsx"]');if(!t.length)return;var n=t.prop("href");t.prop("href","javascript:void(0)"),t.on("click",function(e){e.preventDefault(),u(n)})}(e)}},exportXlsx:u,jump:function(t,n,a){return a=e.assign({mode:"rid",pattern:"^ *[0-9]+ *$",autoFocus:!window.IS_MOBILE,width:150},a),{template:function(){return i({title:a.title||c(n,"PAGE_ACTION:jump:title"),placeholder:a.placeholder||c(n,"PAGE_ACTION:jump:placeholder"),autoFocus:a.autoFocus,pattern:a.pattern,width:a.width})},afterRender:function(i){var o=i.find("form");o.submit(function(t,n,a,i){var o=a[0].phrase;if(o.readOnly)return!1;var l=o.value;o.readOnly=!0;var u=a.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),p=t.ajax("rid"===i.mode?{url:e.result(n,"url")+";rid",data:{rid:l}}:{method:"HEAD",url:e.result(n,"url")+"/"+l});return p.done(function(e){t.broker.publish("router.navigate",{url:n.genClientUrl()+"/"+(e||l),trigger:!0})}),p.fail(function(){r.msg.show({type:"error",time:2e3,text:c(n,"MSG:jump:404",{rid:l})}),u.removeClass("fa-spinner fa-spin").addClass("fa-search"),o.readOnly=!1,o.select()}),!1}.bind(null,t,n,o,a))}}}}});