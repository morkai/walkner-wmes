define(["underscore","jquery","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction","app/core/templates/exportAction"],function(e,t,r,n,a,l,i){"use strict";function o(e,t,r){return!1===t?null:t||e.getPrivilegePrefix()+":"+(r||"MANAGE")}function u(e,t){var n=e.getNlsDomain();return r.bound(r.has(n,t)?n:"core",t)}return{add:function(e,t){return{label:u(e,"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:o(e,t)}},edit:function(e,t){return{label:u(e,"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:o(e,t)}},delete:function(t,r,n){return n||(n={}),{label:u(t,"PAGE_ACTION:delete"),icon:"times",href:t.genClientUrl("delete"),privileges:o(t,r),callback:function(r){r&&0!==r.button||(r&&r.preventDefault(),a.showDeleteDialog(e.defaults({model:t},n)))}}},export:function(a,l,c,p){var s={layout:a,page:l,collection:c,privilege:p,maxCount:6e4};1===arguments.length&&e.assign(s,a);var f=function(){var t,r=(t=s.collection).paginationData?t.paginationData.get("totalCount"):t.length,n=e.result(s.collection,"url")+";export.${format}?"+s.collection.rqlQuery,a=[{type:"csv",href:n.replace("${format}","csv")}];return window.XLSX_EXPORT&&r<s.maxCount/2&&a.push({type:"xlsx",href:n.replace("${format}","xlsx")}),i({type:r>=s.maxCount/2?"danger":r>=s.maxCount/4?"warning":"default",formats:a,disabled:r>=s.maxCount||0===r,label:s.label||u(s.collection,"PAGE_ACTION:export")})};return s.page.listenTo(s.collection,"sync",function(){s.layout.$(".page-actions-export").replaceWith(f())}),{template:f,privileges:o(s.collection,s.privilege,"VIEW"),callback:s.callback,afterRender:function(e){var a=e.find('a[data-export-type="xlsx"]');if(a.length){var l=a.prop("href");a.prop("href","javascript:void(0)"),a.on("click",function(e){var a,i,o;e.preventDefault(),a=l,i=n.msg.show({type:"warning",text:r("core","MSG:EXPORTING"),sticky:!0}),(o=t.ajax({url:a})).fail(function(){n.msg.show({type:"error",time:2500,text:r("core","MSG:EXPORTING_FAILURE")})}),o.done(function(e){window.open("/express/exports/"+e)}),o.always(function(){n.msg.hide(i)})})}}}},jump:function(t,a,i){return i=e.assign({mode:"rid",pattern:"^ *[0-9]+ *$",autoFocus:!0},i),{template:function(){return l({title:i.title||u(a,"PAGE_ACTION:jump:title"),placeholder:i.placeholder||u(a,"PAGE_ACTION:jump:placeholder"),autoFocus:i.autoFocus,pattern:i.pattern})},afterRender:function(l){var o=l.find("form");o.submit(function(t,a,l,i){var o=l[0].phrase;if(o.readOnly)return!1;var u=o.value;o.readOnly=!0;var c=l.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),p=t.ajax("rid"===i.mode?{url:e.result(a,"url")+";rid",data:{rid:u}}:{method:"HEAD",url:e.result(a,"url")+"/"+u});return p.done(function(e){t.broker.publish("router.navigate",{url:a.genClientUrl()+"/"+(e||u),trigger:!0})}),p.fail(function(){n.msg.show({type:"error",time:2e3,text:r(a.getNlsDomain(),"MSG:jump:404",{rid:u})}),c.removeClass("fa-spinner fa-spin").addClass("fa-search"),o.readOnly=!1,o.select()}),!1}.bind(null,t,a,o,i))}}}}});