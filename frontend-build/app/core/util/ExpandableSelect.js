// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","underscore"],function(e,t){function s(e,t){this.$el=e,this.$helper=null,this.options=t,this.$el.on("mousedown."+n,this.onMouseDown.bind(this)).on("keydown."+n,this.onKeyDown.bind(this)).on("focus."+n,this.onFocus.bind(this)).on("blur."+n,this.onBlur.bind(this))}var n="expandableSelect";return s.prototype={destroy:function(){this.collapse(),this.$el.off("."+n),this.$el=null},isExpanded:function(){return this.$el.hasClass(this.options.isExpandedClassName)},expand:function(){if(!this.isExpanded()){var e=this.$el.css("width"),t=this.$el.position();this.$helper=this.options.createHelperElement(this.$el),this.$helper.css({width:e,opacity:0}),this.$helper.insertAfter(this.$el);var s=this.$el.prop("length")+this.$el.find("optgroup").length,n=this.options.expandedLength||parseInt(this.$el.attr("data-expanded-length"),10)||s;this.$el.prop("size",n>s?s:n),this.$el.css({top:t.top+"px",left:t.left+"px",width:e}),this.$el.addClass(this.options.isExpandedClassName)}},collapse:function(){this.isExpanded()&&(this.$helper.remove(),this.$helper=null,this.$el.prop("size",1),this.$el.removeClass(this.options.isExpandedClassName))},onMouseDown:function(e){this.isExpanded()||(this.expand(),t.defer(this.$el.focus.bind(this.$el)),e.preventDefault())},onKeyDown:function(e){return 27===e.keyCode?(this.$el.blur(),!1):void 0},onFocus:function(){this.expand()},onBlur:function(){this.collapse()}},e.fn[n]=function(){var i,l=null,o=null,h=null;return 0!==arguments.length&&t.isString(arguments[0])?(h=Array.prototype.slice.call(arguments),o=h.shift()):l=t.defaults({},arguments[0],e.fn[n].defaults),this.each(function(){var t=e(this),a=t.data(n);if(a){if(null!==o)return i=a[o].apply(a,h),void(void 0===i&&(i=null));a.destroy()}t.data(n,new s(t,l))}),void 0===i?this:i},e.fn[n].defaults={isExpandedClassName:"is-expanded",createHelperElement:function(t){return e("<div></div>").attr("class",t.attr("class"))},expandedLength:0},s});