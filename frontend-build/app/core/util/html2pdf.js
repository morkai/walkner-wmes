// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport"],function(t,i,e,n){"use strict";function s(i,s,o){var r=Math.min(window.screen.availWidth-200,1400);s=t.assign({top:80,width:r,height:Math.min(window.screen.availHeight-160,800),left:window.screen.availWidth-r-80},t.pick(s,["top","left","width","height"]));var a=[];Object.keys(s).forEach(function(t){a.push(t+"="+s[t])});var p=window.open("/html2pdf/"+o+".pdf","_blank",a.join(","));p?(n.msg.hide(i),p.focus()):(n.msg.hide(i,!0),n.msg.show({type:"error",time:3e3,text:e("core","MSG:POPUP_BLOCKED")}))}function o(t,s,o){n.msg.hide(t),t=n.msg.show({type:"info",text:'<i class="fa fa-spinner fa-spin"></i><span>'+e("core","html2pdf:printing")+"</span>"});var r=i.ajax({method:"POST",url:"/html2pdf;print",data:JSON.stringify({hash:o,printer:s})});r.done(function(){n.msg.hide(t,!0),n.msg.show({type:"success",time:2e3,text:e("core","html2pdf:printing:success")})}),r.fail(function(){n.msg.hide(t,!0),n.msg.show({type:"error",time:2500,text:e("core","html2pdf:printing:failure")})})}return function(r,a,p){"string"==typeof a&&(p=a,a=null),a=t.assign({format:"A4",orientation:"portrait"},a);var f=n.msg.show({type:"info",text:'<i class="fa fa-spinner fa-spin"></i><span>'+e("core","html2pdf:progress")+"</span>"}),h=i.ajax({method:"POST",url:"/html2pdf?format="+a.format+"&orientation="+a.orientation,contentType:"text/plain",data:r});h.done(function(t){"string"==typeof p&&/^[a-f0-9]{24}$/.test(p)?o(f,p,t.hash):s(f,a,t.hash)}),h.fail(function(){n.msg.hide(f,!0),n.msg.show({type:"error",time:2500,text:e("core","html2pdf:failure")})})}});