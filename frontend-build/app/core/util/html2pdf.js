define(["underscore","jquery","app/i18n","app/broker","app/viewport"],function(t,e,i,n,s){"use strict";return function(a,o,r){"string"==typeof o&&(r=o,o=null),o=t.assign({format:"A4",orientation:"portrait"},o);var p=s.msg.show({type:"info",text:'<i class="fa fa-spinner fa-spin"></i><span>'+i("core","html2pdf:progress")+"</span>"}),f=e.ajax({method:"POST",url:"/html2pdf?format="+o.format+"&orientation="+o.orientation,contentType:"text/plain",data:a});f.done(function(a){"string"==typeof r&&/^[a-f0-9]{24}$/.test(r)?function(t,a,o){s.msg.hide(t),t=s.msg.show({type:"info",text:'<i class="fa fa-spinner fa-spin"></i><span>'+i("core","html2pdf:printing")+"</span>"});var r=e.ajax({method:"POST",url:"/html2pdf;print",data:JSON.stringify({hash:o,printer:a})});r.done(function(){s.msg.hide(t,!0),s.msg.show({type:"success",time:2e3,text:i("core","html2pdf:printing:success")})}),r.fail(function(){s.msg.hide(t,!0),s.msg.show({type:"error",time:2500,text:i("core","html2pdf:printing:failure")})}),r.always(function(){n.publish("html2pdf.completed")})}(p,r,a.hash):function(e,a,o){var r=Math.min(window.screen.availWidth-200,1400),p=t.assign({top:80,width:r,height:Math.min(window.screen.availHeight-160,800),left:window.screen.availWidth-r-80},t.pick(a,["top","left","width","height"])),f=[];Object.keys(p).forEach(function(t){f.push(t+"="+p[t])});var h="/html2pdf/"+o;a.filename&&(h+="/"+a.filename);h+=".pdf";var m=window.open(h,"_blank",f.join(","));m?(s.msg.hide(e),m.focus()):(s.msg.hide(e,!0),s.msg.show({type:"error",time:3e3,text:i("core","MSG:POPUP_BLOCKED")}));n.publish("html2pdf.completed")}(p,o,a.hash)}),f.fail(function(){s.msg.hide(p,!0),s.msg.show({type:"error",time:2500,text:i("core","html2pdf:failure")})})}});