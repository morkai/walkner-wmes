define(["underscore","jquery","app/i18n","app/broker","app/viewport"],function(t,e,i,n,s){"use strict";return function(o,a,r){"string"==typeof a&&(r=a,a=null),a=t.assign({format:"A4",orientation:"portrait"},a);var p=s.msg.show({type:"info",text:'<i class="fa fa-spinner fa-spin"></i><span>'+i("core","html2pdf:progress")+"</span>"}),f=e.ajax({method:"POST",url:"/html2pdf?format="+a.format+"&orientation="+a.orientation,contentType:"text/plain",data:o});f.done(function(o){"string"==typeof r&&/^[a-f0-9]{24}$/.test(r)?function(t,o,a){s.msg.hide(t),t=s.msg.show({type:"info",text:'<i class="fa fa-spinner fa-spin"></i><span>'+i("core","html2pdf:printing")+"</span>"});var r=e.ajax({method:"POST",url:"/html2pdf;print",data:JSON.stringify({hash:a,printer:o})});r.done(function(){s.msg.hide(t,!0),s.msg.show({type:"success",time:2e3,text:i("core","html2pdf:printing:success")})}),r.fail(function(){s.msg.hide(t,!0),s.msg.show({type:"error",time:2500,text:i("core","html2pdf:printing:failure")})}),r.always(function(){n.publish("html2pdf.completed")})}(p,r,o.hash):function(e,o,a){var r=Math.min(window.screen.availWidth-200,1400);o=t.assign({top:80,width:r,height:Math.min(window.screen.availHeight-160,800),left:window.screen.availWidth-r-80},t.pick(o,["top","left","width","height"]));var p=[];Object.keys(o).forEach(function(t){p.push(t+"="+o[t])});var f=window.open("/html2pdf/"+a+".pdf","_blank",p.join(","));f?(s.msg.hide(e),f.focus()):(s.msg.hide(e,!0),s.msg.show({type:"error",time:3e3,text:i("core","MSG:POPUP_BLOCKED")}));n.publish("html2pdf.completed")}(p,a,o.hash)}),f.fail(function(){s.msg.hide(p,!0),s.msg.show({type:"error",time:2500,text:i("core","html2pdf:failure")})})}});