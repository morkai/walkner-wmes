define(["underscore","jquery","app/i18n","app/time","app/core/util/getShiftStartInfo","app/core/templates/forms/dateTimeRange"],function(e,t,a,r,n,i){"use strict";var s={date:"YYYY-MM-DD",month:"YYYY-MM","date+time":"YYYY-MM-DD",time:"HH:mm:ss"},l={shifts:["+0+1","-1+0","1","2","3"],days:["+0+1","-1+0","-7+0","-14+0","-28+0"],weeks:["+0+1","-1+0","-2+0","-3+0","-4+0"],months:["+0+1","-1+0","-2+0","-3+0","-6+0"],quarters:["+0+1","1","2","3","4",null],years:["+0+1","-1+0",null,null,null]},o=!1;function u(e){var a=e.currentTarget,r=document.getElementById(a.htmlFor);r&&requestAnimationFrame(function(){r.disabled||t(r).prop("checked",!0).trigger("change")})}function d(e){if("Escape"===e.key)return e.currentTarget.value="",!1}function m(n){o||(t(document).on("click",".dateTimeRange-is-input > .dropdown-toggle",u).on("keyup",".dateTimeRange-field > .form-control",d),o=!0);var c=n.type||"date",g={idPrefix:n.idPrefix||"v",property:n.property||"date",formGroup:!1!==n.formGroup,hidden:!0===n.hidden,utc:n.utc?1:0,setTime:!1!==n.setTime?1:0,type:c,startHour:n.startHour||0,shiftLength:n.shiftLength||8,minDate:n.minDate||window.PRODUCTION_DATA_START_DATE||"",maxDate:""===n.maxDate?"":n.maxDate||r.getMoment().add(1,"years").format(s[c]),labelProperty:n.labelProperty||"dateFilter",labels:[],maxLabels:2,separator:n.separator||"â€“",required:{date:[!1,!1],time:[!1,!1]}};if(n.required){var p=g.required;"boolean"==typeof n.required?(p.date=[n.required,n.required],p.time=[n.required,n.required]):Array.isArray(n.required)?(p.date=[!!n.required[0],!!n.required[1]],p.time=[!!n.required[0],!!n.required[1]]):(Array.isArray(n.required.date)?p.date=[!!n.required.date[0],!!n.required.date[1]]:p.date=[!!n.required.date,!!n.required.date],Array.isArray(n.required.time)?p.time=[!!n.required.time[0],!!n.required.time[1]]:p.time=[!!n.required.time,!!n.required.time])}if(n.labels?Array.isArray(n.labels)?g.labels=[].concat(n.labels):g.labels.push(n.labels):g.labels.push({ranges:!0}),g.labels=g.labels.map(function(t){return{text:t.text||a("core","dateTimeRange:label:"+g.type),dropdown:function(e){return Array.isArray(e.dropdown)?e.dropdown.map(function(e){return"object"==typeof e.attrs&&(e.attrs=Object.keys(e.attrs).map(function(t){return t+'="'+e.attrs[t]+'"'}).join(" ")),e}):null}(t),value:t.value||null,ranges:function(t){if(!0===t.ranges&&(t.ranges=""),"string"!=typeof t.ranges)return null;var a={shifts:!1,days:!0,weeks:!0,months:!0,quarters:!0,years:!0};t.ranges.split(" ").some(function(e){return/^[^+\-]/.test(e)})&&Object.keys(a).forEach(function(e){a[e]=!1});var r=e.assign({},l);return t.ranges.split(" ").forEach(function(e){var t="-"===e.charAt(0)?"-":"+",n=e.replace(/^[^a-z]+/,"").split(":"),i=n.shift(),s=n.length?n[0].split("_"):[];a[i]="+"===t,s.length&&(r[i]=s)}),Object.keys(a).forEach(function(e){r[e]&&a[e]?a[e]=r[e]:delete a[e]}),a}(t),utc:null==t.utc?n.utc:t.utc?1:0}}),g.labels.length>g.maxLabels){var h=g.idPrefix+"-dateTimeRange-"+g.property;requestAnimationFrame(function(){t("#"+h).on("click","a[data-label-value]",f),m.toggleLabel(h)})}return i(g)}function f(e){var a=t(e.currentTarget).closest(".dateTimeRange-labels"),r=e.currentTarget.dataset.labelValue,n=a.find('.dateTimeRange-label-input[value="'+r+'"]');return n.prop("checked",!0),m.toggleLabel(a.closest(".dateTimeRange").prop("id")),n.closest(".dropdown-toggle").click(),!1}return m.handleRangeEvent=function(e){var t=this.$(e.target).closest("a[data-date-time-range]"),a=t.closest(".dateTimeRange"),r=a[0].dataset.type,i="1"===a[0].dataset.utc,l=+a[0].dataset.startHour,o=+a[0].dataset.shiftLength,u=t[0].dataset.dateTimeGroup,d=t[0].dataset.dateTimeRange,m=u,f=1,c=n(Date.now(),{utc:i,startHour:l,shiftLength:o}),g=c.moment,p=null;if(g.hours()<l&&g.subtract(24,"hours"),"shifts"===u?(m="hours",f=o):g.startOf("day"),/^[0-9]+$/.test(d))"shifts"===u?(g.subtract((c.no-1)*c.length,"hours").add((+d-1)*c.length,"hours"),p=g.clone().add(c.length,"hours")):("0"===d?g.startOf(m):g.startOf("year").add(d-1,m),p=g.clone().add(1,m));else{var h=d.match(/^([+-])([0-9]+)([+-])([0-9]+)$/)||[0,"+","0","+","1"];p=g.startOf(m).clone()["+"===h[3]?"add":"subtract"](+h[4]*f,m),g=g["+"===h[1]?"add":"subtract"](+h[2]*f,m)}"shifts"!==u&&(g.hours(l),p.hours(l));var v=s[r];a.find('input[name="from-date"]').val(g.format(v)).trigger("change"),a.find('input[name="from-time"]').val(g.format("HH:mm:ss")).trigger("change"),a.find('input[name="to-date"]').val(p.format(v)).trigger("change"),a.find('input[name="to-time"]').val(p.format("HH:mm:ss")).trigger("change");var y=this.$('[name="interval"]');if(y.length){var b={},T=[];y.each(function(){this.disabled||this.parentNode.classList.contains("disabled")||(b[this.value]=this,T.push(this.value))});var q=function(e,t){var a=36e5;if(e<=8*a)return"hour";var r=24*a;if(e<=9e7)return"shift";if("weeks"===t&&e>11988e5&&e<=243e7)return"week";var n=31*r;return e<=26892e5?"day":e<2.5*n?"week":e>12*n?"year":"month"}(p.valueOf()-g.valueOf(),u);b[q]||(q=T[T.length-1]),q&&y.filter('[value="'+q+'"]').parent().click()}e.altKey&&this.$('[type="submit"]').click()},m.serialize=function(e){var t=e.$(".dateTimeRange"),a=t.find(".dateTimeRange-label-input:checked"),n=a.length?a.val():t[0].dataset.property,i=Object.assign({},t[0].dataset,a.prop("dataset")),l=i.type,o=s[l],u="1"===i.utc,d="1"===i.setTime,m=i.startHour,f=t.find('input[name="from-date"]'),c=t.find('input[name="from-time"]'),g=t.find('input[name="to-date"]'),p=t.find('input[name="to-time"]'),h=f.val(),v=c.val(),y=g.val(),b=p.val();(!f.length||h.length<7)&&(h="1970-01-01"),(!g.length||y.length<7)&&(y="1970-01-01"),7===h.length&&(h+="-01"),7===y.length&&(y+="-01");var T=d?(1===m.length?"0":"")+m+":00":"00:00:00";(!c.length||v.length<5)&&(v=T),(!p.length||b.length<5)&&(b=T),5===v.length&&(v+=":00"),5===b.length&&(b+=":00");var q=(u?r.utc:r).getMoment(h+" "+v,"YYYY-MM-DD HH:mm:ss"),R=(u?r.utc:r).getMoment(y+" "+b,"YYYY-MM-DD HH:mm:ss");return H(q)?(f.val(""),c.val(""),q=null):(f.val(q.format(o)),c.val(q.format("HH:mm:ss"))),H(R)?(g.val(""),p.val(""),R=null):(g.val(R.format(o)),p.val(R.format("HH:mm:ss"))),{property:n,from:q,to:R};function H(e){return!e.isValid()||"time"!==l&&1970===e.year()}},m.formToRql=function(e,t){var a=m.serialize(e);a.from&&t.push({name:"ge",args:[a.property,a.from.valueOf()]}),a.to&&t.push({name:"lt",args:[a.property,a.to.valueOf()]})},m.rqlToForm=function(e,t,a){var n,i=this.$(".dateTimeRange"),l=i.find(".dateTimeRange-label-input").first().prop("name"),o=i[0].dataset,u=this.$id(l+"-"+e).prop("dataset")||{},d=s[u.type||o.type],m=((null==u.utc?"1"===o.utc:"1"===u.utc)?r.utc:r).getMoment(t.args[1]);"ge"===t.name||"gt"===t.name?n="from":"le"!==t.name&&"lt"!==t.name||(n="to"),n&&m.isValid()&&(l&&(a[l]=e),a[n+"-date"]=m.format(d),a[n+"-time"]=m.format("HH:mm:ss"))},m.toggleLabel=function(e){var a=("string"==typeof e?t("#"+e):e.$(".dateTimeRange").first()).find(".dateTimeRange-labels");a.hasClass("dateTimeRange-labels-overflow")&&a.find(".dateTimeRange-label").each(function(){this.classList.toggle("hidden",!t(this).find(".dateTimeRange-label-input").prop("checked"))})},m});