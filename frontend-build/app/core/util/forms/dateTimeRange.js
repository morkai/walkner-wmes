define(["underscore","jquery","app/i18n","app/time","app/core/util/getShiftStartInfo","app/core/templates/forms/dateTimeRange"],function(t,e,a,r,n,s){"use strict";var i={date:"YYYY-MM-DD",month:"YYYY-MM","date+time":"YYYY-MM-DD",time:"HH:mm:ss"},o={shifts:["+0+1","-1+0","1","2","3"],days:["+0+1","-1+0","-7+0","-14+0","-28+0"],weeks:["+0+1","-1+0","-2+0","-3+0","-4+0"],months:["+0+1","-1+0","-2+0","-3+0","-6+0"],quarters:["+0+1","1","2","3","4",null],years:["+0+1","-1+0",null,null,null]},l=!1;function u(t){var a=t.currentTarget,r=document.getElementById(a.htmlFor);r&&requestAnimationFrame(function(){r.disabled||e(r).prop("checked",!0).trigger("change")})}function m(n){l||(e(document).on("click",".dateTimeRange-is-input > .dropdown-toggle",u),l=!0);var m=n.type||"date",d={idPrefix:n.idPrefix||"v",property:n.property||"date",formGroup:!1!==n.formGroup,hidden:!0===n.hidden,utc:n.utc?1:0,setTime:!1!==n.setTime?1:0,type:m,startHour:n.startHour||0,shiftLength:n.shiftLength||8,minDate:n.minDate||window.PRODUCTION_DATA_START_DATE||"",maxDate:""===n.maxDate?"":n.maxDate||r.getMoment().add(1,"years").format(i[m]),labels:[],separator:n.separator||"â€“",required:{date:!1,time:!1}};if(n.required){var f=d.required;"boolean"==typeof n.required?(f.date=!0,f.time=!0):(f.date=!!n.required.date,f.time=!!n.required.time)}return n.labels?Array.isArray(n.labels)?d.labels=[].concat(n.labels):d.labels.push(n.labels):d.labels.push({ranges:!0}),d.labels=d.labels.map(function(e){return{text:e.text||a("core","dateTimeRange:label:"+d.type),dropdown:function(t){return Array.isArray(t.dropdown)?t.dropdown.map(function(t){return"object"==typeof t.attrs&&(t.attrs=Object.keys(t.attrs).map(function(e){return e+'="'+t.attrs[e]+'"'}).join(" ")),t}):null}(e),input:e.input||null,ranges:function(e){if(!0===e.ranges&&(e.ranges=""),"string"!=typeof e.ranges)return null;var a={shifts:!1,days:!0,weeks:!0,months:!0,quarters:!0,years:!0};e.ranges.split(" ").some(function(t){return/^[^+\-]/.test(t)})&&Object.keys(a).forEach(function(t){a[t]=!1});var r=t.assign({},o);return e.ranges.split(" ").forEach(function(t){var e="-"===t.charAt(0)?"-":"+",n=t.replace(/^[^a-z]+/,"").split(":"),s=n.shift(),i=n.length?n[0].split("_"):[];a[s]="+"===e,i.length&&(r[s]=i)}),Object.keys(a).forEach(function(t){r[t]&&a[t]?a[t]=r[t]:delete a[t]}),a}(e)}}),s(d)}return m.handleRangeEvent=function(t){var e=this.$(t.target).closest("a[data-date-time-range]"),a=e.closest(".dateTimeRange"),r=a[0].dataset.type,s="1"===a[0].dataset.utc,o=+a[0].dataset.startHour,l=+a[0].dataset.shiftLength,u=e[0].dataset.dateTimeGroup,m=e[0].dataset.dateTimeRange,d=u,f=1,h=n(Date.now(),{utc:s,startHour:o,shiftLength:l}),c=h.moment,p=null;if(c.hours()<o&&c.subtract(24,"hours"),"shifts"===u?(d="hours",f=l):c.startOf("day"),/^[0-9]+$/.test(m))"shifts"===u?(c.subtract((h.no-1)*h.length,"hours").add((+m-1)*h.length,"hours"),p=c.clone().add(h.length,"hours")):("0"===m?c.startOf(d):c.startOf("year").add(m-1,d),p=c.clone().add(1,d));else{var g=m.match(/^([+-])([0-9]+)([+-])([0-9]+)$/)||[0,"+","0","+","1"];p=c.startOf(d).clone()["+"===g[3]?"add":"subtract"](+g[4]*f,d),c=c["+"===g[1]?"add":"subtract"](+g[2]*f,d)}"shifts"!==u&&(c.hours(o),p.hours(o));var v=i[r];a.find('input[name="from-date"]').val(c.format(v)),a.find('input[name="from-time"]').val(c.format("HH:mm:ss")),a.find('input[name="to-date"]').val(p.format(v)),a.find('input[name="to-time"]').val(p.format("HH:mm:ss"));var y=this.$('[name="interval"]');if(y.length){var b={},H=[];y.each(function(){this.disabled||this.parentNode.classList.contains("disabled")||(b[this.value]=this,H.push(this.value))});var Y=function(t,e){var a=36e5;if(t<=8*a)return"hour";var r=24*a;if(t<=9e7)return"shift";if("weeks"===e&&t>11988e5&&t<=243e7)return"week";var n=31*r;return t<=26892e5?"day":t<2.5*n?"week":t>12*n?"year":"month"}(p.valueOf()-c.valueOf(),u);b[Y]||(Y=H[H.length-1]),Y&&y.filter('[value="'+Y+'"]').parent().click()}t.altKey&&this.$('[type="submit"]').click()},m.serialize=function(t){var e=t.$(".dateTimeRange"),a=e[0].dataset.type,n=i[a],s="1"===e[0].dataset.utc,o="1"===e[0].dataset.setTime,l=e[0].dataset.startHour,u=e.find('input[name="from-date"]'),m=e.find('input[name="from-time"]'),d=e.find('input[name="to-date"]'),f=e.find('input[name="to-time"]'),h=u.val(),c=m.val(),p=d.val(),g=f.val();(!u.length||h.length<7)&&(h="1970-01-01"),(!d.length||p.length<7)&&(p="1970-01-01"),7===h.length&&(h+="-01"),7===p.length&&(p+="-01");var v=o?(1===l.length?"0":"")+l+":00":"00:00:00";(!m.length||c.length<5)&&(c=v),(!f.length||g.length<5)&&(g=v),5===c.length&&(c+=":00"),5===g.length&&(g+=":00");var y=(s?r.utc:r).getMoment(h+" "+c,"YYYY-MM-DD HH:mm:ss"),b=(s?r.utc:r).getMoment(p+" "+g,"YYYY-MM-DD HH:mm:ss");return H(y)?(u.val(""),m.val(""),y=null):(u.val(y.format(n)),m.val(y.format("HH:mm:ss"))),H(b)?(d.val(""),f.val(""),b=null):(d.val(b.format(n)),f.val(b.format("HH:mm:ss"))),{property:e[0].dataset.property,from:y,to:b};function H(t){return!t.isValid()||"time"!==a&&1970===t.year()}},m.formToRql=function(t,e){var a=m.serialize(t);a.from&&e.push({name:"ge",args:[a.property,a.from.valueOf()]}),a.to&&e.push({name:"lt",args:[a.property,a.to.valueOf()]})},m.rqlToForm=function(t,e,a){var n,s=this.$(".dateTimeRange")[0].dataset,o=i[s.type],l=("1"===s.utc?r.utc:r).getMoment(e.args[1]);"ge"===e.name||"gt"===e.name?n="from":"le"!==e.name&&"lt"!==e.name||(n="to"),n&&l.isValid()&&(a[n+"-date"]=l.format(o),a[n+"-time"]=l.format("HH:mm:ss"))},m});