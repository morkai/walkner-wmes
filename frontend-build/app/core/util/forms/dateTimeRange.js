define(["app/i18n","app/time","app/core/util/getShiftStartInfo","app/core/templates/forms/dateTimeRange"],function(t,e,a,r){"use strict";var n={shifts:["+0+1","-1+0","1","2","3"],days:["+0+1","-1+0","-7+0","-14+0","-28+0"],weeks:["+0+1","-1+0","-2+0","-3+0","-4+0"],months:["+0+1","-1+0","-2+0","-3+0","-6+0"],quarters:["+0+1","1","2","3","4",null],years:["+0+1","-1+0",null,null,null]};function s(a){var s={idPrefix:a.idPrefix||"v",property:a.property||"date",formGroup:!1!==a.formGroup,utc:a.utc?1:0,setTime:!1!==a.setTime?1:0,type:a.type||"date",startHour:a.startHour||0,shiftLength:a.shiftLength||8,minDate:a.minDate||window.PRODUCTION_DATA_START_DATE||"",maxDate:""===a.maxDate?"":a.maxDate||e.getMoment().add(1,"years").format("YYYY-MM-DD"),labels:[],separator:a.separator||"â€“"};return a.labels?Array.isArray(a.labels)?s.labels=[].concat(a.labels):s.labels.push(a.labels):s.labels.push({ranges:!0}),s.labels=s.labels.map(function(e){return{text:e.text||t("core","dateTimeRange:label:"+s.type),dropdown:function(t){return Array.isArray(t.dropdown)?t.dropdown.map(function(t){return"object"==typeof t.attrs&&(t.attrs=Object.keys(t.attrs).map(function(e){return e+'="'+t.attrs[e]+'"'}).join(" ")),t}):null}(e),ranges:function(t){if(!0===t.ranges&&(t.ranges=""),"string"!=typeof t.ranges)return null;var e={shifts:!1,days:!0,weeks:!0,months:!0,quarters:!0,years:!0};t.ranges.split(" ").some(function(t){return/^[^+\-]/.test(t)})&&Object.keys(e).forEach(function(t){e[t]=!1});var a=Object.assign({},n);return t.ranges.split(" ").forEach(function(t){var r="-"===t.charAt(0)?"-":"+",n=t.replace(/^[^a-z]+/,"").split(":"),s=n.shift(),o=n.length?n[0].split("_"):[];e[s]="+"===r,o.length&&(a[s]=o)}),Object.keys(e).forEach(function(t){a[t]&&e[t]?e[t]=a[t]:delete e[t]}),e}(e)}}),r(s)}return s.handleRangeEvent=function(t){var e=this.$(t.target).closest("a[data-date-time-range]"),r=e.closest(".dateTimeRange"),n="1"===r[0].dataset.utc,s=+r[0].dataset.startHour,o=+r[0].dataset.shiftLength,l=e[0].dataset.dateTimeGroup,i=e[0].dataset.dateTimeRange,m=l,u=1,f=a(Date.now(),{utc:n,startHour:s,shiftLength:o}),d=f.moment,p=null;if(d.hours()<s&&d.subtract(24,"hours"),"shifts"===l?(m="hours",u=o):d.startOf("day"),/^[0-9]+$/.test(i))"shifts"===l?(d.subtract((f.no-1)*f.length,"hours").add((+i-1)*f.length,"hours"),p=d.clone().add(f.length,"hours")):("0"===i?d.startOf(m):d.startOf("year").add(i-1,m),p=d.clone().add(1,m));else{var h=i.match(/^([+-])([0-9]+)([+-])([0-9]+)$/)||[0,"+","0","+","1"];p=d.startOf(m).clone()["+"===h[3]?"add":"subtract"](+h[4]*u,m),d=d["+"===h[1]?"add":"subtract"](+h[2]*u,m)}"shifts"!==l&&(d.hours(s),p.hours(s)),r.find('input[name="from-date"]').val(d.format("YYYY-MM-DD")),r.find('input[name="from-time"]').val(d.format("HH:mm:ss")),r.find('input[name="to-date"]').val(p.format("YYYY-MM-DD")),r.find('input[name="to-time"]').val(p.format("HH:mm:ss"))},s.serialize=function(t){var a=t.$(".dateTimeRange"),r="1"===a[0].dataset.utc,n="1"===a[0].dataset.setTime,s=a[0].dataset.startHour,o=a.find('input[name="from-date"]'),l=a.find('input[name="from-time"]'),i=a.find('input[name="to-date"]'),m=a.find('input[name="to-time"]'),u=o.val(),f=l.val(),d=i.val(),p=m.val();o.length||(u="2000-01-01"),i.length||(d="2000-01-01");var h=n?(1===s.length?"0":"")+s+":00":"00:00:00";(!l.length||f.length<5)&&(f=h),(!m.length||p.length<5)&&(p=h),5===f.length&&(f+=":00"),5===p.length&&(p+=":00");var c=(r?e.utc:e).getMoment(u+" "+f,"YYYY-MM-DD HH:mm:ss"),g=(r?e.utc:e).getMoment(d+" "+p,"YYYY-MM-DD HH:mm:ss");return c.isValid()?(o.val(c.format("YYYY-MM-DD")),l.val(c.format("HH:mm:ss"))):(o.val(""),l.val(""),c=null),g.isValid()?(i.val(g.format("YYYY-MM-DD")),m.val(g.format("HH:mm:ss"))):(i.val(""),m.val(""),g=null),{property:a[0].dataset.property,from:c,to:g}},s.formToRql=function(t,e){var a=s.serialize(t);a.from&&e.push({name:"ge",args:[a.property,a.from.valueOf()]}),a.to&&e.push({name:"lt",args:[a.property,a.to.valueOf()]})},s.rqlToForm=function(t,a,r){var n,s=("1"===this.$(".dateTimeRange")[0].dataset.utc?e.utc:e).getMoment(a.args[1]);"ge"===a.name||"gt"===a.name?n="from":"le"!==a.name&&"lt"!==a.name||(n="to"),n&&s.isValid()&&(r[n+"-date"]=s.format("YYYY-MM-DD"),r[n+"-time"]=s.format("HH:mm:ss"))},s});