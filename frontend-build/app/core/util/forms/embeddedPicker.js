define(["underscore","jquery","app/viewport","app/core/util/embedded","app/core/util/html","app/core/templates/forms/embeddedPicker"],function(e,d,r,i,t,l){"use strict";function o(e){return e.toUpperCase().replace(/[^A-Z0-9]+/g,"")}function n(e,d){var r=o(e.find(".form-embeddedPicker-filter").val()),i="",t=e.find(".form-embeddedPicker-value").val();d.forEach(function(e){-1!==e.filter.indexOf(r)&&(i+='<button class="btn btn-default '+(e.value===t?"active":"")+'" type="button" value="'+e.value+'"><span class="form-embeddedPicker-label">'+e.label+'</span><span class="form-embeddedPicker-description">'+e.description+"</span></button>")}),e.find(".form-embeddedPicker-options").html(i)}return function(i,t){t=Object.assign({label:"?",placeholder:"",filter:"",options:[]},t);var c=d(l({required:i.prop("required"),label:t.label,placeholder:t.placeholder,filter:t.filter})),a=t.options.map(function(d){return{value:e.escape(d.value),label:e.escape(d.label||d.value),description:e.escape(d.description||""),filter:o((d.label||d.value)+(d.description||""))}}).sort(function(e,d){return e.label.localeCompare(d.label,void 0,{numeric:!0,ignorePunctuation:!0})});c.find(".form-embeddedPicker-clear").on("click",function(){i.val(""),c.find(".form-embeddedPicker-selected").text(t.placeholder)}),c.find(".form-embeddedPicker-selected").on("click",function(){c.addClass("form-embeddedPicker-selecting"),c.find(".form-embeddedPicker-filter").val("").focus(),n(c,a);var e=c.find(".active");e.length?e[0].scrollIntoView():c.find(".form-embeddedPicker-options")[0].scrollTop=0,r.adjustDialogBackdrop()}),c.find(".form-embeddedPicker-filter").on("input",function(){n(c,a)}),c.find(".form-embeddedPicker-options").on("click",".btn",function(e){i.val(e.currentTarget.value),c.find(".form-embeddedPicker-selected").html(e.currentTarget.innerHTML),c.removeClass("form-embeddedPicker-selecting"),r.adjustDialogBackdrop()}),c.insertAfter(i),i.addClass("form-embeddedPicker-value").appendTo(c.find(".form-embeddedPicker-buttons"));var f=c.find(".form-embeddedPicker-selected");f.css("width",f.outerWidth()+"px"),r.adjustDialogBackdrop()}});