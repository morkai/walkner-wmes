// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","moment","app/time"],function(t,e,a){"use strict";function m(t,m,i){var r;if(t.hasClass("form-group-datetime")){var o=t.find("input[type=date]"),f=t.find("input[type=time]"),s=o.val().trim(),n=f.val().trim();0===n.length&&(n=m),2===n.split(":").length&&(n+=":00"),r=(i?e.utc:a.getMoment)(s+" "+n,"YYYY-MM-DD HH:mm:ss")}else{var l=t.val().trim();if(/^[0-9]{4}.[0-9]{1,2}/.test(l)&&!/^[0-9]{4}.[0-9]{1,2}.[0-9]{1,2}/.test(l)){var u=l.split(" ");u[0]=u[0]+"-01",l=u.join(" ")}/ [0-9]+:[0-9]+(:[0-9]+)?/.test(l)||(l+=" "+(m||"00:00:00")),2===l.split(":").length&&(l+=":00"),r=(i?e.utc:a.getMoment)(l,"YYYY-MM-DD HH:mm:ss")}var Y=r.isValid();if(t.hasClass("form-group-datetime"))t.find("input[type=date]").val(Y?r.format("YYYY-MM-DD"):""),t.find("input[type=time]").val(Y?r.format("HH:mm"):"");else if(Y){var d="";switch(t.attr("type")){case"datetime-local":case"datetime":d=r.toISOString();break;case"date":d=r.format("YYYY-MM-DD");break;case"time":d=r.format("HH:mm");break;case"month":d=r.format("YYYY-MM");break;default:d=r.format("YYYY-MM-DD HH:mm")}t.val(d)}else t.val("");return r}var i=document.createElement("input");i.setAttribute("type","datetime-local"),i="text"!==i.type;var r={};return r.fromView=function(e,a){a=t.defaults(a||{},{fromId:"from",toId:"to",defaultTime:"00:00",utc:!1});var i={from:null,to:null},r=m(e.$id(a.fromId),a.defaultTime,a.utc),o=m(e.$id(a.toId),a.defaultTime,a.utc);return r.isValid()&&(i.from=r.valueOf()),o.isValid()&&(i.to=o.valueOf()),i},r.toFormData=function(m,r,o,f){if("select"!==r.name&&"sort"!==r.name){f=t.defaults(f||{},{utc:!1});var s="ge"===r.name?"from":"to",n=(f.utc?e.utc:a.getMoment)(r.args[1]);"date+time"===o?(m[s+"-date"]=n.format("YYYY-MM-DD"),m[s+"-time"]=n.format("HH:mm")):"datetime"===o?m[s]=i?n.toISOString():n.format("YYYY-MM-DD HH:mm:ss"):"time"===o?m[s]=n.format("HH:mm:ss"):m[s]=n.format("YYYY-MM-DD")}},r});