// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","moment","app/time"],function(t,e,a){function m(t,m,i){var r;if(t.hasClass("form-group-datetime")){var o=t.find("input[type=date]"),f=t.find("input[type=time]"),n=o.val().trim(),u=f.val().trim();0===u.length&&(u=m),r=(i?e.utc:a.getMoment)(n+" "+u,"YYYY-MM-DD HH:mm:ss")}else r=(i?e.utc:a.getMoment)(t.val(),"YYYY-MM-DD HH:mm:ss");var l=r.isValid();if(t.hasClass("form-group-datetime"))t.find("input[type=date]").val(l?r.format("YYYY-MM-DD"):""),t.find("input[type=time]").val(l?r.format("HH:mm"):"");else if(l){var d="";switch(t.attr("type")){case"datetime-local":case"datetime":d=r.toISOString();break;case"date":d=r.format("YYYY-MM-DD");break;case"time":d=r.format("HH:mm");break;default:d=r.format("YYYY-MM-DD HH:mm")}t.val(d)}else t.val("");return r}var i=document.createElement("input");i.setAttribute("type","datetime-local"),i="text"!==i.type;var r={};return r.fromView=function(e,a){a=t.defaults(a||{},{fromId:"from",toId:"to",defaultTime:"00:00",utc:!1});var i={from:null,to:null},r=m(e.$id(a.fromId),a.defaultTime,a.utc),o=m(e.$id(a.toId),a.defaultTime,a.utc);return r.isValid()&&(i.from=r.valueOf()),o.isValid()&&(i.to=o.valueOf()),i},r.toFormData=function(m,r,o,f){if("select"!==r.name&&"sort"!==r.name){f=t.defaults(f||{},{utc:!1});var n="ge"===r.name?"from":"to",u=(f.utc?e.utc:a.getMoment)(r.args[1]);"date+time"===o?(m[n+"-date"]=u.format("YYYY-MM-DD"),m[n+"-time"]=u.format("HH:mm")):m[n]="datetime"===o?i?u.toISOString():u.format("YYYY-MM-DD HH:mm:ss"):u.format("time"===o?"HH:mm:ss":"YYYY-MM-DD")}},r});