define(["require","underscore","jquery","./View","./util","./views/MessagesView","app/core/templates/dialogContainer"],function(t,i,e,o,r,n,s){"use strict";var a=function(t){return new t};function l(t){o.call(this,t),this.msg=t.messagesView?t.messagesView:new n({el:this.el}),this.document=t.document||window.document,this.layouts={},this.currentLayout=null,this.currentLayoutName=null,this.defaultLayoutName=null,this.currentPage=null,this.$dialog=null,this.dialogQueue=[],this.currentDialog=null,this.pageCounter=0,this.closeDialog=this.closeDialog.bind(this),this.$el.on("click",".viewport-dialog .cancel",this.closeDialog)}return r.inherits(l,o),l.prototype.cleanup=function(){this.broker.destroy(),this.msg.remove(),this.$dialog.remove(),this.currentPage&&this.currentPage.remove(),this.currentLayout&&this.currentLayout.remove(),this.currentDialog&&this.currentDialog.remove(),i.invoke(this.dialogQueue.filter(i.isObject),"remove"),this.$el.off("click",".viewport-dialog .cancel",this.closeDialog),this.broker=null,this.msg=null,this.$dialog=null,this.currentLayout=null,this.currentDialog=null,this.dialogQueue=null,this.layouts=null},l.prototype.afterRender=function(){if(null!==this.$dialog)return this.closeDialog();this.$dialog=e(s()).appendTo(this.el).modal({show:!1,backdrop:!0}),this.$dialog.on("show.bs.modal",this.onDialogShowing.bind(this)),this.$dialog.on("shown.bs.modal",this.onDialogShown.bind(this)),this.$dialog.on("hide.bs.modal",this.onDialogHiding.bind(this)),this.$dialog.on("hidden.bs.modal",this.onDialogHidden.bind(this))},l.prototype.setDefaultLayout=function(t){return this.defaultLayoutName=t,this},l.prototype.registerLayout=function(t,i){return this.defaultLayoutName||(this.defaultLayoutName=t),this.layouts[t]=i,this},l.prototype.loadPage=function(e,o){this.msg.loading(),i.isFunction(o)||(o=a);var r=this,n=++this.pageCounter;t(i.flatten([].concat(e),!0),function(){n===r.pageCounter&&r.showPage(o.apply(null,arguments)),r.msg.loaded()},function(t){n===r.pageCounter&&(r.msg.loadingFailed(),r.broker.publish("viewport.page.loadingFailed",{page:null,xhr:{status:0,responseText:t.stack||t.message}}))})},l.prototype.showPage=function(o){var r=this,n=r.defaultLayoutName;if("string"==typeof o.layoutName?n=o.layoutName:"function"==typeof o.layoutName&&(n=o.layoutName(r)),!i.isObject(r.layouts[n]))throw new Error("Unknown layout: "+n);++r.pageCounter,r.broker.publish("viewport.page.loading",{page:o});var s=[],a=[],l=[],u=[];function h(){i.isFunction(o.load)?o.load(g).then(d,c):g().then(d,c)}function g(){for(var t=[],i=[],r=[],n=0;n<arguments.length;++n)t=t.concat(arguments[n]);return t.forEach(function(t){t&&("string"==typeof t?r.push(t):t.priority&&t.promise&&t.promise.then?i.push(o.promised(t.promise)):t.priority&&t.then?i.push(o.promised(t)):t.then&&l.push(o.promised(t)))}),r.length&&i.push(p(r)),i.length?e.when.apply(e,i).then(function(){return e.when.apply(e,l)}):e.when.apply(e,l)}function d(){r.broker.publish("viewport.page.loaded",{page:o}),o.trigger("afterLoad",o),null!==r.currentPage&&r.currentPage.remove(),r.currentPage=o;var t=r.setLayout(n);i.isFunction(t.setUpPage)&&t.setUpPage(o),i.isFunction(o.setUpLayout)&&o.setUpLayout(t),i.isObject(o.view)&&o.setView(o.view),t.setView(t.pageContainerSelector,o),r.isRendered()?t.isRendered()?o.render():t.render():r.render(),r.broker.publish("viewport.page.shown",o)}function c(t){o.remove(),r.broker.publish("viewport.page.loadingFailed",{page:o,xhr:t})}function p(i){var o=e.Deferred();return t(i,function(){o.resolve()},function(t){o.reject(t)}),o.promise()}o.trigger("beforeLoad",o,s),s.forEach(function(t){t&&("string"==typeof t?u.push(t):t.priority&&t.promise&&t.promise.then?a.push(o.promised(t.promise)):t.priority&&t.then?a.push(o.promised(t)):t.then&&l.push(o.promised(t)))}),u.length&&a.unshift(p(u)),a.length?g.apply(null,a).then(h,c):h()},l.prototype.showDialog=function(t,e){if(null!==this.currentDialog)return this.dialogQueue.push(t,e),this;var o=!0,r=t.afterRender,n=this;t.afterRender=function(){var e=n.$dialog.find(".modal-body");e.children()[0]!==t.el&&e.empty().append(t.el),o&&(o=!1,n.$dialog.modal("show")),i.isFunction(r)&&r.apply(t,arguments)},this.currentDialog=t;var s=this.$dialog.find(".modal-header");e?(s.find(".modal-title").html(e),s.show()):s.hide(),t.dialogClassName&&this.$dialog.addClass(i.result(t,"dialogClassName"));var a=i.result(t,"dialogBackdrop");return this.$dialog.data("bs.modal").options.backdrop=null==a||a,t.render(),this},l.prototype.closeDialog=function(t){return null===this.currentDialog?this:(this.$dialog.modal("hide"),t&&t.preventDefault&&t.preventDefault(),this)},l.prototype.closeDialogs=function(t,i){this.dialogQueue=this.dialogQueue.filter(i||t),"function"==typeof t&&this.currentDialog&&t(this.currentDialog)&&this.closeDialog()},l.prototype.closeAllDialogs=function(){this.dialogQueue=[],this.closeDialog()},l.prototype.adjustDialogBackdrop=function(){this.currentDialog&&this.$dialog.modal("adjustBackdrop")},l.prototype.setLayout=function(t){if(t===this.currentLayoutName)return i.isFunction(this.currentLayout.reset)&&this.currentLayout.reset(),this.currentLayout;var e=this.layouts[t],o=this.options.selector||"";return i.isObject(this.currentLayout)&&this.removeView(o),this.currentLayoutName=t,this.currentLayout=e(),this.setView(o,this.currentLayout),this.trigger("layout:change",this.currentLayoutName,this.currentLayout),this.currentLayout},l.prototype.onDialogShowing=function(){this.currentDialog&&(i.isFunction(this.currentDialog.onDialogShowing)&&this.currentDialog.onDialogShowing(this),this.broker.publish("viewport.dialog.showing",this.currentDialog),this.currentDialog.trigger("dialog:showing"))},l.prototype.onDialogShown=function(){this.currentDialog&&(this.currentDialog.$("[autofocus]").focus(),i.isFunction(this.currentDialog.onDialogShown)&&this.currentDialog.onDialogShown(this),this.broker.publish("viewport.dialog.shown",this.currentDialog),this.currentDialog.trigger("dialog:shown"))},l.prototype.onDialogHiding=function(){var t=this.currentDialog;t&&i.isFunction(t.remove)&&(t.trigger("dialog:hiding"),this.broker.publish("viewport.dialog.hiding",t))},l.prototype.onDialogHidden=function(){var t=this.currentDialog;t&&(this.currentDialog=null,t.dialogClassName&&this.$dialog.removeClass(i.result(t,"dialogClassName")),i.isFunction(t.remove)&&(t.trigger("dialog:hidden"),t.remove(),this.broker.publish("viewport.dialog.hidden",t)),this.dialogQueue.length&&this.showDialog(this.dialogQueue.shift(),this.dialogQueue.shift()))},l});