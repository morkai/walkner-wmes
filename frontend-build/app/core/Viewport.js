define(["require","underscore","jquery","./View","./util","./views/MessagesView","app/core/templates/dialogContainer"],function(t,e,i,o,a,r,s){"use strict";var n=function(t){return new t};function l(t){o.call(this,t),this.msg=t.messagesView?t.messagesView:new r({el:this.el}),this.document=t.document||window.document,this.layouts={},this.currentLayout=null,this.currentLayoutName=null,this.defaultLayoutName=null,this.currentPage=null,this.$dialog=null,this.dialogQueue=[],this.currentDialog=null,this.pageCounter=0,this.closeDialog=this.closeDialog.bind(this),this.$el.on("click",".viewport-dialog .cancel",this.closeDialog)}return a.inherits(l,o),l.prototype.cleanup=function(){this.broker.destroy(),this.msg.remove(),this.$dialog.remove(),this.currentPage&&this.currentPage.remove(),this.currentLayout&&this.currentLayout.remove(),this.currentDialog&&this.currentDialog.remove(),e.invoke(this.dialogQueue.filter(e.isObject),"remove"),this.$el.off("click",".viewport-dialog .cancel",this.closeDialog),this.broker=null,this.msg=null,this.$dialog=null,this.currentLayout=null,this.currentDialog=null,this.dialogQueue=null,this.layouts=null},l.prototype.afterRender=function(){if(null!==this.$dialog)return this.closeDialog();this.$dialog=i(s()).appendTo(this.el).modal({show:!1,backdrop:!0}),this.$dialog.on("shown.bs.modal",this.onDialogShown.bind(this)),this.$dialog.on("hidden.bs.modal",this.onDialogHidden.bind(this))},l.prototype.setDefaultLayout=function(t){return this.defaultLayoutName=t,this},l.prototype.registerLayout=function(t,e){return this.defaultLayoutName||(this.defaultLayoutName=t),this.layouts[t]=e,this},l.prototype.loadPage=function(i,o){this.msg.loading(),e.isFunction(o)||(o=n);var a=this,r=++this.pageCounter;t(e.flatten([].concat(i),!0),function(){r===a.pageCounter&&a.showPage(o.apply(null,arguments)),a.msg.loaded()},function(t){r===a.pageCounter&&(a.msg.loadingFailed(),a.broker.publish("viewport.page.loadingFailed",{page:null,xhr:{status:0,responseText:t.stack||t.message}}))})},l.prototype.showPage=function(t){var o=this,a=o.defaultLayoutName;if("string"==typeof t.layoutName?a=t.layoutName:"function"==typeof t.layoutName&&(a=t.layoutName(o)),!e.isObject(o.layouts[a]))throw new Error("Unknown layout: "+a);function r(){for(var o=[],a=0;a<arguments.length;++a){var r=arguments[a];Array.isArray(r)?o.push.apply(o,r):o.push(r)}return t.trigger("beforeLoad",t,o),i.when.apply(i,e.map(o,t.promised,t))}function s(){o.broker.publish("viewport.page.loaded",{page:t}),t.trigger("afterLoad",t),null!==o.currentPage&&o.currentPage.remove(),o.currentPage=t;var i=o.setLayout(a);e.isFunction(i.setUpPage)&&i.setUpPage(t),e.isFunction(t.setUpLayout)&&t.setUpLayout(i),e.isObject(t.view)&&t.setView(t.view),i.setView(i.pageContainerSelector,t),o.isRendered()?i.isRendered()?t.render():i.render():o.render(),o.broker.publish("viewport.page.shown",t)}function n(e){t.remove(),o.broker.publish("viewport.page.loadingFailed",{page:t,xhr:e})}++o.pageCounter,o.broker.publish("viewport.page.loading",{page:t}),e.isFunction(t.load)?t.load(r).then(s,n):r().then(s,n)},l.prototype.showDialog=function(t,i){if(null!==this.currentDialog)return this.dialogQueue.push(t,i),this;var o=!0,a=t.afterRender,r=this;t.afterRender=function(){var i=r.$dialog.find(".modal-body");i.children()[0]!==t.el&&i.empty().append(t.el),o&&(o=!1,r.$dialog.modal("show")),e.isFunction(a)&&a.apply(t,arguments)},this.currentDialog=t;var s=this.$dialog.find(".modal-header");i?(s.find(".modal-title").html(i),s.show()):s.hide(),t.dialogClassName&&this.$dialog.addClass(e.result(t,"dialogClassName"));var n=e.result(t,"dialogBackdrop");return this.$dialog.data("bs.modal").options.backdrop=null==n||n,t.render(),this},l.prototype.closeDialog=function(t){return null===this.currentDialog?this:(this.$dialog.modal("hide"),t&&t.preventDefault&&t.preventDefault(),this)},l.prototype.closeDialogs=function(t,e){this.dialogQueue=this.dialogQueue.filter(e||t),"function"==typeof t&&this.currentDialog&&t(this.currentDialog)&&this.closeDialog()},l.prototype.closeAllDialogs=function(){this.dialogQueue=[],this.closeDialog()},l.prototype.setLayout=function(t){if(t===this.currentLayoutName)return e.isFunction(this.currentLayout.reset)&&this.currentLayout.reset(),this.currentLayout;var i=this.layouts[t],o=this.options.selector||"";return e.isObject(this.currentLayout)&&this.removeView(o),this.currentLayoutName=t,this.currentLayout=i(),this.setView(o,this.currentLayout),this.trigger("layout:change",this.currentLayoutName,this.currentLayout),this.currentLayout},l.prototype.onDialogShown=function(){this.currentDialog&&(this.currentDialog.$("[autofocus]").focus(),e.isFunction(this.currentDialog.onDialogShown)&&this.currentDialog.onDialogShown(this),this.broker.publish("viewport.dialog.shown",this.currentDialog),this.currentDialog.trigger("dialog:shown"))},l.prototype.onDialogHidden=function(){var t=this.currentDialog;t&&(this.currentDialog=null,t.dialogClassName&&this.$dialog.removeClass(e.result(t,"dialogClassName")),e.isFunction(t.remove)&&(t.trigger("dialog:hidden"),t.remove(),this.broker.publish("viewport.dialog.hidden",t)),this.dialogQueue.length&&this.showDialog(this.dialogQueue.shift(),this.dialogQueue.shift()))},l});