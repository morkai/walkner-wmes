define(["require","underscore","jquery","./View","./util","./views/MessagesView","app/core/templates/dialogContainer"],function(e,t,n,i,r,a,o){function s(e){i.call(this,e),this.msg=e.messagesView?e.messagesView:new a({el:this.el}),this.document=e.document||window.document,this.layouts={},this.currentLayout=null,this.currentLayoutName=null,this.currentPage=null,this.$dialog=null,this.dialogQueue=[],this.currentDialog=null,this.closeDialog=this.closeDialog.bind(this),this.$el.on("click",".viewport-dialog .cancel",this.closeDialog)}var l=function(e){return new e};return r.inherits(s,i),s.prototype.cleanup=function(){this.broker.destroy(),this.msg.remove(),this.$dialog.remove(),this.currentPage&&this.currentPage.remove(),this.currentLayout&&this.currentLayout.remove(),this.currentDialog&&this.currentDialog.remove(),t.invoke(this.dialogQueue.filter(t.isObject),"remove"),this.$el.off("click",".viewport-dialog .cancel",this.closeDialog),this.broker=null,this.msg=null,this.$dialog=null,this.currentLayout=null,this.currentDialog=null,this.dialogQueue=null,this.layouts=null},s.prototype.afterRender=function(){return null!==this.$dialog?this.closeDialog():(this.$dialog=n(o()).appendTo(this.el).modal({show:!1,backdrop:!0}),this.$dialog.on("shown.bs.modal",this.onDialogShown.bind(this)),this.$dialog.on("hidden.bs.modal",this.onDialogHidden.bind(this)),void 0)},s.prototype.registerLayout=function(e,t){return this.layouts[e]=t,this},s.prototype.loadPage=function(n,i){this.msg.loading(),t.isFunction(i)||(i=l);var r=this;e([].concat(n),function(){r.showPage(i.apply(null,arguments)),r.msg.loaded()})},s.prototype.showPage=function(e){function i(){return n.when.apply(n,t.map(arguments,e.promised,e))}function r(){null!==s.currentPage&&s.currentPage.remove(),s.currentPage=e;var n=s.setLayout(o);t.isFunction(n.setUpPage)&&n.setUpPage(e),t.isFunction(e.setUpLayout)&&e.setUpLayout(n),t.isObject(e.view)&&e.setView(e.view),n.setView(n.pageContainerSelector,e),s.isRendered()?n.isRendered()?e.render():n.render():s.render()}function a(){console.log("onPageLoadFailure"),e.remove()}var o=t.result(e,"layoutName");if(!t.isObject(this.layouts[o]))throw new Error("Unknown layout: `"+o+"`");var s=this;t.isFunction(e.load)?e.load(i).then(r,a):r()},s.prototype.showDialog=function(e,n){if(null!==this.currentDialog)return this.dialogQueue.push(e,n),this;e.render(),this.currentDialog=e;var i=this.$dialog.find(".modal-header");return n?(i.find(".modal-title").text(n),i.show()):i.hide(),e.dialogClassName&&this.$dialog.addClass(t.result(e,"dialogClassName")),this.$dialog.find(".modal-body").empty().append(e.el),this.$dialog.modal("show"),this},s.prototype.closeDialog=function(e){return null===this.currentDialog?this:(this.$dialog.modal("hide"),e&&e.preventDefault(),this)},s.prototype.closeAllDialogs=function(){this.dialogQueue=[],this.closeDialog()},s.prototype.setLayout=function(e){if(e===this.currentLayoutName)return t.isFunction(this.currentLayout.reset)&&this.currentLayout.reset(),this.currentLayout;var n=this.layouts[e],i=this.options.selector||"";return t.isObject(this.currentLayout)&&this.removeView(i),this.currentLayoutName=e,this.currentLayout=n(),this.setView(i,this.currentLayout),this.currentLayout},s.prototype.onDialogShown=function(){this.currentDialog.$("[autofocus]").focus(),t.isFunction(this.currentDialog.onDialogShown)&&this.currentDialog.onDialogShown(this),this.broker.publish("viewport.dialog.shown",this.currentDialog)},s.prototype.onDialogHidden=function(){this.currentDialog.dialogClassName&&this.$dialog.removeClass(t.result(this.currentDialog,"dialogClassName")),t.isFunction(this.currentDialog.remove)&&(this.currentDialog.remove(),this.broker.publish("viewport.dialog.hidden")),this.currentDialog=null,this.dialogQueue.length&&this.showDialog(this.dialogQueue.shift(),this.dialogQueue.shift())},s});