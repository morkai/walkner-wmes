define(["underscore","app/i18n","app/viewport","../View","app/core/templates/error","app/data/localStorage"],function(e,i,r,t,n,o){"use strict";return t.extend({pageId:"error",events:{"change #-comment":function(){var e=this.$id("comment"),i=e.val().trim();i.replace(/[^a-zA-Z]+/g,"").length<3&&(i=""),e.val(i)},"submit form":function(){var e=this,i=e.buildMail();return e.$id("comment").prop("disabled",!0),e.$id("notify").prop("disabled",!0).find(".fa").removeClass("fa-envelope").addClass("fa-spinner fa-spin"),e.trySendMail("/mail;send",i,function(r){r?e.trySendMail(e.senderUrl,i,e.handleMailSent.bind(e)):e.handleMailSent()}),!1},"click a[data-reload]":function(){return window.location.reload(),!1}},breadcrumbs:function(){return[i.bound("core","ERROR:"+this.resolveCode()+":title")]},initialize:function(){var e=this,r=e.resolveCode();try{e.adminEmail=atob(window.ADMIN_EMAIL),e.senderUrl=atob(window.REMOTE_MAIL_SENDER_URL),e.secretKey=atob(window.REMOTE_MAIL_SECRET_KEY),e.notify=0!==r}catch(i){e.notify=!1}e.view=new t({template:function(){var t=require("app/user");return 403!==r||t.isLoggedIn()||(r+=":guest"),e.renderPartialHtml(n,{message:i("core","ERROR:"+r+":message"),notify:e.notify})},afterRender:function(){403===r&&e.checkUser()}})},resolveCode:function(){var e=this.model.code;return i.has("core","ERROR:"+e+":title")?e:e>=400&&e<500?400:e>=500?500:0},trySendMail:function(e,r,t){var n=require("app/user");this.ajax({method:"POST",url:e,data:JSON.stringify({secretKey:this.secretKey,to:this.adminEmail,subject:i("core","ERROR:notify:subject",{APP_NAME:i("core","APP_NAME"),code:this.model.code,user:n.getLabel()}),html:r}),success:function(){t()},error:function(){t(!0)}})},handleMailSent:function(e){e?(r.msg.show({type:"error",time:2500,text:i("core","ERROR:notify:failure")}),this.$id("comment").prop("disabled",!0),this.$id("notify").prop("disabled",!1).find(".fa").removeClass("fa-spinner fa-spin").addClass("fa-envelope")):this.$("form").html("<p>"+i("core","ERROR:notify:success")+"</p>")},buildMail:function(){var i=require("app/user"),r=[],t=function(e){return JSON.stringify(e,null,2)},n=function(e,i){r.push("<b>"+e+"=</b><br>",'<pre style="margin-top: 0; margin-bottom: 10px">'+String(i).trim()+"</pre>")};return n("comment",this.$id("comment").val().trim()),n("date",(new Date).toLocaleString()),n("user",'<a href="'+window.location.origin+"/#users/"+i.data._id+'">'+i.getLabel()+"</a><br>"+t(e.assign({cname:window.COMPUTERNAME},e.omit(i.data,"privilegesMap")))),n("router.currentRequest",this.model.req?this.model.req.url:"?"),n("router.referrer",this.model.previousUrl||"?"),n("router.recent",t(JSON.parse(o.getItem("WMES_RECENT_LOCATIONS")||"[]"))),n("response.code",this.model.code),n("response.body",this.model.xhr?this.model.xhr.responseText:""),n("window.location.href",window.location.href),n("window.navigator",t(e.pick(window.navigator,["language","languages","cookieEnabled","onLine","platform","userAgent"]))),n("window.screen",t(e.assign(e.pick(window.screen,["availHeight","availWidth","width","height"])),(window.innerWidth,window.innerHeight))),r.join("")},checkUser:function(){var e=require("app/user");this.ajax({url:"/users/self"}).done(function(i){i._id!==e.data._id&&window.location.reload()})}})});