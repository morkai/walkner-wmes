define(["underscore","app/i18n","../View","app/core/templates/error"],function(e,i,r,n){"use strict";return r.extend({pageId:"error",events:{"click #-notify > a":function(){var e=this,i=e.buildMail();return e.$id("notify").html('<i class="fa fa-spinner fa-spin"></i>'),e.trySendMail("/mail;send",i,function(r){r?e.trySendMail(e.senderUrl,i,e.handleMailSent.bind(e)):e.handleMailSent()}),!1},"click a[data-reload]":function(){return window.location.reload(),!1}},breadcrumbs:function(){return[i.bound("core","ERROR:"+this.resolveCode()+":title")]},initialize:function(){var e=this,t=e.resolveCode();try{e.adminEmail=atob(window.ADMIN_EMAIL),e.senderUrl=atob(window.REMOTE_MAIL_SENDER_URL),e.secretKey=atob(window.REMOTE_MAIL_SECRET_KEY),e.notify=0!==t}catch(i){e.notify=!1}e.view=new r({template:function(){var r=require("app/user");return 403!==t||r.isLoggedIn()||(t+=":guest"),n({idPrefix:e.idPrefix,message:i("core","ERROR:"+t+":message"),notify:e.notify})},afterRender:function(){403===t&&e.checkUser()}})},resolveCode:function(){var e=this.model.code;return i.has("core","ERROR:"+e+":title")?e:e>=400&&e<500?400:e>=500?500:0},trySendMail:function(e,r,n){var t=require("app/user");this.ajax({method:"POST",url:e,data:JSON.stringify({secretKey:this.secretKey,to:this.adminEmail,subject:i("core","ERROR:notify:subject",{APP_NAME:i("core","APP_NAME"),code:this.model.code,user:t.getLabel()}),html:r}),success:function(){n()},error:function(){n(!0)}})},handleMailSent:function(e){this.$id("notify").html(i("core","ERROR:notify:"+(e?"failure":"success")))},buildMail:function(){var i=require("app/user"),r=[],n=function(e){return JSON.stringify(e,null,2)},t=function(e,i){r.push("<b>"+e+"=</b><br>",'<pre style="margin-top: 0; margin-bottom: 10px">'+String(i).trim()+"</pre>")};return t("date",(new Date).toLocaleString()),t("user",'<a href="'+window.location.origin+"/#users/"+i.data._id+'">'+i.getLabel()+"</a><br>"+n(e.assign({cname:window.COMPUTERNAME},e.omit(i.data,"privilegesMap")))),t("router.currentRequest",this.model.req?this.model.req.url:"?"),t("router.referrer",this.model.previousUrl||"?"),t("router.recent",n(JSON.parse(localStorage.WMES_RECENT_LOCATIONS||"[]"))),t("response.code",this.model.code),t("response.body",this.model.xhr?this.model.xhr.responseText:""),t("window.location.href",window.location.href),t("window.navigator",n(e.pick(window.navigator,["language","languages","cookieEnabled","onLine","platform","userAgent"]))),t("window.screen",n(e.assign(e.pick(window.screen,["availHeight","availWidth","width","height"])),(window.innerWidth,window.innerHeight))),r.join("")},checkUser:function(){var e=require("app/user");this.ajax({url:"/users/self"}).done(function(i){i._id!==e.data._id&&window.location.reload()})}})});