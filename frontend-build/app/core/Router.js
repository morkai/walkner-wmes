define(["underscore","./util","./Request"],function(t,e,r){"use strict";var i=/([:*])([\w\-]+)?/g,n=/[\-\[\]{}()+?.,\\\^$|#\s]/g;function u(t){this.broker=t,this.routes=[],this.dispatching=!1,this.dispatchQueue=[],this.currentRequest=null,this.previousUrl=null}function s(r,i){return function(n){var u=r.exec(n.path);if(null===u)return!1;var s=u.length;if(1===s)return!0;var h,o=t.isArray(i)?i.length:0;if(s===o+1)for(h=0;h<o;++h)n.params[i[h]]=e.decodeUriComponent(u[h+1]);else for(h=0;h<s;++h)n.params[h]=e.decodeUriComponent(u[h]);return!0}}return u.prototype.getCurrentRequest=function(){return this.currentRequest},u.prototype.setCurrentRequest=function(t){this.currentRequest=new r(t)},u.prototype.map=function(t){var e=Array.prototype.slice.call(arguments);e.shift(),this.routes.unshift(this.createMatcher(t),e)},u.prototype.navigate=function(e,r){this.broker.publish("router.navigate",t.assign({url:e},r))},u.prototype.replace=function(t){this.broker.publish("router.navigate",{url:t,trigger:!0,replace:!0})},u.prototype.update=function(t){this.broker.publish("router.navigate",{url:t,trigger:!1,replace:!0})},u.prototype.dispatch=function(e){if(!t.isUndefined(e))if(null===e&&(e="/"),this.dispatching)this.dispatchQueue.push(e);else{this.dispatching=!0;var i=new r(e);this.broker.publish("router.dispatching",i);var n=this.match(i);if(null===n){this.dispatching=!1;var u=this.dispatchQueue.shift();t.isUndefined(u)?this.broker.publish("router.404",{req:i}):this.dispatch(u)}else this.broker.publish("router.matched",{handlers:n,req:i}),t.defer(this.execute.bind(this,n,i))}},u.prototype.match=function(t){for(var e=this.routes,r=0,i=e.length;r<i;r+=2){if((0,e[r])(t))return e[r+1]}return null},u.prototype.execute=function(t,e){this.currentRequest=e,this.broker.publish("router.executing",{handlers:t,req:e});var r=this.previousUrl;!function i(n){n+1<t.length?t[n](e,r,i.bind(null,n+1)):t[n](e,r)}(0),this.previousUrl=e.url,this.dispatching=!1,this.dispatch(this.dispatchQueue.shift())},u.prototype.createMatcher=function(e){if(e instanceof RegExp)return s(e);if(""===(e=e.trim())||"/"===e)return function(t){return""===t.path||"/"===t.path};var r=[],u=!1,h=e.replace(n,"\\$&");return h=h.replace(i,function(e,i,n){return u=!0,t.isUndefined(n)?"*"===i?".*":e:(r.push(n),"*"===i?"(.*?)":"([^/#?;]*)")}),u?s(new RegExp("^"+h+"$"),r):function(t){return t.path===e}},u});