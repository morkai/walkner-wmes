define(["underscore","./util","./Request"],function(e,t,i){function n(e){this.broker=e,this.routes=[],this.dispatching=!1,this.dispatchQueue=[],this.currentRequest=null,this.previousUrl=null}function r(i,n){return function(r){var o=i.exec(r.path);if(null===o)return!1;var a=o.length;if(1===a)return!0;var s,l=e.isArray(n)?n.length:0;if(a===l+1)for(s=0;l>s;++s)r.params[n[s]]=t.decodeUriComponent(o[s+1]);else for(s=0;a>s;++s)r.params[s]=t.decodeUriComponent(o[s]);return!0}}var o=/([:*])([\w\-]+)?/g,a=/[\-\[\]{}()+?.,\\\^$|#\s]/g;return n.prototype.getCurrentRequest=function(){return this.currentRequest},n.prototype.map=function(e){var t=Array.prototype.slice.call(arguments);t.shift(),this.routes.unshift(this.createMatcher(e),t)},n.prototype.navigate=function(t,i){this.broker.publish("router.navigate",e.extend({url:t},i))},n.prototype.replace=function(e){this.broker.publish("router.navigate",{url:e,trigger:!0,replace:!0})},n.prototype.update=function(e){this.broker.publish("router.navigate",{url:e,trigger:!1,replace:!0})},n.prototype.dispatch=function(t){if(!e.isUndefined(t)){if(null===t&&(t="/"),this.dispatching)return this.dispatchQueue.push(t),void 0;this.dispatching=!0;var n=new i(t);this.broker.publish("router.dispatching",n);var r=this.match(n);if(null===r){this.dispatching=!1;var o=this.dispatchQueue.shift();e.isUndefined(o)?this.broker.publish("router.404",n):this.dispatch(o)}else this.broker.publish("router.matched",{handlers:r,req:n}),e.defer(this.execute.bind(this,r,n))}},n.prototype.match=function(e){for(var t=this.routes,i=0,n=t.length;n>i;i+=2){var r=t[i];if(r(e))return t[i+1]}return null},n.prototype.execute=function(e,t){function i(r){r+1<e.length?e[r](t,n,i.bind(null,r+1)):e[r](t,n)}this.currentRequest=t,this.broker.publish("router.executing",{handlers:e,req:t});var n=this.previousUrl;i(0),this.previousUrl=t.url,this.dispatching=!1,this.dispatch(this.dispatchQueue.shift())},n.prototype.createMatcher=function(t){if(t instanceof RegExp)return r(t);if(t=t.trim(),""===t||"/"===t)return function(e){return""===e.path||"/"===e.path};var i=[],n=!1,s=t.replace(a,"\\$&");return s=s.replace(o,function(t,r,o){return n=!0,e.isUndefined(o)?"*"===r?".*":t:(i.push(o),"*"===r?"(.*?)":"([^/#?;]*)")}),n?r(new RegExp("^"+s+"$"),i):function(e){return e.path===t}},n});