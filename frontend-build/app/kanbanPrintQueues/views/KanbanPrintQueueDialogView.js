// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/core/View","app/kanbanPrintQueues/templates/dialog"],function(e,t,n,i){"use strict";return n.extend({dialogClassName:"kanbanPrintQueues-dialog",initialize:function(){this.current=null,this.remaining=[].concat(this.model.jobs),this.listenTo(this.model.queue,"change:jobs",this.onJobsChange)},destroy:function(){this.current=null},afterRender:function(){this.current?this.updateJob():this.printNext()},onJobsChange:function(e){-1!==e.indexOf(this.current)&&this.updateJob()},updateJob:function(){this.$el.closest(".kanbanPrintQueues-dialog")[0].dataset.status=this.error?"failure":this.current.status,this.el.innerHTML=i({idPrefix:this.idPrefix,job:this.current,jobNo:this.model.jobs.length-this.remaining.length,jobTotal:this.model.jobs.length,error:this.error})},printNext:function(){var n=this;n.current=n.remaining.shift(),n.error=null,n.updateJob();var i=e.ajax({method:"POST",url:"/kanban/printQueues;print",data:JSON.stringify({queue:n.model.queue.id,job:n.current._id})});i.fail(function(){if(n.current){var e=i.responseJSON&&i.responseJSON.error&&i.responseJSON.error.code;i.status||(e="CONNECTION"),t.has("kanbanPrintQueues","msg:print:"+e)&&(n.error=t("kanbanPrintQueues","msg:print:"+e)),n.updateJob()}}),i.done(function(){n.current&&(n.remaining.length?n.timers.printNext=setTimeout(n.printNext.bind(n),1):n.timers.hide=setTimeout(n.closeDialog,3e4))})},closeDialog:function(){},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e)}})});