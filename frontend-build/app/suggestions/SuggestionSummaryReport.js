// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","../i18n","../time","../core/Model"],function(e,t,o,n){"use strict";return n.extend({urlRoot:"/suggestions/reports/summary",nlsDomain:"suggestions",defaults:function(){return{from:0,to:0,section:[],productFamily:[],confirmer:[],interval:"week"}},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.extend(t.data||{},e.pick(this.attributes,["from","to","section","productFamily","confirmer"])),t.data.section=t.data.section.join(","),t.data.productFamily=t.data.productFamily.join(","),t.data.confirmer=t.data.confirmer.join(","),n.prototype.fetch.call(this,t)},genClientUrl:function(){return"/suggestionSummaryReport?from="+this.get("from")+"&to="+this.get("to")+"&section="+this.get("section")+"&productFamily="+this.get("productFamily")+"&confirmer="+this.get("confirmer")},parse:function(t){var o={total:{averageDuration:t.averageDuration,count:t.count},averageDuration:[],count:{open:[],finished:[],cancelled:[]},suggestionOwners:{categories:[],open:[],finished:[],cancelled:[]},categories:{categories:[],open:[],finished:[],cancelled:[]}},n=o.averageDuration,i=o.count,r=o.suggestionOwners,s=o.categories;return e.forEach(t.suggestionOwners,function(e){r.categories.push(t.users[e[0]]||e[0]),r.open.push(e[2]),r.finished.push(e[3]),r.cancelled.push(e[4])}),e.forEach(t.categories,function(e){s.categories.push(t.categoryNames[e[0]]||e[0]),s.open.push(e[2]),s.finished.push(e[3]),s.cancelled.push(e[4])}),e.forEach(t.groups,function(e){"number"==typeof e?(n.push({x:e,y:0}),i.open.push({x:e,y:0}),i.finished.push({x:e,y:0}),i.cancelled.push({x:e,y:0})):(n.push({x:e.key,y:e.averageDuration,color:e.averageDuration>5?"#d9534f":"#5cb85c"}),i.open.push({x:e.key,y:e.count.open}),i.finished.push({x:e.key,y:e.count.finished}),i.cancelled.push({x:e.key,y:e.count.cancelled}))}),o}},{fromQuery:function(t){return void 0===t.from&&void 0===t.to&&(t.from=o.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+t.from||void 0,to:+t.to||void 0,section:e.isEmpty(t.section)?[]:t.section.split(","),productFamily:e.isEmpty(t.productFamily)?[]:t.productFamily.split(","),confirmer:e.isEmpty(t.confirmer)?[]:t.confirmer.split(",")})}})});