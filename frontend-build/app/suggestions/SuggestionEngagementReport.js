define(["underscore","../i18n","../time","../core/Model"],function(t,s,e,n){"use strict";return n.extend({urlRoot:"/suggestions/reports/engagement",nlsDomain:"suggestions",defaults:function(){return{from:0,to:0,status:[],interval:"month",sections:[]}},fetch:function(s){return t.isObject(s)||(s={}),s.data=t.extend(s.data||{},t.pick(this.attributes,["from","to","status","interval","sections"])),s.data.status=s.data.status.join(","),s.data.sections=s.data.sections.join(","),n.prototype.fetch.call(this,s)},genClientUrl:function(){return"/suggestionEngagementReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&status="+this.get("status")+"&sections="+this.get("sections")},parse:function(s){var e={groups:[]};return t.forEach(s.groups,function(n,o){var i={name:0,nearMisses:0,suggestions:0,behaviorObs:0,minutesForSafety:0};(n={key:+o,totals:i,users:t.map(n,function(t,e){return i.name+=1,i.nearMisses+=t.nearMisses,i.suggestions+=t.suggestions,i.behaviorObs+=t.behaviorObs,i.minutesForSafety+=t.minutesForSafety,{name:s.users[e],nearMisses:t.nearMisses,suggestions:t.suggestions,behaviorObs:t.behaviorObs,minutesForSafety:t.minutesForSafety,sections:Object.keys(t.sections).map(function(t){return s.sections[t]||t})}})}).users.sort(function(t,s){return t.name.localeCompare(s.name)}),e.groups.push(n)}),e.groups.sort(function(t,s){return t.key-s.key}),e.groups.length&&(this.attributes.groups=[]),e},serializeToCsv:function(){var s=["date;name;nearMisses;suggestions;behaviorObs;minutesForSafety;sections"];return t.forEach(this.get("groups"),function(n){var o=e.format(n.key,"YYYY-MM-DD")+";";t.forEach(n.users,function(t){s.push(o+'"'+t.name+'";'+t.nearMisses+";"+t.suggestions+";"+t.behaviorObs+";"+t.minutesForSafety+';"'+t.sections.join(",")+'"')})}),s.join("\r\n")}},{fromQuery:function(s){return void 0===s.from&&void 0===s.to&&(s.from=e.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+s.from||void 0,to:+s.to||void 0,interval:s.interval||"month",status:t.isEmpty(s.status)?[]:s.status.split(","),sections:t.isEmpty(s.sections)?[]:s.sections.split(",")})}})});