define(["underscore","jquery","app/viewport","app/core/View","app/core/views/DialogView","app/core/util/fileIcons","app/planning/util/contextMenu","./EditAttachmentView","app/suggestions/templates/attachments/panel","app/suggestions/templates/attachments/preview","app/suggestions/templates/attachments/delete"],function(e,t,i,n,s,a,h,r,o,d,l){"use strict";return n.extend({template:o,events:{"click .suggestions-attachment":function(e){const t=this.$(e.currentTarget);if(0===e.button&&!e.ctrlKey&&t.find(".suggestions-attachment-img").length)return this.showPreview(t[0].dataset.id),!1},"contextmenu .suggestions-attachment":function(e){e.preventDefault();var t=this.model.get("attachments").find(function(t){return t._id===e.currentTarget.dataset.id});if(t){var i=[{icon:"fa-external-link",label:this.t("attachments:open"),handler:this.handleOpenAttachment.bind(this,t)}];this.model.constructor.can.editAttachment(this.model,t)&&i.push({icon:"fa-edit",label:this.t("attachments:edit"),handler:this.handleEditAttachment.bind(this,t)}),this.model.constructor.can.deleteAttachment(this.model,t)&&i.push({icon:"fa-trash",label:this.t("attachments:delete"),handler:this.handleDeleteAttachment.bind(this,t)}),h.show(this,e.pageY,e.pageX,i)}}},initialize:function(){this.$preview=null,this.once("afterRender",function(){this.listenTo(this.model,"change:attachments",e.debounce(this.render,1)),this.listenTo(this.model,"seen",this.onSeen)}),t(window).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this)).on("resize."+this.idPrefix,e.debounce(this.onWidowResize.bind(this),33))},destroy:function(){t(window).off("."+this.idPrefix),this.$preview&&(this.$preview.remove(),this.$preview=null)},getTemplateData:function(){var e=this.model.get("observer");return{panelTitle:this.getPanelTitle(),attachments:this.serializeAttachments(),unseen:e.notify&&(e.changes.all||!!e.changes.attachments),hideEmpty:!!this.options.hideEmpty}},getPanelTitle:function(){return this.t("attachments:panelTitle:"+(this.options.kind||"default"))},serializeAttachments:function(){var e=this;return e.model.get("attachments").filter(e.filterAttachment,e).map(function(t){return{_id:t._id,time:Date.parse(t.date),name:t.name,icon:a.getByMime(t.type),image:t.type.startsWith("image/"),url:e.model.getAttachmentUrl(t)}}).sort(function(e,t){return e.image&&!t.image?-1:!e.image&&t.image?1:e.time-t.time})},filterAttachment:function(e){return!this.options.kind||(e.kind||"other")===this.options.kind},afterRender:function(){this.toggleBorders()},toggleBorders:function(){var e=this.$(".suggestions-attachments");if(e.length){var t=e.parent().outerWidth()-(this.$el.hasClass("suggestions-attachments-bordered")?30:0);this.$el.toggleClass("suggestions-attachments-bordered",e.outerWidth()<t)}},handleOpenAttachment:function(e){window.open(this.model.getAttachmentUrl(e),"_blank")},handleEditAttachment:function(e){var t=new r({model:this.model,attachment:e});i.showDialog(t,this.t("attachments:edit:title"))},handleDeleteAttachment:function(e){var t=new s({template:l,nlsDomain:this.model.getNlsDomain(),model:e});i.showDialog(t,this.t("attachments:delete:title")),this.listenTo(t,"answered",function(t){"yes"===t&&this.deleteAttachment(e)})},deleteAttachment:function(e){i.msg.saving();var t=this.ajax({method:"PUT",url:this.model.url(),data:JSON.stringify({attachments:{deleted:[e._id]}})});t.fail(function(){i.msg.savingFailed()}),t.done(function(){i.msg.saved()})},showPreview:function(e){var t=this.model.get("attachments").find(function(t){return t._id===e});if(!t&&this.$preview)return this.hidePreview();this.$preview||(this.$preview=this.renderPartial(d).appendTo(document.body),this.$preview.find(".suggestions-attachment-preview-close").on("click",this.hidePreview.bind(this)),this.$preview.find(".suggestions-attachment-preview-prev").on("click",this.prevPreview.bind(this)),this.$preview.find(".suggestions-attachment-preview-next").on("click",this.nextPreview.bind(this)),this.$preview.on("wheel",()=>!1));var i=this.model.getAttachmentUrl(t),n=this.$preview.find(".suggestions-attachment-preview-img"),s=this.$preview.find(".suggestions-attachment-preview-name");n.css("background-image","url("+i+")"),s.text(t.name),this.$preview.data("attachmentId",e),this.$preview.removeClass("hidden"),s.css("margin-left",s.outerWidth()/2*-1+"px")},hidePreview:function(){this.$preview&&this.$preview.addClass("hidden")},prevPreview:function(){var e=this;if(e.$preview&&!e.$preview.hasClass("hidden")){var t=e.model.get("attachments").filter(function(t){return t.type.startsWith("image/")&&e.filterAttachment(t)});if(!t.length)return e.hidePreview();var i=e.$preview.data("attachmentId"),n=t.findIndex(function(e){return e._id===i}),s=0;0===n?s=t.length-1:-1!==n&&1!==n&&(s=n-1),e.showPreview(t[s]._id)}},nextPreview:function(){var e=this;if(e.$preview&&!e.$preview.hasClass("hidden")){var t=e.model.get("attachments").filter(function(t){return t.type.startsWith("image/")&&e.filterAttachment(t)});if(!t.length)return e.hidePreview();var i=e.$preview.data("attachmentId"),n=t.findIndex(e=>e._id===i),s=0;-1!==n&&n!==t.length-1&&(s=n+1),e.showPreview(t[s]._id)}},onWindowKeyDown:function(e){if(e.key){var t=e.key.toLowerCase();"escape"===t?this.hidePreview():"arrowleft"===t||"a"===t?this.prevPreview():"arrowright"!==t&&"d"!==t||this.nextPreview()}},onWidowResize:function(){this.toggleBorders()},onSeen:function(){this.$(".suggestions-unseen").removeClass("suggestions-unseen")}})});