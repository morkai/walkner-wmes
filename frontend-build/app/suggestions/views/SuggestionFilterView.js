// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/time","app/core/views/FilterView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","app/suggestions/templates/filter"],function(e,t,s,r,a,n){"use strict";return s.extend({template:n,events:e.extend({'change input[name="userType"]':"toggleUserSelect2","keyup select":function(e){return 27===e.keyCode?(e.target.selectedIndex=-1,!1):void 0},"dblclick select":function(e){e.target.selectedIndex=-1}},s.prototype.events),defaultFormData:function(){return{status:[].concat(a.statuses),section:null,category:null,productFamily:null,userType:"others",user:null,from:"",to:""}},termToForm:{types:function(e,t,s){s[e]=t.args[1]},categories:function(e,t,s){s.category=t.args[1]},"owners.id":function(e,t,s){s.userType="owner",s.user=t.args[1]},"observers.user.id":function(e,t,s){"mine"===t.args[1]?(s.userType="mine",s.user=null):"unseen"===t.args[1]?(s.userType="unseen",s.user=null):(s.userType="others",s.user=t.args[1])},eventDate:function(e,s,r){r["ge"===s.name?"from":"to"]=t.format(s.args[1],"YYYY-MM-DD")},status:function(e,t,s){s.status="in"===t.name?"open":t.args[1]},section:"types",area:"types",productFamily:"types"},serialize:function(){return e.extend(s.prototype.serialize.call(this),{statuses:a.statuses,sections:a.sections.toJSON(),areas:a.areas.toJSON(),categories:e.invoke(a.categories.inSuggestion(),"toJSON"),productFamilies:a.productFamilies.toJSON()})},serializeFormToQuery:function(e){var s=t.getMoment(this.$id("from").val(),"YYYY-MM-DD"),r=t.getMoment(this.$id("to").val(),"YYYY-MM-DD"),a=this.$id("category").val(),n=this.$('input[name="userType"]:checked').val(),i=this.$id("user").val(),o=this.$id("status").val();s.isValid()&&e.push({name:"ge",args:["eventDate",s.valueOf()]}),r.isValid()&&(r.valueOf()===s.valueOf()&&this.$id("to").val(r.add(1,"days").format("YYYY-MM-DD")),e.push({name:"lt",args:["eventDate",r.valueOf()]})),a&&e.push({name:"eq",args:["categories",a]}),"mine"===n||"unseen"===n?e.push({name:"eq",args:["observers.user.id",n]}):i&&e.push({name:"eq",args:["owner"===n?"owners.id":"observers.user.id",i]}),"open"===o?e.push({name:"in",args:["status",["new","accepted","todo","inProgress","paused"]]}):o&&e.push({name:"eq",args:["status",o]}),["section","area","productFamily"].forEach(function(t){var s=this.$id(t).val();s&&e.push({name:"eq",args:[t,s]})},this)},afterRender:function(){s.prototype.afterRender.call(this),r(this.$id("user"),{view:this}),this.toggleUserSelect2()},toggleUserSelect2:function(){var e=this.$('input[name="userType"]:checked').val();this.$id("user").select2("enable","others"===e||"owner"===e)}})});