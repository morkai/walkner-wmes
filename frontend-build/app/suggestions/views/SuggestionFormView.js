define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","../Suggestion","app/suggestions/templates/form"],function(t,e,i,s,a,r,o,n,l,d,c,u){"use strict";function p(t){return{id:t.id,text:t.getLabel(),description:t.get("description")}}function h(e){if(t.isEmpty(e.description))return t.escape(e.text);var i='<div class="suggestions-select2">';return i+="<h3>"+t.escape(e.text)+"</h3>",i+="<p>"+t.escape(e.description)+"</p>",i+="</div>"}function g(t,e){return e}return n.extend({template:u,events:t.assign({'keydown [role="togglePanel"]':function(t){13===t.keyCode&&(t.preventDefault(),t.stopPropagation(),t.currentTarget.click())},'click [role="togglePanel"]':function(t){var e=this.$(t.currentTarget).closest(".panel"),i=e.attr("data-type");e.hasClass("is-collapsed")?this.expandPanel(i):this.collapsePanel(i)},'change [name="status"]':function(){this.togglePanels(),this.toggleRequiredFlags()},'change [name="categories"]':function(){this.toggleProductFamily()},'change [name="productFamily"]':function(){this.updateProductFamilySubscribers()},'change [type="date"]':function(t){var i=s.getMoment(t.target.value,"YYYY-MM-DD"),r=i.isValid()?i.diff(new Date,"days"):0,o=Math.abs(r),n=this.$(t.target).closest(".form-group"),l=n.find(".help-block");if(o<=7)return t.target.setCustomValidity(""),void l.remove();!a.isAllowedTo("SUGGESTIONS:MANAGE")&&o>60&&t.target.setCustomValidity(this.t("FORM:ERROR:date",{days:60})),l.length||(l=e('<p class="help-block"></p>')),l.text(this.t("FORM:help:date:diff",{dir:r>0?"future":"past",days:o})).appendTo(n)},"click #-productFamily-other":function(){var t=this.$id("productFamily"),e=this.$id("kaizenEvent"),i="OTHER"===t.val();t.val(i?"":"OTHER"),e.val(""),this.setUpProductFamily(),i?t.select2("open"):e.focus()}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),this.productFamilyObservers={}},serialize:function(){var e={};return this.options.editMode&&this.model.get("attachments").forEach(function(t){e[t.description]=t}),t.assign(n.prototype.serialize.call(this),{today:s.format(new Date,"YYYY-MM-DD"),statuses:d.statuses,attachments:e,backTo:this.serializeBackTo()})},serializeBackTo:function(){var t="behaviorObsCards",e=JSON.parse(localStorage.getItem("BOC_LAST")||"null");if(!e){if(!(e=JSON.parse(localStorage.getItem("MFS_LAST")||"null")))return null;t="minutesForSafetyCards"}return{submitLabel:this.t("FORM:backTo:"+t+":"+(e._id?"edit":"add")),cancelLabel:this.t("FORM:backTo:"+t+":cancel"),cancelUrl:"#"+t+(e._id?"/"+e._id+";edit":";add")}},checkValidity:function(){return!0},submitRequest:function(t,e){var s=this,a=new FormData,r=0;if(this.$('input[type="file"]').each(function(){this.files.length&&(a.append(this.dataset.name,this.files[0]),++r)}),0===r)return n.prototype.submitRequest.call(s,t,e);this.$el.addClass("is-uploading");var o=this.ajax({type:"POST",url:"/suggestions;upload",data:a,processData:!1,contentType:!1});o.done(function(i){e.attachments=i,n.prototype.submitRequest.call(s,t,e)}),o.fail(function(){s.showErrorMessage(i("suggestions","FORM:ERROR:upload")),t.attr("disabled",!1)}),o.always(function(){s.$el.removeClass("is-uploading")})},handleSuccess:function(){var t=JSON.parse(localStorage.getItem("BOC_LAST")||"null"),e=JSON.parse(localStorage.getItem("MFS_LAST")||"null"),i=t?"behaviorObsCards":e?"minutesForSafetyCards":null,s=t||e;!this.options.editMode&&i?this.broker.publish("router.navigate",{url:"/"+i+(s._id?"/"+s._id+";edit":";add")+"?suggestion="+this.model.get("rid"),trigger:!0}):this.broker.publish("router.navigate",{url:this.model.genClientUrl()+"?"+(this.options.editMode?"":"&thank=you")+(this.options.standalone?"&standalone=1":""),trigger:!0})},serializeToForm:function(){var e=this.model.toJSON();return c.DATE_PROPERTIES.forEach(function(t){e[t]&&(e[t]=s.format(e[t],"YYYY-MM-DD"))}),e.categories=t.isEmpty(e.categories)?"":e.categories.join(","),e.subscribers="",e},serializeForm:function(t){var e=this.$id("confirmer").select2("data");return t.categories=t.categories.split(","),t.confirmer=e?{id:e.id,label:e.text}:null,t.suggestionOwners=this.serializeOwners("suggestion"),t.kaizenOwners=this.serializeOwners("kaizen"),t.subscribers=this.$id("subscribers").select2("data").map(function(t){return{id:t.id,label:t.text}}),c.DATE_PROPERTIES.forEach(function(e){var i=s.getMoment(t[e],"YYYY-MM-DD");t[e]=i.isValid()?i.toISOString():null}),delete t.attachments,t},serializeOwners:function(t){return this.$id(t+"Owners").select2("data").map(function(t){return{id:t.id,label:t.text}}).filter(function(t){return!!t.id})},afterRender:function(){n.prototype.afterRender.call(this),this.$id("section").select2({data:d.sections.map(o)}),this.$id("categories").select2({allowClear:!0,placeholder:" ",dropdownCssClass:"is-bigdrop",multiple:!0,data:d.categories.where({inSuggestion:!0}).map(p),formatResult:h}),r.toggle(this.$id("status")),l(this.$id("subscribers"),{multiple:!0,textFormatter:g,activeOnly:!this.options.editMode}),this.setUpProductFamily(),this.setUpConfirmerSelect2(),this.setUpOwnerSelect2(),this.toggleStatuses(),this.togglePanels(),this.$("input[autofocus]").focus()},setUpProductFamily:function(){var t=this.$id("productFamily"),e=this.$id("kaizenEvent"),i=this.$id("productFamily-other");"OTHER"===t.val()?(i.text(this.t("FORM:productFamily:list")),t.select("destroy").addClass("hidden"),e.removeClass("hidden")):(i.text(this.t("FORM:productFamily:other")),e.addClass("hidden"),t.removeClass("hidden").select2({allowClear:!0,placeholder:" ",data:d.productFamilies.map(o)})),this.toggleProductFamily()},setUpConfirmerSelect2:function(){var t=this.model.get("confirmer"),e=l(this.$id("confirmer"),{textFormatter:g,activeOnly:!this.options.editMode});t&&e.select2("data",{id:t.id,text:t.label})},setUpOwnerSelect2:function(){var t=this.options.editMode,e=!t,i=this.model,s=null;function r(e){if(!t)return s;var a=i.get(e+"Owners");return Array.isArray(a)&&a.length?a.map(function(t){return{id:t.id,text:t.label}}):[]}this.options.operator?s=this.options.operator:a.isLoggedIn()&&(s={id:a.data._id,text:a.getLabel()}),l(this.$id("suggestionOwners"),{multiple:!0,textFormatter:g,activeOnly:e}).select2("data",r("suggestion")),l(this.$id("kaizenOwners"),{multiple:!0,textFormatter:g,activeOnly:e}).select2("data",r("kaizen"))},toggleRequiredFlags:function(){this.$(".suggestions-form-typePanel").each(function(){var t=e(this),i=!t.hasClass("hidden");t.find(".is-required").each(function(){t.find("#"+this.htmlFor).prop("required",i)})})},toggleStatuses:function(){if(this.options.editMode){if(a.isAllowedTo("SUGGESTIONS:MANAGE"))return;var t=["new"],e=!this.model.isConfirmer();e&&t.push("accepted","finished"),this.model.isCreator()&&"new"===this.model.get("status")||!e||t.push("cancelled");var i=this.el;t.forEach(function(t){var e=i.querySelector('input[name="status"][value="'+t+'"]');e.parentNode.classList.toggle("disabled",!e.checked)}),this.$id("statusGroup").removeClass("hidden")}else this.$id("statusGroup").toggleClass("hidden",!a.isAllowedTo("SUGGESTIONS:MANAGE"))},togglePanels:function(){var t=r.getValue(this.$id("status"));this.$id("panel-kaizen").toggleClass("hidden","new"===t||"cancelled"===t)},toggleProductFamily:function(){var e=t.includes(this.$id("categories").val().split(","),"KON"),i=this.$id("productFamily"),s=i.closest(".form-group"),a=s.find(".control-label");i.prop("required",e),e||(i.select2("data",null),this.updateProductFamilySubscribers()),a.toggleClass("is-required",e),s.toggleClass("has-required-select2",e)},updateProductFamilySubscribers:function(){var e=this,i=d.productFamilies.get(this.$id("productFamily").val()),s=i&&i.get("owners")||[],a={},r=[];this.$id("subscribers").select2("data").forEach(function(t){e.productFamilyObservers[t.id]||(a[t.id]=!0,r.push(t))}),e.productFamilyObservers={},t.forEach(s,function(t){a[t.id]||(r.push({id:t.id,text:t.label}),e.productFamilyObservers[t.id]=!0)}),this.$id("subscribers").select2("data",r)}})});