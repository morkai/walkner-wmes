define(["underscore","app/highcharts","app/core/View","app/reports/util/formatTooltipHeader","app/reports/util/formatXAxis","../../EngagementReport"],function(t,e,i,a,s,r){"use strict";return i.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:groups",this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){const t=this.serializeChartSeries();this.chart=new e.Chart({chart:{renderTo:this.el,plotBorderWidth:1,spacing:[10,1,1,1]},exporting:{filename:this.t("engagement:export:filename"),chartOptions:{title:{text:this.t("engagement:title")},legend:{enabled:!0}},noDataLabels:t.length&&t.length*t[0].data.length>30},title:!1,noData:{},xAxis:{type:"datetime",labels:s.labels(this)},yAxis:{title:!1,min:0,allowDecimals:!1},tooltip:{shared:!0,valueDecimals:0,headerFormatter:a.bind(this)},legend:{enabled:!0},plotOptions:{column:{borderWidth:0,dataLabels:{enabled:t.length&&t.length*t[0].data.length<=70}}},series:t})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeChartSeries:function(){const t=[],e=this.model.get("groups");return r.COUNTERS.forEach(i=>{if("total"===i)return;const a={id:i,name:this.t(`engagement:series:${i}`),type:"column",data:e.map(t=>({x:t.key,y:t.totals[i]}))};t.push(a)}),t},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});