// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/highcharts","app/core/View"],function(t,i,e,s){"use strict";return s.extend({initialize:function(){this.chart=null,this.isLoading=!1,this.limit=-1,this.listenTo(this.model,"request",this.onModelLoading),this.listenTo(this.model,"sync",this.onModelLoaded),this.listenTo(this.model,"error",this.onModelError),this.listenTo(this.model,"change:"+this.options.metric,this.render)},destroy:function(){null!==this.chart&&(this.chart.destroy(),this.chart=null)},afterRender:function(){this.timers.createOrUpdate&&clearTimeout(this.timers.createOrUpdate),this.timers.createOrUpdate=setTimeout(this.createOrUpdate.bind(this),1)},createOrUpdate:function(){this.timers.createOrUpdate=null,this.chart?this.updateChart():(this.createChart(),this.isLoading&&this.chart.showLoading())},createChart:function(){var t=this.serializeSeries(),s=t[0].data.length,r=this.model.getNlsDomain(),a=this.options.metric,o=-1===this.limit?Math.max(400,150+20*s):100+20*s;this.chart=new e.Chart({chart:{renderTo:this.el,plotBorderWidth:1,height:o,type:"bar"},exporting:{filename:i.bound(r,"report:filenames:summary:"+a),chartOptions:{title:{text:i.bound(r,"report:title:summary:"+a)}},sourceHeight:o},title:!1,noData:{},xAxis:{categories:this.serializeCategories()},yAxis:{title:!1,min:0,allowDecimals:!1},tooltip:{shared:!0,valueDecimals:0},legend:{enabled:-1===this.limit},plotOptions:{bar:{stacking:"normal",dataLabels:{enabled:-1!==this.limit,formatter:function(){return this.y||""}}}},series:t})},updateChart:function(){this.chart.destroy(),this.createChart()},serializeCategories:function(){var t=this.model.get(this.options.metric).categories;return-1!==this.limit&&(t=t.slice(0,this.limit)),t},serializeSeries:function(){var t=this.model.get(this.options.metric);return-1!==this.limit&&(t={cancelled:t.cancelled.slice(0,this.limit),open:t.open.slice(0,this.limit),finished:t.finished.slice(0,this.limit)}),[{id:"cancelled",name:i.bound("suggestions","report:series:summary:cancelled"),data:t.cancelled,color:"#d9534f"},{id:"open",name:i.bound("suggestions","report:series:summary:open"),data:t.open,color:"#f0ad4e"},{id:"finished",name:i.bound("suggestions","report:series:summary:finished"),data:t.finished,color:"#5cb85c"}]},onModelLoading:function(){this.isLoading=!0,this.chart&&this.chart.showLoading()},onModelLoaded:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()},onModelError:function(){this.isLoading=!1,this.chart&&this.chart.hideLoading()}})});