define(["underscore","jquery","app/i18n","app/core/views/ListView","app/kaizenOrders/dictionaries","./CoordSectionsView"],function(e,t,i,o,n,s){"use strict";function r(e,t){return e.observer&&e.observer.notify&&e.observer.changes&&e.observer.changes[t.id]?{className:"is-changed"}:{}}return o.extend({className:"suggestions-list is-clickable is-colored",events:Object.assign({'click td[data-id="opinions"]':function(e){var t=this.$(e.currentTarget),i=t.parent(),o=this.collection.get(i.attr("data-id")),n=t.data("bs.popover");if(this.$opinionPopover&&this.$opinionPopover[0]!==t[0]&&(this.$opinionPopover.popover("hide"),this.$opinionPopover=null),n)return n.toggle(),void(this.$opinionPopover="in"===n.hoverState?t:null);t.popover({container:this.el,trigger:"manual",placement:"left",html:!0,className:"suggestions-list-popover-opinions",hasContent:function(){return o.get("coordSections").length>0},title:function(){return""},content:function(){var e=new s({model:o,embedded:!0});return e.render(),e.$el}}),t.popover("show"),t.modelId=o.id,this.$opinionPopover=t}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),t(document).on("keydown."+this.idPrefix,this.onDocumentKeyDown.bind(this))},destroy:function(){o.prototype.destroy.apply(this,arguments),t(document).off("."+this.idPrefix)},serializeColumns:function(){var t=this.options.simple,i=[{id:"rid",className:"is-min is-number"},{id:"status",className:"is-min",tdAttrs:t?"":r},{id:"subject",className:(t?"":"is-overflow w275")+" has-popover",tdAttrs:t?"":r,label:this.t("PROPERTY:subjectAndDescription")}];if(t)return i;var o=this.collection.findRqlTerm("status",["eq","in"]);return o&&(o="eq"===o.name?[o.args[1]]:o.args[1]),i.push.apply(i,[{id:"date",className:"is-min",tdAttrs:r},{id:"finishedAt",className:"is-min",tdAttrs:r,visible:e.isEmpty(o)||o.includes("finished")},{id:"categories",className:"is-overflow w250 has-popover",tdAttrs:r},{id:"productFamily",className:"is-overflow w150",tdAttrs:r},{id:"section",className:"is-overflow w150",tdAttrs:r},{id:"confirmer",className:"is-min",tdAttrs:r},{id:"owners",className:"is-min has-popover"},{id:"opinions",className:"text-nowrap"}]),i},serializeActions:function(){var e=this.collection;return this.options.simple?null:function(t){var i=e.get(t._id),n=[o.actions.viewDetails(i)];return i.canEdit()&&n.push(o.actions.edit(i)),i.canDelete()&&n.push(o.actions.delete(i)),n}},afterRender:function(){if(o.prototype.afterRender.call(this),this.setUpPopover(),this.$opinionPopover){var e=this.$opinionPopover.modelId;this.collection.get(e)&&this.$('.list-item[data-id="'+e+'"] > td[data-id="opinions"]').click()}},setUpPopover:function(){var e=this;e.$el.popover({selector:".has-popover",container:this.el,trigger:"hover",placement:function(e,t){return"owners"===t.dataset.id?"auto left":"auto right"},html:!0,className:"suggestions-list-popover",hasContent:function(){var t=this.dataset.id;if("subject"===t)return!0;var i=e.collection.get(this.parentNode.dataset.id);return("categories"===t||"owners"===t)&&i.get(t).length>1},title:function(){return""},content:function(){var t=e.collection.get(this.parentNode.dataset.id),i=this.dataset.id;return"subject"===i?t.get("howItIs"):"categories"===i?e.serializePopoverList(t.get(i).map(function(e){return n.categories.getLabel(e)})):"owners"===i?e.serializePopoverList(t.get(i).map(function(e){return e.rendered})):void 0}})},serializePopoverList:function(e){if(!(e.length<=1)){for(var t="<ul>",i=0;i<e.length;++i)t+="<li>"+e[i];return t+="</ul>"}},isNotClickable:function(e){return"opinions"===this.$(e.target).closest("td").attr("data-id")||o.prototype.isNotClickable.apply(this,arguments)},onDocumentKeyDown:function(e){this.$opinionPopover&&"Escape"===e.key&&this.$opinionPopover.popover("hide")},onModelEdited:function(e){var t=this.collection.get(e.model._id);t&&this.$opinionPopover&&this.$opinionPopover.modelId===t.id?(t.set(e.model),this.render()):this.refreshCollection()}})});