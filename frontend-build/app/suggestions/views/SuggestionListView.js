define(["require","underscore","jquery","app/i18n","app/core/views/ListView","./CoordSectionsView"],function(e,t,i,o,s,n){"use strict";function r(e,t){return e.observer&&e.observer.notify&&e.observer.changes&&e.observer.changes[t.id]?{className:"is-changed"}:{}}return s.extend({className:"suggestions-list is-clickable is-colored",events:Object.assign({'click td[data-id="opinions"]':function(e){var t=this.$(e.currentTarget),i=t.parent(),o=this.collection.get(i.attr("data-id")),s=t.data("bs.popover");if(this.$opinionPopover&&this.$opinionPopover[0]!==t[0]&&(this.$opinionPopover.popover("hide"),this.$opinionPopover=null),s)return s.toggle(),void(this.$opinionPopover="in"===s.hoverState?t:null);t.popover({container:this.el,trigger:"manual",placement:"left",html:!0,className:"suggestions-list-popover-opinions",hasContent:function(){return o.get("coordSections").length>0},title:function(){return""},content:function(){var e=new n({model:o,embedded:!0});return e.render(),e.$el}}),t.popover("show"),t.modelId=o.id,this.$opinionPopover=t}},s.prototype.events),initialize:function(){s.prototype.initialize.apply(this,arguments),i(document).on("keydown."+this.idPrefix,this.onDocumentKeyDown.bind(this))},destroy:function(){s.prototype.destroy.apply(this,arguments),i(document).off("."+this.idPrefix)},serializeColumns:function(){var e=this.options.simple,i=[{id:"rid",className:"is-min is-number"},{id:"status",className:"is-min",tdAttrs:e?"":r},{id:"subject",className:(e?"":"is-overflow w275")+" has-popover",tdAttrs:e?"":r,label:this.t("PROPERTY:subjectAndDescription")}];if(e)return i;var o=this.collection.findRqlTerm("status",["eq","in"]);return o&&(o="eq"===o.name?[o.args[1]]:o.args[1]),i.push.apply(i,[{id:"date",className:"is-min",tdAttrs:r},{id:"finishedAt",className:"is-min",tdAttrs:r,visible:t.isEmpty(o)||o.includes("finished")},{id:"categories",className:"is-overflow w250 has-popover",tdAttrs:r},{id:"productFamily",className:"is-overflow w150",tdAttrs:r},{id:"section",className:"is-overflow w150",tdAttrs:r},{id:"confirmer",className:"is-min",tdAttrs:r},{id:"owners",className:"is-min has-popover"},{id:"opinions",className:"text-nowrap"}]),i},serializeActions:function(){var e=this.collection;return this.options.simple?null:function(t){var i=e.get(t._id),o=[s.actions.viewDetails(i)];return i.canEdit()&&o.push(s.actions.edit(i)),i.canDelete()&&o.push(s.actions.delete(i)),o}},afterRender:function(){if(s.prototype.afterRender.call(this),this.options.simple||this.setUpPopover(),this.$opinionPopover){var e=this.$opinionPopover.modelId;this.collection.get(e)&&this.$('.list-item[data-id="'+e+'"] > td[data-id="opinions"]').click()}},setUpPopover:function(){var t=this,i=e("app/kaizenOrders/dictionaries");t.$el.popover({selector:".has-popover",container:this.el,trigger:"hover",placement:function(e,t){return"owners"===t.dataset.id?"auto left":"auto right"},html:!0,className:"suggestions-list-popover",hasContent:function(){var e=this.dataset.id;if("subject"===e)return!0;var i=t.collection.get(this.parentNode.dataset.id);return("categories"===e||"owners"===e)&&i.get(e).length>1},title:function(){return""},content:function(){var e=t.collection.get(this.parentNode.dataset.id),o=this.dataset.id;return"subject"===o?e.get("howItIs"):"categories"===o?t.serializePopoverList(e.get(o).map(function(e){return i.categories.getLabel(e)})):"owners"===o?t.serializePopoverList(e.get(o).map(function(e){return e.rendered})):void 0}})},serializePopoverList:function(e){if(!(e.length<=1)){for(var t="<ul>",i=0;i<e.length;++i)t+="<li>"+e[i];return t+="</ul>"}},isNotClickable:function(e){return"opinions"===this.$(e.target).closest("td").attr("data-id")||s.prototype.isNotClickable.apply(this,arguments)},onDocumentKeyDown:function(e){this.$opinionPopover&&"Escape"===e.key&&this.$opinionPopover.popover("hide")},onModelEdited:function(e){var t=this.collection.get(e.model._id);t&&this.$opinionPopover&&this.$opinionPopover.modelId===t.id?(t.set(e.model),this.render()):this.refreshCollection()}})});