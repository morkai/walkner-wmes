define(["underscore","app/time","app/user","app/viewport","app/core/views/FormView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","app/suggestions/templates/accept"],function(e,t,i,n,r,s,a,o){"use strict";return r.extend({dialogClassName:"suggestions-accept-dialog",template:o,events:e.assign({"click #-accept":function(){this.status="inProgress",this.checkKaizenOwnersValidity(),this.el.reportValidity()&&this.submitForm()},"click #-reject":function(){this.status="new",this.checkKaizenOwnersValidity(),this.el.reportValidity()&&this.submitForm()},"click #-cancel":function(){this.status="cancelled",this.checkKaizenOwnersValidity(),this.el.reportValidity()&&this.submitForm()},"change #-kaizenOwners-1":function(e){this.toggleRequired(this.$id("kaizenSuperiors-1"),!!e.currentTarget.value)}},r.prototype.events),afterRender:function(){var e=this;r.prototype.afterRender.apply(e,arguments);var t=[].concat(e.model.get("kaizenOwners")),i=[].concat(e.model.get("kaizenSuperiors"));for(Array.isArray(t)&&0!==t.length||(t=[].concat(e.model.get("suggestionOwners")),i=[].concat(e.model.get("suggestionSuperiors")));t.length<2;)t.push(null),i.push(null);t.forEach(function(t,n){var r=s(e.$id("kaizenOwners-"+n),{activeOnly:!0,noPersonnelId:!0,currentUserInfo:t});e.toggleRequired(r,0===n);var o=s(e.$id("kaizenSuperiors-"+n),{activeOnly:!0,noPersonnelId:!0,currentUserInfo:i[n],rqlQueryDecorator:function(e){var t=a.settings.getValue("superiorFuncs");Array.isArray(t)&&t.length&&e.selector.args.push({name:"in",args:["prodFunction",t]})}});e.toggleRequired(o,!!t)})},toggleRequired:function(e,t){e.prop("required",t).closest(".form-group").toggleClass("has-required-select2",t).find(".control-label").toggleClass("is-required",t)},serializeToForm:function(){return{}},serializeForm:function(e){var i=this,n=[],r=[];return i.$('input[name^="kaizenOwners"]').each(function(e){var t=s.getUserInfo(i.$(this)),a=s.getUserInfo(i.$id("kaizenSuperiors-"+e));t&&a&&(n.push(t),r.push(a))}),{status:this.status,kaizenOwners:n,kaizenSuperiors:r,kaizenStartDate:"inProgress"===i.status?t.getMoment().startOf("day").toISOString():null,kaizenFinishDate:null,comment:e.comment}},request:function(e){return this.ajax({method:"PUT",url:this.model.url(),data:JSON.stringify(e)})},getFailureText:function(){return this.t("accept:failure")},handleSuccess:function(){n.closeDialog()},checkKaizenOwnersValidity:function(){var e=this,t="",i={};e.model.get("suggestionOwners").forEach(function(e){i[e.id]=1}),e.$('input[name^="kaizenOwners"]').each(function(){var t=s.getUserInfo(e.$(this));t&&(i[t.id]=1)}),Object.keys(i).length>3&&(t=e.t("FORM:owners:tooMany:overall",{max:3})),e.$id("kaizenOwners-0")[0].setCustomValidity(t)}})});