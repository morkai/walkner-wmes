define(["underscore","../i18n","../time","../user","../core/Model","app/kaizenOrders/dictionaries","app/core/templates/userInfo"],function(e,t,r,n,i,s,a){"use strict";var o=["date","kaizenStartDate","kaizenFinishDate"],u=["createdAt","updatedAt","confirmedAt"],c=["creator","updater","confirmer"],g=["suggestionOwners","kaizenOwners"];return t=t.forDomain("suggestions"),i.extend({urlRoot:"/suggestions",clientUrlRoot:"#suggestions",topicPrefix:"suggestions",privilegePrefix:"SUGGESTIONS",nlsDomain:"suggestions",labelAttribute:"rid",defaults:function(){return{status:"new",date:new Date}},initialize:function(){this.on("reset change",this.prepareUsers),this.prepareUsers()},serialize:function(n){var i=n&&n.longDateTime,f=i?"LL":"L",h=i?"LLLL":"L, LTS",d=this.toJSON();return d.status=t(n&&n.nlsDomain||"suggestions","status:"+d.status),d.section=s.sections.getLabel(d.section),d.categories=(d.categories||[]).map(function(e){return s.categories.getLabel(e)}).join("; "),d.productFamily=d.kaizenEvent||s.productFamilies.getLabel(d.productFamily)||"-",o.forEach(function(e){d[e]=d[e]?r.format(d[e],f):null}),u.forEach(function(e){d[e]=d[e]?r.format(d[e],h):null}),c.forEach(function(e){d[e]=a({userInfo:d[e]})}),g.forEach(function(e){d[e]=(d[e]||[]).map(function(e){return e.rendered})}),d.coordSections=(d.coordSections||[]).map(function(t){var r=s.sections.get(t._id);return e.defaults({name:r?r.getLabel():t._id,user:a({userInfo:t.user})},t)}),Array.isArray(d.attachments)||(d.attachments=[]),d},serializeRow:function(r){var n=this.serialize(r);n.observer&&n.observer.notify&&e.isEmpty(n.observer.changes)&&(n.className="is-changed");var i=n.owners;return i&&(n.owners=1===i.length?i[0].rendered:t(r&&r.nlsDomain||"suggestions","LIST:owners",{first:i[0].rendered,count:i.length-1})),n},serializeDetails:function(){var t=this.serialize({longDateTime:!0});return t.changed=t.observer.changes||{},delete t.changed.all,t.changed.all=t.observer.notify&&e.isEmpty(t.observer.changes),t},isCreator:function(){return this.attributes.creator&&this.attributes.creator.id===n.data._id},isConfirmer:function(){return this.attributes.confirmer&&this.attributes.confirmer.id===n.data._id},isSuggestionOwner:function(){return e.some(this.get("suggestionOwners"),function(e){return e.id===n.data._id})},isKaizenOwner:function(){return e.some(this.get("kaizenOwners"),function(e){return e.id===n.data._id})},isOwner:function(){return this.isSuggestionOwner()||this.isKaizenOwner()},isCoordinator:function(){return e.some(this.get("coordSections"),function(t){var r=s.sections.get(t._id);return!!r&&e.some(r.get("coordinators"),function(e){return e.id===n.data._id})})},isNotSeen:function(){return this.attributes.observer.notify},canManage:function(){return n.isAllowedTo(this.privilegePrefix+":MANAGE")},canCoordinate:function(){return"new"===this.get("status")&&(!!this.canManage()||this.isCoordinator())},canAccept:function(){return"accepted"===this.get("status")&&(!!this.canManage()||this.isConfirmer())},canComplete:function(){return"inProgress"===this.get("status")&&(!!this.canManage()||(this.isConfirmer()||this.isKaizenOwner()))},canVerify:function(){return"verification"===this.get("status")&&(!!this.canManage()||this.isConfirmer())},canEdit:function(){if(this.canManage())return!0;var e=this.get("status");return!(!n.isLoggedIn()||"finished"===e||"cancelled"===e)&&(!!this.isConfirmer()||(!("new"!==e||!this.isCreator()&&!this.isSuggestionOwner())||"inProgress"===e&&this.isKaizenOwner()))},canDelete:function(){return!!this.canManage()||"new"===this.get("status")&&this.isCreator()},markAsSeen:function(){var e=this.attributes.observer;if(e.notify){e.lastSeenAt=new Date,e.notify=!1,e.changes={};var t=this.attributes.observers;this.attributes.observers=null,this.set("observers",t),this.trigger("seen")}},prepareUsers:function(){this.attributes.observers&&this.prepareObserver(),this.attributes.suggestionOwners&&this.prepareOwners()},prepareObserver:function(){var t=this.get("observers")||[],r=e.find(t,function(e){return e.user.id===n.data._id});this.attributes.observer=r||{user:{id:n.data._id,label:n.getLabel()},role:"viewer",lastSeenAt:null,notify:!1,changes:{}},r&&"string"==typeof r.lastSeenAt&&(r.lastSeenAt=new Date(r.lastSeenAt)),this.trigger("change:observer")},prepareOwners:function(){var t=this.attributes,r={};g.forEach(function(e){t[e]=(t[e]||[]).map(function(e){return e.rendered=a({userInfo:e}),r[e.id]||(r[e.id]=e),e})}),t.owners=e.values(r),this.trigger("change:owners")}},{DATE_PROPERTIES:o})});