define(["require","underscore","../i18n","../time","../user","../core/Model","app/core/templates/userInfo"],function(e,t,i,n,r,s,a){"use strict";var o=["date","kaizenStartDate","kaizenFinishDate"],c=["createdAt","updatedAt","confirmedAt","finishedAt"],u=["creator","updater","confirmer","suggestionSuperiors","kaizenSuperiors"],f=["suggestionOwners","kaizenOwners"],h={pending:"fa-question",rejected:"fa-thumbs-down",accepted:"fa-thumbs-up"};return i=i.forDomain("suggestions"),s.extend({urlRoot:"/suggestions",clientUrlRoot:"#suggestions",topicPrefix:"suggestions",privilegePrefix:"SUGGESTIONS",nlsDomain:"suggestions",labelAttribute:"rid",defaults:function(){return{status:"new",date:(new Date).toISOString()}},initialize:function(){this.on("reset change",this.prepareUsers),this.prepareUsers()},serialize:function(t){var r=t&&t.longDateTime,s=r?"LL":"L",h=r?"LLL":"L, LTS",d=this.toJSON();d.status=i(t&&t.nlsDomain||"suggestions","status:"+d.status);var g=null;try{g=e("app/kaizenOrders/dictionaries")}catch(e){}return g?(d.section=g.sections.getLabel(d.section),d.categories=(d.categories||[]).map(function(e){return g.categories.getLabel(e)}).join("; "),d.productFamily=d.kaizenEvent||g.productFamilies.getLabel(d.productFamily)||""):d.categories=(d.categories||[]).join("; "),o.forEach(function(e){d[e]=d[e]?n.format(d[e],s):null}),c.forEach(function(e){d[e]=d[e]?n.format(d[e],h):null}),u.forEach(function(e){Array.isArray(d[e])?d[e]=d[e].map(function(e){return a(e,{noIp:!0})}):d[e]=a(d[e],{noIp:!0})}),f.forEach(function(e){d[e]=(d[e]||[]).map(function(e){return e.rendered})}),d.coordSections=this.serializeCoordSections(),Array.isArray(d.attachments)||(d.attachments=[]),d},serializeRow:function(e){var r=this.serialize(e);r.className="",r.observer&&r.observer.notify&&t.isEmpty(r.observer.changes)&&(r.className+=" is-changed");var s=r.owners;switch(s&&(r.owners=1===s.length?s[0].rendered:i(e&&e.nlsDomain||"suggestions","LIST:owners",{first:s[0].rendered,count:s.length-1})),r.finishedAt=r.finishedAt?n.format(this.get("finishedAt"),"L"):"",r.opinions=r.coordSections.map(function(e){return'<i class="fa '+h[e.status]+'"></i><span>'+t.escape(e._id)+"</span>"}).join(" "),this.get("status")){case"finished":this.get("kom")?(r.className+=" warning",r.status+=' <i class="fa fa-trophy"></i>'):r.className+=" success";break;case"cancelled":r.className+=" danger";break;case"inProgress":r.className+=" active";break;case"accepted":case"verification":r.className=" info"}return r},serializeDetails:function(){var e=this.serialize({longDateTime:!0});return e.changed=e.observer.changes||{},e.changed.all=e.observer.notify&&t.isEmpty(e.observer.changes),e},serializeCoordSections:function(){var i=this,r=this.constructor,s=null;try{s=e("app/kaizenOrders/dictionaries")}catch(e){}return(this.get("coordSections")||[]).map(function(e){var o=s?s.sections.get(e._id):null;return t.defaults({name:o?o.getLabel():e._id,user:e.user?a({userInfo:e.user}):"-",time:e.time?n.format(e.time,"LLLL"):"-",users:(e.users||[]).map(function(e){return a({userInfo:e})}),canCoordinate:r.can.coordinateSection(i,e._id)},e)})},getAttachmentKinds:function(){return["before","after","other"]},getAttachmentUrl:function(e){return`${this.urlRoot}/${this.id}/attachments/${e._id}/${e.file}?`},isParticipant:function(){return this.attributes.observer&&"viewer"!==this.attributes.observer.role},isCreator:function(){return this.attributes.creator&&this.attributes.creator.id===r.data._id},isConfirmer:function(){return this.attributes.confirmer&&this.attributes.confirmer.id===r.data._id},isPossibleConfirmer:function(){var t=null;try{t=e("app/kaizenOrders/dictionaries")}catch(e){}var i=t?t.sections.get(this.get("section")):null;return!!i&&i.get("confirmers").some(function(e){return e.id===r.data._id})},isSuggestionOwner:function(){return t.some(this.get("suggestionOwners"),function(e){return e.id===r.data._id})},isKaizenOwner:function(){return t.some(this.get("kaizenOwners"),function(e){return e.id===r.data._id})},isOwner:function(){return this.isSuggestionOwner()||this.isKaizenOwner()},isCoordinator:function(){return t.some(this.get("coordSections"),function(e){return t.some(e.users,function(e){return e.id===r.data._id})})},isNotSeen:function(){return this.attributes.observer.notify},canManage:function(){return r.isAllowedTo(this.privilegePrefix+":MANAGE")},canKom:function(){return"finished"===this.get("status")&&(this.canManage()||this.isConfirmer())},canCoordinate:function(){return"new"===this.get("status")&&(!!this.canManage()||this.isCoordinator())},canAccept:function(){return"accepted"===this.get("status")&&(!!this.canManage()||this.isConfirmer())},canComplete:function(){return"inProgress"===this.get("status")&&(!!this.canManage()||(this.isConfirmer()||this.isKaizenOwner()))},canVerify:function(){return"verification"===this.get("status")&&(!!this.canManage()||this.isConfirmer())},canEdit:function(){if(!r.isLoggedIn())return!1;if(this.canManage()||this.isConfirmer()||this.isPossibleConfirmer())return!0;var e=this.get("status");return"finished"!==e&&"cancelled"!==e&&(("new"===e||"inProgress"===e)&&(this.isCreator()||this.isSuggestionOwner()||this.isKaizenOwner()))},canDelete:function(){return!!this.canManage()||"new"===this.get("status")&&this.isCreator()},markAsSeen:function(){var e=this.attributes.observer;if(e.notify){e.lastSeenAt=new Date,e.notify=!1,e.changes={};var t=this.attributes.observers;this.attributes.observers=null,this.set("observers",t),this.trigger("seen")}},prepareUsers:function(){this.attributes.observers&&this.prepareObserver(),this.attributes.suggestionOwners&&this.prepareOwners()},prepareObserver:function(){var e=this.get("observers")||[],i=t.find(e,function(e){return e.user.id===r.data._id});this.attributes.observer=i||{user:{id:r.data._id,label:r.getLabel()},role:"viewer",lastSeenAt:null,notify:!1,changes:{}},i&&"string"==typeof i.lastSeenAt&&(i.lastSeenAt=new Date(i.lastSeenAt)),this.trigger("change:observer")},prepareOwners:function(){var e=this.attributes,i={};f.forEach(function(t){e[t]=(e[t]||[]).map(function(e){return e.rendered=a({userInfo:e}),i[e.id]||(i[e.id]=e),e})}),e.owners=t.values(i),this.trigger("change:owners")},getCoordSection:function(e){return this.get("coordSections").find(function(t){return t._id===e})}},{DATE_PROPERTIES:o,OPINION_STATUS_ICONS:h,can:{manage:function(){return r.isAllowedTo("SUGGESTIONS:MANAGE")},coordinate:function(e){var t=this.can||this;return(e.get("coordSections")||[]).some(function(i){return t.coordinateSection(e,i._id)})},coordinateSection:function(e,t){if((this.can||this).manage())return!0;if("new"!==e.get("status"))return!1;var i=e.getCoordSection(t);return!!i&&i.users.some(function(e){return e.id===r.data._id})},editAttachment:function(e){return!!(this.can||this).manage()||"finished"!==e.get("status")&&e.isParticipant()},deleteAttachment:function(e,t){return!!(this.can||this).manage()||"finished"!==e.get("status")&&(!!e.isCoordinator()||t.user.id===r.data._id)}}})});