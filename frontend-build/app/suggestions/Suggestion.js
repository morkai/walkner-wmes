define(["underscore","../i18n","../time","../user","../core/Model","app/kaizenOrders/dictionaries","app/core/templates/userInfo"],function(e,t,n,i,r,s,o){"use strict";var a=["date","kaizenStartDate","kaizenFinishDate"],u=["createdAt","updatedAt","confirmedAt","finishedAt"],c=["creator","updater","confirmer"],f=["suggestionOwners","kaizenOwners"];return t=t.forDomain("suggestions"),r.extend({urlRoot:"/suggestions",clientUrlRoot:"#suggestions",topicPrefix:"suggestions",privilegePrefix:"SUGGESTIONS",nlsDomain:"suggestions",labelAttribute:"rid",defaults:function(){return{status:"new",date:new Date}},initialize:function(){this.on("reset change",this.prepareUsers),this.prepareUsers()},serialize:function(i){var r=i&&i.longDateTime,d=r?"LL":"L",g=r?"LLL":"L, LTS",h=this.toJSON();return h.status=t(i&&i.nlsDomain||"suggestions","status:"+h.status),h.section=s.sections.getLabel(h.section),h.categories=(h.categories||[]).map(function(e){return s.categories.getLabel(e)}).join("; "),h.productFamily=h.kaizenEvent||s.productFamilies.getLabel(h.productFamily)||"",a.forEach(function(e){h[e]=h[e]?n.format(h[e],d):null}),u.forEach(function(e){h[e]=h[e]?n.format(h[e],g):null}),c.forEach(function(e){h[e]=o({userInfo:h[e],noIp:!0})}),f.forEach(function(e){h[e]=(h[e]||[]).map(function(e){return e.rendered})}),h.coordSections=(h.coordSections||[]).map(function(t){var i=s.sections.get(t._id);return e.defaults({name:i?i.getLabel():t._id,user:t.user?o({userInfo:t.user}):"-",time:t.time?n.format(t.time,"LLLL"):"-",users:(t.users||[]).map(function(e){return o({userInfo:e})})},t)}),Array.isArray(h.attachments)||(h.attachments=[]),h},serializeRow:function(i){var r=this.serialize(i);r.observer&&r.observer.notify&&e.isEmpty(r.observer.changes)&&(r.className="is-changed");var s=r.owners;return s&&(r.owners=1===s.length?s[0].rendered:t(i&&i.nlsDomain||"suggestions","LIST:owners",{first:s[0].rendered,count:s.length-1})),r.finishedAt=r.finishedAt?n.format(this.get("finishedAt"),"L"):"",r},serializeDetails:function(){var t=this,n=this.constructor,i=this.serialize({longDateTime:!0});return i.changed=i.observer.changes||{},delete i.changed.all,i.changed.all=i.observer.notify&&e.isEmpty(i.observer.changes),i.coordSections.forEach(function(e){e.canCoordinate=n.can.coordinateSection(t,e._id)}),i},isCreator:function(){return this.attributes.creator&&this.attributes.creator.id===i.data._id},isConfirmer:function(){return this.attributes.confirmer&&this.attributes.confirmer.id===i.data._id},isSuggestionOwner:function(){return e.some(this.get("suggestionOwners"),function(e){return e.id===i.data._id})},isKaizenOwner:function(){return e.some(this.get("kaizenOwners"),function(e){return e.id===i.data._id})},isOwner:function(){return this.isSuggestionOwner()||this.isKaizenOwner()},isCoordinator:function(){return e.some(this.get("coordSections"),function(t){return e.some(t.users,function(e){return e.id===i.data._id})})},isNotSeen:function(){return this.attributes.observer.notify},canManage:function(){return i.isAllowedTo(this.privilegePrefix+":MANAGE")},canCoordinate:function(){return"new"===this.get("status")&&(!!this.canManage()||this.isCoordinator())},canAccept:function(){return"accepted"===this.get("status")&&(!!this.canManage()||this.isConfirmer())},canComplete:function(){return"inProgress"===this.get("status")&&(!!this.canManage()||(this.isConfirmer()||this.isKaizenOwner()))},canVerify:function(){return"verification"===this.get("status")&&(!!this.canManage()||this.isConfirmer())},canEdit:function(){if(this.canManage())return!0;var e=this.get("status");return!(!i.isLoggedIn()||"finished"===e||"cancelled"===e)&&(!!this.isConfirmer()||(!("new"!==e||!this.isCreator()&&!this.isSuggestionOwner())||"inProgress"===e&&this.isKaizenOwner()))},canDelete:function(){return!!this.canManage()||"new"===this.get("status")&&this.isCreator()},markAsSeen:function(){var e=this.attributes.observer;if(e.notify){e.lastSeenAt=new Date,e.notify=!1,e.changes={};var t=this.attributes.observers;this.attributes.observers=null,this.set("observers",t),this.trigger("seen")}},prepareUsers:function(){this.attributes.observers&&this.prepareObserver(),this.attributes.suggestionOwners&&this.prepareOwners()},prepareObserver:function(){var t=this.get("observers")||[],n=e.find(t,function(e){return e.user.id===i.data._id});this.attributes.observer=n||{user:{id:i.data._id,label:i.getLabel()},role:"viewer",lastSeenAt:null,notify:!1,changes:{}},n&&"string"==typeof n.lastSeenAt&&(n.lastSeenAt=new Date(n.lastSeenAt)),this.trigger("change:observer")},prepareOwners:function(){var t=this.attributes,n={};f.forEach(function(e){t[e]=(t[e]||[]).map(function(e){return e.rendered=o({userInfo:e}),n[e.id]||(n[e.id]=e),e})}),t.owners=e.values(n),this.trigger("change:owners")},getCoordSection:function(e){return this.get("coordSections").find(function(t){return t._id===e})}},{DATE_PROPERTIES:a,can:{manage:function(){return i.isAllowedTo("SUGGESTIONS:MANAGE")},coordinate:function(e){var t=this.can||this;return(e.get("coordSections")||[]).some(function(n){return t.coordinateSection(e,n._id)})},coordinateSection:function(e,t){if((this.can||this).manage())return!0;if("new"!==e.get("status"))return!1;var n=e.getCoordSection(t);return!!n&&n.users.some(function(e){return e.id===i.data._id})}}})});