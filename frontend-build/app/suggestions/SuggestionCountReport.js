define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","app/kaizenOrders/dictionaries"],function(e,t,r,o,s,a){"use strict";var i={new:"#1aadce",accepted:"#aaff00",inProgress:"#2f7ed8",verification:"#ffaa00",finished:"#5cb85c",cancelled:"#e00"},n=["total","status","section","category","productFamily"];return o.extend({urlRoot:"/suggestions/reports/count",nlsDomain:"suggestions",defaults:function(){return{from:0,to:0,interval:"month",sections:[],categories:[]}},fetch:function(t){return e.isObject(t)||(t={}),t.data=e.assign(t.data||{},e.pick(this.attributes,["from","to","interval","sections","categories"])),t.data.sections=t.data.sections.join(","),t.data.categories=t.data.categories.join(","),o.prototype.fetch.call(this,t)},genClientUrl:function(){return"/suggestionCountReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&categories="+this.get("categories")},parse:function(t){var r=this,o=t.totals,s=o.count,a={total:{rows:this.prepareTotalRows(o),series:this.prepareTotalSeries()},status:{rows:this.prepareRows(s,o.status,"status"),series:{}},owner:{categories:this.prepareUserCategories(t.users,o.owner),series:this.prepareOwnerSeries(o.owner,t.groups)},confirmer:{categories:this.prepareUserCategories(t.users,o.confirmer),series:this.prepareConfirmerSeries(o.confirmer,t.groups)},productFamily:{rows:this.prepareProductFamilyRows(t),series:{}}};return e.forEach(n,function(e){a[e]||(a[e]={rows:r.prepareRows(s,o[e],e),series:{}})}),e.forEach(t.groups,function(t){var o;"number"==typeof t?t={key:o=t,type:{}}:o=t.key;var s=a.total.series;s.suggestion.data.push({x:o,y:t.type.suggestion||null}),s.kaizen.data.push({x:o,y:t.type.kaizen||null}),s.kaizenEvent.data.push({x:o,y:t.type.kaizenEvent||null}),e.forEach(n,function(e){r.createSeriesFromRows(e,a,t)})},this),a},prepareTotalRows:function(e){return[{id:"suggestion",abs:e.type.suggestion,rel:1,color:"#f0ad4e"},{id:"kaizen",abs:e.type.kaizen,rel:e.type.kaizen/e.type.suggestion,color:"#5cb85c"},{id:"kaizenEvent",abs:e.type.kaizenEvent,rel:e.type.kaizenEvent/e.type.suggestion,color:"#8e5ec7"}]},prepareTotalSeries:function(){return{suggestion:{data:[],color:"#f0ad4e"},kaizen:{data:[],color:"#5cb85c"},kaizenEvent:{data:[],color:"#8e5ec7"}}},prepareRows:function(e,t,r){var o=a.forProperty(r);return t.map(function(t){var n=t[0],c=i[n]||s.getColor(r,n);return{id:n,abs:t[1],rel:t[1]/e,color:c,label:o?a.getLabel(o,n):void 0}})},prepareProductFamilyRows:function(e){return e.totals.productFamily.map(function(t){var r=t[0];return{id:r,abs:t[1],rel:t[1]/e.totals.count,color:s.getColor("productFamily",r),label:e.kaizenEvents[r]||a.getLabel("productFamilies",r)}})},createSeriesFromRows:function(r,o,s){var a=this.getNlsDomain(),i=o[r].series;e.forEach(o[r].rows,function(e){i[e.id]||(e.label||"status"!==r||(e.label=t(a,"status:"+e.id)),i[e.id]={name:e.label,data:[],color:e.color}),i[e.id].data.push({x:s.key,y:s[r]&&s[r][e.id]||null})})},prepareUserCategories:function(e,t){return t.map(function(t){var r=t[0];return e[r]||r})},prepareOwnerSeries:function(r){var o=[{id:"suggestion",name:t.bound("suggestions","report:series:suggestion"),data:[],color:"#f0ad4e"},{id:"kaizen",name:t.bound("suggestions","report:series:kaizen"),data:[],color:"#5cb85c"},{id:"kaizenEvent",name:t.bound("suggestions","report:series:kaizenEvent"),data:[],color:"#8e5ec7"}];return e.forEach(r,function(e){o[0].data.push(e[3]),o[1].data.push(e[4]),o[2].data.push(e[5])}),o},prepareConfirmerSeries:function(r){return[{id:"entry",name:t.bound("suggestions","report:series:entry"),data:e.map(r,function(e){return e[1]})}]}},{TABLE_AND_CHART_METRICS:n,fromQuery:function(t){return void 0===t.from&&void 0===t.to&&(t.from=r.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+t.from||void 0,to:+t.to||void 0,interval:t.interval||void 0,sections:e.isEmpty(t.sections)?[]:t.sections.split(","),categories:e.isEmpty(t.categories)?[]:t.categories.split(",")})}})});