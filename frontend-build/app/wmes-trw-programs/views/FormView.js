define(["underscore","jquery","jsplumb","app/viewport","app/core/Model","app/core/views/FormView","app/core/util/idAndLabel","app/core/util/uuid","app/planning/util/contextMenu","app/wmes-trw-tests/dictionaries","app/wmes-trw-bases/Base","app/wmes-trw-bases/templates/cluster","../Program","app/wmes-trw-programs/templates/form"],function(t,e,s,i,n,o,r,a,c,l,p,d,u,h){"use strict";return o.extend({template:h,events:t.assign({"change #-base":function(){this.loadBase()},"click #-steps-play":function(){},"click #-steps-add":function(){var t={_id:a(),color:[],length:0,source:{cluster:"",row:-1,col:-1,endpoint:""},target:{cluster:"",row:-1,col:-1,endpoint:""},connector:"Bezier"};this.model.attributes.steps.push(t),this.addStep(t,!0)},"click #-steps-delete":function(){this.deleteStep(this.selectedStep)},"click #-steps-up":function(){this.moveStepUp(this.selectedStep)},"click #-steps-down":function(){this.moveStepDown(this.selectedStep)},"click .trw-programs-step":function(t){this.selectStep(t.currentTarget.dataset.id)},"click .trw-programs-canvasAndSteps":function(){this.hideEditor()},'click .trw-testing-prop[data-prop="color"]':function(){return this.showColorEditor(),!1},'click .trw-testing-prop[data-prop="length"]':function(){return this.showLengthEditor(),!1},"mouseenter .trw-base-cluster":function(t){this.showClusterPopover(t.currentTarget.dataset.id)},"mouseleave .trw-base-cluster":function(){this.hideClusterPopover()}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.jsPlumb=null,this.base=null,this.selectedStep=null,e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){e(window).off("."+this.idPrefix),this.hideEditor(),this.resetCanvas(!0),this.jsPlumb=null},afterRender:function(){o.prototype.afterRender.call(this),this.$id("base").select2({data:l.bases.map(r)}),this.setUpJsPlumb();var e=this.model.get("base");t.isObject(e)?(this.base=e,this.completeRendering()):this.loadBase()},completeRendering:function(){if(this.resetCanvas(),this.renderCanvas(),this.renderSteps(),t.isEmpty(this.model.get("steps")))this.$id("steps-add").click();else{var e=this.$step(this.selectedStep);this.selectedStep=null,e.length?e.click():this.$(".trw-programs-step").first().click()}},onKeyDown:function(t){"Escape"===t.key&&this.hideEditor()},setUpJsPlumb:function(){this.jsPlumb=s.getInstance({Container:this.$(".trw-base-canvas-inner")[0],ConnectionOverlays:[["Arrow",{id:"ARROW",location:-6,cssClass:"trw-base-canvas-arrow",visible:!0,width:22,length:22}],["Label",{id:"LABEL",location:.5,cssClass:"trw-base-canvas-label",visible:!1}]]}),this.jsPlumb.bind("connection",this.onConnectionCreated.bind(this)),this.jsPlumb.bind("click",this.onConnectionClicked.bind(this)),this.jsPlumb.bind("contextmenu",function(t,e){e.preventDefault()})},onConnectionCreated:function(t,e){var s=this,i=t.connection.getParameter("step"),n=!1;i||(s.jsPlumb.getConnections().forEach(function(t){t.getParameter("step")===s.selectedStep&&s.jsPlumb.deleteConnection(t)}),t.connection.setParameter("step",s.selectedStep),i=s.selectedStep,n=e&&(e.ctrlKey||e.altKey));var o=s.model.getStep(i),r=s.model.getStepIndex(i),a=t.connection.getOverlay("LABEL");if(a.setLabel((r+1).toString()),a.setVisible(!0),i===s.selectedStep?a.removeClass("trw-base-canvas-faded"):a.addClass("trw-base-canvas-faded"),o.source=t.sourceEndpoint.getParameters(),o.target=t.targetEndpoint.getParameters(),s.updateStep(i),n){var c=s.model.attributes.steps[r+1];c?this.selectStep(c._id):this.$id("steps-add").click()}},onConnectionClicked:function(t){this.selectStep(t.getParameter("step"))},loadBase:function(){var t=this,e=t.$id("base").val();if(t.base=null,t.resetCanvas(),e.length){var s=t.ajax({url:"/trw/bases/"+e});s.fail(function(){i.msg.show({type:"error",time:1e4,text:t.t("FORM:ERROR:baseLoadingFailure")})}),s.done(function(e){t.base=e,t.completeRendering()})}},$cluster:function(t){return this.$('.trw-base-cluster[data-id="'+t+'"]')},$cell:function(t,e,s){return this.$cluster(t).find('.trw-base-cell[data-row="'+e+'"][data-col="'+s+'"]')},resetCanvas:function(t){this.jsPlumb&&this.jsPlumb.reset(!t),this.$id("canvas").empty()},renderCanvas:function(){var t=this;if(t.base){var e=t.base.clusters.map(function(e){return t.renderPartialHtml(d,{cluster:e})});t.$id("canvas").html(e),t.base.clusters.forEach(function(e){e.rows.forEach(function(s,i){s.forEach(function(s,n){var o=t.$cell(e._id,i,n)[0],r=e._id+":"+i+":"+n;s.endpoints.forEach(function(s){t.jsPlumb.addEndpoint(o,{uuid:r+":"+s,anchor:u.ENDPOINT_TO_ANCHOR[s],isSource:!0,isTarget:!0,allowLoopback:!1,maxConnections:-1,endpoint:["Dot",{radius:10}],cssClass:"trw-base-canvas-endpoint",connector:"Bezier",connectorClass:"trw-base-canvas-connector",parameters:{cluster:e._id,row:i,col:n,endpoint:s}})})})})})}},renderSteps:function(){var t=this;t.$(".trw-programs-step").remove(),t.model.get("steps").forEach(function(e){t.addStep(e,!1)})},addStep:function(t,s){var i=this.$id("steps"),n=i[0].childElementCount,o=e('<div class="trw-programs-step"></div>').attr("data-id",t._id).text(this.formatDescription(n,t));i.append(o),s&&o.click()},deleteStep:function(t){if(1!==this.model.attributes.steps.length){var e=this.$step(t),s=0===e.next().length;this.model.attributes.steps.splice(this.findStepIndex(e[0]),1);var i=e[0].nextElementSibling||e[0].previousElementSibling;e.remove(),i.click(),s||this.recountSteps()}},recountSteps:function(){var t=this;t.$(".trw-programs-step").each(function(t){this.textContent=this.textContent.replace(/^[0-9]+\./,t+1+".")}),t.jsPlumb.getConnections().forEach(function(e){var s=t.model.getStepIndex(e.getParameter("step"));e.getOverlay("LABEL").setLabel((s+1).toString())})},moveStepUp:function(e){var s=this.model.attributes.steps;if(1!==s.length){var i=t.findIndex(s,{_id:e}),n=this.$step(e),o=this.$id("steps");if(0===i)o.append(n),s.push(s.shift());else{n.insertBefore(n.prev());var r=s[i-1];s[i-1]=s[i],s[i]=r}this.recountSteps()}},moveStepDown:function(e){var s=this.model.attributes.steps;if(1!==s.length){var i=t.findIndex(s,{_id:e}),n=this.$step(e),o=this.$id("steps");if(i===s.length-1)n.insertAfter(o[0].firstElementChild),s.unshift(s.pop());else{n.insertAfter(n.next());var r=s[i+1];s[i+1]=s[i],s[i]=r}this.recountSteps()}},findStepIndex:function(t){for(var e=1;e<t.parentNode.childElementCount;++e)if(t.parentNode.children[e]===t)return e-1;return-1},findStepEl:function(t){return this.$id("steps")[0].children[t+1]},$step:function(t){return this.$('.trw-programs-step[data-id="'+t+'"]')},selectStep:function(t){var e=this.$id("steps").find(".trw-programs-step.active");if(!e.length||e[0].dataset.id!==t){e.removeClass("active"),this.$step(t).addClass("active");var s=this.model.getStep(t);this.$(".trw-base-cell.active").removeClass("active"),this.$cell(s.source.cluster,s.source.row,s.source.col).addClass("active"),this.$cell(s.target.cluster,s.target.row,s.target.col).addClass("active"),this.selectedStep=t,this.updateSelectedStep(),this.updateConnections()}},updateConnections:function(){var t=this;t.jsPlumb.deleteEveryConnection(),t.model.attributes.steps.forEach(function(e){if(e.source.cluster&&e.target.cluster){var s=e._id===t.selectedStep,i=["trw-base-canvas-connector"];s||i.push("trw-base-canvas-faded"),t.jsPlumb.connect({uuids:[u.formatEndpointUuid(e.source),u.formatEndpointUuid(e.target)],parameters:{step:e._id},detachable:s,cssClass:i.join(" ")})}})},updateStep:function(t){var e=this.model.getStep(t);this.$step(t).text(this.formatDescription(this.model.getStepIndex(t)+1,e)),t===this.selectedStep&&this.updateSelectedStep()},updateSelectedStep:function(){var t=this.model.getStep(this.selectedStep);this.$id("no").text(this.t("PROPERTY:steps.no",{no:this.model.getStepIndex(t._id)+1})),this.updateProp("source",this.formatEndpoint(t.source)),this.updateProp("target",this.formatEndpoint(t.target)),this.updateProp("color",this.formatColor(t.color,"?")),this.updateProp("length",this.formatLength(t.length,"?"))},updateProp:function(t,e){this.$('.trw-testing-prop[data-prop="'+t+'"]').find(".trw-testing-prop-value").text(e)},formatDescription:function(t,e){return this.t("form:steps:description",{no:t,source:this.formatEndpoint(e.source),target:this.formatEndpoint(e.target),color:this.formatColor(e.color),length:this.formatLength(e.length)})},formatColor:function(t,e){return u.formatColor(t,e)},formatLength:function(t,e){return u.formatLength(t,e)},formatEndpoint:function(t){return u.formatEndpoint(t,this.base)},hideEditor:function(){var t=this.$id("editor");t.find("input").select2("destroy"),t.remove()},showColorEditor:function(){var t=this,s=t.model.getStep(t.selectedStep);t.hideEditor();var i=t.$('.trw-testing-prop[data-prop="color"] > .trw-testing-prop-value'),n=e('<form class="trw-programs-editor"></form>').attr("id",this.idPrefix+"-editor"),o=e("<input>").val(s.color.join(","));n.append(o),n.append('<button class="btn btn-default"><i class="fa fa-check"></i></button>'),n.on("submit",function(){return s.color=o.select2("val"),t.hideEditor(),t.updateStep(s._id),!1});var r=i.position();n.css({top:r.top+"px",left:r.left+"px"}),n.appendTo("body"),o.select2({width:Math.max(i.outerWidth()-40,300)+"px",multiple:!0,allowClear:!0,placeholder:" ",data:u.COLORS.map(function(e){return{id:e,text:t.t("colors:"+e)}})}),o.select2("focus")},showLengthEditor:function(){var t=this,s=t.model.getStep(t.selectedStep);t.hideEditor();var i=t.$('.trw-testing-prop[data-prop="length"] > .trw-testing-prop-value'),n=e('<form class="trw-programs-editor"></form>').attr("id",this.idPrefix+"-editor"),o=e('<input class="form-control">').val(s.length.toString()).css({width:Math.max(i.outerWidth()-40,75)});n.append(o),n.append('<button class="btn btn-default"><i class="fa fa-check"></i></button>'),n.on("submit",function(){return s.length=Math.max(0,parseInt(o.val(),10)||0),t.hideEditor(),t.updateStep(s._id),!1});var r=i.position();n.css({top:r.top+"px",left:r.left+"px"}),n.appendTo("body"),o.focus()},showClusterPopover:function(t){var s=this;s.hideClusterPopover();var i=s.model.getCluster(t);i&&i.image&&(s.$clusterPopover=s.$cluster(t).popover({container:document.body,placement:"top",trigger:"manual",html:!0,content:function(){return'<img src="'+i.image+'">'},template:function(t){return e(t).addClass("trw-base-cluster-popover")}}),s.timers.showClusterPopover=setTimeout(function(){s.$clusterPopover&&s.$clusterPopover.popover("show")},333))},hideClusterPopover:function(t){clearTimeout(this.timers.showClusterPopover),this.$clusterPopover&&(t&&this.$clusterPopover[0].dataset.id!==t||(this.$clusterPopover.popover("destroy"),this.$clusterPopover=null))}})});