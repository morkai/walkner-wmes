define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/resultTips","app/data/clipboard","app/planning/util/contextMenu","app/orderDocuments/views/BomAndViewerView","../WiringOrderCollection","app/wmes-wiring/templates/list","app/wmes-wiring/templates/listRow","app/wmes-wiring/templates/action","jquery.stickytableheaders"],function(t,e,i,n,o,r,s,a,c,d,l,p,h){"use strict";return o.extend({template:l,events:{"click td":function(t){var e=t.currentTarget,n=e.dataset.popover;if(this.$popover&&this.$popover[0]===e&&this.$popover.data("sticky"))this.hidePopover();else if(this.hidePopover(!0),"nc12"!==e.dataset.columnId){if(n){var o=(n=n.split(" ")).join("\n");"leadingOrders"===e.dataset.columnId&&i.isAllowedTo("ORDERS:VIEW")&&(n=n.map(function(t){return'<a href="#orders/'+t+'" target="_blank">'+t+"</a>"})),this.$popover=this.$(e).popover({container:document.body,placement:"right",trigger:"manual",html:!0,content:n.join(", ")}),this.$popover.data("sticky",!0).data("clipboard",o).popover("show")}}else this.handleOpenDocumentAction(this.$(e).closest("tr")[0].dataset.id,t)},"mouseenter td":function(t){var e=t.currentTarget;if(!this.$popover||this.$popover[0]!==e){var i=e.dataset.popover;i&&-1!==i.indexOf(" ")&&(this.hidePopover(),this.$popover=this.$(e).popover({container:document.body,placement:"right",trigger:"manual",content:i.replace(/ /g,", ")}),this.$popover.data("sticky",!1).data("clipboard",i.replace(/ /g,"\n")).popover("show"))}},"mouseleave td":function(){this.$popover&&!this.$popover.data("sticky")&&this.hidePopover()},"click .btn":function(t){this.handleAction(t.currentTarget.dataset.action,this.$(t.target).closest("tr")[0].dataset.nc12)}},modelProperty:"orders",initialize:function(){this.lastNc12=null,this.lastColumnId=null,this.renderRow=this.renderPartialHtml.bind(this,p),this.once("afterRender",this.defineBindings)},destroy:function(){e(window).off("keydown."+this.idPrefix),this.$(".table").stickyTableHeaders("destroy"),this.hidePopover(!0)},defineBindings:function(){this.listenTo(this.orders,"reset add remove filter:status filter:mrp",t.debounce(this.render.bind(this),1)),this.listenTo(this.orders,"change",this.onChange),e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("click."+this.idPrefix,this.onMouseClick.bind(this))},getTemplateData:function(){return{canUpdate:this.orders.canUpdate(),renderRow:this.renderRow,rows:this.serializeRows(null)}},serializeRows:function(e){var i=this.orders.filters;return"all"===i.mrp?this.groupRows(e):this.orders.serialize().filter(function(n){return(!e||n.nc12===e)&&n.mrp===i.mrp&&(0===i.status.length||t.includes(i.status,n.status))})},groupRows:function(e){var i=this,n={},o={};i.orders.serialize().forEach(function(t){e&&t.nc12!==e||(n[t.nc12]||(n[t.nc12]=[]),n[t.nc12].push(t))}),t.forEach(n,function(e){var n=!0;e.forEach(function(t){n=n&&"cancelled"===t.status}),e.forEach(function(e){var r=o[e.nc12];r?(r.status=i.resolveStatus(r.status,e.status),("cancelled"!==e.status||n)&&(r.qty+=e.qty),r.qtyDone+=e.qtyDone,(!r.startedAt||e.startedAt<r.startedAt)&&(r.startedAt=e.startedAt),(!r.finishedAt||e.finishedAt>r.finishedAt)&&(r.finishedAt=e.finishedAt),r.actionInProgress||(r.actionInProgress=e.actionInProgress)):((r=o[e.nc12]=t.clone(e)).mrps={},r.leadingOrders={},"cancelled"!==e.status||n||(r.qty=0)),e.mrps.forEach(function(t){r.mrps[t]=1}),e.leadingOrders.forEach(function(t){r.leadingOrders[t]=1})})});var r=[],s=i.orders.filters.status;return t.forEach(o,function(e){s.length&&!t.includes(s,e.status)||(e.mrps=Object.keys(e.mrps).sort(),e.leadingOrders=Object.keys(e.leadingOrders).sort(),r.push(e))}),r},resolveStatus:function(t,e){if(t===e)return t;var i=[t,e].sort(function(t,e){return d.STATUS_ORDERS[t]-d.STATUS_ORDERS[e]});return t=i[0],e=i[1],"new"===t?"cancelled"===e?t:"started"===e?e:"partial":t},beforeRender:function(){this.hidePopover(!0)},afterRender:function(){this.$(".table").stickyTableHeaders({fixedOffset:e(".navbar-fixed-top")})},onChange:function(t){var i=t.get("nc12"),n=this.serializeRows(i),o=this.$('.wiring-list-item[data-nc12="'+i+'"]');if(n.length){var r=this.renderRow({canUpdate:this.orders.canUpdate(),row:n[0]});o.length?o.replaceWith(r):e(r).css({display:"none"}).appendTo(this.$("tbody")).fadeIn("fast")}else o.fadeOut("fast",function(){o.remove()})},onKeyDown:function(t){if(!n.currentDialog&&(t.ctrlKey&&"C"===t.key.toUpperCase()&&this.handleCopy(t),"Escape"===t.key)){this.hidePopover(),this.hideEditor();var e=Date.now();this.lastEscapeAt&&e-this.lastEscapeAt<500&&(this.orders.setStatusFilter([]),this.orders.setMrpFilter("all")),this.lastEscapeAt=e}},onMouseClick:function(t){var i=e(t.target);i.closest(".wiring-list-editor-popover").length||i.closest(".actions").length||this.hideEditor()},handleCopy:function(t){if(""===window.getSelection().toString()&&this.$popover){t.preventDefault();var e=this.$popover[0].dataset.columnId,i=this.$popover.data("clipboard").replace(/ /g,"\n");this.copyProp(e,i)}},copyProp:function(t,e){var i=this;s.copy(function(o){o.setData("text/plain",e),i.$clipboardMsg&&n.msg.hide(i.$clipboardMsg,!0),i.$clipboardMsg=n.msg.show({type:"info",time:1500,text:i.t("msg:clipboard:"+t)})})},hidePopover:function(t){if(this.$popover){var e=this.$popover.data("bs.popover");t&&e&&e.tip().removeClass("fade"),this.$popover.popover("destroy").removeData("sticky"),this.$popover=null}},handleAction:function(t,e){switch(this.hideEditor(),t){case"start":this.act(t,e);break;case"continue":case"cancel":case"reset":case"finish":this.showActionPopover(t,e)}},hideEditor:function(){var t=e(".wiring-list-editor-popover");t.length&&this.$('.btn[aria-describedby="'+t[0].id+'"]').popover("destroy")},showActionPopover:function(t,e){var i=this,n=i.serializeRows(e)[0];if(n){var o=i.$('.wiring-list-item[data-nc12="'+e+'"]').find('.btn[data-action="'+t+'"]');o.popover({container:document.body,placement:"right",trigger:"manual",html:!0,title:function(){return""},content:this.renderPartialHtml(h,{action:t,qtyDone:n.qtyDone<n.qty?n.qty:n.qtyDone===n.qty?0:n.qtyDone,qty:n.qty}),className:"wiring-list-editor-popover"}),o.popover("show");var r=o.data("bs.popover").tip().find("form");r.on("submit",function(){return i.hideEditor(),i.act(t,e,r.find(".form-control").val()||""),!1}),r.find(".btn-danger").on("click",function(){i.hideEditor()}),"finish"===t?r.find(".form-control").select():r.find(".btn-success").focus()}},act:function(t,e,i){var o="finish"===t;if(!o||i){n.msg.saving();var r=this.orders.filters.mrp,s=this.orders.filter(function(t){return t.get("nc12")===e&&("all"===r||t.get("mrp")===r)}),a=0;s.forEach(function(t){a+=t.get("qtyDone")}),o&&(i=("+"===i.charAt(0)?a:0)+parseInt(i,10));var c=[];s.forEach(function(e,n){var r;if(o){var a=e.get("qty");r=n+1===s.length?i>=0?i:0:i>0?i>=a?a:i:0,i-=a}else if(s.length>1){var d=e.get("status");if("continue"===t&&"finished"===d)return;if("reset"!==t&&"cancelled"===d)return}c.push({action:t,orderId:e.id,qtyDone:r}),e.set("actionInProgress",t)}),c.length&&this.actNext(e,c)}},actNext:function(t,e){var i=this,o=e.shift();i.orders.act(o,function(r){var s=i.orders.get(o.orderId);s&&s.set("actionInProgress",null),r?n.msg.savingFailed():e.length?i.actNext(t,e):n.msg.saved()})},handleOpenDocumentAction:function(t,e){var i=this.orders.get(t);if(i){n.msg.loading();var o=i.get("orders").map(t=>t._id).slice(0,10),s=this.ajax({url:`/orders?select(documents)&limit(1)&_id=in=(${o})&exists(documents.0)`});s.fail(()=>{n.msg.loadingFailed()}),s.done(t=>{if(n.msg.loaded(),0===t.totalCount||0===t.collection[0].documents.length)return void r.show({type:"warning",text:this.t("openDocument:empty"),e:e});const{documents:o}=t.collection[0];1===o.length?this.openDocument(o[0],i.get("orders")[0]._id):this.showOpenDocumentMenu(o,i.get("orders")[0]._id,e)})}},showOpenDocumentMenu:function(e,i,n){a.show(this,n.pageY,n.pageX,e.map(e=>({label:"<code>"+e.nc15+"</code> "+t.escape(e.name),handler:()=>this.openDocument(e,i)})))},openDocument:function(t,e){const i=new c({model:{document:t,order:e}});n.showDialog(i)}})});