define(["underscore","jquery","app/user","app/viewport","app/core/View","app/data/clipboard","../WiringOrderCollection","app/wmes-wiring/templates/list","app/wmes-wiring/templates/listRow","app/wmes-wiring/templates/action","jquery.stickytableheaders"],function(t,e,i,r,o,n,s,a,c,d){"use strict";return o.extend({template:a,events:{"click td":function(t){var e=t.currentTarget,r=e.dataset.popover;if(this.$popover&&this.$popover[0]===e&&this.$popover.data("sticky"))this.hidePopover();else if(this.hidePopover(!0),r){var o=(r=r.split(" ")).join("\n");"leadingOrders"===e.dataset.columnId&&i.isAllowedTo("ORDERS:VIEW")&&(r=r.map(function(t){return'<a href="#orders/'+t+'" target="_blank">'+t+"</a>"})),this.$popover=this.$(e).popover({container:document.body,placement:"right",trigger:"manual",html:!0,content:r.join(", ")}),this.$popover.data("sticky",!0).data("clipboard",o).popover("show")}},"mouseenter td":function(t){var e=t.currentTarget;if(!this.$popover||this.$popover[0]!==e){var i=e.dataset.popover;i&&-1!==i.indexOf(" ")&&(this.hidePopover(),this.$popover=this.$(e).popover({container:document.body,placement:"right",trigger:"manual",content:i.replace(/ /g,", ")}),this.$popover.data("sticky",!1).data("clipboard",i.replace(/ /g,"\n")).popover("show"))}},"mouseleave td":function(){this.$popover&&!this.$popover.data("sticky")&&this.hidePopover()},"click .btn":function(t){this.handleAction(t.currentTarget.dataset.action,this.$(t.target).closest("tr")[0].dataset.nc12)}},modelProperty:"orders",initialize:function(){this.lastNc12=null,this.lastColumnId=null,this.renderRow=this.renderPartialHtml.bind(this,c),this.once("afterRender",this.defineBindings)},destroy:function(){e(window).off("keydown."+this.idPrefix),this.$(".table").stickyTableHeaders("destroy"),this.hidePopover(!0)},defineBindings:function(){this.listenTo(this.orders,"reset add remove filter:status filter:mrp",t.debounce(this.render.bind(this),1)),this.listenTo(this.orders,"change",this.onChange),e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("click."+this.idPrefix,this.onMouseClick.bind(this))},getTemplateData:function(){return{canUpdate:this.orders.canUpdate(),renderRow:this.renderRow,rows:this.serializeRows(null)}},serializeRows:function(e){var i=this.orders.filters;return"all"===i.mrp?this.groupRows(e):this.orders.serialize().filter(function(r){return(!e||r.nc12===e)&&r.mrp===i.mrp&&(0===i.status.length||t.includes(i.status,r.status))})},groupRows:function(e){var i=this,r={},o={};i.orders.serialize().forEach(function(t){e&&t.nc12!==e||(r[t.nc12]||(r[t.nc12]=[]),r[t.nc12].push(t))}),t.forEach(r,function(e){var r=!0;e.forEach(function(t){r=r&&"cancelled"===t.status}),e.forEach(function(e){var n=o[e.nc12];n?(n.status=i.resolveStatus(n.status,e.status),("cancelled"!==e.status||r)&&(n.qty+=e.qty),n.qtyDone+=e.qtyDone,(!n.startedAt||e.startedAt<n.startedAt)&&(n.startedAt=e.startedAt),(!n.finishedAt||e.finishedAt>n.finishedAt)&&(n.finishedAt=e.finishedAt),n.actionInProgress||(n.actionInProgress=e.actionInProgress)):((n=o[e.nc12]=t.clone(e)).mrps={},n.leadingOrders={},"cancelled"!==e.status||r||(n.qty=0)),e.mrps.forEach(function(t){n.mrps[t]=1}),e.leadingOrders.forEach(function(t){n.leadingOrders[t]=1})})});var n=[],s=i.orders.filters.status;return t.forEach(o,function(e){s.length&&!t.includes(s,e.status)||(e.mrps=Object.keys(e.mrps).sort(),e.leadingOrders=Object.keys(e.leadingOrders).sort(),n.push(e))}),n},resolveStatus:function(t,e){if(t===e)return t;var i=[t,e].sort(function(t,e){return s.STATUS_ORDERS[t]-s.STATUS_ORDERS[e]});return t=i[0],e=i[1],"new"===t?"cancelled"===e?t:"started"===e?e:"partial":t},beforeRender:function(){this.hidePopover(!0)},afterRender:function(){this.$(".table").stickyTableHeaders({fixedOffset:e(".navbar-fixed-top")})},onChange:function(t){var i=t.get("nc12"),r=this.serializeRows(i),o=this.$('.wiring-list-item[data-nc12="'+i+'"]');if(r.length){var n=this.renderRow({canUpdate:this.orders.canUpdate(),row:r[0]});o.length?o.replaceWith(n):e(n).css({display:"none"}).appendTo(this.$("tbody")).fadeIn("fast")}else o.fadeOut("fast",function(){o.remove()})},onKeyDown:function(t){if(t.ctrlKey&&"C"===t.key.toUpperCase()&&this.handleCopy(t),"Escape"===t.key){this.hidePopover(),this.hideEditor();var e=Date.now();this.lastEscapeAt&&e-this.lastEscapeAt<500&&(this.orders.setStatusFilter([]),this.orders.setMrpFilter("all")),this.lastEscapeAt=e}},onMouseClick:function(t){var i=e(t.target);i.closest(".wiring-list-editor-popover").length||i.closest(".actions").length||this.hideEditor()},handleCopy:function(t){if(""===window.getSelection().toString()&&this.$popover){t.preventDefault();var e=this.$popover[0].dataset.columnId,i=this.$popover.data("clipboard").replace(/ /g,"\n");this.copyProp(e,i)}},copyProp:function(t,e){var i=this;n.copy(function(o){o.setData("text/plain",e),i.$clipboardMsg&&r.msg.hide(i.$clipboardMsg,!0),i.$clipboardMsg=r.msg.show({type:"info",time:1500,text:i.t("msg:clipboard:"+t)})})},hidePopover:function(t){if(this.$popover){var e=this.$popover.data("bs.popover");t&&e&&e.tip().removeClass("fade"),this.$popover.popover("destroy").removeData("sticky"),this.$popover=null}},handleAction:function(t,e){switch(this.hideEditor(),t){case"start":this.act(t,e);break;case"continue":case"cancel":case"reset":case"finish":this.showActionPopover(t,e)}},hideEditor:function(){var t=e(".wiring-list-editor-popover");t.length&&this.$('.btn[aria-describedby="'+t[0].id+'"]').popover("destroy")},showActionPopover:function(t,e){var i=this,r=i.serializeRows(e)[0];if(r){var o=i.$('.wiring-list-item[data-nc12="'+e+'"]').find('.btn[data-action="'+t+'"]');o.popover({container:document.body,placement:"right",trigger:"manual",html:!0,title:function(){return""},content:this.renderPartialHtml(d,{action:t,qtyDone:r.qtyDone<r.qty?r.qty:r.qtyDone===r.qty?0:r.qtyDone,qty:r.qty}),className:"wiring-list-editor-popover"}),o.popover("show");var n=o.data("bs.popover").tip().find("form");n.on("submit",function(){return i.hideEditor(),i.act(t,e,n.find(".form-control").val()||""),!1}),n.find(".btn-danger").on("click",function(){i.hideEditor()}),"finish"===t?n.find(".form-control").select():n.find(".btn-success").focus()}},act:function(t,e,i){var o="finish"===t;if(!o||i){r.msg.saving();var n=this.orders.filters.mrp,s=this.orders.filter(function(t){return t.get("nc12")===e&&("all"===n||t.get("mrp")===n)}),a=0;s.forEach(function(t){a+=t.get("qtyDone")}),o&&(i=("+"===i.charAt(0)?a:0)+parseInt(i,10));var c=[];s.forEach(function(e,r){var n;if(o){var a=e.get("qty");n=r+1===s.length?i>=0?i:0:i>0?i>=a?a:i:0,i-=a}else if(s.length>1){var d=e.get("status");if("continue"===t&&"finished"===d)return;if("reset"!==t&&"cancelled"===d)return}c.push({action:t,orderId:e.id,qtyDone:n}),e.set("actionInProgress",t)}),c.length&&this.actNext(e,c)}},actNext:function(t,e){var i=this,o=e.shift();i.orders.act(o,function(n){var s=i.orders.get(o.orderId);s&&s.set("actionInProgress",null),n?r.msg.savingFailed():e.length?i.actNext(t,e):r.msg.saved()})}})});