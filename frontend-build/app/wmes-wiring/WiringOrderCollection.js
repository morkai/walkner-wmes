define(["underscore","jquery","../time","../user","../core/util/getShiftStartInfo","../core/util/embedded","../core/Collection","./WiringOrder"],function(t,e,r,i,s,n,a,l){"use strict";var o=["new","started","partial","finished","cancelled"];function u(){var t={todo:0,done:0,remaining:0};return o.forEach(function(e){t[e]=0}),t}return a.extend({model:l,comparator:"name",initialize:function(e,r){r||(r={}),this.settings=r.settings||null,this.user=r.user||null,this.filters={mrp:r.mrp||"all",status:r.status||[],order:r.order||""},this.resetState(),this.on("request",this.resetState),this.on("change",function(e){this.serializedMap&&this.serializedMap[e.id]&&t.assign(this.serializedMap[e.id],e.serialize(!0,this))})},parse:function(t){return a.prototype.parse.call(this,t).map(l.parse)},genClientUrl:function(){return"/wiring/"+this.getDateFilter()},isDateFilter:function(e){return t.some(this.rqlQuery.selector.args,function(t){return"eq"===t.name&&"date"===t.args[0]&&t.args[1]===e})},getDateFilter:function(t){var e=null;return this.rqlQuery.selector.args.forEach(function(i){"eq"===i.name&&"date"===i.args[0]&&(e=r.utc.getMoment(i.args[1],"YYYY-MM-DD").format(t||"YYYY-MM-DD"))}),e},setDateFilter:function(t){this.rqlQuery.selector.args.forEach(function(e){"eq"===e.name&&"date"===e.args[0]&&(e.args[1]=t)})},setStatusFilter:function(t){5===t.length&&(t=[]),this.filters.status=t,this.trigger("filter:status")},setMrpFilter:function(t){this.filters.mrp=this.filters.mrp===t?"all":t,this.trigger("filter:mrp")},setOrderFilter:function(t){this.setMrpFilter("all"),this.filters.order=t,this.trigger("filter:order")},getMrps:function(){if(!this.serializedList){if(0===this.length)return[];this.serialize()}return this.allMrps},getStats:function(){if(!this.totalQuantities){if(0===this.length)return{all:u()};this.serialize()}return this.totalQuantities},serialize:function(t){var e=this;if(!t&&e.serializedList)return e.serializedList;var r=[],i={},s={},n={all:u()};return e.forEach(function(t){var a=i[t.id]=t.serialize(!0,e);r.push(a),s[a.mrp]=1,e.recountOrder(n,a)}),e.serializedList=r,e.serializedMap=i,e.allMrps=Object.keys(s).sort(),e.totalQuantities=n,"all"===e.filters.mrp||s[e.filters.mrp]||e.setMrpFilter("all"),r},serializeTotals:function(){return this.totalQuantities[this.filters.mrp]||u()},recountTotals:function(){this.totalQuantities={all:u()},(this.serializedList||[]).forEach(this.recountOrder.bind(this,this.totalQuantities)),this.trigger("totalsRecounted")},recountOrder:function(t,e){var r=e.mrp,i=e.status;t[r]||(t[r]=u()),t.all[i]+=e.qtyRemaining,t[r][i]+=e.qtyRemaining,"cancelled"!==i&&(t.all.finished+=e.qtyDone,t[r].finished+=e.qtyDone,t.all.todo+=e.qty,t[r].todo+=e.qty,t.all.done+=e.qtyDone,t[r].done+=e.qtyDone,t.all.remaining+=e.qtyRemaining,t[r].remaining+=e.qtyRemaining),e.orders.forEach(function(e){t[e.leadingOrder]||(t[e.leadingOrder]=u());var r=Math.max(0,e.qty-e.qtyDone);t[e.leadingOrder].todo+=e.qty,t[e.leadingOrder].done+=e.qtyDone,t[e.leadingOrder].remaining+=r,t[e.leadingOrder][i]+=r})},canUpdate:function(){return!!i.isAllowedTo("WIRING:WIRER","WIRING:MANAGE")||!(!n.isEnabled()||!i.isAllowedTo("LOCAL"))},act:function(t,r){var i=this,s=i.url;t.orderId&&(s="/wiring/orders/"+t.orderId),i.user&&(t.user=i.user);var n=e.ajax({method:"PATCH",url:s,data:JSON.stringify(t)});return i.trigger("request",this,n,{}),n.fail(function(t){var e=t.responseJSON?t.responseJSON.error:null;e||(e={message:t.statusText}),e.statusCode=t.status,r(e),i.trigger("error",n)}),n.done(function(t){r(null,t),i.trigger("sync",t,n)}),n},applyChanges:function(t){var e=this,r=t.removed.length>0||t.added.length>0,i=r;e.remove(t.removed,{silent:r}),t.added.forEach(function(t){e.add(l.parse(t),{silent:r})}),t.changed.forEach(function(t){var s=e.get(t._id);s&&(s.set(l.parse(t),{silent:r}),(t.qty||t.status)&&(i=!0))}),r?(e.resetState(),e.sort({silent:!0}),e.trigger("reset",e)):i&&e.recountTotals()},resetState:function(){this.allMrps=null,this.serializedList=null,this.serializedMap=null,this.totalQuantities={all:u()}}},{STATUSES:o,STATUS_ORDERS:{new:0,started:1,partial:2,finished:3,cancelled:4},forDate:function(e,r){return new this(null,t.assign({rqlQuery:"sort(name)&limit(0)&date="+e},r))}})});