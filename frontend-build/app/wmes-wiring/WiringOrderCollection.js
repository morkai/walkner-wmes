define(["underscore","jquery","../time","../user","../core/util/getShiftStartInfo","../core/util/embedded","../core/Collection","./WiringOrder"],function(t,e,i,r,s,n,a,l){"use strict";var o=["new","started","partial","finished","cancelled"];function u(){var t={todo:0,done:0,remaining:0};return o.forEach(function(e){t[e]=0}),t}return a.extend({model:l,comparator:"name",initialize:function(e,i){this.settings=i?i.settings:null,this.user=i?i.user:null,this.filters={mrp:i&&i.mrp||"all",status:i&&i.status||[]},this.resetState(),this.on("request",this.resetState),this.on("change",function(e){this.serializedMap&&this.serializedMap[e.id]&&t.assign(this.serializedMap[e.id],e.serialize(!0,this))})},parse:function(t){return a.prototype.parse.call(this,t).map(l.parse)},genClientUrl:function(){return"/wiring/"+this.getDateFilter()},isDateFilter:function(e){return t.some(this.rqlQuery.selector.args,function(t){return"eq"===t.name&&"date"===t.args[0]&&t.args[1]===e})},getDateFilter:function(t){var e=null;return this.rqlQuery.selector.args.forEach(function(r){"eq"===r.name&&"date"===r.args[0]&&(e=i.utc.getMoment(r.args[1],"YYYY-MM-DD").format(t||"YYYY-MM-DD"))}),e},setDateFilter:function(t){this.rqlQuery.selector.args.forEach(function(e){"eq"===e.name&&"date"===e.args[0]&&(e.args[1]=t)})},setStatusFilter:function(t){5===t.length&&(t=[]),this.filters.status=t,this.trigger("filter:status")},setMrpFilter:function(t){this.filters.mrp=this.filters.mrp===t?"all":t,this.trigger("filter:mrp")},getMrps:function(){if(!this.serializedList){if(0===this.length)return[];this.serialize()}return this.allMrps},getStats:function(){if(!this.totalQuantities){if(0===this.length)return{all:u()};this.serialize()}return this.totalQuantities},serialize:function(t){var e=this;if(!t&&e.serializedList)return e.serializedList;var i=[],r={},s={},n={all:u()};return e.forEach(function(t){var a=r[t.id]=t.serialize(!0,e);i.push(a),s[a.mrp]=1,e.recountOrder(n,a)}),e.serializedList=i,e.serializedMap=r,e.allMrps=Object.keys(s).sort(),e.totalQuantities=n,"all"===e.filters.mrp||s[e.filters.mrp]||e.setMrpFilter("all"),i},serializeTotals:function(){return this.totalQuantities[this.filters.mrp]||u()},recountTotals:function(){this.totalQuantities={all:u()},(this.serializedList||[]).forEach(this.recountOrder.bind(this,this.totalQuantities)),this.trigger("totalsRecounted")},recountOrder:function(t,e){var i=e.mrp,r=e.status;t[i]||(t[i]=u()),t.all[r]+=e.qtyRemaining,t[i][r]+=e.qtyRemaining,"cancelled"!==r&&(t.all.finished+=e.qtyDone,t[i].finished+=e.qtyDone,t.all.todo+=e.qty,t[i].todo+=e.qty,t.all.done+=e.qtyDone,t[i].done+=e.qtyDone,t.all.remaining+=e.qtyRemaining,t[i].remaining+=e.qtyRemaining)},canUpdate:function(){return!!r.isAllowedTo("WIRING:WIRER","WIRING:MANAGE")||!(!n.isEnabled()||!r.isAllowedTo("LOCAL"))},act:function(t,i){var r=this,s=r.url;t.orderId&&(s="/wiring/orders/"+t.orderId),r.user&&(t.user=r.user);var n=e.ajax({method:"PATCH",url:s,data:JSON.stringify(t)});return r.trigger("request",this,n,{}),n.fail(function(t){var e=t.responseJSON?t.responseJSON.error:null;e||(e={message:t.statusText}),e.statusCode=t.status,i(e),r.trigger("error",n)}),n.done(function(t){i(null,t),r.trigger("sync",t,n)}),n},applyChanges:function(t){var e=this,i=t.removed.length>0||t.added.length>0,r=i;e.remove(t.removed,{silent:i}),t.added.forEach(function(t){e.add(l.parse(t),{silent:i})}),t.changed.forEach(function(t){var s=e.get(t._id);s&&(s.set(l.parse(t),{silent:i}),(t.qty||t.status)&&(r=!0))}),i?(e.resetState(),e.sort({silent:!0}),e.trigger("reset",e)):r&&e.recountTotals()},resetState:function(){this.allMrps=null,this.serializedList=null,this.serializedMap=null,this.totalQuantities={all:u()}}},{STATUSES:o,STATUS_ORDERS:{new:0,started:1,partial:2,finished:3,cancelled:4},forDate:function(e,i){return new this(null,t.assign({rqlQuery:"sort(name)&limit(0)&date="+e},i))}})});