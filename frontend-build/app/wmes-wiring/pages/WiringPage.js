define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/util/bindLoadingMessage","app/core/util/embedded","app/core/util/pageActions","../WiringOrder","../WiringOrderCollection","../WiringSettingCollection","../views/FilterView","../views/ListView","../views/DatePickerView","../views/UserPickerView","app/wmes-wiring/templates/page","app/wmes-wiring/templates/userPageAction"],function(e,t,i,s,r,n,o,a,l,d,c,u,h,f,g,p,w,m,b){"use strict";return o.extend({template:m,layoutName:"page",pageId:"wiring",modelProperty:"orders",breadcrumbs:function(){return[this.t("BREADCRUMBS:base"),{href:"#wiring/"+this.orders.getDateFilter(),label:this.orders.getDateFilter("L"),template:function(e){return'<span class="wiring-breadcrumb"><a class="fa fa-chevron-left" data-action="prev"></a><a href="'+e.href+'" data-action="showPicker">'+e.label+'</a><a class="fa fa-chevron-right" data-action="next"></a></span>'}}]},actions:function(){var e=this,t=[];return l.isEnabled()?t.push({id:"user",template:function(){return b({signedIn:!!e.orders.user,user:e.orders.user})},afterRender:function(t){t.find(".is-clickable").on("click",e.showUserPickerDialog.bind(e))}}):t.push({type:"link",icon:"arrows-alt",callback:e.toggleFullscreen.bind(e)},{href:"#wiring;settings?tab=planning",icon:"cogs",label:e.t("PAGE_ACTIONS:settings"),privileges:"WIRING:MANAGE"}),t},localTopics:{"socket.connected":function(){this.$el.removeClass("wiring-is-disconnected")},"socket.disconnected":function(){this.$el.addClass("wiring-is-disconnected")}},remoteTopics:{"wiring.orders.changed.*":function(e){var t=this.orders.getDateFilter();s.utc.format(e.date,"YYYY-MM-DD")===t&&this.orders.applyChanges(e.changes)},"wiring.orders.updated.*":function(e){var t=this.orders.get(e._id);t&&(t.set(c.parse(e)),null==e.qty&&null==e.qtyDone&&null==e.status||this.orders.recountTotals())}},events:{},initialize:function(){this.onResize=e.debounce(this.resize.bind(this),30),this.defineModels(),this.defineViews(),this.once("afterRender",this.defineBindings)},setUpLayout:function(e){this.layout=e},destroy:function(){t(document.body).removeClass("wiring-is-fullscreen wiring-is-embedded"),t(window).off("."+this.idPrefix),t(document).off("."+this.idPrefix)},defineModels:function(){this.settings=a(new h(null,{pubsub:this.pubsub}),this),this.orders=a(u.forDate(this.options.date,{mrp:this.options.mrp,status:this.options.status,settings:this.settings,user:JSON.parse(sessionStorage.getItem("WMES_WIRING_USER")||"null")}),this)},defineViews:function(){this.filterView=new f({orders:this.orders}),this.listView=new g({orders:this.orders}),this.setView("#-filter",this.filterView),this.setView("#-list",this.listView)},defineBindings:function(){var e=this.idPrefix;this.listenTo(this.orders,"reset",this.onOrdersReset),this.listenTo(this.orders,"filter:status filter:mrp",this.onFilter),t(document).on("click."+e,".wiring-breadcrumb",this.onBreadcrumbsClick.bind(this)),t(window).on("resize."+e,this.onResize),l.ready(),this.onOrdersReset()},load:function(e){return e(this.settings.fetch({reset:!0}),this.orders.fetch({reset:!0}))},getTemplateData:function(){return{embedded:l.isEnabled()}},serializeTotals:function(){return this.orders.serializeTotals()},beforeRender:function(){document.body.classList.toggle("wiring-is-fullscreen",this.isFullscreen()),document.body.classList.toggle("wiring-is-embedded",l.isEnabled())},afterRender:function(){l.render(this),this.resize()},resize:function(){document.body.classList.toggle("wiring-is-fullscreen",this.isFullscreen())},isFullscreen:function(){return l.isEnabled()||this.options.fullscreen||window.innerWidth<=800||window.outerWidth===window.screen.width&&window.outerHeight===window.screen.height},toggleFullscreen:function(){this.options.fullscreen=!this.options.fullscreen,this.updateUrl(),this.resize()},updateUrl:function(){l.isEnabled()||this.broker.publish("router.navigate",{url:this.genClientUrl(),trigger:!1,replace:!0})},genClientUrl:function(){var e=[];return"all"!==this.orders.filters.mrp&&e.push("mrp="+this.orders.filters.mrp),this.orders.filters.status.length&&e.push("status="+this.orders.filters.status),this.options.fullscreen&&e.push("fullscreen=1"),this.orders.genClientUrl()+(e.length?"?":"")+e.join("&")},onOrdersReset:function(){this.layout&&this.layout.setBreadcrumbs(this.breadcrumbs,this),this.updateUrl()},onFilter:function(){this.updateUrl()},onBreadcrumbsClick:function(e){if("A"===e.target.tagName)return!e.target.classList.contains("disabled")&&("showPicker"===e.target.dataset.action?this.showDatePickerDialog():this.selectNonEmptyDate(e.target.dataset.action),!1)},setDate:function(e){this.orders.setDateFilter(e),this.promised(this.orders.fetch({reset:!0}))},showDatePickerDialog:function(){var e=new p({model:{date:this.orders.getDateFilter()}});this.listenTo(e,"picked",function(e){n.closeDialog(),e!==this.orders.getDateFilter()&&this.setDate(e)}),n.showDialog(e)},selectNonEmptyDate:function(e){t(".wiring-breadcrumb").find("a").addClass("disabled");var i=this,r=+i.orders.getDateFilter("x"),o="/wiring/orders?limit(1)&select(date)";o+="prev"===e?"&sort(-date)&date<"+r+"&date>"+(r-2592e6):"&sort(date)&date>"+r+"&date<"+(r+2592e6);var a=i.ajax({url:o});a.done(function(e){e.totalCount?i.setDate(s.utc.format(e.collection[0].date,"YYYY-MM-DD")):n.msg.show({type:"warning",time:2500,text:i.t("MSG:date:empty")})}),a.fail(function(){n.msg.show({type:"error",time:2500,text:i.t("MSG:date:failure")})}),a.always(function(){i.layout&&i.layout.setBreadcrumbs(i.breadcrumbs,i)})},showUserPickerDialog:function(){var e=this,t=new w({model:{user:e.orders.user}});e.listenTo(t,"picked",function(t){t?sessionStorage.setItem("WMES_WIRING_USER",JSON.stringify(t)):sessionStorage.removeItem("WMES_WIRING_USER"),e.orders.user=t,e.layout&&e.layout.setActions(e.actions,e),n.closeDialog()}),n.showDialog(t)}})});