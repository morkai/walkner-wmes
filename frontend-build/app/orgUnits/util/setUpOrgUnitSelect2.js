define(["underscore","select2","app/broker","app/data/orgUnits"],function(e,t,i,n){"use strict";var r={prodFlow:!0,subdivision:!0},o={};function s(e){return o[e]=n.getAllByType(e).map(function(t){return{id:t.id,text:r[e]?t.get("name"):t.get("description"),model:t}}).sort(function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0})}),o[e]}return function(a,l){if(!a||!a.length)throw new Error("Unspecified $input!");l=e.assign({orgUnitType:"prodLine"},l);var u=!0===r[l.orgUnitType],p=!!l.idOnly,d=0,c=o[l.orgUnitType];if(!c){var m=n.getCollection(l.orgUnitType).model.topicPrefix;i.subscribe(m+".synced",s.bind(null,l.orgUnitType)),c=s(l.orgUnitType)}var f={};return c=c.filter(function(e){if(!l.showDeactivated&&e.model.get("deactivatedAt"))return!1;if(l.itemFilter&&!l.itemFilter(e))return!1;if(e.id.length>d&&(d=e.id.length),"subdivision"===l.orgUnitType){var t=e.model.get("division");f[t]||(f[t]=[]),f[t].push(e)}return!0}),"subdivision"===l.orgUnitType&&(c=Object.keys(f).map(function(e){return{text:e,children:f[e]}})),a.removeClass("form-control").select2(e.assign({width:"100%",allowClear:!0,multiple:!1,data:c,minimumResultsForSearch:1,matcher:function(e,t,i){return e=e.toUpperCase(),!u&&i.id.toUpperCase().indexOf(e)>=0||i.text.toUpperCase().indexOf(e)>=0},formatSelection:function(t){return t.model?"subdivision"===l.orgUnitType?e.escape(t.model.get("division")+" \\ "+t.model.get("name")):e.escape(u?t.text:t.id):null},formatResult:function(e,i,n,r){var o=[];if(!u||""===e.text){for(var s=e.id;s.length<d;)s+=" ";if(o.push('<span class="text-mono">'),n.term.length?t.util.markMatch(s,n.term,o,r):o.push(r(s)),p)return o.join("")+"</span>"}return""===e.text?o.push("</span>"):u?n.term.length?t.util.markMatch(e.text,n.term,o,r):o.push(r(e.text)):(o.push('</span><span class="text-small">: '),n.term.length?t.util.markMatch(e.text,n.term,o,r):o.push(r(e.text)),o.push("</span>")),o.join("")}},l)),a}});