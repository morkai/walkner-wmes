define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/core/util/idAndLabel","app/data/orgUnits","./OrgUnitPickerDialogView","app/orgUnits/templates/pickerButton","i18n!app/nls/orgUnits"],function(i,e,t,n,r,o,s,l,a){"use strict";var p={division:"division",subdivision:"subdivision",mrpControllers:"mrpControllers",prodFlow:"prodFlow",workCenter:"workCenter",prodLine:"prodLine"};return r.extend({template:a,events:{"click #-showDialog":function(){var e=new l({model:{divisionFilter:this.options.divisionFilter,subdivisionFilter:this.options.subdivisionFilter,resolveLabel:this.resolveLabel.bind(this),orgUnitTypes:this.options.orgUnitTypes,orgUnitType:this.model.type,orgUnitIds:i.pluck(this.model.units,"id")}});this.listenTo(e,"picked",function(i,e){n.closeDialog(),0===e.length?(this.model.type=null,this.model.units=[]):(this.model.type=i,this.model.units=e.map(function(e){return s.getByTypeAndId(i,e)})),this.render()}),n.showDialog(e,t("orgUnits","picker:dialog:title"))},"click #-clear":function(){this.model={type:null,units:[]},this.render()}},initialize:function(){var e=this;e.termToType={},e.typeToTerm={},i.forEach(e.options.orgUnitTerms||p,function(i,t){e.termToType[t]=i,e.typeToTerm[i]=t}),e.model=e.getOrgUnitsFromRql(),e.listenTo(e.filterView,"filtering",e.onFiltering),e.listenTo(e.filterView,"filterChanged",e.onFilterChanged)},serialize:function(){var i=this.model;return{idPrefix:this.idPrefix,active:!!i.type,label:this.resolveLabel(i.type),button:i.type?i.units.map(function(e){var t=e.getLabel();return"subdivision"===i.type&&(t=e.get("division")+" > "+t),t}).join("; "):t("orgUnits","picker:any")}},resolveLabel:function(i){if(!i)return t("orgUnits","picker:label");var e=this.options.orgUnitLabels;return e&&e[i]?String(e[i]):t("core","ORG_UNIT:"+i)},getOrgUnitsFromRql:function(){var i="array"===this.options.mode,e=this.termToType,t=null,n=[];return this.filterView.model.rqlQuery.selector.args.forEach(function(r){t||(i&&"orgUnit"===r.name?(n=[].concat(r.args),t=e[n.shift()]):"eq"!==r.name&&"in"!==r.name||(t=e[r.args[0]],n=Array.isArray(r.args[1])?r.args[1]:[r.args[1]]))}),{type:n.length?t:null,units:n.map(function(i){return s.getByTypeAndId(t,i)}).filter(function(i){return!!i})}},onFiltering:function(e){if(this.model.type&&this.model.units.length){var t=i.pluck(this.model.units,"id");"array"===this.options.mode?e.push({name:"orgUnit",args:[this.typeToTerm[this.model.type]].concat(t)}):e.push({name:1===t.length?"eq":"in",args:[this.typeToTerm[this.model.type],1===t.length?t[0]:t]})}}})});