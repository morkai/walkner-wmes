define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/core/util/idAndLabel","app/data/orgUnits","./OrgUnitPickerDialogView","app/orgUnits/templates/pickerButton","i18n!app/nls/orgUnits"],function(i,t,e,n,r,o,s,l,a){"use strict";var p={division:"division",subdivision:"subdivision",mrpControllers:"mrpControllers",prodFlow:"prodFlow",workCenter:"workCenter",prodLine:"prodLine"};return r.extend({template:a,events:{"click #-showDialog":function(){var t=new l({model:{orgUnitTypes:this.options.orgUnitTypes,orgUnitType:this.model.type,orgUnitIds:i.pluck(this.model.units,"id")}});this.listenTo(t,"picked",function(i,t){n.closeDialog(),0===t.length?(this.model.type=null,this.model.units=[]):(this.model.type=i,this.model.units=t.map(function(t){return s.getByTypeAndId(i,t)})),this.render()}),n.showDialog(t,e("orgUnits","picker:dialog:title"))},"click #-clear":function(){this.model={type:null,units:[],labels:[]},this.render()}},initialize:function(){this.model=this.getOrgUnitsFromRql(),this.listenTo(this.filterView,"filtering",this.onFiltering),this.listenTo(this.filterView,"filterChanged",this.onFilterChanged)},serialize:function(){var i=this.model;return{idPrefix:this.idPrefix,active:!!i.type,label:i.type?e("core","ORG_UNIT:"+i.type):e("orgUnits","picker:label"),button:i.type?i.units.map(function(t){var e=t.getLabel();return"subdivision"===i.type&&(e=t.get("division")+" > "+e),e}).join("; "):e("orgUnits","picker:any")}},getOrgUnitsFromRql:function(){var i="array"===this.options.mode,t=null,e=[];return this.filterView.model.rqlQuery.selector.args.forEach(function(n){t||(i||"eq"!==n.name&&"in"!==n.name?i&&"orgUnit"===n.name&&(e=[].concat(n.args),t=p[e.shift()]):(t=p[n.args[0]],e=Array.isArray(n.args[1])?n.args[1]:[n.args[1]]))}),{type:e.length?t:null,units:e.map(function(i){return s.getByTypeAndId(t,i)}).filter(function(i){return!!i})}},onFiltering:function(t){if(this.model.type&&this.model.units.length){var e=i.pluck(this.model.units,"id");"array"===this.options.mode?t.push({name:"orgUnit",args:[this.model.type].concat(e)}):t.push({name:1===e.length?"eq":"in",args:[this.model.type,1===e.length?e[0]:e]})}}})});