// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","dragscroll","app/core/views/FormView","app/core/util/idAndLabel","app/opinionSurveyResponses/templates/form","app/opinionSurveyResponses/templates/formAnswer"],function(e,t,i,s,r,o){"use strict";return i.extend({template:r,events:e.extend({"change #-survey":function(e){this.selectSurvey(e.added.id)},"click .nav-tabs a":function(e){e.preventDefault(),this.$(e.target).tab("show")}},i.prototype.events),destroy:function(){i.prototype.destroy.call(this),t.destroy()},serialize:function(){return e.extend(i.prototype.serialize.call(this),{omrResults:(this.model.omrResults||[]).map(function(e){return{_id:e.get("_id"),pageNumber:e.get("pageNumber")}})})},afterRender:function(){i.prototype.afterRender.call(this),this.$id("survey").select2({minimumResultsForSearch:5,data:this.model.surveys.map(s)}),this.options.editMode?(this.selectSurvey(this.model.get("survey")._id),this.$id("comment").focus()):this.model.surveys.length?(this.selectSurvey(this.model.surveys.at(0).id),this.$id(1===this.model.surveys.length?"comment":"survey").focus()):(this.setUpEmployerSelect2([]),this.setUpSuperiorSelect2([]),this.$id("survey").focus()),this.options.fixing&&this.$('[type="submit"]').click(),this.model.omrResults&&this.model.omrResults.length&&(this.activatePreviewTab(this.model.omrResults.at(0).id),this.resizePreview(),t.reset())},activatePreviewTab:function(e){this.$('.nav-tabs > li[data-tab="'+e+'"] > a').tab("show")},resizePreview:function(){var e=this.$id("fields").outerHeight(),t=this.$('a[data-toggle="tab"]').outerHeight(),i=e-t;this.$id("preview").css("height",i+"px")},setUpEmployerSelect2:function(e){this.$id("employer").select2({minimumResultsForSearch:5,data:e.map(function(e){return{id:e._id,text:e.full}})})},setUpSuperiorSelect2:function(e){this.$id("superior").select2({minimumResultsForSearch:5,data:e.map(function(e){return{id:e._id,text:e.full+" ("+e.division+")",division:e.division}})})},selectSurvey:function(e){var t=this.model.surveys.get(e);if(t){this.setUpEmployerSelect2(t.get("employers")),this.setUpSuperiorSelect2(t.get("superiors"));var i=this.idPrefix,s=this.model.get("answers")||[],r=t.get("questions").map(function(e,t){return o({idPrefix:i,index:t,question:e,value:s[t]?s[t].answer:"na"})});this.$id("survey").select2("val",e),this.$id("answers").html(r.join(""))}},serializeForm:function(e){return e.division=this.$id("superior").select2("data").division,e},handleSuccess:function(){this.options.fixing?this.redirectToNext():i.prototype.handleSuccess.call(this)},redirectToNext:function(){var e=this.ajax({url:"/opinionSurveys/omrResults?select(_id)&status=unrecognized"}),t=this;e.fail(function(){t.broker.publish("router.navigate",{url:"#opinionSurveyOmrResults",trigger:!0})}),e.done(function(e){var i="#opinionSurveyOmrResults";e&&e.collection&&e.collection[0]&&(i+="/"+e.collection[0]._id),t.broker.publish("router.navigate",{url:i,trigger:!0})})}})});