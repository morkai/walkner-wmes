define(["app/user","app/viewport","app/core/views/ListView","app/planning/util/shift","../WhLineCollection","./RedirLineDialogView","./EditStartedPlanDialogView","app/wh-lines/templates/list","app/wh-lines/templates/row"],function(e,t,i,n,a,o,r,l,s){"use strict";return i.extend({template:l,localTopics:{"socket.connected":function(){this.refreshCollectionNow()}},remoteTopics:function(){var e={};return e[this.collection.getTopicPrefix()+".updated"]="onUpdated",e},events:Object.assign({'click a[data-action="redirLine"]':function(e){this.redirLine(this.$(e.currentTarget).closest(".list-item")[0].dataset.id)},'click a[data-action="editStartedPlan"]':function(e){this.editStartedPlan(this.$(e.currentTarget).closest(".list-item")[0].dataset.id)}},i.prototype.events),initialize:function(){i.prototype.initialize.apply(this,arguments),this.once("afterRender",function(){this.listenTo(this.collection,"filtered",this.render),this.listenTo(this.collection,"add change",this.renderRow)})},onUpdated:function(e){this.promised(this.collection.handleUpdate(e))},getTemplateData:function(){return{renderRow:this.renderPartialHtml.bind(this,s),canManage:a.can.manage()}},serializeRows:function(){var e=this,t=[],i={currentPlan:n.getPlanDate(Date.now(),!0).valueOf()};return e.collection.forEach(function(n){e.collection.isVisible(n)&&t.push(n.serializeRow(i))}),t},renderRow:function(e){var t=this.$row(e.id);if(this.collection.isVisible(e)){var i=this.renderPartial(s,{row:e.serializeRow(),canManage:a.can.manage()});if(t.length)t.replaceWith(i);else{var n=this.$(".list-item > td:first-child").get(),o=n.map(function(e){return e.textContent.trim()});o.push(e.id),o.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0,ignorePunctuation:!0})});var r=o.indexOf(e.id);n[r]?i.insertBefore(n[r].parentNode):this.$("tbody").append(i)}}else t.length&&t.remove()},redirLine:function(e){var i=this.collection.get(e);if(i&&!(t.currentDialog instanceof o&&t.currentDialog.model.sourceLine.id===e)){var n=new o({model:i});t.showDialog(n,this.t("redirLine:title:"+(i.get("redirLine")?"stop":"start")))}},editStartedPlan:function(e){var i=new r({model:this.collection.get(e)});t.showDialog(i,this.t("editStartedPlan:title"))}})});