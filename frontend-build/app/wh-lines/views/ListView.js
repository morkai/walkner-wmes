define(["jquery","app/user","app/viewport","app/core/views/ListView","app/planning/util/shift","app/wh-deliveredOrders/WhDeliveredOrderCollection","app/wh-deliveredOrders/views/ListView","app/wh/WhOrderCollection","../WhLineCollection","./RedirLineDialogView","./EditStartedPlanDialogView","./PickupOrderListView","app/wh-lines/templates/list","app/wh-lines/templates/row"],function(e,t,i,n,a,o,l,s,r,d,c,h,u,p){"use strict";return n.extend({template:u,localTopics:{"socket.connected":function(){this.refreshCollectionNow()}},remoteTopics:function(){var e={};return e[this.collection.getTopicPrefix()+".updated"]="onUpdated",e},events:Object.assign({'click a[data-action="redirLine"]':function(e){this.redirLine(this.$(e.currentTarget).closest(".list-item")[0].dataset.id)},'click a[data-action="editStartedPlan"]':function(e){this.editStartedPlan(this.$(e.currentTarget).closest(".list-item")[0].dataset.id)},"mousedown td[data-details]":function(e){1===e.button&&e.preventDefault()},"mouseup td[data-details]":function(e){var t=e.currentTarget,i=t.dataset.details,n=t.parentNode.dataset.id;if(2!==e.button&&"available"===i&&""===document.getSelection().toString()){if(t.dataset.mouseup=Math.round(e.timeStamp).toString(),1===e.button||0===e.button&&(e.ctrlKey||e.shiftKey)){var a="/#wh/deliveredOrders?sort(date,set,startTime)&limit(-1337)&status=in=(todo,blocked)&line="+encodeURIComponent(n);return window.open(a),!1}return 0===e.button?(this.collection.setDetails(i,n),!1):void 0}},"click td[data-details]":function(e){var t=e.currentTarget;if(""!==document.getSelection().toString()||t.dataset.mouseup===Math.round(e.timeStamp).toString())return!1;this.collection.setDetails(t.dataset.details,t.parentNode.dataset.id)}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),this.once("afterRender",function(){this.listenTo(this.collection,"filtered",this.onFiltered),this.listenTo(this.collection,"detailed",this.onDetailed),this.listenTo(this.collection,"add change",this.onChanged)}),e(window).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){n.prototype.destroy.apply(this,arguments),e(window).off("."+this.idPrefix)},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.toggleDetails()},onUpdated:function(e){this.promised(this.collection.handleUpdate(e))},getTemplateData:function(){return{renderRow:this.renderPartialHtml.bind(this,p),canManage:r.can.manage()}},serializeRows:function(){var e=this,t=[],i={currentPlan:a.getPlanDate(Date.now(),!0).valueOf()};return e.collection.forEach(function(n){e.collection.isVisible(n)&&t.push(n.serializeRow(i))}),t},renderRow:function(e){var t=this.$row(e.id);if(this.collection.isVisible(e)){var i=this.renderPartial(p,{row:e.serializeRow(),canManage:r.can.manage()}),n=this.collection.getDetails();if(n.type&&n.line===e.id){var a=i.find('td[data-details="'+n.type+'"]');a.length&&a.addClass("wh-lines-details-active")}if(t.length)t.replaceWith(i);else{var o=this.$(".list-item > td:first-child").get(),l=o.map(function(e){return e.textContent.trim()});l.push(e.id),l.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0,ignorePunctuation:!0})});var s=l.indexOf(e.id);o[s]?i.insertBefore(o[s].parentNode):this.$("tbody").append(i)}}else t.length&&t.remove()},redirLine:function(e){var t=this.collection.get(e);if(t&&!(i.currentDialog instanceof d&&i.currentDialog.model.sourceLine.id===e)){var n=new d({model:t});i.showDialog(n,this.t("redirLine:title:"+(t.get("redirLine")?"stop":"start")))}},editStartedPlan:function(e){var t=new c({model:this.collection.get(e)});i.showDialog(t,this.t("editStartedPlan:title"))},onWindowKeyDown:function(e){if("Escape"===e.key&&!i.currentDialog&&!this.$id("details-inner").find(".popover").length)return this.collection.setDetails(null,null),!1},onFiltered:function(){var e=this,t=e.collection.getDetails();if(t.line){var i=e.collection.get(t.line);i&&e.collection.isVisible(i)||e.collection.setDetails(null,null)}e.collection.forEach(function(t){e.renderRow(t)})},onDetailed:function(){this.toggleDetails()},onChanged:function(e){this.renderRow(e)},toggleDetails:function(){var e=this.collection.getDetails(),t=this.collection.get(e.line),i=this.$row(e.line),n=this.$id("details-outer"),a=this.$id("details-inner");if(this.$(".wh-lines-details-active").removeClass("wh-lines-details-active"),!t||!i.length)return n.addClass("hidden"),void this.removeView("#-details-outer");i.find('td[data-details="'+e.type+'"]').addClass("wh-lines-details-active"),a.html('<i class="fa fa-spinner fa-spin"></i><span>'),n.insertAfter(i).removeClass("hidden"),"available"===e.type?this.loadDeliveredOrders():this.loadPickupOrders(e.type)},loadDeliveredOrders:function(){var e=this.collection.getDetails(),t=new o([],{paginate:!1,rqlQuery:{selector:{name:"and",args:[{name:"in",args:["status",["todo","blocked"]]},{name:"eq",args:["line",e.line]}]}}});this.loadDetails(new l({collection:t,showLineColumn:!1}))},loadPickupOrders:function(e){var t=this.collection.getDetails(),i=new s([],{paginate:!1,date:null,rqlQuery:{selector:{name:"and",args:[{name:"in",args:["status",["started","finished","problem"]]},{name:"eq",args:["lines._id",t.line]},{name:"eq",args:["distStatus","pending"]}]},sort:{date:1,set:1,startTime:1}}});this.loadDetails(new h({collection:i,status:e,line:t.line}))},loadDetails:function(e){var t=this,i=e.promised(e.collection.fetch({reset:!0}));i.done(function(){t.setView("#-details-inner",e).render()}),i.fail(function(){e.remove(),t.$id("details-inner").find(".fa-spin").removeClass("fa-spin").css("color","red")})}})});