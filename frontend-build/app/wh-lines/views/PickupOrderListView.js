define(["underscore","app/user","app/time","app/core/views/ListView","i18n!app/nls/wh"],function(t,e,s,a){"use strict";return a.extend({className:"is-colored",localTopics:{"socket.connected":"refreshCollectionNow"},remoteTopics:{"old.wh.orders.changed.*":function(e){var s=this.options.line,a=this.collection;e.changes.removed.forEach(function(t){a.remove(t)}),e.changes.changed.forEach(function(t){var e=a.get(t._id);e&&e.set(t)}),e.changes.added.forEach(function(e){t.some(e.lines,function(t){return t._id===s})&&a.add(e)})},"old.wh.orders.updated":function(t){this.collection.update(t.updated||[])}},columns:function(){return[{id:"sapOrder",className:"is-min",label:this.t("wh","prop:order")},{id:"qty",className:"is-min text-right",tdClassName:"text-right",label:this.t("wh","prop:qty")},{id:"date",className:"is-min",label:this.t("wh","prop:plan")},{id:"set",className:"is-min text-center",label:this.t("wh","prop:set")},{id:"status",className:"is-min",label:this.t("wh","prop:whStatus")},"-"]},actions:null,initialize:function(){a.prototype.initialize.apply(this,arguments),this.once("afterRender",function(){this.listenTo(this.collection,"add change remove",this.render)})},serializeRows:function(){var e=this,s=[],a={};return e.collection.forEach(function(e){if(!e.get("setDistStarted")){var s=e.get("date")+":"+e.get("set");a[s]||(a[s]={status:"finished",orders:[]});var i=a[s],r=e.get("status");if("problem"===r)t.every(e.get("funcs"),function(t){return"problem"===t.status||"finished"===t.status})||(i.status="started");else"started"===r&&(i.status="started");i.orders.push(e)}}),t.forEach(a,function(t){t.status===e.options.status&&t.orders.forEach(function(t){s.push(e.serializeRow(t))})}),s},serializeRow:function(t){var a=t.get("set"),i={sapOrder:t.get("order"),qty:t.get("qty").toLocaleString(),date:s.utc.format(t.get("date"),"L"),set:a?a.toLocaleString():"?",status:this.t("wh","status:"+t.get("status"))};e.isAllowedTo("LOCAL","ORDERS:VIEW")&&(i.sapOrder='<a href="#orders/'+i.sapOrder+'" target="_blank">'+i.sapOrder+"</a>");var r=s.utc.format(t.get("date"),"YYYY-MM-DD");return e.isAllowedTo("WH:VIEW")&&(i.date='<a href="#wh/pickup/'+r+"?order="+(t.id||"")+'" target="_blank">'+i.date+"</a>",i.set='<a href="#wh/pickup/'+r+"?set="+(t.id||"")+'" target="_blank" style="display: block">'+i.set+"</a>"),i}})});