define(["underscore","app/user","app/core/Collection","app/core/util/getShiftStartInfo","app/data/localStorage","./WhLine"],function(e,t,i,n,l,r){"use strict";var s=["pickup","available","redirLine"];return i.extend({model:r,rqlQuery:"sort(_id)&limit(0)",initialize:function(e,t){this.filters={working:null,mrps:[]},this.details={type:null,line:null},this.on("filtered",function(){l.setItem("WMES_WH_LINES_FILTERS",JSON.stringify(this.filters))}),t&&t.filters&&this.setFilters(t.filters),t&&t.details&&this.setDetails(t.details.type,t.details.line)},getFilters:function(){return this.filters},setFilters:function(e){Object.assign(this.filters,e),this.trigger("filtered")},getDetails:function(){return this.details},setDetails:function(e,t){if(e&&t||(e=null,t=null),this.details.type===e&&this.details.line===t){if(!e)return;this.details={type:null,line:null}}else this.details={type:e,line:t};this.trigger("detailed",this.details)},isVisible:function(e){var t=this.filters;return(null===t.working||e.get("working")===t.working)&&!(t.mrps.length&&!e.get("mrps").some(function(e){return t.mrps.includes(e)}))},comparator:function(e,t){return e.id.localeCompare(t.id,void 0,{numeric:!0,ignorePunctuation:!0})},handleUpdate:function(t){var i=this,n=!1;return t.added&&i.add(t.added,{merge:!0}),t.deleted&&t.deleted.forEach(function(e){i.remove(e._id)}),t.updated&&t.updated.forEach(function(t){var l=i.get(t._id);l?l.set(t):!n&&e.intersection(Object.keys(t),s).length&&(n=!0)}),n?i.fetch():null}},{can:{manage:function(){return t.isAllowedTo("WH:MANAGE","PLANNING:MANAGE","PLANNING:PLANNER")},redir:function(){return this.manage()}},fromQuery:function(e){var t=JSON.parse(l.getItem("WMES_WH_LINES_FILTERS")||"{}"),i={type:null,line:null};if(Object.keys(e).length&&(t.working="1"===e.working||"0"!==e.working&&null,t.mrps=(e.mrps||"").split(",").filter(function(e){return!!e.length})),e.details){var n=e.details.match(/^(started|finished|available)_(.*?)$/);n&&(i.type=n[1],i.line=n[2])}return new this(null,{filters:t,details:i})}})});