define(["underscore","app/time","app/data/orgUnits","app/data/prodFunctions","app/core/util/idAndLabel","app/core/views/FormView","app/wmes-fap-categories/templates/form"],function(i,t,n,e,o,s,a){"use strict";return s.extend({template:a,events:i.assign({"click #-addNotification":function(){this.addNotification({subdivisions:[],prodFunctions:[]}),this.$id("notifications").children().last().find("input").first().focus()},'click [data-action="removeNotification"]':function(i){var t=this.$(i.target).closest("tr");t.find("input").select2("destroy"),t.remove()},"input #-notifiedUsers-mrp":"testNotifications","change #-notifiedUsers-date":"testNotifications",'change input[name^="notifications"]':"testNotifications"},s.prototype.events),initialize:function(){s.prototype.initialize.apply(this,arguments),this.i=0,this.subdivisions=n.getAllByType("division").map(function(i){var t=i.getLabel();return{text:t,children:n.getChildren(i).map(function(i){return{id:i.id,text:i.getLabel(),divisionText:t}})}}),this.prodFunctions=e.map(o)},afterRender:function(){s.prototype.afterRender.apply(this,arguments),this.$notification=this.$id("notifications").children().first().detach(),this.$notifiedUser=this.$id("notifiedUsers").children().first().detach(),(this.model.get("notifications")||[]).forEach(this.addNotification,this),this.addNotification({subdivisions:[],prodFunctions:[]})},addNotification:function(i){var t=this.$notification.clone(),n=++this.i;t.find('input[name$="subdivisions"]').prop("name","notifications["+n+"].subdivisions").val(i.subdivisions.join(",")).select2({width:"500px",placeholder:" ",allowClear:!0,multiple:!0,data:this.subdivisions,formatSelection:function(i,t,n){return n(i.divisionText+" \\ "+i.text)}}),t.find('input[name$="prodFunctions"]').prop("name","notifications["+n+"].prodFunctions").val(i.prodFunctions.join(",")).select2({width:"500px",placeholder:" ",allowClear:!0,multiple:!0,data:this.prodFunctions}),this.$id("notifications").append(t)},serializeForm:function(i){return i.notifications=(i.notifications||[]).map(function(i){return{subdivisions:(i.subdivisions||"").split(",").filter(function(i){return!!i.length}),prodFunctions:(i.prodFunctions||"").split(",").filter(function(i){return!!i.length})}}).filter(function(i){return!!i.prodFunctions.length}),i},testNotifications:function(){var n=this;n.testReq&&n.testReq.abort();var o=n.$id("notifiedUsers-mrp").val(),s=n.$id("notifiedUsers-date").val(),a=n.getFormData().notifications;if(!(o.length<3)&&a.length){var r=t.getMoment(s,"YYYY-MM-DD[T]HH:mm");r.isValid()&&(s=r.valueOf()),n.testReq=n.ajax({method:"POST",url:"/fap/entries;resolve-participants",data:JSON.stringify({mrp:o,date:s,notifications:a,category:null})}),n.testReq.fail(function(){n.$id("notifiedUsers").empty()}),n.testReq.done(function(t){var o="";t.collection.forEach(function(t){var s=e.get(t.prodFunction);o+='<tr><td class="is-min">'+i.escape(t.lastName)+" "+i.escape(t.firstName)+'</td><td class="is-min">'+i.escape(s?s.getLabel():t.prodFunction)+'</td><td class="is-min">'+i.escape(t.kdPosition)+'</td><td class="is-min">'+n.t("core","BOOL:"+t.sms)+"</td><td></td>"}),n.$id("notifiedUsers").html(o)}),n.testReq.always(function(){n.testReq=null})}}})});