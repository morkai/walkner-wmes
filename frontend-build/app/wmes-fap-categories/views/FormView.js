define(["underscore","select2","app/time","app/data/orgUnits","app/data/prodFunctions","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/wmes-fap-entries/dictionaries","app/wmes-fap-categories/templates/form"],function(t,e,i,n,o,s,a,r,c,d){"use strict";return a.extend({template:d,events:t.assign({"click #-addNotification":function(){this.addNotification({subdivisions:[],prodFunctions:[]}),this.$id("notifications").children().last().find("input").first().focus()},'click [data-action="removeNotification"]':function(t){var e=this.$(t.target).closest("tr");e.find("input").select2("destroy"),e.remove(),this.testNotifications()},"input #-tester-mrp, #-tester-orderNo, #-tester-nc12":"testNotifications","change #-tester-date":"testNotifications",'change input[name="users"]':"testNotifications",'change input[name^="notifications"]':"testNotifications","change #-etoCategoryToggle":"toggleEtoCategory","click #-reqFields td":function(t){var e=this.$(t.target).find("input")[0];e&&(e.checked=!e.checked)}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),this.i=0,this.subdivisions=n.getAllByType("division").map(function(t){var e=t.getLabel();return{text:e,children:n.getChildren(t).map(function(t){return{id:t.id,text:t.getLabel(),divisionText:e}})}}),this.prodFunctions=o.map(s)},getTemplateData:function(){return{subdivisionTypes:c.subdivisionTypes,reqFields:c.reqFields}},afterRender:function(){a.prototype.afterRender.apply(this,arguments),r(this.$id("users"),{view:this,multiple:!0}),this.$notification=this.$id("notifications").children().first().detach(),this.$notifiedUser=this.$id("tester").children().first().detach(),(this.model.get("notifications")||[]).forEach(this.addNotification,this),this.addNotification({subdivisions:[],prodFunctions:[]}),this.setUpEtoCategorySelect2(),this.toggleEtoCategory()},setUpEtoCategorySelect2:function(){var i=this;i.$id("etoCategory").select2({allowClear:!0,placeholder:" ",data:c.categories.filter(function(t){return t.id!==i.model.id&&(t.get("active")||t.id===i.model.get("etoCategory"))}).sort(function(t,e){return t.attributes.active&&e.attributes.active?t.attributes.name.localeCompare(e.attributes.name):t.attributes.active?-1:1}).map(function(t){return{id:t.id,text:t.getLabel(),deactivated:!t.get("active")}}),formatSelection:function(e){var i=t.escape(e.selection||e.text);return e.deactivated?'<span style="text-decoration: line-through">'+i+"</span>":i},formatResult:function(t,i,n,o){var s=[];return s.push('<span style="text-decoration: '+(t.deactivated?"line-through":"initial")+'">'),e.util.markMatch(t.selection||t.text,n.term,s,o),s.push("</span>"),s.join("")}})},toggleEtoCategory:function(){this.$id("etoCategory").select2("enable",this.$id("etoCategoryToggle").prop("checked"))},addNotification:function(t){var e=this.$notification.clone(),i=++this.i;e.find('input[name$="subdivisions"]').prop("name","notifications["+i+"].subdivisions").val(t.subdivisions.join(",")).select2({width:"500px",placeholder:" ",allowClear:!0,multiple:!0,data:this.subdivisions,formatSelection:function(t,e,i){return i(t.divisionText+" \\ "+t.text)}}),e.find('input[name$="prodFunctions"]').prop("name","notifications["+i+"].prodFunctions").val(t.prodFunctions.join(",")).select2({width:"500px",placeholder:" ",allowClear:!0,multiple:!0,data:this.prodFunctions}),this.$id("notifications").append(e)},serializeToForm:function(){var t=this.model.toJSON();return t.users=(t.users||[]).map(function(t){return t.id}).join(","),t.etoCategoryToggle=null!=t.etoCategory,t},serializeForm:function(t){return t.users=(this.$id("users").select2("data")||[]).map(function(t){return{id:t.id,label:t.text}}),t.notifications=(t.notifications||[]).map(function(t){return{subdivisions:(t.subdivisions||"").split(",").filter(function(t){return!!t.length}),prodFunctions:(t.prodFunctions||"").split(",").filter(function(t){return!!t.length})}}).filter(function(t){return!!t.prodFunctions.length}),t.etoCategoryToggle?t.etoCategory||(t.etoCategory=""):t.etoCategory=null,delete t.etoCategoryToggle,t},testNotifications:function(){var e=this;e.testReq&&e.testReq.abort();var n=e.$id("tester-mrp").val(),s=e.$id("tester-orderNo").val(),a=e.$id("tester-nc12").val(),r=e.$id("tester-date").val(),c=e.getFormData();if(!(n.length<3&&s.length<9)){var d=i.getMoment(r,"YYYY-MM-DD[T]HH:mm");d.isValid()&&(r=d.valueOf()),e.testReq=e.ajax({method:"POST",url:"/fap/entries;resolve-participants",data:JSON.stringify({mrp:n,orderNo:s,nc12:a,date:r,users:c.users,notifications:c.notifications,category:null,subCategory:null})}),e.testReq.fail(function(){e.$id("tester").empty()}),e.testReq.done(function(i){var n="";i.users.forEach(function(i){var s=o.get(i.prodFunction);n+='<tr><td class="is-min">'+t.escape(i.lastName)+" "+t.escape(i.firstName)+'</td><td class="is-min">'+t.escape(s?s.getLabel():i.prodFunction)+'</td><td class="is-min">'+t.escape(i.syncData&&i.syncData.jobTitle||"")+'</td><td class="is-min">'+e.t("core","BOOL:"+i.sms)+"</td><td></td>"}),e.$id("tester").html(n)}),e.testReq.always(function(){e.testReq=null})}}})});