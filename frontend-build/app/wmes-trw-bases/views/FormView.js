define(["underscore","jquery","jsplumb","app/viewport","app/core/Model","app/core/views/FormView","app/core/util/idAndLabel","app/planning/util/contextMenu","app/wmes-trw-tests/dictionaries","../Base","./ClusterFormView","./ClusterCellFormView","app/wmes-trw-bases/templates/form","app/wmes-trw-bases/templates/cluster"],function(t,e,s,i,r,o,l,n,a,u,c,d,h,p){"use strict";return o.extend({template:h,updateOnChange:!1,events:t.assign({"dblclick #-canvas":function(t){if(!this.tester)return!1;var e=t.offsetY+10-t.offsetY%10,s=t.offsetX+10-t.offsetX%10;this.showAddClusterDialog(e,s)},"contextmenu #-canvas":function(t){if(!this.tester)return!1;var e=t.offsetY+10-t.offsetY%10,s=t.offsetX+10-t.offsetX%10;return n.show(this,t.pageY,t.pageX,[{icon:"fa-plus",label:this.t("menu:addCluster"),handler:this.showAddClusterDialog.bind(this,e,s)}]),!1},"dblclick .trw-base-cell":function(e){if(!this.tester)return!1;var s=this.$(e.currentTarget),i=s.closest(".trw-base-cluster"),r=t.find(this.model.get("clusters"),function(t){return t._id===i[0].dataset.id});return this.showEditIoDialog(r,+s[0].dataset.row,+s[0].dataset.col),!1},"contextmenu .trw-base-cell":function(e){if(!this.tester)return!1;var s=this.$(e.currentTarget),i=s.closest(".trw-base-cluster"),r=t.find(this.model.get("clusters"),function(t){return t._id===i[0].dataset.id});return n.show(this,e.pageY,e.pageX,[{icon:"fa-edit",label:this.t("menu:editIo"),handler:this.showEditIoDialog.bind(this,r,+s[0].dataset.row,+s[0].dataset.col)},"-",{icon:"fa-edit",label:this.t("menu:editCluster"),handler:this.showEditClusterDialog.bind(this,r)},{icon:"fa-arrows-h",label:this.t("menu:alignH"),handler:this.alignCluster.bind(this,r,"h")},{icon:"fa-arrows-v",label:this.t("menu:alignV"),handler:this.alignCluster.bind(this,r,"v")},{icon:"fa-times",label:this.t("menu:deleteCluster"),handler:this.model.deleteCluster.bind(this.model,r)}]),!1},"change #-tester":function(){this.loadTester()},"mouseenter .trw-base-cluster":function(t){this.showClusterPopover(t.currentTarget.dataset.id)},"mouseleave .trw-base-cluster":function(){this.hideClusterPopover()}},o.prototype.events),initialize:function(){o.prototype.initialize.apply(this,arguments),this.jsPlumb=null,this.tester=null,this.$clusterPopover=null,this.listenTo(this.model,"change:clusters",this.updateClusters)},destroy:function(){var t=this;t.hideClusterPopover(),t.jsPlumb&&(t.$(".trw-base-cluster").each(function(){t.jsPlumb.destroyDraggable(this)}),t.jsPlumb.reset(),t.jsPlumb=null)},afterRender:function(){o.prototype.afterRender.call(this),this.$id("tester").select2({data:a.testers.map(l)}),this.setUpJsPlumb(),this.loadTester()},setUpJsPlumb:function(){this.jsPlumb=s.getInstance({Container:this.$(".trw-base-canvas-outer")[0]})},loadTester:function(){var t=this,e=t.$id("tester").val();if(t.tester=null,t.model.get("clusters").forEach(function(e){t.deleteCluster(e)}),e.length){var s=t.ajax({url:"/trw/testers/"+e});s.fail(function(){i.msg.show({type:"error",time:1e4,text:t.t("FORM:ERROR:testerLoadingFailure")})}),s.done(function(e){t.tester={ioList:e.io,ioMap:{}},e.io.forEach(function(e){t.tester.ioMap[e._id]=e}),t.model.updateIo(t.tester.ioMap)})}},$cluster:function(t){return this.$('.trw-base-cluster[data-id="'+t+'"]')},updateClusters:function(t,e,s){switch(s.action){case"updateOne":this.updateCluster(s.newCluster);break;case"deleteOne":this.deleteCluster(s.cluster);break;case"updateIo":this.model.get("clusters").forEach(this.updateCluster,this)}},updateCluster:function(e){var s=this,i=e._id,r=s.$cluster(i),o=s.renderPartial(p,{cluster:e});r.length?(s.jsPlumb.destroyDraggable(r[0]),r.replaceWith(o)):s.$id("canvas").append(o),s.jsPlumb.draggable(o[0],{containment:!0,grid:[10,10],stop:function(e){var r=t.find(s.model.get("clusters"),function(t){return t._id===i});r&&(r.top=e.finalPos[1],r.left=e.finalPos[0])}})},deleteCluster:function(t){var e=this.$cluster(t._id);e.length&&(this.hideClusterPopover(t._id),this.jsPlumb.destroyDraggable(e[0]),e.remove())},alignCluster:function(t,e){var s=this.$id("canvas"),i=s.outerWidth(),r=s.outerHeight(),o=this.$cluster(t._id),l=o.outerWidth(),n=o.outerHeight();"h"===e?t.left=(i-l)/2:t.top=(r-n)/2,o.css({top:t.top+"px",left:t.left+"px"})},showAddClusterDialog:function(t,e){this.showEditClusterDialog({id:"",label:{text:"",position:"bottom"},top:t,left:e,connector:"na",image:"",rows:[]})},showEditClusterDialog:function(e){e=new r(t.clone(e));var s=new c({nlsDomain:this.model.nlsDomain,model:e});this.listenToOnce(e,"change",function(){this.model.updateCluster(e.toJSON())}),i.showDialog(s,this.t("clusterForm:title"))},showEditIoDialog:function(e,s,o){var l=e.rows[s];if(l){var n=l[o];if(n){n=new r(t.clone(n));var a=new d({nlsDomain:this.model.nlsDomain,io:this.tester.ioList,model:n});this.listenToOnce(n,"change",function(){(e=t.clone(e)).rows[s][o]=n.toJSON(),this.model.updateCluster(e)}),i.showDialog(a,this.t("clusterCellForm:title"))}}},showClusterPopover:function(t){var s=this;s.hideClusterPopover();var i=s.model.getCluster(t);i&&i.image&&(s.$clusterPopover=s.$cluster(t).popover({container:document.body,placement:"top",trigger:"manual",html:!0,content:function(){return'<img src="'+i.image+'">'},template:function(t){return e(t).addClass("trw-base-cluster-popover")}}),s.timers.showClusterPopover=setTimeout(function(){s.$clusterPopover&&s.$clusterPopover.popover("show")},333))},hideClusterPopover:function(t){clearTimeout(this.timers.showClusterPopover),this.$clusterPopover&&(t&&this.$clusterPopover[0].dataset.id!==t||(this.$clusterPopover.popover("destroy"),this.$clusterPopover=null))}})});