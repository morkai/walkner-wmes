define(["underscore","jsplumb","app/viewport","app/core/Model","app/core/views/FormView","app/core/util/idAndLabel","app/planning/util/contextMenu","app/wmes-trw-tests/dictionaries","../Base","./ClusterFormView","./ClusterCellFormView","app/wmes-trw-bases/templates/form","app/wmes-trw-bases/templates/cluster"],function(t,e,s,i,l,r,n,o,a,u,d,h,c){"use strict";return l.extend({template:h,events:t.assign({"dblclick #-canvas":function(t){if(!this.tester)return!1;var e=t.offsetY+10-t.offsetY%10,s=t.offsetX+10-t.offsetX%10;this.showAddClusterDialog(e,s)},"contextmenu #-canvas":function(t){if(!this.tester)return!1;var e=t.offsetY+10-t.offsetY%10,s=t.offsetX+10-t.offsetX%10;return n.show(this,t.pageY,t.pageX,[{icon:"fa-plus",label:this.t("menu:addCluster"),handler:this.showAddClusterDialog.bind(this,e,s)}]),!1},"dblclick .trw-base-cell":function(e){if(!this.tester)return!1;var s=this.$(e.currentTarget),i=s.closest(".trw-base-cluster"),l=t.find(this.model.get("clusters"),function(t){return t._id===i[0].dataset.id});return this.showEditIoDialog(l,+s[0].dataset.row,+s[0].dataset.col),!1},"contextmenu .trw-base-cell":function(e){if(!this.tester)return!1;var s=this.$(e.currentTarget),i=s.closest(".trw-base-cluster"),l=t.find(this.model.get("clusters"),function(t){return t._id===i[0].dataset.id});return n.show(this,e.pageY,e.pageX,[{icon:"fa-edit",label:this.t("menu:editIo"),handler:this.showEditIoDialog.bind(this,l,+s[0].dataset.row,+s[0].dataset.col)},"-",{icon:"fa-edit",label:this.t("menu:editCluster"),handler:this.showEditClusterDialog.bind(this,l)},{icon:"fa-arrows-h",label:this.t("menu:alignH"),handler:this.alignCluster.bind(this,l,"h")},{icon:"fa-arrows-v",label:this.t("menu:alignV"),handler:this.alignCluster.bind(this,l,"v")},{icon:"fa-times",label:this.t("menu:deleteCluster"),handler:this.model.deleteCluster.bind(this.model,l)}]),!1},"change #-tester":function(){this.loadTester()}},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.jsPlumb=null,this.tester=null,this.listenTo(this.model,"change:clusters",this.updateClusters)},destroy:function(){var t=this;t.jsPlumb&&(t.$(".trw-base-cluster").each(function(){t.jsPlumb.destroyDraggable(this)}),t.jsPlumb.reset(),t.jsPlumb=null)},afterRender:function(){l.prototype.afterRender.call(this),this.$id("tester").select2({data:o.testers.map(r)}),this.setUpJsPlumb(),this.loadTester()},setUpJsPlumb:function(){this.jsPlumb=e.getInstance({Container:this.$id("jsPlumb")[0]})},loadTester:function(){var t=this,e=t.$id("tester").val();if(t.tester=null,t.model.get("clusters").forEach(function(e){t.deleteCluster(e)}),e.length){var i=t.ajax({url:"/trw/testers/"+e});i.fail(function(){s.msg.show({type:"error",time:1e4,text:t.t("FORM:ERROR:testerLoadingFailure")})}),i.done(function(e){t.tester={ioList:e.io,ioMap:{}},e.io.forEach(function(e){t.tester.ioMap[e._id]=e}),t.model.updateIo(t.tester.ioMap)})}},$cluster:function(t){return this.$('.trw-base-cluster[data-id="'+t+'"]')},updateClusters:function(t,e,s){switch(s.action){case"updateOne":this.updateCluster(s.newCluster);break;case"deleteOne":this.deleteCluster(s.cluster);break;case"updateIo":this.model.get("clusters").forEach(this.updateCluster,this)}},updateCluster:function(e){var s=this,i=e._id,l=s.$cluster(i),r=s.renderPartial(c,{cluster:e});l.length?(s.jsPlumb.destroyDraggable(l[0]),l.replaceWith(r)):s.$id("canvas").append(r),s.jsPlumb.draggable(r[0],{containment:!0,grid:[10,10],stop:function(e){var l=t.find(s.model.get("clusters"),function(t){return t._id===i});l&&(l.top=e.finalPos[1],l.left=e.finalPos[0])}})},deleteCluster:function(t){var e=this.$cluster(t._id);e.length&&(this.jsPlumb.destroyDraggable(e[0]),e.remove())},alignCluster:function(t,e){var s=this.$id("canvas"),i=s.outerWidth(),l=s.outerHeight(),r=this.$cluster(t._id),n=r.outerWidth(),o=r.outerHeight();"h"===e?t.left=(i-n)/2:t.top=(l-o)/2,r.css({top:t.top+"px",left:t.left+"px"})},showAddClusterDialog:function(t,e){this.showEditClusterDialog({id:"",label:{text:"",position:"bottom"},top:t,left:e,rows:[]})},showEditClusterDialog:function(e){e=new i(t.clone(e));var l=new u({nlsDomain:this.model.nlsDomain,model:e});this.listenToOnce(e,"change",function(){this.model.updateCluster(e.toJSON())}),s.showDialog(l,this.t("clusterForm:title"))},showEditIoDialog:function(e,l,r){var n=e.rows[l];if(n){var o=n[r];if(o){o=new i(t.clone(o));var a=new d({nlsDomain:this.model.nlsDomain,io:this.tester.ioList,model:o});this.listenToOnce(o,"change",function(){(e=t.clone(e)).rows[l][r]=o.toJSON(),this.model.updateCluster(e)}),s.showDialog(a,this.t("clusterCellForm:title"))}}}})});