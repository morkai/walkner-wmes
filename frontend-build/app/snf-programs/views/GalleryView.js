define(["underscore","app/i18n","app/viewport","app/core/View","app/core/views/DialogView","./ImageView","./ImageFormView","app/snf-programs/templates/gallery","app/snf-programs/templates/galleryThumbnail","app/snf-programs/templates/yesNoDialog"],function(e,a,t,i,n,s,r,l,o,d){"use strict";return i.extend({template:l,events:{"click #-upload":function(){this.$id("files").click()},"change #-files":function(e){this.handleFiles(e.target.files)},dragenter:function(){return this.enterCount<=0?this.enterCount=1:++this.enterCount,!1},dragleave:function(){--this.enterCount,this.enterCount<=0&&this.$el.removeClass("is-valid is-invalid")},dragover:function(e){return this.$el.addClass(this.findImages(e.originalEvent.dataTransfer.items).length?"is-valid":"is-invalid"),!1},drop:function(e){return this.enterCount=0,this.$el.removeClass("is-valid is-invalid"),this.handleFiles(e.originalEvent.dataTransfer.files),!1},"click .snf-programs-image-edit":function(i){var n=this.$(i.target).closest(".thumbnail").attr("data-id"),s=new r({model:{programId:this.model.id,image:e.find(this.model.get("images"),function(e){return e._id===n})}});t.showDialog(s,a("snf-programs","gallery:edit:title"))},"click .snf-programs-image-delete":function(e){var a=this.$(e.target).closest(".thumbnail"),i=this,s=new n({template:d.bind(null,{severity:"danger",message:i.t("gallery:delete:message"),yes:i.t("gallery:delete:yes"),no:i.t("gallery:delete:no")})});s.on("answered",function(e){"yes"===e&&i.deleteImage(a)}),t.showDialog(s,i.t("gallery:delete:title"))},"click .thumbnail > a":function(a){var i=this.$(a.target).closest(".thumbnail").attr("data-id"),n=e.find(this.model.get("images"),function(e){return e._id===i});if(!n)return!1;var r=new s({model:{programId:this.model.id,image:n}});return t.showDialog(r),!1}},remoteTopics:{"snf.programs.*.images.*":function(e,a){var t=this.model;if(e.program===t.id){var i=t.get("images"),n=a.split(".").pop();switch(n){case"added":i=[].concat(i,e.images);break;case"deleted":i=i.filter(function(a){return a._id!==e.image});break;case"edited":for(var s=0;s<i.length;++s){if(i[s]._id===e.image._id){(i=[].concat(i))[s]=e.image;break}}}t.set("images",i,{action:n,message:e})}}},initialize:function(){this.enterCount=0,this.listenTo(this.model,"change:images",this.onImagesChanged)},getTemplateData:function(){return{program:this.model.toJSON()}},findImages:function(e){for(var a=[],t=0;t<e.length;++t){var i=e[t];/^image\/(jpeg|png|gif)$/.test(i.type)&&a.push(i)}return a},findThumbnail:function(e){return this.$('.thumbnail[data-id="'+e+'"]')},deleteImage:function(e){e.fadeOut("fast"),e.find(".btn").attr("disabled",!0);var a=e.attr("data-id");this.ajax({type:"DELETE",url:"/snf/programs/"+this.model.id+"/images/"+a}).fail(function(){e.find(".btn").attr("disabled",!1),e.fadeIn("fast")})},handleFiles:function(e){var a=this.findImages(e);if(a.length){for(var t={},i=0;i<a.length;++i){var n=a[i],s=Date.now().toString(36).toUpperCase()+(1e9+1e9*Math.random()).toString(36).replace(".","").substr(0,10).toUpperCase();this.createImageThumbnail(n,s),t[s]=n}this.uploadImageFiles(t)}},createImageThumbnail:function(e,a){if(!this.findThumbnail(a).length){var t=this.renderPartial(o,{program:{_id:this.model.id},image:{_id:a,type:this.resolveImageType(e.type),label:e.name.replace(/\..*?$/,"")}}),i=t.find("img")[0];if(e.size){i.src="";var n=new FileReader;n.onload=function(e){i.src=e.target.result},n.readAsDataURL(e),t.addClass("is-uploading").appendTo(this.$(".panel-body"))}else t.hide().appendTo(this.$(".panel-body")).fadeIn("fast").find("a")}},resolveImageType:function(e){switch(e){case"image/jpeg":return"jpg";case"image/png":return"png";case"image/gif":return"gif";default:return e}},uploadImageFiles:function(a){var t=new FormData;e.forEach(a,function(e,a){t.append(a,e)});var i=this.ajax({type:"POST",url:"/snf/programs/"+this.model.id+"/images",data:t,processData:!1,contentType:!1}),n=this;i.fail(function(){Object.keys(a).forEach(function(e){var a=n.findThumbnail(e);a.fadeOut("fast",function(){a.remove()})})}),i.done(function(){Object.keys(a).forEach(function(e){n.findThumbnail(e).removeClass("is-uploading")})})},onImagesChanged:function(e,a,t){var i,n=t.message;switch(t.action){case"added":n.images.forEach(function(e){var a={type:e.type,name:e.label+"."+e.type};this.createImageThumbnail(a,e._id)},this);break;case"deleted":(i=this.findThumbnail(n.image._id)).length&&i.fadeOut("fast",function(){i.remove()});break;case"edited":this.findThumbnail(n.image._id).find(".thumbnail-label").text(n.image.label)}}})});