// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["backbone","h5.rql/specialOperators","app/broker","app/viewport","app/time","app/core/Router","app/core/pages/ErrorPage"],function(r,e,t,a,o,s,i){"use strict";r.Router.prototype._extractParameters=function(r,e){return r.exec(e).slice(1)};var u=new s(t),c=new r.Router;c.route("*catchall","catchall",function(r){u.dispatch(r)}),t.subscribe("router.navigate",function(r){var e=r.url,t=e.charAt(0);"#"!==t&&"/"!==t||(e=e.substr(1));var a=!0===r.trigger,o=!0===r.replace;c.navigate(e,{trigger:a,replace:o}),!a&&o&&u.setCurrentRequest(e)});return t.subscribe("router.404",function(r){var e=r.req;"/404"===e.path?a.showPage(new i({model:{code:404,req:e,previousUrl:u.previousUrl}})):u.dispatch("/404")}),t.subscribe("viewport.page.loadingFailed",function(r){a.showPage(new i({model:{code:r.xhr?r.xhr.status:0,req:u.currentRequest,previousUrl:u.previousUrl,xhr:r.xhr}}))}),t.subscribe("router.dispatching",function(r){var e=JSON.parse(localStorage.WMES_RECENT_DISPATCH||"[]");e.push(o.getMoment().format("YYYY-MM-DD, HH:mm:ss")+" "+r.url),e.length>10&&e.shift(),localStorage.WMES_RECENT_DISPATCH=JSON.stringify(e)}),window.router=u,u});