// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["../broker","../pubsub","../core/Model","./FactoryLayoutSettingCollection","./ProdLineState","./ProdLineStateCollection","./FactoryLayout"],function(t,e,n,o,s,u,r){function i(t){if(l)return c.push(t);var e=b.prodLineStates.get(t._id);e&&t.v>e.get("v")&&e.update(t)}var a=6e4,c=[],l=!1,d=!1,p=null,b=new n;return window.productionState=b,b.pubsub=null,b.url="/production/state",b.settings=new o,b.factoryLayout=new r,b.prodLineStates=new u,b.parse=function(t){return t.settings&&this.settings.reset(t.settings),Array.isArray(t.prodLineStates)&&this.prodLineStates.reset(t.prodLineStates.map(s.parse)),t.factoryLayout&&this.factoryLayout.set(t.factoryLayout),{}},b.load=function(t){return null!==p&&(clearTimeout(p),p=null),!d||t?(null===b.pubsub&&(b.pubsub=e.sandbox(),b.pubsub.subscribe("production.stateChanged.**",i),b.settings.setUpPubsub(b.pubsub)),b.fetch()):void 0},b.unload=function(){d&&(null!==p&&clearTimeout(p),p=setTimeout(function(){null!==b.pubsub&&(b.pubsub.destroy(),b.pubsub=null),b.prodLineStates.reset([]),b.settings.reset([]),p=null,d=!1},a))},b.on("request",function(){l=!0}),b.on("sync",function(){l=!1,d=!0,c.forEach(i),c=[]}),b.on("error",function(){l=!1,d=!1,c=[],b.prodLineStates.reset([])}),["divisions","subdivisions","mrpControllers","prodFlows","workCenters","prodLines"].forEach(function(e){t.subscribe(e+".synced",function(){b.load(!0)})}),b});