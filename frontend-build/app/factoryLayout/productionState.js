// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["../pubsub","../core/Model","./ProdLineState","./ProdLineStateCollection","./FactoryLayout"],function(t,e,n,o,r){function u(t){if(l)return i.push(t);var e=f.prodLineStates.get(t._id);e&&t.v>e.get("v")&&e.update(t)}var a=6e4,i=[],c=null,l=!1,s=!1,d=null,f=new e;return window.productionState=f,f.url="/production/state",f.factoryLayout=new r,f.prodLineStates=new o,f.parse=function(t){return Array.isArray(t.prodLineStates)&&this.prodLineStates.reset(t.prodLineStates.map(n.parse)),t.factoryLayout&&this.factoryLayout.set(t.factoryLayout),{}},f.load=function(e){return null!==d&&(clearTimeout(d),d=null),!s||e?(null===c&&(c=t.subscribe("production.stateChanged.**",u)),f.fetch()):void 0},f.unload=function(){s&&(null!==d&&clearTimeout(d),d=setTimeout(function(){null!==c&&(c.cancel(),c=null),f.prodLineStates.reset([]),d=null,s=!1},a))},f.on("request",function(){l=!0}),f.on("sync",function(){l=!1,s=!0,i.forEach(u),i=[]}),f.on("error",function(){l=!1,s=!1,i=[],f.prodLineStates.reset([])}),f});