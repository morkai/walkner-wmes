// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["../pubsub","../core/Model","./ProdLineState","./ProdLineStateCollection","./FactoryLayout"],function(t,e,n,o,r){function u(t){if(c)return a.push(t);var e=d.prodLineStates.get(t._id);e&&t.v>e.get("v")&&e.update(t)}var a=[],i=null,c=!1,l=!1,s=null,d=new e;return window.productionState=d,d.url="/production/state",d.factoryLayout=new r,d.prodLineStates=new o,d.parse=function(t){return Array.isArray(t.prodLineStates)&&this.prodLineStates.reset(t.prodLineStates.map(n.parse)),t.factoryLayout&&this.factoryLayout.set(t.factoryLayout),{}},d.load=function(e){return null!==s&&clearTimeout(s),!l||e?(null===i&&(i=t.subscribe("production.stateChanged.**",u)),d.fetch()):void 0},d.unload=function(){l&&(null!==s&&clearTimeout(s),s=setTimeout(function(){null!==i&&(i.cancel(),i=null),d.prodLineStates.reset([]),s=null,l=!1},1e4))},d.on("request",function(){c=!0}),d.on("sync",function(){c=!1,l=!0,a.forEach(u),a=[]}),d.on("error",function(){c=!1,l=!1,a=[],d.prodLineStates.reset([])}),d});