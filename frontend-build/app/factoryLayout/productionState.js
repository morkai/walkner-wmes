// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../broker","../pubsub","../core/Model","app/production/ProductionSettingCollection","app/planning/WhOrderStatusCollection","./FactoryLayoutSettingCollection","./ProdLineState","./ProdLineStateCollection","./FactoryLayout"],function(t,e,s,r,n,u,o,i,a){"use strict";function c(t){if(b)return p.push(t);var e=h.prodLineStates.get(t._id);e&&t.v>e.get("v")&&e.update(t)}function d(){f&&setTimeout(l,1e4)}function l(){f&&(h.whOrderStatuses.setCurrentDate(),h.whOrderStatuses.fetch({reset:!0}))}var p=[],b=!1,f=!1,y=null,h=new s;return window.productionState=h,h.pubsub=null,h.url="/production/state",h.settings={factoryLayout:new u,production:new r},h.factoryLayout=new a,h.prodLineStates=new i(null,{settings:h.settings}),h.historyData=new i(null,{settings:h.settings}),h.whOrderStatuses=new n,h.isLoading=function(){return b},h.parse=function(t){return t.settings&&(this.settings.factoryLayout.reset(t.settings.filter(function(t){return/^factoryLayout/.test(t._id)})),this.settings.production.reset(t.settings.filter(function(t){return/^production/.test(t._id)}))),Array.isArray(t.prodLineStates)&&this.prodLineStates.reset(this.prodLineStates.parse(t)),t.factoryLayout&&this.factoryLayout.set(t.factoryLayout),Array.isArray(t.whOrderStatuses)&&this.whOrderStatuses.reset(this.whOrderStatuses.parse({collection:t.whOrderStatuses})),{}},h.load=function(t){if(null!==y&&(clearTimeout(y),y=null),!f||t)return null===h.pubsub&&(h.pubsub=e.sandbox(),h.pubsub.subscribe("production.stateChanged.**",c),h.pubsub.subscribe("shiftChanged",d),h.settings.factoryLayout.setUpPubsub(h.pubsub),h.settings.production.setUpPubsub(h.pubsub),h.whOrderStatuses.setUpPubsub(h.pubsub)),h.whOrderStatuses.setCurrentDate(),h.fetch()},h.unload=function(){f&&(null!==y&&clearTimeout(y),y=setTimeout(function(){null!==h.pubsub&&(h.pubsub.destroy(),h.pubsub=null),h.prodLineStates.reset([]),h.settings.factoryLayout.reset([]),h.settings.production.reset([]),h.whOrderStatuses.reset([]),y=null,f=!1},6e4))},h.on("request",function(){b=!0}),h.on("sync",function(){b=!1,f=!0,p.forEach(c),p=[]}),h.on("error",function(){b=!1,f=!1,p=[],h.prodLineStates.reset([])}),["divisions","subdivisions","mrpControllers","prodFlows","workCenters","prodLines"].forEach(function(e){t.subscribe(e+".synced",function(){f&&h.load(!0)})}),h});