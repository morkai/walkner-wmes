// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../broker","../pubsub","../core/Model","app/production/ProductionSettingCollection","./FactoryLayoutSettingCollection","./ProdLineState","./ProdLineStateCollection","./FactoryLayout"],function(t,n,e,o,s,u,r,i){"use strict";function a(t){if(l)return c.push(t);var n=b.prodLineStates.get(t._id);n&&t.v>n.get("v")&&n.update(t)}var c=[],l=!1,d=!1,p=null,b=new e;return window.productionState=b,b.pubsub=null,b.url="/production/state",b.settings={factoryLayout:new s,production:new o},b.factoryLayout=new i,b.prodLineStates=new r(null,{settings:b.settings}),b.historyData=new r(null,{settings:b.settings}),b.isLoading=function(){return l},b.parse=function(t){return t.settings&&(this.settings.factoryLayout.reset(t.settings.filter(function(t){return/^factoryLayout/.test(t._id)})),this.settings.production.reset(t.settings.filter(function(t){return/^production/.test(t._id)}))),Array.isArray(t.prodLineStates)&&this.prodLineStates.reset(this.prodLineStates.parse(t)),t.factoryLayout&&this.factoryLayout.set(t.factoryLayout),{}},b.load=function(t){if(null!==p&&(clearTimeout(p),p=null),!d||t)return null===b.pubsub&&(b.pubsub=n.sandbox(),b.pubsub.subscribe("production.stateChanged.**",a),b.settings.factoryLayout.setUpPubsub(b.pubsub),b.settings.production.setUpPubsub(b.pubsub)),b.fetch()},b.unload=function(){d&&(null!==p&&clearTimeout(p),p=setTimeout(function(){null!==b.pubsub&&(b.pubsub.destroy(),b.pubsub=null),b.prodLineStates.reset([]),b.settings.factoryLayout.reset([]),b.settings.production.reset([]),p=null,d=!1},6e4))},b.on("request",function(){l=!0}),b.on("sync",function(){l=!1,d=!0,c.forEach(a),c=[]}),b.on("error",function(){l=!1,d=!1,c=[],b.prodLineStates.reset([])}),["divisions","subdivisions","mrpControllers","prodFlows","workCenters","prodLines"].forEach(function(n){t.subscribe(n+".synced",function(){d&&b.load(!0)})}),b});