// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","../settings/SettingCollection","./FactoryLayoutSetting"],function(e,t,r){return t.extend({model:r,topicSuffix:"factoryLayout.**",isBlacklisted:function(e,t){var r=this.getValue("blacklist."+e);return Array.isArray(r)&&-1!==r.indexOf(t)},getValue:function(e){var t=this.get("factoryLayout."+e);return t?t.getValue():null},getColor:function(e,t){var r=this.getValue(e+".color")||"#FFFFFF";if(!t)return r;var a=r.match(/^#(.{2})(.{2})(.{2})$/);return a?"rgba("+parseInt(a[1],16)+","+parseInt(a[2],16)+","+parseInt(a[3],16)+","+t+")":r},update:function(t,r){if(r=this.prepareValue(t,r.trim()),void 0===r)return e.Deferred().reject().promise();var a=this.get(t);if(a){if(a.getValue()===r)return e.Deferred().resolve().promise()}else this.add({_id:t,value:null}),a=this.get(t);return a.save({value:r})},prepareValue:function(e,t){return/blacklist/.test(e)?this.prepareBlacklistValue(t):/color/i.test(e)?this.prepareColorValue(t):(t=parseInt(t,10),isNaN(t)?void 0:t)},prepareBlacklistValue:function(e){return"string"==typeof e?e=e.split(","):Array.isArray(e)||(e=[]),e.filter(function(e){return"string"==typeof e&&e.length})},prepareColorValue:function(e){return e=e.toLowerCase(),/^#[a-f0-9]{6}$/.test(e)?e:void 0}})});