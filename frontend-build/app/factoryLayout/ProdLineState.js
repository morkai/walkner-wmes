// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["../core/Model","../prodShifts/ProdShift","../prodShiftOrders/ProdShiftOrder","../prodShiftOrders/ProdShiftOrderCollection","../prodDowntimes/ProdDowntime","../prodDowntimes/ProdDowntimeCollection"],function(r,e,t,o,d,i){return r.extend({urlRoot:"/production/state",clientUrlRoot:"#factoryLayout",topicPrefix:"production",privilegePrefix:"FACTORY_LAYOUT",nlsDomain:"factoryLayout",defaults:{v:0,state:null,stateChangedAt:0,online:!1,extended:!1,plannedQuantityDone:0,actualQuantityDone:0,prodShift:null,prodShiftOrders:null,prodDowntimes:null},getLabel:function(){return this.id.substr(0,10).toUpperCase().replace(/_$/,"").replace(/_/g," ")},update:function(r){var o=this.attributes;if(r.prodShift&&(null===o.prodShift?o.prodShift=new e(e.parse(r.prodShift)):o.prodShift.set(e.parse(r.prodShift)),this.trigger("change:prodShift"),delete r.prodShift),Array.isArray(r.prodShiftOrders))o.prodShiftOrders.reset(r.prodShiftOrders.map(t.parse)),this.trigger("change:prodShiftOrders",{reset:!0}),delete r.prodShiftOrders;else if(r.prodShiftOrders){var i=o.prodShiftOrders.get(r.prodShiftOrders._id);i?i.set(t.parse(r.prodShiftOrders)):o.prodShiftOrders.add(t.parse(r.prodShiftOrders)),this.trigger("change:prodShiftOrders",{reset:!1}),delete r.prodShiftOrders}if(Array.isArray(r.prodDowntimes))o.prodDowntimes.reset(r.prodDowntimes.map(d.parse)),this.trigger("change:prodDowntimes",{reset:!0}),delete r.prodDowntimes;else if(r.prodDowntimes){var s=o.prodDowntimes.get(r.prodDowntimes._id);s?s.set(d.parse(r.prodDowntimes)):o.prodDowntimes.add(d.parse(r.prodDowntimes)),this.trigger("change:prodDowntimes",{reset:!1}),delete r.prodDowntimes}Object.keys(r).length?this.set(r):this.trigger("change")}},{parse:function(r){var s=new o;s.comparator="startedAt",s.reset(r.prodShiftOrders.map(t.parse));var p=new i;return p.comparator="startedAt",p.reset(r.prodDowntimes.map(d.parse)),r.prodShift=r.prodShift?new e(e.parse(r.prodShift)):null,r.prodShiftOrders=s,r.prodDowntimes=p,r}})});