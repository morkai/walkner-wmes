define(["underscore","app/time","app/core/Model","app/prodShifts/ProdShift","app/prodShiftOrders/ProdShiftOrder","app/prodShiftOrders/ProdShiftOrderCollection","app/prodDowntimes/ProdDowntime","app/prodDowntimes/ProdDowntimeCollection","app/planning/util/shift"],function(t,e,r,i,n,s,o,a,d){"use strict";return r.extend({urlRoot:"/production/state",clientUrlRoot:"#factoryLayout",topicPrefix:"production",privilegePrefix:"FACTORY_LAYOUT",nlsDomain:"factoryLayout",initialize:function(t,e){this.settings=e&&e.settings?e.settings:null},getLabel:function(){if(!this.attributes.label){var t=this.getProdLineId().toUpperCase().replace(/(_+|~.*?)$/,"").replace(/[_-]+/g," ");t.length>10&&(t=t.replace(/ +/g,"")),this.attributes.label=t}return this.attributes.label},getProdLineId:function(){return null===this.attributes.prodShift?this.id:this.attributes.prodShift.get("prodLine")},getCurrentOrder:function(){if(!this.attributes.prodShiftOrders)return null;var t=this.attributes.prodShiftOrders.last();return t&&!t.get("finishedAt")?t:null},getCurrentDowntime:function(){if(!this.attributes.prodDowntimes)return null;var t=this.attributes.prodDowntimes.last();return t&&!t.get("finishedAt")?t:null},getOrderEfficiencyClassName:function(){var t=this.get("prodShiftOrders");if(!t||!t.length)return null;var e=t.last();return e.get("finishedAt")?null:e.getEfficiencyClassName({prodDowntimes:this.get("prodDowntimes")})},getShiftEfficiencyClassName:function(){var t=this.get("prodShiftOrders");if(!t||0===t.length)return null;var e=this.get("prodDowntimes"),r=i.calcEfficiency(t,e);return-1===r?null:r>=100?"is-eff-high":r>=90?"is-eff-mid":"is-eff-low"},isTaktTimeOk:function(){var t=this.get("prodShiftOrders");if(!t||!t.length)return!0;var e=t.last();if(e.get("finishedAt")||!this.settings||!this.settings.production.isTaktTimeEnabled(this.id))return!0;var r=e.get("avgTaktTime")/1e3,i=e.getSapTaktTime();return!r||r<=i},isBreak:function(){var t=this.getCurrentDowntime();return!!t&&t.isBreak()},update:function(e){e=t.clone(e);var r=this.attributes,s=!1,a=null,d=null,l=null;if("object"==typeof e.prodShift&&(null===e.prodShift?r.prodShift=null:null===r.prodShift?r.prodShift=new i(i.parse(e.prodShift)):r.prodShift.set(i.parse(e.prodShift)),s=!0,delete e.prodShift),Array.isArray(e.prodShiftOrders))r.prodShiftOrders.reset(e.prodShiftOrders.map(n.parse)),a={reset:!0},delete e.prodShiftOrders;else if(e.prodShiftOrders){var f=r.prodShiftOrders.get(e.prodShiftOrders._id);f?f.set(n.parse(e.prodShiftOrders)):r.prodShiftOrders.add(n.parse(e.prodShiftOrders)),a={reset:!1},e.prodShiftOrders.lastTaktTime&&(l=e.prodShiftOrders),delete e.prodShiftOrders}if(Array.isArray(e.prodDowntimes))r.prodDowntimes.reset(e.prodDowntimes.map(o.parse)),d={reset:!0},delete e.prodDowntimes;else if(e.prodDowntimes){var p=r.prodDowntimes.get(e.prodDowntimes._id);p?p.set(o.parse(e.prodDowntimes)):r.prodDowntimes.add(o.parse(e.prodDowntimes)),d={reset:!1},delete e.prodDowntimes}s&&this.trigger("change:prodShift"),a&&this.trigger("change:prodShiftOrders",a),d&&this.trigger("change:prodDowntimes",d),l&&this.trigger("change:taktTime",this,l),Object.keys(e).length?this.set(e):this.trigger("change")},getMetricValue:function(t,e){return e?(e=this.get("heff")||this.recalcHeff(),"plannedQuantityDone"===t?e.endOfHourPlanned:"actualQuantityDone"===t?e.totalActual:0):this.get(t)},recalcHeff:function(){var t={currentPlanned:0,endOfHourPlanned:0,totalPlanned:0,totalActual:0,totalRemaining:0,status:"off"},r=this.get("prodShift");if(!r||!r.get("shift"))return this.set("heff",t),t;for(var i=r.get("quantitiesDone"),n=e.getMoment(),s=n.hours(),o=n.minutes(),a=d.HOUR_TO_INDEX_SHIFT[s],l=0;l<8;++l){var f=i[l].planned,p=i[l].actual;t.totalPlanned+=f,t.totalActual+=p,l<a?(t.currentPlanned+=f,t.endOfHourPlanned+=f):l===a&&(t.endOfHourPlanned+=f,t.currentPlanned+=Math.round(f*(o/60)*1e3)/1e3)}if(t.totalRemaining=Math.max(t.totalPlanned-t.totalActual,0),t.currentPlanned=Math.floor(t.currentPlanned),t.totalPlanned){var u=this.settings&&this.settings.factoryLayout.getValue("outOfSyncWindow"),h=Math.round(t.totalActual/t.currentPlanned*100)-100;t.status=h>=u?"overRatio":h<=-1*u?"underRatio":t.totalActual>=t.currentPlanned?"over":"under"}else t.status=t.totalActual?"unplanned":"noPlan";return this.set("heff",t),t}},{parse:function(t){var e=new s;e.comparator="startedAt",e.reset(t.prodShiftOrders.map(n.parse));var r=new a;return r.comparator="startedAt",r.reset(t.prodDowntimes.map(o.parse)),t.prodShift=t.prodShift?new i(i.parse(t.prodShift)):null,t.prodShiftOrders=e,t.prodDowntimes=r,t}})});