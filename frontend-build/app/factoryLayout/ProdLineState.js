// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../core/Model","../prodShifts/ProdShift","../prodShiftOrders/ProdShiftOrder","../prodShiftOrders/ProdShiftOrderCollection","../prodDowntimes/ProdDowntime","../prodDowntimes/ProdDowntimeCollection"],function(t,r,e,i,s,o){"use strict";return t.extend({urlRoot:"/production/state",clientUrlRoot:"#factoryLayout",topicPrefix:"production",privilegePrefix:"FACTORY_LAYOUT",nlsDomain:"factoryLayout",defaults:{v:0,state:null,stateChangedAt:0,online:!1,extended:!1,plannedQuantityDone:0,actualQuantityDone:0,prodShift:null,prodShiftOrders:null,prodDowntimes:null},initialize:function(t,r){this.settings=r&&r.settings?r.settings:null},getLabel:function(){return this.getProdLineId().substr(0,10).toUpperCase().replace(/(_+|~.*?)$/,"").replace(/_/g," ")},getProdLineId:function(){return null===this.attributes.prodShift?this.id:this.attributes.prodShift.get("prodLine")},getCurrentOrder:function(){if(!this.attributes.prodShiftOrders)return null;var t=this.attributes.prodShiftOrders.last();return t&&!t.get("finishedAt")?t:null},getCurrentDowntime:function(){if(!this.attributes.prodDowntimes)return null;var t=this.attributes.prodDowntimes.last();return t&&!t.get("finishedAt")?t:null},isTaktTimeOk:function(){var t=this.get("prodShiftOrders");if(!t||!t.length)return!0;var r=t.last();if(r.get("finishedAt")||!this.settings||!this.settings.production.isTaktTimeEnabled(this.id))return!0;var e=r.get("avgTaktTime")/1e3,i=r.getTaktTime(this.settings.production);return!e||e<=i},update:function(t){var i=this.attributes,o=!1,d=null,n=null,p=null;if("object"==typeof t.prodShift&&(null===t.prodShift?i.prodShift=null:null===i.prodShift?i.prodShift=new r(r.parse(t.prodShift)):i.prodShift.set(r.parse(t.prodShift)),o=!0,delete t.prodShift),Array.isArray(t.prodShiftOrders))i.prodShiftOrders.reset(t.prodShiftOrders.map(e.parse)),d={reset:!0},delete t.prodShiftOrders;else if(t.prodShiftOrders){var a=i.prodShiftOrders.get(t.prodShiftOrders._id);a?a.set(e.parse(t.prodShiftOrders)):i.prodShiftOrders.add(e.parse(t.prodShiftOrders)),d={reset:!1},t.prodShiftOrders.lastTaktTime&&(p=t.prodShiftOrders),delete t.prodShiftOrders}if(Array.isArray(t.prodDowntimes))i.prodDowntimes.reset(t.prodDowntimes.map(s.parse)),n={reset:!0},delete t.prodDowntimes;else if(t.prodDowntimes){var h=i.prodDowntimes.get(t.prodDowntimes._id);h?h.set(s.parse(t.prodDowntimes)):i.prodDowntimes.add(s.parse(t.prodDowntimes)),n={reset:!1},delete t.prodDowntimes}o&&this.trigger("change:prodShift"),d&&this.trigger("change:prodShiftOrders",d),n&&this.trigger("change:prodDowntimes",n),p&&this.trigger("change:taktTime",this,p),Object.keys(t).length?this.set(t):this.trigger("change")}},{parse:function(t){var d=new i;d.comparator="startedAt",d.reset(t.prodShiftOrders.map(e.parse));var n=new o;return n.comparator="startedAt",n.reset(t.prodDowntimes.map(s.parse)),t.prodShift=t.prodShift?new r(r.parse(t.prodShift)):null,t.prodShiftOrders=d,t.prodDowntimes=n,t}})});