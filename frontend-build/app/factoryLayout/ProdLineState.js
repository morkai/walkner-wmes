define(["underscore","app/time","app/core/Model","app/prodShifts/ProdShift","app/prodShiftOrders/ProdShiftOrder","app/prodShiftOrders/ProdShiftOrderCollection","app/prodDowntimes/ProdDowntime","app/prodDowntimes/ProdDowntimeCollection","app/planning/util/shift"],function(t,e,r,i,n,o,a,s,d){"use strict";return r.extend({urlRoot:"/production/state",clientUrlRoot:"#factoryLayout",topicPrefix:"production",privilegePrefix:"FACTORY_LAYOUT",nlsDomain:"factoryLayout",initialize:function(t,e){this.settings=e&&e.settings?e.settings:null},getLabel:function(){if(!this.attributes.label){var t=this.getProdLineId().toUpperCase().replace(/(_+|~.*?)$/,"").replace(/[_-]+/g," ");t.length>10&&(t=t.replace(/ +/g,"")),this.attributes.label=t}return this.attributes.label},getProdLineId:function(){return null===this.attributes.prodShift?this.id:this.attributes.prodShift.get("prodLine")},getCurrentOrder:function(){if(!this.attributes.prodShiftOrders)return null;var t=this.attributes.prodShiftOrders.last();return t&&!t.get("finishedAt")?t:null},getCurrentDowntime:function(){if(!this.attributes.prodDowntimes)return null;var t=this.attributes.prodDowntimes.last();return t&&!t.get("finishedAt")?t:null},isTaktTimeOk:function(){var t=this.get("prodShiftOrders");if(!t||!t.length)return!0;var e=t.last();if(e.get("finishedAt")||!this.settings||!this.settings.production.isTaktTimeEnabled(this.id))return!0;var r=e.get("avgTaktTime")/1e3,i=e.getSapTaktTime();return!r||r<=i},isBreak:function(){var t=this.getCurrentDowntime();return!!t&&t.isBreak()},update:function(e){e=t.clone(e);var r=this.attributes,o=!1,s=null,d=null,l=null;if("object"==typeof e.prodShift&&(null===e.prodShift?r.prodShift=null:null===r.prodShift?r.prodShift=new i(i.parse(e.prodShift)):r.prodShift.set(i.parse(e.prodShift)),o=!0,delete e.prodShift),Array.isArray(e.prodShiftOrders))r.prodShiftOrders.reset(e.prodShiftOrders.map(n.parse)),s={reset:!0},delete e.prodShiftOrders;else if(e.prodShiftOrders){var p=r.prodShiftOrders.get(e.prodShiftOrders._id);p?p.set(n.parse(e.prodShiftOrders)):r.prodShiftOrders.add(n.parse(e.prodShiftOrders)),s={reset:!1},e.prodShiftOrders.lastTaktTime&&(l=e.prodShiftOrders),delete e.prodShiftOrders}if(Array.isArray(e.prodDowntimes))r.prodDowntimes.reset(e.prodDowntimes.map(a.parse)),d={reset:!0},delete e.prodDowntimes;else if(e.prodDowntimes){var u=r.prodDowntimes.get(e.prodDowntimes._id);u?u.set(a.parse(e.prodDowntimes)):r.prodDowntimes.add(a.parse(e.prodDowntimes)),d={reset:!1},delete e.prodDowntimes}o&&this.trigger("change:prodShift"),s&&this.trigger("change:prodShiftOrders",s),d&&this.trigger("change:prodDowntimes",d),l&&this.trigger("change:taktTime",this,l),Object.keys(e).length?this.set(e):this.trigger("change")},getMetricValue:function(t,e){return e?(e=this.get("heff")||this.recalcHeff(),"plannedQuantityDone"===t?e.endOfHourPlanned:"actualQuantityDone"===t?e.totalActual:0):this.get(t)},recalcHeff:function(){var t={currentPlanned:0,endOfHourPlanned:0,totalPlanned:0,totalActual:0,totalRemaining:0,status:"off"},r=this.get("prodShift");if(!r||!r.get("shift"))return this.set("heff",t),t;for(var i=r.get("quantitiesDone"),n=e.getMoment(),o=n.hours(),a=n.minutes(),s=d.HOUR_TO_INDEX_SHIFT[o],l=0;l<8;++l){var p=i[l].planned,u=i[l].actual;t.totalPlanned+=p,t.totalActual+=u,l<s?(t.currentPlanned+=p,t.endOfHourPlanned+=p):l===s&&(t.endOfHourPlanned+=p,t.currentPlanned+=Math.round(p*(a/60)*1e3)/1e3)}if(t.totalRemaining=Math.max(t.totalPlanned-t.totalActual,0),t.currentPlanned=Math.floor(t.currentPlanned),t.totalPlanned){var f=this.settings&&this.settings.factoryLayout.getValue("outOfSyncWindow"),h=Math.round(t.totalActual/t.currentPlanned*100)-100;t.status=h>=f?"overRatio":h<=f?"underRatio":t.totalActual>=t.currentPlanned?"over":"under"}else t.status=t.totalActual?"unplanned":"noPlan";return this.set("heff",t),t}},{parse:function(t){var e=new o;e.comparator="startedAt",e.reset(t.prodShiftOrders.map(n.parse));var r=new s;return r.comparator="startedAt",r.reset(t.prodDowntimes.map(a.parse)),t.prodShift=t.prodShift?new i(i.parse(t.prodShift)):null,t.prodShiftOrders=e,t.prodDowntimes=r,t}})});