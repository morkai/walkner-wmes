define(["underscore","../core/Model","../prodShifts/ProdShift","../prodShiftOrders/ProdShiftOrder","../prodShiftOrders/ProdShiftOrderCollection","../prodDowntimes/ProdDowntime","../prodDowntimes/ProdDowntimeCollection"],function(t,r,e,i,s,o,d){"use strict";return r.extend({urlRoot:"/production/state",clientUrlRoot:"#factoryLayout",topicPrefix:"production",privilegePrefix:"FACTORY_LAYOUT",nlsDomain:"factoryLayout",defaults:{v:0,state:null,stateChangedAt:0,online:!1,extended:!1,plannedQuantityDone:0,actualQuantityDone:0,prodShift:null,prodShiftOrders:null,prodDowntimes:null},initialize:function(t,r){this.settings=r&&r.settings?r.settings:null},getLabel:function(){if(!this.attributes.label){var t=this.getProdLineId().toUpperCase().replace(/(_+|~.*?)$/,"").replace(/[_-]+/g," ");t.length>10&&(t=t.replace(/ +/g,"")),this.attributes.label=t}return this.attributes.label},getProdLineId:function(){return null===this.attributes.prodShift?this.id:this.attributes.prodShift.get("prodLine")},getCurrentOrder:function(){if(!this.attributes.prodShiftOrders)return null;var t=this.attributes.prodShiftOrders.last();return t&&!t.get("finishedAt")?t:null},getCurrentDowntime:function(){if(!this.attributes.prodDowntimes)return null;var t=this.attributes.prodDowntimes.last();return t&&!t.get("finishedAt")?t:null},isTaktTimeOk:function(){var t=this.get("prodShiftOrders");if(!t||!t.length)return!0;var r=t.last();if(r.get("finishedAt")||!this.settings||!this.settings.production.isTaktTimeEnabled(this.id))return!0;var e=r.get("avgTaktTime")/1e3,i=r.getSapTaktTime();return!e||e<=i},isBreak:function(){var t=this.getCurrentDowntime();return!!t&&t.isBreak()},update:function(r){r=t.clone(r);var s=this.attributes,d=!1,n=null,a=null,p=null;if("object"==typeof r.prodShift&&(null===r.prodShift?s.prodShift=null:null===s.prodShift?s.prodShift=new e(e.parse(r.prodShift)):s.prodShift.set(e.parse(r.prodShift)),d=!0,delete r.prodShift),Array.isArray(r.prodShiftOrders))s.prodShiftOrders.reset(r.prodShiftOrders.map(i.parse)),n={reset:!0},delete r.prodShiftOrders;else if(r.prodShiftOrders){var h=s.prodShiftOrders.get(r.prodShiftOrders._id);h?h.set(i.parse(r.prodShiftOrders)):s.prodShiftOrders.add(i.parse(r.prodShiftOrders)),n={reset:!1},r.prodShiftOrders.lastTaktTime&&(p=r.prodShiftOrders),delete r.prodShiftOrders}if(Array.isArray(r.prodDowntimes))s.prodDowntimes.reset(r.prodDowntimes.map(o.parse)),a={reset:!0},delete r.prodDowntimes;else if(r.prodDowntimes){var l=s.prodDowntimes.get(r.prodDowntimes._id);l?l.set(o.parse(r.prodDowntimes)):s.prodDowntimes.add(o.parse(r.prodDowntimes)),a={reset:!1},delete r.prodDowntimes}d&&this.trigger("change:prodShift"),n&&this.trigger("change:prodShiftOrders",n),a&&this.trigger("change:prodDowntimes",a),p&&this.trigger("change:taktTime",this,p),Object.keys(r).length?this.set(r):this.trigger("change")}},{parse:function(t){var r=new s;r.comparator="startedAt",r.reset(t.prodShiftOrders.map(i.parse));var n=new d;return n.comparator="startedAt",n.reset(t.prodDowntimes.map(o.parse)),t.prodShift=t.prodShift?new e(e.parse(t.prodShift)):null,t.prodShiftOrders=r,t.prodDowntimes=n,t}})});