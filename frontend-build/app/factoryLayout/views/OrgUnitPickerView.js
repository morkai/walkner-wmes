// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","underscore","js2form","Sortable","app/i18n","app/data/orgUnits","app/core/View","app/factoryLayout/templates/orgUnitPicker"],function(t,e,i,r,n,s,o,l){return o.extend({template:l,events:{submit:function(t){t.preventDefault();var e=this.$('input[name="orgUnitType"]:checked').val(),i=this.$id(e).select2("val");this.trigger("picked",e,i)},'change input[type="radio"]':function(t){this.$id(t.currentTarget.value).select2("focus")}},initialize:function(){this.sortables=[]},destroy:function(){this.destroySortables()},destroySortables:function(){for(var t=0,e=this.sortables.length;e>t;++t)this.sortables[t].destroy();this.sortables=[]},beforeRender:function(){this.destroySortables()},afterRender:function(){var t=this.serializeFormData();i(this.el,t),this.setUpOrgUnitSelect2("division"),this.setUpOrgUnitSelect2("subdivision"),this.setUpOrgUnitSelect2("mrpController"),this.setUpOrgUnitSelect2("prodFlow"),this.setUpOrgUnitSelect2("workCenter"),this.setUpOrgUnitSelect2("prodLine"),this.$id(t.orgUnitType).attr("autofocus",!0)},serializeFormData:function(){var t={orgUnitType:this.model.orgUnitType};return t[t.orgUnitType]=this.model.orgUnitIds.join(","),t},setUpOrgUnitSelect2:function(t){var e=this.$id(t);e.select2({multiple:!0,data:s.getAllByType(t).map(function(e){if("division"===t&&"prod"!==e.get("type"))return null;var i;if("subdivision"===t){if("storage"===e.get("type"))return null;i=e.get("division")+" > "+e.getLabel()}else i=e.getLabel();return{id:e.id,text:i}}).filter(function(t){return null!==t})});var i=e.select2("container").find(".select2-choices")[0];this.sortables.push(new r(i,{draggable:".select2-search-choice",filter:".select2-search-choice-close",onStart:function(){e.select2("onSortStart")},onEnd:function(){e.select2("onSortEnd").select2("focus")}}))}})});