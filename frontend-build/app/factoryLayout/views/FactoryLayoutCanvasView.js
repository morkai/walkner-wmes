// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","d3","screenfull","app/viewport","app/core/View","app/factoryLayout/templates/canvas"],function(t,e,n,i,a,o,r){function s(t,e){return"rgba("+parseInt(t.substr(1,2),16)+","+parseInt(t.substr(3,2),16)+","+parseInt(t.substr(5,2),16)+","+e+")"}var l=10,d=22,c=4,h=17,u=18,p=110,f=39,y=d+2+l;return o.extend({template:r,events:{"click [data-action]":function(t){var e=t.currentTarget,n=e.dataset.action;return n===this.currentAction?!1:(null!==this.currentAction&&this.$("[data-action="+this.currentAction+"]").removeClass("active"),this.currentAction=n,void this.$("[data-action="+this.currentAction+"]").addClass("active"))},"mouseover .factoryLayout-division":function(t){var e=t.currentTarget;e.parentNode.lastChild!==e&&e.parentNode.appendChild(e)},"mousedown .factoryLayout-prodLine":function(t){return this.clickInfo={type:"prodLine",time:t.timeStamp,modelId:t.currentTarget.dataset.id},!1},"mousedown .factoryLayout-division":function(t){return this.clickInfo={type:"division",time:t.timeStamp,modelId:t.currentTarget.dataset.id},!1}},initialize:function(){this.onKeyDown=this.onKeyDown.bind(this),this.onResize=t.debounce(this.onResize.bind(this),16),this.canvas=null,this.zoom=null,this.currentAction=null,this.editable=!1,this.clickInfo=null,this.panInfo=null,e("body").on("keydown",this.onKeyDown),e(window).on("resize",this.onResize),i.onchange=t.debounce(this.onFullscreen.bind(this),16),this.listenTo(this.model.prodLineStates,"change:state",this.onStateChange),this.listenTo(this.model.prodLineStates,"change:online",this.onOnlineChange),this.listenTo(this.model.prodLineStates,"change:extended",this.onExtendedChange),this.listenTo(this.model.prodLineStates,"change:plannedQuantityDone",this.onPlannedQuantityDoneChange),this.listenTo(this.model.prodLineStates,"change:actualQuantityDone",this.onActualQuantityDoneChange)},destroy:function(){e("body").off("keydown",this.onKeyDown),e(window).off("resize",this.onResize),i.onchange=function(){},this.zoom=null,this.canvas=null,this.clickInfo=null,this.panInfo=null},beforeRender:function(){this.stopListening(this.model,"sync",this.render)},afterRender:function(){this.listenToOnce(this.model,"sync",this.render),this.el.classList.toggle("is-editable",this.editable),this.setUpCanvas(this.getSize()),this.renderLayout(),this.centerView(),this.$("[data-action=pan]").click()},renderLayout:function(){var t=this.canvas.selectAll(".division").data(this.model.factoryLayout.get("live")),e=n.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]}).interpolate("linear-closed"),i=n.behavior.drag().origin(function(t){return t.position}).on("dragstart",function(){n.event.sourceEvent.stopPropagation(),this.parentNode.appendChild(this),n.select(this).classed("is-dragging",!0)}).on("dragend",function(){n.select(this).classed("is-dragging",!1)}).on("drag",function(t){t.position.x=n.event.x-n.event.x%10,t.position.y=n.event.y-n.event.y%10,n.select(this).attr("transform","translate("+t.position.x+","+t.position.y+")")}),a=t.enter().insert("g").attr("class","factoryLayout-division").attr("transform",function(t){return"translate("+t.position.x+","+t.position.y+")"}).attr("fill",function(t){return s(t.fillColor||"#000000",1)}).attr("data-id",function(t){return t._id}).call(this.editable?i:function(){});a.append("path").classed("factoryLayout-division-area",!0).attr("d",function(t){return e(t.points)});var o=this,r=this.model.prodLineStates;a.each(function(t){t.prodLines.forEach(o.renderProdLinesGuide.bind(o,t,n.select(this),r.getForDivision(t._id)))}),t.exit().remove()},renderProdLinesGuide:function(t,e,n,i){var a=e.append("g").attr({"class":"factoryLayout-prodLines",transform:"translate("+i.x+","+i.y+")"});a.append("path").attr({"class":"factoryLayout-prodLines-line",d:"M-5,0 v"+i.h});for(var o=Math.floor(i.h/y),r=0;o>r;++r){var s=n.shift();if(void 0===s)break;this.renderProdLineBox(a,s,r)}},renderProdLineBox:function(t,e,n){var i=t.append("g").attr({"class":"factoryLayout-prodLine",transform:"translate(0,"+y*n+")",style:"font-size: "+u+"px"});i.attr("data-id",e.id),null!==e.get("state")&&i.classed("is-"+e.get("state"),!0),i.classed("is-offline",!e.get("online")),i.classed("is-extended",e.get("extended"));var a=i.append("g").attr({"class":"factoryLayout-prodLine-inner"});a.append("rect").attr({"class":"factoryLayout-prodLine-bg",x:0,y:0,width:p,height:d}),a.append("text").attr({"class":"factoryLayout-prodLine-name",x:c,y:h}).text(e.getLabel()),a.append("rect").attr({"class":"factoryLayout-metric-bg",x:p,y:0,width:f,height:d});var o=this.prepareMetricValue(e.get("plannedQuantityDone"));a.append("text").attr({"class":"factoryLayout-metric-value factoryLayout-metric-plannedQuantityDone",x:1+p+c,y:h,"data-length":o.length}).text(o),a.append("rect").attr({"class":"factoryLayout-metric-bg",x:p+f,y:0,width:f,height:d});var r=this.prepareMetricValue(e.get("actualQuantityDone"));a.append("text").attr({"class":"factoryLayout-metric-value factoryLayout-metric-actualQuantityDone",x:1+p+f+c,y:h,"data-length":r.length}).text(r)},padMetricValue:n.format(" >3d"),setUpCanvas:function(t){function e(){i.canvas.attr("transform","translate("+n.event.translate+")")}var i=this;this.$el.css(t);var a=n.behavior.zoom().on("zoomstart",function(){i.panInfo={time:n.event.sourceEvent.timeStamp,translate:n.event.target.translate()},i.$el.addClass("is-panning")}).on("zoomend",function(){i.$el.removeClass("is-panning");var t=i.panInfo,e=n.event.target.translate();i.panInfo=null,i.clickInfo&&t.translate[0]===e[0]&&t.translate[1]===e[1]&&i.handleClick()}).on("zoom",e),o=n.select(this.el).select("svg").attr("class","factoryLayout-canvas").attr("width",t.width).attr("height",t.height).attr("pointer-events","all").append("g").call(a).on("dblclick.zoom",null).on("wheel.zoom",null);o.append("rect").attr("class","factoryLayout-bg").attr("width",t.width).attr("height",t.height),this.zoom=a,this.canvas=o.append("g"),this.canvas.append("rect").attr("class","factoryLayout-area").attr("x","0").attr("y","0").attr("width","1920px").attr("height","1080px"),this.translate(5,5)},translate:function(t,e){this.zoom.translate([t,e]),this.canvas.attr("transform","translate("+t+","+e+")")},getSize:function(){if(i.element===this.el)return{width:window.innerWidth,height:window.innerHeight};var t=window.innerWidth-28,n=window.innerHeight-19-e(".page > .hd").outerHeight(!0)-e(".page > .ft").outerHeight(!0);return{width:t,height:n}},centerView:function(){var t,e,n=this.canvas.node().getBBox().width;i.isFullscreen?(t=(window.innerWidth-n)/2,e=0):(t=(this.el.getBoundingClientRect().width-n)/2,e=5),this.$el.toggleClass("is-fullscreen",i.isFullscreen),this.translate(t,e)},onKeyDown:function(t){122!==t.which||i.isFullscreen||(t.preventDefault(),i.request(this.el))},onResize:function(){var t=this.getSize();this.$el.css(t),this.$("svg").attr(t).find(".factoryLayout-bg").attr(t)},onFullscreen:function(){this.centerView()},getProdLineOuterContainer:function(t){return n.select('.factoryLayout-prodLine[data-id="'+t+'"]')},onStateChange:function(t){var e=this.getProdLineOuterContainer(t.id);if(!e.empty()){var n={"is-idle":!1,"is-working":!1,"is-downtime":!1};n["is-"+t.get("state")]=!0,e.classed(n)}},onOnlineChange:function(t){var e=this.getProdLineOuterContainer(t.id);e.empty()||e.classed("is-offline",!t.get("online"))},onExtendedChange:function(e){var n=this.getProdLineOuterContainer(e.id);n.empty()||(n.classed("is-extended",e.get("extended")),e.get("extended")||(n.style("display","none"),t.defer(function(){n.style("display",null)})))},onPlannedQuantityDoneChange:function(t){this.updateMetricValue(t,"plannedQuantityDone")},onActualQuantityDoneChange:function(t){this.updateMetricValue(t,"actualQuantityDone")},updateMetricValue:function(e,n){var i=this.getProdLineOuterContainer(e.id);if(!i.empty()){var a=i.select(".factoryLayout-metric-"+n);if(!a.empty()){var o=this.prepareMetricValue(e.get(n));a.style("display","none"),a.text(o),a.attr("data-length",o.length),t.defer(function(){a.style("display",null)})}}},prepareMetricValue:function(t){return-1===t?"???":this.padMetricValue(t)},handleClick:function(){var t=this.clickInfo;t&&(this.clickInfo=null,"division"===t.type?this.broker.publish("router.navigate",{url:"/factoryLayout/prodLines?division="+encodeURIComponent(t.modelId),trigger:!0,replace:!1}):"prodLine"===t.type&&this.showProdLinePreview(t.modelId))},showProdLinePreview:function(t){a.msg.show({type:"warning",text:"TODO ("+t+")",time:2e3})}})});