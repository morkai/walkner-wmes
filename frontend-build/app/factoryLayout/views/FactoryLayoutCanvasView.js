define(["underscore","jquery","d3","screenfull","app/time","app/viewport","app/core/View","app/core/util/padString","app/factoryLayout/templates/canvas","app/factoryLayout/templates/popover"],function(t,e,i,n,a,o,r,s,c,l){"use strict";return r.extend({template:c,events:{"click [data-action]":function(t){var e=t.currentTarget.dataset.action;if(e===this.currentAction)return!1;null!==this.currentAction&&this.$("[data-action="+this.currentAction+"]").removeClass("active"),this.currentAction=e,this.$("[data-action="+this.currentAction+"]").addClass("active")},"mouseover .factoryLayout-division":function(t){this.bringDivisionToTop(t.currentTarget)},"mouseenter .factoryLayout-prodLine":function(t){this.$popover=this.$(t.currentTarget).popover({container:"body",placement:"auto right",viewport:{selector:"body",padding:15},trigger:"manual",html:!0,content:this.getPopoverContent.bind(this,t.currentTarget.getAttribute("data-id")),template:'<div class="popover factoryLayout-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")},"mouseleave .factoryLayout-prodLine":function(t){this.$(t.currentTarget).popover("destroy"),this.$popover=null},"mousedown .factoryLayout-prodLine":function(t){return this.clickInfo={type:"prodLine",time:t.timeStamp,modelId:t.currentTarget.getAttribute("data-id"),button:t.button},!1},"mousedown .factoryLayout-division":function(t){return this.clickInfo={type:"division",time:t.timeStamp,modelId:t.currentTarget.getAttribute("data-id"),button:t.button},!1},"mousedown .factoryLayout-bg":function(){return this.clickInfo=null,!1}},localTopics:{"navbar.shown":function(){this.onResize()},"navbar.hidden":function(){this.onResize()}},initialize:function(i){if(this.onKeyDown=this.onKeyDown.bind(this),this.onResize=t.debounce(this.onResize.bind(this),16),this.heff=!!i.heff,this.editable=!!this.options.editable,this.canvas=null,this.zoom=null,this.currentAction=null,this.clickInfo=null,this.panInfo=null,this.$popover=null,this.dragged=!1,e("body").on("keydown",this.onKeyDown),e(window).on("resize",this.onResize),n.onchange=t.debounce(this.onFullscreen.bind(this),16),!this.editable){var a=this.model,o=a.prodLineStates;this.once("afterRender",function(){this.listenTo(o,"change:state",this.onStateChange),this.listenTo(o,"change:online",this.onOnlineChange),this.listenTo(o,"change:extended",this.onExtendedChange),this.listenTo(o,"change:qi",this.onQiChange),this.listenTo(o,"change:plannedQuantityDone",this.onPlannedQuantityDoneChange),this.listenTo(o,"change:actualQuantityDone",this.onActualQuantityDoneChange),this.listenTo(o,"change:taktTime",this.updateTaktTime),this.listenTo(o,"change:heff",this.updateHeffStatus),this.listenTo(a,"sync",this.render),this.listenTo(a.settings.factoryLayout,"change",this.onLayoutSettingsChange),this.listenTo(a.settings.production,"change",this.onProductionSettingsChange)}),this.timers.updateMetrics=setInterval(this.updateMetrics.bind(this),2e4)}},destroy:function(){this.$popover&&(this.$popover.popover("destroy"),this.$popover=null),e("body").off("keydown",this.onKeyDown),e(window).off("resize",this.onResize),n.onchange=function(){},this.zoom=null,this.canvas=null,this.clickInfo=null,this.panInfo=null},getTemplateData:function(){return{editable:this.editable,heff:this.heff}},afterRender:function(){this.model.isLoading()||(this.setUpCanvas(this.getSize()),this.renderLayout(),this.centerView(),this.$("[data-action=pan]").click())},renderLayout:function(){this.renderDivisionAreas()},renderDivisionAreas:function(){var t=this,e=this.model,n=this.canvas.selectAll(".factoryLayout-division").data(e.factoryLayout.get("live")),a=i.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]}).interpolate("linear-closed"),o=i.behavior.drag().origin(function(t){return t.position}).on("dragstart",function(){i.event.sourceEvent.stopPropagation(),t.bringDivisionToTop(this),i.select(this).classed("is-dragging",!0)}).on("dragend",function(){i.select(this).classed("is-dragging",!1)}).on("drag",function(e){e.position.x=i.event.x-i.event.x%10,e.position.y=i.event.y-i.event.y%10,i.select(this).attr("transform","translate("+e.position.x+","+e.position.y+")"),t.dragged=!0}),r=n.enter().insert("g").attr("class","factoryLayout-division").attr("transform",function(t){return"translate("+t.position.x+","+t.position.y+")"}).attr("fill",function(t){return e.settings.factoryLayout?e.settings.factoryLayout.getColor(t._id):(i=t.fillColor||"#000000",n=1,"rgba("+parseInt(i.substr(1,2),16)+","+parseInt(i.substr(3,2),16)+","+parseInt(i.substr(5,2),16)+","+n+")");var i,n}).attr("data-id",function(t){return t._id}).call(this.editable?o:function(){});r.append("path").classed("factoryLayout-division-area",!0).attr("d",function(t){return a(t.points)});var s=e.prodLineStates,c=e.settings.factoryLayout?e.settings.factoryLayout.isBlacklisted.bind(e.settings.factoryLayout):null;r.each(function(e){var n=i.select(this);e.prodLines.forEach(t.renderProdLinesGuide.bind(t,e,n,s?s.getByOrgUnit("division",[e._id],c):null)),t.renderDivisionName(n,e)}),n.exit().remove()},renderDivisionName:function(t,e){for(var i=0,n=0,a=1,o=e.points.length-1;a<o;++a){var r=e.points[a-1],s=e.points[a],c=e.points[a+1];if(s[1]===r[1]&&s[1]>c[1]&&s[0]===c[0]){i=s[0]-(4+8*e._id.length),n=s[1]-16;break}}var l=t.append("g").classed("factoryLayout-divisionName",!0).attr("transform","translate("+i+","+n+")");l.append("rect").attr({x:0,y:0,width:3+8*e._id.length,height:14}),l.append("text").attr({x:2,y:12}).text(e._id)},renderProdLinesGuide:function(t,e,i,n){for(var a=e.append("g").attr({class:"factoryLayout-prodLines",transform:"translate("+n.x+","+n.y+")"}),o=Math.floor(n.h/33),r=0;r<o;++r){var s=i?i.shift():null;if(void 0===s)break;this.renderProdLineBox(a,s,r)}},renderProdLineBox:function(t,e,i){var n=t.append("g").attr({class:"factoryLayout-prodLine",transform:"translate(0,"+33*i+")",style:"font-size: 18px"}),a=this.heff&&e?e.recalcHeff():null,o=0,r=0,s=0;e&&(n.attr("data-id",e.id),a||null===e.get("state")||(n.classed("is-"+e.get("state"),!0),n.classed("is-break",e.isBreak())),a?(o=a.endOfHourPlanned,r=a.totalActual,n.classed("is-heff-"+a.status,!0)):(o=e.getMetricValue("plannedQuantityDone"),r=e.getMetricValue("actualQuantityDone")),s=e.getMetricValue("inspections"));var c=e&&e.get("qi");n.classed({"is-offline":e&&!e.get("online"),"is-extended":e&&e.get("extended"),"is-eff-high":!1,"is-eff-mid":!1,"is-eff-low":!1,"is-inspection-ok":c&&!0===c.ok,"is-inspection-nok":c&&!1===c.ok});var l=e&&e.getOrderEfficiencyClassName();l&&n.classed(l,!0);var d=n.append("g").attr({class:"factoryLayout-prodLine-inner"});d.append("rect").attr({class:"factoryLayout-prodLine-bg",x:0,y:0,width:110,height:22}),d.append("text").attr({class:"factoryLayout-prodLine-name",x:4,y:17}).text(e?e.getLabel():"LPx "+(i+1)),o=this.prepareMetricValue(o),d.append("rect").attr({class:"factoryLayout-metric-bg factoryLayout-metric-plannedQuantityDone-bg",x:110,y:0,width:39,height:22}),d.append("text").attr({class:"factoryLayout-metric-value factoryLayout-metric-plannedQuantityDone",x:115,y:17,"data-length":o.length}).text(o),r=this.prepareMetricValue(r),d.append("rect").attr({class:"factoryLayout-metric-bg factoryLayout-metric-actualQuantityDone-bg",x:149,y:0,width:39,height:22}),d.append("text").attr({class:"factoryLayout-metric-value factoryLayout-metric-actualQuantityDone",x:154,y:17,"data-length":r.length}).text(r),s=this.prepareMetricValue(s),d.append("rect").attr({class:"factoryLayout-metric-bg factoryLayout-metric-inspections-bg",x:188,y:0,width:39,height:22}),d.append("text").attr({class:"factoryLayout-metric-value factoryLayout-metric-inspections",x:193,y:17,"data-length":s.length}).text(s)},setUpCanvas:function(t){var e=this;this.$el.css(t);var n=i.behavior.zoom().on("zoomstart",function(){e.panInfo={time:i.event.sourceEvent.timeStamp,translate:i.event.target.translate()},e.$el.addClass("is-panning"),e.$popover&&(e.$popover.popover("destroy"),e.$popover=null)}).on("zoomend",function(){e.$el.removeClass("is-panning");var t=e.panInfo,n=i.event.target.translate();e.panInfo=null,e.clickInfo&&t.translate[0]===n[0]&&t.translate[1]===n[1]&&e.handleClick()}).on("zoom",function(){e.canvas&&e.canvas.attr("transform","translate("+i.event.translate+")")}),a=i.select(this.el).select("svg").attr("class","factoryLayout-canvas").attr("width",t.width).attr("height",t.height).attr("pointer-events","all").append("g").call(n).on("dblclick.zoom",null).on("wheel.zoom",null);a.append("rect").attr("class","factoryLayout-bg").attr("width",t.width).attr("height",t.height),this.zoom=n,this.canvas&&this.canvas.remove(),this.canvas=a.append("g"),this.canvas.append("rect").attr("class","factoryLayout-area").attr("x","0").attr("y","0").attr("width","1920px").attr("height","1080px"),this.translate(5,5)},translate:function(t,e){this.zoom&&this.zoom.translate([t,e]),this.canvas&&this.canvas.attr("transform","translate("+t+","+e+")")},getSize:function(){return n.element===this.el?{width:window.innerWidth,height:window.innerHeight}:{width:window.innerWidth-28,height:window.innerHeight-28-e(".page > .hd").outerHeight(!0)}},centerView:function(){this.$el.toggleClass("is-fullscreen",n.isFullscreen);var t=[];(this.model.factoryLayout.get("live")||[]).forEach(function(e){e.points.forEach(function(i){t.push([i[0]+e.position.x,i[1]+e.position.y])})}),t.sort((t,e)=>t[0]-e[0]);var e=t[0][0],i=t[t.length-1][0];t.sort((t,e)=>t[1]-e[1]);var a=t[0][1],o=t[t.length-1][1],r=0,s=0;if(n.isFullscreen)r=window.innerWidth,s=window.innerHeight;else{var c=this.el.getBoundingClientRect();r=c.width,s=c.height}var l=i-e,d=o-a,u=Math.round((r-l)/2),h=Math.round((s-d)/2);this.translate(u,h)},getPopoverContent:function(t){var e=this.model.prodLineStates.get(t),i=e&&e.get("state")||"idle",n=null,o=null;if(!this.heff){if("idle"===i)return;if(!(n=e.getCurrentOrder()))return;o=e.getCurrentDowntime()}var r=Date.now();return this.renderPartialHtml(l,{order:n?{name:n.getProductName(),operation:n.getOperationName(),startedAt:a.format(n.get("startedAt"),"LTS"),duration:n.getDurationString(r,!1),quantityDone:n.getQuantityDone(),workerCount:n.getWorkerCount(),sapWorkerCount:n.getWorkerCountSap(),taktTime:a.toString(n.getSapTaktTime()),cycleTime:a.toString(n.getLastTaktTime()),iptCycleTime:a.toString(n.getIptTaktTime()),avgCycleTime:a.toString(n.getAvgTaktTime())}:null,downtime:o?{reason:o.getReasonLabel(),aor:o.getAorLabel(),duration:o.getDurationString(r,!1)}:null,heff:this.heff&&e?e.get("heff"):null})},onKeyDown:function(t){document.msExitFullscreen||122!==t.which||n.isFullscreen||(t.preventDefault(),n.request(this.el))},onResize:function(){this.resize(),this.dragged||this.centerView()},onFullscreen:function(){this.resize(),this.centerView()},resize:function(){var t=this.getSize();this.$el.css(t),this.$("svg").attr(t).find(".factoryLayout-bg").attr(t)},getProdLineOuterContainer:function(t){return i.select('.factoryLayout-prodLine[data-id="'+t+'"]')},onStateChange:function(t){this.updateLineClassNames(t)},updateLineClassNames:function(t){var e=this.getProdLineOuterContainer(t.id);if(!e.empty()){var i={"is-off":!1,"is-idle":!1,"is-working":!1,"is-downtime":!1,"is-break":!this.heff&&t.isBreak(),"is-heff-off":!1,"is-heff-noPlan":!1,"is-heff-unplanned":!1,"is-heff-under":!1,"is-heff-over":!1,"is-heff-underRatio":!1,"is-heff-overRatio":!1};if(this.heff){var n=t.get("heff");n||(n=t.recalcHeff()),i["is-heff-"+n.status]=!0}else i["is-"+(t.get("state")||"off")]=!0;e.classed(i)}},onOnlineChange:function(t){var e=this.getProdLineOuterContainer(t.id);e.empty()||(e.classed("is-offline",!t.get("online")),this.updateTaktTime(t))},onExtendedChange:function(e){var i=this.getProdLineOuterContainer(e.id);i.empty()||(i.classed("is-extended",e.get("extended")),e.get("extended")||(i.style("display","none"),t.defer(function(){i.style("display",null)})))},onQiChange:function(t){var e=this.getProdLineOuterContainer(t.id);if(!e.empty()){var i=t.get("qi");e.classed({"is-inspection-ok":!0===i.ok,"is-inspection-nok":!1===i.ok}),this.updateMetricValue(t,"inspections")}},onPlannedQuantityDoneChange:function(t){this.heff&&t.recalcHeff(),this.updateMetricValue(t,"plannedQuantityDone")},onActualQuantityDoneChange:function(t){this.heff&&t.recalcHeff(),this.updateMetricValue(t,"actualQuantityDone")},onLayoutSettingsChange:function(t){if(/blacklist/.test(t.id))this.canvas.selectAll(".factoryLayout-division").remove(),this.renderLayout();else if(/color/.test(t.id)){var e=t.id.split(".")[1];this.canvas.select('.factoryLayout-division[data-id="'+e+'"]').attr("fill",t.getValue())}else/outOfSyncWindow/.test(t.id)&&this.model.prodLineStates.forEach(function(t){t.recalcHeff()})},onProductionSettingsChange:function(t){/taktTime/.test(t.id)&&this.model.prodLineStates.forEach(this.updateTaktTime,this)},updateTaktTime:function(t){var e=this.getProdLineOuterContainer(t.id);if(!e.empty()){var i=t.getOrderEfficiencyClassName();if(e.classed(i))return;e.classed({"is-eff-high":!1,"is-eff-mid":!1,"is-eff-low":!1}),i&&e.classed(i,!0)}},updateMetricValue:function(e,i){var n=this.getProdLineOuterContainer(e.id);if(!n.empty()){var a=n.select(".factoryLayout-metric-"+i);if(!a.empty()){var o=this.prepareMetricValue(e.getMetricValue(i,this.heff));if(a.text()!==o){var r=+a.attr("data-length");o.length===r?a.text(o):(a.style("display","none"),a.text(o),a.attr("data-length",o.length),t.defer(function(){a.style("display",null)}))}}}},updateMetrics:function(){var t=this;t.model.prodLineStates.forEach(function(e){t.heff?(e.recalcHeff(),t.updateMetricValue(e,"plannedQuantityDone")):t.updateTaktTime(e)})},updateHeffStatus:function(t){this.updateLineClassNames(t)},toggleHeff:function(){var t=this;t.heff=!t.heff,t.$el.toggleClass("is-heff",t.heff),t.model.prodLineStates.forEach(function(e){t.heff&&e.recalcHeff(),t.updateMetricValue(e,"plannedQuantityDone"),t.updateMetricValue(e,"actualQuantityDone"),t.heff||e.set("heff",null)})},prepareMetricValue:function(t,e){return e||(e=3),-1===t?s.start("?",e,"?"):s.start(t.toString(),e," ")},handleClick:function(){var t=this.clickInfo;if(t&&(this.clickInfo=null,2!==t.button)){var e=1===t.button;if("division"===t.type){var i="#factoryLayout;list?orgUnitType=division&orgUnitIds="+encodeURIComponent(t.modelId);e?window.open(i):this.broker.publish("router.navigate",{url:i,trigger:!0,replace:!1})}else"prodLine"===t.type&&this.showProdLinePreview(t.modelId,e)}},showProdLinePreview:function(t,e){var i=this.model.prodLineStates.get(t);if(i&&i.get("prodShift")){var n="#prodShifts/"+t;e?window.open(n):this.broker.publish("router.navigate",{url:n,trigger:!0,replace:!1})}},bringDivisionToTop:function(t){t.parentNode.lastElementChild!==t&&t.parentNode.appendChild(t)}})});