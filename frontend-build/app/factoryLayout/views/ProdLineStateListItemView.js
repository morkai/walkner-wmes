define(["underscore","jquery","app/time","app/user","app/viewport","app/data/orgUnits","app/data/downtimeReasons","app/core/View","app/core/templates/userInfo","app/orders/util/resolveProductName","app/factoryLayout/templates/listItem","app/prodShifts/views/ProdShiftTimelineView","app/prodShifts/views/QuantitiesDoneChartView"],function(e,t,i,n,s,o,a,r,l,h,d,u,m){"use strict";return r.extend({template:d,events:{"click .factoryLayout-quantityDone-prop":function(e){e.currentTarget.classList.contains("is-clickable")&&this.toggleQuantitiesDoneChart()},"mouseup .factoryLayout-prodLineListItem-prodLine":function(e){if(2!==e.button){var t=this.serializeShift();if(t.href)return 1===e.button?window.open(t.href):this.broker.publish("router.navigate",{url:t.href,trigger:!0,replace:!1}),!1}},'click .btn[data-action="comment"]':function(e){var t=this,i=t.model.get("prodShift");if(t.$id("comments").find("form.active").removeClass("active"),i){var n=i.id,o=t.$(e.currentTarget).closest(".factoryLayout-comment"),a=o.find("form"),r=a.find(".form-control"),l=a.find(".btn-primary"),h=+o[0].dataset.i,d=(i.get("comments")||[])[h]||{text:""},u=o[0].getBoundingClientRect();r.val(d.text).css({width:u.width+2+"px",height:Math.max(u.height,100)+"px"}),a.addClass("active"),r.focus(),a.on("submit",function(e){e.preventDefault(),c()}),r.on("keydown",function(e){"Escape"===e.key?m():"Enter"===e.key&&e.ctrlKey&&c()})}function m(){r.off(),a.off(),a.removeClass("active"),r.prop("disabled",!1),l.prop("disabled",!1)}function c(){var e=r.val().trim();if(e===d.text)return m();s.msg.saving(),r.prop("disabled",!0),l.prop("disabled",!0);var i=t.ajax({method:"PUT",url:"/prodShifts/"+n,data:JSON.stringify({comment:{i:h,text:e}})});i.fail(function(){s.msg.savingFailed()}),i.done(function(){s.msg.saved(),m()}),setTimeout(()=>m(),1e3)}}},initialize:function(){this.renderTimeline=e.debounce(this.renderTimeline.bind(this),1),this.timelineView=null,this.quantitiesDoneChartView=null;var t=this.model;this.listenTo(t,"change:online",this.onOnlineChanged),this.listenTo(t,"change:state",this.onStateChanged),this.listenTo(t,"change:extended",this.onExtendedChanged),this.listenTo(t,"change:prodShift",this.onProdShiftChanged),this.listenTo(t,"change:prodShiftOrders",this.onProdShiftOrdersChanged),this.listenTo(t,"change:prodDowntimes",this.onProdDowntimesChanged),this.listenTo(t,"change:taktTime",this.toggleTaktTime),this.listenTo(t,"change:plannedQuantityDone change:actualQuantityDone",e.debounce(this.onMetricsChanged.bind(this),1)),this.listenTo(t.settings.production,"change",this.onProductionSettingsChanged),this.listenTo(this.displayOptions,"change",this.toggleVisibility)},destroy:function(){this.timelineView=null,this.quantitiesDoneChartView=null},getTemplateData:function(){var e=[];this.model.get("online")||e.push("is-offline"),this.model.get("state")&&(e.push("is-"+this.model.get("state")),this.model.isBreak()&&e.push("is-break")),this.model.get("extended")&&e.push("is-extended"),e.push(this.model.getShiftEfficiencyClassName());var t=o.getParent(o.getByTypeAndId("prodLine",this.model.getProdLineId())),i=t?o.getParent(t):null,s=this.serializeOrder(),a=this.serializeNc12(),r=this.serializeDowntime();return{canComment:n.isAllowedTo("PROD_DATA:VIEW","FN:master","FN:leader"),classNames:e.join(" "),prodLine:this.model.getLabel(),prodFlow:i?i.getLabel():"?",workCenter:t?t.getLabel():"?",shift:this.serializeShift(),order:s,nc12:a,downtime:r,quantityDone:this.serializeQuantityDone(),master:this.serializePersonnel("master"),leader:this.serializePersonnel("leader"),operator:this.serializePersonnel("operator")}},serializeShift:function(){var e=this.model.get("prodShift");return e?{text:i.format(e.get("date"),"L")+", "+this.t("core","SHIFT:"+e.get("shift")),href:"#prodShifts/"+(this.displayOptions.isHistoryData()?e.id:this.model.id)}:{text:"?",href:null}},serializePersonnel:function(e){var t=this.model.get("prodShift");if(!t)return"-";var i=t.get(e);if(!i)return"-";var n=i.label.match(/^(.*?)(?:\(.*?\))?$/)[1].trim(),s=n.split(/\s+/),o=s.pop(),a=s.join(" ");return i.label=a+(o.length?" "+o.substring(0,1)+".":""),i.title=n,l(i)},serializeOrder:function(){var e=this.model.get("prodShiftOrders").last(),t="-",i="";if(e){var n=e.get("orderId"),s=e.get("operationNo"),o=h(e.get("orderData"));t=n,o.length?(t+=": "+o,i=o):t+=", "+s}return{label:this.t(!e||e.get("finishedAt")?"prop:lastOrder":"prop:order"),value:t,title:i}},serializeNc12:function(){var e=this.model.get("prodShiftOrders").last();return{label:this.t(!e||e.get("finishedAt")?"prop:lastNc12":"prop:nc12"),value:e?e.getNc12():"-"}},serializeDowntime:function(){var e=this.model.get("prodDowntimes").last(),t=e?a.get(e.get("reason")):null;return{label:this.t(!e||e.get("finishedAt")?"prop:lastDowntime":"prop:downtime"),value:t?t.getLabel():e?"?":"-"}},serializeQuantityDone:function(){var e=this.model.get("actualQuantityDone"),t=this.model.get("plannedQuantityDone");return this.t("qty",{actual:-1===e?"?":e.toLocaleString(),planned:-1===t?"?":t.toLocaleString()})},serializeComments:function(){for(var e=this.model.get("prodShift"),t=e&&e.get("comments")||[],n=[],s=0;s<8;++s){var o=t[s]||{date:null,user:null,text:""},a=0,r="";if(o.date){var l=i.getMoment(o.date);a=l.valueOf(),r=o.user.label+" @ "+l.format("L LT")}n.push({v:a.toString(),title:r,text:o.text})}return n},afterRender:function(){this.timelineView=new u({prodLineId:this.model.id,prodShift:this.model.get("prodShift"),prodShiftOrders:this.model.get("prodShiftOrders"),prodDowntimes:this.model.get("prodDowntimes"),whOrderStatuses:this.whOrderStatuses,editable:!1,resizable:!1,itemHeight:40,calcWidth:this.calcWidth}),this.setView("#-timeline",this.timelineView).render(),this.listenTo(this.timelineView,"chartRendered",this.onTimelineChartRendered);var e=!!this.model.get("prodShift");e&&this.$(".factoryLayout-quantityDone-prop").addClass("is-clickable"),this.$el.toggleClass("has-prodShift",e),this.quantitiesDoneChartView&&(this.quantitiesDoneChartView=null,this.toggleQuantitiesDoneChart()),this.toggleVisibility()},calcWidth:function(){return window.innerWidth-20},renderTimeline:function(){this.timelineView&&this.timelineView.render()},resize:function(){this.timelineView.onWindowResize();var e=this.quantitiesDoneChartView;e&&(e.$el.css("width",this.calcWidth()+"px"),e.chart&&e.chart.reflow())},toggleQuantitiesDoneChart:function(){null===this.quantitiesDoneChartView?this.renderQuantitiesDoneChart():this.destroyQuantitiesDoneChart()},renderQuantitiesDoneChart:function(){this.model.get("prodShift")&&(this.quantitiesDoneChartView=new m({model:this.model.get("prodShift"),height:220,reflow:!1,showTitle:!1,showLegend:!1}),this.setView("#-quantitiesDone",this.quantitiesDoneChartView).render(),this.updateComments(!0),this.$id("quantitiesDone").removeClass("hidden"),this.$id("comments").removeClass("hidden"))},destroyQuantitiesDoneChart:function(){null!==this.quantitiesDoneChartView&&(this.$id("comments").addClass("hidden"),this.$id("quantitiesDone").addClass("hidden"),this.quantitiesDoneChartView.remove(),this.quantitiesDoneChartView=null)},toggleTaktTime:function(){var e=this.model.getShiftEfficiencyClassName();this.$el.hasClass(e)||(this.$el.removeClass("is-eff-low is-eff-mid is-eff-high"),e&&this.$el.addClass(e))},updateComments:function(e){var t=this;if(e||!t.$id("comments").hasClass("hidden")){var i=t.serializeComments();t.$(".factoryLayout-comment").each(function(e,n){var s=i[e];if(s.v!==n.dataset.v){n.dataset.v=s.v,n.title=s.title;var o=n.querySelector("p");s.text?o.textContent=s.text:o.innerHTML="<i>"+t.t("comments:empty")+"</i>"}})}},toggleVisibility:function(){this.$el.toggle(this.displayOptions.isVisible(this.model))},onProductionSettingsChanged:function(e){/taktTime/.test(e.id)&&this.toggleTaktTime()},onOnlineChanged:function(){this.$el.toggleClass("is-offline",!this.model.get("online")),this.toggleVisibility()},onStateChanged:function(){this.$el.removeClass("is-idle is-working is-downtime is-break"),this.model.get("state")&&(this.$el.addClass("is-"+this.model.get("state")),this.$el.toggleClass("is-break",this.model.isBreak())),this.toggleVisibility()},onExtendedChanged:function(){this.$el.toggleClass("is-extended",this.model.get("extended"))},onProdShiftChanged:function(){var e=this;e.$id("shift").html(e.serializeShift().text),["master","leader","operator"].forEach(function(t){e.$id(t).html(e.serializePersonnel(t))});var t=!!e.model.get("prodShift");t||e.destroyQuantitiesDoneChart(),e.$(".factoryLayout-quantityDone-prop").toggleClass("is-clickable",t),e.updateComments(!1)},onProdShiftOrdersChanged:function(e){var t=this.serializeOrder(),i=this.serializeNc12();this.$id("orderLabel").html(t.label),this.$id("orderValue").html(t.value),this.$id("nc12Label").html(i.label),this.$id("nc12Value").html(i.value),e&&e.reset&&this.renderTimeline()},onProdDowntimesChanged:function(e){var t=this.serializeDowntime();this.$id("downtimeLabel").html(t.label),this.$id("downtimeValue").html(t.value),e&&e.reset&&this.renderTimeline()},onMetricsChanged:function(){this.$id("quantityDone").html(this.serializeQuantityDone())},onTimelineChartRendered:function(){this.toggleTaktTime()}})});