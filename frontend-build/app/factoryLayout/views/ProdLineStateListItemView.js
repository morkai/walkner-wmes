// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/data/orgUnits","app/data/downtimeReasons","app/core/View","app/factoryLayout/templates/listItem","app/prodShifts/views/ProdShiftTimelineView"],function(e,t,i,n,o,s,a,r){return s.extend({template:a,events:{},initialize:function(){this.timelineView=null,this.listenTo(this.model,"change:online",this.onOnlineChanged),this.listenTo(this.model,"change:state",this.onStateChanged),this.listenTo(this.model,"change:prodShift",this.onProdShiftChanged),this.listenTo(this.model,"change:prodShiftOrders",this.onProdShiftOrdersChanged),this.listenTo(this.model,"change:prodDowntimes",this.onProdDowntimesChanged),this.listenTo(this.model,"change:plannedQuantityDone change:actualQuantityDone",e.debounce(this.onMetricsChanged.bind(this),1))},destroy:function(){this.timelineView=null},serialize:function(){var e=[];this.model.get("online")||e.push("is-offline"),this.model.get("state")&&e.push("is-"+this.model.get("state"));var t=n.getParent(n.getByTypeAndId("prodLine",this.model.id)),i=t?n.getParent(t):null,o=this.serializeOrder(),s=this.serializeDowntime();return{classNames:e.join(" "),prodLine:this.model.getLabel(),prodFlow:i?i.getLabel():"?",workCenter:t?t.getLabel():"?",shift:this.serializeShift(),order:o,downtime:s,quantitiesDone:this.serializeQuantitiesDone()}},serializeShift:function(){var e=this.model.get("prodShift");return e?i.format(e.get("date"),"YYYY-MM-DD")+", "+t("core","SHIFT:"+e.get("shift")):"?"},serializeOrder:function(){var e=this.model.get("prodShiftOrders").last();return{label:t("factoryLayout",!e||e.get("finishedAt")?"prop:lastOrder":"prop:order"),value:e?e.getLabel(!1):"-"}},serializeDowntime:function(){var e=this.model.get("prodDowntimes").last(),i=e?o.get(e.get("reason")):null;return{label:t("factoryLayout",!e||e.get("finishedAt")?"prop:lastDowntime":"prop:downtime"),value:i?i.getLabel():e?"?":"-"}},serializeQuantitiesDone:function(){var e=this.model.get("actualQuantityDone"),i=this.model.get("plannedQuantityDone");return t("factoryLayout","qty",{actual:-1===e?"?":e.toLocaleString(),planned:-1===i?"?":i.toLocaleString()})},beforeRender:function(){},afterRender:function(){this.timelineView=new r({prodShift:this.model.get("prodShift"),prodShiftOrders:this.model.get("prodShiftOrders"),prodDowntimes:this.model.get("prodDowntimes"),editable:!1,resizable:!1,itemHeight:40,calcWidth:function(){return window.innerWidth-20}}),this.setView(".factoryLayout-timeline-container",this.timelineView).render()},resize:function(){this.timelineView.onWindowResize()},onOnlineChanged:function(){this.$el.toggleClass("is-offline",!this.model.get("online"))},onStateChanged:function(){this.$el.removeClass("is-idle is-working is-downtime"),this.model.get("state")&&this.$el.addClass("is-"+this.model.get("state"))},onProdShiftChanged:function(){this.$("[role=shift]").html(this.serializeShift())},onProdShiftOrdersChanged:function(){var e=this.serializeOrder();this.$("[role=orderLabel]").html(e.label),this.$("[role=orderValue]").html(e.value)},onProdDowntimesChanged:function(){var e=this.serializeDowntime();this.$("[role=downtimeLabel]").html(e.label),this.$("[role=downtimeValue]").html(e.value)},onMetricsChanged:function(){this.$("[role=quantitiesDone]").html(this.serializeQuantitiesDone())}})});