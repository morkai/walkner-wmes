// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","underscore","js2form","app/i18n","app/time","app/viewport","app/core/View","app/core/util/buttonGroup","app/factoryLayout/views/OrgUnitPickerView","app/factoryLayout/templates/displayOptions"],function(t,e,s,i,a,o,l,d,n,r){"use strict";return l.extend({template:r,events:{submit:function(t){t.preventDefault(),this.loadHistory()},'change [name="statuses[]"]':function(){this.model.set("statuses",d.getValue(this.$id("statuses")))},'change [name="states[]"]':function(){this.model.set("states",d.getValue(this.$id("states")))},'change [name="blacklisted"]':function(){this.model.set("blacklisted","1"===d.getValue(this.$id("blacklisted")))},"click #-showPicker":function(){var t=new n({model:{orgUnitType:this.model.get("orgUnitType"),orgUnitIds:this.model.get("orgUnitIds")}});this.listenTo(t,"picked",function(t,e){o.closeDialog(),this.model.set({orgUnitType:t,orgUnitIds:e})}),o.showDialog(t,i("factoryLayout","picker:title"))},"click #-save":function(){this.model.save(),o.msg.show({type:"success",time:1e3,text:i("factoryLayout","options:saved")})},"click #-resetHistory":function(){this.$id("from").val(""),this.$id("to").val(""),this.$id("shifts").find("input").prop("checked",!0),d.toggle(this.$id("shifts")),this.model.set({from:null,to:null,shifts:["1","2","3"]})}},afterRender:function(){s(this.el,this.serializeFormData()),d.toggle(this.$id("statuses")),d.toggle(this.$id("states")),d.toggle(this.$id("blacklisted")),d.toggle(this.$id("shifts")),this.toggleHistoryData()},serializeFormData:function(){var t=this.model.get("from"),s=this.model.get("to");return{statuses:this.model.get("statuses"),states:this.model.get("states"),blacklisted:this.model.get("blacklisted")?"1":"0",from:e.isNumber(t)?a.format(t,"YYYY-MM-DD"):"",to:e.isNumber(s)?a.format(s,"YYYY-MM-DD"):"",shifts:this.model.get("shifts")}},loadHistory:function(){var t=this.$id("from"),e=this.$id("to"),s=this.$id("shifts"),l=a.getMoment(t.val()),n=a.getMoment(e.val());if(l.isValid()&&n.isValid()){if(l.valueOf()>n.valueOf()){var r=l;l=n,n=r}if(n.valueOf()===l.valueOf())n.add(1,"days");else if(n.valueOf()-l.valueOf()>6048e5)return o.msg.show({type:"warning",time:2500,text:i("factoryLayout","msg:historyDataRange")});t.val(l.format("YYYY-MM-DD")),e.val(n.format("YYYY-MM-DD"));var h=d.getValue(s);0===h.length&&(h=["1","2","3"],s.find("input").prop("checked",!0),d.toggle(s)),this.model.set({from:l.valueOf(),to:n.valueOf(),shifts:h})}},toggleHistoryData:function(){var t=this.model.isHistoryData();this.$id("statuses").find(".btn").toggleClass("disabled",t),this.$id("states").find(".btn").toggleClass("disabled",t),this.$id("blacklisted").find(".btn").toggleClass("disabled",t),this.$id("save").toggleClass("disabled",t)}})});