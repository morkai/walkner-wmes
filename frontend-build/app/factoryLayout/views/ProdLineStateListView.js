// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","d3","screenfull","app/viewport","app/core/View","app/factoryLayout/templates/list","./ProdLineStateListItemView"],function(t,e,i,s,n,o,h,d){return o.extend({template:h,initialize:function(){this.onKeyDown=this.onKeyDown.bind(this),this.onResize=t.debounce(this.onResize.bind(this),16),this.toggleIsEmptyAsync=t.debounce(this.toggleIsEmpty,1),this.lastWidth=null,this.listenTo(this.displayOptions,"change:orgUnitType change:orgUnitIds",t.debounce(this.render,1)),this.listenTo(this.model.settings,"change",this.onSettingsChange),e("body").on("keydown",this.onKeyDown),e(window).on("resize",this.onResize)},destroy:function(){e("body").off("keydown",this.onKeyDown),e(window).off("resize",this.onResize)},beforeRender:function(){this.stopListening(this.model.prodLineStates,"reset",this.render),this.stopListening(this.model.prodLineStates,"change:online change:state",this.toggleIsEmptyAsync),this.stopListening(this.displayOptions,"change:statuses change:states",this.toggleIsEmptyAsync)},afterRender:function(){this.listenToOnce(this.model.prodLineStates,"reset",this.render),this.getProdLineStates().forEach(this.renderProdLineState,this),this.listenTo(this.model.prodLineStates,"change:online change:state",this.toggleIsEmptyAsync),this.listenTo(this.displayOptions,"change:statuses change:states",this.toggleIsEmptyAsync),this.toggleIsEmpty()},getProdLineStates:function(){return this.model.prodLineStates.getByOrgUnit(this.displayOptions.get("orgUnitType"),this.displayOptions.get("orgUnitIds"),this.model.settings.isBlacklisted.bind(this.model.settings))},renderProdLineState:function(t){var e=new d({keep:!1,model:t,displayOptions:this.displayOptions});this.insertView(e).render()},onKeyDown:function(t){122!==t.which||s.isFullscreen||(t.preventDefault(),s.request(this.el.parentNode))},onResize:function(){window.innerWidth!==this.lastWidth&&(this.lastWidth=window.innerWidth,this.getViews().each(function(t){t.resize()}))},onSettingsChange:function(t){/blacklist/.test(t.id)&&this.render()},toggleIsEmpty:function(){this.$el.toggleClass("is-empty",0===this.$("tbody:visible").length)}})});