// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","js2form","app/i18n","app/core/View","app/purchaseOrders/templates/filter"],function(e,i,r,t,a){return t.extend({template:a,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()}},initialize:function(){this.idPrefix=e.uniqueId("poFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();i(this.el.querySelector(".filter-form"),e)},serializeRqlQuery:function(){var i=this.model.rqlQuery,r={_id:"",nc12:"",from:"",to:"",limit:i.limit<5?5:i.limit>100?100:i.limit};return i.selector.args.forEach(function(i){var t=i.args[0];switch(t){case"_id":r._id=e.isString(i.args[1])?i.args[1].replace(/^[0-9]/g,""):"";break;case"items.nc12":r.nc12=e.isString(i.args[1])?i.args[1].replace(/[^0-9]/g,""):"-";break;case"items.schedule.date":}}),r},changeFilter:function(){var e=this.model.rqlQuery,i=e.selector.args.filter(function(e){return"populate"===e.name});this.serializeRegexTerm(i,this.$id("_id"),"_id",6),this.serializeRegexTerm(i,this.$id("nc12"),"items.nc12",12),e.selector={name:"and",args:i},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},serializeRegexTerm:function(e,i,r,t){var a=i.val().trim().replace(/[^0-9]/g,"");i.val(a),a.length===t?e.push({name:"eq",args:[r,a]}):a.length>0&&e.push({name:"regex",args:[r,a]})}})});