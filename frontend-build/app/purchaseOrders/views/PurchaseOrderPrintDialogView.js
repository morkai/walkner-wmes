// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["js2form","form2js","app/i18n","app/viewport","app/core/View","app/purchaseOrders/templates/printDialog"],function(t,e,i,r,a,s){return a.extend({dialogClassName:"pos-printDialog",template:s,events:{"focus .form-control":"toggleRowFocus","blur .form-control":"toggleRowFocus","change .pos-printDialog-qty":"recountTotals","keyup .pos-printDialog-qty":"recountTotals","blur .pos-printDialog-qty":function(t){t.target.value=Math.min(t.target.max,this.parseQty(t.target.value)).toLocaleString()},submit:"submitForm"},initialize:function(){this.decimalSeparator=1.1.toLocaleString().substr(1,1),this.$msg=null},destroy:function(){this.hideMessage()},serialize:function(){return{idPrefix:this.idPrefix,action:"/purchaseOrders/"+this.model.get("orderId")+"/prints",barcodes:["code128","qr"],papers:["a4","104x42"],items:this.model.get("items").map(function(t){return{_id:t._id,nc12:t.nc12}})}},afterRender:function(){t(this.el,this.model.toJSON()),this.recountTotals()},hideMessage:function(){null!==this.$msg&&(r.msg.hide(this.$msg),this.$msg=null)},toggleRowFocus:function(t){t.currentTarget.parentNode.parentNode.classList.toggle("is-focused")},recountTotals:function(){var t=0,e=0,i=0,r=0,a=0,s=this;this.$(".pos-printDialog-items-item").each(function(){var o=this,n=o.querySelectorAll(".pos-printDialog-qty"),l=s.parseQty(n[0].value),p=s.parseQty(n[1].value),c=s.parseQty(n[2].value);0===l&&(p=0),0===p&&(l=0);var g=l+(c>0?1:0),u=l*p+c;t+=l,e+=p,i+=c,r+=g,a+=u,o.querySelector(".pos-printDialog-items-totalPackageQty").innerText=g.toLocaleString(),o.querySelector(".pos-printDialog-items-totalQty").innerText=u.toLocaleString()}),this.$id("overallPackageQty").text(t.toLocaleString()),this.$id("overallComponentQty").text(e.toLocaleString()),this.$id("overallRemainingQty").text(i.toLocaleString()),this.$id("overallTotalPackageQty").text(r.toLocaleString()),this.$id("overallTotalQty").text(a.toLocaleString())},submitForm:function(){this.hideMessage();var t=this.serializeFormData(),e=this.ajax({type:"POST",url:this.el.action,data:JSON.stringify(t)}),a=this.$("input, button, select").attr("disabled",!0),s=a.filter(".btn-primary").find(".fa").removeClass("fa-print").addClass("fa-spin fa-spinner"),o=this;return e.fail(function(t,e){if("abort"!==e){var a=t.responseJSON.error.message;o.$msg=r.msg.show({type:"error",time:8e3,text:i.has("purchaseOrders","printDialog:msg:"+a)?i("purchaseOrders","printDialog:msg:"+a):i("purchaseOrders","printDialog:msg:failure")})}}),e.done(function(e){o.model.set({shippingNo:t.shippingNo,paper:t.paper,barcode:t.barcode}),localStorage.setItem("POS:PAPER",t.paper),localStorage.setItem("POS:BARCODE",t.barcode),o.trigger("print",e)}),e.always(function(){s.removeClass("fa-spin fa-spinner").addClass("fa-print"),a.attr("disabled",!1)}),!1},serializeFormData:function(){var t=e(this.el);return t.items=t.items.map(function(t){t.packageQty=this.parseQty(t.packageQty),t.componentQty=this.parseQty(t.componentQty),t.remainingQty=this.parseQty(t.remainingQty);var e=t.packageQty*t.componentQty+t.remainingQty;return 0===e?null:t},this).filter(function(t){return null!==t}),t},parseQty:function(t){var e=String(t).split(this.decimalSeparator),i=parseInt(e[0].replace(/[^0-9]+/g,""),10),r=e.length>1?parseInt(e[1].replace(/[^0-9]+/g,""),10):0;return i=isNaN(i)?"0":i.toString(),r=isNaN(r)?"0":r.toString(),"0"===r?"0"===i?0:parseInt(i,10):parseFloat(i+"."+r.substr(0,3))}})});