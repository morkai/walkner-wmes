// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/Model","app/core/View","./PurchaseOrderPrintDialogView","app/purchaseOrders/templates/items"],function(t,e,i,s,n,a,l,o,r){return l.extend({template:r,events:{"mouseover .pos-items-item":"highlightItemScheduleRows","mouseout .pos-items-item":"highlightItemScheduleRows","mouseover .pos-items-item-schedule":"highlightItemRow","mouseout .pos-items-item-schedule":"highlightItemRow","change [name=status]":function(){this.state.set("statuses",this.$("[name=status]:checked").map(function(){return this.value}).get())},"click .is-selectable":function(e){if(!this.state.get("printing")){var i=this.state.get("selected"),s=e.currentTarget.dataset.itemId;-1===i.indexOf(s)?this.state.set("selected",[s].concat(i)):this.state.set("selected",t.without(i,s))}},"click #-selectAll":function(){var t=this.model.get("items").where({completed:!1}).map(function(t){return t.id});this.state.set("selected",t)},"click #-selectNone":function(){this.state.set("selected",[])},"click #-print":"showPrintDialog"},initialize:function(){this.state=new a({printing:!1,statuses:null,selected:[]}),this.print=new a({orderId:null,shippingNo:"",paper:localStorage.getItem("POS:PAPER")||"a4",barcode:localStorage.getItem("POS:BARCODE")||"code128",items:[]}),this.printWindow=null,this.$msg=null,this.listenTo(this.state,"change:printing",this.togglePrintingStatus),this.listenTo(this.state,"change:selected",this.toggleItemSelection),this.listenTo(this.state,"change:statuses",this.toggleItemVisibility)},destroy:function(){this.hideMessage(),this.state=null,this.print=null,this.printWindow=null},serialize:function(){var t=this.model;return{idPrefix:this.idPrefix,toolbarVisible:t.get("open")&&s.isAllowedTo("PURCHASE_ORDERS:MANAGE"),open:t.get("open"),items:t.get("items").invoke("serialize")}},afterRender:function(){this.model.get("open")&&(this.fixLastItemRow(),this.toggleItemVisibility(),this.toggleItemSelection())},hideMessage:function(){null!==this.$msg&&(n.msg.hide(this.$msg),this.$msg=null)},fixLastItemRow:function(){var t=this.model.get("items"),e=t.last();if(!e.completed){var i=e.get("schedule");1!==i.length&&this.$(".pos-items-item").last().addClass("is-last")}},toggleItemVisibility:function(){if(!this.model.get("open"))return this.$(".hidden").removeClass("hidden");var t=this.state.get("statuses"),e=this.$("input[name=status]");null===t&&(e.filter("[value=waiting]").attr("checked",!0).parent().addClass("active"),t=["waiting"],this.state.set("statuses",["waiting"],{silent:!0}));var i=this;e.each(function(){i.$(".is-"+this.value).toggleClass("hidden",!this.checked)});var s=-1===t.indexOf("waiting");s&&this.state.set("selected",[]),this.$id("selectAll").attr("disabled",s),this.$id("selectNone").attr("disabled",s)},toggleItemSelection:function(){this.$(".is-selected").removeClass("is-selected");var t=this.state.get("selected");this.$id("print").attr("disabled",!t.length),t.length&&this.$(".is-selectable > .pos-rowSeparator").each(function(){-1!==t.indexOf(this.parentNode.dataset.itemId)&&this.classList.add("is-selected")})},togglePrintingStatus:function(){var t=this.state.get("printing");this.$id("selectAll").attr("disabled",t),this.$id("selectNone").attr("disabled",t),this.$id("print").attr("disabled",!0),this.$el.toggleClass("is-printing",t),this.printWindow&&(this.printWindow.closed||this.printWindow.close(),this.printWindow=null),this.state.set("selected",[])},highlightItemScheduleRows:function(t){var e=t.currentTarget,i=e.dataset.scheduleLength-1;if(0!==i)for(var s=0;i>s;++s)e=e.nextElementSibling,e.classList.toggle("is-hovered")},highlightItemRow:function(t){for(var e=t.currentTarget;;){if(e=e.previousElementSibling,null===e)break;if(e.classList.toggle("is-hovered"),e.classList.contains("pos-items-item"))break}for(e=t.currentTarget;;){if(e=e.nextElementSibling,null===e||e.classList.contains("pos-items-item"))break;e.classList.toggle("is-hovered")}},showPrintDialog:function(){this.$id("print").blur(),n.msg.loading();var e=this,s=this.model.get("items"),a=this.state.get("selected").map(function(t){var e=s.get(t);return{_id:+e.id,nc12:e.get("nc12"),packageQty:0,componentQty:0,remainingQty:e.get("schedule")[0].qty}}).sort(function(t,e){return t._id-e._id}),l=this.ajax({type:"GET",url:"/purchaseOrders;getLatestComponentQty",data:{nc12:t.unique(t.pluck(a,"nc12"))}});l.always(function(t,s){var l="success"===s?t:{};a.forEach(function(t){var e=l[t.nc12];!e||t.remainingQty<e||(t.packageQty=Math.floor(t.remainingQty/e),t.componentQty=e,t.remainingQty=t.remainingQty%e)}),e.print.set({orderId:e.model.id,items:a});var r=new o({model:e.print});e.listenToOnce(r,"print",e.onPrintRequest.bind(e)),n.msg.loaded(),n.showDialog(r,i("purchaseOrders","printDialog:title"))})},onPrintRequest:function(t){this.state.set("printing",!0),this.broker.subscribe("viewport.dialog.hidden",this.openPrintPopup.bind(this,t)).setLimit(1),n.closeDialog()},openPrintPopup:function(t){var e="/purchaseOrders/"+this.model.id+"/prints/"+t+".html",s="WMES_PO_LABEL_PRINTING",a=window.screen,l=.6*a.availWidth,o=.8*a.availHeight,r=Math.floor((a.availWidth-l)/2),h=Math.floor((a.availHeight-o)/2),d="resizable,scrollbars,location=no,top="+h+",left="+r+",width="+Math.floor(l)+",height="+Math.floor(o);if(this.printWindow=window.open(e,s,d),this.printWindow){var c=this;window.WMES_PO_PRINT_DONE=function(){delete window.WMES_PO_PRINT_DONE,c.state.set("printing",!1)}}else this.$msg=n.msg.show({type:"error",time:6e3,text:i("purchaseOrders","printDialog:msg:blocked")}),this.state.set("printing",!1)}})});