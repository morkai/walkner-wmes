// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/Model","app/core/View","./PurchaseOrderPrintDialogView","app/purchaseOrders/templates/items","app/purchaseOrders/templates/printsPopover"],function(t,e,i,s,n,o,r,a,l,d){return r.extend({template:l,events:{"mouseover .pos-items-item":"highlightItemScheduleRows","mouseout .pos-items-item":"highlightItemScheduleRows","mouseover .pos-items-item-schedule":"highlightItemRow","mouseout .pos-items-item-schedule":"highlightItemRow","click .popover":function(t){return t.target.classList.contains("popover-title")},"change [name=status]":function(){this.state.set("statuses",this.$("[name=status]:checked").map(function(){return this.value}).get())},"click .is-clickable":function(t){return this.showItemPrints(t.currentTarget.parentNode.dataset.itemId),!1},"click .is-selectable":function(e){if(!this.state.get("printing")){var i=this.state.get("selected"),s=e.currentTarget.dataset.itemId;-1===i.indexOf(s)?this.state.set("selected",[s].concat(i)):this.state.set("selected",t.without(i,s))}},"click #-selectAll":function(){var t=this.model.get("items").where({completed:!1}).map(function(t){return t.id});this.state.set("selected",t)},"click #-selectNone":function(){this.state.set("selected",[])},"click #-print":"showPrintDialog","click .action-showPrintPdf":function(t){this.showPrintPdf(this.$(t.currentTarget).closest("tr").attr("data-print-id"))},"click .action-toggleCancelled":function(t){this.toggleCancelledPrint(this.$popover.data("itemId"),this.$(t.currentTarget).closest("tr").attr("data-print-id"))}},initialize:function(){this.onBodyClick=this.onBodyClick.bind(this),this.deferRender=t.debounce(this.render.bind(this),1),this.state=new o({printing:!1,statuses:null,selected:[]}),this.print=new o({orderId:null,shippingNo:"",paper:localStorage.getItem("POS:PAPER")||"a4",barcode:localStorage.getItem("POS:BARCODE")||"code128",items:[]}),this.printWindow=null,this.$msg=null,this.$popover=null,this.lastPopoverId=null,this.listenTo(this.state,"change:printing",this.togglePrintingStatus),this.listenTo(this.state,"change:selected",this.toggleItemSelection),this.listenTo(this.state,"change:statuses",this.toggleItemVisibility),e("body").on("click",this.onBodyClick)},destroy:function(){e("body").off("click",this.onBodyClick),this.hideMessage(),this.hidePopover(!0),this.state=null,this.print=null,this.printWindow=null},serialize:function(){var t=this.model,e=0,i=0,n=t.get("items").map(function(t){return t.get("completed")?++i:++e,t.serialize()});return{idPrefix:this.idPrefix,toolbarVisible:t.get("open")&&s.isAllowedTo("PURCHASE_ORDERS:MANAGE"),open:t.get("open"),items:n,waitingCount:e.toLocaleString(),completedCount:i.toLocaleString()}},beforeRender:function(){this.stopListening(this.model,"change:open",this.deferRender),this.stopListening(this.model.get("items"),"change",this.deferRender),null!==this.$popover&&(this.lastPopoverId=this.$popover.data("itemId"),this.hidePopover(!0))},afterRender:function(){this.listenToOnce(this.model,"change:open",this.deferRender),this.listenToOnce(this.model.get("items"),"change",this.deferRender),this.model.get("open")&&(this.fixLastItemRow(),this.fixToolbarState(),this.togglePrintingStatus(),this.toggleItemVisibility(),this.toggleItemSelection()),null!==this.lastPopoverId&&(this.$('.pos-items-item[data-item-id="'+this.lastPopoverId+'"]').find(".is-clickable").click(),this.lastPopoverId=null)},hideMessage:function(){null!==this.$msg&&(n.msg.hide(this.$msg),this.$msg=null)},hidePopover:function(t){null!==this.$popover&&(this.$popover.popover(t?"destroy":"hide"),this.$popover=null)},fixLastItemRow:function(){var t=this.model.get("items"),e=t.last();if(!e.completed){var i=e.get("schedule");1!==i.length&&this.$(".pos-items-item").last().addClass("is-last")}},fixToolbarState:function(){var t=this.$(".btn-toolbar");(this.state.get("statuses")||[]).forEach(function(e){t.find("input[value="+e+"]").attr("checked",!0).parent().addClass("active")})},toggleItemVisibility:function(){if(!this.model.get("open"))return this.$(".hidden").removeClass("hidden");var t=this.state.get("statuses"),e=this.$("input[name=status]");null===t&&(e.filter("[value=waiting]").attr("checked",!0).parent().addClass("active"),t=["waiting"],this.state.set("statuses",["waiting"],{silent:!0}));var i=this;e.each(function(){i.$(".is-"+this.value).toggleClass("hidden",!this.checked)});var s=-1===t.indexOf("waiting");s&&this.state.set("selected",[]);var n=this.state.get("printing");this.$id("selectAll").prop("disabled",n||s),this.$id("selectNone").prop("disabled",n||s)},toggleItemSelection:function(){this.$(".is-selected").removeClass("is-selected");var t=this.state.get("selected"),e=this.state.get("printing");this.$id("print").prop("disabled",e||!t.length),t.length&&this.$(".is-selectable > .pos-rowSeparator").each(function(){if(-1!==t.indexOf(this.parentNode.dataset.itemId)){this.classList.add("is-selected");for(var e=this.parentNode;e.nextElementSibling&&(e=e.nextElementSibling,e.classList.contains("pos-items-item")||e.classList.contains("pos-items-item-schedule"));)e.classList.add("is-selected")}})},togglePrintingStatus:function(){var t=this.state.get("printing");this.$id("statuses").find(".btn").toggleClass("disabled",t),this.$id("selectAll").prop("disabled",t),this.$id("selectNone").prop("disabled",t),this.$id("print").prop("disabled",!0),this.$el.toggleClass("is-printing",t),t||this.state.set("selected",[])},highlightItemScheduleRows:function(t){this.$(".is-hovered").removeClass("is-hovered");var e=t.currentTarget,i=e.dataset.scheduleLength-1;if(0!==i&&"mouseout"!==t.type)for(var s=0;i>s;++s)e=e.nextElementSibling,e.classList.add("is-hovered")},highlightItemRow:function(t){for(var e=t.currentTarget;;){if(e=e.previousElementSibling,null===e)break;if(e.classList.toggle("is-hovered"),e.classList.contains("pos-items-item"))break}for(e=t.currentTarget;;){if(e=e.nextElementSibling,null===e||e.classList.contains("pos-items-item"))break;e.classList.toggle("is-hovered")}},showPrintDialog:function(){this.$id("print").blur(),n.msg.loading();var e=this,s=this.model.get("items"),o=this.state.get("selected").map(function(t){var e=s.get(t);return{_id:+e.id,nc12:e.get("nc12"),packageQty:0,componentQty:0,remainingQty:e.get("schedule")[0].qty}}).sort(function(t,e){return t._id-e._id}),r=this.ajax({type:"GET",url:"/purchaseOrders;getLatestComponentQty",data:{nc12:t.unique(t.pluck(o,"nc12"))}});r.always(function(t,s){var r="success"===s?t:{};o.forEach(function(t){var e=r[t.nc12];!e||t.remainingQty<e||(t.packageQty=Math.floor(t.remainingQty/e),t.componentQty=e,t.remainingQty=t.remainingQty%e)}),e.print.set({orderId:e.model.id,items:o});var l=new a({model:e.print});e.listenToOnce(l,"print",e.onPrintRequest.bind(e)),n.msg.loaded(),n.showDialog(l,i("purchaseOrders","printDialog:title"))})},onPrintRequest:function(t){this.state.set("printing",!0),this.broker.subscribe("viewport.dialog.hidden",this.openPrintPopup.bind(this,t)).setLimit(1),n.closeDialog()},openPrintPopup:function(t){var e="/purchaseOrders/"+this.model.id+"/prints/"+t+".html",s="WMES_PO_LABEL_PRINTING",o=window.screen,r=.6*o.availWidth,a=.8*o.availHeight,l=Math.floor((o.availWidth-r)/2),d=Math.floor((o.availHeight-a)/2),h="resizable,scrollbars,location=no,top="+d+",left="+l+",width="+Math.floor(r)+",height="+Math.floor(a);if(this.printWindow=window.open(e,s,h),this.printWindow){var c=this;this.printWindow.onbeforeunload=window.WMES_PO_PRINT_DONE=function(){c.printWindow.onbeforeunload=null,c.printWindow=null,delete window.WMES_PO_PRINT_DONE,c.state.set("printing",!1)}}else this.$msg=n.msg.show({type:"error",time:6e3,text:i("purchaseOrders","printDialog:msg:blocked")}),this.state.set("printing",!1)},showItemPrints:function(t){var e=null;null!==this.$popover&&(e=this.$popover.data("itemId"),this.hidePopover(!1)),t!==e&&(this.$popover=this.$('.pos-items-item[data-item-id="'+t+'"]').find(".pos-items-item-prints").data("itemId",t),this.$popover.popover({animation:null===this.lastPopoverId,trigger:"manual",html:!0,title:i("purchaseOrders","prints:title"),content:d({orderId:this.model.id,prints:this.model.get("items").get(t).get("prints")})}),this.$popover.popover("show"))},onBodyClick:function(){this.hidePopover(!1)},showPrintPdf:function(t){window.open("/purchaseOrders/"+this.model.id+"/prints/"+t+".pdf")},toggleCancelledPrint:function(e,i){var s=this.$('.pos-prints-print[data-print-id="'+i+'"]'),n=s.find(".action-toggleCancelled");n.prop("disabled",!0);var o=this.model.get("items").get(e),r=t.find(o.get("prints"),function(t){return t._id===i}),a=this.ajax({type:"POST",url:"/purchaseOrders/"+this.model.id+"/prints;cancel",data:JSON.stringify({__v:this.model.get("__v"),itemId:e,printId:i,cancelled:!r.cancelled})});a.always(function(){n.prop("disabled",!1)})}})});