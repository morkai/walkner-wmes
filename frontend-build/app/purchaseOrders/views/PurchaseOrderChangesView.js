// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/time","app/core/View","app/purchaseOrders/templates/changes","app/purchaseOrders/templates/newItemsChange","app/purchaseOrders/templates/itemScheduleChange"],function(e,t,i,n,s,a,r,h){return s.extend({template:a,events:{"mouseover .pos-changes-change-next":function(e){this.highlightDateCell(e.currentTarget)},"mouseout .pos-changes-change-next":function(e){this.highlightDateCell(e.currentTarget)},"click #-more":"showAllChanges"},initialize:function(){this.hidden=!0},serialize:function(){return{idPrefix:this.idPrefix,changes:this.serializeChanges(),hidden:this.hidden}},serializeChanges:function(){var e=[],t=this.model.get("changes"),s=t.length-1;return t.forEach(function(t,a){var h=[],l=[];Object.keys(t.data).forEach(function(e){var i=t.data[e],n=this.serializeChange(e,i[0],i[1]);"item"===n.key?l.push(n.newValue):"importedAt"===n.key?h.unshift(n):h.push(n)},this),l.length&&h.push({key:"newItems",name:i("purchaseOrders","changes:newItems"),oldValue:"-",newValue:r({items:l})}),e.push({visible:!this.hidden||3>s||0===a||a===s,date:n.format(t.date,"LLLL"),properties:h})},this),e},serializeChange:function(e,t,n){var s=e.split("/"),a=e,r=e;return 1===s.length?r=i("purchaseOrders","PROPERTY:"+e):"items"===s[0]&&(r=i("purchaseOrders","PROPERTY:item",{itemNo:s[1]}),a="item",3===s.length&&(r=i("purchaseOrders","changes:itemProp",{item:r,prop:i("purchaseOrders","PROPERTY:item."+s[2])}),a+="."+s[2])),{key:a,name:r,oldValue:this.serializeChangeValue(a,t),newValue:this.serializeChangeValue(a,n)}},serializeChangeValue:function(t,s){if(null===s)return"-";var a=typeof s;if("boolean"===a)return i("core","BOOL:"+s);if("number"===a)return s.toLocaleString();var r=Date.parse(s);return isNaN(r)?"string"===a?e.escape(s):"item"===t?this.serializeItemChangeValue(s):"item.schedule"===t?h({schedule:s}):e.escape(JSON.stringify(s)):n.format(r,"LLLL")},serializeItemChangeValue:function(e){return{_id:e._id,nc12:e.nc12,unit:e.unit,qty:e.qty.toLocaleString(),name:e.name,schedule:h({schedule:e.schedule})}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.render)},afterRender:function(){this.listenToOnce(this.model,"change:changes",this.render),this.$(".pos-changes-change").last().addClass("is-last")},highlightDateCell:function(e){this.$(e).prevAll(".pos-changes-change").first().find(".pos-changes-date").toggleClass("is-hovered")},showAllChanges:function(){this.$id("more").remove(),this.$(".hidden").removeClass("hidden"),this.hidden=!1}})});