// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/core/View","app/core/templates/userInfo","app/purchaseOrders/templates/changes","app/purchaseOrders/templates/newItemsChange","app/purchaseOrders/templates/itemScheduleChange","app/purchaseOrders/templates/printsChange"],function(e,t,s,n,i,r,a,h,l,c){"use strict";return i.extend({template:a,events:{"mouseover .pos-changes-change-next":function(e){this.highlightDateAndUserCell(e.currentTarget)},"mouseout .pos-changes-change-next":function(e){this.highlightDateAndUserCell(e.currentTarget)},"mouseover .pos-changes-prints-item":function(e){this.highlightPrintCells(e.currentTarget)},"mouseout .pos-changes-prints-item":function(e){this.highlightPrintCells(e.currentTarget)},"click #-more":"showAllChanges"},initialize:function(){this.hidden=!0},serialize:function(){return{idPrefix:this.idPrefix,changes:this.serializeChanges(),hidden:this.hidden}},serializeChanges:function(){var e=[],t=this.model.get("changes"),i=t.length-1;return t.forEach(function(t,a){var l=[],c=[];Object.keys(t.data).forEach(function(e){var s=t.data[e],n=this.serializeChange(e,s[0],s[1]);"item"===n.key?c.push(n.newValue):"importedAt"===n.key?l.unshift(n):l.push(n)},this),c.length&&l.push({key:"newItems",name:s("purchaseOrders","changes:newItems"),oldValue:"-",newValue:h({items:c})}),e.push({visible:!this.hidden||i<3||0===a||a===i,date:n.format(t.date,"LLLL"),user:r({userInfo:t.user}),properties:l})},this),e},serializeChange:function(e,t,n){var i=e.split("/"),r=e,a=e;return 1===i.length?a=s("purchaseOrders","PROPERTY:"+e):"items"===i[0]&&(a=s("purchaseOrders","PROPERTY:item",{itemNo:i[1]}),r="item",3===i.length?(r+="."+i[2],a=s("purchaseOrders","changes:itemProp",{item:a,prop:s("purchaseOrders","PROPERTY:"+r)})):"cancelled"===i[4]&&(r+=".prints."+i[4],a=s("purchaseOrders","changes:itemProp",{item:a,prop:s("purchaseOrders","changes:printCancelled",{printIndex:parseInt(i[3],10)+1})}))),{key:r,name:a,oldValue:this.serializeChangeValue(r,t),newValue:this.serializeChangeValue(r,n)}},serializeChangeValue:function(t,i){if(null===i)return"-";var r=typeof i;if("boolean"===r)return s("core","BOOL:"+i);if("number"===r)return i.toLocaleString();var a=Date.parse(i);return isNaN(a)?"string"===r?e.escape(i):"item"===t?this.serializeItemChangeValue(i):"item.schedule"===t?l({schedule:i}):"prints"===t?c({change:i}):e.escape(JSON.stringify(i)):n.format(a,"LLLL")},serializeItemChangeValue:function(e){return{_id:e._id,nc12:e.nc12,unit:e.unit,qty:e.qty.toLocaleString(),name:e.name,schedule:l({schedule:e.schedule})}},beforeRender:function(){this.stopListening(this.model,"change:changes",this.render)},afterRender:function(){this.listenToOnce(this.model,"change:changes",this.render),this.$(".pos-changes-change").last().addClass("is-last")},highlightDateAndUserCell:function(e){this.$(e).prevAll(".pos-changes-change").first().find("[rowspan]").toggleClass("is-hovered")},highlightPrintCells:function(e){this.$(e).parent().children().first().find("[rowspan]").toggleClass("is-hovered")},showAllChanges:function(){this.$id("more").remove(),this.$(".hidden").removeClass("hidden"),this.hidden=!1}})});