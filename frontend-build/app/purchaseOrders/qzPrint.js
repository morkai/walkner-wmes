// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","deployJava","app/broker","app/purchaseOrders/templates/qzPrintInitWarning"],function(n,e,i,r){function t(){}function o(){n("body").prepend(r())}var u=5e3,d=null,l=[],c={};return c.isLoaded=function(){if(null===d)return!1;try{if(!d.isActive())return!1}catch(n){return!1}return!0},c.load=function(){var n={id:"qz",code:"qz.PrintApplet.class",archive:"qz-print.jar",width:1,height:1},i={jnlp_href:"/vendor/qz-print/qz-print_jnlp.jnlp",cache_option:"plugin",disable_logging:"false",initial_focus:"false"};e.versionCheck("1.7+")||e.versionCheck("1.6.0_45+")||!e.versionCheck("1.6+")||delete i.jnlp_href,e.runApplet(n,i,"1.5")},c.findPrinter=function(n,e){if(!this.isLoaded())return e(new Error("NOT_LOADED"));var i=setTimeout(function(){return window.qzDoneFinding=null,e(new Error("TIMEOUT"))},u);window.qzDoneFinding=function(){clearTimeout(i),window.qzDoneFinding=null;var n=d.getPrinter();return null===n?e(new Error("NOT_FOUND")):e(null,n)},d.findPrinter(n)},c.findPrinters=function(n){if(!this.isLoaded())return n(new Error("NOT_LOADED"));var e=setTimeout(function(){return window.qzDoneFinding=null,n(new Error("TIMEOUT"))},u);window.qzDoneFinding=function(){return clearTimeout(e),window.qzDoneFinding=null,n(null,d.getPrinters().split(",").filter(function(n){return!!n}))},d.findPrinter("\\{bogus_printer\\}")},c.rawPrint=function(n,e,i){return this.isLoaded()?(l.push({printerName:n,data:e,done:i}),void t()):i(new Error("NOT_LOADED"))},window.qzReady=function(){d=document.getElementById("qz");try{d.getVersion()}catch(n){d=null,o()}},window.qzDonePrinting=function(){var n=d.getException();n&&d.clearException()},i.subscribe("router.executing").setLimit(1).on("message",function(){document.getElementById("qzPrintInitWarning")||window.qzReady()}),window.qzPrint=c,c});