// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","deployJava","app/broker","app/purchaseOrders/templates/qzPrintInitWarning"],function(n,e,i,r){function t(){null===a&&p.length&&(a=p.shift(),c.findPrinter(a.printerName,function(n){return n?a.done(n):void a.append(a.print)}))}function o(){n("body").prepend(r())}function u(){n("#qzPrintInitWarning").remove()}var d=5e3,l=null,p=[],a=null,c={};return c.isLoaded=function(){if(null===l)return!1;try{if(!l.isActive())return!1}catch(n){return!1}return!0},c.isPrinting=function(){return null!==a},c.load=function(){var n={id:"qz",code:"qz.PrintApplet.class",archive:"qz-print.jar",width:1,height:1},i={jnlp_href:"/vendor/qz-print/qz-print_jnlp.jnlp",cache_option:"plugin",disable_logging:"false",initial_focus:"false"};e.versionCheck("1.7+")||e.versionCheck("1.6.0_45+")||!e.versionCheck("1.6+")||delete i.jnlp_href,e.runApplet(n,i,"1.5")},c.findPrinter=function(n,e){if(!this.isLoaded())return e(new Error("PLUGIN_NOT_LOADED"));var i=setTimeout(function(){return window.qzDoneFinding=null,e(new Error("FIND_PRINT_TIMEOUT"))},d);window.qzDoneFinding=function(){clearTimeout(i),window.qzDoneFinding=null;var n=l.getPrinter();return null===n?e(new Error("PRINTER_NOT_FOUND")):e(null,n)},l.findPrinter(n)},c.findPrinters=function(n){if(!this.isLoaded())return n(new Error("PLUGIN_NOT_LOADED"));var e=setTimeout(function(){return window.qzDoneFinding=null,n(new Error("FIND_PRINTERS_TIMEOUT"))},d);window.qzDoneFinding=function(){return clearTimeout(e),window.qzDoneFinding=null,n(null,l.getPrinters().split(",").filter(function(n){return n.length}))},l.findPrinter("\\{dummy_printer\\}")},c.printRaw=function(n,e,i){return this.isLoaded()?(p.push({type:"raw",printerName:n,done:function(n){a=null,i(n)},append:function(n){l.append(e),n()},print:function(){l.print()}}),void t()):i(new Error("PLUGIN_NOT_LOADED"))},c.printPdf=function(n,e,i,r){return this.isLoaded()?(p.push({type:"pdf",printerName:n,done:function(n){a=null,r(n)},append:function(n){l.setPaperSize(i.width,i.height,"mm"),l.setOrientation(i.orientation),l.setAutoSize(!0),l.appendPDF(e),window.qzDoneAppending=function(){window.qzDoneAppending=null,n()}},print:function(){l.printPS()}}),void t()):r(new Error("PLUGIN_NOT_LOADED"))},window.qzReady=function(){l=document.getElementById("qz");try{l.getVersion(),u()}catch(n){l=null,o()}},window.qzDonePrinting=function(){var n=l.getException();n?(n=new Error(n.getLocalizedMessage()),l.clearException(),a.done(n)):null!==a&&a.done()},i.subscribe("router.executing").setLimit(1).on("message",function(){document.getElementById("qzPrintInitWarning")||window.qzReady()}),window.qzPrint=c,c});