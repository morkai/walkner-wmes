define(["underscore","jquery","app/i18n","app/time","app/core/View","app/core/util/getShiftStartInfo","app/data/downtimeReasons","app/data/aors","app/heff/templates/executionTimeline","app/heff/templates/executionTimelineItem"],function(e,t,n,i,r,o,d,s,a,h){"use strict";return r.extend({template:a,initialize:function(){var t=e.debounce(this.renderOrders.bind(this),1),n=e.debounce(this.renderOrders.bind(this),1);this.cache={todo:{},done:{}},"todo"===this.options.mode?(this.listenTo(this.model.todo,"reset",t),this.listenTo(this.model.done,"add",function(){this.cacheOrders(),n()}),this.listenTo(this.model.done,"change",n)):this.listenTo(this.model.done,"reset add change",t)},afterRender:function(){this.renderOrders(),this.scheduleExtendLastItems()},cacheOrders:function(){var e=this;e.cache.todo={},e.cache.done={},e.model.todo.forEach(function(t){var n=t.get("orderId");e.cache.todo[n]||(e.cache.todo[n]=[]),e.cache.todo[n].push(t)}),e.model.done.forEach(function(t){var n=t.get("orderId");e.cache.done[n]||(e.cache.done[n]=[]),e.cache.done[n].push(t)})},renderOrders:function(){this.cacheOrders(),this.renderItems("order")},renderDowntimes:function(){this.renderItems("downtime")},renderItems:function(e){var t=this,n=t.model[t.options.mode],i=n.length?o(n.at(0).get("startedAt")).startTime:0,r=Date.now(),d=n.map(function(n,o){return t.renderItem(e,n.attributes,o,i,r)}).join("");t.$el.find('.heff-timeline-item[data-type="'+e+'"]').remove(),t.$el.append(d),t.scheduleExtendLastItems()},renderItem:function(e,t,n,i,r){i||(i=o(t.startedAt).startTime),r||(r=Date.now());var d=Date.parse(t.startedAt),s=((Date.parse(t.finishedAt)||r)-d)/288e5*100,a=(d-i)/288e5*100;return h({type:e,id:n,label:this.resolveLabel(e,t),execution:this.resolveExecution(e,t),width:s,left:a})},updateExecution:function(){var e=this;e.model[e.options.mode].forEach(function(t,n){var i=e.$('.heff-timeline-item[data-type="order"][data-id="'+n+'"]');i.length&&(i[0].dataset.execution=e.resolveExecution("order",t.toJSON()))})},resolveLabel:function(e,t){return"order"===e?t.orderId.match(/([0-9]{3})/g).join("<br>"):"downtime"===e?t.reason:""},resolveExecution:function(e,t){if("order"!==e)return"";if("todo"===this.options.mode){var n=this.cache.done[t.orderId]||[];if(0===n.length)return"";for(var i=n.length-1;i>=0;--i){var r=n[i];if(!r.get("finishedAt"))return"current";if(r.get("quantityDone")>=t.quantityDone)return"ok"}return""}if(!t.finishedAt)return"current";var o=this.cache.todo[t.orderId]||[];if(0===o.length)return"nok";for(var d=0;d<o.length;++d){if(o[d].get("quantityDone")===t.quantityDone)return"ok"}return""},updateLastItem:function(e){var t=this.model.get(this[e+"Prop"])||[],n=t.length-1;if(-1!==n){var i=t.last();this.$('.heff-timeline-item[data-type="'+e+'"][data-id="'+n+'"]').replaceWith(this.renderItem(e,i,n))}},scheduleExtendLastItems:function(){"todo"!==this.options.mode&&(clearTimeout(this.timers.extendLastItems),this.timers.extendLastItems=setTimeout(this.extendLastItems.bind(this),6e4))},extendLastItems:function(){this.extendLastItem("order")},extendLastItem:function(e){this.scheduleExtendLastItems();var t=this.model[this.options.mode],n=t.length-1,i=t.last();if(i&&!i.get("finishedAt")){var r=this.$('.heff-timeline-item[data-type="'+e+'"][data-id="'+n+'"]'),o=Date.parse(i.get("startedAt")),d=(Date.now()-o)/288e5*100;r[0].style.width=d+"%"}}})});