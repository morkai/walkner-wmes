define(["app/time","app/core/View","app/prodShiftOrders/ProdShiftOrder","./ExecutionTimelineView","app/heff/templates/shiftEfficiency"],function(t,e,i,a,s){"use strict";return e.extend({swapDelay:4e4,template:s,initialize:function(){this.currentMetrics="eff",this.todoView=new a({mode:"todo",model:{todo:this.model.planShiftOrders,done:this.model.prodShiftOrders}}),this.doneView=new a({mode:"done",model:{todo:this.model.planShiftOrders,done:this.model.prodShiftOrders}}),this.listenTo(this.model.prodShiftOrders,"reset add change",this.updateData),this.setView("#-todo",this.todoView),this.setView("#-done",this.doneView)},getTitle:function(){return this.t("shift:title")},activate:function(){this.swapMetrics(),this.updateData()},deactivate:function(){this.currentMetrics="eff",clearTimeout(this.timers.swapMetrics)},updateData:function(){this.updatePlanned(),this.updateActual(),this.updateLineEff()},periodicUpdate:function(){this.updateActual()},updatePlanned:function(){var e="?",i=this.model.prodShiftOrders.last();i&&(i.get("sapTaktTime")&&(e=t.toString(i.get("sapTaktTime"),!0,!1).replace(/^00:/,"")));this.$id("plannedTt").text(e)},updateActual:function(){var e="?",i="?",a="fa-meh-o",s=this.model.prodShiftOrders.last();if(s){var r=Date.now(),d=s.get("workDuration"),n=s.get("quantityDone")||1,o=!1;if(d>0)d*=36e5;else{var h=Date.parse(s.get("startedAt")),f=Date.parse(s.get("finishedAt"))||r;d=f-h,this.model.prodDowntimes.forEach(function(t){t.get("prodShiftOrder")===s.id&&"A"===t.get("reason")&&(d-=(Date.parse(t.get("finishedAt"))||r)-Date.parse(t.get("startedAt")))}),s.attributes.workDuration=d/36e5,o=!0}var p=s.get("sapTaktTime"),l=d/n/1e3;if(e=t.toString(l,!0,!1).replace(/^00:/,""),l<=p?a="fa-smile-o":l>p&&(a="fa-frown-o"),s.get("quantityDone")){var u=s.getEfficiency();u&&(i=Math.min(999,Math.round(100*u))+"%")}o&&(s.attributes.workDuration=0)}this.$id("actualTt").text(e),this.$id("orderEff").text(i),this.$id("icon").hasClass(a)||this.$id("icon").removeClass("fa-meh-o fa-smile-o fa-frown-o").addClass(a)},updateLineEff:function(){var t=this,e=Date.now(),a=0,s=0;t.model.prodShiftOrders.forEach(function(r){var d=r.get("workDuration"),n=i.getTaktTimeCoeff(r.attributes);d||r.get("finishedAt")||(d=e-Date.parse(r.get("startedAt")),t.model.prodDowntimes.forEach(function(t){t.get("prodShiftOrder")===r.id&&"A"===t.get("reason")&&(d-=(Date.parse(t.get("finishedAt"))||e)-Date.parse(t.get("startedAt")))}),d/=36e5),a+=r.get("laborTime")*n/100*r.get("quantityDone"),s+=d*r.get("workerCount")});var r=Math.min(999,Math.round(a/s*100));t.$id("lineEff").text(r>0?r+"%":"?")},swapMetrics:function(){"tt"===this.currentMetrics?(this.currentMetrics="eff",this.updateLineEff(),this.$id("plannedTt").parent().addClass("hidden"),this.$id("actualTt").parent().addClass("hidden"),this.$id("lineEff").parent().removeClass("hidden"),this.$id("orderEff").parent().removeClass("hidden")):(this.currentMetrics="tt",this.$id("lineEff").parent().addClass("hidden"),this.$id("orderEff").parent().addClass("hidden"),this.$id("plannedTt").parent().removeClass("hidden"),this.$id("actualTt").parent().removeClass("hidden")),this.timers.swapMetrics=setTimeout(this.swapMetrics.bind(this),5e3)}})});