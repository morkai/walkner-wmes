define(["app/time","app/core/View","app/data/downtimeReasons","app/prodShiftOrders/ProdShiftOrder","./ExecutionTimelineView","app/heff/templates/shiftEfficiency"],function(t,e,i,a,d,r){"use strict";return e.extend({swapDelay:2e4,template:r,initialize:function(){this.currentMetrics="tt",this.todoView=new d({mode:"todo",model:{todo:this.model.planShiftOrders,done:this.model.prodShiftOrders}}),this.doneView=new d({mode:"done",model:{todo:this.model.planShiftOrders,done:this.model.prodShiftOrders}}),this.listenTo(this.model.prodShiftOrders,"reset add change",this.updateData),this.setView("#-todo",this.todoView),this.setView("#-done",this.doneView)},getTitle:function(){return this.t("shift:title")},activate:function(){this.swapMetrics(),this.updateData()},deactivate:function(){this.currentMetrics="tt",clearTimeout(this.timers.swapMetrics)},updateData:function(){this.updatePlanned(),this.updateActual(),this.updateLineEff()},periodicUpdate:function(){this.updateActual()},updatePlanned:function(){var e="?",i=this.model.prodShiftOrders.last();i&&(i.get("sapTaktTime")&&(e=t.toString(i.get("sapTaktTime"),!0,!1).replace(/^00:/,"")));this.$id("plannedTt").text(e)},updateActual:function(){var e="?",a="?",d="fa-meh-o",r=this.model.prodShiftOrders.last();if(r){var s=Date.now(),n=r.get("workDuration"),o=r.get("quantityDone")||1;if(n>0)n*=36e5;else{var h=Date.parse(r.get("startedAt")),f=Date.parse(r.get("finishedAt"))||s;n=f-h,this.model.prodDowntimes.forEach(function(t){if(t.get("prodShiftOrder")===r.id){var e=i.get(t.get("reason"));if(!e||"break"!==e.get("type")){var a=Date.parse(t.get("startedAt")),d=t.get("finishedAt")?Date.parse(t.get("finishedAt")):s;n-=d-a}}})}var p=r.get("sapTaktTime"),l=n/o/1e3;if(e=t.toString(l,!0,!1).replace(/^00:/,""),l<=p?d="fa-smile-o":l>p&&(d="fa-frown-o"),r.get("quantityDone")){var c=r.getEfficiency({workDuration:n/36e5});c&&(a=Math.min(999,Math.round(100*c))+"%")}}this.$id("actualTt").text(e),this.$id("orderEff").text(a),this.$id("icon").hasClass(d)||this.$id("icon").removeClass("fa-meh-o fa-smile-o fa-frown-o").addClass(d)},updateLineEff:function(){var t=this,e=Date.now(),i=0,d=0;t.model.prodShiftOrders.forEach(function(r){var s=r.get("workDuration"),n=a.getTaktTimeCoeff(r.attributes);s||r.get("finishedAt")||(s=e-Date.parse(r.get("startedAt")),t.model.prodDowntimes.forEach(function(t){t.get("prodShiftOrder")===r.id&&"A"===t.get("reason")&&(s-=(Date.parse(t.get("finishedAt"))||e)-Date.parse(t.get("startedAt")))}),s/=36e5),i+=r.get("laborTime")*n/100*r.get("quantityDone"),d+=s*r.get("workerCount")});var r=Math.min(999,Math.round(i/d*100));t.$id("lineEff").text(r>0?r+"%":"?")},swapMetrics:function(){"tt"===this.currentMetrics?(this.currentMetrics="eff",this.updateLineEff(),this.$id("plannedTt").parent().addClass("hidden"),this.$id("actualTt").parent().addClass("hidden"),this.$id("lineEff").parent().removeClass("hidden"),this.$id("orderEff").parent().removeClass("hidden")):(this.currentMetrics="tt",this.$id("lineEff").parent().addClass("hidden"),this.$id("orderEff").parent().addClass("hidden"),this.$id("plannedTt").parent().removeClass("hidden"),this.$id("actualTt").parent().removeClass("hidden"))}})});