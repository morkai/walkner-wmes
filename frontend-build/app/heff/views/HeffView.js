define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/data/localStorage","app/core/View","app/core/util/getShiftStartInfo","app/core/util/embedded","app/production/snManager","app/prodShifts/views/QuantitiesDoneChartView","./UnlockDialogView","app/heff/templates/page"],function(t,e,i,o,a,n,s,d,h,r,l,f,p,u){"use strict";var c=[2,3,4,5,6,7,0,1,2,3,4,5,6,7,0,1,2,3,4,5,6,7,0,1];return d.extend({template:u,remoteTopics:function(){var t={};return this.model.get("prodLine")&&(t["heff.reload."+this.model.get("prodLine")]="onReload"),t},localTopics:{"socket.connected":"loadData"},events:{"click #-line":function(){if(window.WMES_CLIENT)r.isEnabled()&&r.actions.config();else{var t=new p({model:this.model});n.showDialog(t,this.t("unlockDialog:title"))}},"click #-snMessage":"hideSnMessage"},initialize:function(){this.periodicUpdate=this.periodicUpdate.bind(this),this.loadData=this.loadData.bind(this),this.currentHour=-1,this.shiftStartInfo=null,this.setView("#-chart",new f({showTitle:!1,showLegend:!1,noData:!1,exporting:!1,height:285,model:this.model})),this.listenTo(this.model,"change:quantitiesDone",this.onQuantitiesDoneChanged),l.bind(this)},destroy:function(){e(window).off("."+this.idPrefix)},afterRender:function(){this.updateLine(),this.periodicUpdate(),this.loadData(),r.render(this),r.ready(),this.model.get("prodLine")||this.$id("line").click()},loadData:function(){var t=this;if(t.model.get("prodLine")){var e="/heff/"+encodeURIComponent(t.model.get("prodLine"));clearTimeout(t.timers.loadData),t.ajax({url:e}).done(function(e){t.onReload(e),t.timers.loadData=setTimeout(t.loadData,3e5)})}},periodicUpdate:function(){var t=o.getMoment(),e=t.hours();this.updateDate(t),e!==this.currentHour&&(this.currentHour=e,this.hourlyUpdate(t)),this.timers.periodicUpdate=setTimeout(this.periodicUpdate,1e3)},hourlyUpdate:function(t){this.updateShift(t),this.updateTitle(t)},updateDate:function(t){this.$id("date").html(t.format("dddd, LL<br>LTS"))},updateShift:function(t){this.shiftStartInfo=h(t.valueOf());var e=i("core","SHIFT:"+this.shiftStartInfo.no);this.$id("shift").html(i("heff","shift",{shift:e}))},updateLine:function(){var t="?";this.model.get("prodLine")&&(t=this.model.get("prodLine"),this.model.get("station")&&(t=this.t("station",{line:t,station:this.model.get("station")}))),this.$id("line").text(t)},updateTitle:function(t){this.$id("title").html(i("heff","title",{from:this.shiftStartInfo.moment.format("H:00"),to:t.clone().add(1,"hours").format("H:00")}))},updateData:function(t){if(Array.isArray(t)&&8===t.length){for(var e=o.getMoment(),i=e.hours(),a=c[i],n=e.minutes(),s=0,d=0,h=0,r=0,l=0;l<8;++l){var f=t[l].planned;h+=f,r+=t[l].actual,l<a?(s+=f,d+=f):l===a&&(d+=f,s+=Math.round(f*(n/60)*1e3)/1e3)}this.$id("planned").text(d),this.$id("actual").text(r),this.$id("remaining").text(Math.max(h-r,0)),this.$id("eff").removeClass("fa-smile-o fa-frown-o fa-meh-o").addClass(r>=s?"fa-smile-o":"fa-frown-o")}},onReload:function(t){this.model.set(t)},onQuantitiesDoneChanged:function(){this.updateData(this.model.get("quantitiesDone"))}})});