// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/data/localStorage","app/core/View","app/core/util/getShiftStartInfo","app/heff/templates/page"],function(t,i,e,o,n,s,a,r){"use strict";var h=[2,3,4,5,6,7,0,1,2,3,4,5,6,7,0,1,2,3,4,5,6,7,0,1];return s.extend({template:r,remoteTopics:function(){var t={};return this.model.prodLineId&&(t["heff.reload."+this.model.prodLineId]="loadData"),t},localTopics:{"socket.connected":"loadData"},events:{"click #-line":function(){var e=this.$id("line");e.find("select").length||(e.html('<i class="fa fa-spinner fa-spin"></i>'),this.ajax({url:"/prodLines?select(_id)&deactivatedAt=null"}).done(function(o){var s="";t.forEach(o.collection,function(i){s+="<option>"+t.escape(i._id)+"</option>"});var a=i("<select></select>").html(s);e.empty().append(a),a.val(n.getItem("HEFF:LINE")).on("change",function(){n.setItem("HEFF:LINE",a.val()),window.location.reload()})}))},"mousedown #-switchApps":function(t){this.startActionTimer("switchApps",t)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(t){this.startActionTimer("reboot",t)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(t){this.startActionTimer("shutdown",t)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},initialize:function(){this.periodicUpdate=this.periodicUpdate.bind(this),this.loadData=this.loadData.bind(this),this.currentHour=-1,this.shiftStartInfo=null,this.actionTimer={action:null,time:null}},serialize:function(){return{idPrefix:this.idPrefix,showParentControls:window.parent!==window}},afterRender:function(){this.updateLine(),this.periodicUpdate(),this.loadData(),window.parent!==window&&window.parent.postMessage({type:"ready",app:"heff"},"*")},loadData:function(){var i=this,e="/heff/"+encodeURIComponent(i.model.prodLineId);clearTimeout(i.timers.loadData),i.ajax({url:e}).done(function(e){i.updateData(e),i.timers.loadData=setTimeout(i.loadData,t.random(25e3,35e3))})},periodicUpdate:function(){var t=o.getMoment(),i=t.hours();this.updateDate(t),i!==this.currentHour&&(this.currentHour=i,this.hourlyUpdate(t)),this.timers.periodicUpdate=setTimeout(this.periodicUpdate,1e3)},hourlyUpdate:function(t){this.updateShift(t),this.updateTitle(t)},updateDate:function(t){this.$id("date").html(t.format("dddd, LL<br>LTS"))},updateShift:function(t){this.shiftStartInfo=a(t.valueOf());var i=e("core","SHIFT:"+this.shiftStartInfo.shift);this.$id("shift").html(e("heff","shift",{shift:i}))},updateLine:function(){this.$id("line").html(this.model.prodLineId||"?")},updateTitle:function(t){this.$id("title").html(e("heff","title",{from:this.shiftStartInfo.moment.format("H:00"),to:t.clone().add(1,"hours").format("H:00")}))},updateData:function(t){for(var i=o.getMoment(),e=i.hours(),n=h[e],s=i.minutes(),a=0,r=0,d=0,c=0,p=0;8>p;++p){var u=t[p].planned,f=t[p].actual;d+=u,c+=f,n>p?(a+=u,r+=u):p===n&&(r+=u,a+=Math.round(u*(s/60)*1e3)/1e3)}this.$id("planned").text(r),this.$id("actual").text(c),this.$id("remaining").text(Math.max(d-c,0)),this.$id("eff").removeClass("fa-smile-o fa-frown-o fa-meh-o").addClass(c>=a?"fa-smile-o":"fa-frown-o")},startActionTimer:function(t,i){this.actionTimer.action=t,this.actionTimer.time=Date.now(),i&&i.preventDefault()},stopActionTimer:function(t){if(this.actionTimer.action===t){var i=Date.now()-this.actionTimer.time>3e3;"switchApps"===t?i?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"heff"},"*"):"reboot"===t?i?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):i&&"shutdown"===t&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}}})});