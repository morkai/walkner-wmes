// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/data/localStorage","app/core/View","app/core/util/getShiftStartInfo","app/production/snManager","app/production/views/BomCheckerDialogView","app/heff/templates/page"],function(t,e,i,n,o,s,a,r,d,c,h,u){"use strict";var p=[2,3,4,5,6,7,0,1,2,3,4,5,6,7,0,1,2,3,4,5,6,7,0,1];return r.extend({template:u,remoteTopics:function(){var t={};return this.model.prodLineId&&(t["heff.reload."+this.model.prodLineId]="loadData"),t},localTopics:{"socket.connected":"loadData","production.taktTime.snScanned":"onSnScanned"},events:{"click #-line":function(){var i=this.$id("line");i.find("select").length||(i.html('<i class="fa fa-spinner fa-spin"></i>'),this.ajax({url:"/prodLines?select(_id)&deactivatedAt=null"}).done(function(n){var o="";t.forEach(n.collection,function(e){o+="<option>"+t.escape(e._id)+"</option>"});var s=e("<select></select>").html(o);i.empty().append(s),s.val(a.getItem("HEFF:LINE")).on("change",function(){a.setItem("HEFF:LINE",s.val()),window.location.reload()})}))},"click #-snMessage":"hideSnMessage","mousedown #-switchApps":function(t){this.startActionTimer("switchApps",t)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(t){this.startActionTimer("reboot",t)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(t){this.startActionTimer("shutdown",t)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},initialize:function(){this.periodicUpdate=this.periodicUpdate.bind(this),this.loadData=this.loadData.bind(this),this.currentHour=-1,this.shiftStartInfo=null,this.actionTimer={action:null,time:null},e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){e(window).off("."+this.idPrefix)},serialize:function(){return{idPrefix:this.idPrefix,showParentControls:window.parent!==window}},afterRender:function(){this.updateLine(),this.periodicUpdate(),this.loadData(),window.parent!==window&&window.parent.postMessage({type:"ready",app:"heff"},"*")},loadData:function(){var e=this;if(e.model.prodLineId){var i="/heff/"+encodeURIComponent(e.model.prodLineId);clearTimeout(e.timers.loadData),e.ajax({url:i}).done(function(i){e.updateData(i),e.timers.loadData=setTimeout(e.loadData,t.random(25e3,35e3))})}},periodicUpdate:function(){var t=n.getMoment(),e=t.hours();this.updateDate(t),e!==this.currentHour&&(this.currentHour=e,this.hourlyUpdate(t)),this.timers.periodicUpdate=setTimeout(this.periodicUpdate,1e3)},hourlyUpdate:function(t){this.updateShift(t),this.updateTitle(t)},updateDate:function(t){this.$id("date").html(t.format("dddd, LL<br>LTS"))},updateShift:function(t){this.shiftStartInfo=d(t.valueOf());var e=i("core","SHIFT:"+this.shiftStartInfo.shift);this.$id("shift").html(i("heff","shift",{shift:e}))},updateLine:function(){this.$id("line").html(this.model.prodLineId||"?")},updateTitle:function(t){this.$id("title").html(i("heff","title",{from:this.shiftStartInfo.moment.format("H:00"),to:t.clone().add(1,"hours").format("H:00")}))},updateData:function(t){for(var e=n.getMoment(),i=e.hours(),o=p[i],s=e.minutes(),a=0,r=0,d=0,c=0,h=0;h<8;++h){var u=t[h].planned,l=t[h].actual;d+=u,c+=l,h<o?(a+=u,r+=u):h===o&&(r+=u,a+=Math.round(u*(s/60)*1e3)/1e3)}this.$id("planned").text(r),this.$id("actual").text(c),this.$id("remaining").text(Math.max(d-c,0)),this.$id("eff").removeClass("fa-smile-o fa-frown-o fa-meh-o").addClass(c>=a?"fa-smile-o":"fa-frown-o")},startActionTimer:function(t,e){this.actionTimer.action=t,this.actionTimer.time=Date.now(),e&&e.preventDefault()},stopActionTimer:function(t){if(this.actionTimer.action===t){var e=Date.now()-this.actionTimer.time>3e3;"switchApps"===t?e?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"heff"},"*"):"reboot"===t?e?window.parent.postMessage({type:"reboot"},"*"):window.parent.postMessage({type:"refresh"},"*"):e&&"shutdown"===t&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}},onKeyDown:function(t){var e=t.target.tagName,i="INPUT"===e&&"BUTTON"!==t.target.type||"SELECT"===e||"TEXTAREA"===e;8!==t.keyCode||i&&!t.target.readOnly&&!t.target.disabled||t.preventDefault(),c.handleKeyboardEvent(t)},onSnScanned:function(t){if(s.currentDialog){if(!(s.currentDialog instanceof h))return;return void(t.orderNo?this.swapBomCheckerIfNeeded(t):s.currentDialog.onSnScanned(t))}t.orderNo?this.createCheckSn(t):this.resolveBomCheck(t)},createCheckSn:function(t,e){if(c.contains(t._id))return this.showSnMessage(t,"error","ALREADY_USED");var i={_id:null,instanceId:window.INSTANCE_ID,type:"checkSerialNumber",data:t,createdAt:n.getMoment().toDate(),creator:o.getInfo(),prodLine:this.model.prodLineId};t.sapTaktTime=-1,this.checkSn(i,e)},checkSn:function(t,e){var i=this,n=t.data;i.showSnMessage(n,"warning","CHECKING");var o=i.ajax({method:"POST",url:"/production/checkSerialNumber?bomCheck="+(e?1:0),data:JSON.stringify(t),timeout:6e3});o.fail(function(t){if(t.status<200)return void i.showSnMessage(n,"success","SUCCESS");i.showSnMessage(n,"error","SERVER_FAILURE")}),o.done(function(t){"CHECK_BOM"===t.result?(i.hideSnMessage(),i.showBomChecker(t,e)):"SUCCESS"===t.result?i.showSnMessage(t.serialNumber,"success","SUCCESS"):("ALREADY_USED"===t.result&&c.add(t.serialNumber),i.showSnMessage(n,"error",t.result))})},swapBomCheckerIfNeeded:function(t){var e=s.currentDialog.model.logEntry.data;t._id!==e._id&&(0===t.serialNo&&/^0+$/.test(t.orderNo)||t.orderNo!==e.orderNo?(s.closeDialog(),this.createCheckSn(t)):s.currentDialog.onSnScanned(t))},resolveBomCheck:function(t){var e={_id:"0000.000000000.0000",orderNo:"000000000",serialNo:0,scannedAt:t.scannedAt};this.createCheckSn(e,t)},showBomChecker:function(t,e){e&&(t.logEntry.data._id="0000.000000000.0000",t.logEntry.data.serialNo=0);var n=this,o=new h({model:t,snMessage:{show:n.showSnMessage.bind(n),hide:n.hideSnMessage.bind(n)}});n.listenToOnce(o,"dialog:shown",function(){e&&o.onSnScanned(e)}),n.listenToOnce(o,"checked",function(t){s.closeDialog(),n.checkSn(t)}),s.showDialog(o,i("production","bomChecker:title"))},showSnMessage:function(t,e,n){var o=this.$id("snMessage");this.$id("snMessage-text").html(i("production","snMessage:"+n)),this.$id("snMessage-scannedValue").text(t._id.length>43?t._id.substring(0,40)+"...":t._id),this.$id("snMessage-orderNo").text(t.orderNo||"-"),this.$id("snMessage-serialNo").text(t.serialNo||"-"),o.css({top:"50%",marginTop:"-80px"}).removeClass("hidden is-success is-error is-warning").addClass("is-"+e),this.timers.hideSnMessage&&clearTimeout(this.timers.hideSnMessage),this.timers.hideSnMessage=setTimeout(this.hideSnMessage.bind(this),6e3)},hideSnMessage:function(){this.timers.hideSnMessage=null,this.$id("snMessage").addClass("hidden")}})});