define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/data/localStorage","app/core/View","app/core/util/getShiftStartInfo","app/core/util/embedded","app/production/snManager","app/heff/views/UnlockDialogView","app/heff/views/HourlyEfficiencyView","app/heff/views/ShiftEfficiencyView","app/heff/templates/page","highcharts/themes/high-contrast-dark"],function(i,t,e,s,n,h,o,d,c,a,r,f,l,u,p){"use strict";return d.extend({template:p,remoteTopics:function(){var i={};return this.model.get("prodLine")&&(i["heff.updated."+this.model.get("prodLine")]="onStateUpdated"),i},localTopics:{"socket.connected":function(){this.loadData()}},events:{click:function(i){t(i.target).closest(".embedded-actions").length||this.swapView()},"click #-line":function(){if(window.WMES_CLIENT)return a.isEnabled()&&a.actions.config(),!1;var i=new f({model:this.model});return h.showDialog(i,this.t("unlockDialog:title")),!1},"click #-snMessage":"hideSnMessage"},initialize:function(){this.periodicUpdate=this.periodicUpdate.bind(this),this.shiftStartInfo=null,this.currentHour=-1,this.currentView=null,this.defineViews(),this.defineBindings(),this.setView("#-hourlyEfficiency",this.hourlyEfficiencyView),this.setView("#-shiftEfficiency",this.shiftEfficiencyView),r.bind(this)},defineViews:function(){this.hourlyEfficiencyView=new l({model:this.model}),this.shiftEfficiencyView=new u({model:this.model})},defineBindings:function(){this.listenTo(this.model,"sync",this.onModelSynced),this.once("afterRender",function(){this.swapView(),this.loadData()})},destroy:function(){t(window).off("."+this.idPrefix)},afterRender:function(){this.periodicUpdate(),this.updateLine(),a.render(this),a.ready(),this.model.get("prodLine")||this.$id("line").click()},swapView:function(){this.currentView===this.hourlyEfficiencyView?(this.currentView=this.shiftEfficiencyView,this.$id("hourlyEfficiency").addClass("hidden"),this.$id("shiftEfficiency").removeClass("hidden"),this.hourlyEfficiencyView.deactivate()):this.currentView===this.shiftEfficiencyView?(this.currentView=this.hourlyEfficiencyView,this.$id("shiftEfficiency").addClass("hidden"),this.$id("hourlyEfficiency").removeClass("hidden"),this.shiftEfficiencyView.deactivate()):this.currentView=this.hourlyEfficiencyView,this.updateTitle(s.getMoment()),this.currentView.activate(),clearTimeout(this.timers.swapView),this.timers.swapView=setTimeout(this.swapView.bind(this),this.currentView.swapDelay)},periodicUpdate:function(){var i=s.getMoment(),t=i.hours();this.updateDate(i),t!==this.currentHour&&(this.currentHour=t,this.hourlyUpdate(i)),this.currentView&&this.currentView.periodicUpdate(),clearTimeout(this.timers.periodicUpdate),this.timers.periodicUpdate=setTimeout(this.periodicUpdate,1e3)},hourlyUpdate:function(i){this.updateShift(i),this.updateTitle(i)},updateDate:function(i){this.$id("date").html(i.format("dddd, LL<br>LTS"))},updateShift:function(i){this.shiftStartInfo=c(i.valueOf());var t=this.t("core","SHIFT:"+this.shiftStartInfo.no);this.$id("shift").html(this.t("shift",{shift:t}))},updateLine:function(){var i="?";this.model.get("prodLine")&&(i=this.model.get("prodLine"),this.model.get("station")&&(i=this.t("station",{line:i,station:this.model.get("station")}))),this.$id("line").text(i)},updateTitle:function(i){this.currentView&&this.$id("title").html(this.currentView.getTitle(this.shiftStartInfo,i))},loadData:function(){this.model.get("prodLine")&&this.model.fetch()},onModelSynced:function(){clearTimeout(this.timers.reload),this.timers.reload=setTimeout(this.loadData.bind(this),9e5)},onStateUpdated:function(i){this.model.update(i)}})});