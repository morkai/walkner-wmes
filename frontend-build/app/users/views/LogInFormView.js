define(["app/user","app/i18n","app/viewport","app/core/View","app/users/templates/logInForm"],function(t,i,s,e,n){"use strict";return e.extend({template:n,events:{submit:"submitForm","keypress input":function(){this.$id("login")[0].setCustomValidity(""),this.$submit.removeClass("btn-danger").addClass("btn-primary")},'input input[type="password"]':function(){this.togglePasswordValidity()},"click #-loginLink":function(){this.switchToLogin()},"click #-resetLink":function(){this.switchToReset()},"click #-office365":function(){window.location.href="/auth/office365?returnUrl="+encodeURIComponent(window.location.href)}},initialize:function(){this.resetting=!1,this.originalTitle=null,this.$title=null,this.$submit=null},destroy:function(){this.$title=null,this.$submit=null},getTemplateData:function(){return{OFFICE365_TENANT:window.OFFICE365_TENANT}},afterRender:function(){var t=this;t.$title=t.getTitleEl(),t.$submit=t.$(".logInForm-submit"),t.$id("loginLink").hide(),this.model&&this.model.unknown?(t.$id("login").val(this.model.unknown)[0].setCustomValidity(i("users","LOG_IN_FORM:UNKNOWN")),t.$submit.removeClass("btn-primary").addClass("btn-danger").click()):t.$id("login").focus(),t.originalTitle=t.$title.text(),window.CORS_PING_URL&&window.OFFICE365_TENANT&&t.ajax({url:window.CORS_PING_URL,dataType:"text"}).done(function(){t.$id("office365").removeClass("hidden")})},submitForm:function(){if(!this.$submit.hasClass("btn-primary"))return!1;var t={login:this.$id("login").val(),password:this.$id("password").val(),socketId:this.socket.getId()};if(!t.login.length||!t.password.length)return!1;this.resetting&&(t.subject=i("users","LOG_IN_FORM:RESET:SUBJECT",{APP_NAME:i("core","APP_NAME")}),t.text=i("users","LOG_IN_FORM:RESET:TEXT",{APP_NAME:i("core","APP_NAME"),appUrl:window.location.origin,resetUrl:window.location.origin+"/resetPassword/{REQUEST_ID}"})),this.$el.addClass("logInForm-loading"),this.$submit.prop("disabled",!0),this.$(".btn-link").prop("disabled",!0);var e=this.ajax({type:"POST",url:this.el.action,data:JSON.stringify(t)}),n=this;return e.done(function(){n.$submit&&(n.resetting?s.msg.show({type:"info",time:5e3,text:i("users","LOG_IN_FORM:RESET:MSG:SUCCESS")}):n.$submit.removeClass("btn-primary").addClass("btn-success"))}),e.fail(function(t){var e=t.responseJSON&&t.responseJSON.error||{};"UNSAFE_PASSWORD"!==e.code?(n.$submit&&n.$submit.removeClass("btn-primary").addClass("btn-danger"),i.has("users","LOG_IN_FORM:MSG:"+e.code)?s.msg.show({type:"error",time:3e3,text:i("users","LOG_IN_FORM:MSG:"+e.code)}):n.resetting&&s.msg.show({type:"error",time:3e3,text:i("users","LOG_IN_FORM:RESET:MSG:FAILURE")})):n.switchToReset(i("users","LOG_IN_FORM:UNSAFE_PASSWORD"))}),e.always(function(t){n.$submit&&(n.$submit.attr("disabled",!1),n.$(".btn-link").prop("disabled",!1),n.$el.removeClass("logInForm-loading"),n.$("[autofocus]").focus()),n.resetting&&!t&&n.$id("loginLink").click()}),!1},getTitleEl:function(){var t=this.$el.closest(".modal-content");return t.length?t.find(".modal-title"):this.$el.closest(".page").find(".page-breadcrumbs > :last-child")},togglePasswordValidity:function(){var t="";this.resetting&&this.$id("password").val()!==this.$id("password2").val()&&(t=i("users","LOG_IN_FORM:PASSWORD_MISMATCH")),this.$id("password2")[0].setCustomValidity(t)},switchToLogin:function(t){this.$el.attr("action","/login"),this.$id("loginLink").hide(),this.$id("resetLink").show(),this.$id("login").select(),this.$id("password").val("").attr("placeholder",i("users","LOG_IN_FORM:LABEL:PASSWORD")),this.$id("password2").val("").prop("required",!1),this.$id("password2-container").addClass("hidden"),this.$(".logInForm-submit-label").text(i("users","LOG_IN_FORM:SUBMIT:LOG_IN")),this.resetting=!1,this.onModeSwitch(t)},switchToReset:function(t){this.$el.attr("action","/resetPassword/request"),this.$id("resetLink").hide(),this.$id("loginLink").show(),this.$id("login").select(),this.$id("password").val("").attr("placeholder",i("users","LOG_IN_FORM:LABEL:NEW_PASSWORD")),this.$id("password2").val("").prop("required",!0),this.$id("password2-container").removeClass("hidden"),this.$(".logInForm-submit-label").text(i("users","LOG_IN_FORM:SUBMIT:RESET")),this.resetting=!0,this.onModeSwitch(t)},onModeSwitch:function(t){this.$title.text(this.resetting?i("users","LOG_IN_FORM:TITLE:RESET"):this.originalTitle),this.$submit.removeClass("btn-danger").addClass("btn-primary"),t?this.$id("message").html(t).removeClass("hidden"):this.$id("message").addClass("hidden")}})});