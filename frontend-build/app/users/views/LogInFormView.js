// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/user","app/i18n","app/viewport","app/core/View","app/users/templates/logInForm"],function(t,i,s,e,n){"use strict";return e.extend({template:n,events:{submit:"submitForm","keypress input":function(){this.$submit.removeClass("btn-danger").addClass("btn-primary")},"click #-loginLink":function(){this.$el.attr("action","/login"),this.$id("loginLink").hide(),this.$id("resetLink").show(),this.$id("login").select(),this.$id("password").attr("placeholder",i("users","LOG_IN_FORM:LABEL:PASSWORD")),this.$(".logInForm-submit-label").text(i("users","LOG_IN_FORM:SUBMIT:LOG_IN")),this.resetting=!1,this.onModeSwitch()},"click #-resetLink":function(){this.$el.attr("action","/resetPassword/request"),this.$id("resetLink").hide(),this.$id("loginLink").show(),this.$id("login").select(),this.$id("password").val("").attr("placeholder",i("users","LOG_IN_FORM:LABEL:NEW_PASSWORD")),this.$(".logInForm-submit-label").text(i("users","LOG_IN_FORM:SUBMIT:RESET")),this.resetting=!0,this.onModeSwitch()}},initialize:function(){this.resetting=!1,this.originalTitle=null,this.$title=null,this.$submit=null},destroy:function(){this.$title=null,this.$submit=null},afterRender:function(){this.$id("login").focus(),this.$id("loginLink").hide(),this.$title=this.getTitleEl(),this.$submit=this.$(".logInForm-submit"),this.originalTitle=this.$title.text()},submitForm:function(){if(!this.$submit.hasClass("btn-primary"))return!1;var t={login:this.$id("login").val(),password:this.$id("password").val(),socketId:this.socket.getId()};if(!t.login.length||!t.password.length)return!1;this.resetting&&(t.subject=i("users","LOG_IN_FORM:RESET:SUBJECT",{APP_NAME:i("core","APP_NAME")}),t.text=i("users","LOG_IN_FORM:RESET:TEXT",{APP_NAME:i("core","APP_NAME"),appUrl:window.location.origin,resetUrl:window.location.origin+"/resetPassword/{REQUEST_ID}"})),this.$el.addClass("logInForm-loading"),this.$submit.prop("disabled",!0),this.$(".btn-link").prop("disabled",!0);var e=this.ajax({type:"POST",url:this.el.action,data:JSON.stringify(t)}),n=this;return e.done(function(){n.$submit&&(n.resetting?s.msg.show({type:"info",time:5e3,text:i("users","LOG_IN_FORM:RESET:MSG:SUCCESS")}):n.$submit.removeClass("btn-primary").addClass("btn-success"))}),e.fail(function(t){if(n.$submit&&n.$submit.removeClass("btn-primary").addClass("btn-danger"),n.resetting){var e=t.responseJSON&&t.responseJSON.error?t.responseJSON.error:{};s.msg.show({type:"error",time:5e3,text:i.has("users","LOG_IN_FORM:RESET:MSG:"+e.message)?i("users","LOG_IN_FORM:RESET:MSG:"+e.message):i("users","LOG_IN_FORM:RESET:MSG:FAILURE")})}}),e.always(function(){n.$submit&&(n.$submit.attr("disabled",!1),n.$(".btn-link").prop("disabled",!1),n.$el.removeClass("logInForm-loading"),n.$("[autofocus]").focus()),n.resetting&&n.$id("loginLink").click()}),!1},getTitleEl:function(){var t=this.$el.closest(".modal-content");return t.length?t.find(".modal-title"):this.$el.closest(".page").find(".page-breadcrumbs > :last-child")},onModeSwitch:function(){this.$title.text(this.resetting?i("users","LOG_IN_FORM:TITLE:RESET"):this.originalTitle),this.$submit.removeClass("btn-danger").addClass("btn-primary")}})});