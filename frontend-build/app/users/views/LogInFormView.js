define(["app/user","app/i18n","app/viewport","app/core/View","app/users/templates/logInForm","i18n!app/nls/users"],function(i,t,s,e,n){"use strict";return e.extend({template:n,events:{submit:"submitForm","keypress input":function(){this.$id("login")[0].setCustomValidity(""),this.$submit.removeClass("btn-danger").addClass("btn-primary")},'input input[type="password"]':function(){this.togglePasswordValidity()},"click #-loginLink":function(){this.switchToLogin()},"click #-resetLink":function(){this.switchToReset()},"click #-office365":function(){window.location.href="/auth/office365?returnUrl="+encodeURIComponent(window.location.href)}},nlsDomain:"users",initialize:function(){this.resetting=!1,this.originalTitle=null,this.$title=null,this.$submit=null,this.model={}},destroy:function(){this.$title=null,this.$submit=null},getTemplateData:function(){return{OFFICE365_TENANT:window.OFFICE365_TENANT}},afterRender:function(){var i=this;i.$title=i.getTitleEl(),i.$submit=i.$(".logInForm-submit"),i.$id("loginLink").hide(),this.model&&this.model.unknown?(i.$id("login").val(this.model.unknown)[0].setCustomValidity(t("users","LOG_IN_FORM:UNKNOWN")),i.$submit.removeClass("btn-primary").addClass("btn-danger").click()):i.$id("login").focus(),i.originalTitle=i.$title.text(),window.CORS_PING_URL&&window.OFFICE365_TENANT&&i.ajax({url:window.CORS_PING_URL,dataType:"text"}).done(function(){i.$id("office365").removeClass("hidden")})},submitForm:function(){if(!this.$submit.hasClass("btn-primary"))return!1;var i={login:this.$id("login").val(),password:this.$id("password").val(),socketId:this.socket.getId()};if(!i.login.length||!i.password.length)return!1;this.resetting&&(i.subject=t("users","LOG_IN_FORM:RESET:SUBJECT",{APP_NAME:t("core","APP_NAME")}),i.text=t("users","LOG_IN_FORM:RESET:TEXT",{APP_NAME:t("core","APP_NAME"),appUrl:window.location.origin,resetUrl:window.location.origin+"/resetPassword/{REQUEST_ID}"})),this.$el.addClass("logInForm-loading"),this.$submit.prop("disabled",!0),this.$(".btn-link").prop("disabled",!0);var e=this.ajax({type:"POST",url:this.el.action,data:JSON.stringify(i)}),n=this;return e.done(function(){n.$submit&&(n.resetting?s.msg.show({type:"info",time:5e3,text:t("users","LOG_IN_FORM:RESET:MSG:SUCCESS")}):n.$submit.removeClass("btn-primary").addClass("btn-success"))}),e.fail(function(i){var e=i.responseJSON&&i.responseJSON.error||{};"UNSAFE_PASSWORD"!==e.code?(n.$submit&&n.$submit.removeClass("btn-primary").addClass("btn-danger"),t.has("users","LOG_IN_FORM:MSG:"+e.code)?s.msg.show({type:"error",time:3e3,text:t("users","LOG_IN_FORM:MSG:"+e.code)}):n.resetting&&s.msg.show({type:"error",time:3e3,text:t("users","LOG_IN_FORM:RESET:MSG:FAILURE")})):n.switchToReset(t("users","LOG_IN_FORM:UNSAFE_PASSWORD"))}),e.always(function(i){n.$submit&&(n.$submit.attr("disabled",!1),n.$(".btn-link").prop("disabled",!1),n.$el.removeClass("logInForm-loading"),n.$("[autofocus]").focus()),n.resetting&&!i&&n.$id("loginLink").click()}),!1},getTitleEl:function(){var i=this.$el.closest(".modal-content");return i.length?i.find(".modal-title"):this.$el.closest(".page").find(".page-breadcrumbs > :last-child")},togglePasswordValidity:function(){var i="";this.resetting&&this.$id("password").val()!==this.$id("password2").val()&&(i=t("users","LOG_IN_FORM:PASSWORD_MISMATCH")),this.$id("password2")[0].setCustomValidity(i)},switchToLogin:function(i){this.$el.attr("action","/login"),this.$id("loginLink").hide(),this.$id("resetLink").show(),this.$id("login").select(),this.$id("password").val("").attr("placeholder",t("users","LOG_IN_FORM:LABEL:PASSWORD")),this.$id("password2").val("").prop("required",!1),this.$id("password2-container").addClass("hidden"),this.$(".logInForm-submit-label").text(t("users","LOG_IN_FORM:SUBMIT:LOG_IN")),this.resetting=!1,this.onModeSwitch(i)},switchToReset:function(i){this.$el.attr("action","/resetPassword/request"),this.$id("resetLink").hide(),this.$id("loginLink").show(),this.$id("login").select(),this.$id("password").val("").attr("placeholder",t("users","LOG_IN_FORM:LABEL:NEW_PASSWORD")),this.$id("password2").val("").prop("required",!0),this.$id("password2-container").removeClass("hidden"),this.$(".logInForm-submit-label").text(t("users","LOG_IN_FORM:SUBMIT:RESET")),this.resetting=!0,this.onModeSwitch(i)},onModeSwitch:function(i){this.$title.text(this.resetting?t("users","LOG_IN_FORM:TITLE:RESET"):this.originalTitle),this.$submit.removeClass("btn-danger").addClass("btn-primary"),i?this.$id("message").html(i).removeClass("hidden"):this.$id("message").addClass("hidden")}})});