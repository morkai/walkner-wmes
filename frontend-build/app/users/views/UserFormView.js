define(["underscore","jquery","app/ZeroClipboard","app/i18n","app/user","app/viewport","app/core/Model","app/core/views/FormView","app/core/util/idAndLabel","app/orgUnits/views/OrgUnitDropdownsView","app/data/aors","app/data/companies","app/data/divisions","app/data/subdivisions","app/data/prodFunctions","app/data/privileges","app/data/loadedModules","app/vendors/util/setUpVendorSelect2","app/mrpControllers/util/setUpMrpSelect2","app/users/templates/formMobileList","app/users/templates/form"],function(e,i,t,s,o,r,n,l,a,d,p,c,u,h,m,v,f,g,b,w,y){"use strict";var U=d.ORG_UNIT;return l.extend({template:y,events:{submit:"submitForm",'input input[type="password"]':function(e){null!==this.timers.validatePasswords&&clearTimeout(this.timers.validatePasswords),this.timers.validatePasswords=setTimeout(this.validatePasswords.bind(this,e),30)},"change #-aors":"resizeColumns","keydown #-mobile":function(e){if(13===e.keyCode)return this.$id("mobile-add").click(),!1},"click #-mobile-add":function(){var e=this.$id("mobile-number"),i=this.$id("mobile-from"),t=this.$id("mobile-to");this.addMobile(e.val(),i.val(),t.val()),this.renderMobileList(),e.val("").focus(),i.val(""),t.val("")},"click .users-form-mobile-remove":function(e){return this.removeMobile(this.$(e.target).closest("li").attr("data-number")),this.$id("mobile-number").select(),!1},"keydown #-cardUid":function(e){if("Enter"===e.key)return!1}},initialize:function(){l.prototype.initialize.call(this),this.mobileList=null,this.accountMode=this.options.editMode&&o.data._id===this.model.id&&!o.isAllowedTo("USERS:MANAGE"),this.orgUnitDropdownsView=new d({orgUnit:U.SUBDIVISION,allowClear:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView),this.listenTo(this.orgUnitDropdownsView,"afterRender",this.resizeColumns),i(window).on("resize."+this.idPrefix,e.debounce(this.resizeColumns.bind(this),16))},destroy:function(){i(window).off("."+this.idPrefix),i(document).off("."+this.idPrefix),this.privilegesCopyClient&&(this.privilegesCopyClient.destroy(),this.privilegesCopyClient=null)},afterRender:function(){l.prototype.afterRender.call(this),this.accountMode||(this.$id("aors").select2({width:"100%",allowClear:!0}),this.setUpProdFunctionSelect2(),this.setUpCompanySelect2(),this.setUpVendorSelect2(),this.setUpPrivilegesControls(),this.listenToOnce(this.orgUnitDropdownsView,"afterRender",this.setUpOrgUnitDropdowns)),b(this.$id("mrps"),{width:"100%"}),this.resizeColumns(),this.mobileList||(this.mobileList=this.model.get("mobile")||[]),this.renderMobileList()},setUpOrgUnitDropdowns:function(){var e=null,i=null;switch(this.model.get("orgUnitType")){case"division":i=U.DIVISION,e=new n({division:this.model.get("orgUnitId")});break;case"subdivision":i=U.SUBDIVISION,e=new n({subdivision:this.model.get("orgUnitId")})}this.orgUnitDropdownsView.selectValue(e,i)},setUpPrivilegesControls:function(){var e={},i=[];v.forEach(function(t){var o=s("users","PRIVILEGE:"+t);e[o]=t,i.push({id:t,text:o})}),this.$id("privileges").select2({width:"100%",allowClear:!1,tags:i,tokenSeparators:[";"],createSearchChoice:function(i){var t=i.trim(),s=e[t];return s?{id:s,text:t}:null}}),this.setUpPrivilegesCopy()},serializePrivileges:function(){var e=this.$id("privileges").select2("data");return 0===e.length?"":e.map(function(e){return e.text}).join(";")+";"},setUpPrivilegesCopy:function(){var e=this,o=e.$id("copyPrivileges"),n=e.privilegesCopyClient=new t(o);n.on("copy",function(i){i.clipboardData.setData("text/plain",e.serializePrivileges())}),n.on("aftercopy",function(){r.msg.show({type:"info",time:2e3,text:s("users","FORM:copyPrivileges:success")})}),n.on("error",function(s){t.destroy(),i(document).on("copy."+e.idPrefix,e.onCopy.bind(e)),o.on("mousedown",function(){e.captureCopy=!0,document.execCommand("copy")})})},onCopy:function(e){this.captureCopy&&(this.captureCopy=!1,e.preventDefault(),e.originalEvent.clipboardData.setData("text/plain",this.serializePrivileges()),r.msg.show({type:"info",time:2e3,text:s("users","FORM:copyPrivileges:success")}))},setUpProdFunctionSelect2:function(){this.$id("prodFunction").select2({width:"100%",allowClear:!0,data:m.map(a)})},setUpCompanySelect2:function(){this.$id("company").select2({width:"100%",allowClear:!0})},setUpVendorSelect2:function(){var e=this.$id("vendor");if(f.isLoaded("vendors")){g(e,{placeholder:s("users","NO_DATA:vendor")});var i=this.model.get("vendor");i&&i._id&&e.select2("data",e.prepareData(i))}else e.closest(".form-group").remove()},validatePasswords:function(){var e=this.$id("password"),i=this.$id("password2");e.val()===i.val()?i[0].setCustomValidity(""):i[0].setCustomValidity(s("users","FORM:ERROR:passwordMismatch")),this.timers.validatePassword=null},serialize:function(){return e.extend(l.prototype.serialize.call(this),{aors:p.toJSON(),companies:c.toJSON(),privileges:v,accountMode:this.accountMode})},serializeToForm:function(){var e=this.model.toJSON();return e.active=(!!e.active).toString(),e.privileges=(e.privileges||[]).join(","),e.vendor=null,e.mrps=(e.mrps||[]).join(","),e},serializeForm:function(i){return i=e.defaults(i,{privileges:[],aors:[],mrps:[],preferences:{}}),["firstName","lastName","personellId","email"].forEach(function(e){i[e]&&i[e].length||(i[e]="")}),["company","prodFunction","vendor"].forEach(function(e){i[e]&&i[e].length||(i[e]=null)}),["card","cardUid"].forEach(function(e){i[e]=i[e]?i[e].replace(/[^0-9]+/g,"").replace(/^0+/,""):null}),["aors","mrps","privileges"].forEach(function(e){"string"==typeof i[e]&&(i[e]=i[e].split(","))}),i.subdivision?(i.orgUnitType="subdivision",i.orgUnitId=i.subdivision):i.division?(i.orgUnitType="division",i.orgUnitId=i.division):(i.orgUnitType="unspecified",i.orgUnitId=null),i.mobile=this.serializeMobile(),i.kdId=parseInt(i.kdId,10),(isNaN(i.kdId)||i.kdId<1)&&(i.kdId=-1),i},serializeMobile:function(){var i={};return e.forEach(this.mobileList,function(e){i[e.number]=e}),e.values(i)},resizeColumns:function(){var e=this.$(".col-lg-3"),t=null,s=0;e.each(function(){var e=i(this).css("height",""),o=e.outerHeight();o>s&&(t=e,s=o)}),window.innerWidth>=1200&&e.each(function(){this.style.height=this===t[0]?"":s+"px"})},renderMobileList:function(){this.$id("mobile-list").html(w({mobileList:this.mobileList}))},removeMobile:function(e){this.mobileList=this.mobileList.filter(function(i){return i.number!==e}),this.renderMobileList()},addMobile:function(e,i,t){e=this.parseMobileNumber(e),i=this.parseMobileTime(i),t=this.parseMobileTime(t),e&&i&&t&&this.mobileList.push({number:e,fromTime:i,toTime:t})},parseMobileNumber:function(e){return(e=e.replace(/[^0-9]/g,"")).length<9?"":(9===e.length&&(e="48"+e),e.length>11?"":"+"+e)},parseMobileTime:function(e){e.trim().length||(e="00:00"),e>-1&&e<25&&(e<10?e="0"+e+":00":"24"===e?e="00:00":e+=":00");var i=e.match(/([0-9]{1,2})[^0-9]*([0-9]{2})/);return null===i?"00:00":(1===i[1].length&&(i[1]="0"+i[1]),i[1]+":"+i[2])},handleFailure:function(e){var i=e.responseJSON,t=i&&i.error&&i.error.message;return s.has("users","FORM:ERROR:"+t)?this.showErrorMessage(s("users","FORM:ERROR:"+t)):l.prototype.handleFailure.apply(this,arguments)}})});