define(["require","underscore","jquery","app/i18n","app/user","app/viewport","app/core/Model","app/core/views/FormView","app/core/util/idAndLabel","app/core/util/uuid","app/orgUnits/views/OrgUnitDropdownsView","app/data/loadedModules","app/data/aors","app/data/companies","app/data/prodFunctions","app/data/privileges","app/data/clipboard","app/vendors/util/setUpVendorSelect2","app/mrpControllers/util/setUpMrpSelect2","../User","app/users/templates/formMobileList","app/users/templates/form"],function(e,i,t,o,s,r,n,l,a,d,p,c,h,u,m,f,v,g,w,b,U,y){"use strict";var M=p.ORG_UNIT;return l.extend({template:y,events:{submit:"submitForm",'input input[type="password"]':function(e){null!==this.timers.validatePasswords&&clearTimeout(this.timers.validatePasswords),this.timers.validatePasswords=setTimeout(this.validatePasswords.bind(this,e),30)},"change #-aors":"resizeColumns","keydown #-mobile":function(e){if(13===e.keyCode)return this.$id("mobile-add").click(),!1},"click #-mobile-add":function(){var e=this.$id("mobile-number"),i=this.$id("mobile-from"),t=this.$id("mobile-to");this.addMobile(e.val(),i.val(),t.val()),this.renderMobileList(),e.val("").focus(),i.val(""),t.val("")},"click .users-form-mobile-remove":function(e){return this.removeMobile(this.$(e.target).closest("li").attr("data-number")),this.$id("mobile-number").select(),!1},"keydown #-cardUid":function(e){if("Enter"===e.key)return!1},"click #-copyPrivileges":"copyPrivileges","click #-genApiKey":"genApiKey","change #-oshWorkplace":function(){this.setUpOshSelect2(this.$id("oshWorkplace").val()||null,null)}},initialize:function(){l.prototype.initialize.call(this),this.mobileList=null,this.accountMode=this.options.editMode&&s.data._id===this.model.id&&!s.isAllowedTo("USERS:MANAGE"),c.isLoaded("orgUnits")&&(this.orgUnitDropdownsView=new p({orgUnit:M.SUBDIVISION,allowClear:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView),this.listenTo(this.orgUnitDropdownsView,"afterRender",this.resizeColumns)),t(window).on("resize."+this.idPrefix,i.debounce(this.resizeColumns.bind(this),16))},destroy:function(){t(window).off("."+this.idPrefix),t(document).off("."+this.idPrefix)},afterRender:function(){l.prototype.afterRender.call(this),this.accountMode||(this.$id("aors").select2({width:"100%",allowClear:!0,multiple:!0,placeholder:" ",data:h.map(a)}),this.setUpOshSelect2(),this.setUpProdFunctionSelect2(),this.setUpCompanySelect2(),this.setUpVendorSelect2(),this.setUpPrivilegesControls(),this.orgUnitDropdownsView&&this.listenToOnce(this.orgUnitDropdownsView,"afterRender",this.setUpOrgUnitDropdowns)),w(this.$id("mrps"),{width:"100%"}),this.mobileList||(this.mobileList=this.model.get("mobile")||[]),this.renderMobileList(),this.resizeColumns()},setUpOrgUnitDropdowns:function(){var e=null,i=null;switch(this.model.get("orgUnitType")){case"division":i=M.DIVISION,e=new n({division:this.model.get("orgUnitId")});break;case"subdivision":i=M.SUBDIVISION,e=new n({subdivision:this.model.get("orgUnitId")})}this.orgUnitDropdownsView.selectValue(e,i)},setUpOshSelect2:function(i,t){var o=this.$id("oshWorkplace"),s=this.$id("oshDepartment");if(o.length){void 0===i&&(i=this.model.get("oshWorkplace"),t=this.model.get("oshDepartment")),o.val(i||""),s.val(t||"");var r=e("app/wmes-osh-common/dictionaries");o.select2({width:"100%",allowClear:!0,placeholder:" ",data:r.workplaces.map(function(e){return{id:e.id,text:e.getLabel({long:!0}),model:e}})}),s.select2({width:"100%",allowClear:!0,placeholder:" ",data:r.departments.where({workplace:+i}).map(function(e){return{id:e.id,text:e.getLabel({long:!0}),model:e}})})}},setUpPrivilegesControls:function(){var e=this,i={},t=[];f.forEach(function(o){var s=e.t("PRIVILEGE:"+o);i[s]=o,t.push({id:o,text:s})}),e.$id("privileges").select2({width:"100%",allowClear:!1,tags:t,tokenSeparators:[";"],createSearchChoice:function(e){var t=e.trim(),o=i[t];return o?{id:o,text:t}:null}})},serializePrivileges:function(){var e=this.$id("privileges").select2("data");return 0===e.length?"":e.map(function(e){return e.text}).join(";")+";"},copyPrivileges:function(e){var i=this;v.copy(function(t){t.setData("text/plain",i.serializePrivileges()),v.showTooltip(i,e.currentTarget,-1,-1,{title:i.t("FORM:copyPrivileges:success"),placement:"left"})})},genApiKey:function(){this.$id("apiKey").val((d()+d()).replace(/-/g,"").toLowerCase())},setUpProdFunctionSelect2:function(){this.$id("prodFunction").select2({width:"100%",allowClear:!0,placeholder:" ",data:m.map(a)})},setUpCompanySelect2:function(){this.$id("company").select2({width:"100%",allowClear:!0,placeholder:" ",data:u.map(a)})},setUpVendorSelect2:function(){var e=g(this.$id("vendor")),i=this.model.get("vendor");i&&i._id&&e.select2("data",e.prepareData(i))},validatePasswords:function(){var e=this.$id("password"),i=this.$id("password2");e.val()===i.val()?i[0].setCustomValidity(""):i[0].setCustomValidity(this.t("FORM:ERROR:passwordMismatch")),this.timers.validatePassword=null},getTemplateData:function(){return{loadedModules:c,notifications:b.NOTIFICATIONS,accountMode:this.accountMode}},serializeToForm:function(){var e=this.model.toJSON();return e.active=(!!e.active).toString(),e.privileges=(e.privileges||[]).join(","),e.vendor=null,e.aors=(e.aors||[]).join(","),e.mrps=(e.mrps||[]).join(","),e},serializeForm:function(e){e=i.defaults(e,{privileges:[],aors:[],mrps:[],preferences:{}}),["firstName","lastName","personnelId","email"].forEach(function(i){e[i]&&e[i].length||(e[i]="")}),["company","prodFunction","vendor"].forEach(function(i){e[i]&&e[i].length||(e[i]=null)});var t=this.$id("oshWorkplace");if(t.length){var o=t.select2("data"),s=this.$id("oshDepartment").select2("data");e.oshDivision=o&&o.model.get("division")||0,e.oshWorkplace=o&&o.model.id||0,e.oshDepartment=s&&s.model.id||0}return["card","cardUid"].forEach(function(i){e[i]=e[i]?e[i].replace(/[^0-9]+/g,"").replace(/^0+/,""):null}),["aors","mrps","privileges"].forEach(function(i){"string"==typeof e[i]&&(e[i]=e[i].split(","))}),e.subdivision?(e.orgUnitType="subdivision",e.orgUnitId=e.subdivision):e.division?(e.orgUnitType="division",e.orgUnitId=e.division):(e.orgUnitType="unspecified",e.orgUnitId=null),e.mobile=this.serializeMobile(),e},serializeMobile:function(){var e={};return i.forEach(this.mobileList,function(i){e[i.number]=i}),i.values(e)},resizeColumns:function(){var e=this.$(".col-lg-3"),i=null,o=0;e.each(function(){var e=t(this).css("height",""),s=e.outerHeight();s>o&&(i=e,o=s)}),window.innerWidth>=1200&&e.each(function(){this.style.height=this===i[0]?"":o+"px"})},renderMobileList:function(){this.$id("mobile-list").html(this.renderPartialHtml(U,{mobileList:this.mobileList}))},removeMobile:function(e){this.mobileList=this.mobileList.filter(function(i){return i.number!==e}),this.renderMobileList()},addMobile:function(e,i,t){e=this.parseMobileNumber(e),i=this.parseMobileTime(i),t=this.parseMobileTime(t),e&&i&&t&&this.mobileList.push({number:e,fromTime:i,toTime:t})},parseMobileNumber:function(e){return(e=e.replace(/[^0-9]/g,"")).length<9?"":(9===e.length&&(e="48"+e),e.length>11?"":"+"+e)},parseMobileTime:function(e){e.trim().length||(e="00:00"),e>-1&&e<25&&(e<10?e="0"+e+":00":"24"===e?e="00:00":e+=":00");var i=e.match(/([0-9]{1,2})[^0-9]*([0-9]{2})/);return null===i?"00:00":(1===i[1].length&&(i[1]="0"+i[1]),i[1]+":"+i[2])},handleFailure:function(e){var i=e.responseJSON,t=i&&i.error&&i.error.message;return this.t.has("FORM:ERROR:"+t)?this.showErrorMessage(this.t("FORM:ERROR:"+t)):l.prototype.handleFailure.apply(this,arguments)}})});