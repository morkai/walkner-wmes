// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/ZeroClipboard","app/i18n","app/user","app/core/Model","app/core/views/FormView","app/data/views/OrgUnitDropdownsView","app/data/aors","app/data/companies","app/data/divisions","app/data/subdivisions","app/data/prodFunctions","app/data/privileges","app/vendors/util/setUpVendorSelect2","app/users/templates/form"],function(i,t,e,o,s,n,r,a,d,l,p,c,u,h,v){"use strict";var g=r.ORG_UNIT;return n.extend({template:v,events:{submit:"submitForm",'input input[type="password"]':function(i){null!==this.timers.validatePasswords&&clearTimeout(this.timers.validatePasswords),this.timers.validatePasswords=setTimeout(this.validatePasswords.bind(this,i),100)}},initialize:function(){n.prototype.initialize.call(this),this.accountMode=this.options.editMode&&o.data._id===this.model.id&&!o.isAllowedTo("USERS:MANAGE"),this.orgUnitDropdownsView=new r({orgUnit:g.SUBDIVISION,allowClear:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView)},destroy:function(){this.privilegesCopyClient&&this.privilegesCopyClient.destroy()},afterRender:function(){n.prototype.afterRender.call(this),this.options.editMode||this.$('input[type="password"]').attr("required",!0),this.accountMode||(this.$id("aors").select2({width:"100%",allowClear:!0}),this.setUpProdFunctionSelect2(),this.setUpCompanySelect2(),this.setUpVendorSelect2(),this.setUpPrivilegesControls(),this.listenToOnce(this.orgUnitDropdownsView,"afterRender",this.setUpOrgUnitDropdowns))},setUpOrgUnitDropdowns:function(){var i=null,t=null;switch(this.model.get("orgUnitType")){case"division":t=g.DIVISION,i=new s({division:this.model.get("orgUnitId")});break;case"subdivision":t=g.SUBDIVISION,i=new s({subdivision:this.model.get("orgUnitId")})}this.orgUnitDropdownsView.selectValue(i,t)},setUpPrivilegesControls:function(){var i={},o=[];u.forEach(function(t){var s=e("users","PRIVILEGE:"+t);i[s]=t,o.push({id:t,text:s})});var s=this.$id("privileges").select2({width:"100%",allowClear:!1,tags:o,tokenSeparators:[";"],createSearchChoice:function(t){var e=t.trim(),o=i[e];return o?{id:o,text:e}:null}});this.privilegesCopyClient=new t(this.$id("copyPrivileges")),this.privilegesCopyClient.on("load",function(i){i.on("datarequested",function(i){var t=s.select2("data");i.setText(0===t.length?"":t.map(function(i){return i.text}).join(";")+";")})}),this.privilegesCopyClient.on("wrongflash noflash",function(){t.destroy()})},setUpProdFunctionSelect2:function(){this.$id("prodFunction").select2({width:"100%",allowClear:!0,data:this.getProdFunctionsForCompany()})},setUpCompanySelect2:function(){var i=this.$id("company").select2({width:"100%",allowClear:!0}),t=this.$id("prodFunction"),e=this;i.on("change",function(){var i=t.val();t.select2("val",null),e.setUpProdFunctionSelect2(),t.select2("val",i)})},setUpVendorSelect2:function(){var i=h(this.$id("vendor"),{placeholder:e("users","NO_DATA:vendor")}),t=this.model.get("vendor");t&&t._id&&i.select2("data",i.prepareData(t))},getProdFunctionsForCompany:function(){var i=this.$id("company").val();return""===i?[]:c.filter(function(t){return-1!==t.get("companies").indexOf(i)}).map(function(i){return{id:i.id,text:i.getLabel()}})},validatePasswords:function(){var i=this.$id("password"),t=this.$id("password2");t[0].setCustomValidity(i.val()===t.val()?"":e("users","FORM:ERROR:passwordMismatch")),this.timers.validatePassword=null},serialize:function(){return i.extend(n.prototype.serialize.call(this),{aors:a.toJSON(),companies:d.toJSON(),privileges:u,accountMode:this.accountMode})},serializeToForm:function(){var i=this.model.toJSON();return i.privileges=i.privileges.join(","),i.vendor=null,i},serializeForm:function(t){return t=i.defaults(t,{privileges:[],aors:[]}),"string"==typeof t.aors&&(t.aors=t.aors.split(",")),"string"==typeof t.privileges&&(t.privileges=t.privileges.split(",")),t.company&&t.company.length||(t.company=null),t.prodFunction&&t.prodFunction.length||(t.prodFunction=null),t.vendor&&t.vendor.length||(t.vendor=null),t.subdivision?(t.orgUnitType="subdivision",t.orgUnitId=t.subdivision):t.division?(t.orgUnitType="division",t.orgUnitId=t.division):(t.orgUnitType="unspecified",t.orgUnitId=null),t}})});