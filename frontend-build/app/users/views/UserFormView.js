define(["require","underscore","jquery","app/i18n","app/user","app/viewport","app/core/Model","app/core/views/FormView","app/core/util/idAndLabel","app/core/util/uuid","app/orgUnits/views/OrgUnitDropdownsView","app/data/loadedModules","app/data/aors","app/data/companies","app/data/prodFunctions","app/data/privileges","app/data/clipboard","app/vendors/util/setUpVendorSelect2","app/mrpControllers/util/setUpMrpSelect2","../User","app/users/templates/formMobileList","app/users/templates/form"],function(i,e,t,s,o,r,n,l,a,d,c,p,h,u,m,v,f,g,w,b,U,y){"use strict";var M=c.ORG_UNIT;return l.extend({template:y,events:{submit:"submitForm",'input input[type="password"]':function(i){null!==this.timers.validatePasswords&&clearTimeout(this.timers.validatePasswords),this.timers.validatePasswords=setTimeout(this.validatePasswords.bind(this,i),30)},"change #-aors":"resizeColumns","keydown #-mobile":function(i){if(13===i.keyCode)return this.$id("mobile-add").click(),!1},"click #-mobile-add":function(){var i=this.$id("mobile-number"),e=this.$id("mobile-from"),t=this.$id("mobile-to");this.addMobile(i.val(),e.val(),t.val()),this.renderMobileList(),i.val("").focus(),e.val(""),t.val("")},"click .users-form-mobile-remove":function(i){return this.removeMobile(this.$(i.target).closest("li").attr("data-number")),this.$id("mobile-number").select(),!1},"keydown #-cardUid":function(i){if("Enter"===i.key)return!1},"click #-copyPrivileges":"copyPrivileges","click #-genApiKey":"genApiKey","change #-oshWorkplace":function(){this.setUpOshSelect2(this.$id("oshWorkplace").val()||null,null)}},initialize:function(){l.prototype.initialize.call(this),this.mobileList=null,this.accountMode=this.options.editMode&&o.data._id===this.model.id&&!o.isAllowedTo("USERS:MANAGE"),p.isLoaded("orgUnits")&&(this.orgUnitDropdownsView=new c({orgUnit:M.SUBDIVISION,allowClear:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView),this.listenTo(this.orgUnitDropdownsView,"afterRender",this.resizeColumns)),t(window).on("resize."+this.idPrefix,e.debounce(this.resizeColumns.bind(this),16))},destroy:function(){t(window).off("."+this.idPrefix),t(document).off("."+this.idPrefix)},afterRender:function(){l.prototype.afterRender.call(this),this.accountMode||(this.$id("aors").select2({width:"100%",allowClear:!0,multiple:!0,placeholder:" ",data:h.map(a)}),this.setUpOshSelect2(),this.setUpProdFunctionSelect2(),this.setUpCompanySelect2(),this.setUpVendorSelect2(),this.setUpPrivilegesControls(),this.orgUnitDropdownsView&&this.listenToOnce(this.orgUnitDropdownsView,"afterRender",this.setUpOrgUnitDropdowns)),w(this.$id("mrps"),{width:"100%"}),this.mobileList||(this.mobileList=this.model.get("mobile")||[]),this.renderMobileList(),this.resizeColumns()},setUpOrgUnitDropdowns:function(){var i=null,e=null;switch(this.model.get("orgUnitType")){case"division":e=M.DIVISION,i=new n({division:this.model.get("orgUnitId")});break;case"subdivision":e=M.SUBDIVISION,i=new n({subdivision:this.model.get("orgUnitId")})}this.orgUnitDropdownsView.selectValue(i,e)},setUpOshSelect2:function(e,t){var s=this.$id("oshWorkplace"),o=this.$id("oshDivision");if(s.length){void 0===e&&(e=this.model.get("oshWorkplace"),t=this.model.get("oshDivision")),s.val(e||""),o.val(t||"");var r=i("app/wmes-osh-common/dictionaries");s.select2({width:"100%",allowClear:!0,placeholder:" ",data:r.workplaces.map(function(i){return{id:i.id,text:i.getLabel({long:!0})}})}),o.select2({width:"100%",allowClear:!0,placeholder:" ",data:r.divisions.where({workplace:+e}).map(function(i){return{id:i.id,text:i.getLabel({long:!0})}})})}},setUpPrivilegesControls:function(){var i=this,e={},t=[];v.forEach(function(s){var o=i.t("PRIVILEGE:"+s);e[o]=s,t.push({id:s,text:o})}),i.$id("privileges").select2({width:"100%",allowClear:!1,tags:t,tokenSeparators:[";"],createSearchChoice:function(i){var t=i.trim(),s=e[t];return s?{id:s,text:t}:null}})},serializePrivileges:function(){var i=this.$id("privileges").select2("data");return 0===i.length?"":i.map(function(i){return i.text}).join(";")+";"},copyPrivileges:function(i){var e=this;f.copy(function(t){t.setData("text/plain",e.serializePrivileges()),f.showTooltip(e,i.currentTarget,-1,-1,{title:e.t("FORM:copyPrivileges:success"),placement:"left"})})},genApiKey:function(){this.$id("apiKey").val((d()+d()).replace(/-/g,"").toLowerCase())},setUpProdFunctionSelect2:function(){this.$id("prodFunction").select2({width:"100%",allowClear:!0,placeholder:" ",data:m.map(a)})},setUpCompanySelect2:function(){this.$id("company").select2({width:"100%",allowClear:!0,placeholder:" ",data:u.map(a)})},setUpVendorSelect2:function(){var i=g(this.$id("vendor")),e=this.model.get("vendor");e&&e._id&&i.select2("data",i.prepareData(e))},validatePasswords:function(){var i=this.$id("password"),e=this.$id("password2");i.val()===e.val()?e[0].setCustomValidity(""):e[0].setCustomValidity(this.t("FORM:ERROR:passwordMismatch")),this.timers.validatePassword=null},getTemplateData:function(){return{loadedModules:p,notifications:b.NOTIFICATIONS,accountMode:this.accountMode}},serializeToForm:function(){var i=this.model.toJSON();return i.active=(!!i.active).toString(),i.privileges=(i.privileges||[]).join(","),i.vendor=null,i.aors=(i.aors||[]).join(","),i.mrps=(i.mrps||[]).join(","),i},serializeForm:function(i){return i=e.defaults(i,{privileges:[],aors:[],mrps:[],preferences:{}}),["firstName","lastName","personnelId","email"].forEach(function(e){i[e]&&i[e].length||(i[e]="")}),["company","prodFunction","vendor","oshWorkplace","oshDivision"].forEach(function(e){i[e]&&i[e].length||(i[e]=null)}),["card","cardUid"].forEach(function(e){i[e]=i[e]?i[e].replace(/[^0-9]+/g,"").replace(/^0+/,""):null}),["aors","mrps","privileges"].forEach(function(e){"string"==typeof i[e]&&(i[e]=i[e].split(","))}),i.subdivision?(i.orgUnitType="subdivision",i.orgUnitId=i.subdivision):i.division?(i.orgUnitType="division",i.orgUnitId=i.division):(i.orgUnitType="unspecified",i.orgUnitId=null),i.mobile=this.serializeMobile(),i},serializeMobile:function(){var i={};return e.forEach(this.mobileList,function(e){i[e.number]=e}),e.values(i)},resizeColumns:function(){var i=this.$(".col-lg-3"),e=null,s=0;i.each(function(){var i=t(this).css("height",""),o=i.outerHeight();o>s&&(e=i,s=o)}),window.innerWidth>=1200&&i.each(function(){this.style.height=this===e[0]?"":s+"px"})},renderMobileList:function(){this.$id("mobile-list").html(this.renderPartialHtml(U,{mobileList:this.mobileList}))},removeMobile:function(i){this.mobileList=this.mobileList.filter(function(e){return e.number!==i}),this.renderMobileList()},addMobile:function(i,e,t){i=this.parseMobileNumber(i),e=this.parseMobileTime(e),t=this.parseMobileTime(t),i&&e&&t&&this.mobileList.push({number:i,fromTime:e,toTime:t})},parseMobileNumber:function(i){return(i=i.replace(/[^0-9]/g,"")).length<9?"":(9===i.length&&(i="48"+i),i.length>11?"":"+"+i)},parseMobileTime:function(i){i.trim().length||(i="00:00"),i>-1&&i<25&&(i<10?i="0"+i+":00":"24"===i?i="00:00":i+=":00");var e=i.match(/([0-9]{1,2})[^0-9]*([0-9]{2})/);return null===e?"00:00":(1===e[1].length&&(e[1]="0"+e[1]),e[1]+":"+e[2])},handleFailure:function(i){var e=i.responseJSON,t=e&&e.error&&e.error.message;return this.t.has("FORM:ERROR:"+t)?this.showErrorMessage(this.t("FORM:ERROR:"+t)):l.prototype.handleFailure.apply(this,arguments)}})});