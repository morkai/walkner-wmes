define(["require","underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/data/loadedModules","app/users/templates/userInfoPopover"],function(e,o,n,t,a,r,l,s,u){"use strict";var i=["firstName","lastName","login","personnelId","email","mobile","prodFunction","company","syncData","presence","oshWorkplace","oshDivision"],p={},c=null,m=null,d=null,f=null,v=null,b=!0,g=null;function I(e,a){null===c&&(c=t.subscribe("users.edited",function(e){var n=e.model;null===p[n._id]&&(p[n._id]={}),p[n._id]&&o.assign(p[n._id],o.pick(n,Object.keys(i)))})),e.style.cursor="wait",p[a]=null;var r=n.ajax({url:"/users?_id="+a+"&limit(1)&select("+i.join(",")+")"});r.always(function(){e.style.cursor=""}),r.done(function(o){1===o.totalCount&&(p[a]=o.collection[0],v===a&&h(e,a,!0))})}function h(t,i,c){if(!m||m[0]!==t){null===g&&(g=n(".navbar").find('a[href^="#users"]').length>0),y(),v=i;var I,h,k=p[i],N=r.get(k.prodFunction),w=l.get(k.company),D=(I=k.mobile,h=T(a.format(Date.now(),"HH:mm")).value,o.find(I,function(e){var o=T(e.fromTime),n=T("00:00"===e.toTime?"24:00":e.toTime);return n.value<o.value?h<n.value||h>=o.value:o.value<n.value&&h>=o.value&&h<n.value}));D&&(/^\+48[0-9]{9}$/.test(D.number)?D.label=D.number.substr(3,3)+" "+D.number.substr(6,3)+" "+D.number.substr(9,3):D.label=D.number),d||(d=n(n.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML);var _="",L="";if(s.isLoaded("wmes-osh")){var j=e("app/wmes-osh-common/dictionaries");_=j.workplaces.getLabel(k.oshWorkplace),L=j.divisions.getLabel(k.oshDivision)}(m=n(t).popover({placement:"top",container:t.parentNode,trigger:"manual",html:!0,content:u({linkToDetails:g,userInfo:{_id:k._id,name:k.firstName&&k.lastName?k.firstName+" "+k.lastName:k.login,personnelId:k.personnelId,position:k.syncData.jobTitle||(N?N.getLabel():null),company:w?w.getLabel():k.company,email:k.email,mobile:D,oshWorkplace:_,oshDivision:L}}),template:d})).data("userId",k._id),m.on("click.userInfoPopover",function(e){if("0"!==e.currentTarget.dataset.clickable||e.ctrlKey)return b?b=!1:y(),!1}),f&&clearTimeout(f),c?m.popover("show"):f=setTimeout(function(){m&&m.data("userId")===v&&m.popover("show")},200)}}function y(){v=null,b=!0,f&&(clearTimeout(f),f=null),m&&(m.off(".userInfoPopover"),m.popover("destroy"),m=null,n(".userInfoPopover").remove())}function T(e){var o=e.split(":"),n=parseInt(o[0],10),t=parseInt(o[1],10);return{hours:n,minutes:t,value:1e3*n+t}}n(document.body).on("click",function(e){m&&(n(e.target).closest(".popover").length?setTimeout(y,1):y())}).on("mouseenter",".userInfo-label",function(e){var o=e.currentTarget.parentNode,n=o.dataset.userId;if(n){if(v=n,p[n])return h(o,n);null!==p[n]&&I(o,n)}}).on("mouseleave",".userInfo-label",function(e){b?y():e.currentTarget.parentNode.dataset.userId!==v&&(b=!0,y())})});