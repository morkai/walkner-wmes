define(["underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/users/templates/userInfoPopover"],function(e,o,n,t,r,u,l){"use strict";var a=["firstName","lastName","login","personellId","email","mobile","prodFunction","company","kdPosition","presence"],i={},s=null,p=null,m=null,c=null;function d(t,r){null===s&&(s=n.subscribe("users.edited",function(o){var n=o.model;null===i[n._id]&&(i[n._id]={}),i[n._id]&&e.assign(i[n._id],e.pick(n,Object.keys(a)))})),t.style.cursor="wait";var u=o.ajax({url:"/users?_id="+r+"&limit(1)&select("+a.join(",")+")"});u.always(function(){t.style.cursor=""}),u.fail(function(){i[r]=null}),u.done(function(e){1===e.totalCount?(i[r]=e.collection[0],f(t,r)):i[r]=null})}function f(n,a){if(!p||p[0]!==n){v();var s,d,f=!0,I=i[a],g=r.get(I.prodFunction),y=u.get(I.company),T=(s=I.mobile,d=b(t.format(Date.now(),"HH:mm")).value,e.find(s,function(e){var o=b(e.fromTime),n=b("00:00"===e.toTime?"24:00":e.toTime);return n.value<o.value?d<n.value||d>=o.value:o.value<n.value&&d>=o.value&&d<n.value}));T&&(/^\+48[0-9]{9}$/.test(T.number)?T.label=T.number.substr(3,3)+" "+T.number.substr(6,3)+" "+T.number.substr(9,3):T.label=T.number),m||(m=o(o.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML),(p=o(n).popover({placement:"top",container:n.parentNode,trigger:"manual",html:!0,content:l({userInfo:{_id:I._id,name:I.firstName&&I.lastName?I.firstName+" "+I.lastName:I.login,personnelId:I.personellId,position:I.kdPosition||(g?g.getLabel():null),company:y?y.getLabel():I.company,email:I.email,mobile:T}}),template:m})).on("click.userInfoPopover",function(){return f?f=!1:v(),!1}),p.on("mouseleave.userInfoPopover",function(){c&&(clearTimeout(c),c=null),f&&v()}),c&&clearTimeout(c),c=setTimeout(function(){p&&p.popover("show")},200)}}function v(){p&&(p.off(".userInfoPopover"),p.popover("destroy"),p=null,o(".userInfoPopover").remove())}function b(e){var o=e.split(":"),n=parseInt(o[0],10),t=parseInt(o[1],10);return{hours:n,minutes:t,value:1e3*n+t}}o(document.body).on("click",function(e){p&&(o(e.target).closest(".popover").length?setTimeout(v,1):v())}),o(document.body).on("mouseenter",".userInfo-label",function(e){var o=e.currentTarget.parentNode,n=o.dataset.userId;if(n)return i[n]?f(o,n):void(null!==i[n]&&d(o,n))})});