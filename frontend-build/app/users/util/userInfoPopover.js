define(["underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/users/templates/userInfoPopover"],function(e,n,o,t,r,u,a){"use strict";var l=["firstName","lastName","login","personellId","email","mobile","prodFunction","company","kdPosition","presence"],s={},i=null,p=null,m=null,c=null,d=null,f=!0;function v(t,r){null===i&&(i=o.subscribe("users.edited",function(n){var o=n.model;null===s[o._id]&&(s[o._id]={}),s[o._id]&&e.assign(s[o._id],e.pick(o,Object.keys(l)))})),t.style.cursor="wait",s[r]=null;var u=n.ajax({url:"/users?_id="+r+"&limit(1)&select("+l.join(",")+")"});u.always(function(){t.style.cursor=""}),u.done(function(e){1===e.totalCount&&(s[r]=e.collection[0],d===r&&b(t,r,!0))})}function b(o,l,i){if(!p||p[0]!==o){I(),d=l;var v,b,y=s[l],T=r.get(y.prodFunction),N=u.get(y.company),_=(v=y.mobile,b=g(t.format(Date.now(),"HH:mm")).value,e.find(v,function(e){var n=g(e.fromTime),o=g("00:00"===e.toTime?"24:00":e.toTime);return o.value<n.value?b<o.value||b>=n.value:n.value<o.value&&b>=n.value&&b<o.value}));_&&(/^\+48[0-9]{9}$/.test(_.number)?_.label=_.number.substr(3,3)+" "+_.number.substr(6,3)+" "+_.number.substr(9,3):_.label=_.number),m||(m=n(n.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML),(p=n(o).popover({placement:"top",container:o.parentNode,trigger:"manual",html:!0,content:a({userInfo:{_id:y._id,name:y.firstName&&y.lastName?y.firstName+" "+y.lastName:y.login,personnelId:y.personellId,position:y.kdPosition||(T?T.getLabel():null),company:N?N.getLabel():y.company,email:y.email,mobile:_}}),template:m})).data("userId",y._id),p.on("click.userInfoPopover",function(){return f?f=!1:I(),!1}),c&&clearTimeout(c),i?p.popover("show"):c=setTimeout(function(){p&&p.data("userId")===d&&p.popover("show")},200)}}function I(){d=null,f=!0,c&&(clearTimeout(c),c=null),p&&(p.off(".userInfoPopover"),p.popover("destroy"),p=null,n(".userInfoPopover").remove())}function g(e){var n=e.split(":"),o=parseInt(n[0],10),t=parseInt(n[1],10);return{hours:o,minutes:t,value:1e3*o+t}}n(document.body).on("click",function(e){p&&(n(e.target).closest(".popover").length?setTimeout(I,1):I())}).on("mouseenter",".userInfo-label",function(e){var n=e.currentTarget.parentNode,o=n.dataset.userId;if(o){if(d=o,s[o])return b(n,o);null!==s[o]&&v(n,o)}}).on("mouseleave",".userInfo-label",function(e){f?I():e.currentTarget.parentNode.dataset.userId!==d&&(f=!0,I())})});