define(["underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/users/templates/userInfoPopover"],function(e,o,n,t,u,r,l){"use strict";var a=["firstName","lastName","login","personellId","email","mobile","prodFunction","company","kdPosition","presence"],i={},s=null,m=null,p=null,c=null,d=null;function f(t,u){null===s&&(s=n.subscribe("users.edited",function(o){var n=o.model;null===i[n._id]&&(i[n._id]={}),i[n._id]&&e.assign(i[n._id],e.pick(n,Object.keys(a)))})),t.style.cursor="wait",i[u]=null;var r=o.ajax({url:"/users?_id="+u+"&limit(1)&select("+a.join(",")+")"});r.always(function(){t.style.cursor=""}),r.done(function(e){1===e.totalCount&&(i[u]=e.collection[0],d===u&&v(t,u))})}function v(n,a){if(!m||m[0]!==n){b(),d=a;var s,f,v=!0,g=i[a],y=u.get(g.prodFunction),T=r.get(g.company),N=(s=g.mobile,f=I(t.format(Date.now(),"HH:mm")).value,e.find(s,function(e){var o=I(e.fromTime),n=I("00:00"===e.toTime?"24:00":e.toTime);return n.value<o.value?f<n.value||f>=o.value:o.value<n.value&&f>=o.value&&f<n.value}));N&&(/^\+48[0-9]{9}$/.test(N.number)?N.label=N.number.substr(3,3)+" "+N.number.substr(6,3)+" "+N.number.substr(9,3):N.label=N.number),p||(p=o(o.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML),(m=o(n).popover({placement:"top",container:n.parentNode,trigger:"manual",html:!0,content:l({userInfo:{_id:g._id,name:g.firstName&&g.lastName?g.firstName+" "+g.lastName:g.login,personnelId:g.personellId,position:g.kdPosition||(y?y.getLabel():null),company:T?T.getLabel():g.company,email:g.email,mobile:N}}),template:p})).data("userId",g._id),m.on("click.userInfoPopover",function(){return v?v=!1:b(),!1}),m.on("mouseleave.userInfoPopover",function(){c&&(clearTimeout(c),c=null),v&&b()}),c&&clearTimeout(c),c=setTimeout(function(){m&&m.data("userId")===d&&m.popover("show")},200)}}function b(){d=null,c&&(clearTimeout(c),c=null),m&&(m.off(".userInfoPopover"),m.popover("destroy"),m=null,o(".userInfoPopover").remove())}function I(e){var o=e.split(":"),n=parseInt(o[0],10),t=parseInt(o[1],10);return{hours:n,minutes:t,value:1e3*n+t}}o(document.body).on("click",function(e){m&&(o(e.target).closest(".popover").length?setTimeout(b,1):b())}),o(document.body).on("mouseenter",".userInfo-label",function(e){var o=e.currentTarget.parentNode,n=o.dataset.userId;if(n){if(d=n,i[n])return v(o,n);null!==i[n]&&f(o,n)}}).on("mouseleave",".userInfo-label",function(){b()})});