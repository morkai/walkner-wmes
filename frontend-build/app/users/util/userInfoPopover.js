define(["require","underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/data/loadedModules","app/users/templates/userInfoPopover"],function(e,o,n,t,a,r,l,u,s){"use strict";var i=["firstName","lastName","login","personnelId","email","mobile","prodFunction","company","syncData","presence","oshWorkplace","oshDepartment"],p={},c=null,m=null,d=null,f=null,v=null,b=!0,g=null;function I(e,a){null===c&&(c=t.subscribe("users.edited",function(e){var n=e.model;null===p[n._id]&&(p[n._id]={}),p[n._id]&&o.assign(p[n._id],o.pick(n,Object.keys(i)))})),e.style.cursor="wait",p[a]=null;var r=n.ajax({url:"/users?_id="+a+"&limit(1)&select("+i.join(",")+")"});r.always(function(){e.style.cursor=""}),r.done(function(o){1===o.totalCount&&(p[a]=o.collection[0],v===a&&y(e,a,!0))})}function y(t,i,c){if(!m||m[0]!==t){null===g&&(g=n(".navbar").find('a[href^="#users"]').length>0),h(),v=i;var I,y,k=p[i],D=r.get(k.prodFunction),N=l.get(k.company),w=(I=k.mobile,y=T(a.format(Date.now(),"HH:mm")).value,o.find(I,function(e){var o=T(e.fromTime),n=T("00:00"===e.toTime?"24:00":e.toTime);return n.value<o.value?y<n.value||y>=o.value:o.value<n.value&&y>=o.value&&y<n.value}));w&&(/^\+48[0-9]{9}$/.test(w.number)?w.label=w.number.substr(3,3)+" "+w.number.substr(6,3)+" "+w.number.substr(9,3):w.label=w.number),d||(d=n(n.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML);var _="",L="";if(u.isLoaded("wmes-osh")){var j=e("app/wmes-osh-common/dictionaries");_=j.workplaces.getLabel(k.oshWorkplace),L=j.departments.getLabel(k.oshDepartment)}(m=n(t).popover({placement:"top",container:t.parentNode,trigger:"manual",html:!0,content:s({linkToDetails:g,userInfo:{_id:k._id,name:k.firstName||k.lastName?(k.firstName+" "+k.lastName).trim():k.login,personnelId:k.personnelId,position:k.syncData.jobTitle||(D?D.getLabel():""),company:N?N.getLabel():k.syncData.company||k.company||"",email:k.email,mobile:w,oshWorkplace:_,oshDepartment:L}}),template:d})).data("userId",k._id),m.on("click.userInfoPopover",function(e){if("0"!==e.currentTarget.dataset.clickable||e.ctrlKey)return b?b=!1:h(),!1}),f&&clearTimeout(f),c?m.popover("show"):f=setTimeout(function(){m&&m.data("userId")===v&&m.popover("show")},200)}}function h(){v=null,b=!0,f&&(clearTimeout(f),f=null),m&&(m.off(".userInfoPopover"),m.popover("destroy"),m=null,n(".userInfoPopover").remove())}function T(e){var o=e.split(":"),n=parseInt(o[0],10),t=parseInt(o[1],10);return{hours:n,minutes:t,value:1e3*n+t}}n(document.body).on("click",function(e){m&&(n(e.target).closest(".popover").length?setTimeout(h,1):h())}).on("mouseenter",".userInfo-label",function(e){var o=e.currentTarget.parentNode,n=o.dataset.userId;if(n){if(v=n,p[n])return y(o,n);null!==p[n]&&I(o,n)}}).on("mouseleave",".userInfo-label",function(e){b?h():e.currentTarget.parentNode.dataset.userId!==v&&(b=!0,h())})});