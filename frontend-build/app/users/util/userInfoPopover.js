define(["underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/users/templates/userInfoPopover"],function(e,o,n,t,u,l,r){"use strict";var a=["firstName","lastName","login","personellId","email","mobile","prodFunction","company","kdPosition","presence"],i={},s=null,m=null,p=null,c=null;function f(t,u){null===s&&(s=n.subscribe("users.edited",function(o){var n=o.model;null===i[n._id]&&(i[n._id]={}),i[n._id]&&e.assign(i[n._id],e.pick(n,Object.keys(a)))})),t.style.cursor="wait";var l=o.ajax({url:"/users?_id="+u+"&limit(1)&select("+a.join(",")+")"});l.always(function(){t.style.cursor=""}),l.fail(function(){i[u]=null}),l.done(function(e){1===e.totalCount?(i[u]=e.collection[0],d(t,u)):i[u]=null})}function d(n,a){if(!m||m[0]!==n){v();var s,f,d=!0,I=i[a],g=u.get(I.prodFunction),y=l.get(I.company),T=(s=I.mobile,f=b(t.format(Date.now(),"HH:mm")).value,e.find(s,function(e){var o=b(e.fromTime),n=b("00:00"===e.toTime?"24:00":e.toTime);return n.value<o.value?f<n.value||f>=o.value:o.value<n.value&&f>=o.value&&f<n.value}));T&&(/^\+48[0-9]{9}$/.test(T.number)?T.label=T.number.substr(3,3)+" "+T.number.substr(6,3)+" "+T.number.substr(9,3):T.label=T.number),p||(p=o(o.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML),(m=o(n).popover({placement:"top",container:n.parentNode,trigger:"manual",html:!0,content:r({userInfo:{_id:I._id,name:I.firstName&&I.lastName?I.firstName+" "+I.lastName:I.login,personnelId:I.personellId,position:I.kdPosition||(g?g.getLabel():null),company:y?y.getLabel():I.company,email:I.email,mobile:T}}),template:p})).on("click.userInfoPopover",function(){return d?d=!1:v(),!1}),m.on("mouseleave.userInfoPopover",function(){c&&(clearTimeout(c),c=null),d&&v()}),c&&clearTimeout(c),c=setTimeout(function(){m&&m.popover("show")},200)}}function v(){c&&(clearTimeout(c),c=null),m&&(m.off(".userInfoPopover"),m.popover("destroy"),m=null,o(".userInfoPopover").remove())}function b(e){var o=e.split(":"),n=parseInt(o[0],10),t=parseInt(o[1],10);return{hours:n,minutes:t,value:1e3*n+t}}o(document.body).on("click",function(e){m&&(o(e.target).closest(".popover").length?setTimeout(v,1):v())}),o(document.body).on("mouseenter",".userInfo-label",function(e){var o=e.currentTarget.parentNode,n=o.dataset.userId;if(n)return i[n]?d(o,n):void(null!==i[n]&&f(o,n))}).on("mouseleave",".userInfo-label",function(){v()})});