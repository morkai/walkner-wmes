define(["require","underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/data/loadedModules","app/users/templates/userInfoPopover"],function(e,o,n,t,r,a,l,s,u){"use strict";var i=["firstName","lastName","login","personellId","email","mobile","prodFunction","company","kdPosition","presence","oshWorkplace","oshDivision"],p={},c=null,m=null,d=null,f=null,v=null,b=!0,g=null;function I(e,r){null===c&&(c=t.subscribe("users.edited",function(e){var n=e.model;null===p[n._id]&&(p[n._id]={}),p[n._id]&&o.assign(p[n._id],o.pick(n,Object.keys(i)))})),e.style.cursor="wait",p[r]=null;var a=n.ajax({url:"/users?_id="+r+"&limit(1)&select("+i.join(",")+")"});a.always(function(){e.style.cursor=""}),a.done(function(o){1===o.totalCount&&(p[r]=o.collection[0],v===r&&h(e,r,!0))})}function h(t,i,c){if(!m||m[0]!==t){null===g&&(g=n(".navbar").find('a[href^="#users"]').length>0),T(),v=i;var I,h,y=p[i],N=a.get(y.prodFunction),w=l.get(y.company),_=(I=y.mobile,h=k(r.format(Date.now(),"HH:mm")).value,o.find(I,function(e){var o=k(e.fromTime),n=k("00:00"===e.toTime?"24:00":e.toTime);return n.value<o.value?h<n.value||h>=o.value:o.value<n.value&&h>=o.value&&h<n.value}));_&&(/^\+48[0-9]{9}$/.test(_.number)?_.label=_.number.substr(3,3)+" "+_.number.substr(6,3)+" "+_.number.substr(9,3):_.label=_.number),d||(d=n(n.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML);var L="",P="";if(s.isLoaded("wmes-osh")){var D=e("app/wmes-osh-common/dictionaries");L=D.workplaces.getLabel(y.oshWorkplace),P=D.divisions.getLabel(y.oshDivision)}(m=n(t).popover({placement:"top",container:t.parentNode,trigger:"manual",html:!0,content:u({linkToDetails:g,userInfo:{_id:y._id,name:y.firstName&&y.lastName?y.firstName+" "+y.lastName:y.login,personnelId:y.personellId,position:y.kdPosition||(N?N.getLabel():null),company:w?w.getLabel():y.company,email:y.email,mobile:_,oshWorkplace:L,oshDivision:P}}),template:d})).data("userId",y._id),m.on("click.userInfoPopover",function(e){if("0"!==e.currentTarget.dataset.clickable||e.ctrlKey)return b?b=!1:T(),!1}),f&&clearTimeout(f),c?m.popover("show"):f=setTimeout(function(){m&&m.data("userId")===v&&m.popover("show")},200)}}function T(){v=null,b=!0,f&&(clearTimeout(f),f=null),m&&(m.off(".userInfoPopover"),m.popover("destroy"),m=null,n(".userInfoPopover").remove())}function k(e){var o=e.split(":"),n=parseInt(o[0],10),t=parseInt(o[1],10);return{hours:n,minutes:t,value:1e3*n+t}}n(document.body).on("click",function(e){m&&(n(e.target).closest(".popover").length?setTimeout(T,1):T())}).on("mouseenter",".userInfo-label",function(e){var o=e.currentTarget.parentNode,n=o.dataset.userId;if(n){if(v=n,p[n])return h(o,n);null!==p[n]&&I(o,n)}}).on("mouseleave",".userInfo-label",function(e){b?T():e.currentTarget.parentNode.dataset.userId!==v&&(b=!0,T())})});