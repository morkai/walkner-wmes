define(["underscore","jquery","app/pubsub","app/time","app/data/prodFunctions","app/data/companies","app/users/templates/userInfoPopover"],function(e,n,o,t,r,l,a){"use strict";var u=["firstName","lastName","login","personellId","email","mobile","prodFunction","company","kdPosition","presence"],s={},i=null,p=null,c=null,m=null,d=null,f=!0,v=null;function b(t,r){null===i&&(i=o.subscribe("users.edited",function(n){var o=n.model;null===s[o._id]&&(s[o._id]={}),s[o._id]&&e.assign(s[o._id],e.pick(o,Object.keys(u)))})),t.style.cursor="wait",s[r]=null;var l=n.ajax({url:"/users?_id="+r+"&limit(1)&select("+u.join(",")+")"});l.always(function(){t.style.cursor=""}),l.done(function(e){1===e.totalCount&&(s[r]=e.collection[0],d===r&&I(t,r,!0))})}function I(o,u,i){if(!p||p[0]!==o){null===v&&(v=n(".navbar").find('a[href^="#users"]').length>0),g(),d=u;var b,I,y=s[u],N=r.get(y.prodFunction),k=l.get(y.company),_=(b=y.mobile,I=T(t.format(Date.now(),"HH:mm")).value,e.find(b,function(e){var n=T(e.fromTime),o=T("00:00"===e.toTime?"24:00":e.toTime);return o.value<n.value?I<o.value||I>=n.value:n.value<o.value&&I>=n.value&&I<o.value}));_&&(/^\+48[0-9]{9}$/.test(_.number)?_.label=_.number.substr(3,3)+" "+_.number.substr(6,3)+" "+_.number.substr(9,3):_.label=_.number),c||(c=n(n.fn.popover.Constructor.DEFAULTS.template).addClass("userInfoPopover")[0].outerHTML),(p=n(o).popover({placement:"top",container:o.parentNode,trigger:"manual",html:!0,content:a({linkToDetails:v,userInfo:{_id:y._id,name:y.firstName&&y.lastName?y.firstName+" "+y.lastName:y.login,personnelId:y.personellId,position:y.kdPosition||(N?N.getLabel():null),company:k?k.getLabel():y.company,email:y.email,mobile:_}}),template:c})).data("userId",y._id),p.on("click.userInfoPopover",function(e){if("0"!==e.currentTarget.dataset.clickable||e.ctrlKey)return f?f=!1:g(),!1}),m&&clearTimeout(m),i?p.popover("show"):m=setTimeout(function(){p&&p.data("userId")===d&&p.popover("show")},200)}}function g(){d=null,f=!0,m&&(clearTimeout(m),m=null),p&&(p.off(".userInfoPopover"),p.popover("destroy"),p=null,n(".userInfoPopover").remove())}function T(e){var n=e.split(":"),o=parseInt(n[0],10),t=parseInt(n[1],10);return{hours:o,minutes:t,value:1e3*o+t}}n(document.body).on("click",function(e){p&&(n(e.target).closest(".popover").length?setTimeout(g,1):g())}).on("mouseenter",".userInfo-label",function(e){var n=e.currentTarget.parentNode,o=n.dataset.userId;if(o){if(d=o,s[o])return I(n,o);null!==s[o]&&b(n,o)}}).on("mouseleave",".userInfo-label",function(e){f?g():e.currentTarget.parentNode.dataset.userId!==d&&(f=!0,g())})});