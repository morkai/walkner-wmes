define(["underscore","h5.rql/index","app/core/util/transliterate","app/i18n","app/user"],function(e,t,r,n,a){"use strict";function i(e,t,r){return e.id&&e.text?e:(e.name=e.lastName&&e.firstName?e.lastName+" "+e.firstName:e.name||e.login||e._id,{id:e._id,text:t(e,e.name,r),user:e})}function l(){return{id:"$SYSTEM",text:n("users","select2:users:system"),user:null}}function o(){var e=a.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function c(t){var r={};return e.forEach(t,function(e){var t=e.searchName,n=r[t];n&&(!1!==n.active||!0!==e.active)?!0===n.active&&!1===e.active||(n.email||!e.email?n.email&&!e.email||"PHILIPS"!==n.company&&"PHILIPS"===e.company&&(r[t]=e):r[t]=e):r[t]=e}),e.values(r)}function u(e,t,r){t=t.trim();var n=/^[0-9]+$/.test(t)?"personellId":"searchName";"searchName"===n&&(t=d.transliterate(t));var a={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[n,"^"+t]}]}};return r.activeOnly&&a.selector.args.push({name:"eq",args:["active",!0]}),a.sort[n]=1,e.Query.fromObject(a)}function s(e){return e.textFormatter||function(e,t,r,n){return!e&&t.personellId&&(r+=" ("+t.personellId+")"),r}.bind(null,!!e.noPersonnelId)}function d(r,f){if(!r.length)return r;f||(f={});var m=s(f),p={openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:n("users","select2:placeholder")};if(f.collection)f.minimumInputLength=0,f.placeholder=" ",f.data=function(e){var t=s(e),r=[];return(e.currentUserInfo||[]).forEach(function(t){e.collection.get(t[a.idProperty])||r.push({id:t[a.idProperty],text:t.label})}),e.collection.forEach(function(e){r.push(i(e.toJSON(),t))}),r.sort(function(e,t){return e.text.localeCompare(t.text,void 0,{ignorePunctuation:!0,sensitivity:"base"})}),r}(f);else{var v=f.rqlQueryProvider?f.rqlQueryProvider:u,y=f.userFilter?f.userFilter:null;p.ajax={cache:!0,quietMillis:300,url:function(e){return"/users?"+v(t,e,f)},results:function(e,t,r){var n=[l(),o()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(r.term.toLowerCase())}),a=!1===f.filterDuplicates?n.concat(e.collection||[]):n.concat(c(e.collection||[]));return y&&(a=a.filter(y)),{results:a.map(function(e){return i(e,m,r)}).sort(function(e,t){return e.text.localeCompare(t.text)})}}}}if(r.select2(e.assign(p,f)),f.collection){var x=r.data("select2"),h=x.destroy;x.destroy=function(){f.collection.off(null,null,r),h.apply(x,arguments)},f.collection.once("reset add change remove",function(){d(r,f)})}var g=r.val(),I=o(),P=f.currentUserInfo;if(P)Array.isArray(P)?r.select2("data",P.map(function(e){return{id:e.id,text:e.label}})):r.select2("data",{id:P.id,text:P.label});else if(g===I.id)r.select2("data",I);else if("$SYSTEM"===g)r.select2("data",l());else if(g&&f.view){f.view.ajax({type:"GET",url:"/users?_id=in=("+g+")"}).done(function(e){if(e.collection&&e.collection.length){var t=e.collection.map(function(e){return i(e,m)});r.select2("data",f.multiple?t:t[0]),f.onDataLoaded&&f.onDataLoaded()}})}return r}return d.defaultRqlQueryProvider=u,d.filterDuplicates=c,d.transliterate=function(e){return r(e.toUpperCase()).replace(/[^A-Z0-9]+/g,"")},d.getUserInfo=function(e){var t=e.select2("data");if(Array.isArray(t))return t.map(function(e){var t={};return t[a.idProperty]=e.id,t.label=e.text,t});if(t){var r={};return r[a.idProperty]=t.id,r.label=t.text,r}return null},d});