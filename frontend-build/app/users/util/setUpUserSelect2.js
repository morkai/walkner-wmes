define(["underscore","h5.rql/index","app/core/util/transliterate","app/i18n","app/user","app/data/companies"],function(e,r,t,n,a,i){"use strict";function o(r){if(e.isEmpty(r.description))return r.header;var t='<div class="select2-result-with-description">';return t+="<h3>"+r.header+"</h3>",t+="<p>"+r.description+"</p>",t+="</div>"}function s(r,t,n){if(r.id&&r.text)return r;r.name=r.lastName||r.firstName?(r.lastName+" "+r.firstName).trim():r.name||r.login||r._id;var a=t(r,r.name,n),o=e.escape(a),s="";if(r.duplicate){r.personnelId&&(o+=" ("+e.escape(r.personnelId)+")"),r.syncData.jobTitle&&(s=e.escape(r.syncData.jobTitle));var c=i.get(r.company);c?c=c.get("shortName"):r.syncData.company&&(c=r.syncData.company),c&&(s&&(s+=" @ "),s+=e.escape(c)),r.syncData.workplace&&(s&&(s+="<br>"),s+=e.escape(r.syncData.workplace)),r.syncData.department&&(r.syncData.workplace?s+=" \\ ":s&&(s+="<br>"),s+=e.escape(r.syncData.department))}return r.active||(o="<del>"+o+"</del>"),{id:r._id,text:a,header:o,description:s,user:r}}function c(){return{id:"$SYSTEM",text:n("users","select2:users:system"),user:null}}function l(){var e=a.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function u(r){var t={};r.forEach(function(e){t[e.searchName]||(t[e.searchName]=[]);var r=0;e.active||(r-=10),e.email&&(r+=1),e.mobile&&e.mobile.length&&(r+=1),e.privileges&&e.privileges.length&&(r+=1),e.personnelId&&(r+=1),e.syncData&&/PHILIPS|SIGNIFY/i.test(e.syncData.company)&&(r+=1),e.orgUnitId&&(r+=1),e.oshDepartment&&(r+=1),e.duplicate=!1,e.score=r,t[e.searchName].push(e)});var n=[];return e.values(t).forEach(function(e){e.forEach(function(r){r.duplicate=e.length>1,n.push(r)})}),n}function d(e,r,t){r=r.trim();var n=/^[0-9]+$/.test(r)?"personnelId":"searchName";"searchName"===n&&(r=m.transliterate(r));var a={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[n,"^"+r]}]}};return t.activeOnly&&a.selector.args.push({name:"eq",args:["active",!0]}),a.sort[n]=1,t.rqlQueryDecorator&&t.rqlQueryDecorator(a,r,t),e.Query.fromObject(a)}function p(e){return e.textFormatter||function(e,r,t,n){return!e&&r.personnelId&&(t+=" ("+r.personnelId+")"),t}.bind(null,!1!==e.noPersonnelId)}function f(e,r){var t=(e.user&&e.user.searchName||e.text).localeCompare(r.user&&r.user.searchName||r.text,void 0,{ignorePunctuation:!0,sensitivity:"base"});return 0===t&&(t=(r.user&&r.user.score||0)-(e.user&&e.user.score||0)),t}function m(t,i){if(!t.length)return t;i||(i={});var h=p(i),v={openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:n("users","select2:placeholder"),formatResult:o};if(i.collection)i.minimumInputLength=0,i.placeholder=" ",i.data=function(e){var r=p(e),t=[];return(e.currentUserInfo||[]).forEach(function(r){e.collection.get(r[a.idProperty])||t.push({id:r[a.idProperty],text:r.label,user:r})}),e.collection.forEach(function(e){t.push(s(e.toJSON(),r))}),t.sort(f),t}(i);else{var y=i.rqlQueryProvider?i.rqlQueryProvider:d,g=i.userFilter?i.userFilter:null;v.ajax={cache:!0,quietMillis:300,url:function(e){return"/users?"+y(r,e,i)},results:function(e,r,t){var n=[c(),l()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(t.term.toLowerCase())}).concat(u(e.collection||[]));return g&&(n=n.filter(g)),{results:n.map(function(e){return s(e,h,t)}).sort(f)}}}}if(t.select2(e.assign(v,i)),i.collection){var D=t.data("select2"),I=D.destroy;D.destroy=function(){i.collection.off(null,null,t),I.apply(D,arguments)},i.collection.once("reset add change remove",function(){m(t,i)})}var x=t.val(),b=l(),N=i.currentUserInfo;if(N)Array.isArray(N)?t.select2("data",N.map(function(e){return{id:e.id,text:e.label,user:e}})):t.select2("data",{id:N.id,text:N.label,user:N});else if(x===b.id)t.select2("data",b);else if("$SYSTEM"===x)t.select2("data",c());else if(x&&i.view){i.view.ajax({type:"GET",url:"/users?_id=in=("+x+")"}).done(function(e){if(e.collection&&e.collection.length){var r=e.collection.map(function(e){return s(e,h)});t.select2("data",i.multiple?r:r[0]),i.onDataLoaded&&i.onDataLoaded()}})}return t}return m.defaultRqlQueryProvider=d,m.filterDuplicates=u,m.transliterate=function(e){return t(e.toUpperCase()).replace(/[^A-Z0-9]+/g,"")},m.getUserInfo=function(e){var r=e.select2("data"),t=e.data("select2"),n=a.getInfo.decorators.concat(t&&t.opts.userInfoDecorators||[]);if(Array.isArray(r))return r.map(function(e){var r={},t=e.user||{};return r[a.idProperty]=e.id,r.label=e.text,n.forEach(function(e){e(r,t)}),r});if(r){var i={},o=r.user||{};return i[a.idProperty]=r.id,i.label=r.text,n.forEach(function(e){e(i,o)}),i}return null},m});