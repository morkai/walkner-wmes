// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","h5.rql/index","app/i18n","app/user"],function(e,r,t,n){"use strict";function a(e,r,t){return e.personellId&&(r+=" ("+e.personellId+")"),r}function i(e,r,t){if(e.id&&e.text)return e;var n=e.lastName&&e.firstName?e.lastName+" "+e.firstName:e.name||e.login||e._id;return{id:e._id,text:(r||a)(e,n,t),user:e}}function l(){return{id:"$SYSTEM",text:t("users","select2:users:system"),user:null}}function u(){var e=n.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function o(e){return e.toUpperCase().replace(m,function(e){return f[e]}).replace(/[^A-Z]+/g,"")}function s(r){var t={};return e.forEach(r,function(e){var r=t[e.searchName];return r?void("PHILIPS"===r||r.email&&!e.email||(t[e.searchName]=e)):void(t[e.searchName]=e)}),e.values(t)}function c(e,r){r=r.trim();var t=/^[0-9]+$/.test(r)?"personellId":"searchName";"searchName"===t&&(r=o(r));var n={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[t,"^"+r]}]}};return n.sort[t]=1,e.Query.fromObject(n)}function d(n,a){a||(a={});var o=a.rqlQueryProvider?a.rqlQueryProvider:c,d=a.userFilter?a.userFilter:null;n.select2(e.extend({openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:t("users","select2:placeholder"),ajax:{cache:!0,quietMillis:300,url:function(e){return"/users?"+o(r,e)},results:function(e,r,t){var n=[l(),u()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(t.term.toLowerCase())}),o=n.concat(s(e.collection||[]));return d&&(o=o.filter(d)),{results:o.map(function(e){return i(e,a.textFormatter,t)}).sort(function(e,r){return e.text.localeCompare(r.text)})}}}},a));var f=n.val(),m=u();if(f===m.id)n.select2("data",m);else if("$SYSTEM"===f)n.select2("data",l());else if(f&&a.view){var p=a.view.ajax({type:"GET",url:"/users?_id=in=("+f+")"});p.done(function(e){if(e.collection&&e.collection.length){var r=e.collection.map(function(e){return i(e,a.textFormatter)});n.select2("data",a.multiple?r:r[0]),a.onDataLoaded&&a.onDataLoaded()}})}return n}var f={"Ę":"E","Ó":"O","Ą":"A","Ś":"S","Ł":"L","Ż":"Z","Ź":"Z","Ć":"C","Ń":"N"},m=new RegExp(Object.keys(f).join("|"),"g");return d.defaultRqlQueryProvider=c,d.transliterate=o,d});