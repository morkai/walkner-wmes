// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","h5.rql/index","app/i18n","app/user"],function(e,t,r,n){"use strict";function l(e,t){return e.personellId&&(t+=" ("+e.personellId+")"),t}function i(e,t){if(e.id&&e.text)return e;var r=e.lastName&&e.firstName?e.lastName+" "+e.firstName:e.name||e.login||e._id;return{id:e._id,text:(t||l)(e,r),user:e}}function a(){return{id:"$SYSTEM",text:r("users","select2:users:system"),user:null}}function o(){var e=n.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function s(e,t){t=t.trim();var r=/^[0-9]+$/.test(t)?"personellId":"lastName",n={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[r,"^"+t,"i"]}]}};return n.sort[r]=1,e.Query.fromObject(n)}function u(n,l){l||(l={});var u=l.rqlQueryProvider?l.rqlQueryProvider:s,c=l.userFilter?l.userFilter:null;n.select2(e.extend({openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:r("users","select2:placeholder"),ajax:{cache:!0,quietMillis:300,url:function(e){return"/users?"+u(t,e)},results:function(e,t,r){var n=[a(),o()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(r.term.toLowerCase())}),s=n.concat(e.collection||[]);return c&&(s=s.filter(c)),{results:s.map(function(e){return i(e,l.textFormatter)}).sort(function(e,t){return e.text.localeCompare(t.text)})}}}},l));var d=n.val(),f=o();if(d===f.id)n.select2("data",f);else if("$SYSTEM"===d)n.select2("data",a());else if(d&&l.view){var m=l.view.ajax({type:"GET",url:"/users?_id="+d});m.done(function(e){e.collection&&e.collection.length&&(n.select2("data",i(e.collection[0],l.textFormatter)),l.onDataLoaded&&l.onDataLoaded())})}return n}return u.defaultRqlQueryProvider=s,u});