// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/user"],function(e,t,n){"use strict";return function(r,l){return r.select2(e.extend({openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:t("users","select2:placeholder"),ajax:{cache:!0,quietMillis:300,url:function(e){e=e.trim();var t=/^[0-9]+$/.test(e)?"personellId":"lastName";return e=encodeURIComponent("^"+e),"/users?select(personellId,lastName,firstName,login)&sort("+t+")&limit(20)&regex("+t+","+e+",i)"},results:function(e,r,s){var o=n.getRootUserData(),i=[{_id:"$SYSTEM",text:t("users","select2:users:system"),name:t("users","select2:users:system"),login:null,personellId:"-"},{_id:o._id,text:o.name||o.login,name:o.name||o.login,login:o.login,personellId:"-"}].filter(function(e){return-1!==e.text.toLowerCase().indexOf(s.term.toLowerCase())}),a=i.concat(e.collection||[]);return l&&l.userFilter&&(a=a.filter(l.userFilter)),{results:a.map(function(e){var t=e.lastName&&e.firstName?e.lastName+" "+e.firstName:e.name||e.login||e._id,n=t;return e.personellId&&(n+=" ("+e.personellId+")"),{id:e._id,text:n,name:t,login:e.login,personellId:e.personellId||"-"}}).sort(function(e,t){return e.text.localeCompare(t.text)})}}}},l))}});