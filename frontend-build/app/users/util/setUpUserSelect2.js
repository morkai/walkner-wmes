define(["underscore","h5.rql/index","app/core/util/transliterate","app/i18n","app/user","app/data/companies","app/data/loadedModules"],function(e,r,t,a,n,o,s){"use strict";function i(r){if(e.isEmpty(r.description))return r.header;var t='<div class="select2-result-with-description">';return t+="<h3>"+r.header+"</h3>",t+="<p>"+r.description+"</p>",t+="</div>"}function c(r,t,a){if(r.id&&r.text)return r;r.name=r.lastName||r.firstName?(r.lastName+" "+r.firstName).trim():r.name||r.login||r._id;var n=t(r,r.name,a),i=e.escape(n),c="";if(r.duplicate){r.personnelId&&(i+=" ("+e.escape(r.personnelId)+")"),r.syncData.jobTitle&&(c=e.escape(r.syncData.jobTitle));var l=o.get(r.company);l?l=l.get("shortName"):r.syncData.company&&(l=r.syncData.company),l&&(c&&(c+=" @ "),c+=e.escape(l));var u="",d="";if(s.isLoaded("wmes-osh")&&r.oshWorkplace){var p=require("app/wmes-osh-common/dictionaries"),f=p.workplaces.get(r.oshWorkplace),m=p.departments.get(r.oshDepartment);f&&(u=f.getLabel({short:!0}),m&&(d=m.getLabel({short:!0})))}!u&&r.syncData.workplace&&(u=r.syncData.workplace),!d&&r.syncData.department&&(d=r.syncData.department),u&&(c&&(c+="<br>"),c+=e.escape(u)),d&&(u?c+=" \\ ":c&&(c+="<br>"),c+=e.escape(d))}return r.active||(i="<del>"+i+"</del>"),{id:r._id,text:n,header:i,description:c,user:r}}function l(){return{id:"$SYSTEM",text:a("users","select2:users:system"),user:null}}function u(){var e=n.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function d(r){var t={};r.forEach(function(e){t[e.searchName]||(t[e.searchName]=[]);var r=0;e.active||(r-=10),e.email&&(r+=1),e.mobile&&e.mobile.length&&(r+=1),e.privileges&&e.privileges.length&&(r+=1),e.personnelId&&(r+=1),e.syncData&&/PHILIPS|SIGNIFY/i.test(e.syncData.company)&&(r+=1),e.orgUnitId&&(r+=1),e.oshDepartment&&(r+=1),e.duplicate=!1,e.score=r,t[e.searchName].push(e)});var a=[];return e.values(t).forEach(function(e){e.forEach(function(r){r.duplicate=e.length>1,a.push(r)})}),a}function p(e,r,t){r=r.trim();var a=/^[0-9]+$/.test(r)?"personnelId":"searchName";"searchName"===a&&(r=h.transliterate(r));var n={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[a,"^"+r]}]}};return t.activeOnly&&n.selector.args.push({name:"eq",args:["active",!0]}),n.sort[a]=1,t.rqlQueryDecorator&&t.rqlQueryDecorator(n,r,t),e.Query.fromObject(n)}function f(e){return e.textFormatter||function(e,r,t,a){return!e&&r.personnelId&&(t+=" ("+r.personnelId+")"),t}.bind(null,!1!==e.noPersonnelId)}function m(e,r){var t=(e.user&&e.user.searchName||e.text).localeCompare(r.user&&r.user.searchName||r.text,void 0,{ignorePunctuation:!0,sensitivity:"base"});return 0===t&&(t=(r.user&&r.user.score||0)-(e.user&&e.user.score||0)),t}function h(t,o){if(!t.length)return t;o||(o={});var s=f(o),v={openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:a("users","select2:placeholder"),formatResult:i};if(o.collection)o.minimumInputLength=0,o.placeholder=" ",o.data=function(e){var r=f(e),t=[];return(e.currentUserInfo||[]).forEach(function(r){e.collection.get(r[n.idProperty])||t.push({id:r[n.idProperty],text:r.label,user:r})}),e.collection.forEach(function(e){t.push(c(e.toJSON(),r))}),t.sort(m),t}(o);else{var y=o.rqlQueryProvider?o.rqlQueryProvider:p,g=o.userFilter?o.userFilter:null;v.ajax={cache:!0,quietMillis:300,url:function(e){return"/users?"+y(r,e,o)},results:function(e,r,t){var a=[l(),u()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(t.term.toLowerCase())}).concat(d(e.collection||[]));return g&&(a=a.filter(g)),{results:a.map(function(e){return c(e,s,t)}).sort(m)}}}}if(t.select2(e.assign(v,o)),o.collection){var D=t.data("select2"),I=D.destroy;D.destroy=function(){o.collection.off(null,null,t),I.apply(D,arguments)},o.collection.once("reset add change remove",function(){h(t,o)})}var x=t.val(),b=u(),N=o.currentUserInfo;if(N)Array.isArray(N)?t.select2("data",N.map(function(e){return{id:e.id,text:e.label,user:e}})):t.select2("data",{id:N.id,text:N.label,user:N});else if(x===b.id)t.select2("data",b);else if("$SYSTEM"===x)t.select2("data",l());else if(x&&o.view){o.view.ajax({type:"GET",url:"/users?_id=in=("+x+")"}).done(function(e){if(e.collection&&e.collection.length){var r=e.collection.map(function(e){return c(e,s)});t.select2("data",o.multiple?r:r[0]),o.onDataLoaded&&o.onDataLoaded()}})}return t}return h.defaultRqlQueryProvider=p,h.filterDuplicates=d,h.transliterate=function(e){return t(e.toUpperCase()).replace(/[^A-Z0-9]+/g,"")},h.getUserInfo=function(e){var r=e.select2("data"),t=e.data("select2"),a=n.getInfo.decorators.concat(t&&t.opts.userInfoDecorators||[]);if(Array.isArray(r))return r.map(function(e){var r={},t=e.user||{};return r[n.idProperty]=e.id,r.label=e.text,a.forEach(function(e){e(r,t)}),r});if(r){var o={},s=r.user||{};return o[n.idProperty]=r.id,o.label=r.text,a.forEach(function(e){e(o,s)}),o}return null},h});