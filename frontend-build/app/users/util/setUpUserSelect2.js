define(["require","underscore","h5.rql/index","app/core/util/transliterate","app/i18n","app/user","app/data/companies","app/data/loadedModules"],function(e,r,t,a,n,o,s,i){"use strict";function c(e){if(r.isEmpty(e.description))return e.header;var t='<div class="select2-result-with-description">';return t+="<h3>"+e.header+"</h3>",t+="<p>"+e.description+"</p>",t+="</div>"}function l(t,a,n){if(t.id&&t.text)return t;t.name=t.lastName||t.firstName?(t.lastName+" "+t.firstName).trim():t.name||t.login||t._id;var o=a?a(t,t.name,n):t.name,c=r.escape(o),l="";if(t.duplicate){t.personnelId&&(c+=" ("+r.escape(t.personnelId)+")"),t.syncData.jobTitle&&(l=r.escape(t.syncData.jobTitle));var u=s.get(t.company);u?u=u.get("shortName"):t.syncData.company&&(u=t.syncData.company),u&&(l&&(l+=" @ "),l+=r.escape(u));var d="",p="";if(i.isLoaded("wmes-osh")&&t.oshWorkplace){var f=e("app/wmes-osh-common/dictionaries"),m=f.workplaces.get(t.oshWorkplace),h=f.departments.get(t.oshDepartment);m&&(d=m.getLabel({long:!1}),h&&(p=h.getLabel({long:!1})))}!d&&t.syncData.workplace&&(d=t.syncData.workplace),!p&&t.syncData.department&&(p=t.syncData.department),d&&(l&&(l+="<br>"),l+=r.escape(d)),p&&(d?l+=" \\ ":l&&(l+="<br>"),l+=r.escape(p))}return t.active||(c="<del>"+c+"</del>"),{id:t._id,text:o,header:c,description:l,user:t}}function u(){return{id:"$SYSTEM",text:n("users","select2:users:system"),user:null}}function d(){var e=o.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function p(e){var t={};e.forEach(function(e){t[e.searchName]||(t[e.searchName]=[]);var r=0;e.active||(r-=10),e.email&&(r+=1),e.mobile&&e.mobile.length&&(r+=1),e.privileges&&e.privileges.length&&(r+=1),e.personnelId&&(r+=1),e.syncData&&/PHILIPS|SIGNIFY/i.test(e.syncData.company)&&(r+=1),e.orgUnitId&&(r+=1),e.oshDepartment&&(r+=1),e.duplicate=!1,e.score=r,t[e.searchName].push(e)});var a=[];return r.values(t).forEach(function(e){e.forEach(function(r){r.duplicate=e.length>1,a.push(r)})}),a}function f(e,r,t){r=r.trim();var a=/^[0-9]+$/.test(r)?"personnelId":"searchName";"searchName"===a&&(r=v.transliterate(r));var n={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[a,"^"+r]}]}};return t.activeOnly&&n.selector.args.push({name:"eq",args:["active",!0]}),n.sort[a]=1,t.rqlQueryDecorator&&t.rqlQueryDecorator(n,r,t),e.Query.fromObject(n)}function m(e){return e.textFormatter||function(e,r,t,a){return!e&&r.personnelId&&(t+=" ("+r.personnelId+")"),t}.bind(null,!1!==e.noPersonnelId)}function h(e,r){var t=(e.user&&e.user.searchName||e.text).localeCompare(r.user&&r.user.searchName||r.text,void 0,{ignorePunctuation:!0,sensitivity:"base"});return 0===t&&(t=(r.user&&r.user.score||0)-(e.user&&e.user.score||0)),t}function v(e,a){if(!e.length)return e;a||(a={});var s=m(a),i={openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:n("users","select2:placeholder"),formatResult:c};if(a.collection)a.minimumInputLength=0,a.placeholder=" ",a.data=function(e){var r=m(e),t=[];return(e.currentUserInfo||[]).forEach(function(r){e.collection.get(r[o.idProperty])||t.push({id:r[o.idProperty],text:r.label,user:r})}),e.collection.forEach(function(e){t.push(l(e.toJSON(),r))}),t.sort(h),t}(a);else{var y=a.rqlQueryProvider?a.rqlQueryProvider:f,g=a.userFilter?a.userFilter:null;i.ajax={cache:!0,quietMillis:300,url:function(e){return"/users?"+y(t,e,a)},results:function(e,r,t){var a=[u(),d()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(t.term.toLowerCase())}).concat(p(e.collection||[]));return g&&(a=a.filter(g)),{results:a.map(function(e){return l(e,s,t)}).sort(h)}}}}if(e.select2(r.assign(i,a)),a.collection){var D=e.data("select2"),I=D.destroy;D.destroy=function(){a.collection.off(null,null,e),I.apply(D,arguments)},a.collection.once("reset add change remove",function(){v(e,a)})}var x=e.val(),b=d(),N=a.currentUserInfo;if(N)Array.isArray(N)?e.select2("data",N.map(function(e){return{id:e.id,text:e.label,user:e}})):e.select2("data",{id:N.id,text:N.label,user:N});else if(x===b.id)e.select2("data",b);else if("$SYSTEM"===x)e.select2("data",u());else if(x&&a.view){a.view.ajax({type:"GET",url:"/users?_id=in=("+x+")"}).done(function(r){if(r.collection&&r.collection.length){var t=r.collection.map(function(e){return l(e,s)});e.select2("data",a.multiple?t:t[0]),a.onDataLoaded&&a.onDataLoaded()}})}return e}return v.userToData=l,v.defaultRqlQueryProvider=f,v.filterDuplicates=p,v.transliterate=function(e){return a(e.toUpperCase()).replace(/[^A-Z0-9]+/g,"")},v.getUserInfo=function(e){var r=e.select2("data"),t=e.data("select2"),a=o.getInfo.decorators.concat(t&&t.opts.userInfoDecorators||[]);if(Array.isArray(r))return r.map(function(e){var r={},t=e.user||{};return r[o.idProperty]=e.id,r.label=e.text,a.forEach(function(e){e(r,t)}),r});if(r){var n={},s=r.user||{};return n[o.idProperty]=r.id,n.label=r.text,a.forEach(function(e){e(n,s)}),n}return null},v});