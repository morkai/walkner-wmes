define(["underscore","h5.rql/index","app/core/util/transliterate","app/i18n","app/user"],function(e,t,r,n,a){"use strict";function i(e,t,r,n){return!e&&t.personellId&&(r+=" ("+t.personellId+")"),r}function l(e,t,r){if(e.id&&e.text)return e;var n=e.lastName&&e.firstName?e.lastName+" "+e.firstName:e.name||e.login||e._id;return{id:e._id,text:t(e,n,r),user:e}}function o(){return{id:"$SYSTEM",text:n("users","select2:users:system"),user:null}}function s(){var e=a.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function u(e,t,r){t=t.trim();var n=/^[0-9]+$/.test(t)?"personellId":"searchName";"searchName"===n&&(t=c.transliterate(t));var a={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[n,"^"+t]}]}};return r.activeOnly&&a.selector.args.push({name:"eq",args:["active",!0]}),a.sort[n]=1,e.Query.fromObject(a)}function c(r,a){a||(a={});var c=a.rqlQueryProvider?a.rqlQueryProvider:u,d=a.userFilter?a.userFilter:null;r.select2(e.assign({openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:n("users","select2:placeholder"),ajax:{cache:!0,quietMillis:300,url:function(e){return"/users?"+c(t,e,a)},results:function(t,r,n){var u=[o(),s()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(n.term.toLowerCase())}).concat(function(t){var r={};return e.forEach(t,function(e){var t=e.searchName,n=r[t];!n||!1===n.active&&!0===e.active?r[t]=e:!0===n.active&&!1===e.active||(n.email||!e.email?n.email&&!e.email||"PHILIPS"!==n.company&&"PHILIPS"===e.company&&(r[t]=e):r[t]=e)}),e.values(r)}(t.collection||[]));d&&(u=u.filter(d));var c=a.textFormatter||i.bind(null,!!a.noPersonnelId);return{results:u.map(function(e){return l(e,c,n)}).sort(function(e,t){return e.text.localeCompare(t.text)})}}}},a));var f=r.val(),m=s();if(f===m.id)r.select2("data",m);else if("$SYSTEM"===f)r.select2("data",o());else if(f&&a.view){a.view.ajax({type:"GET",url:"/users?_id=in=("+f+")"}).done(function(e){if(e.collection&&e.collection.length){var t=a.textFormatter||i.bind(null,!!a.noPersonnelId),n=e.collection.map(function(e){return l(e,t)});r.select2("data",a.multiple?n:n[0]),a.onDataLoaded&&a.onDataLoaded()}})}return r}return c.defaultRqlQueryProvider=u,c.transliterate=function(e){return r(e.toUpperCase()).replace(/[^A-Z]+/g,"")},c});