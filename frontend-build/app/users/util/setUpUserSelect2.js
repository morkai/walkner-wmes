define(["underscore","h5.rql/index","app/core/util/transliterate","app/i18n","app/user"],function(e,r,t,n,a){"use strict";function i(e,r,t,n){return!e&&r.personellId&&(t+=" ("+r.personellId+")"),t}function l(e,r,t){if(e.id&&e.text)return e;var n=e.lastName&&e.firstName?e.lastName+" "+e.firstName:e.name||e.login||e._id;return{id:e._id,text:r(e,n,t),user:e}}function u(){return{id:"$SYSTEM",text:n("users","select2:users:system"),user:null}}function o(){var e=a.getRootUserData();return{id:e._id,text:e.name||e.login,user:e}}function s(r){var t={};return e.forEach(r,function(e){var r=e.searchName,n=t[r];n&&(!1!==n.active||!0!==e.active)?!0===n.active&&!1===e.active||(n.email||!e.email?n.email&&!e.email||"PHILIPS"!==n.company&&"PHILIPS"===e.company&&(t[r]=e):t[r]=e):t[r]=e}),e.values(t)}function c(e,r,t){r=r.trim();var n=/^[0-9]+$/.test(r)?"personellId":"searchName";"searchName"===n&&(r=d.transliterate(r));var a={fields:{},sort:{},limit:20,skip:0,selector:{name:"and",args:[{name:"regex",args:[n,"^"+r]}]}};return t.activeOnly&&a.selector.args.push({name:"eq",args:["active",!0]}),a.sort[n]=1,e.Query.fromObject(a)}function d(t,a){a||(a={});var d=a.rqlQueryProvider?a.rqlQueryProvider:c,f=a.userFilter?a.userFilter:null;t.select2(e.assign({openOnEnter:null,allowClear:!0,minimumInputLength:3,placeholder:n("users","select2:placeholder"),ajax:{cache:!0,quietMillis:300,url:function(e){return"/users?"+d(r,e,a)},results:function(e,r,t){var n=[u(),o()].filter(function(e){return-1!==e.text.toLowerCase().indexOf(t.term.toLowerCase())}).concat(s(e.collection||[]));f&&(n=n.filter(f));var c=a.textFormatter||i.bind(null,!!a.noPersonnelId);return{results:n.map(function(e){return l(e,c,t)}).sort(function(e,r){return e.text.localeCompare(r.text)})}}}},a));var m=t.val(),p=o();if(m===p.id)t.select2("data",p);else if("$SYSTEM"===m)t.select2("data",u());else if(m&&a.view){a.view.ajax({type:"GET",url:"/users?_id=in=("+m+")"}).done(function(e){if(e.collection&&e.collection.length){var r=a.textFormatter||i.bind(null,!!a.noPersonnelId),n=e.collection.map(function(e){return l(e,r)});t.select2("data",a.multiple?n:n[0]),a.onDataLoaded&&a.onDataLoaded()}})}return t}return d.defaultRqlQueryProvider=c,d.filterDuplicates=s,d.transliterate=function(e){return t(e.toUpperCase()).replace(/[^A-Z0-9]+/g,"")},d.getUserInfo=function(e){var r=e.select2("data");if(Array.isArray(r))return r.map(function(e){var r={};return r[a.idProperty]=e.id,r.label=e.text,r});if(r){var t={};return t[a.idProperty]=r.id,t.label=r.text,t}return null},d});