define(["jquery","app/i18n","app/viewport","app/core/util/bindLoadingMessage","app/core/util/pageActions","app/core/View","../UserCollection","../views/UserListView","../views/UserFilterView","app/core/templates/listPage"],function(e,i,s,t,n,o,c,l,r,a){"use strict";return o.extend({template:a,layoutName:"page",pageId:"collection",remoteTopics:{"users.synced":"onSynced","users.syncFailed":"onSyncFailed"},breadcrumbs:[i.bound("users","BREADCRUMB:browse")],actions:function(){var i=this;return[n.add(this.collection)].concat({label:i.t("PAGE_ACTION:sync"),icon:"refresh",privileges:"USERS:MANAGE",callback:function(){return i.$syncAction=e("a",this),i.syncUsers(),!1}},{label:i.t("PAGE_ACTION:settings"),icon:"cogs",privileges:"USERS:MANAGE",href:"#users;settings"})},initialize:function(){this.$syncAction=null,this.defineModels(),this.defineViews(),this.setView(".filter-container",this.filterView),this.setView(".list-container",this.listView)},defineModels:function(){this.collection=t(new c(null,{rqlQuery:this.options.rql}),this)},defineViews:function(){this.listView=new l({collection:this.collection}),this.filterView=new r({model:this.collection}),this.listenTo(this.filterView,"filterChanged",this.refreshList)},load:function(e){return e(this.collection.fetch({reset:!0}))},refreshList:function(e){this.collection.rqlQuery=e,this.listView.refreshCollectionNow(),this.broker.publish("router.navigate",{url:this.collection.genClientUrl()+"?"+e,trigger:!1,replace:!0})},syncUsers:function(){var e=this,i=e.$syncAction;i.hasClass("disabled")||(i.addClass("disabled"),i.find("i").removeClass("fa-refresh").addClass("fa-spinner fa-spin"),this.socket.emit("users.sync",function(i){i&&(console.error(i),s.msg.show({type:"error",text:e.t("MSG:SYNC_FAILURE")}),e.unlockSync())}))},unlockSync:function(){this.$syncAction.removeClass("disabled"),this.$syncAction.find("i").removeClass("fa-spinner fa-spin").addClass("fa-refresh"),this.$syncAction=null},onSynced:function(){null!==this.$syncAction&&(s.msg.show({type:"success",text:this.t("MSG:SYNCED"),time:2500}),this.unlockSync())},onSyncFailed:function(){null!==this.$syncAction&&(s.msg.show({type:"error",text:this.t("MSG:SYNC_FAILURE"),time:5e3}),this.unlockSync())}})});