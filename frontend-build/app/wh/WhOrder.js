define(["app/i18n","app/time","app/user","app/core/Model","app/core/templates/userInfo","app/planning/util/shift","app/planning/templates/orderStatusIcons"],function(t,s,e,i,n,a,r){"use strict";var u={pending:"default",started:"info",finished:"success",problem:"danger",cancelled:"warning"},l={pending:"fa-question",picklist:"fa-file-text-o",pickup:"fa-shopping-cart",problem:"fa-thumbs-down",finished:"fa-thumbs-up"},o={null:"wh-problems-pending",true:"wh-problems-success",false:"wh-problems-failure",pending:"wh-problems-pending",picklist:"wh-problems-progress",pickup:"wh-problems-progress",problem:"wh-problems-failure",finished:"wh-problems-success"},c={pending:"fa-question",started:"fa-truck",finished:"fa-thumbs-up"},p={fmx:0,kitter:1,packer:2};return i.extend({urlRoot:"/old/wh/orders",topicPrefix:"old.wh.orders",privilegePrefix:"WH",nlsDomain:"wh",serialize:function(t,e,i){var n=this.toJSON(),o=t&&t.orders.get(n.order)||null,p=t&&t.sapOrders.get(n.order)||null,f=Date.parse(n.startTime),m=Date.parse(n.finishTime);return n.no=e+1,n.shift=a.getShiftNo(f),n.qty=n.qty.toLocaleString(),o?(n.mrp=o.get("mrp"),n.nc12=o.get("nc12"),n.name=o.get("name"),n.qtyTodo=o.get("quantityTodo").toLocaleString(),n.planStatus=o.getStatus(),n.planStatusIcons=r(t,o.id)):(n.mrp="?",n.nc12="?",n.name="?",n.qtyTodo="0",n.planStatus="unplanned",n.planStatusIcons="?"),n.startDate=s.utc.format(f,"LL"),n.finishDate=s.utc.format(m,"LL"),n.startTimeMs=f,n.startTime=s.utc.format(f,"HH:mm:ss"),n.startTimeShort=s.utc.format(f,"H:mm"),n.finishTime=s.utc.format(m,"HH:mm:ss"),n.comment=p?p.getCommentWithIcon():"",n.comments=p?p.get("comments"):[],n.rowClassName=u[n.status],n.funcIcons={fmx:l[n.funcs[0].status],kitter:l[n.funcs[1].status],packer:l[n.funcs[2].status]},n.distIcons={dist:c[n.distStatus],fifo:c[n.fifoStatus],pack:c[n.packStatus]},n.psStatus=t&&t.sapOrders.getPsStatus(n.order)||"unknown",n.hidden=!i||f<i.startTime.from||f>=i.startTime.to||i.whStatuses.length>0&&-1===i.whStatuses.indexOf(n.status)||i.psStatuses.length>0&&-1===i.psStatuses.indexOf(n.psStatus),n.hidden&&(n.rowClassName+=" hidden"),n},serializeSet:function(t,s,i){var n=this.serialize(t,s,this.collection?this.collection.getFilters(t):{startTime:{},whStatuses:[],psStatuses:[]}),a=e.isAllowedTo("WH:MANAGE"),r=this.getUserFunc(i),u=!!r;return n.clickable={picklistDone:a||u&&r._id===n.picklistFunc&&null===n.picklistDone},n.funcs.forEach(function(t){n.clickable[t._id]={picklist:a&&n.picklistDone||n.picklistDone&&u&&r._id===t._id&&"picklist"===t.status,pickup:a&&null!==n.picklistDone&&"require"===t.picklist||n.picklistDone&&u&&r._id===t._id&&"pickup"===t.status}}),n.clickable.printLabels=a||u,n},serializeProblemFunc:function(s){var i,a;return"lp10"===s?(a=this.getFunc(this.get("picklistFunc")),i={label:t("wh","prop:picklist"),className:o[this.get("picklistDone")],status:t("wh","status:picklistDone:"+this.get("picklistDone")),user:a&&a.user?n({userInfo:a.user,noIp:!0,clickable:!1}):"",carts:"",problemArea:"",problem:this.get("problem")}):(a=this.getFunc(s),i={label:t("wh","func:"+s),className:o[a.status],status:t("wh","status:"+a.status),user:a.user?n({userInfo:a.user,noIp:!0,clickable:!1}):"",carts:a.carts.join(", "),problemArea:a.problemArea,problem:a.comment}),i.solvable="problem"===this.get("status")&&"wh-problems-failure"===i.className&&e.isAllowedTo("WH:SOLVER","WH:MANAGE"),i},update:function(t){this.set(t)},getFunc:function(t){return this.attributes.funcs[p[t]]||null},getUserFunc:function(t){if(!t)return null;var s=this.attributes.funcs[p[t.func]];return s.user&&s.user.id===t._id?s:null}},{FUNC_TO_INDEX:p,finalizeOrder:function(t){var s=!1===t.picklistDone,e=!0;return t.funcs.forEach(function(t){"problem"===t.status&&(s=!0),"finished"!==t.status&&(e=!1)}),s?(t.status="problem",t.finishedAt=new Date):e?(t.status="finished",t.finishedAt=new Date):(t.status="started",t.finishedAt=null),t}})});