define(["app/i18n","app/time","app/user","app/core/Model","app/core/templates/userInfo","app/planning/util/shift","app/planning/templates/orderStatusIcons"],function(t,e,s,i,n,r,a){"use strict";var u={pending:"default",started:"info",finished:"success",problem:"danger",cancelled:"warning"},l={pending:"fa-question",picklist:"fa-file-text-o",pickup:"fa-shopping-cart",problem:"fa-thumbs-down",finished:"fa-thumbs-up"},o={pending:"wh-problems-pending",picklist:"wh-problems-progress",pickup:"wh-problems-progress",problem:"wh-problems-failure",finished:"wh-problems-success"},c={fmx:0,kitter:1,packer:2};return i.extend({urlRoot:"/wh/orders",topicPrefix:"wh.orders",privilegePrefix:"WH",nlsDomain:"wh",serialize:function(t,s){var i=this.toJSON(),n=t.orders.get(i.order),o=t.sapOrders.get(i.order),c=Date.parse(i.startTime),p=Date.parse(i.finishTime);return i.no=s+1,i.shift=r.getShiftNo(c),i.qty=i.qty.toLocaleString(),n?(i.mrp=n.get("mrp"),i.nc12=n.get("nc12"),i.name=n.get("name"),i.qtyTodo=n.get("quantityTodo").toLocaleString(),i.planStatus=n.getStatus(),i.planStatusIcons=a(t,n.id)):(i.mrp="?",i.nc12="?",i.name="?",i.qtyTodo="0",i.planStatus="unplanned",i.planStatusIcons="?"),i.startDate=e.utc.format(c,"LL"),i.finishDate=e.utc.format(p,"LL"),i.startTime=e.utc.format(c,"HH:mm:ss"),i.finishTime=e.utc.format(p,"HH:mm:ss"),i.comment=o?o.getCommentWithIcon():"",i.comments=o?o.get("comments"):[],i.rowClassName=u[i.status],i.funcIcons={fmx:l[i.funcs[0].status],kitter:l[i.funcs[1].status],packer:l[i.funcs[2].status]},i},serializeSet:function(t,e,i){var n=this.serialize(t,e),r=s.isAllowedTo("WH:MANAGE"),a=this.getUserFunc(i),u=!!a;return n.clickable={picklistDone:r||u&&a._id===n.picklistFunc&&null===n.picklistDone},n.funcs.forEach(function(t){n.clickable[t._id]={picklist:r&&n.picklistDone||n.picklistDone&&u&&a._id===t._id&&"picklist"===t.status,pickup:r&&null!==n.picklistDone&&"require"===t.picklist||n.picklistDone&&u&&a._id===t._id&&"pickup"===t.status}}),n.clickable.printLabels=r||u,n},serializeProblemFunc:function(e){var i;if("lp10"===e)i={label:t("wh","prop:picklist"),className:this.get("picklistDone")?"wh-problems-success":"wh-problems-failure",status:t("wh","status:picklistDone:"+this.get("picklistDone")),user:n({userInfo:this.getFunc(this.get("picklistFunc")).user}),carts:"",problemArea:"",problem:this.get("problem")};else{var r=this.getFunc(e);i={label:t("wh","func:"+e),className:o[r.status],status:t("wh","status:"+r.status),user:r.user?n({userInfo:r.user}):"",carts:r.carts.join(", "),problemArea:r.problemArea,problem:r.comment}}return i.solvable="problem"===this.get("status")&&"wh-problems-failure"===i.className&&s.isAllowedTo("WH:SOLVER","WH:MANAGE"),i},update:function(t){this.set(t)},getFunc:function(t){return this.attributes.funcs[c[t]]||null},getUserFunc:function(t){if(!t)return null;var e=this.attributes.funcs[c[t.func]];return e.user&&e.user.id===t._id?e:null}},{FUNC_TO_INDEX:c,finalizeOrder:function(t){var e=!1===t.picklistDone,s=!0;return t.funcs.forEach(function(t){"problem"===t.status&&(e=!0),"finished"!==t.status&&(s=!1)}),e?(t.status="problem",t.finishedAt=new Date):s?(t.status="finished",t.finishedAt=new Date):(t.status="started",t.finishedAt=null),t}})});