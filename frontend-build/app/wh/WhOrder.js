define(["app/i18n","app/time","app/user","app/core/Model","app/core/templates/userInfo","app/planning/util/shift","app/planning/templates/orderStatusIcons"],function(t,s,e,i,r,n,a){"use strict";var u={pending:"default",started:"info",finished:"success",problem:"danger",cancelled:"warning"},o={pending:"fa-question",picklist:"fa-file-text-o",pickup:"fa-shopping-cart",problem:"fa-thumbs-down",finished:"fa-thumbs-up"},c={pending:"wh-problems-pending",progress:"wh-problems-progress",picklist:"wh-problems-progress",pickup:"wh-problems-progress",problem:"wh-problems-failure",failure:"wh-problems-failure",success:"wh-problems-success",finished:"wh-problems-success"},l={pending:"fa-question",started:"fa-truck",finished:"fa-thumbs-up"},p={pending:"fa-question",progress:"fa-spinner",success:"fa-thumbs-up",failure:"fa-thumbs-down"},m={fmx:0,kitter:1,packer:2};return i.extend({urlRoot:"/old/wh/orders",topicPrefix:"old.wh.orders",privilegePrefix:"WH",nlsDomain:"wh",serialize:function(t,e,i){var r=this.toJSON(),c=t&&t.orders.get(r.order)||null,m=t&&t.sapOrders.get(r.order)||null,f=Date.parse(r.startTime),d=Date.parse(r.finishTime);return r.no=e+1,r.shift=n.getShiftNo(f),r.qty=r.qty.toLocaleString(),c?(r.mrp=c.get("mrp"),r.nc12=c.get("nc12"),r.name=c.get("name"),r.qtyTodo=c.get("quantityTodo").toLocaleString(),r.planStatus=c.getStatus(),r.planStatusIcons=a(t,c.id)):(r.mrp="?",r.nc12="?",r.name="?",r.qtyTodo="0",r.planStatus="unplanned",r.planStatusIcons="?"),r.startDate=s.utc.format(f,"LL"),r.finishDate=s.utc.format(d,"LL"),r.startTimeMs=f,r.startTime=s.utc.format(f,"HH:mm:ss"),r.startTimeShort=s.utc.format(f,"H:mm"),r.finishTime=s.utc.format(d,"HH:mm:ss"),r.comment=m?m.getCommentWithIcon():"",r.comments=m?m.get("comments"):[],r.rowClassName=u[r.status],r.funcIcons={fmx:o[r.funcs[0].status],kitter:o[r.funcs[1].status],packer:o[r.funcs[2].status]},r.distIcons={dist:l[r.distStatus],fifo:l[r.fifoStatus],pack:l[r.packStatus]},r.picklistDoneIcon=p[r.picklistDone],r.psStatus=t&&t.sapOrders.getPsStatus(r.order)||"unknown",r.hidden=!i||f<i.startTime.from||f>=i.startTime.to||i.whStatuses.length>0&&-1===i.whStatuses.indexOf(r.status)||i.psStatuses.length>0&&-1===i.psStatuses.indexOf(r.psStatus),r.hidden&&(r.rowClassName+=" hidden"),r},serializeSet:function(t,s,i){var r=this.serialize(t,s,this.collection?this.collection.getFilters(t):{startTime:{},whStatuses:[],psStatuses:[]}),n=e.isAllowedTo("WH:MANAGE"),a=this.getUserFunc(i),u=!!a,o="success"===r.picklistDone,c="pending"===this.get("fifoStatus");return r.clickable={picklistDone:c&&(n||u&&a._id===r.picklistFunc&&!o)},r.funcs.forEach(function(t){r.clickable[t._id]={picklist:c&&(n&&o||o&&u&&a._id===t._id&&"picklist"===t.status),pickup:c&&(n&&"require"===t.picklist||o&&u&&a._id===t._id&&"pickup"===t.status)}}),r.clickable.printLabels=n||u,r},serializeProblemFunc:function(t){var s,i;return"lp10"===t?(i=this.getFunc(this.get("picklistFunc")),s={label:this.t("prop:picklist"),className:c[this.get("picklistDone")],status:this.t("status:picklistDone:"+this.get("picklistDone")),user:i&&i.user?r({userInfo:i.user,noIp:!0,clickable:!1}):"",carts:"",problemArea:"",problem:this.get("problem")}):(i=this.getFunc(t),s={label:this.t("func:"+t),className:c[i.status],status:this.t("status:"+i.status),user:i.user?r({userInfo:i.user,noIp:!0,clickable:!1}):"",carts:i.carts.join(", "),problemArea:i.problemArea,problem:i.comment}),s.solvable="problem"===this.get("status")&&"wh-problems-failure"===s.className&&e.isAllowedTo("WH:SOLVER","WH:MANAGE"),s},update:function(t){this.set(t)},getFunc:function(t){return this.attributes.funcs[m[t]]||null},getUserFunc:function(t){if(!t)return null;var s=this.attributes.funcs[m[t.func]];return s.user&&s.user.id===t._id?s:null}},{FUNC_TO_INDEX:m})});