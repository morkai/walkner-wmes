define(["app/i18n","app/time","app/user","app/core/Model","app/core/templates/userInfo","app/planning/util/shift","app/planning/templates/orderStatusIcons"],function(s,t,e,i,r,n,a){"use strict";var l={pending:"default",started:"info",finished:"success",problem:"danger",cancelled:"warning"},c={pending:"fa-question",picklist:"fa-file-text-o",pickup:"fa-shopping-cart",problem:"fa-thumbs-down",finished:"fa-thumbs-up",ignored:"fa-times"},u={pending:"wh-problems-pending",progress:"wh-problems-progress",picklist:"wh-problems-progress",pickup:"wh-problems-progress",problem:"wh-problems-failure",failure:"wh-problems-failure",success:"wh-problems-success",finished:"wh-problems-success"},o={pending:"fa-question",started:"fa-truck",finished:"fa-thumbs-up",ignored:"fa-times"},p={pending:"fa-question",progress:"fa-spinner",success:"fa-thumbs-up",failure:"fa-thumbs-down"},m={fmx:0,kitter:1,platformer:2,packer:3,painter:4};return i.extend({urlRoot:"/old/wh/orders",topicPrefix:"old.wh.orders",privilegePrefix:"WH",nlsDomain:"wh",serialize:function(s,e,i){var r=this.toJSON(),u=s&&s.orders.get(r.order)||null,m=s&&s.sapOrders.get(r.order)||null,f=Date.parse(r.startTime),d=Date.parse(r.finishTime),h=Date.parse(r.problemAt);return r.no=e+1,r.shift=n.getShiftNo(f),r.qty=r.qty.toLocaleString(),u?(r.mrp=u.get("mrp"),r.nc12=u.get("nc12"),r.name=u.get("name"),r.qtyTodo=u.get("quantityTodo").toLocaleString(),r.planStatus=u.getStatus(),r.planStatusIcons=a(s,u.id)):(r.mrp="?",r.nc12="?",r.name="?",r.qtyTodo="0",r.planStatus="unplanned",r.planStatusIcons="?"),h?(r.problemDate=t.format(h,"LL"),r.problemTime=t.format(h,"HH:mm:ss")):(r.problemDate="",r.problemTime=""),r.startDate=t.utc.format(f,"LL"),r.finishDate=t.utc.format(d,"LL"),r.startTimeMs=f,r.startTime=t.utc.format(f,"HH:mm:ss"),r.startTimeShort=t.utc.format(f,"H:mm"),r.finishTime=t.utc.format(d,"HH:mm:ss"),r.comment=m?m.getCommentWithIcon():"",r.comments=m?m.get("comments"):[],r.rowClassName=l[r.status],r.funcIcons={},r.funcs.forEach(function(s){"ignore"===s.picklist?r.funcIcons[s._id]=c.ignored:"painter"!==s._id||"pickup"!==s.status||s.user?r.funcIcons[s._id]=c[s.status]:r.funcIcons[s._id]=c.pending}),r.distIcons={dist:o[r.distStatus],fifo:o[r.fifoStatus],pack:o[r.packStatus],psDist:"unknown"===r.psStatus?o.ignored:o[r.psDistStatus]},r.picklistDoneIcon=p[r.picklistDone],r.hidden=!i||f<i.startTime.from||f>=i.startTime.to||i.whStatuses.length>0&&!i.whStatuses.includes(r.status)||i.psStatuses.length>0&&!i.psStatuses.includes(r.psStatus)||i.distStatuses.length>0&&!i.distStatuses.includes(r.distStatus)||i.orders.length>0&&!i.orders.includes(r.order)||i.sets.length>0&&!i.sets.includes(r.set)||i.lines.length>0&&!r.lines.some(function(s){return i.lines.includes(s._id)})||i.mrps.length>0&&!i.mrps.includes(r.mrp),r.hidden&&(r.rowClassName+=" hidden"),r},getFilters:function(s){return this.collection?this.collection.getFilters(s):{startTime:{},whStatuses:[],psStatuses:[],distStatuses:[],orders:[],sets:[],lines:[],mrps:[]}},serializeSet:function(s,t,i){var r=this.serialize(t,s.i,this.getFilters(t)),n=e.isAllowedTo("WH:MANAGE"),a=e.isAllowedTo("WH:MANAGE:CARTS"),l=this.getUserFunc(i),c=!!l,u=c&&l._id===r.picklistFunc,o="success"===r.picklistDone,p=!s.delivered;r.visible={picklistDone:!0,funcs:{}},r.clickable={picklistDone:p&&(n||c&&l._id===r.picklistFunc&&!o)},r.funcs.forEach(function(s){var t=!!s.user,e=c&&l._id===s._id;(n||!c||e)&&(r.visible.funcs[s._id]=!0);var i=!t&&(u||n)&&o&&("pending"===s.status||"picklist"===s.status||"ignore"===s.picklist);r.clickable[s._id]={picklist:p&&(i||t&&n&&o||o&&c&&e&&"picklist"===s.status),pickup:p&&(t&&n&&"require"===s.picklist||t&&a&&"success"===s.pickup||o&&c&&e&&"pickup"===s.status)}}),r.visible.picklistDone=1!==Object.keys(r.visible.funcs).length||u;var m=this.getFunc("fmx"),f=this.getFunc("kitter"),d=this.getFunc("platformer");return"finished"===d.status&&"success"===d.pickup&&(r.clickable.fmx.picklist=!1,r.clickable.fmx.pickup=!1,r.clickable.kitter.picklist=!1,r.clickable.kitter.pickup=!1),r.clickable.platformer.picklist=!1,r.clickable.platformer.pickup=r.clickable.platformer.pickup&&"success"===m.pickup&&"problem"!==f.status&&"problem"!==d.status,r.clickable.painter.picklist=!1,r.clickable.printLabels=n||c&&"platformer"!==l._id&&"painter"!==l._id,r},serializeProblemFuncs:function(){var s={};return["lp10","fmx","kitter","platformer","packer","painter"].forEach(function(t){s[t]=this.serializeProblemFunc(t)},this),s},serializeProblemFunc:function(t){var i,n;("lp10"===t?(n=this.getFunc(this.get("picklistFunc")),i={label:s("wh","prop:picklist"),className:u[this.get("picklistDone")],status:s("wh","status:picklistDone:"+this.get("picklistDone")),user:n&&n.user?r({userInfo:n.user,noIp:!0,clickable:!1}):"",carts:"",problemArea:"",problem:this.get("problem"),solvable:!1}):(n=this.getFunc(t),i={label:s("wh","func:"+t),className:u[n.status],status:s("wh","status:"+n.status),user:n.user?r({userInfo:n.user,noIp:!0,clickable:!1}):"",carts:n.carts.join(", "),problemArea:n.problemArea,problem:n.comment,solvable:!1}),e.isAllowedTo("WH:SOLVER","WH:MANAGE"))&&("problem"===this.get("status")&&"wh-problems-failure"===i.className?i.solvable=!0:"wh-problems-progress"===i.className&&"platformer"===t&&(i.solvable=!0));return i},update:function(s){this.set(s)},getFunc:function(s){return this.attributes.funcs[m[s]]||null},getUserFunc:function(s){if(!s)return null;var t=this.attributes.funcs[m[s.func]];return t.user&&t.user.id===s._id?t:null},isDelivered:function(){var s=this.get("distStatus");return"started"===s||"finished"===s}},{FUNC_LIST:Object.keys(m),FUNC_TO_INDEX:m})});