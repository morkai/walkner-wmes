define(["app/i18n","app/time","app/user","app/core/Model","app/core/templates/userInfo","app/planning/util/shift","app/planning/templates/orderStatusIcons"],function(t,e,s,i,r,a,n){"use strict";var c={pending:"default",started:"info",finished:"success",problem:"danger",cancelled:"warning"},l={pending:"fa-question",picklist:"fa-file-text-o",pickup:"fa-shopping-cart",problem:"fa-thumbs-down",finished:"fa-thumbs-up",ignored:"fa-times"},o={pending:"wh-problems-pending",progress:"wh-problems-progress",picklist:"wh-problems-progress",pickup:"wh-problems-progress",problem:"wh-problems-failure",failure:"wh-problems-failure",success:"wh-problems-success",finished:"wh-problems-success"},u={pending:"fa-question",started:"fa-truck",finished:"fa-thumbs-up",ignored:"fa-times"},p={pending:"fa-question",progress:"fa-spinner",success:"fa-thumbs-up",failure:"fa-thumbs-down"},m={fmx:0,kitter:1,platformer:2,packer:3,painter:4};return i.extend({urlRoot:"/old/wh/orders",topicPrefix:"old.wh.orders",privilegePrefix:"WH",nlsDomain:"wh",serialize:function(t,s,i){var r=this.toJSON(),o=t&&t.orders.get(r.order)||null,m=t&&t.sapOrders.get(r.order)||null,f=Date.parse(r.startTime),d=Date.parse(r.finishTime);return r.no=s+1,r.shift=a.getShiftNo(f),r.qty=r.qty.toLocaleString(),o?(r.mrp=o.get("mrp"),r.nc12=o.get("nc12"),r.name=o.get("name"),r.qtyTodo=o.get("quantityTodo").toLocaleString(),r.planStatus=o.getStatus(),r.planStatusIcons=n(t,o.id)):(r.mrp="?",r.nc12="?",r.name="?",r.qtyTodo="0",r.planStatus="unplanned",r.planStatusIcons="?"),r.startDate=e.utc.format(f,"LL"),r.finishDate=e.utc.format(d,"LL"),r.startTimeMs=f,r.startTime=e.utc.format(f,"HH:mm:ss"),r.startTimeShort=e.utc.format(f,"H:mm"),r.finishTime=e.utc.format(d,"HH:mm:ss"),r.comment=m?m.getCommentWithIcon():"",r.comments=m?m.get("comments"):[],r.psStatus=t&&t.sapOrders.getPsStatus(r.order)||"unknown",r.rowClassName=c[r.status],r.funcIcons={},r.funcs.forEach(function(t){"ignore"===t.picklist?r.funcIcons[t._id]=l.ignored:"painter"!==t._id||"pickup"!==t.status||t.user?r.funcIcons[t._id]=l[t.status]:r.funcIcons[t._id]=l.pending}),r.distIcons={dist:u[r.distStatus],fifo:u[r.fifoStatus],pack:u[r.packStatus],psDist:"unknown"===r.psStatus?u.ignored:u[r.psDistStatus]},r.picklistDoneIcon=p[r.picklistDone],r.hidden=!i||f<i.startTime.from||f>=i.startTime.to||i.whStatuses.length>0&&-1===i.whStatuses.indexOf(r.status)||i.psStatuses.length>0&&-1===i.psStatuses.indexOf(r.psStatus),r.hidden&&(r.rowClassName+=" hidden"),r},serializeSet:function(t,e,i){var r=this.serialize(e,t.i,this.collection?this.collection.getFilters(e):{startTime:{},whStatuses:[],psStatuses:[]}),a=s.isAllowedTo("WH:MANAGE"),n=s.isAllowedTo("WH:MANAGE:CARTS"),c=this.getUserFunc(i),l=!!c,o="success"===r.picklistDone,u=!t.delivered;r.clickable={picklistDone:u&&(a||l&&c._id===r.picklistFunc&&!o)},r.funcs.forEach(function(t){var e=!!t.user,s=l&&c._id===t._id;r.clickable[t._id]={picklist:u&&(e&&a&&o||o&&l&&s&&"picklist"===t.status),pickup:u&&(e&&a&&"require"===t.picklist||n&&"success"===t.pickup||o&&l&&s&&"pickup"===t.status)}});var p=this.getFunc("fmx"),m=this.getFunc("kitter"),f=this.getFunc("platformer");return"finished"===f.status&&(r.clickable.fmx.picklist=!1,r.clickable.fmx.pickup=!1,r.clickable.kitter.picklist=!1,r.clickable.kitter.pickup=!1),r.clickable.platformer.picklist=!1,r.clickable.platformer.pickup=r.clickable.platformer.pickup&&"success"===p.pickup&&"problem"!==m.status&&"problem"!==f.status,r.clickable.painter.picklist=!1,r.clickable.printLabels=a||l&&"platformer"!==c._id&&"painter"!==c._id,r},serializeProblemFuncs:function(){var t={};return["lp10","fmx","kitter","platformer","packer","painter"].forEach(function(e){t[e]=this.serializeProblemFunc(e)},this),t},serializeProblemFunc:function(e){var i,a;("lp10"===e?(a=this.getFunc(this.get("picklistFunc")),i={label:t("wh","prop:picklist"),className:o[this.get("picklistDone")],status:t("wh","status:picklistDone:"+this.get("picklistDone")),user:a&&a.user?r({userInfo:a.user,noIp:!0,clickable:!1}):"",carts:"",problemArea:"",problem:this.get("problem"),solvable:!1}):(a=this.getFunc(e),i={label:t("wh","func:"+e),className:o[a.status],status:t("wh","status:"+a.status),user:a.user?r({userInfo:a.user,noIp:!0,clickable:!1}):"",carts:a.carts.join(", "),problemArea:a.problemArea,problem:a.comment,solvable:!1}),s.isAllowedTo("WH:SOLVER","WH:MANAGE"))&&("problem"===this.get("status")&&"wh-problems-failure"===i.className?i.solvable=!0:"wh-problems-progress"===i.className&&"platformer"===e&&(i.solvable=!0));return i},update:function(t){this.set(t)},getFunc:function(t){return this.attributes.funcs[m[t]]||null},getUserFunc:function(t){if(!t)return null;var e=this.attributes.funcs[m[t.func]];return e.user&&e.user.id===t._id?e:null},isDelivered:function(){var t=this.get("distStatus");return"started"===t||"finished"===t}},{FUNC_LIST:Object.keys(m),FUNC_TO_INDEX:m})});