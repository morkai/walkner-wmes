define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","./WhProblemDetailsView","app/wh/templates/problemList","app/wh/templates/problemListItem"],function(e,t,i,r,s,o,n,d,h,a){"use strict";return n.extend({template:h,events:{"click .wh-problems-item":function(e){this.$(e.target).closest("a").length||this.showProblemDetails(e.currentTarget.dataset.id)}},initialize:function(){this.model=this.whOrders,this.listenTo(this.whOrders,"reset",this.onOrdersReset),this.listenTo(this.whOrders,"add",this.onOrderAdded),this.listenTo(this.whOrders,"remove",this.onOrderRemoved),this.listenTo(this.whOrders,"change",this.onOrderChanged)},getTemplateData:function(){return{renderItem:a,items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.map(function(t){return e.serializeItem(t)})},serializeItem:function(e){var t={order:"",pickup:""};s.isAllowedTo("LOCAL","ORDERS:VIEW")&&!this.options.embedded&&(t.order="#orders/"+e.get("order"));var i=r.utc.format(e.get("date"),"YYYY-MM-DD");return this.options.embedded?t.pickup="/wh-pickup#?date="+i+"&focus="+e.id:t.pickup="#wh/pickup/"+i+"?focus="+e.id,{_id:e.id,order:e.get("order"),line:e.get("line"),qty:e.get("qty").toLocaleString(),date:r.utc.format(e.get("date"),"LL"),startTime:r.utc.format(e.get("startTime"),"L HH:mm:ss"),finishTime:r.utc.format(e.get("finishTime"),"L HH:mm:ss"),lp10:e.serializeProblemFunc("lp10"),fmx:e.serializeProblemFunc("fmx"),kitter:e.serializeProblemFunc("kitter"),packer:e.serializeProblemFunc("packer"),urls:t}},$item:function(e){return this.$('.wh-problems-item[data-id="'+e+'"]')},showProblemDetails:function(e){var t=this.whOrders.get(e),i=new d({model:t,whOrders:this.whOrders});o.showDialog(i,this.t("problem:title",{orderNo:t.get("order"),line:t.get("line")}))},toggleEmpty:function(){this.$el.toggleClass("is-empty",0===this.whOrders.length)},onOrdersReset:function(){this.render()},onOrderAdded:function(e){this.$el.append(a({item:this.serializeItem(e)})),this.toggleEmpty()},onOrderRemoved:function(e){this.$item(e.id).remove(),this.toggleEmpty()},onOrderChanged:function(e){var t=this.$item(e.id);t.length&&t.replaceWith(a({item:this.serializeItem(e)}))}})});