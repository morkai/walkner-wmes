define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","./WhProblemDetailsView","app/wh/templates/problemList","app/wh/templates/problemListItem"],function(e,t,s,r,i,n,o,a,l,m,h){"use strict";var p={pending:"wh-problems-pending",picklist:"wh-problems-progress",pickup:"wh-problems-progress",problem:"wh-problems-failure",finished:"wh-problems-success"};return o.extend({template:m,events:{"click .wh-problems-item":function(e){this.showProblemDetails(e.currentTarget.dataset.id)}},initialize:function(){this.model=this.whOrders,this.listenTo(this.whOrders,"reset",this.onOrdersReset),this.listenTo(this.whOrders,"add",this.onOrderAdded),this.listenTo(this.whOrders,"remove",this.onOrderRemoved),this.listenTo(this.whOrders,"change",this.onOrderChanged)},getTemplateData:function(){return{renderItem:h,items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.map(function(t){return e.serializeItem(t)})},serializeItem:function(e){return{_id:e.id,order:e.get("order"),line:e.get("line"),qty:e.get("qty").toLocaleString(),date:r.utc.format(e.get("date"),"LL"),startTime:r.utc.format(e.get("startTime"),"L HH:mm:ss"),finishTime:r.utc.format(e.get("finishTime"),"L HH:mm:ss"),lp10:{label:this.t("prop:picklist"),className:e.get("picklistDone")?"wh-problems-success":"wh-problems-failure",status:s("wh","status:picklistDone:"+e.get("picklistDone")),user:a({userInfo:e.getFunc(e.get("picklistFunc")).user}),problem:e.get("problem")},fmx:this.serializeFunc(e,"fmx"),kitter:this.serializeFunc(e,"kitter"),packer:this.serializeFunc(e,"packer"),urls:{order:i.isAllowedTo("LOCAL","ORDERS:VIEW")?"#orders/"+e.get("order"):"",date:"#wh/plans/"+r.utc.format(e.get("date"),"YYYY-MM-DD")+"?focus="+e.id}}},serializeFunc:function(e,t){var s=e.getFunc(t);return{label:this.t("func:"+t),className:p[s.status],status:this.t("status:"+s.status),user:s.user?a({userInfo:s.user}):"",carts:s.carts.join(", "),problemArea:s.problemArea,problem:s.comment}},$item:function(e){return this.$('.wh-problems-item[data-id="'+e+'"]')},showProblemDetails:function(e){var t=new l({model:this.whOrders.get(e)});n.showDialog(t,this.t("problem:title"))},hideProblemDetails:function(){},onOrdersReset:function(){this.render()},onOrderAdded:function(e){this.$el.append(h({item:this.serializeItem(e)}))},onOrderRemoved:function(e){this.$item(e).remove()},onOrderChanged:function(e){var t=this.$item(e);t.length&&t.replaceWith(h({item:this.serializeItem(e)}))}})});