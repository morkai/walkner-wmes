define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","./WhProblemDetailsView","app/wh/templates/problemList","app/wh/templates/problemListItem"],function(e,t,i,r,s,n,o,l,a,m){"use strict";return o.extend({template:a,events:{"click .wh-problems-item":function(e){this.$(e.target).closest("a").length||this.showProblemDetails(e.currentTarget.dataset.id)}},initialize:function(){this.model=this.whOrders,this.listenTo(this.whOrders,"reset",this.onOrdersReset),this.listenTo(this.whOrders,"add",this.onOrderAdded),this.listenTo(this.whOrders,"remove",this.onOrderRemoved),this.listenTo(this.whOrders,"change",this.onOrderChanged)},getTemplateData:function(){return{renderItem:m,items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.map(function(t){return e.serializeItem(t)})},serializeItem:function(e){return{_id:e.id,order:e.get("order"),line:e.get("line"),qty:e.get("qty").toLocaleString(),date:r.utc.format(e.get("date"),"LL"),startTime:r.utc.format(e.get("startTime"),"L HH:mm:ss"),finishTime:r.utc.format(e.get("finishTime"),"L HH:mm:ss"),lp10:e.serializeProblemFunc("lp10"),fmx:e.serializeProblemFunc("fmx"),kitter:e.serializeProblemFunc("kitter"),packer:e.serializeProblemFunc("packer"),urls:{order:s.isAllowedTo("LOCAL","ORDERS:VIEW")?"#orders/"+e.get("order"):"",date:"#wh/plans/"+r.utc.format(e.get("date"),"YYYY-MM-DD")+"?focus="+e.id}}},$item:function(e){return this.$('.wh-problems-item[data-id="'+e+'"]')},showProblemDetails:function(e){var t=this.whOrders.get(e),i=new l({model:t});n.showDialog(i,this.t("problem:title",{orderNo:t.get("order"),line:t.get("line")}))},hideProblemDetails:function(){},toggleEmpty:function(){this.$el.toggleClass("is-empty",0===this.whOrders.length)},onOrdersReset:function(){this.render()},onOrderAdded:function(e){this.$el.append(m({item:this.serializeItem(e)})),this.toggleEmpty()},onOrderRemoved:function(e){this.$item(e.id).remove(),this.toggleEmpty()},onOrderChanged:function(e){var t=this.$item(e.id);t.length&&t.replaceWith(m({item:this.serializeItem(e)}))}})});