define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","./WhProblemDetailsView","app/wh/templates/problems/list","app/wh/templates/problems/listItem"],function(e,t,r,i,s,o,n,d,h,a){"use strict";return n.extend({template:h,events:{"click .wh-problems-item":function(e){this.$(e.target).closest("a").length||this.showProblemDetails(e.currentTarget.dataset.id)}},initialize:function(){this.model=this.whOrders,this.listenTo(this.whOrders,"reset",this.onOrdersReset),this.listenTo(this.whOrders,"add",this.onOrderAdded),this.listenTo(this.whOrders,"remove",this.onOrderRemoved),this.listenTo(this.whOrders,"change",this.onOrderChanged)},getTemplateData:function(){return{renderItem:this.renderPartialHtml.bind(this,a),items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.map(function(t){return e.serializeItem(t)})},serializeItem:function(e){var t={order:"",pickup:""};s.isAllowedTo("LOCAL","ORDERS:VIEW")&&!this.options.embedded&&(t.order="#orders/"+e.get("order"));var r=i.utc.format(e.get("date"),"YYYY-MM-DD");this.options.embedded?t.pickup="/wh-pickup#?date="+r+"&order="+e.id:t.pickup="#wh/pickup/"+r+"?order="+e.id;var o=e.get("problemAt");return{_id:e.id,order:e.get("order"),line:e.get("line"),qty:e.get("qty").toLocaleString(),date:i.utc.format(e.get("date"),"LL"),startTime:i.utc.format(e.get("startTime"),"L HH:mm:ss"),problemAt:o?i.utc.format(o,"L HH:mm:ss"):"",funcs:e.serializeProblemFuncs(),urls:t}},$item:function(e){return this.$('.wh-problems-item[data-id="'+e+'"]')},showProblemDetails:function(e){var t=this.whOrders.get(e),r=new d({model:t,whOrders:this.whOrders});o.showDialog(r,this.t("problem:title",{orderNo:t.get("order"),line:t.get("line")}))},toggleEmpty:function(){this.$el.toggleClass("is-empty",0===this.whOrders.length)},onOrdersReset:function(){this.render()},onOrderAdded:function(e){this.$el.append(this.renderPartialHtml(a,{item:this.serializeItem(e)})),this.toggleEmpty()},onOrderRemoved:function(e){this.$item(e.id).remove(),this.toggleEmpty()},onOrderChanged:function(e){var t=this.$item(e.id);t.length&&t.replaceWith(this.renderPartialHtml(a,{item:this.serializeItem(e)}))}})});