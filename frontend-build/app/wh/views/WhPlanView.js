define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/planning/PlanSapOrder","app/core/templates/userInfo","app/wh/templates/whList","app/wh/templates/whListRow","app/wh/templates/whListPopover","app/planning/templates/lineOrderComments"],function(t,e,n,i,s,r,a,o,d,l,h,p,c,u,m){"use strict";return a.extend({template:p,events:{"contextmenu td[data-column-id]":function(t){return this.showMenu(t),!1},"mousedown .planning-mrp-lineOrders-comment":function(t){if(0===t.button){var e=this.plan.sapOrders.get(t.currentTarget.parentNode.dataset.order);if(e){var n=e.get("comments");n.length&&this.$(t.currentTarget).popover({trigger:"manual",placement:"left",html:!0,content:m({comments:n.map(function(t){return{user:h({noIp:!0,userInfo:t.user}),time:i.toTagData(t.time).human,text:l.formatCommentWithIcon(t)}})}),template:'<div class="popover planning-mrp-comment-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")}}},"mouseup .planning-mrp-lineOrders-comment":function(t){this.$(t.currentTarget).popover("destroy")},'click .is-clickable[data-column-id="set"]':function(t){this.trigger("setClicked",t.currentTarget.parentNode.dataset.id)}},initialize:function(){var t=this.plan,e=t.sapOrders;this.listenTo(t,"change:loading change:updatedAt",this.scheduleRender),this.listenTo(e,"reset",this.onOrdersReset),this.listenTo(e,"change:comments",this.onCommentChange),this.listenTo(e,"change:psStatus",this.onPsStatusChanged),this.listenTo(this.whOrders,"reset",this.onOrdersReset),this.listenTo(this.whOrders,"change",this.onOrderChanged)},serialize:function(){return{idPrefix:this.idPrefix,renderRow:c,rows:this.serializeRows()}},serializeRows:function(){return this.whOrders.serialize(this.plan)},beforeRender:function(){clearTimeout(this.timers.render)},afterRender:function(){var t=this;t.$el.popover({selector:".wh-has-popover",container:"body",placement:"top auto",trigger:"hover",html:!0,title:function(){return n("wh","list:popover:"+this.dataset.columnId)},content:function(){var i=t.whOrders.get(e(this).closest(".wh-list-item")[0].dataset.id),s={user:null,status:null,carts:[],problemArea:"",comment:""};if("picklist"===this.dataset.columnId){var r=i.getFunc(i.get("picklistFunc"));r?(s.user=r.user.label,s.status=n("wh","status:picklistDone:"+i.get("picklistDone"))):s.status=n("wh","status:pending")}else{var a=i.getFunc(this.dataset.columnId);s.status=n("wh","status:"+a.status),s.carts=a.carts,s.problemArea=a.problemArea,s.comment=a.comment,a.user&&(s.user=a.user.label)}return t.renderPartial(u,s)},template:function(t){return e(t).addClass("wh-list-popover")}})},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},hideMenu:function(){d.hide(this)},showMenu:function(t){var e=t.currentTarget.parentNode,i=this.whOrders.get(e.dataset.id),r=i.get("order"),a=i.get("set"),o=i.get("status"),l=[d.actions.sapOrder(r)];(this.plan.shiftOrders.findOrders(r).length||this.plan.getActualOrderData(r).quantityDone)&&l.push({icon:"fa-file-text-o",label:n("wh","menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,r)}),this.plan.canCommentOrders()&&l.push(d.actions.comment(r)),l.push("-"),l.push({icon:"fa-clipboard",label:n("wh","menu:copy:all"),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX,!1,!1)}),s.isAllowedTo("WH:MANAGE")&&(l.push("-"),"cancelled"!==o&&(l.push({icon:"fa-times",label:n("wh","menu:cancelOrder"),handler:this.handleCancelAction.bind(this,{orders:[i.id]})}),a&&l.push({label:n("wh","menu:cancelSet"),handler:this.handleCancelAction.bind(this,{set:a})})),"pending"!==o&&(l.push({icon:"fa-eraser",label:n("wh","menu:resetOrder"),handler:this.handleResetAction.bind(this,{orders:[i.id]})}),a&&l.push({label:n("wh","menu:resetSet"),handler:this.handleResetAction.bind(this,{set:a})}))),d.show(this,t.pageY,t.pageX,l)},handleShiftOrderAction:function(t){var e=this.plan.shiftOrders.findOrders(t);if(1===e.length)return window.open("/#prodShiftOrders/"+e[0].id);window.open("/#prodShiftOrders?sort(startedAt)&limit(-1337)&orderId="+t)},handleCopyAction:function(e,i,s,r,a){var d=this;o.copy(function(o){if(o){var l=a?[]:[["group","no","set","shift","mrp","order","nc12","name","qtyPlan","qtyTodo","startTime","finishTime","line","picklist","fmx","kitter","packer","comment"].map(function(t){return n("wh","prop:"+t)}).join("\t")],h=d.whOrders.get(e.dataset.id),p=h.get("line"),c=h.get("group");d.serializeRows().forEach(function(t){if(!r||t.line===p&&t.group===c)if(a)l.push(t.order);else{var e=[t.group,t.no,t.set,t.shift,t.mrp,t.order,t.nc12,t.name,t.qty,t.qtyTodo,t.startTime,t.finishTime,t.line,t.picklistFunc?t.picklistDone?1:0:"",n("wh","status:"+t.funcs[0].status),n("wh","status:"+t.funcs[1].status),n("wh","status:"+t.funcs[2].status),'"'+t.comments.map(function(t){return t.user.label+": "+t.text.replace(/"/g,"'")}).join("\r\n--\r\n")+'"'];l.push(e.join("\t"))}}),a&&(l=t.uniq(l)),o.setData("text/plain",l.join("\r\n"));var u=d.$(e).tooltip({container:d.el,trigger:"manual",placement:"bottom",title:n("planning","lineOrders:menu:copy:success")});u.tooltip("show").data("bs.tooltip").tip().addClass("result success").css({left:s+"px",top:i+"px"}),d.timers.hideTooltip&&clearTimeout(d.timers.hideTooltip),d.timers.hideTooltip=setTimeout(function(){u.tooltip("destroy")},1337)}})},handleResetAction:function(t){this.promised(this.whOrders.act("resetOrders",t))},handleCancelAction:function(t){this.promised(this.whOrders.act("cancelOrders",t))},onCommentChange:function(t){this.plan.orders.get(t.id)&&this.$('tr[data-order="'+t.id+'"] > .planning-mrp-lineOrders-comment').html(t.getCommentWithIcon())},onOrdersReset:function(t,e){e.reload||this.scheduleRender()},onPsStatusChanged:function(t){var e=this.$('tr[data-order="'+t.id+'"]');if(e.length){var i=this.plan.sapOrders.getPsStatus(t.id);e.find(".planning-mrp-list-property-psStatus").attr("title",n("planning","orders:psStatus:"+i)).attr("data-ps-status",i)}},onOrderChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');if(e.length){var n=this.whOrders.indexOf(t);e.replaceWith(c({row:t.serialize(this.plan,n)}))}}})});