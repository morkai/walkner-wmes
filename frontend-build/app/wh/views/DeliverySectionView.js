define(["app/time","app/core/View","app/wh/templates/delivery/section","app/wh/templates/delivery/item","app/wh/templates/resolveAction"],function(e,t,s,i,n){"use strict";return t.extend({template:s,nlsDomain:"wh",events:{"submit .wh-pa-resolveAction":function(){var e=this.$(".wh-pa-resolveAction").find(".form-control").val();return this.model.trigger("resolveAction",e),!1}},initialize:function(){this.listenTo(this.setCarts,"reset",this.onReset),this.listenTo(this.setCarts,"remove",this.onRemoved),this.listenTo(this.setCarts,"add",this.onAdded),this.listenTo(this.setCarts,"change",this.onChanged),this.options.resolveAction&&this.listenTo(this.model,"change:personnelId",this.onPersonnelIdChanged)},getTemplateData:function(){return{kind:this.options.kind,status:this.options.status,renderItem:this.renderPartialHtml.bind(this,i),items:this.serializeItems(),resolveAction:this.options.resolveAction?this.renderPartialHtml(n,{pattern:"development"===window.ENV?"":"^[0-9]{5,}$"}):""}},afterRender:function(){this.options.resolveAction&&this.onPersonnelIdChanged()},serializeItems:function(){var e=this,t=[];return e.setCarts.forEach(function(s){t.push(e.serializeItem(s))}),t},serializeItem:function(t){var s=t.toJSON();return s.model=t,s.className=this.getStatusClassName(t),s.lineClassName=s.line.length>=15?"wh-is-very-long":s.line.length>10?"wh-is-long":"",s.date=e.utc.format(s.date,"L"),s.set=this.t("delivery:set",{set:s.set}),s.sapOrders={},s.orders.forEach(function(e){s.sapOrders[e.sapOrder]=1}),s.sapOrders=Object.keys(s.sapOrders),s},getStatusClassName:function(e){if("delivering"===e.get("status"))return"wh-status-delivering";for(var t=this.whSettings.getLateDeliveryTime(),s=this.whSettings.getMinTimeForDelivery(),i=e.get("lines"),n="pending"===this.options.status?"wh-status-pending":"",r=0;r<i.length;++r){var a=this.lines.get(i[r]);if(a){var o=a.get("components").time;if(o<t){n="wh-status-late";break}o<s&&(n="wh-status-deliverable")}}return n},highlight:function(){var e=this;e.setCarts.forEach(function(t){var s=e.getStatusClassName(t),i=e.$item(t.id);i.hasClass(s)||i.removeClass("wh-status-pending wh-status-deliverable wh-status-late wh-status-delivering").addClass(s)})},$item:function(e){return this.$('.wh-delivery-item[data-id="'+e+'"]')},renderItem:function(e){return this.renderPartialHtml(i,{item:this.serializeItem(e)})},onReset:function(){var e=this,t=e.$id("items"),s="";e.setCarts.forEach(function(t){s+=e.renderItem(t)}),s+=t.find("tfoot")[0].outerHTML,t.html(s)},onRemoved:function(e){this.$item(e.id).remove()},onAdded:function(e){this.$id("items").append(this.renderItem(e))},onChanged:function(e){this.$item(e.id).replaceWith(this.renderItem(e))},onPersonnelIdChanged:function(){this.$(".wh-pa-resolveAction").find(".form-control").val(this.model.get("personnelId")||"")}})});