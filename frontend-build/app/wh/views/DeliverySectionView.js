define(["underscore","app/time","app/core/View","app/wh/templates/delivery/section","app/wh/templates/delivery/item","app/wh/templates/resolveAction"],function(e,t,i,s,n,r){"use strict";return i.extend({template:s,nlsDomain:"wh",events:{"click #-forceLine":function(){this.trigger("forceLineClicked")},"click .wh-delivery-item":function(e){if("delivering"===this.options.status){var t=this.setCarts.get(e.currentTarget.dataset.id).get("deliveringBy");this.model.trigger("continueDelivery",{user:t,setCarts:this.setCarts.filter(function(e){return e.get("deliveringBy").id===t.id}).map(function(e){return e.id})})}},"submit .wh-pa-resolveAction":function(){document.activeElement&&document.activeElement.blur();var e=this.$(".wh-pa-resolveAction").find(".form-control").val();return this.model.trigger("resolveAction",e),!1}},initialize:function(){this.listenTo(this.setCarts,"reset",this.onReset),this.listenTo(this.setCarts,"remove",this.onRemoved),this.listenTo(this.setCarts,"add",this.onAdded),this.listenTo(this.setCarts,"change",this.onChanged),this.options.actions&&this.listenTo(this.model,"change:personnelId",this.onPersonnelIdChanged)},getTemplateData:function(){return{kind:this.options.kind,status:this.options.status,renderItem:this.renderPartialHtml.bind(this,n),items:this.serializeItems(),actions:!!this.options.actions,resolveAction:this.options.actions?this.renderPartialHtml(r,{pattern:"development"===window.ENV?"":"^[0-9]{5,}$",value:this.model.get("personnelId")}):""}},afterRender:function(){this.options.resolveAction&&this.onPersonnelIdChanged()},serializeItems:function(){var e=this,t=[];return e.setCarts.forEach(function(i){t.push(e.serializeItem(i))}),t},serializeItem:function(e){var i=e.toJSON();return i.model=e,i.className=this.getStatusClassName(e),i.line=this.serializeItemLine(e),i.date=t.utc.format(i.date,"L"),i.startTime=t.utc.format(i.startTime,"HH:mm:ss"),i.set=this.t("delivery:set",{set:i.set}),i.sapOrders={},i.orders.forEach(function(e){i.sapOrders[e.sapOrder]=1}),i.sapOrders=Object.keys(i.sapOrders),i},serializeItemLine:function(t){var i=t.get("line"),s=t.get("lines"),n=t.get("redirLine"),r=t.get("redirLines"),a=i.length,o=23,l=19;"completed"===this.options.status&&(o=16,l=12);var h="",d="",c=e.escape(i);return n&&(a+=2,c='<i class="fa fa-arrow-right"></i>'+c,"completed"!==this.options.status&&(a+=n.length,c=e.escape(n)+c),1===s.length?h=n+" ➜ "+i:(h=i+":",s.forEach(function(e,t){e===r[t]?h+="\n - "+e:h+="\n - "+r[t]+" ➜ "+e}))),a>o?d="wh-is-very-long":a>l&&(d="wh-is-long"),{title:h,className:d,label:c}},getStatusClassName:function(e){if("delivering"===e.get("status"))return"wh-status-delivering";for(var t=this.whSettings.getLateDeliveryTime(),i=this.whSettings.getMinTimeForDelivery(),s=e.get("lines"),n="pending"===this.options.status?"wh-status-pending":"",r=0;r<s.length;++r){var a=this.lines.get(s[r]);if(a){var o=a.get("components").time;if(o<t){n="wh-status-late";break}o<i&&(n="wh-status-deliverable")}}return n},highlight:function(){var e=this;e.setCarts.forEach(function(t){var i=e.getStatusClassName(t),s=e.$item(t.id);s.hasClass(i)||s.removeClass("wh-status-pending wh-status-deliverable wh-status-late wh-status-delivering").addClass(i)})},$item:function(e){return this.$('.wh-delivery-item[data-id="'+e+'"]')},renderItem:function(e){return this.renderPartialHtml(n,{item:this.serializeItem(e)})},onReset:function(){var e=this,t=e.$id("items"),i="";e.setCarts.forEach(function(t){i+=e.renderItem(t)}),i+=t.find("tfoot")[0].outerHTML,t.html(i)},onRemoved:function(e){this.$item(e.id).remove()},onAdded:function(e){this.$id("items").append(this.renderItem(e))},onChanged:function(e){this.$item(e.id).replaceWith(this.renderItem(e))},onPersonnelIdChanged:function(){this.$(".wh-pa-resolveAction").find(".form-control").val(this.model.get("personnelId")||"")}})});