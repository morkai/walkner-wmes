define(["underscore","app/time","app/core/View","app/wh/templates/delivery/section","app/wh/templates/delivery/item","app/wh/templates/resolveAction"],function(t,e,s,i,n,r){"use strict";return s.extend({template:i,nlsDomain:"wh",events:{"click #-forceLine":function(){this.trigger("forceLineClicked")},"click .wh-delivery-item":function(t){if("delivering"===this.options.status){var e=this.setCarts.get(t.currentTarget.dataset.id).get("deliveringBy");this.model.trigger("continueDelivery",{user:e,setCarts:this.setCarts.filter(function(t){return t.get("deliveringBy").id===e.id}).map(function(t){return t.id})})}},"submit .wh-pa-resolveAction":function(){document.activeElement&&document.activeElement.blur();var t=this.$(".wh-pa-resolveAction").find(".form-control").val();return this.model.trigger("resolveAction",t),!1}},initialize:function(){this.scheduleStatsUpdate=t.debounce(this.updateStats.bind(this),100),this.listenTo(this.setCarts,"reset",this.onReset),this.listenTo(this.setCarts,"remove",this.onRemoved),this.listenTo(this.setCarts,"add",this.onAdded),this.listenTo(this.setCarts,"change",this.onChanged),this.options.actions&&this.listenTo(this.model,"change:personnelId",this.onPersonnelIdChanged)},getTemplateData:function(){return{kind:this.options.kind,status:this.options.status,renderItem:this.renderPartialHtml.bind(this,n),items:this.serializeItems(),actions:!!this.options.actions,resolveAction:this.options.actions?this.renderPartialHtml(r,{pattern:"production"!==window.ENV?"":"^[0-9]{5,}$",value:this.model.get("personnelId")}):""}},afterRender:function(){this.options.resolveAction&&this.onPersonnelIdChanged(),this.updateStats()},serializeItems:function(){var t=this,e=[];return t.setCarts.forEach(function(s){e.push(t.serializeItem(s))}),e},serializeItem:function(t){var s=t.toJSON();return s.model=t,s.className=this.getStatusClassName(t),s.line=this.serializeItemLine(t),s.date=e.utc.format(s.date,"L"),s.startTime=e.utc.format(s.startTime,"HH:mm:ss"),s.set=this.t("delivery:set",{set:s.set}),s.sapOrders={},s.orders.forEach(function(t){s.sapOrders[t.sapOrder]=1}),s.sapOrders=Object.keys(s.sapOrders),s.reason&&"completed"===this.options.status?(s.title=this.t("delivery:reasons:title:"+s.reason),s.reason=this.t("delivery:reasons:code:"+s.reason)):(s.title="",s.reason=""),s},serializeItemLine:function(e){var s=e.get("line"),i=e.get("lines"),n=e.get("redirLine"),r=e.get("redirLines"),a=s.length,o=23,h=19;"completed"===this.options.status&&(o=16,h=12);var d="",l="",c=t.escape(s);return n&&(a+=2,c='<i class="fa fa-arrow-right"></i>'+c,"completed"!==this.options.status&&(a+=n.length,c=t.escape(n)+c),1===i.length?d=n+" ➜ "+s:(d=s+":",i.forEach(function(t,e){t===r[e]?d+="\n - "+t:d+="\n - "+r[e]+" ➜ "+t}))),a>o?l="wh-is-very-long":a>h&&(l="wh-is-long"),{title:d,className:l,label:c}},getStatusClassName:function(t){var e=t.get("status");if("completing"===e)return"wh-status-completing";if("delivering"===e)return"wh-status-delivering";if("completed"===e&&t.get("forced"))return"wh-status-late";for(var s=this.whSettings.getLateDeliveryTime(),i=this.whSettings.getMaxMinTimeForDelivery(t.get("orders")),n=t.get("lines"),r="pending"===this.options.status?"wh-status-pending":"",a=0;a<n.length;++a){var o=this.lines.get(n[a]);if(o){var h=o.get("available").time;if(h<s){r="wh-status-late";break}h<i&&(r="wh-status-deliverable")}}return r},highlight:function(){var t=this;t.setCarts.forEach(function(e){var s=t.getStatusClassName(e),i=t.$item(e.id);i.hasClass(s)||i.removeClass("wh-status-pending wh-status-deliverable wh-status-late wh-status-delivering").addClass(s)})},$item:function(t){return this.$('.wh-delivery-item[data-id="'+t+'"]')},renderItem:function(t){return this.renderPartialHtml(n,{item:this.serializeItem(t)})},updateStats:function(){var t={},s={sets:{},orders:{},qty:0,time:0};this.setCarts.forEach(function(e){var i=e.get("date")+e.get("set");s.sets[i]=1,e.get("orders").forEach(function(e){s.orders[e.sapOrder]=1,t[e.whOrder]||(t[e.whOrder]=1,s.qty+=e.qty,s.time+=Date.parse(e.finishTime)-Date.parse(e.startTime))})}),s.sets=Object.keys(s.sets).length,s.orders=Object.keys(s.orders).length,s.time=e.toString(s.time/1e3,!0,!1),this.$(".wh-delivery-stat-value").each(function(){var t=s[this.parentNode.dataset.stat];this.textContent="number"==typeof t?t.toLocaleString():t})},onReset:function(){var t=this,e=t.$id("items"),s="";t.setCarts.forEach(function(e){s+=t.renderItem(e)}),s+=e.find("tfoot")[0].outerHTML,e.html(s),t.scheduleStatsUpdate()},onRemoved:function(t){this.$item(t.id).remove(),this.scheduleStatsUpdate()},onAdded:function(t){this.$id("items").append(this.renderItem(t)),this.scheduleStatsUpdate()},onChanged:function(t){this.$item(t.id).replaceWith(this.renderItem(t)),this.scheduleStatsUpdate()},onPersonnelIdChanged:function(){this.$(".wh-pa-resolveAction").find(".form-control").val(this.model.get("personnelId")||"")}})});