define(["underscore","app/core/View","app/data/localStorage","app/planning/util/shift","app/wh/WhOrder","app/wh/templates/pickup/status"],function(t,e,s,i,n,a){"use strict";var d="WMES_WH_PICKUP_STATUS_EXPANDED";return e.extend({template:a,events:{click:function(){this.$el.toggleClass("wh-pickup-status-expanded"),this.updateStats(),this.updatePadding(),this.$el.hasClass("wh-pickup-status-expanded")?s.setItem(d,"1"):s.removeItem(d)}},initialize:function(){this.scheduleStatsUpdate=t.throttle(this.updateStats.bind(this),1e3),this.statsCache=null,this.oldPadding=null,this.listenTo(this.model,"change:funcs",this.updateStatus),this.listenTo(this.whLines,"change:pickup change:startedPlan",this.scheduleStatsUpdate),this.listenTo(this.whOrders,"change:status change:funcs",this.scheduleStatsUpdate),this.listenTo(this.whOrders,"reset",this.updateStats)},getTemplateData:function(){return{expanded:"1"===s.getItem(d),funcs:this.model.get("funcs")}},destroy:function(){null!==this.oldPadding&&(document.body.style.paddingBottom=this.oldPadding)},beforeRender:function(){this.statsCache=null,null===this.oldPadding&&(this.oldPadding=document.body.style.paddingBottom)},afterRender:function(){this.updateStats(),this.updatePadding()},updatePadding:function(){document.body.style.paddingBottom=this.$el.outerHeight()+"px"},updateStatus:function(){var t=this.model.get("funcs");this.$(".wh-pickup-status-func").each(function(){this.classList.toggle("is-ready",t[this.dataset.func])})},updateStats:function(){if(this.el.classList.contains("wh-pickup-status-expanded")){var e={};n.FUNC_LIST.forEach(function(t){e[t]={pending:{sets:{},orders:0,qty:0},started:{sets:{},orders:0,qty:0}}});var s=this.whSettings.getValue("planning.ignorePsStatus")||[],a=this.whSettings.getValue("planning.psPickupStatus")||[],d={},u={};this.whOrders.forEach(function(t){var e=t.get("set");t.get("lines").forEach(function(t){u[t._id]=!0}),e&&(d[e]||(d[e]=[]),d[e].push(t))}),this.whOrders.forEach(function(i){var u=i.get("status");if("finished"!==u&&"cancelled"!==u){var h="unknown"!==i.get("psStatus");if(!h||"pending"!==u||!t.includes(s,i.get("psStatus"))){var r=d[i.get("set")]||[],c=i.get("set")+"_"+i.get("date"),o=i.get("qty"),p=i.get("funcs"),l=p[n.FUNC_TO_INDEX.fmx],f=p[n.FUNC_TO_INDEX.kitter],g=r.every(function(e){var s=e.get("psStatus");return"unknown"===s||t.includes(a,s)});p.forEach(function(t){if("finished"!==t.status&&"ignore"!==t.picklist&&(h||"painter"!==t._id)){if("painter"===t._id){if("pending"!==i.get("psDistStatus"))return;if(!t.user&&!g)return;if(0===r.length)return}else if("packer"===t._id){if("pending"!==i.get("packStatus"))return;if(0===r.length)return}else{if("pending"!==i.get("fifoStatus"))return;if("platformer"===t._id&&(0===l.carts.length||"finished"!==f.status))return}var s=t.user?"started":"pending",n=e[t._id][s];n.sets[c]=1,n.orders+=1,n.qty+=o}})}}}),this.statsCache||this.cacheStats();var h=this.statsCache,r=this.whSettings.getValue("planning.maxSetsPerLine")||2,c=i.getPlanDate(Date.now()).valueOf(),o=0;this.whLines.forEach(function(t){!u[t.id]||Date.parse(t.get("startedPlan"))<c||(o+=Math.max(0,r-t.get("pickup").total.sets))}),n.FUNC_LIST.forEach(function(t){var s=e[t];Object.keys(s).forEach(function(e){var i=s[e];i.sets="pending"!==e||"fmx"!==t&&"kitter"!==t?Object.keys(i.sets).length:o,Object.keys(i).forEach(function(s){var n=t+":"+e+":"+s,a=i[s];h[n].textContent="number"==typeof a?a.toLocaleString():a})})})}},cacheStats:function(){var t={};this.$("td[data-stat]").each(function(){t[this.dataset.stat]=this}),this.statsCache=t}})});