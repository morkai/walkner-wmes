// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/core/util/idAndLabel","app/mrpControllers/util/setUpMrpSelect2","app/users/util/setUpUserSelect2","app/settings/views/SettingsView","../WhUser","app/wh/templates/settings"],function(e,t,n,i,s,r,a){"use strict";return s.extend({clientUrl:"#wh/settings",template:a,events:e.assign({"change input[data-setting]":function(e){this.updateSetting(e.target.name,e.target.value)},"change input[data-user-func]":function(e){var t=e.currentTarget.dataset.userFunc;e.added?this.addUser(e.added,t):e.removed&&this.removeUser(e.removed,t)}},s.prototype.events),initialize:function(){s.prototype.initialize.apply(this,arguments),this.listenTo(this.whUsers,"add remove",this.onUserUpdated),this.listenTo(this.whUsers,"change:func",this.onFuncChanged)},afterRender:function(){var e=this;s.prototype.afterRender.apply(e,arguments),n(e.$id("planning-ignoredMrps"),{width:"100%",placeholder:" ",sortable:!0,own:!1,view:this}),this.$("input[data-user-func]").each(function(){i(e.$(this),{width:"100%",multiple:!0,allowClear:!0,placeholder:" ",noPersonnelId:!0}),e.updateUsers(this.dataset.userFunc)})},shouldAutoUpdateSettingField:function(e){return"wh.planning.ignoredMrps"!==e.id},updateSettingField:function(e){e&&"wh.planning.ignoredMrps"===e.id&&this.$id("planning-ignoredMrps").select2("data",e.getValue().map(function(e){return{id:e,text:e}}))},addUser:function(e,t){var n=this,i=n.whUsers.get(e.id);if(i){if(i.get("func")===t)return;this.promised(i.save({func:t}))}else i=new r({_id:e.id,label:e.text,func:t}),i.id=null,n.promised(i.save()).done(function(){n.whUsers.add(i)})},removeUser:function(e,t){var n=this.whUsers.get(e.id);n&&n.get("func")===t&&n.destroy()},updateUsers:function(e){this.$('input[data-user-func="'+e+'"]').select2("data",this.whUsers.filter(function(t){return t.get("func")===e}).map(t))},onUserUpdated:function(e){this.updateUsers(e.get("func"))},onFuncChanged:function(e){e.hasChanged("func")&&(this.updateUsers(e.previous("func")),this.updateUsers(e.get("func")))}})});