define(["underscore","app/user","app/core/util/idAndLabel","app/mrpControllers/util/setUpMrpSelect2","app/users/util/setUpUserSelect2","app/settings/views/SettingsView","../WhUser","app/wh/templates/settings"],function(e,t,i,s,n,r,a,d){"use strict";return r.extend({clientUrl:"#wh/settings",template:d,events:e.assign({"change input[data-setting]":function(e){this.updateSetting(e.target.name,e.target.value)},"change input[data-user-func]":function(e){var t=e.currentTarget.dataset.userFunc;e.added?this.addUser(e.added,t):e.removed&&this.removeUser(e.removed,t)},"dblclick .select2-search-choice > div":function(e){if(t.isAllowedTo("USERS:VIEW")){for(var i=-1,s=e.currentTarget.parentNode;null!==(s=s.previousSibling);)++i;var n=this.$(e.currentTarget).closest(".select2-container").select2("data")[i];if(n){var r=this.whUsers.get(n.id);r&&window.open("/#users/"+r.id)}}}},r.prototype.events),initialize:function(){r.prototype.initialize.apply(this,arguments),this.listenTo(this.whUsers,"add remove",this.onUserUpdated),this.listenTo(this.whUsers,"change:func",this.onFuncChanged)},afterRender:function(){var e=this;r.prototype.afterRender.apply(e,arguments),s(e.$id("planning-ignoredMrps"),{width:"100%",placeholder:" ",sortable:!0,own:!1,view:this}),s(e.$id("planning-enabledMrps"),{width:"100%",placeholder:" ",sortable:!0,own:!1,view:this});var i=t.isAllowedTo("WH:MANAGE:USERS");this.$("input[data-user-func]").each(function(){n(e.$(this).prop("disabled",!i),{width:"100%",multiple:!0,allowClear:!0,placeholder:" ",noPersonnelId:!1}),e.updateUsers(this.dataset.userFunc)})},toggleTabPrivileges:function(){this.$(".list-group-item[data-privileges]").each(function(){for(var e=this.dataset.privileges.split(","),i=0;i<e.length;++i)t.isAllowedTo(e[i])||this.classList.add("disabled")})},shouldAutoUpdateSettingField:function(e){return!/Mrps$/.test(e.id)},updateSettingField:function(e){if(e&&/Mrps$/.test(e.id)){var t=e.getValue().map(function(e){return{id:e,text:e}});this.$('input[name="'+e.id+'"]').select2("data",t)}},addUser:function(e,t){var i=this,s=i.whUsers.get(e.id);if(s){if(s.get("func")===t)return;this.promised(s.save({func:t}))}else(s=new a({_id:e.id,label:e.user.name,func:t})).id=null,i.promised(s.save()).done(function(){i.whUsers.add(s)})},removeUser:function(e,t){var i=this.whUsers.get(e.id);i&&i.get("func")===t&&i.destroy()},updateUsers:function(e){this.$('input[data-user-func="'+e+'"]').select2("data",this.whUsers.filter(function(t){return t.get("func")===e}).map(i))},onUserUpdated:function(e){this.updateUsers(e.get("func"))},onFuncChanged:function(e){e.hasChanged("func")&&(this.updateUsers(e.previous("func")),this.updateUsers(e.get("func")))}})});