define(["underscore","jquery","app/i18n","app/time","app/core/View","app/mrpControllers/util/setUpMrpSelect2","app/orgUnits/util/setUpOrgUnitSelect2","app/wh/templates/pickup/filter","app/core/util/ExpandableSelect"],function(e,s,t,i,n,a,l,r){"use strict";return n.extend({template:r,events:{"change #-whStatuses":"changeFilter","change #-psStatuses":"changeFilter","change #-distStatuses":"changeFilter","change #-from":"changeFilter","change #-to":"changeFilter","change #-orders":"scheduleChangeFilter","input #-orders":"scheduleChangeFilter","change #-sets":"scheduleChangeFilter","input #-sets":"scheduleChangeFilter","change #-lines":"changeFilter","change #-mrps":"changeFilter",'change input[name="filter"]':function(){this.toggleFilterVisibility(),this.changeFilter()},"click #-useDarkerTheme":function(){this.plan.displayOptions.toggleDarkerThemeUse()}},nlsDomain:"wh",initialize:function(){var e=this.plan,s=e.displayOptions;this.listenTo(e,"change:loading",this.onLoadingChanged),this.listenTo(s,"change:useDarkerTheme",this.updateToggles)},destroy:function(){this.$(".is-expandable").expandableSelect("destroy")},getTemplateData:function(){var e=this.plan.displayOptions,s=e.get("orders").join(" "),t=e.get("lines").join(","),i=e.get("mrps").join(","),n=e.get("sets").join(" "),a="orders";return s.length||(t.length?a="lines":i.length?a="mrps":n.length&&(a="sets")),{whStatuses:e.get("whStatuses"),psStatuses:e.get("psStatuses"),distStatuses:e.get("distStatuses"),from:e.get("from"),to:e.get("to"),useDarkerTheme:e.isDarkerThemeUsed(),filter:a,orders:s,lines:t,mrps:i,sets:n}},afterRender:function(){this.$(".is-expandable").expandableSelect(),this.setUpLinesFilter(),this.setUpMrpsFilter(),this.toggleFilterVisibility()},toggleFilterVisibility:function(){var e=this.$('input[name="filter"]:checked').val(),s=this.$id("orders"),t=this.$id("lines"),i=this.$id("mrps"),n=this.$id("sets");"orders"===e?(t.prev().css("display","none"),i.prev().css("display","none"),n.addClass("hidden"),s.removeClass("hidden").focus()):"lines"===e?(s.addClass("hidden"),n.addClass("hidden"),i.prev().css("display","none"),t.prev().css("display",""),t.select2("focus")):"mrps"===e?(s.addClass("hidden"),n.addClass("hidden"),t.prev().css("display","none"),i.prev().css("display",""),i.select2("focus")):"sets"===e&&(t.prev().css("display","none"),i.prev().css("display","none"),s.addClass("hidden"),n.removeClass("hidden").focus())},setUpLinesFilter:function(){l(this.$id("lines"),{width:"698px",allowClear:!0,multiple:!0})},setUpMrpsFilter:function(){a(this.$id("mrps"),{view:this,width:"698px"})},updateToggles:function(){this.$id("useDarkerTheme").toggleClass("active",this.plan.displayOptions.isDarkerThemeUsed())},scheduleChangeFilter:function(e){var s=333;e&&e.target&&"sets"===e.target.name&&(s=500),clearTimeout(this.timers.changeFilter),this.timers.changeFilter=setTimeout(this.changeFilter.bind(this),s)},changeFilter:function(){var s=this;clearTimeout(s.timers.changeFilter);var t=s.$id("whStatuses"),i=s.$id("psStatuses"),n=s.$id("distStatuses"),a={whStatuses:t.val(),psStatuses:i.val(),distStatuses:n.val(),from:s.$id("from").val()||"06:00",to:s.$id("to").val()||"06:00",orders:[],lines:[],mrps:[],sets:[]};a.whStatuses&&a.whStatuses.length!==t[0].options.length||(a.whStatuses=[]),a.psStatuses&&a.psStatuses.length!==i[0].options.length||(a.psStatuses=[]),a.distStatuses&&a.distStatuses.length!==n[0].options.length||(a.distStatuses=[]);var l=s.$('input[name="filter"]:checked').val(),r="orders"===l?/^[0-9]{9}$/:"sets"===l?/^[0-9]{1,3}$/:null,d="orders"===l||"sets"===l?/[^0-9]+/:",";a[l]=s.$id(l).val().split(d).filter(function(e){return!!e&&(!r||r.test(e))}),a.sets.length&&(a.sets=a.sets.map(function(e){return+e}));var h={};["whStatuses","psStatuses","distStatuses","from","to","orders","lines","mrps","sets"].forEach(function(t){e.isEqual(a[t],s.plan.displayOptions.get(t))||(h[t]=a[t])}),e.isEmpty(h)||s.plan.displayOptions.set(h)},onLoadingChanged:function(){var e=this,s=e.plan.get("loading");["whStatuses","psStatuses","distStatuses","from","to","orders","sets"].forEach(function(t){e.$id(t).prop("disabled",s)}),e.$('input[name="filter"]').prop("disabled",s),e.$id("lines").select2("enable",!s),e.$id("mrps").select2("enable",!s)}})});