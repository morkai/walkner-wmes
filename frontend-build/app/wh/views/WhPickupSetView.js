define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/planning/PlanSapOrder","../WhOrder","app/core/templates/userInfo","app/wh/templates/pickup/set/set","app/wh/templates/pickup/set/setItem","app/wh/templates/pickup/set/setPickupPopover","app/wh/templates/pickup/set/cartsEditor","app/wh/templates/pickup/set/problemEditor","app/wh/templates/pickup/set/printLabels"],function(e,t,i,r,n,a,s,o,d,c,u,l,p,h,f,m,g,w){"use strict";var v={picklistDone:[{value:"success",icon:"fa-thumbs-o-up"},{value:"failure",icon:"fa-thumbs-o-down"},{value:"pending",manage:!0}],picklist:[{value:"require",icon:"fa-check"},{value:"ignore",icon:"fa-times"},{value:"pending",manage:!0}],pickup:[{value:"success",icon:"fa-thumbs-o-up"},{value:"failure",icon:"fa-thumbs-o-down"},{value:"pending",manage:!0}]};return s.extend({template:p,dialogClassName:"wh-set-dialog modal-no-keyboard",modelProperty:"whOrders",events:{"click .is-clickable":function(e){var t=this.whOrders.get(this.$(e.target).closest(".wh-set-item").attr("data-id")),i=e.currentTarget.dataset.func,r=e.currentTarget.dataset.prop;this.showUpdateMenu(t,i,r,e)},"contextmenu .wh-set-action":function(){return!1},"mousedown .wh-set-action":function(e){if(!e.currentTarget.classList.contains("is-clickable")){var t=this.whOrders.get(this.$(e.target).closest(".wh-set-item").attr("data-id")),i=e.currentTarget.dataset.func,r=e.currentTarget.dataset.prop;this.timers.showFixUpdateMenu=setTimeout(this.showFixUpdateMenu.bind(this,t,i,r,e),500)}},"mouseup .wh-set-action":function(){clearTimeout(this.timers.showFixUpdateMenu),this.timers.showFixUpdateMenu=null},click:function(){this.hideEditor()},'click .btn[data-action="printLabels"]':function(e){var i=this,r=t(w());return r.on("submit",function(){var e=r.data("whOrderId"),t=+r.find("input").val();i.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!0).find(".fa").removeClass("fa-print").addClass("fa-spinner fa-spin"),i.hideEditor();var n=i.whOrders.act("printLabels",{order:e,qty:t,funcId:i.model.user?i.model.user.func:"fmx"});return n.fail(function(){a.msg.show({type:"error",time:2500,text:i.t("printLabels:failure")})}),n.always(function(){i.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!1).find(".fa").removeClass("fa-spinner fa-spin").addClass("fa-print")}),!1}),i.showEditor(r,i.$(e.target).closest(".wh-set-actions")[0]),r.find("input").select(),!1}},initialize:function(){var e=this;e.listenTo(e.plan.sapOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"change",e.onOrderChanged),t(window).on("keydown."+this.idPrefix,function(t){if("Escape"===t.key)return e.$editor?e.hideEditor():a.closeDialog(),!1})},destroy:function(){t(window).off("keydown."+this.idPrefix),this.$el.popover("destroy"),this.hideEditor()},getTemplateData:function(){return{renderItem:this.renderPartialHtml.bind(this,h),items:this.serializeItems()}},serializeItems:function(){return this.whOrders.serializeSet(this.model.set,this.plan,this.model.user)},beforeRender:function(){clearTimeout(this.timers.render)},afterRender:function(){var e=this;e.updateSummary(),e.$el.popover({selector:"[data-popover]",container:"body",trigger:"hover",placement:"bottom",html:!0,content:function(){var t=e.whOrders.get(e.$(this).closest(".wh-set-item")[0].dataset.id).getFunc(this.dataset.func);if(t.carts.length||t.problemArea||t.comment)return e.renderPartial(f,{func:t})},template:function(e){return t(e).addClass("wh-set-popover")}}),e.$el.on("show.bs.popover",function(){t(".wh-set-popover").remove()})},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},updateSummary:function(){var t=this,i=0,n=0,a=0,s={fmx:"",kitter:"",platformer:"",packer:""};this.$(".wh-set-item").each(function(){var e=t.whOrders.get(this.dataset.id);if(e&&e.get("date")===t.model.date&&e.get("set")===t.model.set){if("problem"!==e.get("status")){var r=t.plan.orders.get(e.get("order"));i+=e.get("qty"),n+=r?r.get("quantityTodo"):0,a+=Date.parse(e.get("finishTime"))-Date.parse(e.get("startTime"))}e.get("funcs").forEach(function(e){e.user&&(s[e._id]=e.user.label)})}}),t.$id("qty").text(i.toLocaleString()+"/"+n.toLocaleString()),t.$id("time").text(r.toString(a/1e3,!0,!1)),e.forEach(s,function(e,i){var r=e.split(/\s+/),n=r[0];r.length>1&&(n+=" "+r[1].charAt(0)+(r[1].length>1?".":"")),t.$id(i).text(n).attr("title",e)})},hideMenu:function(){d.hide(this)},showUpdateMenu:function(e,t,i,r){var a=this,s=n.isAllowedTo("WH:MANAGE"),o=[];s||"pickup"!==i||"success"!==e.getFunc(t).pickup||e.isDelivered()||!n.isAllowedTo("WH:MANAGE:CARTS")?"platformer"===t&&"pickup"===i&&"pending"===e.getFunc(t).pickup?setTimeout(a.handleUpdate.bind(a),1,e,t,i,"success"):v[i].forEach(function(r){r.manage&&!s||"platformer"===t&&"pickup"===i&&"failure"===r.value||o.push({icon:r.icon,label:a.t("menu:"+i+":"+(r.label||r.value)),handler:a.handleUpdate.bind(a,e,t,i,r.value)})}):o.push({icon:"fa-edit",label:a.t("menu:pickup:editCarts"),handler:a.handleUpdate.bind(a,e,t,"pickup","success",{edit:!0})}),o.length&&d.show(a,r.pageY-17,r.pageX-17,{className:"wh-set-menu",menu:o})},showFixUpdateMenu:function(e,t,i,r){var n=e.getUserFunc(this.model.user);if(n){var a=e.get("picklistDone");switch(i){case"picklistDone":if("pending"===a||e.get("picklistFunc")!==n._id)return;break;case"picklist":if("success"!==a||"pending"===n.status||t!==n._id)return;break;case"pickup":if("pending"===n.picklist||"ignore"===n.pickup||t!==n._id)return}this.showUpdateMenu(e,t,i,r)}},showEditor:function(e,t){var i=this;i.hideEditor();var r=i.$(t).closest(".wh-set-item");r.length&&(e.data("whOrderId",r[0].dataset.id).attr("data-func",t.dataset.func).css({left:t.offsetLeft+"px",top:t.offsetTop+"px"}).appendTo(".modal-content"),e.on("keydown",function(e){if("Escape"===e.key)return i.hideEditor(),!1}),i.$editor=e)},hideEditor:function(){this.$editor&&(this.onOrderChanged(this.whOrders.get(this.$editor.data("whOrderId"))),this.$editor.remove(),this.$editor=null)},handleUpdate:function(e,t,i,r,n){var s=this,o=JSON.parse(JSON.stringify(e.attributes));s.$action(e.id,i,t).removeClass("is-clickable").find(".fa").removeClass().addClass("fa fa-spinner fa-spin"),s.updateHandlers[i].call(s,o,r,t,n||{},function(r){if(s.hideEditor(),!r)return s.onOrderChanged(e);var n=r(JSON.parse(JSON.stringify(e.attributes)),[]),o=s.promised(s.whOrders.act(i,n));o.fail(function(){s.onOrderChanged(e);var t=o.responseJSON&&o.responseJSON.error&&o.responseJSON.error.code||"failure";a.msg.show({type:"error",time:2500,text:s.t.has("update:"+t)?s.t("update:"+t):s.t("update:failure")})}),o.done(function(r){r.order&&e.set(r.order),s.$action(e.id,i,t).hasClass("is-clickable")||s.onOrderChanged(e)})})},$order:function(e){return this.$('.wh-set-item[data-id="'+e+'"]')},$action:function(e,t,i){return this.$order(e).find('.wh-set-action[data-prop="'+t+'"]'+(i?'[data-func="'+i+'"]':""))},updateHandlers:{picklistDone:function(e,t,i,r,n){n(function(e){return{whOrderId:e._id,newValue:t}})},picklist:function(e,t,i,r,n){n(function(e){return{whOrderId:e._id,funcId:i,newValue:t}})},pickup:function(e,t,i,r,n){if("pending"===t)return n(function(e){return{whOrderId:e._id,funcId:i,newValue:t}});if("success"===t)return this.updateHandlers.handlePickupSuccess.call(this,e,i,r,n);if("failure"===t)return this.updateHandlers.handlePickupFailure.call(this,e,i,n);throw new Error("Invalid pickup value.")},handlePickupSuccess:function(t,i,n,a){var s=this,o=s.$('.wh-set-item[data-id="'+t._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+i+'"]'),d={multiline:"packer"===i,carts:t.funcs[u.FUNC_TO_INDEX[i]].carts.join(" "),fmxCarts:[],kitterCarts:[]};"platformer"===i&&(d.fmxCarts=t.funcs[u.FUNC_TO_INDEX.fmx].carts,d.kitterCarts=t.funcs[u.FUNC_TO_INDEX.kitter].carts);var c=s.renderPartial(m,d);c.find(".form-control").on("input",function(e){e.currentTarget.setCustomValidity("")}).on("keydown",function(e){if("TEXTAREA"===e.target.tagName&&"Enter"===e.key)return c.find(".btn").click(),!1}),c.on("click","a[data-cart]",function(i){var r=i.currentTarget.dataset.func,n=i.currentTarget.dataset.cart,a=c.find(".form-control"),s=a.val().toUpperCase().split(/[,\s]+/).filter(function(e){return/^[A-Z0-9]+$/.test(e)});"all"===n?s=s.concat(t.funcs[u.FUNC_TO_INDEX[r]].carts):s.push(n),(s=e.uniq(s)).sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0})}),a.val(s.join(" ")).focus()}),c.on("submit",function(){var n=c.find(".form-control"),o=e.uniq(n.val().toUpperCase().split(/[,\s]+/).filter(function(e){return/^[A-Z0-9]+$/.test(e)}).sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0})}));if(n.val(o.join(" ")),0===o.length)return s.timers.resubmit=setTimeout(function(){c.find(".btn").click()}),!1;var d=s.whOrders.get(t._id).getFunc(i).carts.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0})});if(e.isEqual(o,d))return a();var u=c.find(".form-control, .btn").prop("disabled",!0),l=s.ajax({url:"/old/wh/setCarts?select(date,set,cart)status=in=(completing,completed,delivering)&kind="+("packer"===i?"packaging":"components")+"&cart=in=("+o.join(",")+")"});return l.fail(function(){s.$editor===c&&p(o)}),l.done(function(e){if(s.$editor===c){var i=Date.parse(t.date)+":"+t.set,n=(e.collection||[]).filter(function(e){return Date.parse(e.date)+":"+e.set!==i});if(n.length){var a=s.t("set:cartsEditor:used:error",{count:n.length});n.forEach(function(e,t){t>0&&(a+=", "),a+=" "+s.t("set:cartsEditor:used:cart",{cart:e.cart,date:r.utc.format(e.date,"L"),set:e.set})}),c.find(".form-control")[0].setCustomValidity(a),u.prop("disabled",!1),c.find(".btn").click()}else p(o)}}),!1}),s.showEditor(c,o[0]);var l=c.find(".form-control");function p(e){a(function(t){return{whOrderId:t._id,funcId:i,newValue:"success",carts:e,edit:!!n.edit}})}l[0].selectionStart=9999,l.focus()},handlePickupFailure:function(e,i,r){var n=e.funcs[u.FUNC_TO_INDEX[i]],a=this.$('.wh-set-item[data-id="'+e._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+i+'"]'),s=t(g({problemArea:n.problemArea,comment:n.comment}));s.on("submit",function(){return r(function(e){return{whOrderId:e._id,funcId:i,newValue:"failure",problemArea:s.find("input").val().trim(),comment:s.find("textarea").val().trim()}}),!1}),this.showEditor(s,a[0]),s.find("input").select()}},onCommentChange:function(e){this.plan.orders.get(e.id)&&this.$('.wh-set-item[data-order="'+e.id+'"] .planning-mrp-lineOrders-comment').html(e.getCommentWithIcon())},onOrdersReset:function(e,t){t.reload||this.scheduleRender()},onPsStatusChanged:function(e){var t=this.$('.wh-set-item[data-order="'+e.id+'"]');if(t.length){var r=this.plan.sapOrders.getPsStatus(e.id);t.find(".planning-mrp-list-property-psStatus").attr("title",i("planning","orders:psStatus:"+r)).attr("data-ps-status",r)}},onOrderChanged:function(e){var t=this,i=t.$('.wh-set-item[data-id="'+e.id+'"]');if(i.length){if(this.updateSummary(),e.get("date")!==this.model.date||e.get("set")!==this.model.set)return 1===t.$(".wh-set-item").length?void a.closeDialog():void i.fadeOut("fast",function(){i.remove(),t.$(".wh-set-item").length||a.closeDialog()});i.replaceWith(this.renderPartialHtml(h,{item:e.serializeSet({i:this.whOrders.indexOf(e),delivered:this.whOrders.isSetDelivered(e.get("set"))},this.plan,this.model.user)}))}}})});