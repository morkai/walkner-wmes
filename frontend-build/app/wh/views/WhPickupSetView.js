define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/planning/PlanSapOrder","../WhOrder","app/core/templates/userInfo","app/wh/templates/whSet","app/wh/templates/whSetItem","app/wh/templates/whSetPickupPopover","app/wh/templates/cartsEditor","app/wh/templates/problemEditor","app/wh/templates/printLabels"],function(e,t,i,n,r,a,s,o,d,u,c,l,p,h,f,m,w,g){"use strict";var v={picklistDone:[{value:"success",icon:"fa-thumbs-o-up"},{value:"failure",icon:"fa-thumbs-o-down"},{value:"pending",manage:!0}],picklist:[{value:"require",icon:"fa-check"},{value:"ignore",icon:"fa-times"},{value:"pending",manage:!0}],pickup:[{value:"success",icon:"fa-thumbs-o-up"},{value:"failure",icon:"fa-thumbs-o-down"},{value:"pending",manage:!0}]};return s.extend({template:p,dialogClassName:"wh-set-dialog modal-no-keyboard",modelProperty:"whOrders",events:{"click .is-clickable":function(e){var t=this.whOrders.get(this.$(e.target).closest("tbody").attr("data-id")),i=e.currentTarget.dataset.func,n=e.currentTarget.dataset.prop;this.showUpdateMenu(t,i,n,e)},"contextmenu .wh-set-action":function(){return!1},"mousedown .wh-set-action":function(e){if(!e.currentTarget.classList.contains("is-clickable")){var t=this.whOrders.get(this.$(e.target).closest("tbody").attr("data-id")),i=e.currentTarget.dataset.func,n=e.currentTarget.dataset.prop;this.timers.showFixUpdateMenu=setTimeout(this.showFixUpdateMenu.bind(this,t,i,n,e),500)}},"mouseup .wh-set-action":function(){clearTimeout(this.timers.showFixUpdateMenu),this.timers.showFixUpdateMenu=null},click:function(){this.hideEditor()},'click .btn[data-action="printLabels"]':function(e){var n=this,r=t(g());return r.on("submit",function(){var e=r.data("whOrderId"),t=+r.find("input").val();n.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!0).find(".fa").removeClass("fa-print").addClass("fa-spinner fa-spin"),n.hideEditor();var s=n.whOrders.act("printLabels",{order:e,qty:t,funcId:n.model.user?n.model.user.func:"fmx"});return s.fail(function(){a.msg.show({type:"error",time:2500,text:i("wh","printLabels:failure")})}),s.always(function(){n.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!1).find(".fa").removeClass("fa-spinner fa-spin").addClass("fa-print")}),!1}),n.showEditor(r,n.$(e.target).closest(".wh-set-actions")[0]),r.find("input").select(),!1}},initialize:function(){var e=this;e.listenTo(e.plan.sapOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"change",e.onOrderChanged),t(window).on("keydown."+this.idPrefix,function(t){if("Escape"===t.key)return e.$editor?e.hideEditor():a.closeDialog(),!1})},destroy:function(){t(window).off("keydown."+this.idPrefix),this.$el.popover("destroy"),this.hideEditor()},serialize:function(){return{idPrefix:this.idPrefix,renderItem:h,items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.filter(function(t){return t.get("set")===e.model.set}).map(function(t,i){return t.serializeSet(e.plan,i,e.model.user)})},beforeRender:function(){clearTimeout(this.timers.render)},afterRender:function(){var e=this;e.$el.popover({selector:"[data-popover]",container:"body",trigger:"hover",placement:"bottom",html:!0,content:function(){var t=e.whOrders.get(e.$(this).closest(".wh-set-item")[0].dataset.id).getFunc(this.dataset.func);if(t.carts.length||t.problemArea||t.comment)return e.renderPartial(f,{func:t})},template:function(e){return t(e).addClass("wh-set-popover")}}),e.$el.on("show.bs.popover",function(){t(".wh-set-popover").remove()})},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},hideMenu:function(){d.hide(this)},showUpdateMenu:function(e,t,i,n){var a=this,s=r.isAllowedTo("WH:MANAGE"),o=v[i].map(function(n){return n.manage&&!s?null:{icon:n.icon,label:a.t("menu:"+i+":"+(n.label||n.value)),handler:a.handleUpdate.bind(a,e,t,i,n.value)}}).filter(function(e){return!!e});d.show(a,n.pageY-17,n.pageX-17,{className:"wh-set-menu",menu:o})},showFixUpdateMenu:function(e,t,i,n){var r=e.getUserFunc(this.model.user);if(r){var a=e.get("picklistDone");switch(i){case"picklistDone":if("pending"===a||e.get("picklistFunc")!==r._id)return;break;case"picklist":if("success"!==a||"pending"===r.status||t!==r._id)return;break;case"pickup":if("pending"===r.picklist||"ignore"===r.pickup||t!==r._id)return}this.showUpdateMenu(e,t,i,n)}},showEditor:function(e,t){var i=this;i.hideEditor(),e.data("whOrderId",i.$(t).closest(".wh-set-item")[0].dataset.id).css({left:t.offsetLeft+"px",top:t.offsetTop+"px"}).appendTo(".modal-content"),e.on("keydown",function(e){if("Escape"===e.key)return i.hideEditor(),!1}),i.$editor=e},hideEditor:function(){this.$editor&&(this.onOrderChanged(this.whOrders.get(this.$editor.data("whOrderId"))),this.$editor.remove(),this.$editor=null)},handleUpdate:function(e,t,i,n){var r=this,s=JSON.parse(JSON.stringify(e.attributes));r.$action(e.id,i,t).removeClass("is-clickable").find(".fa").removeClass().addClass("fa fa-spinner fa-spin"),r.updateHandlers[i].call(r,s,n,t,function(n){if(r.hideEditor(),!n)return r.onOrderChanged(e);var s=n(JSON.parse(JSON.stringify(e.attributes)),[]),o=r.promised(r.whOrders.act(i,s));o.fail(function(){r.onOrderChanged(e),a.msg.show({type:"error",time:2500,text:r.t("update:failure")})}),o.done(function(n){n.order&&e.set(n.order),r.$action(e.id,i,t).hasClass("is-clickable")||r.onOrderChanged(e)})})},$order:function(e){return this.$('.wh-set-item[data-id="'+e+'"]')},$action:function(e,t,i){return this.$order(e).find('.wh-set-action[data-prop="'+t+'"]'+(i?'[data-func="'+i+'"]':""))},updateHandlers:{picklistDone:function(e,t,i,n){n(function(e){return{whOrderId:e._id,newValue:t}})},picklist:function(e,t,i,n){n(function(e){return{whOrderId:e._id,funcId:i,newValue:t}})},pickup:function(e,t,i,n){if("pending"===t)return n(function(e){return{whOrderId:e._id,funcId:i,newValue:t}});if("success"===t)return this.updateHandlers.handlePickupSuccess.call(this,e,i,n);if("failure"===t)return this.updateHandlers.handlePickupFailure.call(this,e,i,n);throw new Error("Invalid pickup value.")},handlePickupSuccess:function(e,t,i){var r=this,a=r.$('.wh-set-item[data-id="'+e._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+t+'"]'),s=r.renderPartial(m,{carts:e.funcs[c.FUNC_TO_INDEX[t]].carts.join(" ")});function o(e){i(function(i){return{whOrderId:i._id,funcId:t,newValue:"success",carts:e}})}s.find(".form-control").on("input",function(e){e.currentTarget.setCustomValidity("")}),s.on("submit",function(){var i=s.find(".form-control").val().split(/[^0-9]+/).filter(function(e){return!!e.length}).map(function(e){return+e});if(0===i.length)return o(i),!1;var a=s.find("input, button").prop("disabled",!0),d=r.ajax({url:"/old/wh/setCarts?select(date,set,cart)status=in=(completing,completed,delivering)&kind="+("packer"===t?"packaging":"components")+"&cart=in=("+i.join(",")+")"});return d.fail(function(){r.$editor===s&&o(i)}),d.done(function(t){if(r.$editor===s){var d=Date.parse(e.date)+":"+e.set,u=(t.collection||[]).filter(function(e){return Date.parse(e.date)+":"+e.set!==d});if(u.length){var c=r.t("set:cartsEditor:used:error",{count:u.length});u.forEach(function(e,t){t>0&&(c+=", "),c+=" "+r.t("set:cartsEditor:used:cart",{cart:e.cart,date:n.utc.format(e.date,"L"),set:e.set})}),s.find(".form-control")[0].setCustomValidity(c),a.prop("disabled",!1),s.find(".btn").click()}else o(i)}}),!1}),r.showEditor(s,a[0]),s.find("input").select()},handlePickupFailure:function(e,i,n){var r=e.funcs[c.FUNC_TO_INDEX[i]],a=this.$('.wh-set-item[data-id="'+e._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+i+'"]'),s=t(w({problemArea:r.problemArea,comment:r.comment}));s.on("submit",function(){return n(function(e){return{whOrderId:e._id,funcId:i,newValue:"failure",problemArea:s.find("input").val().trim(),comment:s.find("textarea").val().trim()}}),!1}),this.showEditor(s,a[0]),s.find("input").select()}},onCommentChange:function(e){this.plan.orders.get(e.id)&&this.$('tbody[data-order="'+e.id+'"] .planning-mrp-lineOrders-comment').html(e.getCommentWithIcon())},onOrdersReset:function(e,t){t.reload||this.scheduleRender()},onPsStatusChanged:function(e){var t=this.$('tbody[data-order="'+e.id+'"]');if(t.length){var n=this.plan.sapOrders.getPsStatus(e.id);t.find(".planning-mrp-list-property-psStatus").attr("title",i("planning","orders:psStatus:"+n)).attr("data-ps-status",n)}},onOrderChanged:function(e){var t=this.$('tbody[data-id="'+e.id+'"]');if(t.length)return e.get("set")!==this.model.set?t.fadeOut("fast",function(){t.remove()}):void t.replaceWith(h({item:e.serializeSet(this.plan,this.whOrders.indexOf(e),this.model.user)}))}})});