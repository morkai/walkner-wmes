define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/planning/PlanSapOrder","../WhOrder","app/core/templates/userInfo","app/wh/templates/pickup/set/set","app/wh/templates/pickup/set/setItem","app/wh/templates/pickup/set/setPickupPopover","app/wh/templates/pickup/set/cartsEditor","app/wh/templates/pickup/set/problemEditor","app/wh/templates/pickup/set/printLabels"],function(e,t,i,n,r,a,s,o,d,c,u,l,p,h,f,m,g,w){"use strict";var v={picklistDone:[{value:"success",icon:"fa-thumbs-o-up"},{value:"failure",icon:"fa-thumbs-o-down"},{value:"pending",manage:!0}],picklist:[{value:"require",icon:"fa-check"},{value:"ignore",icon:"fa-times"},{value:"pending",manage:!0}],pickup:[{value:"success",icon:"fa-thumbs-o-up"},{value:"failure",icon:"fa-thumbs-o-down"},{value:"pending",manage:!0}]};return s.extend({template:p,dialogClassName:"wh-set-dialog modal-no-keyboard",modelProperty:"whOrders",events:{"click .is-clickable":function(e){var t=this.whOrders.get(this.$(e.target).closest("tbody").attr("data-id")),i=e.currentTarget.dataset.func,n=e.currentTarget.dataset.prop;this.showUpdateMenu(t,i,n,e)},"contextmenu .wh-set-action":function(){return!1},"mousedown .wh-set-action":function(e){if(!e.currentTarget.classList.contains("is-clickable")){var t=this.whOrders.get(this.$(e.target).closest("tbody").attr("data-id")),i=e.currentTarget.dataset.func,n=e.currentTarget.dataset.prop;this.timers.showFixUpdateMenu=setTimeout(this.showFixUpdateMenu.bind(this,t,i,n,e),500)}},"mouseup .wh-set-action":function(){clearTimeout(this.timers.showFixUpdateMenu),this.timers.showFixUpdateMenu=null},click:function(){this.hideEditor()},'click .btn[data-action="printLabels"]':function(e){var i=this,n=t(w());return n.on("submit",function(){var e=n.data("whOrderId"),t=+n.find("input").val();i.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!0).find(".fa").removeClass("fa-print").addClass("fa-spinner fa-spin"),i.hideEditor();var r=i.whOrders.act("printLabels",{order:e,qty:t,funcId:i.model.user?i.model.user.func:"fmx"});return r.fail(function(){a.msg.show({type:"error",time:2500,text:i.t("printLabels:failure")})}),r.always(function(){i.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!1).find(".fa").removeClass("fa-spinner fa-spin").addClass("fa-print")}),!1}),i.showEditor(n,i.$(e.target).closest(".wh-set-actions")[0]),n.find("input").select(),!1}},initialize:function(){var e=this;e.listenTo(e.plan.sapOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"change",e.onOrderChanged),t(window).on("keydown."+this.idPrefix,function(t){if("Escape"===t.key)return e.$editor?e.hideEditor():a.closeDialog(),!1})},destroy:function(){t(window).off("keydown."+this.idPrefix),this.$el.popover("destroy"),this.hideEditor()},getTemplateData:function(){return{renderItem:this.renderPartialHtml.bind(this,h),items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.filter(function(t){return t.get("set")===e.model.set}).map(function(t,i){return t.serializeSet(e.plan,i,e.model.user)})},beforeRender:function(){clearTimeout(this.timers.render)},afterRender:function(){var e=this;e.$el.popover({selector:"[data-popover]",container:"body",trigger:"hover",placement:"bottom",html:!0,content:function(){var t=e.whOrders.get(e.$(this).closest(".wh-set-item")[0].dataset.id).getFunc(this.dataset.func);if(t.carts.length||t.problemArea||t.comment)return e.renderPartial(f,{func:t})},template:function(e){return t(e).addClass("wh-set-popover")}}),e.$el.on("show.bs.popover",function(){t(".wh-set-popover").remove()})},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},hideMenu:function(){d.hide(this)},showUpdateMenu:function(e,t,i,n){var a=this,s=r.isAllowedTo("WH:MANAGE"),o=[];!s&&"pickup"===i&&"success"===e.getFunc(t).pickup&&"pending"===e.get("distStatus")&&r.isAllowedTo("WH:MANAGE:CARTS")?o.push({icon:"fa-edit",label:a.t("menu:pickup:editCarts"),handler:a.handleUpdate.bind(a,e,t,"pickup","success",{edit:!0})}):v[i].forEach(function(n){n.manage&&!s||"platformer"===t&&"picklist"===i&&"ignore"===n.value||o.push({icon:n.icon,label:a.t("menu:"+i+":"+(n.label||n.value)),handler:a.handleUpdate.bind(a,e,t,i,n.value)})}),o.length&&d.show(a,n.pageY-17,n.pageX-17,{className:"wh-set-menu",menu:o})},showFixUpdateMenu:function(e,t,i,n){var r=e.getUserFunc(this.model.user);if(r){var a=e.get("picklistDone");switch(i){case"picklistDone":if("pending"===a||e.get("picklistFunc")!==r._id)return;break;case"picklist":if("success"!==a||"pending"===r.status||t!==r._id)return;break;case"pickup":if("pending"===r.picklist||"ignore"===r.pickup||t!==r._id)return}this.showUpdateMenu(e,t,i,n)}},showEditor:function(e,t){var i=this;i.hideEditor(),e.data("whOrderId",i.$(t).closest(".wh-set-item")[0].dataset.id).css({left:t.offsetLeft+"px",top:t.offsetTop+"px"}).appendTo(".modal-content"),e.on("keydown",function(e){if("Escape"===e.key)return i.hideEditor(),!1}),i.$editor=e},hideEditor:function(){this.$editor&&(this.onOrderChanged(this.whOrders.get(this.$editor.data("whOrderId"))),this.$editor.remove(),this.$editor=null)},handleUpdate:function(e,t,i,n,r){var s=this,o=JSON.parse(JSON.stringify(e.attributes));s.$action(e.id,i,t).removeClass("is-clickable").find(".fa").removeClass().addClass("fa fa-spinner fa-spin"),s.updateHandlers[i].call(s,o,n,t,r||{},function(n){if(s.hideEditor(),!n)return s.onOrderChanged(e);var r=n(JSON.parse(JSON.stringify(e.attributes)),[]),o=s.promised(s.whOrders.act(i,r));o.fail(function(){s.onOrderChanged(e),a.msg.show({type:"error",time:2500,text:s.t("update:failure")})}),o.done(function(n){n.order&&e.set(n.order),s.$action(e.id,i,t).hasClass("is-clickable")||s.onOrderChanged(e)})})},$order:function(e){return this.$('.wh-set-item[data-id="'+e+'"]')},$action:function(e,t,i){return this.$order(e).find('.wh-set-action[data-prop="'+t+'"]'+(i?'[data-func="'+i+'"]':""))},updateHandlers:{picklistDone:function(e,t,i,n,r){r(function(e){return{whOrderId:e._id,newValue:t}})},picklist:function(e,t,i,n,r){r(function(e){return{whOrderId:e._id,funcId:i,newValue:t}})},pickup:function(e,t,i,n,r){if("pending"===t)return r(function(e){return{whOrderId:e._id,funcId:i,newValue:t}});if("success"===t)return this.updateHandlers.handlePickupSuccess.call(this,e,i,n,r);if("failure"===t)return this.updateHandlers.handlePickupFailure.call(this,e,i,r);throw new Error("Invalid pickup value.")},handlePickupSuccess:function(t,i,r,a){var s=this,o=s.$('.wh-set-item[data-id="'+t._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+i+'"]'),d=s.renderPartial(m,{multiline:"packer"===i,carts:t.funcs[u.FUNC_TO_INDEX[i]].carts.join(" ")});d.find(".form-control").on("input",function(e){e.currentTarget.setCustomValidity("")}).on("keydown",function(e){if("TEXTAREA"===e.target.tagName&&"Enter"===e.key)return d.find(".btn").click(),!1}),d.on("submit",function(){var r=d.find(".form-control"),o=r.val().toUpperCase().split(/[,\s]+/).filter(function(e){return/^[A-Z0-9]+$/.test(e)}).sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0})});if(r.val(o.join(" ")),0===o.length)return s.timers.resubmit=setTimeout(function(){d.find(".btn").click()}),!1;var c=s.whOrders.get(t._id).getFunc(i).carts.sort(function(e,t){return e.localeCompare(t,void 0,{numeric:!0})});if(e.isEqual(o,c))return a();var u=d.find(".form-control, .btn").prop("disabled",!0),p=s.ajax({url:"/old/wh/setCarts?select(date,set,cart)status=in=(completing,completed,delivering)&kind="+("packer"===i?"packaging":"components")+"&cart=in=("+o.join(",")+")"});return p.fail(function(){s.$editor===d&&l(o)}),p.done(function(e){if(s.$editor===d){var i=Date.parse(t.date)+":"+t.set,r=(e.collection||[]).filter(function(e){return Date.parse(e.date)+":"+e.set!==i});if(r.length){var a=s.t("set:cartsEditor:used:error",{count:r.length});r.forEach(function(e,t){t>0&&(a+=", "),a+=" "+s.t("set:cartsEditor:used:cart",{cart:e.cart,date:n.utc.format(e.date,"L"),set:e.set})}),d.find(".form-control")[0].setCustomValidity(a),u.prop("disabled",!1),d.find(".btn").click()}else l(o)}}),!1}),s.showEditor(d,o[0]);var c=d.find(".form-control");function l(e){a(function(t){return{whOrderId:t._id,funcId:i,newValue:"success",carts:e,edit:!!r.edit}})}c[0].selectionStart=9999,c.focus()},handlePickupFailure:function(e,i,n){var r=e.funcs[u.FUNC_TO_INDEX[i]],a=this.$('.wh-set-item[data-id="'+e._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+i+'"]'),s=t(g({problemArea:r.problemArea,comment:r.comment}));s.on("submit",function(){return n(function(e){return{whOrderId:e._id,funcId:i,newValue:"failure",problemArea:s.find("input").val().trim(),comment:s.find("textarea").val().trim()}}),!1}),this.showEditor(s,a[0]),s.find("input").select()}},onCommentChange:function(e){this.plan.orders.get(e.id)&&this.$('tbody[data-order="'+e.id+'"] .planning-mrp-lineOrders-comment').html(e.getCommentWithIcon())},onOrdersReset:function(e,t){t.reload||this.scheduleRender()},onPsStatusChanged:function(e){var t=this.$('tbody[data-order="'+e.id+'"]');if(t.length){var n=this.plan.sapOrders.getPsStatus(e.id);t.find(".planning-mrp-list-property-psStatus").attr("title",i("planning","orders:psStatus:"+n)).attr("data-ps-status",n)}},onOrderChanged:function(e){var t=this.$('tbody[data-id="'+e.id+'"]');if(t.length)return e.get("set")!==this.model.set?t.fadeOut("fast",function(){t.remove()}):void t.replaceWith(this.renderPartialHtml(h,{item:e.serializeSet(this.plan,this.whOrders.indexOf(e),this.model.user)}))}})});