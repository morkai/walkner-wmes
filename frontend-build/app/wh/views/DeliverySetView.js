define(["underscore","app/time","app/viewport","app/core/View","app/wh/WhOrderCollection","app/wh/templates/delivery/set"],function(e,t,r,d,s,i){"use strict";return d.extend({template:i,dialogClassName:"wh-delivery-set-dialog",nlsDomain:"wh",events:{"click #-addCarts":function(){this.addCarts()},"click #-finish":function(){this.finish()}},initialize:function(){this.req=null,this.listenTo(this.model.pendingSetCarts,"add remove",this.onPendingSetCartsChanged)},getTemplateData:function(){return{canManage:!!this.model.personnelId,setCarts:this.serializeSetCarts(),completedSapOrders:this.model.completedSapOrders}},serializeSetCarts:function(){var r=this.model.completedSapOrders;return this.model.setCarts.map(function(d){var s=d.toJSON();return s.date=t.format(s.date,"L"),s.sapOrders={},s.orders.forEach(function(e){s.sapOrders[e.sapOrder]=1}),s.sapOrders=Object.keys(s.sapOrders).map(function(e){return r.includes(e)?'<span class="wh-delivery-is-completed">'+e+"</span>":e}).join(", "),s.redirLine?s.line=s.redirLine+' <i class="fa fa-arrow-right"></i> '+s.line:s.line=e.escape(s.line),s})},afterRender:function(){this.toggleAddCarts()},addCarts:function(){var e=this;e.$id("finish").prop("disabled",!0),e.$id("addCarts").prop("disabled",!0).find(".fa-spinner").removeClass("hidden");var t=e.req=e.promised(s.act(null,"startDelivery",{kind:e.model.setCarts.at(0).get("kind"),personnelId:e.model.personnelId}));e.req.fail(function(){e.trigger("failure",t)}),e.req.done(function(t){Array.isArray(t.setCarts)&&t.setCarts.length&&(e.model.setCarts.add(t.setCarts),t.completedSapOrders&&(e.model.completedSapOrders=e.model.completedSapOrders.concat(t.completedSapOrders)),e.$("tbody").replaceWith(e.renderPartial(i,e.getTemplateData()).find("tbody")),e.$id("completedSapOrders").toggleClass("hidden",0===e.model.completedSapOrders.length))}),e.req.always(function(){e.req=null,e.$id("finish").prop("disabled",!1),e.$id("addCarts").find(".fa-spinner").addClass("hidden"),e.toggleAddCarts()})},finish:function(){var e=this;e.$id("addCarts").prop("disabled",!0),e.$id("finish").prop("disabled",!0).find(".fa-spinner").removeClass("hidden"),e.req=e.promised(s.act(null,"finishDelivery",{setCarts:e.model.setCarts.pluck("_id"),personnelId:e.model.personnelId})),e.req.fail(function(){e.$id("finish").prop("disabled",!1).find(".fa-spinner").addClass("hidden"),e.toggleAddCarts(),e.trigger("failure",e.req)}),e.req.done(function(){r.closeDialog(),e.trigger("success")}),e.req.always(function(){e.req=null})},toggleAddCarts:function(){var e=Date.now()-Date.parse(this.model.setCarts.at(0).get("deliveringAt"))>6e4,t=!!this.model.personnelId,r=t&&!this.req&&this.model.pendingSetCarts.length>0&&!e;this.$id("addCarts").prop("disabled",!r).toggleClass("hidden",!t||e),clearTimeout(this.timers.toggleAddCarts),this.timers.toggleAddCarts=setTimeout(this.toggleAddCarts.bind(this),5e3)},onPendingSetCartsChanged:function(){this.toggleAddCarts()}})});