define(["underscore","app/time","app/viewport","app/core/View","app/wh/WhOrderCollection","app/wh/templates/delivery/set"],function(e,t,i,s,r,d){"use strict";return s.extend({template:d,dialogClassName:"wh-delivery-set-dialog",nlsDomain:"wh",events:{"click #-addCarts":function(){this.addCarts()},"click #-finish":function(){this.finish()}},initialize:function(){this.req=null,this.listenTo(this.model.pendingSetCarts,"add remove",this.onPendingSetCartsChanged)},getTemplateData:function(){return{canManage:!!this.model.personnelId,setCarts:this.serializeSetCarts()}},serializeSetCarts:function(){return this.model.setCarts.map(function(i){var s=i.toJSON();return s.date=t.format(s.date,"L"),s.sapOrders={},s.orders.forEach(function(e){s.sapOrders[e.sapOrder]=1}),s.sapOrders=Object.keys(s.sapOrders).join(", "),s.redirLine?s.line=s.redirLine+' <i class="fa fa-arrow-right"></i> '+s.line:s.line=e.escape(s.line),s})},afterRender:function(){this.toggleAddCarts()},addCarts:function(){var e=this;e.$id("finish").prop("disabled",!0),e.$id("addCarts").prop("disabled",!0).find(".fa-spinner").removeClass("hidden"),e.req=e.promised(r.act(null,"startDelivery",{kind:e.model.setCarts.at(0).get("kind"),personnelId:e.model.personnelId})),e.req.fail(function(){e.trigger("failure",e.req)}),e.req.done(function(t){Array.isArray(t.setCarts)&&t.setCarts.length&&(e.model.setCarts.add(t.setCarts),e.$("tbody").replaceWith(e.renderPartial(d,e.getTemplateData()).find("tbody")))}),e.req.always(function(){e.req=null,e.$id("finish").prop("disabled",!1),e.$id("addCarts").find(".fa-spinner").addClass("hidden"),e.toggleAddCarts()})},finish:function(){var e=this;e.$id("addCarts").prop("disabled",!0),e.$id("finish").prop("disabled",!0).find(".fa-spinner").removeClass("hidden"),e.req=e.promised(r.act(null,"finishDelivery",{setCarts:e.model.setCarts.pluck("_id"),personnelId:e.model.personnelId})),e.req.fail(function(){e.$id("finish").prop("disabled",!1).find(".fa-spinner").addClass("hidden"),e.toggleAddCarts(),e.trigger("failure",e.req)}),e.req.done(function(){i.closeDialog(),e.trigger("success")}),e.req.always(function(){e.req=null})},toggleAddCarts:function(){var e=Date.now()-Date.parse(this.model.setCarts.at(0).get("deliveringAt"))>6e4,t=!!this.model.personnelId,i=t&&!this.req&&this.model.pendingSetCarts.length>0&&!e;this.$id("addCarts").prop("disabled",!i).toggleClass("hidden",!t||e),clearTimeout(this.timers.toggleAddCarts),this.timers.toggleAddCarts=setTimeout(this.toggleAddCarts.bind(this),5e3)},onPendingSetCartsChanged:function(){this.toggleAddCarts()}})});