define(["app/time","app/viewport","app/core/View","app/wh/WhOrderCollection","app/wh/templates/delivery/set"],function(e,i,s,t,r){"use strict";return s.extend({template:r,dialogClassName:"wh-delivery-set-dialog",nlsDomain:"wh",events:{"click #-finish":function(){this.finish()}},initialize:function(){this.listenTo(this.model.setCarts,"change",this.render)},getTemplateData:function(){return{allowFinish:!!this.model.personnelId,setCarts:this.serializeSetCarts()}},serializeSetCarts:function(){return this.model.setCarts.map(function(i){var s=i.toJSON();return s.date=e.format(s.date,"L"),s.sapOrders={},s.orders.forEach(function(e){s.sapOrders[e.sapOrder]=1}),s.sapOrders=Object.keys(s.sapOrders).join(", "),s})},finish:function(){var e=this,s=e.$id("finish");s.prop("disabled",!0).find(".fa-spinner").removeClass("hidden");var r=e.promised(t.act(null,"finishDelivery",{setCarts:e.model.setCarts.pluck("_id"),personnelId:e.model.personnelId}));r.fail(function(){s.prop("disabled",!1).find(".fa-spinner").addClass("hidden"),e.trigger("failure",r)}),r.done(function(){i.closeDialog(),e.trigger("success")})}})});