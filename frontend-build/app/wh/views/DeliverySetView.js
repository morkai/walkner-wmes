define(["underscore","app/time","app/viewport","app/core/View","app/wh/WhOrderCollection","app/wh/templates/delivery/set"],function(e,i,s,r,n,t){"use strict";return r.extend({template:t,dialogClassName:"wh-delivery-set-dialog",nlsDomain:"wh",events:{"click #-finish":function(){this.finish()}},initialize:function(){this.listenTo(this.model.setCarts,"change",this.render)},getTemplateData:function(){return{allowFinish:!!this.model.personnelId,setCarts:this.serializeSetCarts()}},serializeSetCarts:function(){return this.model.setCarts.map(function(s){var r=s.toJSON();return r.date=i.format(r.date,"L"),r.sapOrders={},r.orders.forEach(function(e){r.sapOrders[e.sapOrder]=1}),r.sapOrders=Object.keys(r.sapOrders).join(", "),r.redirLine?r.line=r.redirLine+' <i class="fa fa-arrow-right"></i> '+r.line:r.line=e.escape(r.line),r})},finish:function(){var e=this,i=e.$id("finish");i.prop("disabled",!0).find(".fa-spinner").removeClass("hidden");var r=e.promised(n.act(null,"finishDelivery",{setCarts:e.model.setCarts.pluck("_id"),personnelId:e.model.personnelId}));r.fail(function(){i.prop("disabled",!1).find(".fa-spinner").addClass("hidden"),e.trigger("failure",r)}),r.done(function(){s.closeDialog(),e.trigger("success")})}})});