// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/planning/PlanSapOrder","app/core/templates/userInfo","app/wh/templates/whSet","app/wh/templates/whSetItem","app/planning/templates/lineOrderComments"],function(e,t,n,r,i,s,a,o,d,p,l,h,m,u){"use strict";return a.extend({template:h,dialogClassName:"wh-set-dialog",events:{"mousedown .planning-mrp-lineOrders-comment":function(e){if(0===e.button){var t=this.plan.sapOrders.get(e.currentTarget.parentNode.dataset.order);if(t){var n=t.get("comments");n.length&&this.$(e.currentTarget).popover({trigger:"manual",placement:"left",html:!0,content:u({comments:n.map(function(e){return{user:l({noIp:!0,userInfo:e.user}),time:r.toTagData(e.time).human,text:p.formatCommentWithIcon(e)}})}),template:'<div class="popover planning-mrp-comment-popover"><div class="arrow"></div><div class="popover-content"></div></div>'}).popover("show")}}},"mouseup .planning-mrp-lineOrders-comment":function(e){this.$(e.currentTarget).popover("destroy")}},initialize:function(){var e=this;e.listenTo(e.plan.sapOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"change",e.onOrderChanged)},serialize:function(){return{idPrefix:this.idPrefix,renderItem:m,items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.filter(function(t){return t.get("set")===e.model.set}).map(function(t,n){return t.serialize(e.plan,n)})},beforeRender:function(){clearTimeout(this.timers.render)},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},hideMenu:function(){d.hide(this)},showMenu:function(e){var t=e.currentTarget,n=t.parentNode,r=(this.whOrders.get(n.dataset.id),[]);d.show(this,e.pageY,e.pageX,r)},onCommentChange:function(e){this.plan.orders.get(e.id)&&this.$('tbody[data-order="'+e.id+'"] .planning-mrp-lineOrders-comment').html(e.getCommentWithIcon())},onOrdersReset:function(e,t){t.reload||this.scheduleRender()},onPsStatusChanged:function(e){var t=this.$('tbody[data-order="'+e.id+'"]');if(t.length){var r=this.plan.sapOrders.getPsStatus(e.id);t.find(".planning-mrp-list-property-psStatus").attr("title",n("planning","orders:psStatus:"+r)).attr("data-ps-status",r)}},onOrderChanged:function(e){var t=this.$('tbody[data-id="'+e.id+'"]');if(t.length){var n=this.whOrders.indexOf(e);t.replaceWith(m({item:e.serialize(this.plan,n)}))}}})});