define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/planning/PlanSapOrder","../WhOrder","app/core/templates/userInfo","app/wh/templates/whSet","app/wh/templates/whSetItem","app/wh/templates/whSetPickupPopover","app/wh/templates/cartsEditor","app/wh/templates/problemEditor","app/wh/templates/printLabels"],function(e,t,i,n,r,a,s,d,o,u,p,l,c,h,f,m,w,g){"use strict";var k={picklistDone:[{label:"true",value:!0,icon:"fa-thumbs-o-up"},{label:"false",value:!1,icon:"fa-thumbs-o-down"},{label:"null",value:null,manage:!0}],picklist:[{value:"require",icon:"fa-check"},{value:"ignore",icon:"fa-times"},{value:"pending",manage:!0}],pickup:[{value:"success",icon:"fa-thumbs-o-up"},{value:"failure",icon:"fa-thumbs-o-down"},{value:"pending",manage:!0}]};return s.extend({template:c,dialogClassName:"wh-set-dialog modal-no-keyboard",events:{"click .is-clickable":function(e){var t=this.whOrders.get(this.$(e.target).closest("tbody").attr("data-id")),i=e.currentTarget.dataset.func,n=e.currentTarget.dataset.prop;this.showUpdateMenu(t,i,n,e)},"contextmenu .wh-set-action":function(){return!1},"mousedown .wh-set-action":function(e){if(!e.currentTarget.classList.contains("is-clickable")){var t=this.whOrders.get(this.$(e.target).closest("tbody").attr("data-id")),i=e.currentTarget.dataset.func,n=e.currentTarget.dataset.prop;this.timers.showFixUpdateMenu=setTimeout(this.showFixUpdateMenu.bind(this,t,i,n,e),500)}},"mouseup .wh-set-action":function(){clearTimeout(this.timers.showFixUpdateMenu),this.timers.showFixUpdateMenu=null},click:function(){this.hideEditor()},'click .btn[data-action="printLabels"]':function(e){var n=this,r=t(g());return r.on("submit",function(){var e=r.data("whOrderId"),t=+r.find("input").val();n.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!0).find(".fa").removeClass("fa-print").addClass("fa-spinner fa-spin"),n.hideEditor();var s=n.whOrders.act("printLabels",{order:e,qty:t,func:n.model.user?n.model.user.func:"fmx"});return s.fail(function(){a.msg.show({type:"error",time:2500,text:i("wh","printLabels:failure")})}),s.always(function(){n.$('.wh-set-item[data-id="'+e+'"] .btn[data-action="printLabels"]').prop("disabled",!1).find(".fa").removeClass("fa-spinner fa-spin").addClass("fa-print")}),!1}),n.showEditor(r,n.$(e.target).closest(".wh-set-actions")[0]),r.find("input").select(),!1}},initialize:function(){var e=this;e.listenTo(e.plan.sapOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"reset",e.onOrdersReset),e.listenTo(e.whOrders,"change",e.onOrderChanged),t(window).on("keydown."+this.idPrefix,function(t){if("Escape"===t.key)return e.$editor?e.hideEditor():a.closeDialog(),!1})},destroy:function(){t(window).off("keydown."+this.idPrefix),this.$el.popover("destroy"),this.hideEditor()},serialize:function(){return{idPrefix:this.idPrefix,renderItem:h,items:this.serializeItems()}},serializeItems:function(){var e=this;return e.whOrders.filter(function(t){return t.get("set")===e.model.set}).map(function(t,i){return t.serializeSet(e.plan,i,e.model.user)})},beforeRender:function(){clearTimeout(this.timers.render)},afterRender:function(){var e=this;e.$el.popover({selector:"[data-popover]",container:"body",trigger:"hover",placement:"bottom",html:!0,content:function(){var t=e.whOrders.get(e.$(this).closest(".wh-set-item")[0].dataset.id).getFunc(this.dataset.func);if(t.carts.length||t.problemArea||t.comment)return e.renderPartial(f,{func:t})},template:function(e){return t(e).addClass("wh-set-popover")}}),e.$el.on("show.bs.popover",function(){t(".wh-set-popover").remove()})},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},hideMenu:function(){o.hide(this)},showUpdateMenu:function(e,t,n,a){var s=this,d=r.isAllowedTo("WH:MANAGE"),u=k[n].map(function(r){return r.manage&&!d?null:{icon:r.icon,label:i("wh","menu:"+n+":"+(r.label||r.value)),handler:s.handleUpdate.bind(s,e,t,n,r.value)}}).filter(function(e){return!!e});o.show(s,a.pageY-17,a.pageX-17,u)},showFixUpdateMenu:function(e,t,i,n){var r=e.getUserFunc(this.model.user);if(r){var a=e.get("picklistDone");switch(i){case"picklistDone":if(null===a||e.get("picklistFunc")!==r._id)return;break;case"picklist":if(!a||"pending"===r.status||t!==r._id)return;break;case"pickup":if("pending"===r.picklist||"ignore"===r.pickup||t!==r._id)return}this.showUpdateMenu(e,t,i,n)}},showEditor:function(e,t){var i=this;i.hideEditor(),e.data("whOrderId",i.$(t).closest(".wh-set-item")[0].dataset.id).css({left:t.offsetLeft+"px",top:t.offsetTop+"px"}).appendTo(".modal-content"),e.on("keydown",function(e){if("Escape"===e.key)return i.hideEditor(),!1}),i.$editor=e},hideEditor:function(){this.$editor&&(this.onOrderChanged(this.whOrders.get(this.$editor.data("whOrderId"))),this.$editor.remove(),this.$editor=null)},handleUpdate:function(e,t,n,r){var s=this,d=JSON.parse(JSON.stringify(e.attributes));s.$('.wh-set-item[data-id="'+e.id+'"]').find('.wh-set-action[data-prop="'+n+'"]'+(t?'[data-func="'+t+'"]':"")).removeClass("is-clickable").find(".fa").removeClass().addClass("fa fa-spinner fa-spin"),s.updateHandlers[n].call(s,d,r,t,function(t){if(s.hideEditor(),!t)return s.onOrderChanged(e);var n=[],r=s.promised(s.whOrders.act("updateOrder",{order:t(JSON.parse(JSON.stringify(e.attributes)),n),events:n}));r.fail(function(){s.onOrderChanged(e),a.msg.show({type:"error",time:2500,text:i("wh","update:failure")})}),r.done(function(t){e.set(t.order),e.hasChanged()||s.onOrderChanged(e)})})},updateHandlers:{picklistDone:function(e,t,i,n){n(function(e,i){var n=e.picklistDone;e.picklistDone=t,!1===t?(e.status="problem",e.problem=""):(e.status="started",e.problem="");var r=null;return e.funcs.forEach(function(i){e.picklistFunc===i._id&&(r=i),t?e.picklistFunc===i._id?(i.status="picklist",i.startedAt=new Date):i.user&&(i.status="picklist"):(i.status="pending",i.startedAt=null),i.finishedAt=null,i.picklist="pending",i.pickup="pending",i.carts=[],i.problemArea=""}),i.push({type:"picklistDone",order:e._id,data:{oldValue:n,newValue:t,func:r?r._id:null,user:r?r.user:null}}),e})},picklist:function(e,t,i,n){var r=this;n(function(e,n){var a=e.funcs[p.FUNC_TO_INDEX[i]],s=a.picklist;switch(a.picklist=t,a.carts=[],a.problemArea="",a.comment="",a.finishedAt=null,t){case"pending":a.status="picklist",a.pickup="pending";break;case"require":a.status="pickup",a.pickup="pending";break;case"ignore":a.status="finished",a.pickup="ignore",a.finishedAt=new Date,r.updateHandlers.finalizeOrder.call(r,e)}return n.push({type:"picklist",order:e._id,data:{oldValue:s,newValue:t,func:a._id,user:a.user}}),e})},pickup:function(e,t,i,n){var r=this;switch(t){case"pending":n(function(e,n){var a=e.funcs[p.FUNC_TO_INDEX[i]],s=e.func.pickup;return a.status="pickup",a.pickup="pending",a.carts=[],a.problemArea="",a.comment="",a.finishedAt=null,r.updateHandlers.finalizeOrder.call(r,e),n.push({type:"pickup",order:e._id,data:{oldValue:s,newValue:t,func:a._id,user:a.user}}),e});break;case"success":r.updateHandlers.handlePickupSuccess.call(r,e,i,n);break;case"failure":r.updateHandlers.handlePickupFailure.call(r,e,i,n)}},handlePickupSuccess:function(e,i,n){var r=this,a=r.$('.wh-set-item[data-id="'+e._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+i+'"]'),s=t(m({carts:e.funcs[p.FUNC_TO_INDEX[i]].carts.join(" ")}));s.on("submit",function(){return n(function(e,t){var n=e.funcs[p.FUNC_TO_INDEX[i]],a=n.pickup;return n.status="finished",n.pickup="success",n.carts=s.find(".form-control").val().split(/[^0-9]+/).filter(function(e){return!!e.length}).map(function(e){return+e}),n.problemArea="",n.comment="",n.finishedAt=new Date,r.updateHandlers.finalizeOrder.call(r,e),t.push({type:"pickup",order:e._id,data:{oldValue:a,newValue:n.pickup,func:n._id,user:n.user,carts:n.carts}}),e}),!1}),r.showEditor(s,a[0]),s.find("input").select()},handlePickupFailure:function(e,i,n){var r=this,a=e.funcs[p.FUNC_TO_INDEX[i]],s=r.$('.wh-set-item[data-id="'+e._id+'"]').find('.wh-set-action[data-prop="pickup"][data-func="'+i+'"]'),d=t(w({problemArea:a.problemArea,comment:a.comment}));d.on("submit",function(){return n(function(e,t){var n=e.funcs[p.FUNC_TO_INDEX[i]],a=n.pickup;return n.status="problem",n.pickup="failure",n.carts=[],n.problemArea=d.find("input").val().trim(),n.comment=d.find("textarea").val().trim(),n.finishedAt=new Date,r.updateHandlers.finalizeOrder.call(r,e),t.push({type:"pickup",order:e._id,data:{oldValue:a,newValue:n.pickup,func:n._id,user:n.user,problemArea:n.problemArea,comment:n.comment}}),e}),!1}),r.showEditor(d,s[0]),d.find("input").select()},finalizeOrder:function(e){p.finalizeOrder(e)}},onCommentChange:function(e){this.plan.orders.get(e.id)&&this.$('tbody[data-order="'+e.id+'"] .planning-mrp-lineOrders-comment').html(e.getCommentWithIcon())},onOrdersReset:function(e,t){t.reload||this.scheduleRender()},onPsStatusChanged:function(e){var t=this.$('tbody[data-order="'+e.id+'"]');if(t.length){var n=this.plan.sapOrders.getPsStatus(e.id);t.find(".planning-mrp-list-property-psStatus").attr("title",i("planning","orders:psStatus:"+n)).attr("data-ps-status",n)}},onOrderChanged:function(e){var t=this.$('tbody[data-id="'+e.id+'"]');if(t.length)return e.get("set")!==this.model.set?t.fadeOut("fast",function(){t.remove()}):void t.replaceWith(h({item:e.serializeSet(this.plan,this.whOrders.indexOf(e),this.model.user)}))}})});