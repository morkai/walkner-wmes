define(["underscore","app/time","app/viewport","app/core/View","app/planning/util/shift","app/wh/templates/pickup/blockedPickup"],function(t,e,i,a,n,r){"use strict";return a.extend({template:r,dialogClassName:"wh-blockedPickup-dialog",nlsDomain:"wh",events:{'click h3[data-action="toggleLines"]':function(t){var e=this.$(t.currentTarget),a=e.next();a.toggleClass("hidden"),a.find(".highlight").removeClass("highlight highlight-success"),e.find(".fa").removeClass("fa-chevron-down fa-chevron-right").addClass(a.hasClass("hidden")?"fa-chevron-right":"fa-chevron-down"),i.$dialog&&i.$dialog.modal("adjustBackdrop")},'click td[data-action="setStartTime"]':function(t){var e=this.$(t.currentTarget).closest("tr"),i=e[0].dataset.id,a=this.model.ignoredLines.find(function(t){return t._id===i});this.setStartedPlan(e,a.startTime)},'click td[data-action="setNextShift"]':function(t){var e=this.$(t.currentTarget).closest("tr"),i=e[0].dataset.id,a=this.model.whLines.get(i);this.setStartedPlan(e,a.get("nextShiftAt"))},"submit form":function(t){var a=this,n=a.$(t.currentTarget),r=n.closest("tr")[0].dataset.id,s=n.find(".form-control"),o=e.utc.format(a.model.whLines.get(r).get("startedPlan"),"YYYY-MM-DD"),d=s.val();if(d===o)return!1;var l=n.find(".btn");s.prop("disabled",!0).removeClass("highlight highlight-success"),l.prop("disabled",!0).find(".fa").removeClass("fa-save").addClass("fa-spinner fa-spin");var c=a.ajax({method:"POST",url:"/old/wh;act",data:JSON.stringify({action:"editStartedPlan",data:{line:r,newValue:d,whUser:a.model.whUser}})});return c.fail(function(){var t=c.responseJSON&&c.responseJSON.error||null;t&&a.t.has("blockedPickup:error:"+t.code)||(t={code:"generic"}),i.msg.show({type:"error",time:5e3,text:a.t("blockedPickup:error:"+t.code,t)})}),c.done(function(){a.timers.highlight=setTimeout(function(){s.addClass("highlight highlight-success")},1)}),c.always(function(){s.prop("disabled",!1),l.prop("disabled",!1).find(".fa").removeClass("fa-spinner fa-spin").addClass("fa-save")}),!1}},initialize:function(){this.once("afterRender",function(){this.listenTo(this.model.whLines,"change:startedPlan change:nextShiftAt change:pickup change:components",this.updateLine)})},getTemplateData:function(){var t=this,i=n.getPlanDate(Date.now(),!0),a={},r=[],s=[];return t.model.ignoredLines.forEach(function(i){var n=t.model.whLines.get(i._id);n&&(a[n.id]=!0,i.mrps.sort(function(t,e){return t.localeCompare(e,void 0,{numeric:!0,ignorePunctuation:!0})}),r.push({_id:n.id,mrps:i.mrps.join(", "),completed:e.toString(n.get("pickup").finished.time/1e3,!0,!1),delivered:e.toString(n.get("available").time/1e3,!0,!1),nextShift:n.serializeNextShiftAt(),startTime:e.utc.format(i.startTime,"L, HH:mm:ss"),startedPlan:e.utc.format(n.get("startedPlan"),"YYYY-MM-DD")}))}),t.model.whLines.forEach(function(t){a[t.id]||s.push({_id:t.id,completed:e.toString(t.get("pickup").finished.time/1e3,!0,!1),delivered:e.toString(t.get("available").time/1e3,!0,!1),nextShift:t.serializeNextShiftAt(),startedPlan:e.utc.format(t.get("startedPlan"),"YYYY-MM-DD")})}),t.sortLines(r),t.sortLines(s),{minValue:i.format("YYYY-MM-DD"),maxValue:i.endOf("week").add(7,"days").format("YYYY-MM-DD"),unpaintedLines:t.model.unpaintedLines,ignoredLines:r,remainingLines:s}},afterRender:function(){console.log(this.model)},sortLines:function(t){t.sort(function(t,e){var i=t.mrps?t.mrps.localeCompare(e.mrps,void 0,{numeric:!0,ignorePunctuation:!0}):0;return i||(i=t._id.localeCompare(e._id,void 0,{numeric:!0,ignorePunctuation:!0})),i})},updateLine:function(i){var a=this.$('tr[data-id="'+t.escape(i.id)+'"]');a.length&&(a.find('[data-prop="completed"]').text(e.toString(i.get("pickup").finished.time/1e3,!0,!1)),a.find('[data-prop="delivered"]').text(e.toString(i.get("available").time/1e3,!0,!1)),a.find('[data-prop="nextShift"]').text(i.serializeNextShiftAt()),a.find(".form-control").val(e.utc.format(i.get("startedPlan"),"YYYY-MM-DD")))},setStartedPlan:function(t,e){var i=t.find(".form-control");if(!i.prop("disabled")){var a=n.getPlanDate(e,!1);a.isValid()&&(i.val(a.format("YYYY-MM-DD")).removeClass("highlight highlight-success"),this.timers.highlight=setTimeout(function(){i.addClass("highlight")},1))}}})});