define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","app/planning/util/contextMenu","../WhOrder","../WhOrderCollection","./WhProblemChatView","app/wh/templates/problemDetails","app/wh/templates/problemDetailsOrderInfo","app/wh/templates/problemDetailsFuncs","app/wh/templates/problemCancelOrderEditor","app/wh/templates/problemSolveProblemEditor"],function(e,t,n,i,r,a,o,l,s,d,c,p,m,u,h,f,g,b,v,w){"use strict";return o.extend({dialogClassName:"wh-problems-dialog modal-no-keyboard",template:f,events:{"click .wh-problems-solvable":"showProblemMenu","contextmenu .wh-problems-solvable":"showProblemMenu"},initialize:function(){var e=this,n=i.utc.format(e.model.get("date"),"YYYY-MM-DD");e.plan=new s({_id:n},{displayOptions:c.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),settings:d.fromDate(n),minMaxDates:!1,pceTimes:!1}),e.chatView=new h({model:e.model,plan:e.plan}),e.setView("#-chat",e.chatView),e.listenTo(e.model,"remove",e.onOrderRemoved),e.listenTo(e.model,"change",e.onOrderChanged),e.listenTo(e.model,"change:status",e.onOrderStatusChanged),e.once("afterRender",e.loadPlan),t(window).on("keydown."+this.idPrefix,function(n){if("Escape"===n.key)return t(".wh-problems-editor").length?e.hideEditor():a.closeDialog(),!1})},destroy:function(){t(window).off("keydown."+this.idPrefix),this.hideEditor()},getTemplateData:function(){return{renderOrderInfo:g,renderFuncs:b,whOrder:this.model.serialize(this.plan,0,this.whOrders.getFilters(this.plan)),funcs:{lp10:this.model.serializeProblemFunc("lp10"),fmx:this.model.serializeProblemFunc("fmx"),kitter:this.model.serializeProblemFunc("kitter"),packer:this.model.serializeProblemFunc("packer")}}},beforeRender:function(){this.hideEditor()},loadPlan:function(){var e=this,n=e.model.get("order"),i=e.ajax({url:"/planning/sapOrders/"+e.plan.id+"?orders="+n}),r=e.ajax({url:"/planning/planOrders/"+e.plan.id+"?orders="+n});i.done(function(t){t.totalCount&&e.plan.sapOrders.add(t.collection[0])}),r.done(function(t){t.totalCount&&e.plan.orders.add(t.collection[0])}),t.when(e.promised(e.plan.settings.fetch({})),i,r).done(function(){e.renderOrderInfo()})},showProblemMenu:function(e){e.preventDefault(),this.hideEditor();var t=this.$(e.target).closest(".wh-problems-func").attr("data-func"),n={className:"wh-problems-menu",menu:[{icon:"fa-thumbs-up",label:this.t("problem:menu:solveProblem"),handler:this.solveProblem.bind(this,t)},{icon:"fa-times",label:this.t("problem:menu:cancelOrder"),handler:this.cancelOrder.bind(this)}]};p.show(this,e.pageY,e.pageX,n)},solveProblem:function(e,t){var n=this,i=n.renderPartial(w,{carts:"lp10"!==e,comment:n.t("problem:editor:solveProblem:message",{qty:n.model.get("qty"),line:n.model.get("line"),func:e})});if(i.css({top:t.pageY-("lp10"===e?0:34)-74-22.5+"px",left:t.pageX-100+"px"}),i.on("submit",function(){var t=i.find("input, textarea, button").prop("disabled",!0),r=(i.find('[name="carts"]').val()||"").split(/[^0-9]+/).filter(function(e){return!!e.length}).map(function(e){return+e}),o=i.find('[name="comment"]').val();a.msg.saving();var l=JSON.parse(JSON.stringify(n.model.attributes));if("lp10"===e)l.picklistDone=!0,l.funcs.forEach(function(e){e.user&&(e.status="picklist",e.startedAt=l.startedAt)});else{if(!r.length)return i.find('[name="carts"]').select(),!1;var s=l.funcs[m.FUNC_TO_INDEX[e]];s.status="finished",s.pickup="success",s.carts=r,s.finishedAt=new Date}m.finalizeOrder(l);var d=u.act(n.model.get("date"),"updateOrder",{order:l,events:[{type:"problemResolved",order:l._id,data:{func:e,carts:r}}]});return d.fail(function(){a.msg.savingFailed(),t.prop("disabled",!1)}),d.done(function(){a.msg.saved(),n.hideEditor(),n.chatView.send(o)}),!1}),i.find(".btn-default").on("click",n.hideEditor.bind(n)),i.appendTo(document.body),"lp10"===e){var r=i.find('[name="comment"]')[0];r.setSelectionRange(r.value.length,r.value.length),r.focus()}else i.find('[name="carts"]').focus()},cancelOrder:function(e){var t=this,n=t.renderPartial(v,{comment:t.t("problem:editor:cancelOrder:message",{qty:t.model.get("qty"),line:t.model.get("line")})});n.css({top:e.pageY-74-22.5+"px",left:e.pageX-100+"px"}),n.find(".btn-primary").on("click",function(){var e=n.find("input, textarea, button").prop("disabled",!0),i=n.find("textarea").val();a.msg.saving();var r=u.act(t.model.get("date"),"cancelOrders",{orders:[t.model.id]});r.done(function(){a.msg.saved(),t.hideEditor(),t.chatView.send(i)}),r.fail(function(){a.msg.savingFailed(),e.prop("disabled",!1)})}),n.find(".btn-default").on("click",t.hideEditor.bind(t)),n.appendTo(document.body);var i=n.find("textarea")[0];i.setSelectionRange(i.value.length,i.value.length),i.focus()},hideEditor:function(){var e=t(".wh-problems-editor");return!!e.length&&(e.remove(),!0)},renderOrderInfo:function(){this.$id("orderInfo").html(g(this.serialize()))},renderFuncs:function(){this.hideEditor(),this.$id("funcs").html(b(this.serialize()))},onOrderRemoved:function(){this.renderFuncs()},onOrderChanged:function(){this.renderFuncs()},onOrderStatusChanged:function(){this.$id("orderInfo").toggleClass("is-cancelled","cancelled"===this.model.get("status"))},onDialogShown:function(){this.chatView.onDialogShown()}})});