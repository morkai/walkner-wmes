define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","app/planning/util/contextMenu","../WhOrder","../WhOrderCollection","./WhProblemChatView","app/wh/templates/problems/details","app/wh/templates/problems/detailsOrderInfo","app/wh/templates/problems/detailsFuncs","app/wh/templates/problems/resetOrderEditor","app/wh/templates/problems/solveProblemEditor"],function(e,n,t,r,o,i,a,l,d,s,p,c,m,h,u,f,g,b,v,w){"use strict";return a.extend({dialogClassName:"wh-problems-dialog modal-no-keyboard",template:f,events:{"click .wh-problems-solvable":"showProblemMenu","contextmenu .wh-problems-solvable":"showProblemMenu"},initialize:function(){var e=this,t=r.utc.format(e.model.get("date"),"YYYY-MM-DD");e.plan=new d({_id:t},{displayOptions:p.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),settings:s.fromDate(t),minMaxDates:!1,pceTimes:!1}),e.chatView=new u({model:e.model,plan:e.plan}),e.setView("#-chat",e.chatView),e.listenTo(e.model,"remove",e.onOrderRemoved),e.listenTo(e.model,"change",e.onOrderChanged),e.listenTo(e.model,"change:status",e.onOrderStatusChanged),e.once("afterRender",e.loadPlan),n(window).on("keydown."+this.idPrefix,function(t){if("Escape"===t.key)return n(".wh-problems-editor").length?e.hideEditor():i.closeDialog(),!1})},destroy:function(){n(window).off("keydown."+this.idPrefix),this.hideEditor()},getTemplateData:function(){return{renderOrderInfo:g,renderFuncs:b,whOrder:this.model.serialize(this.plan,0,this.whOrders.getFilters(this.plan)),funcs:this.model.serializeProblemFuncs()}},beforeRender:function(){this.hideEditor()},loadPlan:function(){var e=this,t=e.model.get("order"),r=e.ajax({url:"/planning/sapOrders/"+e.plan.id+"?orders="+t}),o=e.ajax({url:"/planning/planOrders/"+e.plan.id+"?orders="+t});r.done(function(n){n.totalCount&&e.plan.sapOrders.add(n.collection[0])}),o.done(function(n){n.totalCount&&e.plan.orders.add(n.collection[0])}),n.when(e.promised(e.plan.settings.fetch({})),r,o).done(function(){e.renderOrderInfo()})},showProblemMenu:function(e){e.preventDefault(),this.hideEditor();var n={className:"wh-problems-menu",menu:[{icon:"fa-thumbs-up",label:this.t("problem:menu:resetOrder"),handler:this.resetOrder.bind(this,!1)},{icon:"fa-times",label:this.t("problem:menu:cancelOrder"),handler:this.resetOrder.bind(this,!0)}]};c.show(this,e.pageY,e.pageX,n)},solveProblem:function(e,n){var t=this,r=t.renderPartial(w,{carts:"lp10"!==e,comment:t.t("problem:editor:solveProblem:message",{qty:t.model.get("qty"),line:t.model.get("line"),func:e})});if(r.css({top:n.pageY-("lp10"===e?0:34)-74-22.5+"px",left:n.pageX-100+"px"}),r.on("submit",function(){var n=r.find("input, textarea, button").prop("disabled",!0),o=r.find('[name="carts"]'),a=(o.val()||"").toUpperCase().split(/[^0-9A-Z]+/).filter(function(e){return!!e.length}),l=r.find('[name="comment"]').val().trim();if("lp10"!==e&&!a.length)return n.prop("disabled",!1),o.select(),!1;i.msg.saving();var d=h.act(t.model.get("date"),"solveProblem",{whOrderId:t.model.id,funcId:e,carts:a});return d.fail(function(){i.msg.savingFailed(),n.prop("disabled",!1)}),d.done(function(){i.msg.saved(),t.hideEditor(),t.chatView.send(l)}),!1}),r.find(".btn-default").on("click",t.hideEditor.bind(t)),r.appendTo(document.body),"lp10"===e){var o=r.find('[name="comment"]')[0];o.setSelectionRange(o.value.length,o.value.length),o.focus()}else r.find('[name="carts"]').focus()},resetOrder:function(e,n){var t=this,r=e?"cancel":"reset",o=t.renderPartial(v,{yes:t.t("problem:editor:"+r+"Order:yes"),no:t.t("problem:editor:"+r+"Order:no"),comment:t.t("problem:editor:"+r+"Order:message",{qty:t.model.get("qty"),line:t.model.get("line")})});o.css({top:n.pageY-74-22.5+"px",left:n.pageX-100+"px"}),o.find(".btn-primary").on("click",function(){var n=o.find("input, textarea, button").prop("disabled",!0),r=o.find("textarea").val();i.msg.saving();var a=h.act(t.model.get("date"),"resetOrders",{cancel:e,orders:[t.model.id]});a.done(function(){i.msg.saved(),t.hideEditor(),t.chatView.send(r)}),a.fail(function(){i.msg.savingFailed(),n.prop("disabled",!1)})}),o.find(".btn-default").on("click",t.hideEditor.bind(t)),o.appendTo(document.body);var a=o.find("textarea")[0];a.setSelectionRange(a.value.length,a.value.length),a.focus()},hideEditor:function(){var e=n(".wh-problems-editor");return!!e.length&&(e.remove(),!0)},renderOrderInfo:function(){this.$id("orderInfo").html(g(this.serialize()))},renderFuncs:function(){this.hideEditor(),this.$id("funcs").html(b(this.serialize()))},onOrderRemoved:function(){this.renderFuncs()},onOrderChanged:function(){this.renderFuncs()},onOrderStatusChanged:function(){this.$id("orderInfo").toggleClass("is-cancelled","cancelled"===this.model.get("status"))},onDialogShown:function(){this.chatView.onDialogShown()}})});