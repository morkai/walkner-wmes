define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","app/planning/util/contextMenu","../WhOrder","../WhOrderCollection","./WhProblemChatView","app/wh/templates/problems/details","app/wh/templates/problems/detailsOrderInfo","app/wh/templates/problems/detailsFuncs","app/wh/templates/problems/resetOrderEditor","app/wh/templates/problems/solveProblemEditor"],function(e,t,n,r,o,i,a,l,s,d,p,m,c,h,u,f,g,b,v,w){"use strict";return a.extend({dialogClassName:"wh-problems-dialog modal-no-keyboard",template:f,events:{"click .wh-problems-solvable":"showProblemMenu","contextmenu .wh-problems-solvable":"showProblemMenu"},initialize:function(){var e=this,n=r.utc.format(e.model.get("date"),"YYYY-MM-DD");e.plan=new s({_id:n},{displayOptions:p.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),settings:d.fromDate(n),minMaxDates:!1}),e.chatView=new u({model:e.model,plan:e.plan}),e.setView("#-chat",e.chatView),e.listenTo(e.model,"remove",e.onOrderRemoved),e.listenTo(e.model,"change",e.onOrderChanged),e.listenTo(e.model,"change:status",e.onOrderStatusChanged),e.once("afterRender",e.loadPlan),t(window).on("keydown."+this.idPrefix,function(n){if("Escape"===n.key)return t(".wh-problems-editor").length?e.hideEditor():i.closeDialog(),!1})},destroy:function(){t(window).off("keydown."+this.idPrefix),this.hideEditor()},getTemplateData:function(){return{renderOrderInfo:g,renderFuncs:b,whOrder:this.model.serialize(this.plan,0,this.whOrders.getFilters(this.plan)),funcs:this.model.serializeProblemFuncs()}},beforeRender:function(){this.hideEditor()},loadPlan:function(){var e=this,n=e.model.get("order"),r=e.ajax({url:"/planning/sapOrders/"+e.plan.id+"?orders="+n}),o=e.ajax({url:"/planning/planOrders/"+e.plan.id+"?orders="+n});r.done(function(t){t.totalCount&&e.plan.sapOrders.add(t.collection[0])}),o.done(function(t){t.totalCount&&e.plan.orders.add(t.collection[0])}),t.when(e.promised(e.plan.settings.fetch({})),r,o).done(function(){e.renderOrderInfo()})},showProblemMenu:function(e){e.preventDefault(),this.hideEditor();var t=this.$(e.target).closest(".wh-problems-func").attr("data-func"),n=[];this.model.get("set")&&("platformer"===t||"packer"===t||"painter"===t||"kitter"===t&&"ignore"===this.model.getFunc("platformer").picklist)&&n.push({icon:"fa-thumbs-up",label:this.t("problem:menu:solveProblem"),handler:this.solveProblem.bind(this,t)}),n.push({icon:"fa-eraser",label:this.t("problem:menu:resetOrder"),handler:this.resetOrder.bind(this,!1)},{icon:"fa-times",label:this.t("problem:menu:cancelOrder"),handler:this.resetOrder.bind(this,!0)});var r={className:"wh-problems-menu",menu:n};m.show(this,e.pageY-24,e.pageX-24,r)},solveProblem:function(e,t){var n=this,r=n.renderPartial(w,{carts:"lp10"!==e,comment:n.t("problem:editor:solveProblem:message",{qty:n.model.get("qty"),line:n.model.get("line"),func:e})});if(r.css({top:t.pageY-("lp10"===e?0:34)-74-22.5+"px",left:t.pageX-100+"px"}),r.on("submit",function(){var t=r.find("input, textarea, button").prop("disabled",!0),o=r.find('[name="carts"]'),a=(o.val()||"").toUpperCase().split(/[^0-9A-Z]+/).filter(function(e){return!!e.length}),l=r.find('[name="comment"]').val().trim();if("lp10"!==e&&!a.length)return t.prop("disabled",!1),o.select(),!1;i.msg.saving();var s=h.act(n.model.get("date"),"solveProblem",{whOrderId:n.model.id,funcId:e,carts:a});return s.fail(function(){i.msg.savingFailed(),t.prop("disabled",!1)}),s.done(function(){i.msg.saved(),n.hideEditor(),n.chatView.send(l)}),!1}),r.find(".btn-default").on("click",n.hideEditor.bind(n)),r.appendTo(document.body),"lp10"===e){var o=r.find('[name="comment"]')[0];o.setSelectionRange(o.value.length,o.value.length),o.focus()}else r.find('[name="carts"]').focus()},resetOrder:function(e,t){var n=this,r=e?"cancel":"reset",o=n.renderPartial(v,{yes:n.t("problem:editor:"+r+"Order:yes"),no:n.t("problem:editor:"+r+"Order:no"),comment:n.t("problem:editor:"+r+"Order:message",{qty:n.model.get("qty"),line:n.model.get("line")})});o.css({top:t.pageY-74-22.5+"px",left:t.pageX-100+"px"}),o.find(".btn-primary").on("click",function(){var t=o.find("input, textarea, button").prop("disabled",!0),r=o.find("textarea").val().trim();i.msg.saving();var a=h.act(n.model.get("date"),"resetOrders",{cancel:e,orders:[n.model.id]});a.done(function(){i.msg.saved(),n.hideEditor(),r.length&&n.chatView.send(r)}),a.fail(function(){var e=a.responseJSON&&a.responseJSON.error&&a.responseJSON.error.code||null;n.t.has("problem:msg:"+e)?(i.msg.saved(),i.msg.show({type:"error",time:3e3,text:n.t("problem:msg:"+e)})):i.msg.savingFailed(),t.prop("disabled",!1)})}),o.find(".btn-default").on("click",n.hideEditor.bind(n)),o.appendTo(document.body);var a=o.find("textarea")[0];a.setSelectionRange(a.value.length,a.value.length),a.focus()},hideEditor:function(){var e=t(".wh-problems-editor");return!!e.length&&(e.remove(),!0)},renderOrderInfo:function(){this.$id("orderInfo").html(g(this.serialize()))},renderFuncs:function(){this.hideEditor(),this.$id("funcs").html(b(this.serialize()))},onOrderRemoved:function(){this.renderFuncs()},onOrderChanged:function(){this.renderFuncs()},onOrderStatusChanged:function(){this.$id("orderInfo").toggleClass("is-cancelled","cancelled"===this.model.get("status"))},onDialogShown:function(){this.chatView.onDialogShown()}})});