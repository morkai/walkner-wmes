define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","app/planning/util/contextMenu","../WhOrder","../WhOrderCollection","./WhProblemChatView","app/wh/templates/problems/details","app/wh/templates/problems/detailsOrderInfo","app/wh/templates/problems/detailsFuncs","app/wh/templates/problems/resetOrderEditor","app/wh/templates/problems/solveProblemEditor"],function(e,t,n,r,i,o,a,l,d,s,p,m,c,h,u,f,g,b,v,w){"use strict";return a.extend({dialogClassName:"wh-problems-dialog modal-no-keyboard",template:f,events:{"click .wh-problems-solvable":"showProblemMenu","contextmenu .wh-problems-solvable":"showProblemMenu"},initialize:function(){var e=this,n=r.utc.format(e.model.get("date"),"YYYY-MM-DD");e.plan=new d({_id:n},{displayOptions:p.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),settings:s.fromDate(n),minMaxDates:!1,pceTimes:!1}),e.chatView=new u({model:e.model,plan:e.plan}),e.setView("#-chat",e.chatView),e.listenTo(e.model,"remove",e.onOrderRemoved),e.listenTo(e.model,"change",e.onOrderChanged),e.listenTo(e.model,"change:status",e.onOrderStatusChanged),e.once("afterRender",e.loadPlan),t(window).on("keydown."+this.idPrefix,function(n){if("Escape"===n.key)return t(".wh-problems-editor").length?e.hideEditor():o.closeDialog(),!1})},destroy:function(){t(window).off("keydown."+this.idPrefix),this.hideEditor()},getTemplateData:function(){return{renderOrderInfo:g,renderFuncs:b,whOrder:this.model.serialize(this.plan,0,this.whOrders.getFilters(this.plan)),funcs:{lp10:this.model.serializeProblemFunc("lp10"),fmx:this.model.serializeProblemFunc("fmx"),kitter:this.model.serializeProblemFunc("kitter"),platformer:this.model.serializeProblemFunc("platformer"),packer:this.model.serializeProblemFunc("packer")}}},beforeRender:function(){this.hideEditor()},loadPlan:function(){var e=this,n=e.model.get("order"),r=e.ajax({url:"/planning/sapOrders/"+e.plan.id+"?orders="+n}),i=e.ajax({url:"/planning/planOrders/"+e.plan.id+"?orders="+n});r.done(function(t){t.totalCount&&e.plan.sapOrders.add(t.collection[0])}),i.done(function(t){t.totalCount&&e.plan.orders.add(t.collection[0])}),t.when(e.promised(e.plan.settings.fetch({})),r,i).done(function(){e.renderOrderInfo()})},showProblemMenu:function(e){e.preventDefault(),this.hideEditor();var t={className:"wh-problems-menu",menu:[{icon:"fa-thumbs-up",label:this.t("problem:menu:resetOrder"),handler:this.resetOrder.bind(this,!1)},{icon:"fa-times",label:this.t("problem:menu:cancelOrder"),handler:this.resetOrder.bind(this,!0)}]};m.show(this,e.pageY,e.pageX,t)},solveProblem:function(e,t){var n=this,r=n.renderPartial(w,{carts:"lp10"!==e,comment:n.t("problem:editor:solveProblem:message",{qty:n.model.get("qty"),line:n.model.get("line"),func:e})});if(r.css({top:t.pageY-("lp10"===e?0:34)-74-22.5+"px",left:t.pageX-100+"px"}),r.on("submit",function(){var t=r.find("input, textarea, button").prop("disabled",!0),i=r.find('[name="carts"]'),a=(i.val()||"").toUpperCase().split(/[^0-9A-Z]+/).filter(function(e){return!!e.length}),l=r.find('[name="comment"]').val().trim();if("lp10"!==e&&!a.length)return t.prop("disabled",!1),i.select(),!1;o.msg.saving();var d=h.act(n.model.get("date"),"solveProblem",{whOrderId:n.model.id,funcId:e,carts:a});return d.fail(function(){o.msg.savingFailed(),t.prop("disabled",!1)}),d.done(function(){o.msg.saved(),n.hideEditor(),n.chatView.send(l)}),!1}),r.find(".btn-default").on("click",n.hideEditor.bind(n)),r.appendTo(document.body),"lp10"===e){var i=r.find('[name="comment"]')[0];i.setSelectionRange(i.value.length,i.value.length),i.focus()}else r.find('[name="carts"]').focus()},resetOrder:function(e,t){var n=this,r=e?"cancel":"reset",i=n.renderPartial(v,{yes:n.t("problem:editor:"+r+"Order:yes"),no:n.t("problem:editor:"+r+"Order:no"),comment:n.t("problem:editor:"+r+"Order:message",{qty:n.model.get("qty"),line:n.model.get("line")})});i.css({top:t.pageY-74-22.5+"px",left:t.pageX-100+"px"}),i.find(".btn-primary").on("click",function(){var t=i.find("input, textarea, button").prop("disabled",!0),r=i.find("textarea").val();o.msg.saving();var a=h.act(n.model.get("date"),"resetOrders",{cancel:e,orders:[n.model.id]});a.done(function(){o.msg.saved(),n.hideEditor(),n.chatView.send(r)}),a.fail(function(){o.msg.savingFailed(),t.prop("disabled",!1)})}),i.find(".btn-default").on("click",n.hideEditor.bind(n)),i.appendTo(document.body);var a=i.find("textarea")[0];a.setSelectionRange(a.value.length,a.value.length),a.focus()},hideEditor:function(){var e=t(".wh-problems-editor");return!!e.length&&(e.remove(),!0)},renderOrderInfo:function(){this.$id("orderInfo").html(g(this.serialize()))},renderFuncs:function(){this.hideEditor(),this.$id("funcs").html(b(this.serialize()))},onOrderRemoved:function(){this.renderFuncs()},onOrderChanged:function(){this.renderFuncs()},onOrderStatusChanged:function(){this.$id("orderInfo").toggleClass("is-cancelled","cancelled"===this.model.get("status"))},onDialogShown:function(){this.chatView.onDialogShown()}})});