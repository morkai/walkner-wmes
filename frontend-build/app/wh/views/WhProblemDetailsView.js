define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","app/planning/util/contextMenu","../WhOrder","../WhOrderCollection","./WhProblemChatView","app/wh/templates/problemDetails","app/wh/templates/problemDetailsOrderInfo","app/wh/templates/problemDetailsFuncs","app/wh/templates/problemCancelOrderEditor","app/wh/templates/problemSolveProblemEditor"],function(e,n,t,i,o,r,a,l,d,s,p,c,m,h,u,f,g,b,v,w){"use strict";return a.extend({dialogClassName:"wh-problems-dialog modal-no-keyboard",template:f,events:{"click .wh-problems-solvable":"showProblemMenu","contextmenu .wh-problems-solvable":"showProblemMenu"},initialize:function(){var e=this,t=i.utc.format(e.model.get("date"),"YYYY-MM-DD");e.plan=new d({_id:t},{displayOptions:p.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),settings:s.fromDate(t),minMaxDates:!1,pceTimes:!1}),e.chatView=new u({model:e.model,plan:e.plan}),e.setView("#-chat",e.chatView),e.listenTo(e.model,"remove",e.onOrderRemoved),e.listenTo(e.model,"change",e.onOrderChanged),e.listenTo(e.model,"change:status",e.onOrderStatusChanged),e.once("afterRender",e.loadPlan),n(window).on("keydown."+this.idPrefix,function(t){if("Escape"===t.key)return n(".wh-problems-editor").length?e.hideEditor():r.closeDialog(),!1})},destroy:function(){n(window).off("keydown."+this.idPrefix),this.hideEditor()},getTemplateData:function(){return{renderOrderInfo:g,renderFuncs:b,whOrder:this.model.serialize(this.plan,0,this.whOrders.getFilters(this.plan)),funcs:{lp10:this.model.serializeProblemFunc("lp10"),fmx:this.model.serializeProblemFunc("fmx"),kitter:this.model.serializeProblemFunc("kitter"),packer:this.model.serializeProblemFunc("packer")}}},beforeRender:function(){this.hideEditor()},loadPlan:function(){var e=this,t=e.model.get("order"),i=e.ajax({url:"/planning/sapOrders/"+e.plan.id+"?orders="+t}),o=e.ajax({url:"/planning/planOrders/"+e.plan.id+"?orders="+t});i.done(function(n){n.totalCount&&e.plan.sapOrders.add(n.collection[0])}),o.done(function(n){n.totalCount&&e.plan.orders.add(n.collection[0])}),n.when(e.promised(e.plan.settings.fetch({})),i,o).done(function(){e.renderOrderInfo()})},showProblemMenu:function(e){e.preventDefault(),this.hideEditor();var n=this.$(e.target).closest(".wh-problems-func").attr("data-func"),t={className:"wh-problems-menu",menu:[{icon:"fa-thumbs-up",label:this.t("problem:menu:solveProblem"),handler:this.solveProblem.bind(this,n)},{icon:"fa-times",label:this.t("problem:menu:cancelOrder"),handler:this.cancelOrder.bind(this)}]};c.show(this,e.pageY,e.pageX,t)},solveProblem:function(e,n){var t=this,i=t.renderPartial(w,{carts:"lp10"!==e,comment:t.t("problem:editor:solveProblem:message",{qty:t.model.get("qty"),line:t.model.get("line"),func:e})});if(i.css({top:n.pageY-("lp10"===e?0:34)-74-22.5+"px",left:n.pageX-100+"px"}),i.on("submit",function(){var n=i.find("input, textarea, button").prop("disabled",!0),o=i.find('[name="carts"]'),a=(o.val()||"").toUpperCase().split(/[^0-9A-Z]+/).filter(function(e){return!!e.length}),l=i.find('[name="comment"]').val().trim();if("lp10"!==e&&!a.length)return n.prop("disabled",!1),o.select(),!1;r.msg.saving();var d=h.act(t.model.get("date"),"solveProblem",{whOrderId:t.model.id,funcId:e,carts:a});return d.fail(function(){r.msg.savingFailed(),n.prop("disabled",!1)}),d.done(function(){r.msg.saved(),t.hideEditor(),t.chatView.send(l)}),!1}),i.find(".btn-default").on("click",t.hideEditor.bind(t)),i.appendTo(document.body),"lp10"===e){var o=i.find('[name="comment"]')[0];o.setSelectionRange(o.value.length,o.value.length),o.focus()}else i.find('[name="carts"]').focus()},cancelOrder:function(e){var n=this,t=n.renderPartial(v,{comment:n.t("problem:editor:cancelOrder:message",{qty:n.model.get("qty"),line:n.model.get("line")})});t.css({top:e.pageY-74-22.5+"px",left:e.pageX-100+"px"}),t.find(".btn-primary").on("click",function(){var e=t.find("input, textarea, button").prop("disabled",!0),i=t.find("textarea").val();r.msg.saving();var o=h.act(n.model.get("date"),"resetOrders",{cancel:!0,orders:[n.model.id]});o.done(function(){r.msg.saved(),n.hideEditor(),n.chatView.send(i)}),o.fail(function(){r.msg.savingFailed(),e.prop("disabled",!1)})}),t.find(".btn-default").on("click",n.hideEditor.bind(n)),t.appendTo(document.body);var i=t.find("textarea")[0];i.setSelectionRange(i.value.length,i.value.length),i.focus()},hideEditor:function(){var e=n(".wh-problems-editor");return!!e.length&&(e.remove(),!0)},renderOrderInfo:function(){this.$id("orderInfo").html(g(this.serialize()))},renderFuncs:function(){this.hideEditor(),this.$id("funcs").html(b(this.serialize()))},onOrderRemoved:function(){this.renderFuncs()},onOrderChanged:function(){this.renderFuncs()},onOrderStatusChanged:function(){this.$id("orderInfo").toggleClass("is-cancelled","cancelled"===this.model.get("status"))},onDialogShown:function(){this.chatView.onDialogShown()}})});