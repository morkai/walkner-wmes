define(["underscore","jquery","../time","../core/Collection","./WhOrder"],function(t,e,r,i,n){"use strict";function a(){return r.utc.getMoment(Date.now()).startOf("day").subtract(r.getMoment().hours()<6?1:0,"days").format("YYYY-MM-DD")}return i.extend({model:n,paginate:!1,initialize:function(e,r){r=t.assign({date:a()},r),this.date=r.date,this.byOrderNo={},r.groupByOrderNo&&(this.on("reset",this.groupByOrderNo),this.length&&this.groupByOrderNo())},setCurrentDate:function(){this.setDateFilter(a())},getDateFilter:function(){return this.date},setDateFilter:function(t){this.date=t},url:function(){return this.date?"/old/wh/orders?sort(group,line,startTime)&date="+r.utc.getMoment(this.date,"YYYY-MM-DD").valueOf():"/old/wh/orders"},getFilters:function(t){return{whStatuses:t.displayOptions.get("whStatuses")||[],psStatuses:t.displayOptions.get("psStatuses")||[],startTime:t.displayOptions.getStartTimeRange(t.id)}},serialize:function(t){var e=null,r=this.getFilters(t);return this.map(function(i,n){var a=i.serialize(t,n,r);return e&&(a.newGroup=a.group!==e.group,a.newLine=a.line!==e.line),e=a,a})},update:function(t){for(var e=0;e<t.length;++e){var r=t[e],i=this.get(r._id);i&&i.update(r)}},act:function(t,e){return this.constructor.act(e.date||this.date,t,e)},groupByOrderNo:function(){var t={};this.forEach(function(e){var r=e.get("order");t[r]||(t[r]=[]),t[r].push(e)}),this.byOrderNo=t}},{act:function(t,i,n){return/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(t)||(t=r.utc.format(t,"YYYY-MM-DD")),e.ajax({method:"POST",url:"/wh/plans/"+t+";act",data:JSON.stringify({action:i,data:n})})}})});