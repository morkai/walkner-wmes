define(["underscore","jquery","../user","../data/orgUnits","../settings/SettingCollection","./WhSetting"],function(e,r,t,i,n,a){"use strict";var o=new RegExp(["maxSetSize","minSetDuration","maxSetDuration","maxSetDifference","groupDuration","groupExtraItems","minPickupDowntime","maxPickupDowntime","maxSetsPerLine","maxDeliveryStartTime","lateDeliveryTime","minDeliveryDowntime","maxDeliveryDowntime","maxFifoCartsPerDelivery","maxPackCartsPerDelivery","availableTimeThreshold","pickupPriorityThreshold","unassignSetDelay"].join("|"));return n.extend({model:a,topicSuffix:"wh.**",getValue:function(e){var r=this.get("wh."+e);return r?r.getValue():null},prepareValue:function(e,r){return o.test(e)?(r=Math.round(parseInt(r,10)),isNaN(r)||r<0?0:r):/Mrps$/.test(e)?r.split(",").filter(function(e){return!!e.length}):/(ignorePsStatus|psPickupStatus|Funcs)$/.test(e)?Array.isArray(r)?r.filter(function(e){return/^[a-z\-]{1,30}$/.test(e)}):[]:/lineGroups$/.test(e)?this.prepareLineGroups(r):/minTimeForDelivery$/.test(e)?this.prepareMinTimeForDelivery(r):/pendingOnly$/.test(e)?!!r:void 0},prepareFormValue:function(e,r){return/lineGroups$/.test(e)?this.formatLineGroups(r):/minTimeForDelivery$/.test(e)?this.formatMinTimeForDelivery(r):n.prototype.prepareFormValue.apply(this,arguments)},prepareLineGroups:function(e){var r={};(e||"").split("\n").forEach(function(e){var t=e.trim().split(":");if(2===t.length){var n=t[0].trim();n.length&&(r[n]||(r[n]={}),t[1].split(/[,;]+/).forEach(function(e){var t=i.getByTypeAndId("prodLine",e.trim());t&&(r[n][t.id]=1)}))}});var t=[];return Object.keys(r).forEach(function(e){t.push({_id:e,lines:Object.keys(r[e])})}),t},formatLineGroups:function(r){return r.map(function(r){return e.escape(r._id)+": "+r.lines.join(", ")}).join("\n")},prepareMinTimeForDelivery:function(e){var r={"*":45};return(e||"").split("\n").forEach(function(e){var t=e.trim().split(":");if(2===t.length){var i=t[0].trim();if("*"===i||/^[a-zA-Z0-9_-]+$/.test(i)){var n=parseInt(t[1],10);n>0&&(r[i]=n)}}}),r},formatMinTimeForDelivery:function(e){var r=[];return e||(e={}),e["*"]?r.push("*: "+e["*"]):r.push("*: 45"),Object.keys(e).forEach(function(t){"*"!==t&&r.push(t+": "+e[t])}),r.join("\n")},getMaxDeliveryStartTime:function(){return 60*(this.getValue("planning.maxDeliveryStartTime")||60)*1e3},getMinTimeForDelivery:function(){var e=this.getValue("planning.minTimeForDelivery")||{};return e["*"]||(e["*"]=45),e},getMaxMinTimeForDelivery:function(e){var r=this.getMinTimeForDelivery(),t=0;if(Array.isArray(e))for(var i=0;i<e.length;++i){var n=e[i].mrp;r[n]>t&&(t=r[n])}return 60*(t||r["*"])*1e3},getLateDeliveryTime:function(){return 60*(this.getValue("planning.lateDeliveryTime")||30)*1e3}})});