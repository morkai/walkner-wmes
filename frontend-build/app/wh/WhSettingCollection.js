define(["underscore","jquery","../user","../data/orgUnits","../settings/SettingCollection","./WhSetting"],function(e,r,i,t,n,a){"use strict";var o=new RegExp(["maxSetSize","minSetDuration","maxSetDuration","maxSetDifference","groupDuration","groupExtraItems","minPickupDowntime","maxPickupDowntime","maxSetsPerLine","maxDeliveryStartTime","lateDeliveryTime","minDeliveryDowntime","maxDeliveryDowntime","maxFifoCartsPerDelivery","maxPackCartsPerDelivery","availableTimeThreshold","pickupPriorityThreshold","unassignSetDelay"].join("|"));return n.extend({model:a,topicSuffix:"wh.**",getValue:function(e){var r=this.get("wh."+e);return r?r.getValue():null},prepareValue:function(e,r){return o.test(e)?(r=Math.round(parseInt(r,10)),isNaN(r)||r<0?0:r):/Mrps$/.test(e)?r.split(",").filter(function(e){return!!e.length}):/(ignorePsStatus|psPickupStatus|Funcs)$/.test(e)?Array.isArray(r)?r.filter(function(e){return/^[a-z\-]{1,30}$/i.test(e)}):[]:/lineGroups$/.test(e)?this.prepareLineGroups(r):/minTimeForDelivery$/.test(e)?this.prepareMinTimeForDelivery(r):/pendingOnly$/.test(e)?!!r:void 0},prepareFormValue:function(e,r){return/lineGroups$/.test(e)?this.formatLineGroups(r):/minTimeForDelivery$/.test(e)?this.formatMinTimeForDelivery(r):n.prototype.prepareFormValue.apply(this,arguments)},prepareLineGroups:function(e){var r={};(e||"").split("\n").forEach(function(e){var i=e.trim().split(":");if(2===i.length){var n=i[0].trim();n.length&&(r[n]||(r[n]={}),i[1].split(/[,;]+/).forEach(function(e){var i=t.getByTypeAndId("prodLine",e.trim());i&&(r[n][i.id]=1)}))}});var i=[];return Object.keys(r).forEach(function(e){i.push({_id:e,lines:Object.keys(r[e])})}),i},formatLineGroups:function(r){return r.map(function(r){return e.escape(r._id)+": "+r.lines.join(", ")}).join("\n")},prepareMinTimeForDelivery:function(e){var r={"*":45};return(e||"").split("\n").forEach(function(e){var i=e.trim().split(":");if(2===i.length){var t=i[0].trim();if("*"===t||/^[a-zA-Z0-9_-]+$/.test(t)){var n=parseInt(i[1],10);n>0&&(r[t]=n)}}}),r},formatMinTimeForDelivery:function(e){var r=[];return e||(e={}),e["*"]?r.push("*: "+e["*"]):r.push("*: 45"),Object.keys(e).forEach(function(i){"*"!==i&&r.push(i+": "+e[i])}),r.join("\n")},getMaxDeliveryStartTime:function(){return 60*(this.getValue("planning.maxDeliveryStartTime")||60)*1e3},getMinTimeForDelivery:function(){var e=this.getValue("planning.minTimeForDelivery")||{};return e["*"]||(e["*"]=45),e},getMaxMinTimeForDelivery:function(e){var r=this.getMinTimeForDelivery(),i=0;if(Array.isArray(e))for(var t=0;t<e.length;++t){var n=e[t].mrp;r[n]>i&&(i=r[n])}return 60*(i||r["*"])*1e3},getLateDeliveryTime:function(){return 60*(this.getValue("planning.lateDeliveryTime")||30)*1e3}})});