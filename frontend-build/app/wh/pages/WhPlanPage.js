// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/time","app/core/Model","app/core/View","app/core/util/bindLoadingMessage","app/factoryLayout/productionState","app/paintShop/views/PaintShopDatePickerView","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","../settings","../WhOrderCollection","../views/WhFilterView","../views/WhPlanView","app/wh/templates/planPage","app/planning/templates/planLegend"],function(e,t,i,s,n,a,r,o,l,d,p,h,c,u,f,g,m,w,v){"use strict";var O=!1;return r.extend({template:w,layoutName:"page",breadcrumbs:function(){return[{label:i.bound("wh","BREADCRUMBS:base")},{href:"#wh/plans/"+this.plan.id,label:this.plan.getLabel(),template:function(e){return'<span class="paintShop-breadcrumb"><a class="fa fa-chevron-left" data-action="prev"></a><a href="'+e.href+'" data-action="showPicker">'+e.label+'</a><a class="fa fa-chevron-right" data-action="next"></a></span>'}}]},actions:function(){var e=this;return[{label:e.t("PAGE_ACTION:dailyPlan"),icon:"calculator",privileges:"PLANNING:VIEW",href:"#planning/plans/"+e.plan.id},{label:e.t("PAGE_ACTION:settings"),icon:"cogs",privileges:"WH:MANAGE",href:"#wh/settings"},{label:e.t("PAGE_ACTION:legend"),icon:"question-circle",callback:function(){return e.toggleLegend(this.querySelector(".btn")),!1}}]},remoteTopics:{"planning.changes.created":function(e){this.plan.applyChange(e)},"orders.updated.*":function(t){var i=t.change,s=i.newValues,n=this.plan.sapOrders.get(t._id);if(n){var a=e.clone(s);e.isEmpty(i.comment)||(a.comments=n.get("comments").concat({source:i.source,time:i.time,user:i.user,text:i.comment,delayReason:s.delayReason})),n.set(a)}},"production.stateChanged.**":function(e){this.plan.shiftOrders.update(e)},"paintShop.orders.updated.*":function(e){var t=this.plan.sapOrders.get(e.order);t&&e.status&&t.set("psStatus",e.status)},"wh.orders.changed.*":function(e){this.plan.getMoment().isSame(e.date)&&this.promised(this.whOrders.fetch({reset:!0}))}},localTopics:{"socket.disconnected":function(){O=!0}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings()},destroy:function(){t(document).off("."+this.idPrefix),t(window).off("."+this.idPrefix),l.unload(),u.release()},setUpLayout:function(e){this.layout=e},defineModels:function(){var e=this,t=e.model=e.plan=new p({_id:e.options.date},{displayOptions:c.fromLocalStorage({mrps:e.options.mrps},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),settings:h.fromDate(e.options.date),minMaxDates:!0,pceTimes:!1});e.whSettings=o(u.acquire(),e),e.whOrders=o(new f(null,{date:e.options.date}),e);var i="MSG:LOADING_FAILURE:";o(t,e,i+"plan","planning"),o(t.settings,e,i+"settings","planning"),o(t.sapOrders,e,i+"sapOrders","planning"),o(t.shiftOrders,e,i+"shiftOrders","planning"),o(l,e,i+"productionState","planning"),window.plan=t},defineViews:function(){this.filterView=new g({plan:this.plan}),this.listView=new m({prodLineStates:l.prodLineStates,whSettings:this.whSettings,whOrders:this.whOrders,plan:this.plan}),this.setView("#-filter",this.filterView),this.setView("#-list",this.listView)},defineBindings:function(){var e=this,i=e.plan;e.listenTo(i,"sync",e.onPlanSynced),e.listenTo(i,"change:_id",e.onDateFilterChanged),e.listenTo(i.displayOptions,"change:useDarkerTheme",e.onDarkerThemeChanged),e.listenTo(i.sapOrders,"sync",e.onSapOrdersSynced),t(document).on("click."+e.idPrefix,".paintShop-breadcrumb",this.onBreadcrumbsClick.bind(this))},load:function(e){var t=this.plan,i=O;return O=!1,e(l.load(i),this.whSettings.fetchIfEmpty(),this.whOrders.fetch({reset:!0}),t.settings.fetch(),t.shiftOrders.fetch({reset:!0}),t.sapOrders.fetch({reset:!0}),t.fetch())},serialize:function(){return{idPrefix:this.idPrefix,darker:this.plan.displayOptions.isDarkerThemeUsed()}},afterRender:function(){l.load(!1),u.acquire()},reload:function(){function e(){n.set("loading",!1),s.msg.loadingFailed()}var i=this,n=i.plan;n.set("loading",!0),i.whOrders.date=i.plan.id,i.promised(n.settings.set("_id",n.id).fetch()).then(function(){var s=t.when(i.whSettings.fetch({reset:!0}),i.whOrders.fetch({reset:!0,reload:!0}),n.shiftOrders.fetch({reset:!0,reload:!0}),n.sapOrders.fetch({reset:!0,reload:!0}),n.fetch());i.promised(s).then(n.set.bind(n,"loading",!1),e)},e)},updateUrl:function(){var e=this.plan;this.broker.publish("router.navigate",{url:"/wh/plans/"+e.id,replace:!0,trigger:!1})},reloadOrders:function(){this.promised(this.plan.sapOrders.fetch({reset:!0}))},toggleLegend:function(e){if(this.$legendPopover)return this.$legendPopover.popover("destroy"),void(this.$legendPopover=null);this.$legendPopover=t(e).popover({trigger:"manual",placement:"left",html:!0,content:v({}),template:'<div class="popover planning-legend-popover"><div class="popover-content"></div></div>'}),this.$legendPopover.one("hide.bs.popover",function(){e.classList.remove("active")}),this.$legendPopover.popover("show"),e.classList.add("active")},onBreadcrumbsClick:function(e){if("A"===e.target.tagName)return!e.target.classList.contains("disabled")&&("showPicker"===e.target.dataset.action?this.showDatePickerDialog():this.selectNonEmptyDate(e.target.dataset.action),!1)},showDatePickerDialog:function(){var e=new d({model:{date:this.plan.id}});this.listenTo(e,"picked",function(e){s.closeDialog(),e!==this.plan.id&&this.plan.set("_id",e)}),s.showDialog(e)},selectNonEmptyDate:function(e){t(".paintShop-breadcrumb").find("a").addClass("disabled");var a=this,r=+a.plan.getMoment().valueOf(),o="/wh/orders?limit(1)&select(date)";o+="prev"===e?"&sort(-date)&date<"+r+"&date>"+(r-2592e6):"&sort(date)&date>"+r+"&date<"+(r+2592e6);var l=a.ajax({url:o});l.done(function(e){e.totalCount?a.plan.set("_id",n.utc.format(e.collection[0].date,"YYYY-MM-DD")):s.msg.show({type:"warning",time:2500,text:i("paintShop","MSG:date:empty")})}),l.fail(function(){s.msg.show({type:"error",time:2500,text:i("paintShop","MSG:date:failure")})}),l.always(function(){a.layout&&a.layout.setBreadcrumbs(a.breadcrumbs,a)})},onDateFilterChanged:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this)),this.plan.mrps.reset([]),this.plan.sapOrders.reset([]),this.plan.shiftOrders.reset([]),this.plan.orders.reset([]),this.plan.lines.reset([]),this.whOrders.reset([]),this.updateUrl(),this.reload()},onDarkerThemeChanged:function(){this.$el.toggleClass("planning-darker",this.plan.displayOptions.isDarkerThemeUsed())},onPlanSynced:function(){this.layout&&(this.layout.setBreadcrumbs(this.breadcrumbs,this),this.layout.setActions(this.actions,this))},onSapOrdersSynced:function(){this.timers.reloadOrders&&clearTimeout(this.timers.reloadOrders),this.timers.reloadOrders=setTimeout(this.reloadOrders.bind(this),6e5)}})});