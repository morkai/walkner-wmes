define(["underscore","jquery","app/i18n","app/user","app/viewport","app/time","app/core/Model","app/core/View","app/core/util/bindLoadingMessage","app/core/util/embedded","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","../settings","../WhOrderCollection","../views/WhProblemFilterView","../views/WhProblemListView","../views/WhProblemDetailsView","app/wh/templates/problemListPage"],function(e,i,t,s,n,r,o,a,d,l,h,c,p,u,f,m,w,g,O){"use strict";return a.extend({template:O,layoutName:"page",breadcrumbs:function(){return[{label:this.t("BREADCRUMB:base"),href:l.isEnabled()?null:"#wh/pickup/0d"},this.t("BREADCRUMB:problems")]},actions:function(){return l.isEnabled()?[{label:t("wh","PAGE_ACTION:pickup"),icon:"check-square-o",href:"/wh-pickup"}]:[]},remoteTopics:{"orders.updated.*":function(i){var t=n.currentDialog;if(t instanceof g){var s=i.change,r=s.newValues,o=t.plan.sapOrders.get(i._id);if(o){var a=e.clone(r);e.isEmpty(s.comment)||(a.comments=o.get("comments").concat({source:s.source,time:s.time,user:s.user,text:s.comment,delayReason:r.delayReason})),o.set(a)}}},"old.wh.orders.changed.*":function(e){var i=this;e.changes.changed.forEach(function(e){var t=i.whOrders.get(e._id);if(!t){if(!(n.currentDialog instanceof g&&n.currentDialog.model.id===e._id))return;t=n.currentDialog.model}t.set(e),e.status&&"problem"!==e.status&&i.whOrders.remove(t)}),e.changes.removed.forEach(function(e){i.whOrders.remove(e)})},"old.wh.orders.updated":function(e){var i=this;e.updated.forEach(function(e){var t=i.whOrders.get(e._id),s=!1;if(!t&&n.currentDialog instanceof g&&n.currentDialog.model.id===e._id&&(t=n.currentDialog.model,s=!0),t)return t.set(e),void("problem"!==e.status?i.whOrders.remove(t):s&&i.whOrders.add(t));"problem"===e.status&&i.whOrders.add(e)})}},localTopics:{"socket.connected":function(){this.$el.removeClass("wh-is-disconnected"),this.load(e.noop)},"socket.disconnected":function(){this.$el.addClass("wh-is-disconnected")}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings()},destroy:function(){i(document).off("."+this.idPrefix),i(window).off("."+this.idPrefix),u.release()},setUpLayout:function(e){this.layout=e},defineModels:function(){this.displayOptions=p.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),this.whSettings=d(u.acquire(),this),this.whOrders=d(new f(null,{date:null,rqlQuery:"sort(startTime)&limit(0)&status=problem"}),this),this.model=this.whOrders},defineViews:function(){this.filterView=new m({displayOptions:this.displayOptions}),this.listView=new w({embedded:l.isEnabled(),whSettings:this.whSettings,whOrders:this.whOrders}),this.setView("#-list",this.listView)},defineBindings:function(){this.listenTo(this.displayOptions,"change:useDarkerTheme",this.onDarkerThemeChanged),this.listenToOnce(this,"afterRender",function(){window.parent.postMessage({type:"ready",app:window.WMES_APP_ID},"*")})},load:function(e){return e(this.whSettings.fetchIfEmpty(),this.whOrders.fetch({reset:!0}))},getTemplateData:function(){return{darker:this.displayOptions.isDarkerThemeUsed()}},afterRender:function(){u.acquire(),l.render(this)},onDarkerThemeChanged:function(){this.$el.toggleClass("planning-darker",this.displayOptions.isDarkerThemeUsed())}})});