define(["underscore","jquery","app/i18n","app/user","app/viewport","app/time","app/core/Model","app/core/View","app/core/util/bindLoadingMessage","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","../settings","../WhOrderCollection","../views/WhProblemFilterView","../views/WhProblemListView","../views/WhProblemDetailsView","app/wh/templates/problemListPage"],function(e,t,i,s,n,r,o,a,d,l,h,c,u,p,f,m,g,w){"use strict";return a.extend({template:w,layoutName:"page",breadcrumbs:function(){return[{label:this.t("BREADCRUMBS:base")},{label:this.t("BREADCRUMBS:problems")}]},actions:function(){return window.IS_EMBEDDED?[]:[{label:this.t("PAGE_ACTION:settings"),icon:"cogs",privileges:"WH:MANAGE",href:"#wh/settings"}]},remoteTopics:{"orders.updated.*":function(t){var i=n.currentDialog;if(i instanceof g){var s=t.change,r=s.newValues,o=i.plan.sapOrders.get(t._id);if(o){var a=e.clone(r);e.isEmpty(s.comment)||(a.comments=o.get("comments").concat({source:s.source,time:s.time,user:s.user,text:s.comment,delayReason:r.delayReason})),o.set(a)}}},"wh.orders.changed.*":function(e){var t=this;e.changes.changed.forEach(function(e){var i=t.whOrders.get(e._id);if(!i){if(!(n.currentDialog instanceof g&&n.currentDialog.model.id===e._id))return;i=n.currentDialog.model}i.set(e),e.status&&"problem"!==e.status&&t.whOrders.remove(i)}),e.changes.removed.forEach(function(e){t.whOrders.remove(e)})},"wh.orders.updated":function(e){var t=this;e.orders.forEach(function(e){var i=t.whOrders.get(e._id);if(!i&&n.currentDialog instanceof g&&n.currentDialog.model.id===e._id&&(i=n.currentDialog.model),i)return i.set(e),void("problem"!==e.status&&t.whOrders.remove(i));"problem"===e.status&&t.whOrders.add(e)})}},localTopics:{"socket.connected":function(){this.$el.removeClass("wh-is-disconnected"),this.load(e.noop)},"socket.disconnected":function(){this.$el.addClass("wh-is-disconnected")}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings()},destroy:function(){t(document).off("."+this.idPrefix),t(window).off("."+this.idPrefix),u.release()},setUpLayout:function(e){this.layout=e},defineModels:function(){this.displayOptions=c.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),this.whSettings=d(u.acquire(),this),this.whOrders=d(new p(null,{date:null,rqlQuery:"sort(startTime)&limit(0)&status=problem"}),this),this.model=this.whOrders},defineViews:function(){this.filterView=new f({displayOptions:this.displayOptions}),this.listView=new m({whSettings:this.whSettings,whOrders:this.whOrders}),this.setView("#-list",this.listView)},defineBindings:function(){this.listenTo(this.displayOptions,"change:useDarkerTheme",this.onDarkerThemeChanged)},load:function(e){return e(this.whSettings.fetchIfEmpty(),this.whOrders.fetch({reset:!0}))},getTemplateData:function(){return{darker:this.displayOptions.isDarkerThemeUsed()}},afterRender:function(){u.acquire()},onDarkerThemeChanged:function(){this.$el.toggleClass("planning-darker",this.displayOptions.isDarkerThemeUsed())}})});