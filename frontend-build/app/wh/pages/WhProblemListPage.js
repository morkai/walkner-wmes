define(["underscore","jquery","app/i18n","app/user","app/viewport","app/time","app/core/Model","app/core/View","app/core/util/bindLoadingMessage","app/core/util/embedded","app/planning/Plan","app/planning/PlanSettings","app/planning/PlanDisplayOptions","../settings","../WhOrderCollection","../views/WhProblemFilterView","../views/WhProblemListView","../views/WhProblemDetailsView","app/wh/templates/problemListPage"],function(e,t,i,s,n,r,o,a,d,l,h,c,p,u,f,w,m,g,O){"use strict";var y=window.parent!==window||"/"!==window.location.pathname;return a.extend({template:O,layoutName:"page",breadcrumbs:function(){return[{label:this.t("BREADCRUMB:base")},{label:this.t("BREADCRUMB:problems")}]},actions:function(){return y?[{label:i("wh","PAGE_ACTION:pickup"),icon:"check-square-o",href:"/wh-pickup"}]:[]},remoteTopics:{"orders.updated.*":function(t){var i=n.currentDialog;if(i instanceof g){var s=t.change,r=s.newValues,o=i.plan.sapOrders.get(t._id);if(o){var a=e.clone(r);e.isEmpty(s.comment)||(a.comments=o.get("comments").concat({source:s.source,time:s.time,user:s.user,text:s.comment,delayReason:r.delayReason})),o.set(a)}}},"wh.orders.changed.*":function(e){var t=this;e.changes.changed.forEach(function(e){var i=t.whOrders.get(e._id);if(!i){if(!(n.currentDialog instanceof g&&n.currentDialog.model.id===e._id))return;i=n.currentDialog.model}i.set(e),e.status&&"problem"!==e.status&&t.whOrders.remove(i)}),e.changes.removed.forEach(function(e){t.whOrders.remove(e)})},"wh.orders.updated":function(e){var t=this;e.orders.forEach(function(e){var i=t.whOrders.get(e._id),s=!1;if(!i&&n.currentDialog instanceof g&&n.currentDialog.model.id===e._id&&(i=n.currentDialog.model,s=!0),i)return i.set(e),void("problem"!==e.status?t.whOrders.remove(i):s&&t.whOrders.add(i));"problem"===e.status&&t.whOrders.add(e)})}},localTopics:{"socket.connected":function(){this.$el.removeClass("wh-is-disconnected"),this.load(e.noop)},"socket.disconnected":function(){this.$el.addClass("wh-is-disconnected")}},initialize:function(){this.defineModels(),this.defineViews(),this.defineBindings()},destroy:function(){t(document).off("."+this.idPrefix),t(window).off("."+this.idPrefix),u.release()},setUpLayout:function(e){this.layout=e},defineModels:function(){this.displayOptions=p.fromLocalStorage({},{storageKey:"PLANNING:DISPLAY_OPTIONS:WH"}),this.whSettings=d(u.acquire(),this),this.whOrders=d(new f(null,{date:null,rqlQuery:"sort(startTime)&limit(0)&status=problem"}),this),this.model=this.whOrders},defineViews:function(){this.filterView=new w({displayOptions:this.displayOptions}),this.listView=new m({embedded:y,whSettings:this.whSettings,whOrders:this.whOrders}),this.setView("#-list",this.listView)},defineBindings:function(){this.listenTo(this.displayOptions,"change:useDarkerTheme",this.onDarkerThemeChanged),this.listenToOnce(this,"afterRender",function(){window.parent.postMessage({type:"ready",app:window.WMES_APP_ID},"*")})},load:function(e){return e(this.whSettings.fetchIfEmpty(),this.whOrders.fetch({reset:!0}))},getTemplateData:function(){return{darker:this.displayOptions.isDarkerThemeUsed()}},afterRender:function(){u.acquire(),l.render(this)},onDarkerThemeChanged:function(){this.$el.toggleClass("planning-darker",this.displayOptions.isDarkerThemeUsed())}})});