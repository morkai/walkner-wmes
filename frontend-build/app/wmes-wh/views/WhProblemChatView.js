define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/planning/PlanSapOrder","app/wh/templates/problemChat","app/wh/templates/problemChatMessage"],function(e,t,s,i,r,n,o,a,h,l,p){"use strict";return o.extend({template:l,events:{submit:function(){var e=this.$id("message");return this.send(e.val()),e.val("").focus(),!1},"keydown #-message":function(e){if("Enter"===e.key&&(e.shiftKey||e.ctrlKey||e.altKey))return this.$(".btn-primary").click(),!1}},initialize:function(){this.listenTo(this.plan.sapOrders,"add",this.renderMessages),this.listenTo(this.plan.sapOrders,"change:comments",this.onSapOrderChanged),t(window).on("resize."+this.idPrefix,this.resize.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},getTemplateData:function(){return{canComment:r.can.commentOrders()}},afterRender:function(){this.resize(),this.renderMessages()},resize:function(){var e=t(".modal-header")[0].getBoundingClientRect(),s=window.innerHeight-14-74-14-31;e.height?s-=e.top+e.height:s-=86,this.$id("messages")[0].style.height=s+"px"},scrollToBottom:function(){var e=this.$id("messages");e.prop("scrollTop",e.prop("scrollHeight"))},renderMessages:function(){this.$id("messages").html("");var e=this.plan.sapOrders.at(0);e&&e.get("comments").forEach(this.renderMessage,this),this.scrollToBottom()},renderMessage:function(e){var t=h.formatCommentWithIcon(e);if(t){var s=this.renderPartial(p,{time:i.format(e.time,"LL, HH:mm:ss"),user:a({userInfo:e.user,noIp:!0}),text:t});this.$id("messages").append(s)}},send:function(e){(e=e.trim()).replace(/[^A-Z0-9]+/gi,"").length&&(this.scrollToBottom(),this.ajax({method:"POST",url:"/orders/"+this.model.get("order"),data:JSON.stringify({source:"wh",comment:e})}))},onSapOrderChanged:function(e,t){var s=this.$id("messages")[0],i=s.scrollHeight-s.scrollTop===s.clientHeight;this.renderMessage(t[t.length-1]),i&&this.scrollToBottom()},onDialogShown:function(){this.resize(),this.scrollToBottom()}})});