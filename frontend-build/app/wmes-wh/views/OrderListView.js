define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/planning/PlanSapOrder","app/core/templates/userInfo","app/wmes-wh/templates/pickup/list","app/wmes-wh/templates/pickup/row","app/planning/templates/lineOrderComments"],function(t,e,i,s,n,r,a,o,h,d,l,p,c,u){"use strict";return a.extend({template:p,modelProperty:"whOrders",events:{"contextmenu td[data-column-id]":function(t){return this.showMenu(t),!1},"mousedown .planning-mrp-lineOrders-comment":function(t){if(0===t.button){var e=this.plan.sapOrders.get(t.currentTarget.parentNode.dataset.orderNo);if(e){var i=e.get("comments");i.length&&this.$(t.currentTarget).popover({trigger:"manual",placement:"left",html:!0,className:"planning-mrp-comment-popover",content:u({comments:i.map(function(t){return{user:l({noIp:!0,userInfo:t.user}),time:s.toTagData(t.time).human,text:d.formatCommentWithIcon(t)}})})}).popover("show")}}},"mouseup .planning-mrp-lineOrders-comment":function(t){this.$(t.currentTarget).popover("destroy")}},initialize:function(){var t=this.plan,i=t.sapOrders;this.listenTo(t,"change:loading change:updatedAt",this.scheduleRender),this.listenTo(i,"reset",this.onOrdersReset),this.listenTo(i,"change:comments",this.onCommentChange),this.listenTo(i,"change:psStatus",this.onPsStatusChanged),this.listenTo(this.whOrders,"reset",this.onOrdersReset),this.listenTo(this.whOrders,"change",this.onOrderChanged),this.listenTo(t.displayOptions,"change:whStatuses",this.onWhStatusesFilterChanged),this.listenTo(t.displayOptions,"change:psStatuses",this.onPsStatusesFilterChanged),this.listenTo(t.displayOptions,"change:from change:to",this.onStartTimeFilterChanged),e(window).on("scroll."+this.idPrefix,this.positionStickyHeaders.bind(this))},destroy:function(){e(window).off("."+this.idPrefix),this.$stickyHeaders&&(this.$stickyHeaders.remove(),this.$stickyHeaders=null)},getTemplateData:function(){return{renderRow:this.renderPartialHtml.bind(this,c),rows:this.serializeRows()}},serializeRows:function(){return this.whOrders.serialize(this.plan)},beforeRender:function(){clearTimeout(this.timers.render)},afterRender:function(){this.setUpStickyHeaders()},scheduleRender:function(){clearTimeout(this.timers.render),!this.plan.isAnythingLoading()&&this.isRendered()&&(this.timers.render=setTimeout(this.renderIfNotLoading.bind(this),1))},renderIfNotLoading:function(){this.plan.isAnythingLoading()||this.render()},setUpStickyHeaders:function(){this.$stickyHeaders=e('<div class="planning-wh-list wh-list-sticky"></div>').html('<table class="planning-mrp-lineOrders-table">'+this.$("thead").first()[0].outerHTML+"</table>"),this.adjustStickyHeaders(),this.positionStickyHeaders();var t=e(document.body);t.find(".wh-list-sticky").remove(),t.append(this.$stickyHeaders)},adjustStickyHeaders:function(){if(this.$stickyHeaders){var t=this.$stickyHeaders.find("th");this.$("th").each(function(e){var i=this.getClientRects();t[e].style.width=(i.length?i[0].width:0)+"px"})}},positionStickyHeaders:function(){this.$stickyHeaders&&this.$stickyHeaders[0].classList.toggle("hidden",window.scrollY<this.el.offsetTop)},hideMenu:function(){h.hide(this)},showMenu:function(t){var e=t.currentTarget.parentNode,i=this.whOrders.get(e.dataset.id);if(i){var s=i.get("orderNo"),r=i.get("set"),a=i.get("status"),o=[h.actions.sapOrder(s)];n.isAllowedTo("PROD_DATA:VIEW")&&(this.plan.shiftOrders.findOrders(s).length||this.plan.getActualOrderData(s).quantityDone)&&o.push({icon:"fa-file-text-o",label:this.t("menu:shiftOrder"),handler:this.handleShiftOrderAction.bind(this,s)}),this.plan.canCommentOrders()&&o.push(h.actions.comment(s)),o.push("-"),o.push({icon:"fa-clipboard",label:this.t("menu:copy:all"),handler:this.handleCopyAction.bind(this,e,t.pageY,t.pageX,!1,!1)}),n.isAllowedTo("WH:MANAGE")&&(o.push("-"),"cancelled"===a?(o.push({icon:"fa-recycle",label:this.t("menu:restoreOrder"),handler:this.handleRestoreAction.bind(this,{orders:[i.id]})}),r&&o.push({label:this.t("menu:restoreSet"),handler:this.handleRestoreAction.bind(this,{set:r})})):(o.push({icon:"fa-times",label:this.t("menu:cancelOrder"),handler:this.handleCancelAction.bind(this,{orders:[i.id]})}),r&&o.push({label:this.t("menu:cancelSet"),handler:this.handleCancelAction.bind(this,{set:r})})),"pending"!==a&&(o.push({icon:"fa-eraser",label:this.t("menu:resetOrder"),handler:this.handleResetAction.bind(this,{orders:[i.id]})}),r&&o.push({label:this.t("menu:resetSet"),handler:this.handleResetAction.bind(this,{set:r})}))),h.show(this,t.pageY,t.pageX,o)}},handleShiftOrderAction:function(t){var e=this.plan.shiftOrders.findOrders(t);if(1===e.length)return window.open("/#prodShiftOrders/"+e[0].id);window.open("/#prodShiftOrders?sort(startedAt)&limit(-1337)&orderId=string:"+t)},handleCopyAction:function(e,s,n,r,a){var h=this;o.copy(function(o){if(o){var d=a?[]:[["mrp","order","nc12","name","qtyDone","qtyPlan","qtyTodo","shift","startTime","finishTime","line","whStatus","comment"].map(function(t){return h.t("prop:"+t)}).join("\t")],l=h.whOrders.get(e.dataset.id),p=l.get("line"),c=l.get("group");h.serializeRows().forEach(function(t){if(!t.hidden&&(!r||t.line===p&&t.group===c))if(a)d.push(t.orderNo);else{var e=[t.mrp,t.orderNo,t.nc12,t.name,t.qtyDone,t.qtyPlan,t.qtyTodo,t.shift,t.startTime,t.finishTime,t.line,t.whStatus,'"'+t.comments.map(function(t){return t.user.label+": "+t.text.replace(/"/g,"'")}).join("\r\n--\r\n")+'"'];d.push(e.join("\t"))}}),a&&(d=t.uniq(d)),o.setData("text/plain",d.join("\r\n"));var u=h.$(e).tooltip({container:h.el,trigger:"manual",placement:"bottom",title:i("planning","lineOrders:menu:copy:success")});u.tooltip("show").data("bs.tooltip").tip().addClass("result success").css({left:n+"px",top:s+"px"}),h.timers.hideTooltip&&clearTimeout(h.timers.hideTooltip),h.timers.hideTooltip=setTimeout(function(){u.tooltip("destroy")},1337)}})},handleResetAction:function(t){this.promised(this.whOrders.act("resetOrders",t))},handleCancelAction:function(t){this.promised(this.whOrders.act("cancelOrders",t))},handleRestoreAction:function(t){this.promised(this.whOrders.act("restoreOrders",t))},onCommentChange:function(t){this.plan.orders.get(t.id)&&this.$('tr[data-order="'+t.id+'"] > .planning-mrp-lineOrders-comment').html(t.getCommentWithIcon())},onOrdersReset:function(t,e){e.reload||this.scheduleRender()},onPsStatusChanged:function(t){var e=this.$('tr[data-order="'+t.id+'"]');if(e.length){var s=this.plan.sapOrders.getPsStatus(t.id);e.find(".planning-mrp-list-property-psStatus").attr("title",i("planning","orders:psStatus:"+s)).attr("data-ps-status",s)}},onOrderChanged:function(t){var e=this.$('tr[data-id="'+t.id+'"]');if(e.length){var i=this.whOrders.indexOf(t);e.replaceWith(c({row:t.serialize(this.plan,i,this.whOrders.getFilters(this.plan))})),this.adjustStickyHeaders()}},onWhStatusesFilterChanged:function(){this.toggleOrderRowVisibility()},onPsStatusesFilterChanged:function(){this.toggleOrderRowVisibility()},onStartTimeFilterChanged:function(){this.toggleOrderRowVisibility()},toggleOrderRowVisibility:function(){var t=this.whOrders.getFilters(this.plan);this.$(".wh-list-item").each(function(){var e=+this.dataset.startTime,i=e<t.startTime.from||e>=t.startTime.to;if(!i&&t.whStatuses.length&&(i=-1===t.whStatuses.indexOf(this.dataset.whStatus)),!i&&t.psStatuses.length){var s=this.querySelector(".planning-mrp-list-property-psStatus"),n=s?s.dataset.psStatus:"unknown";i=-1===t.psStatuses.indexOf(n)}this.classList.toggle("hidden",i)})}})});