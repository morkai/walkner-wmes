define(["underscore","app/i18n","app/time","app/viewport","app/core/View","app/core/util/pageActions","app/core/util/bindLoadingMessage","app/wmes-ct-state/settings","../ResultsReport","../views/resultsReport/FilterView","../views/resultsReport/VsChartView","../views/resultsReport/AvgOutputChartView","../views/resultsReport/TableView","../views/resultsReport/UpphQuarterlyConfigView","app/wmes-ct-pces/templates/resultsReport/page"],function(t,e,s,i,r,o,a,p,n,l,u,h,d,c,m){"use strict";return r.extend({layoutName:"page",template:m,events:{"click #-editUpphConfig":function(){var t=new c;i.showDialog(t,this.t("upphQuarterlyConfig:title"))},"click #-exportUpph":"exportUpph","click .ct-reports-results-mode":function(t){this.model.set(t.currentTarget.dataset.prop,t.currentTarget.dataset.value)}},breadcrumbs:function(){return[{href:"#ct",label:this.t("BREADCRUMB:base")},this.t("BREADCRUMB:reports:results")]},actions:function(){return[{label:this.t("PAGE_ACTION:settings"),icon:"cogs",privileges:"PROD_DATA:MANAGE",href:"#ct/settings?tab=resultsReport"}]},initialize:function(){p.bind(this),this.model=a(this.model,this),this.setView("#-filter",new l({model:this.model,settings:this.settings})),this.setView("#-vs",new u({model:this.model})),this.setView("#-avgOutput",new h({model:this.model})),this.setView("#-table",new d({model:this.model})),this.listenTo(this.model,"filtered",this.onFiltered),this.listenTo(this.model,"change:tab",this.updateUrl),this.listenTo(this.model,"change:upph",this.onUpphChanged)},load:function(t){return t(this.model.fetch())},getTemplateData:function(){return{canManage:n.can.manage()}},afterRender:function(){this.updateUpphMode()},onFiltered:function(){this.promised(this.model.fetch()),this.updateUrl()},onUpphChanged:function(){this.updateUpphMode(),this.updateUrl()},updateUrl:function(){this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!1,replace:!0})},updateUpphMode:function(){this.$(".active[data-prop]").removeClass("active"),this.$('.ct-reports-results-mode[data-value="'+this.model.get("upph")+'"]').addClass("active")},exportUpph:function(){var t=this,e=i.msg.show({type:"warning",text:t.t("core","MSG:EXPORTING"),sticky:!0}),s=t.model.get("report").upph||{total:[]},r={mrp:{type:"string",width:5,caption:t.t("resultsReport:avgOutput:export:mrp")},date:{type:"date",width:10,caption:t.t("resultsReport:avgOutput:export:date")},std:{type:"decimal",width:12,caption:t.t("resultsReport:avgOutput:export:standard")},norm:{type:"decimal",width:10,caption:t.t("resultsReport:avgOutput:export:normalized")}},a=[];Object.keys(s).sort((t,e)=>"total"===t?-1:"total"===e?1:t.localeCompare(e,void 0,{numeric:!0,ignorePunctuation:!0})).forEach(t=>{var e="total"===t?"":t;s[t].forEach(t=>{a.push({mrp:e,date:new Date(t._id),std:t.std,norm:t.norm})})});var p={filename:t.t("resultsReport:avgOutput:export:filename"),sheetName:t.t("resultsReport:avgOutput:export:sheetName"),freezeRows:1,columns:r,data:a},n=t.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify(p)});n.fail(function(){i.msg.hide(e,!0),i.msg.show({type:"error",time:2500,text:t.t("core","MSG:EXPORTING_FAILURE")})}),n.done(function(t){o.exportXlsx("/xlsxExporter/"+t,e)})}})});