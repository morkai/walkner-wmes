define(["underscore","app/i18n","app/viewport","app/core/View","app/core/util/pageActions","app/core/util/bindLoadingMessage","app/wmes-ct-state/settings","../ResultsReport","../views/resultsReport/FilterView","../views/resultsReport/VsChartView","../views/resultsReport/AvgOutputChartView","../views/resultsReport/TableView","../views/resultsReport/UpphQuarterlyConfigView","app/wmes-ct-pces/templates/resultsReport/page"],function(t,e,s,i,r,o,p,a,n,l,u,h,d,c){"use strict";return i.extend({layoutName:"page",template:c,events:{"click #-editUpphConfig":function(){var t=new d;s.showDialog(t,this.t("upphQuarterlyConfig:title"))},"click #-exportUpph":"exportUpph","click .ct-reports-results-mode":function(t){this.model.set(t.currentTarget.dataset.prop,t.currentTarget.dataset.value)}},breadcrumbs:function(){return[{href:"#ct",label:this.t("BREADCRUMB:base")},this.t("BREADCRUMB:reports:results")]},actions:function(){return[{label:this.t("PAGE_ACTION:settings"),icon:"cogs",privileges:"PROD_DATA:MANAGE",href:"#ct/settings?tab=resultsReport"}]},initialize:function(){p.bind(this),this.model=o(this.model,this),this.setView("#-filter",new n({model:this.model,settings:this.settings})),this.setView("#-vs",new l({model:this.model})),this.setView("#-avgOutput",new u({model:this.model})),this.setView("#-table",new h({model:this.model})),this.listenTo(this.model,"filtered",this.onFiltered),this.listenTo(this.model,"change:tab",this.updateUrl),this.listenTo(this.model,"change:upph",this.onUpphChanged)},load:function(t){return t(this.model.fetch())},getTemplateData:function(){return{canManage:a.can.manage()}},afterRender:function(){this.updateUpphMode()},onFiltered:function(){this.promised(this.model.fetch()),this.updateUrl()},onUpphChanged:function(){this.updateUpphMode(),this.updateUrl()},updateUrl:function(){this.broker.publish("router.navigate",{url:this.model.genClientUrl(),trigger:!1,replace:!0})},updateUpphMode:function(){this.$(".active[data-prop]").removeClass("active"),this.$('.ct-reports-results-mode[data-value="'+this.model.get("upph")+'"]').addClass("active")},exportUpph:function(){var t=this,e=s.msg.show({type:"warning",text:t.t("core","MSG:EXPORTING"),sticky:!0}),i=t.model.get("report").upph||{total:[]},o={mrp:{type:"string",width:5,caption:t.t("resultsReport:avgOutput:export:mrp")},week:{type:"string",width:10,caption:t.t("resultsReport:avgOutput:export:week")},std:{type:"decimal",width:12,caption:t.t("resultsReport:avgOutput:export:standard")},norm:{type:"decimal",width:10,caption:t.t("resultsReport:avgOutput:export:normalized")}},p=[];Object.keys(i).sort(function(t,e){return"total"===t?-1:"total"===e?1:t.localeCompare(e,void 0,{numeric:!0,ignorePunctuation:!0})}).forEach(function(t){var e="total"===t?"":t;i[t].forEach(function(t){p.push({mrp:e,week:t._id,std:t.std,norm:t.norm})})});var a={filename:t.t("resultsReport:avgOutput:export:filename"),sheetName:t.t("resultsReport:avgOutput:export:sheetName"),freezeRows:1,columns:o,data:p},n=t.ajax({type:"POST",url:"/xlsxExporter",data:JSON.stringify(a)});n.fail(function(){s.msg.hide(e,!0),s.msg.show({type:"error",time:2500,text:t.t("core","MSG:EXPORTING_FAILURE")})}),n.done(function(t){r.exportXlsx("/xlsxExporter/"+t,e)})}})});