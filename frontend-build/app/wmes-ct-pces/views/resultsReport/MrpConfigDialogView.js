define(["jquery","app/time","app/viewport","app/core/View","app/mrpControllers/util/setUpMrpSelect2","app/wmes-ct-pces/templates/resultsReport/mrpConfig"],function(e,t,n,i,a,o){"use strict";return i.extend({template:o,events:{'click .btn[data-role="add"]':function(){this.renderConfig({date:null,unbalance:0,bottleneck:0})},'click .btn[data-role="remove"]':function(e){this.$(e.currentTarget).closest("tr").fadeOut("fast",function(){this.parentNode.removeChild(this)})},submit:function(){return this.submit(),!1},'change input[type="date"]':function(){this.sortConfigs()}},initialize:function(){this.listenToOnce(this.model,"change",this.onModelLoaded)},getTemplateData:function(){return{minDate:window.PRODUCTION_DATA_START_DATE||t.format(Date.now(),"YYYY-01-01"),maxDate:t.getMoment().add(1,"years").format("YYYY-MM-DD")}},afterRender:function(){a(this.$id("id").prop("disabled",!0).val(this.model.id),{view:this,own:!1,width:"100%",maximumSelectionSize:1}),this.load()},load:function(){var e=this;n.msg.loading();var t=e.model.fetch();t.fail(function(){404===t.status?(n.msg.loaded(),e.model.id=null,e.model.set({configs:[]})):(n.msg.loadingFailed(),n.closeDialog())}),t.done(function(t){n.msg.loaded(),e.model.set(t)})},submit:function(){var e=this,i=[];e.$id(".btn-primary").prop("disabled",!0),e.$id("configs").children().each(function(){var e={date:this.querySelector('input[name$="date"]').value+"T00:00:00Z",unbalance:+this.querySelector('input[name$="unbalance"]').value,bottleneck:+this.querySelector('input[name$="bottleneck"]').value};t.utc.getMoment(e.date).isValid()&&(e.unbalance>=0||(e.unbalance=0),e.bottleneck>=0||(e.bottleneck=0),i.push(e))}),e.model.set("configs",i),n.msg.saving();var a=e.model.save();a.fail(function(){n.msg.savingFailed(),e.$id(".btn-primary").prop("disabled",!1)}),a.done(function(){e.model.trigger("save"),n.msg.saved(),n.closeDialog()})},onModelLoaded:function(){this.model.get("configs").forEach(this.renderConfig,this),this.$('.btn[data-role="add"]').prop("disabled",!1)},renderConfig:function(e){this.$configRow||(this.$configRow=this.$id("configs").children().first().detach());var n=this.$configRow.clone();n.find('input[name$="date"]').val(e.date?t.utc.format(e.date,"YYYY-MM-DD"):""),n.find('input[name$="unbalance"]').val(e.unbalance),n.find('input[name$="bottleneck"]').val(e.bottleneck),this.$id("configs").append(n)},sortConfigs:function(){var n=[],i=this.$id("configs"),a=document.activeElement;e(a).closest('tbody[data-role="configs"]').length||(a=null),i.children().each(function(){var i=t.utc.getMoment(this.querySelector('input[type="date"]').value,"YYYY-MM-DD");n.push({time:i.isValid()?i.valueOf():Number.MAX_SAFE_INTEGER,$el:e(this).detach()})}),n.sort(function(e,t){return e.time-t.time}),n.forEach(function(e){i.append(e.$el)}),a&&a.focus()}})});