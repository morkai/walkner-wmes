define(["app/time","app/viewport","app/core/View","app/core/Model","app/wmes-ct-pces/templates/resultsReport/upphQuarterlyConfig"],function(t,e,a,i,o){"use strict";return a.extend({template:o,events:{submit:function(){return this.submitForm(),!1},"input #-year":"updateId","change #-year":"updateId","input #-quarter":"updateId","change #-quarter":"updateId"},initialize:function(){this.model=Object.assign(new i,{urlRoot:"/ct/upphQuarterlyConfigs",nlsDomain:"wmes-ct-pces"}),this.listenTo(this.model,"change:_id",this.loadData),this.listenTo(this.model,"sync",this.updateData),this.once("afterRender",function(){this.$id("year").val(t.getMoment().year()),this.$id("quarter").val(t.getMoment().quarter()),this.updateId()})},getTemplateData:function(){return{minYear:(window.PRODUCTION_DATA_START_DATE||"2020-01-01").split("-")[0],maxYear:t.getMoment().add(1,"years").format("YYYY")}},updateId:function(){var e=+this.$id("year").val(),a=+this.$id("quarter").val(),i=t.utc.getMoment().startOf("year").year(e).quarter(Math.min(4,a)),o=e&&a&&i.isValid()?i.toISOString():void 0;o!==this.model.id&&(this.model.set({_id:o,configs:[]}),this.updateData())},loadData:function(){var t=this;t.loadReq&&(t.loadReq.abort(),t.loadReq=null),t.model.id&&(t.timers.loadData?clearTimeout(t.timers.loadData):e.msg.loading(),t.timers.loadData=setTimeout(function(){if(t.timers.loadData=null,t.model.id){var a=t.loadReq=t.promised(t.model.fetch());a.fail(function(){"abort"===a.statusText?e.msg.loaded():404===a.status?(e.msg.loaded(),t.model.set("configs",[]),t.updateData()):e.msg.loadingFailed()}),a.done(function(){e.msg.loaded()})}else e.msg.loaded()},100))},updateData:function(){if(this.model.id){var e=t.utc.getMoment(this.model.id);this.$id("year").val(e.year()),this.$id("quarter").val(e.quarter())}this.$id("coeffs").val(this.formatCoeffs())},formatCoeffs:function(){var t=[];return this.model.get("configs").forEach(function(e){if(e.qtyCoeff&&e.mrps.length){var a=e.qtyCoeff.toLocaleString(),i=e.mrps.join(", ");t.push(a+": "+i)}}),t.join("\n")},serializeConfigs:function(){var t=[];return this.$id("coeffs").val().split("\n").forEach(function(e){var a=e.split(":");if(2===a.length){var i=parseFloat(a[0].replace(",","."));if(i&&!(i<0)){var o=a[1].split(",").map(function(t){return t.trim()}).filter(function(t){return t.length});o.length&&t.push({mrps:o,qtyCoeff:i})}}}),t},submitForm:function(){e.msg.saving();var t=this.$(".form-control, .btn-primary").prop("disabled",!0);this.model.set("configs",this.serializeConfigs());var a=this.promised(this.model.save());a.fail(function(){e.msg.savingFailed()}),a.done(function(){e.msg.saved()}),a.always(function(){t.prop("disabled",!1)})}})});