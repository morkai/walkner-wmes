define(["underscore","jquery","app/viewport","app/i18n"],function(e,r,t,n){"use strict";return{createGetOrdersUrl:function(e,r){return function(t){var n=e.getOrderIdType();return r.attr("data-type",n),"/production/orders?"+n+"="+encodeURIComponent(t)}},setUpOrderSelect2:function(o,a,i,s){var l=this;function u(e){return-1!==e.laborTime&&""!==e.workCenter}o.removeClass("form-control").select2(e.assign({openOnEnter:null,allowClear:!1,minimumInputLength:6,ajax:{cache:!0,quietMillis:300,url:l.createGetOrdersUrl(i,o),results:function(e){return{results:(Array.isArray(e)?e:[]).map(function(e){return e.id=e._id,e.text=e._id+" - "+(e.description||e.name||"?"),e})}},transport:function(e){return r.ajax.apply(r,arguments).fail(function(){t.msg.show({type:"error",time:2e3,text:n("production","newOrderPicker:msg:searchFailure")}),e.success({collection:[]})})}}},s)),o.on("change",function(r){var t;t=Array.isArray(r.operations)?r.operations.filter(u):r.added&&Array.isArray(r.added.operations)?r.added.operations.filter(u):[],l.setUpOperationSelect2(a,t.map(function(e){return{id:e.no,text:e.no+" - "+e.name}}),s,!r.removed),t.length?a.select2("val",r.selectedOperationNo||l.getBestDefaultOperationNo(t)).select2("focus"):(r.selectedOperationNo&&a.val(r.selectedOperationNo),e.defer(function(){a.focus()}))})},setUpOperationSelect2:function(t,o,a,i){if(t.prev(".message-warning").remove(),i&&!o.length)return t.select2("destroy").addClass("form-control").val("").attr("title",""),void r('<p class="message message-inline message-warning"></p>').html(n("production","newOrderPicker:msg:noOperations")).insertBefore(t);t.removeClass("form-control").select2(e.assign({width:"100%",placeholder:" ",openOnEnter:null,allowClear:!1,minimumResultsForSearch:-1,data:o||[],shouldFocusInput:function(){return!0}},a))},selectOrder:function(r,t){if(t){var n=t.get("orderId"),o=t.get("orderData");n&&o&&(r.select2("data",{id:n,text:n+" - "+(o.description||o.name||"?"),sameOrder:!0}),r.trigger({type:"change",operations:e.values(o.operations),selectedOperationNo:t.get("operationNo")}))}},prepareOrderInfo:function(e,r){return delete r.__v,delete r.id,delete r.text,r._id&&("no"===e.getOrderIdType()?r.no=r._id:(r.no=null,r.nc12=r._id),delete r._id),r.operations=this.prepareOperations(r.operations),r},prepareOperations:function(r){if(Array.isArray(r)){var t={};return r.forEach(function(e){""===e.workCenter||-1===e.laborTime||t[e.no]||(t[e.no]=e)}),t}return e.isObject(r)?r:{}},getBestDefaultOperationNo:function(e){var r=this.getBestDefaultOperation(e);return r?r.no:null},getBestDefaultOperation:function(e){return Array.isArray(e)&&0!==e.length?1===e.length?e[0]:e.map(function(e){var r=0;return e.laborTime>0&&(r+=1),e.workCenter&&(r+=1),/mont/i.test(e.name)&&(r+=2),/g..wn/i.test(e.name)&&(r+=1),/pak/i.test(e.name)&&(r+=1),/kj/i.test(e.name)&&(r+=1),/opra/i.test(e.name)&&(r+=1),/z.o.en/i.test(e.name)&&(r+=1),{op:e,rank:r}}).sort(function(e,r){return r.rank-e.rank}).shift().op:null}}});