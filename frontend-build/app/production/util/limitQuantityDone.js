// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/socket"],function(t,n,e){"use strict";function o(t,n){var e="/prodSerialNumbers?limit(1)&prodShiftOrder="+n.id;return t.ajax({url:e,timeout:1e4}).done(function(n){n&&n.totalCount&&a(t,n.totalCount,null)})}function r(n,e){var o="/orders/"+e.get("orderId")+"?select(qty,qtyMax,qtyDone)";return n.ajax({url:o,timeout:1e4}).done(function(o){var r=e.getOperation()||{no:e.get("operationNo"),qty:o.qty};t.isEmpty(o.qtyDone)&&(o.qtyDone={total:0,byLine:{},byOperation:{}}),o.qtyDone.byOperation[r.no]||(o.qtyDone.byOperation[r.no]=0),t.isEmpty(o.qtyMax)&&(o.qtyMax={}),o.qtyMax[r.no]||(o.qtyMax[r.no]=o.qty);var i=e.get("quantityDone"),u=o.qtyDone.byOperation[r.no],y=u-(u>=i?i:0),p=o.qtyMax[r.no],d=Math.max(0,p-y);a(n,0,d)})}function a(t,n,e){var o=t.$id("quantityDone"),r=parseInt(o.attr("min"),10),a=parseInt(o.attr("max"),10);isNaN(r)&&(r=0),isNaN(a)&&(a=9999),null===e&&(e=a),null===n&&(n=r),n>e&&(n=e),o.attr("min",n).attr("max",e).trigger("input")}var i={};return function(t,a){if(a.id&&e.isConnected()){var u=t.$id("submit").prop("disabled",!0),y=[o(t,a)];a.get("orderId")&&!i[a.get("prodLine")]&&y.push(r(t,a)),n.when.apply(n,y).always(function(){u.prop("disabled",!1)})}}});