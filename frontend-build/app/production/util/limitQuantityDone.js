define(["underscore","jquery","app/socket","app/i18n","app/viewport"],function(t,n,i,e,o){"use strict";var r={};return function(d,s){if(d.ft={checkCredentials:null},s.id&&i.isConnected()){var l=d.$id("submit").prop("disabled",!0),c=[function(t,n){var i="/xiconf/orders/"+n.get("orderId");return t.ajax({url:i,timeout:1e4})}(d,s),function(t,n){var i="/prodSerialNumbers?limit(1)&prodShiftOrder="+n.id;return t.ajax({url:i,timeout:1e4}).done(function(n){n&&n.totalCount&&a(t,n.totalCount,null)})}(d,s)];s.get("orderId")&&!r[s.get("prodLine")]&&c.push(function(n,i){var e="/orders/"+i.get("orderId")+"?select(qty,qtyMax,qtyDone)";return n.ajax({url:e,timeout:1e4}).done(function(e){var o=i.getOperation()||{no:i.get("operationNo"),qty:e.qty};t.isEmpty(e.qtyDone)&&(e.qtyDone={total:0,byLine:{},byOperation:{}}),e.qtyDone.byOperation[o.no]||(e.qtyDone.byOperation[o.no]=0),t.isEmpty(e.qtyMax)&&(e.qtyMax={}),e.qtyMax[o.no]||(e.qtyMax[o.no]=e.qty);var r=i.get("quantityDone"),u=e.qtyDone.byOperation[o.no],d=u-(u>=r?r:0),s=e.qtyMax[o.no],l=Math.max(0,s-d);a(n,0,l)})}(d,s)),n.when.apply(n,c).always(function(n){!function(n,r){if(!r)return u(n);var a=t.find(r.items,function(t){return"ft"===t.kind});if(!a||a.quantityDone>=a.quantityTodo)return u(n);var d=n.$id("ft").removeClass("hidden");d.on("input",s),d.on("change",s),n.options.vkb&&n.options.vkb.reposition();function s(){n.ft.checkCredentials=function(n){var r=n.$id("ft-login").val(),a=n.$id("ft-password").val(),u=n.ajax({method:"POST",url:"/login?login=0",data:JSON.stringify({login:r,password:a})});u.fail(function(){var t=n.$id("ft-login");t.length&&(u.status>=400&&u.status<500?(n.ft.checkCredentials=null,t[0].setCustomValidity(e("production","ft:invalidCredentials"))):i.isConnected()?o.msg.show({type:"error",time:5e3,text:e("production","ft:requestFailure")}):n.ft.checkCredentials=null)}),u.done(function(i){i.super||t.includes(i.prodFunction,"engineer")||t.includes(i.privileges,"OPERATOR:ORDER_UNLOCK")?n.ft.checkCredentials=null:n.$id("ft-login")[0].setCustomValidity(e("production","ft:noPrivileges"))}),u.always(function(){n.$id("submit").prop("disabled",!1).click()})}.bind(null,n),d.find("input").each(function(){this.setCustomValidity("")})}}(d,n&&n[0]),l.prop("disabled",!1)})}};function a(t,n,i){var e=t.$id("quantityDone"),o=parseInt(e.attr("min"),10),r=parseInt(e.attr("max"),10);isNaN(o)&&(o=0),isNaN(r)&&(r=9999),null===i&&(i=r),null===n&&(n=o),n>i&&(n=i),e.attr("min",n).attr("max",i).trigger("input")}function u(t){t.$id("ft").remove()}});