// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/socket"],function(t,n,e){"use strict";function o(t,n){var e="/prodSerialNumbers?limit(1)&prodShiftOrder="+n.id;return t.ajax({url:e,timeout:1e4}).done(function(n){n&&n.totalCount&&a(t,n.totalCount,null)})}function r(t,n){var e="/orders/"+n.get("orderId")+"?select(qty,qtyMax,qtyDone)";return t.ajax({url:e,timeout:1e4}).done(function(e){var o=n.getOperation()||{no:n.get("operationNo"),qty:e.qty};e.qtyDone||(e.qtyDone={total:0,byLine:{},byOperation:{}}),e.qtyDone.byOperation[o.no]||(e.qtyDone.byOperation[o.no]=0),e.qtyMax||(e.qtyMax={}),e.qtyMax[o.no]||(e.qtyMax[o.no]=e.qty);var r=n.get("quantityDone"),i=e.qtyDone.byOperation[o.no],u=i-(i>=r?r:0),y=e.qtyMax[o.no],d=Math.max(0,y-u);a(t,0,d)})}function a(t,n,e){var o=t.$id("quantityDone");null!==n&&o.attr("min",n),null!==e&&o.attr("max",e),o.trigger("input")}var i={"W-1":!0,"W-2":!0,"W-3":!0,"WB-1":!0,"WB-2":!0,"WB-3":!0,"WB-4":!0,AV1:!0,AV1_P:!0,AV2:!0,AV2_P:!0};return function(t,a){if(a.id&&e.isConnected()){var u=t.$id("submit").prop("disabled",!0),y=[o(t,a)];a.get("orderId")&&!i[a.get("prodLine")]&&y.push(r(t,a)),n.when.apply(n,y).always(function(){u.prop("disabled",!1)})}}});