define(["underscore","jquery","app/socket","app/i18n","app/viewport"],function(t,n,e,i,o){"use strict";var r={};return function(d,s){if(d.ft={checkCredentials:null},s.id&&e.isConnected()){var l=d.$id("submit").prop("disabled",!0),c=[function(t,n){var e="/xiconf/orders/"+n.get("orderId");return t.ajax({url:e,timeout:1e4})}(d,s),function(t,n){var e="/prodSerialNumbers?limit(1)&prodShiftOrder="+n.id;return t.ajax({url:e,timeout:1e4}).done(function(n){n&&n.totalCount&&a(t,n.totalCount,null)})}(d,s)];s.get("orderId")&&!r[s.get("prodLine")]&&c.push(function(n,e){var i="/orders/"+e.get("orderId")+"?select(qty,qtyMax,qtyDone)";return n.ajax({url:i,timeout:1e4}).done(function(i){var o=e.getOperation()||{no:e.get("operationNo"),qty:i.qty};t.isEmpty(i.qtyDone)&&(i.qtyDone={total:0,byLine:{},byOperation:{}}),i.qtyDone.byOperation[o.no]||(i.qtyDone.byOperation[o.no]=0),t.isEmpty(i.qtyMax)&&(i.qtyMax={}),i.qtyMax[o.no]||(i.qtyMax[o.no]=i.qty);var r=e.get("quantityDone"),u=i.qtyDone.byOperation[o.no],d=u-(u>=r?r:0),s=i.qtyMax[o.no],l=Math.max(0,s-d);a(n,0,l)})}(d,s)),n.when.apply(n,c).always(function(n){!function(n,r){if(!r)return u(n);var a=t.find(r.items,function(t){return"ft"===t.kind});if(!a||a.quantityDone>=a.quantityTodo)return u(n);var d=n.$id("ft").removeClass("hidden");d.on("input",s),d.on("change",s),n.options.vkb&&n.options.vkb.reposition();function s(){n.ft.checkCredentials=function(n){var r=n.$id("ft-login").val(),a=n.$id("ft-password").val(),d=n.ajax({method:"POST",url:"/login?login=0",data:JSON.stringify({login:r,password:a})});d.fail(function(){var t=n.$id("ft-login");t.length&&(d.status>=400&&d.status<500?(n.ft.checkCredentials=null,t[0].setCustomValidity(i("production","ft:invalidCredentials"))):e.isConnected()?o.msg.show({type:"error",time:5e3,text:i("production","ft:requestFailure")}):(n.ft.checkCredentials=null,u(n)))}),d.done(function(e){e.super||/(engineer|leader)/i.test(e.prodFunction)||t.includes(e.privileges,"OPERATOR:ORDER_UNLOCK")?n.ft.checkCredentials=null:n.$id("ft-login")[0].setCustomValidity(i("production","ft:noPrivileges"))}),d.always(function(){n.$id("submit").prop("disabled",!1).click()})}.bind(null,n),d.find("input").each(function(){this.setCustomValidity("")})}}(d,n&&n[0]),l.prop("disabled",!1)})}else u(d)};function a(t,n,e){var i=t.$id("quantityDone"),o=parseInt(i.attr("min"),10),r=parseInt(i.attr("max"),10);isNaN(o)&&(o=0),isNaN(r)&&(r=9999),null===e&&(e=r),null===n&&(n=o),n>e&&(n=e),i.attr("min",n).attr("max",e).trigger("input")}function u(t){t.$id("ft").remove()}});