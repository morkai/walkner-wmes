// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/socket"],function(t,n,e){"use strict";function o(t,n){var e="/prodSerialNumbers?limit(1)&prodShiftOrder="+n.id;return t.ajax({url:e,timeout:1e4}).done(function(n){n&&n.totalCount&&i(t,n.totalCount,null)})}function r(n,e){var o="/orders/"+e.get("orderId")+"?select(qty,qtyMax,qtyDone)";return n.ajax({url:o,timeout:1e4}).done(function(o){var r=o.qty,a=o.qtyDone?o.qtyDone.total||0:0,u=o.qtyDone&&o.qtyDone.byLine?(t.findWhere(o.qtyDone.byLine,{_id:e.get("prodLine")})||{quantityDone:0}).quantityDone:0,d=e.get("quantityDone"),y=a-(u>=d?d:0),l=o.qtyMax||r,q=Math.max(0,l-y);i(n,0,q)})}function i(t,n,e){var o=t.$id("quantityDone");null!==n&&o.attr("min",n),null!==e&&o.attr("max",e),o.trigger("input")}var a={"W-1":!0,"W-2":!0,"W-3":!0,"WB-1":!0,"WB-2":!0,"WB-3":!0,"WB-4":!0,AV1:!0,AV1_P:!0,AV2:!0,AV2_P:!0};return function(t,i){if(i.id&&e.isConnected()){var u=t.$id("submit").prop("disabled",!0),d=[o(t,i)];i.get("orderId")&&!a[i.get("prodLine")]&&d.push(r(t,i)),n.when.apply(n,d).always(function(){u.prop("disabled",!1)})}}});