define(["underscore","jquery","app/core/View","app/production/templates/vkb"],function(e,t,s,i){"use strict";var n={BACKSPACE:'<i class="fa fa-long-arrow-left"></i>',LEFT:"<",RIGHT:">",CLEAR:'<i class="fa fa-eraser"></i>'};return s.extend({template:i,events:{"focus .btn[data-key]":function(e){this.trigger("keyFocused",e.currentTarget.dataset.key)},"click .btn[data-key]":function(e){var t=e.currentTarget.dataset.key,s=e.currentTarget.dataset.extendedKey;this.pressKey(s&&this.extended&&this.mode.extended?s:t)}},initialize:function(){this.fieldEl=null,this.adjustOverlap=!1,this.onValueChange=null,this.onKeyPress=null,this.extended=!1,this.mode={alpha:!1,numeric:!0,negative:!1,multiline:!1,extended:!1},t(window).on("resize."+this.idPrefix,e.debounce(this.reposition.bind(this),30))},destroy:function(){t(window).off("."+this.idPrefix),this.fieldEl=null,this.onValueChange=null},getTemplateData:function(){return{mode:this.mode,extended:this.extended}},reposition:function(){if(this.fieldEl){var e={top:"",right:"",bottom:"",left:""},s={marginLeft:""},i=this.$el,n=t(".modal-dialog");i.css(e),n.css(s);var a=n.offset(),d=n.outerWidth(),o=n.outerHeight(),l=i.offset(),h=i.outerWidth(),r=this.adjustOverlap&&a.top+o+30>l.top,u=this.adjustOverlap&&a.left+d+30>l.left;r&&this.mode.numeric&&!this.mode.alpha?(e.top=this.fieldEl.getBoundingClientRect().top+"px",e.left=a.left+d+30,e.bottom="auto",e.right="auto"):r&&u&&this.mode.alpha&&window.innerWidth>800&&(s.marginLeft=Math.max(30,window.innerWidth-30-h-30-d)+"px"),i.toggleClass("is-repositioned",r).css(e),n.css(s)}},show:function(s,i){var n=this;return i?"function"==typeof i&&(i={onValueChange:i}):i={},e.defaults(i,{onValueChange:null,onKeyPress:null}),(n.fieldEl!==s||n.onValueChange!==i.onValueChange||n.onKeyPress!==i.onKeyPress)&&(Object.keys(this.mode).forEach(function(e){n.mode[e]=!1}),(s.dataset.vkb||"").split(" ").forEach(function(e){n.mode[e]=!0}),n.render(),n.$el.removeClass("is-repositioned hidden"),t(".is-vkb-focused").removeClass("is-vkb-focused"),s.classList.add("is-vkb-focused"),n.fieldEl=s,n.adjustOverlap=!1!==i.adjustOverlap,n.onValueChange=i.onValueChange,n.onKeyPress=i.onKeyPress,n.updateExtended(),n.reposition(),!0)},hide:function(){t(".modal-dialog").css("margin-left",""),this.$el.addClass("hidden"),this.fieldEl&&this.fieldEl.classList.remove("is-vkb-focused"),this.fieldEl=null,this.onValueChange=null,this.onKeyPress=null},isVisible:function(){return!this.$el.hasClass("hidden")},enableKeys:function(){console.log("enableKeys"),this.$(".btn[data-key][disabled]").each(function(){this.disabled=!1})},disableKeys:function(e,t){null==t&&(t=!1),this.$(".btn[data-key]").each(function(){var s=e[this.dataset.key];t&&void 0===s||1===this.dataset.key.length&&(this.disabled=!0!==s)})},pressKey:function(e){var t=this.fieldEl;if(t&&(!this.onKeyPress||!1!==this.onKeyPress(e,t))){if("EXTENDED"===e)return this.toggleExtended();var s=t.value,i=t.selectionStart,n=t.selectionEnd;"ENTER"===e?e="\n":"SPACE"===e&&(e=" "),"CLEAR"===e?(i=0,s=""):"BACKSPACE"===e?(i-=1,s=s.substring(0,i)+s.substring(n)):"LEFT"===e?i-=1:"RIGHT"===e?i+=1:(!t.maxLength||-1===t.maxLength||s.length<t.maxLength)&&(s=s.substring(0,i)+e+s.substring(n),i+=1);var a=t.value!==s;t.value=s,t.focus(),t.setSelectionRange(i,i),a&&this.onValueChange&&this.onValueChange(t)}},toggleExtended:function(){this.extended=!this.extended,this.updateExtended()},updateExtended:function(){var e=this.mode.extended&&this.extended;this.$el.toggleClass("is-vkb-extended",e),this.$('.btn[data-key="EXTENDED"]').toggleClass("active",e),this.$(".btn[data-extended-key]").each(function(){var t=this.dataset[e?"extendedKey":"key"];this.innerHTML=n[t]||t})}})});