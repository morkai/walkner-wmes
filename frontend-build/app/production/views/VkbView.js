define(["underscore","jquery","app/core/View","app/production/templates/vkb"],function(e,t,i,n){"use strict";var s={BACKSPACE:'<i class="fa fa-long-arrow-left"></i>',LEFT:"<",RIGHT:">",CLEAR:'<i class="fa fa-eraser"></i>'};return i.extend({template:n,events:{"focus .btn[data-key]":function(e){this.trigger("keyFocused",e.currentTarget.dataset.key)},"click .btn[data-key]":function(e){var t=e.currentTarget.dataset.key,i=e.currentTarget.dataset.extendedKey;this.pressKey(i&&this.extended&&this.mode.extended?i:t)}},initialize:function(){this.fieldEl=null,this.onValueChange=null,this.extended=!1,this.mode={alpha:!1,numeric:!0,negative:!1,multiline:!1,extended:!1},t(window).on("resize."+this.idPrefix,e.debounce(this.reposition.bind(this),30))},destroy:function(){t(window).off("."+this.idPrefix),this.fieldEl=null,this.onValueChange=null},getTemplateData:function(){return{mode:this.mode,extended:this.extended}},reposition:function(){if(this.fieldEl){var e={top:"",right:"",bottom:"",left:""},i={marginLeft:""},n=this.$el,s=t(".modal-dialog");n.css(e),s.css(i);var d=s.offset(),a=s.outerWidth(),o=s.outerHeight(),l=n.offset(),h=n.outerWidth(),r=d.top+o+30>l.top,u=d.left+a+30>l.left;r&&this.mode.numeric&&!this.mode.alpha?(e.top=this.fieldEl.getBoundingClientRect().top+"px",e.left=d.left+a+30,e.bottom="auto",e.right="auto"):r&&u&&this.mode.alpha&&window.innerWidth>800&&(i.marginLeft=Math.max(30,window.innerWidth-30-h-30-a)+"px"),n.toggleClass("is-repositioned",r).css(e),s.css(i)}},show:function(e,i){var n=this;return(n.fieldEl!==e||n.onValueChange!==i)&&(Object.keys(this.mode).forEach(function(e){n.mode[e]=!1}),(e.dataset.vkb||"").split(" ").forEach(function(e){n.mode[e]=!0}),n.render(),n.$el.removeClass("is-repositioned hidden"),t(".is-vkb-focused").removeClass("is-vkb-focused"),e.classList.add("is-vkb-focused"),n.fieldEl=e,n.onValueChange=i,n.updateExtended(),n.reposition(),!0)},hide:function(){t(".modal-dialog").css("margin-left",""),this.$el.addClass("hidden"),this.fieldEl&&this.fieldEl.classList.remove("is-vkb-focused"),this.fieldEl=null,this.onValueChange=null},isVisible:function(){return!this.$el.hasClass("hidden")},enableKeys:function(){this.$(".btn[data-key][disabled]").each(function(){this.disabled=!1})},disableKeys:function(e){this.$(".btn[data-key]").each(function(){1===this.dataset.key.length&&(this.disabled=!0!==e[this.dataset.key])})},pressKey:function(e){var t=this.fieldEl;if(t){if("EXTENDED"===e)return this.toggleExtended();var i=t.value,n=t.selectionStart,s=t.selectionEnd;"ENTER"===e?e="\n":"SPACE"===e&&(e=" "),"CLEAR"===e?(n=0,i=""):"BACKSPACE"===e?(n-=1,i=i.substring(0,n)+i.substring(s)):"LEFT"===e?n-=1:"RIGHT"===e?n+=1:(!t.maxLength||-1===t.maxLength||i.length<t.maxLength)&&(i=i.substring(0,n)+e+i.substring(s),n+=1);var d=t.value!==i;t.value=i,t.focus(),t.setSelectionRange(n,n),d&&this.onValueChange&&this.onValueChange(t)}},toggleExtended:function(){this.extended=!this.extended,this.updateExtended()},updateExtended:function(){var e=this.mode.extended&&this.extended;this.$el.toggleClass("is-vkb-extended",e),this.$('.btn[data-key="EXTENDED"]').toggleClass("active",e),this.$(".btn[data-extended-key]").each(function(){var t=this.dataset[e?"extendedKey":"key"];this.innerHTML=s[t]||t})}})});