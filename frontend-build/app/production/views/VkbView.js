// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/production/templates/vkb"],function(e,i,t,s){"use strict";return t.extend({template:s,events:{"click .btn[data-key]":function(e){this.pressKey(e.currentTarget.dataset.key)}},initialize:function(){this.fieldEl=null,this.onValueChange=null,this.mode={alpha:!1,numeric:!0,multiline:!1},i(window).on("resize."+this.idPrefix,e.debounce(this.reposition.bind(this),30))},destroy:function(){i(window).off("."+this.idPrefix),this.fieldEl=null,this.onValueChange=null},serialize:function(){return{idPrefix:this.idPrefix,mode:this.mode}},reposition:function(){if(this.fieldEl){var e={top:"",right:"",bottom:"",left:""},t={marginLeft:""},s=this.$el,n=i(".modal-dialog");s.css(e),n.css(t);var o=n.offset(),l=n.outerWidth(),a=n.outerHeight(),d=s.offset(),h=s.outerWidth(),r=o.top+a+30>d.top,u=o.left+l+30>d.left;r&&this.mode.numeric&&!this.mode.alpha?(e.top=this.fieldEl.getBoundingClientRect().top+"px",e.left=o.left+l+30,e.bottom="auto",e.right="auto"):r&&u&&this.mode.alpha&&window.innerWidth>800&&(t.marginLeft=Math.max(30,window.innerWidth-30-h-30-l)+"px"),s.toggleClass("is-repositioned",r).css(e),n.css(t)}},show:function(e,t){var s=this;return(s.fieldEl!==e||s.onValueChange!==t)&&(Object.keys(this.mode).forEach(function(e){s.mode[e]=!1}),(e.dataset.vkb||"").split(" ").forEach(function(e){s.mode[e]=!0}),s.render(),s.$el.removeClass("is-repositioned hidden"),i(".is-vkb-focused").removeClass("is-vkb-focused"),e.classList.add("is-vkb-focused"),s.fieldEl=e,s.onValueChange=t,s.reposition(),!0)},hide:function(){i(".modal-dialog").css("margin-left",""),this.$el.addClass("hidden"),this.fieldEl&&this.fieldEl.classList.remove("is-vkb-focused"),this.fieldEl=null,this.onValueChange=null},isVisible:function(){return!this.$el.hasClass("hidden")},enableKeys:function(){this.$(".btn[data-key][disabled]").each(function(){this.disabled=!1})},disableKeys:function(e){this.$(".btn[data-key]").each(function(){1===this.dataset.key.length&&(this.disabled=e[this.dataset.key]!==!0)})},pressKey:function(e){var i=this.fieldEl;if(i){var t=i.value,s=i.selectionStart,n=i.selectionEnd;"ENTER"===e?e="\n":"SPACE"===e&&(e=" "),"CLEAR"===e?(s=0,t=""):"BACKSPACE"===e?(s-=1,t=t.substring(0,s)+t.substring(n)):"LEFT"===e?s-=1:"RIGHT"===e?s+=1:(!i.maxLength||i.maxLength===-1||t.length<i.maxLength)&&(t=t.substring(0,s)+e+t.substring(n),s+=1);var o=i.value!==t;i.value=t,i.focus(),i.setSelectionRange(s,s),o&&this.onValueChange&&this.onValueChange(i)}}})});