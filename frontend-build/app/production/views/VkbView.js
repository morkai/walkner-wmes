define(["underscore","jquery","app/core/View","app/core/util/decimalSeparator","app/production/templates/vkb"],function(e,t,i,s,n){"use strict";var a={BACKSPACE:'<i class="fa fa-long-arrow-left"></i>',LEFT:"<",RIGHT:">",CLEAR:'<i class="fa fa-eraser"></i>'};return i.extend({template:n,events:{"focus .btn[data-key]":function(e){this.trigger("keyFocused",e.currentTarget.dataset.key)},"click .btn[data-key]":function(e){var t=e.currentTarget.dataset.key,i=e.currentTarget.dataset.extendedKey;this.pressKey(i&&this.extended&&this.mode.extended?i:t)}},initialize:function(){this.fieldEl=null,this.positioner=null,this.adjustOverlap=!1,this.onValueChange=null,this.onKeyPress=null,this.extended=!1,this.mode={alpha:!1,numeric:!0,negative:!1,multiline:!1,extended:!1},t(window).on("resize."+this.idPrefix,e.debounce(this.reposition.bind(this),30))},destroy:function(){t(window).off("."+this.idPrefix),this.fieldEl=null,this.onValueChange=null},getTemplateData:function(){return{mode:this.mode,extended:this.extended,decimalSeparator:s}},reposition:function(){if(this.fieldEl){var e={top:"",right:"",bottom:"",left:""},i={marginLeft:""},s=this.$el,n=t(".modal-dialog");s.css(e),n.css(i);var a=n.offset(),o=n.outerWidth(),d=n.outerHeight(),l=s.offset(),r=s.outerWidth(),h=this.adjustOverlap&&a.top+d+30>l.top,u=this.adjustOverlap&&a.left+o+30>l.left;h&&this.mode.numeric&&!this.mode.alpha?(e.top=this.fieldEl.getBoundingClientRect().top+"px",e.left=a.left+o+30,e.bottom="auto",e.right="auto"):h&&u&&this.mode.alpha&&window.innerWidth>800&&(i.marginLeft=Math.max(30,window.innerWidth-30-r-30-o)+"px"),this.positioner?this.positioner(e,i):(s.toggleClass("is-repositioned",h).css(e),n.css(i))}},show:function(i,s){var n=this;return s?"function"==typeof s&&(s={onValueChange:s}):s={},e.defaults(s,{onValueChange:null,onKeyPress:null,positioner:null}),(n.fieldEl!==i||n.onValueChange!==s.onValueChange||n.onKeyPress!==s.onKeyPress)&&(Object.keys(this.mode).forEach(function(e){n.mode[e]=!1}),(i.dataset.vkb||"").split(" ").forEach(function(e){n.mode[e]=!0}),n.render(),n.$el.removeClass("is-repositioned hidden"),t(".is-vkb-focused").removeClass("is-vkb-focused"),i.classList.add("is-vkb-focused"),n.fieldEl=i,n.positioner=s.positioner,n.adjustOverlap=!1!==s.adjustOverlap,n.onValueChange=s.onValueChange,n.onKeyPress=s.onKeyPress,n.updateExtended(),n.reposition(),!0)},hide:function(){t(".modal-dialog").css("margin-left",""),this.$el.addClass("hidden"),this.fieldEl&&this.fieldEl.classList.remove("is-vkb-focused"),this.fieldEl=null,this.positioner=null,this.onValueChange=null,this.onKeyPress=null},isVisible:function(){return!this.$el.hasClass("hidden")},enableKeys:function(){this.$(".btn[data-key][disabled]").each(function(){this.disabled=!1})},disableKeys:function(e,t){null==t&&(t=!1),this.$(".btn[data-key]").each(function(){var i=e[this.dataset.key];t&&void 0===i||1===this.dataset.key.length&&(this.disabled=!0!==i)})},pressKey:function(e){var t=this.fieldEl;if(t&&(!this.onKeyPress||!1!==this.onKeyPress(e,t))){if("EXTENDED"===e)return this.toggleExtended();var i=t.value,s=t.selectionStart,n=t.selectionEnd;"ENTER"===e?e="\n":"SPACE"===e&&(e=" "),"CLEAR"===e?(s=0,i=""):"BACKSPACE"===e?(s-=1,i=i.substring(0,s)+i.substring(n)):"LEFT"===e?s-=1:"RIGHT"===e?s+=1:(!t.maxLength||-1===t.maxLength||i.length<t.maxLength)&&(i=i.substring(0,s)+e+i.substring(n),s+=1);var a=t.value!==i;t.value=i,t.focus(),t.setSelectionRange(s,s),a&&this.onValueChange&&this.onValueChange(t)}},toggleExtended:function(){this.extended=!this.extended,this.updateExtended()},updateExtended:function(){var e=this.mode.extended&&this.extended;this.$el.toggleClass("is-vkb-extended",e),this.$('.btn[data-key="EXTENDED"]').toggleClass("active",e),this.$(".btn[data-extended-key]").each(function(){var t=this.dataset[e?"extendedKey":"key"];this.innerHTML=a[t]||t})}})});