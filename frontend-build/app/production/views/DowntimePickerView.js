// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/time","app/viewport","app/data/aors","app/data/downtimeReasons","app/core/View","app/production/templates/downtimePicker"],function(e,t,o,i,s,n,a){return n.extend({template:a,dialogClassName:"production-modal",events:{"keypress .select2-container":function(e){13===e.which&&(e.preventDefault(),this.$el.submit())},"keypress textarea":function(e){13===e.which&&""===e.target.value.trim()&&(e.preventDefault(),this.$el.submit())},submit:function(e){e.preventDefault();var t=this.$('.btn[type="submit"]')[0];t.disabled||(t.disabled=!0,this.handlePick(t))},"click .production-downtimePicker-now":function(){var e=Date.now();this.$id("startedAt").val(t.format(e,"YYYY-MM-DD, HH:mm:ss")).attr("data-time",e)}},destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},serialize:function(){return{idPrefix:this.idPrefix,startedAt:this.model.startedAt,mode:this.model.mode}},afterRender:function(){this.model.reason&&this.$id("reason").val(this.model.reason),this.model.aor&&this.$id("aor").val(this.model.aor),this.model.reasonComment&&this.$id("reasonComment").val(this.model.reasonComment),this.setUpReasonSelect2(),this.setUpAorSelect2(),this.focusControl()},onDialogShown:function(){this.focusControl()},focusControl:function(){this.model.reason?this.model.aor?"edit"===this.model.mode?this.$id("reasonComment").focus():this.$(".btn-danger").focus():this.$id("aor").select2("focus"):this.$id("reason").select2("focus")},setUpReasonSelect2:function(){var e=this,t=this.$id("reason");t.select2({dropdownCssClass:"production-dropdown",openOnEnter:null,data:this.model.prodShift.getDowntimeReasons().map(function(e){return{id:e.id,text:e.id+" - "+e.get("label")}}).sort(function(e,t){return e.id.localeCompare(t.id)})}),t.on("change",function(){t.select2("val")&&e.$id("aor").select2("focus")})},setUpAorSelect2:function(){var e=this,t=this.$id("aor");t.select2({dropdownCssClass:"production-dropdown",openOnEnter:null,data:i.map(function(e){return{id:e.id,text:e.get("name")}})}),t.on("change",function(){t.select2("val")&&e.$id("reasonComment").select()})},handlePick:function(t){var i=this.$id("reason").select2("val"),s=this.$id("aor").select2("val"),n=this.$id("reasonComment").val();return i?s?void this.trigger("downtimePicked",{reason:i,reasonComment:n,aor:s,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("aor").select2("focus"),t.disabled=!1,o.msg.show({type:"error",time:2e3,text:e("production","downtimePicker:msg:emptyAor")})):(this.$id("reason").select2("focus"),t.disabled=!1,o.msg.show({type:"error",time:2e3,text:e("production","downtimePicker:msg:emptyReason")}))}})});