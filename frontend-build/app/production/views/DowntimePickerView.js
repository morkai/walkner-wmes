// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/time","app/viewport","app/data/aors","app/core/View","app/prodDowntimes/util/reasonAndAor","app/production/templates/downtimePicker"],function(e,t,o,s,i,d,n,r){"use strict";return d.extend({template:r,dialogClassName:"production-modal",events:{"keypress .select2-container":function(e){13===e.which&&(e.preventDefault(),this.$el.submit())},"keypress textarea":function(e){13===e.which&&""===e.target.value.trim()&&(e.preventDefault(),this.$el.submit())},submit:function(e){e.preventDefault();var t=this.$('.btn[type="submit"]')[0];t.disabled||(t.disabled=!0,this.options.embedded?this.handleEmbeddedPick(t):this.handlePick(t))},"click .production-downtimePicker-now":function(){var e=Date.now();this.$id("startedAt").val(o.format(e,"YYYY-MM-DD, HH:mm:ss")).attr("data-time",e)},"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.model.reason=null,this.model.aor=null,this.timers.clearSelect2=setTimeout(function(e){e.setUpReasonSelect2(),e.setUpAorSelect2(),e.$id("reason").select2("focus")},1,this)},"change #-reason":function(e){this.model.reason=e.target.value,this.setUpAorSelect2(),this.$id("aor").select2("focus")},"change #-aor":function(e){this.model.aor=e.target.value,this.setUpReasonSelect2(),null===this.$id("reason").select2("data")?this.$id("reason").select2("focus"):this.$id("reasonComment").focus()},"focus #-reasonComment":function(e){this.options.embedded&&this.options.vkb&&this.options.vkb.show(e.target)},"click #-clearReason":function(){this.selectEmbeddedReason(null)},"click #-clearAor":function(){this.selectEmbeddedAor(null)},"click #-selectedReason":function(){this.options.vkb&&this.options.vkb.hide(),this.$id("startedAtGroup").addClass("hidden"),this.$id("aorGroup").addClass("hidden"),this.$id("commentGroup").addClass("hidden"),this.$id("submit").prop("disabled",!0);var t=this.$id("reasonGroup").css("margin-top","15px"),o=t.find(".btn-group-vertical"),s=this.model.reason,i="";n.getReasonsForAor(this,this.model.aor).sort(function(e,t){return e.reason.getLabel().localeCompare(t.reason.getLabel())}).forEach(function(t){var o="btn btn-lg btn-default "+(t.reason.id===s?"active":"");i+='<button type="button" class="'+o+'" data-reason="'+t.reason.id+'">'+e.escape(t.reason.getLabel())+"</button>"}),t.find(".production-downtimePicker-btn-group").addClass("hidden"),o.html(i).removeClass("hidden");var d=o.find(".active")[0];d&&d.scrollIntoView()},"click #-selectedAor":function(){this.options.vkb&&this.options.vkb.hide(),this.$id("startedAtGroup").addClass("hidden"),this.$id("reasonGroup").addClass("hidden"),this.$id("commentGroup").addClass("hidden"),this.$id("submit").prop("disabled",!0);var t=this.$id("aorGroup").css("margin-top","15px"),o=t.find(".btn-group-vertical"),s=this.model.aor,i="";n.getAorsForReason(this,this.model.reason).sort(function(e,t){return e.aor.getLabel().localeCompare(t.aor.getLabel())}).forEach(function(t){var o="btn btn-lg btn-default "+(t.aor.id===s?"active":"");i+='<button type="button" class="'+o+'" data-aor="'+t.aor.id+'">'+e.escape(t.aor.getLabel())+"</button>"}),t.find(".production-downtimePicker-btn-group").addClass("hidden"),o.html(i).removeClass("hidden");var d=o.find(".active")[0];d&&d.scrollIntoView()},"click .btn[data-reason]":function(e){if(this.selectEmbeddedReason(e.currentTarget.dataset.reason),!this.model.aor&&this.model.reason){var t=n.getAorsForReason(this,this.model.reason);1===t.length&&this.selectEmbeddedAor(t[0].id)}},"click .btn[data-aor]":function(e){this.selectEmbeddedAor(e.currentTarget.dataset.aor)}},initialize:function(){n.initialize(this)},destroy:function(){n.destroy(this),this.options.vkb&&this.options.vkb.hide()},serialize:function(){return{idPrefix:this.idPrefix,startedAt:this.model.startedAt,mode:this.model.mode,embedded:this.options.embedded}},afterRender:function(){var e=this.model.prodShift.getDowntimeReasons().sort(function(e,t){return e.id.localeCompare(t.id)});return n.setUpReasons(this,e,this.model.prodShift.get("subdivision")),n.setUpAors(this),this.model.reasonComment&&this.$id("reasonComment").val(this.model.reasonComment),this.options.embedded?this.setUpEmbeddedFields():(this.model.reason&&this.$id("reason").val(this.model.reason),this.model.aor&&this.$id("aor").val(this.model.aor),this.setUpReasonSelect2(),this.setUpAorSelect2(),void this.focusControl())},setUpEmbeddedFields:function(){this.selectEmbeddedReason(this.model.reason),this.selectEmbeddedAor(this.model.aor)},selectEmbeddedReason:function(e){e=n.reasons.get(e);var o="<span>"+(e?e.getLabel():t("production","downtimePicker:reason:placeholder"))+"</span>";this.$id("selectedReason").html(o).val(e?e.id:"");var s=this.$id("reasonGroup");s.find(".btn-group-vertical").addClass("hidden"),s.find(".production-downtimePicker-btn-group").removeClass("hidden"),this.$id("startedAtGroup").removeClass("hidden"),this.$id("aorGroup").removeClass("hidden"),this.$id("commentGroup").removeClass("hidden"),this.$id("submit").prop("disabled",!1),this.model.reason=e?e.id:null},selectEmbeddedAor:function(e){e=n.aors.get(e);var o="<span>"+(e?e.getLabel():t("production","downtimePicker:aor:placeholder"))+"</span>";this.$id("selectedAor").html(o).val(e?e.id:"");var s=this.$id("aorGroup");s.find(".btn-group-vertical").addClass("hidden"),s.find(".production-downtimePicker-btn-group").removeClass("hidden"),this.$id("startedAtGroup").removeClass("hidden"),this.$id("reasonGroup").removeClass("hidden"),this.$id("commentGroup").removeClass("hidden"),this.$id("submit").prop("disabled",!1),this.model.aor=e?e.id:null},onDialogShown:function(){this.focusControl()},focusControl:function(){this.options.embedded||(this.model.reason?this.model.aor?"edit"===this.model.mode?this.$id("reasonComment").focus():this.$(".btn-danger").focus():this.$id("aor").select2("focus"):this.$id("reason").select2("focus"))},setUpReasonSelect2:function(){n.setUpReasonSelect2(this,this.model.aor,{allowClear:!0,dropdownCssClass:"production-dropdown"})},setUpAorSelect2:function(){n.setUpAorSelect2(this,this.model.reason,{allowClear:!0,dropdownCssClass:"production-dropdown"})},handleEmbeddedPick:function(e){var o=this.$id("selectedReason").val(),i=this.$id("selectedAor").val(),d=this.$id("reasonComment").val();return o?i?void this.trigger("downtimePicked",{reason:o,reasonComment:d,aor:i,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("selectedAor").focus(),e.disabled=!1,s.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyAor")})):(this.$id("selectedReason").focus(),e.disabled=!1,s.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyReason")}))},handlePick:function(e){var o=this.$id("reason").select2("val"),i=this.$id("aor").select2("val"),d=this.$id("reasonComment").val();return o?i?void this.trigger("downtimePicked",{reason:o,reasonComment:d,aor:i,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("aor").select2("focus"),e.disabled=!1,s.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyAor")})):(this.$id("reason").select2("focus"),e.disabled=!1,s.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyReason")}))}})});