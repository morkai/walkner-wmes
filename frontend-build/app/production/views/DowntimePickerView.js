// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/viewport","app/data/aors","app/core/View","app/production/templates/downtimePicker"],function(t,e,s,o,i,n,r){"use strict";return n.extend({template:r,dialogClassName:"production-modal",events:{"keypress .select2-container":function(t){13===t.which&&(t.preventDefault(),this.$el.submit())},"keypress textarea":function(t){13===t.which&&""===t.target.value.trim()&&(t.preventDefault(),this.$el.submit())},submit:function(t){t.preventDefault();var e=this.$('.btn[type="submit"]')[0];e.disabled||(e.disabled=!0,this.handlePick(e))},"click .production-downtimePicker-now":function(){var t=Date.now();this.$id("startedAt").val(s.format(t,"YYYY-MM-DD, HH:mm:ss")).attr("data-time",t)},"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.model.reason=null,this.model.aor=null,this.timers.clearSelect2=setTimeout(function(t){t.setUpReasonSelect2(),t.setUpAorSelect2(),t.$id("reason").select2("focus")},1,this)},"change #-reason":function(t){this.model.reason=t.target.value,this.setUpAorSelect2(),this.$id("aor").select2("focus")},"change #-aor":function(t){this.model.aor=t.target.value,this.setUpReasonSelect2(),null===this.$id("reason").select2("data")?this.$id("reason").select2("focus"):this.$id("reasonComment").focus()}},initialize:function(){this.reasonsToAorsMap={},this.reasonsList=[],this.aorsList={}},destroy:function(){this.reasonsToAorsMap=null,this.reasonsList=null,this.aorsList=null},serialize:function(){return{idPrefix:this.idPrefix,startedAt:this.model.startedAt,mode:this.model.mode}},afterRender:function(){this.model.reason&&this.$id("reason").val(this.model.reason),this.model.aor&&this.$id("aor").val(this.model.aor),this.model.reasonComment&&this.$id("reasonComment").val(this.model.reasonComment),this.setUpReasons(),this.setUpAors(),this.setUpReasonSelect2(),this.setUpAorSelect2(),this.focusControl()},onDialogShown:function(){this.focusControl()},focusControl:function(){this.model.reason?this.model.aor?"edit"===this.model.mode?this.$id("reasonComment").focus():this.$(".btn-danger").focus():this.$id("aor").select2("focus"):this.$id("reason").select2("focus")},getReasonsForAor:function(t){if(!t)return this.reasonsList;for(var e=[],s=0;s<this.reasonsList.length;++s){var o=this.reasonsList[s];(!o.aors||o.aors[t])&&e.push(o)}return e},getAorsForReason:function(e){if(!e)return this.aorsList;var s=this.reasonsToAorsMap[e];if(void 0===s)return[];if(null===s)return this.aorsList;var o=[];return t.forEach(Object.keys(s),function(t){o.push({id:t,text:i.get(t).get("name")})}),o},setUpReasons:function(){var e={},s=[],o=this.model.prodShift.getDowntimeReasons().sort(function(t,e){return t.id.localeCompare(e.id)});t.forEach(o,function(o){var i={},n=!1;t.forEach(o.get("aors"),function(t){i[t]=!0,n=!0}),n||(i=null),e[o.id]=i,s.push({id:o.id,text:o.id+" - "+o.get("label"),aors:i})}),this.reasonsToAorsMap=e,this.reasonsList=s},setUpAors:function(){var t=[];i.forEach(function(e){t.push({id:e.id,text:e.get("name")})}),this.aorsList=t},setUpReasonSelect2:function(){var t=this.$id("reason"),e=this.getReasonsForAor(this.model.aor);t.select2({allowClear:!0,dropdownCssClass:"production-dropdown",openOnEnter:null,data:e}),null===t.select2("data")&&t.select2("val",1===e.length?e[0].id:"")},setUpAorSelect2:function(){var t=this.$id("aor"),e=this.getAorsForReason(this.model.reason);t.select2({allowClear:!0,dropdownCssClass:"production-dropdown",openOnEnter:null,data:e}),null===t.select2("data")&&t.select2("val",1===e.length?e[0].id:"")},handlePick:function(t){var s=this.$id("reason").select2("val"),i=this.$id("aor").select2("val"),n=this.$id("reasonComment").val();return s?i?void this.trigger("downtimePicked",{reason:s,reasonComment:n,aor:i,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("aor").select2("focus"),t.disabled=!1,o.msg.show({type:"error",time:2e3,text:e("production","downtimePicker:msg:emptyAor")})):(this.$id("reason").select2("focus"),t.disabled=!1,o.msg.show({type:"error",time:2e3,text:e("production","downtimePicker:msg:emptyReason")}))}})});