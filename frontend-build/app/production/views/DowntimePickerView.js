define(["underscore","jquery","app/i18n","app/time","app/viewport","app/data/aors","app/core/View","app/core/util/transliterate","app/prodDowntimes/util/reasonAndAor","app/production/templates/downtimePicker"],function(e,t,i,s,o,d,n,a,r,l){"use strict";return n.extend({template:l,dialogClassName:"production-modal",events:{"keypress .select2-container":function(e){13===e.which&&(e.preventDefault(),this.$el.submit())},"keypress textarea":function(e){13===e.which&&""===e.target.value.trim()&&(e.preventDefault(),this.$el.submit())},submit:function(e){e.preventDefault();var t=this.$('.btn[type="submit"]')[0];t.disabled||(t.disabled=!0,this.options.embedded?this.handleEmbeddedPick(t):this.handlePick(t))},"click .production-downtimePicker-now":function(){var e=Date.now();this.$id("startedAt").val(s.format(e,"YYYY-MM-DD, HH:mm:ss")).attr("data-time",e)},"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.model.reason=null,this.model.aor=null,this.timers.clearSelect2=setTimeout(function(e){e.setUpReasonSelect2(),e.setUpAorSelect2(),e.$id("reason").select2("focus")},1,this)},"change #-reason":function(e){this.model.reason=e.target.value,this.setUpAorSelect2(),this.$id("aor").select2("focus")},"change #-aor":function(e){this.model.aor=e.target.value,this.setUpReasonSelect2(),null===this.$id("reason").select2("data")?this.$id("reason").select2("focus"):this.$id("reasonComment").focus()},"focus [data-vkb]":function(e){this.options.embedded&&this.options.vkb&&this.options.vkb.show(e.target,this.onVkbValueChange)},"click #-clearReason":function(){this.selectEmbeddedReason(null)},"click #-clearAor":function(){this.selectEmbeddedAor(null)},"click #-selectedReason":function(){this.options.vkb&&this.options.vkb.hide(),this.$id("startedAtGroup").addClass("hidden"),this.$id("aorGroup").addClass("hidden"),this.$id("commentGroup").addClass("hidden"),this.$id("submit").prop("disabled",!0);var t=this.$id("reasonFilter"),i=this.$id("reasonGroup").css("margin-top","15px"),s=i.find(".btn-group-vertical"),o=this.model.reason,d="";r.getReasonsForAor(this,this.model.aor).sort(function(e,t){return e.reason.getLabel().localeCompare(t.reason.getLabel())}).forEach(function(t){var i="btn btn-lg btn-default "+(t.reason.id===o?"active":""),s=a(t.reason.id+t.reason.getLabel()).toUpperCase().replace(/[^A-Z0-9]+/g,"");d+='<button type="button" class="'+i+'" data-reason="'+t.reason.id+'" data-filter="'+s+'"><strong>'+t.reason.id+"</strong>"+e.escape(t.reason.getLabel())+"</button>"}),i.find(".production-downtimePicker-btn-group").addClass("hidden"),i.find("label").addClass("hidden"),t.removeClass("hidden"),s.html(d).removeClass("hidden"),t.focus();var n=s.find(".active")[0];n&&n.scrollIntoView(),this.selectingOption=!0},"click #-selectedAor":function(){this.options.vkb&&this.options.vkb.hide(),this.$id("startedAtGroup").addClass("hidden"),this.$id("reasonGroup").addClass("hidden"),this.$id("commentGroup").addClass("hidden"),this.$id("submit").prop("disabled",!0);var t=this.$id("aorFilter"),i=this.$id("aorGroup").css("margin-top","15px"),s=i.find(".btn-group-vertical"),o=this.model.aor,d="";r.getAorsForReason(this,this.model.reason).sort(function(e,t){return e.aor.getLabel().localeCompare(t.aor.getLabel())}).forEach(function(t){var i="btn btn-lg btn-default "+(t.aor.id===o?"active":""),s=a(t.aor.getLabel()).toUpperCase().replace(/[^A-Z0-9]+/g,"");d+='<button type="button" class="'+i+'" data-aor="'+t.aor.id+'" data-filter="'+s+'">'+e.escape(t.aor.getLabel())+"</button>"}),i.find(".production-downtimePicker-btn-group").addClass("hidden"),i.find("label").addClass("hidden"),t.removeClass("hidden"),s.html(d).removeClass("hidden"),t.focus();var n=s.find(".active")[0];n&&n.scrollIntoView(),this.selectingOption=!0},"click .btn[data-reason]":function(e){if(this.selectEmbeddedReason(e.currentTarget.dataset.reason),!this.model.aor&&this.model.reason){var t=r.getAorsForReason(this,this.model.reason);1===t.length&&this.selectEmbeddedAor(t[0].id)}},"click .btn[data-aor]":function(e){this.selectEmbeddedAor(e.currentTarget.dataset.aor)},"input #-reasonFilter":"filterReasons","input #-aorFilter":"filterAors","keyup #-reasonFilter, #-aorFilter":function(e){if(13===e.keyCode){var t=this.$(e.target).next().find(".btn:not(.hidden)");1===t.length&&t.first().click()}}},initialize:function(){this.onVkbValueChange=this.onVkbValueChange.bind(this),this.selectingOption=!1,r.initialize(this),t(window).on("keyup."+this.idPrefix,this.onKeyUp.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),r.destroy(this),this.options.vkb&&this.options.vkb.hide()},serialize:function(){return{idPrefix:this.idPrefix,startedAt:this.model.startedAt,mode:this.model.mode,embedded:this.options.embedded}},afterRender:function(){var e=this.model.prodShift.getDowntimeReasons().sort(function(e,t){return e.id.localeCompare(t.id)});if(r.setUpReasons(this,e,this.model.prodShift.get("subdivision")),r.setUpAors(this),this.model.reasonComment&&this.$id("reasonComment").val(this.model.reasonComment),this.options.embedded)return this.setUpEmbeddedFields();this.model.reason&&this.$id("reason").val(this.model.reason),this.model.aor&&this.$id("aor").val(this.model.aor),this.setUpReasonSelect2(),this.setUpAorSelect2(),this.focusControl()},setUpEmbeddedFields:function(){this.selectEmbeddedReason(this.model.reason),this.selectEmbeddedAor(this.model.aor)},selectEmbeddedReason:function(e){var t="<span>"+((e=r.reasons.get(e))?e.getLabel():i("production","downtimePicker:reason:placeholder"))+"</span>";this.$id("selectedReason").html(t).val(e?e.id:""),this.$id("reasonFilter").val("").addClass("hidden");var s=this.$id("reasonGroup");s.find(".btn-group-vertical").addClass("hidden"),s.find("label").removeClass("hidden"),s.find(".production-downtimePicker-btn-group").removeClass("hidden"),this.$id("startedAtGroup").removeClass("hidden"),this.$id("aorGroup").removeClass("hidden"),this.$id("commentGroup").removeClass("hidden"),this.$id("submit").prop("disabled",!1),this.model.reason=e?e.id:null,this.selectingOption=!1},selectEmbeddedAor:function(e){var t="<span>"+((e=r.aors.get(e))?e.getLabel():i("production","downtimePicker:aor:placeholder"))+"</span>";this.$id("selectedAor").html(t).val(e?e.id:""),this.$id("aorFilter").val("").addClass("hidden");var s=this.$id("aorGroup");s.find(".btn-group-vertical").addClass("hidden"),s.find("label").removeClass("hidden"),s.find(".production-downtimePicker-btn-group").removeClass("hidden"),this.$id("startedAtGroup").removeClass("hidden"),this.$id("reasonGroup").removeClass("hidden"),this.$id("commentGroup").removeClass("hidden"),this.$id("submit").prop("disabled",!1),this.model.aor=e?e.id:null,this.selectingOption=!1},onVkbValueChange:function(e){/reasonFilter/.test(e.id)?this.filterReasons():/aorFilter/.test(e.id)&&this.filterAors()},onDialogShown:function(){this.focusControl()},onKeyUp:function(e){if(!(!this.selectingOption||document.activeElement&&document.activeElement.dataset.vkb)){var i=t(".production-vkb");i.length&&!i.hasClass("hidden")&&i.find('.btn[data-key="'+e.originalEvent.key.toUpperCase()+'"]').click()}},filterReasons:function(){var e=this.$id("reasonGroup").find(".btn-group-vertical").find(".btn"),t=a(this.$id("reasonFilter").val()).toUpperCase().replace(/[^A-Z0-9]+/g,"");r.reasons.get(t)?e.addClass("hidden").filter('.btn[data-reason="'+t+'"]').removeClass("hidden"):t.length?e.addClass("hidden").filter('.btn[data-filter*="'+t+'"]').removeClass("hidden"):e.removeClass("hidden")},filterAors:function(){var e=this.$id("aorGroup").find(".btn-group-vertical").find(".btn"),t=a(this.$id("aorFilter").val()).toUpperCase().replace(/[^A-Z0-9]+/g,"");t.length?e.addClass("hidden").filter('.btn[data-filter*="'+t+'"]').removeClass("hidden"):e.removeClass("hidden")},focusControl:function(){this.options.embedded||(this.model.reason?this.model.aor?"edit"===this.model.mode?this.$id("reasonComment").focus():this.$(".btn-danger").focus():this.$id("aor").select2("focus"):this.$id("reason").select2("focus"))},setUpReasonSelect2:function(){r.setUpReasonSelect2(this,this.model.aor,{allowClear:!0,dropdownCssClass:"production-dropdown"})},setUpAorSelect2:function(){r.setUpAorSelect2(this,this.model.reason,{allowClear:!0,dropdownCssClass:"production-dropdown"})},handleEmbeddedPick:function(e){var t=this.$id("selectedReason").val(),s=this.$id("selectedAor").val(),d=this.$id("reasonComment").val();return t?s?void this.trigger("downtimePicked",{reason:t,reasonComment:d,aor:s,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("selectedAor").focus(),e.disabled=!1,o.msg.show({type:"error",time:2e3,text:i("production","downtimePicker:msg:emptyAor")})):(this.$id("selectedReason").focus(),e.disabled=!1,o.msg.show({type:"error",time:2e3,text:i("production","downtimePicker:msg:emptyReason")}))},handlePick:function(e){var t=this.$id("reason").select2("val"),s=this.$id("aor").select2("val"),d=this.$id("reasonComment").val();return t?s?void this.trigger("downtimePicked",{reason:t,reasonComment:d,aor:s,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("aor").select2("focus"),e.disabled=!1,o.msg.show({type:"error",time:2e3,text:i("production","downtimePicker:msg:emptyAor")})):(this.$id("reason").select2("focus"),e.disabled=!1,o.msg.show({type:"error",time:2e3,text:i("production","downtimePicker:msg:emptyReason")}))}})});