// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/time","app/viewport","app/data/aors","app/data/downtimeReasons","app/core/View","app/production/templates/downtimePicker"],function(t,e,o,i,s,n,a){return n.extend({template:a,dialogClassName:"production-modal",events:{"keypress .select2-container":function(t){13===t.which&&(t.preventDefault(),this.$el.submit())},"keypress textarea":function(t){13===t.which&&""===t.target.value.trim()&&(t.preventDefault(),this.$el.submit())},submit:function(t){t.preventDefault();var e=this.$('.btn[type="submit"]')[0];e.disabled||(e.disabled=!0,this.handlePick(e))},"click .production-downtimePicker-now":function(){var t=Date.now();this.$id("startedAt").val(e.format(t,"YYYY-MM-DD, HH:mm:ss")).attr("data-time",t)}},serialize:function(){return{idPrefix:this.idPrefix,startedAt:this.model.startedAt,mode:this.model.mode}},afterRender:function(){this.model.reason&&this.$id("reason").val(this.model.reason),this.model.aor&&this.$id("aor").val(this.model.aor),this.model.reasonComment&&this.$id("reasonComment").val(this.model.reasonComment),this.setUpReasonSelect2(),this.setUpAorSelect2(),this.focusControl()},onDialogShown:function(){this.focusControl()},focusControl:function(){this.model.reason?this.model.aor?"edit"===this.model.mode?this.$id("reasonComment").focus():this.$(".btn-danger").focus():this.$id("aor").select2("focus"):this.$id("reason").select2("focus")},setUpReasonSelect2:function(){var t=this,e=this.$id("reason");e.select2({dropdownCssClass:"production-dropdown",openOnEnter:null,data:this.model.prodShift.getDowntimeReasons().map(function(t){return{id:t.id,text:t.id+" - "+t.get("label")}}).sort(function(t,e){return t.id.localeCompare(e.id)})}),e.on("change",function(){e.select2("val")&&t.$id("aor").select2("focus")})},setUpAorSelect2:function(){var t=this,e=this.$id("aor");e.select2({dropdownCssClass:"production-dropdown",openOnEnter:null,data:i.map(function(t){return{id:t.id,text:t.get("name")}})}),e.on("change",function(){e.select2("val")&&t.$id("reasonComment").select()})},handlePick:function(e){var i=this.$id("reason").select2("val"),s=this.$id("aor").select2("val"),n=this.$id("reasonComment").val();return i?s?void this.trigger("downtimePicked",{reason:i,reasonComment:n,aor:s,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("aor").select2("focus"),e.disabled=!1,o.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyAor")})):(this.$id("reason").select2("focus"),e.disabled=!1,o.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyReason")}))}})});