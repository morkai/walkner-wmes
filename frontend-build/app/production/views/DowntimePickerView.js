// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/viewport","app/data/aors","app/core/View","app/prodDowntimes/util/reasonAndAor","app/production/templates/downtimePicker"],function(e,t,o,s,i,n,a,r){"use strict";return n.extend({template:r,dialogClassName:"production-modal",events:{"keypress .select2-container":function(e){13===e.which&&(e.preventDefault(),this.$el.submit())},"keypress textarea":function(e){13===e.which&&""===e.target.value.trim()&&(e.preventDefault(),this.$el.submit())},submit:function(e){e.preventDefault();var t=this.$('.btn[type="submit"]')[0];t.disabled||(t.disabled=!0,this.handlePick(t))},"click .production-downtimePicker-now":function(){var e=Date.now();this.$id("startedAt").val(o.format(e,"YYYY-MM-DD, HH:mm:ss")).attr("data-time",e)},"select2-removed #-reason, #-aor":function(){this.$id("reason").val(""),this.$id("aor").val(""),this.model.reason=null,this.model.aor=null,this.timers.clearSelect2=setTimeout(function(e){e.setUpReasonSelect2(),e.setUpAorSelect2(),e.$id("reason").select2("focus")},1,this)},"change #-reason":function(e){this.model.reason=e.target.value,this.setUpAorSelect2(),this.$id("aor").select2("focus")},"change #-aor":function(e){this.model.aor=e.target.value,this.setUpReasonSelect2(),null===this.$id("reason").select2("data")?this.$id("reason").select2("focus"):this.$id("reasonComment").focus()}},initialize:function(){a.initialize(this)},destroy:function(){a.destroy(this)},serialize:function(){return{idPrefix:this.idPrefix,startedAt:this.model.startedAt,mode:this.model.mode}},afterRender:function(){this.model.reason&&this.$id("reason").val(this.model.reason),this.model.aor&&this.$id("aor").val(this.model.aor),this.model.reasonComment&&this.$id("reasonComment").val(this.model.reasonComment),a.setUpReasons(this,this.model.prodShift.getDowntimeReasons().sort(function(e,t){return e.id.localeCompare(t.id)})),a.setUpAors(this),this.setUpReasonSelect2(),this.setUpAorSelect2(),this.focusControl()},onDialogShown:function(){this.focusControl()},focusControl:function(){this.model.reason?this.model.aor?"edit"===this.model.mode?this.$id("reasonComment").focus():this.$(".btn-danger").focus():this.$id("aor").select2("focus"):this.$id("reason").select2("focus")},setUpReasonSelect2:function(){a.setUpReasonSelect2(this,this.model.aor,{allowClear:!0,dropdownCssClass:"production-dropdown"})},setUpAorSelect2:function(){a.setUpAorSelect2(this,this.model.reason,{allowClear:!0,dropdownCssClass:"production-dropdown"})},handlePick:function(e){var o=this.$id("reason").select2("val"),i=this.$id("aor").select2("val"),n=this.$id("reasonComment").val();return o?i?void this.trigger("downtimePicked",{reason:o,reasonComment:n,aor:i,startedAt:new Date(parseInt(this.$id("startedAt").attr("data-time"),10))}):(this.$id("aor").select2("focus"),e.disabled=!1,s.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyAor")})):(this.$id("reason").select2("focus"),e.disabled=!1,s.msg.show({type:"error",time:2e3,text:t("production","downtimePicker:msg:emptyReason")}))}})});