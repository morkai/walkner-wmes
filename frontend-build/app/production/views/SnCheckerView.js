// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/core/View","app/prodSerialNumbers/ProdSerialNumberCollection","../snManager","./SnListView","app/production/templates/snChecker"],function(e,i,o,s,r,t,n,a){"use strict";return s.extend({template:a,dialogClassName:"production-modal production-snChecker-modal",localTopics:{"production.taktTime.snScanned":function(e){this.$id("orderNo").val(e.orderNo||""),this.$id("serialNo").val(e.serialNo||""),this.$id("submit").click()}},events:{"click #-list":function(){o.closeDialog();var e=new n({collection:new r(null,{rqlQuery:"sort(-scannedAt)&limit(15)&prodLine=string:"+(this.model.get("prodLine")||"")})});o.showDialog(e,i("production","taktTime:list:title"))},submit:function(){for(var e=this.$id("message").removeClass("message-info message-error message-success").addClass("message-warning").html(i("production","taktTime:check:checking")),o=parseInt(this.$id("orderNo").val(),10),s=parseInt(this.$id("serialNo").val(),10),r=s.toString();r.length<4;)r="0"+r;for(var n="PL04."+o+"."+r,a=o+r;a.length<17;)a="0"+a;if(a="P"+a,t.contains(n)||t.contains(a))return e.removeClass("message-warning").addClass("message-info").html(i("production","taktTime:check:local")),!1;var l=this.ajax({url:"/prodSerialNumbers?orderNo="+o+"&serialNo="+s+"&limit(1)"}),d=this.model.get("prodLine")||null;return l.fail(function(){e.removeClass("message-warning").addClass("message-danger").html(i("production","taktTime:check:error"))}),l.done(function(o){e.removeClass("message-warning");var s=(o.collection||[])[0];s?e.addClass("message-info").html(i("production","taktTime:check:"+(s.prodLine===d?"local":"remote"),{prodLine:s.prodLine})):e.addClass("message-success").html(i("production","taktTime:check:notFound"))}),!1}},serialize:function(){return{idPrefix:this.idPrefix,orderNo:this.model.prodShiftOrder.get("orderId")||""}},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.$id("orderNo").focus()},closeDialog:function(){}})});