// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","app/core/View","app/users/util/setUpUserSelect2","app/production/templates/personelPicker"],function(e,t,i,n,s,r){"use strict";return n.extend({template:r,dialogClassName:"production-modal",localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){13===e.which&&(this.$el.submit(),e.preventDefault())},"click .btn[data-id]":function(e){this.trigger("userPicked",{id:e.currentTarget.dataset.id,label:e.currentTarget.textContent.trim()})},submit:function(e){e.preventDefault();var t=this.$(".btn-primary")[0];if(!t.disabled){t.disabled=!0;var i={id:null,label:null};if(this.socket.isConnected()){var n=this.$id("user").select2("data");n&&(i.id=n.id,i.label=n.text)}else i.label=this.$id("user").val().trim().replace(/[^0-9]+/g,"");this.trigger("userPicked",null!==i.label&&i.label.length?i:null)}}},serialize:function(){var e=!this.socket.isConnected();return{idPrefix:this.idPrefix,offline:e,label:t("production","personelPicker:"+(e?"offline":"online")+":label")}},afterRender:function(){var i=this.$id("user");this.socket.isConnected()?(s(i.removeClass("form-control"),{dropdownCssClass:"production-dropdown"}),i.select2("focus")):i.attr("placeholder",t("production","personelPicker:offline:placeholder")).focus();var n=this.$id("list");this.ajax({url:"/production/getRecentPersonnel",data:{type:this.options.type,prodLine:this.model.prodLine.id,shift:this.model.get("shift")}}).success(function(t){var i="";t.forEach(function(t){i+='<button type="button" class="btn btn-lg btn-default" data-id="'+t._id+'">'+e.escape(t.label)+"</button>"}),i.length&&(n.find(".btn-group-vertical").html(i),n.removeClass("hidden"))})},onDialogShown:function(){this.$id("user").focus().select2("focus")}})});