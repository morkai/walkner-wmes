define(["underscore","app/i18n","app/viewport","app/core/View","app/production/templates/personelPicker"],function(e,t,i,n,l){return n.extend({template:l,dialogClassName:"production-modal",localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){13===e.which&&(this.$el.submit(),e.preventDefault())},submit:function(e){e.preventDefault();var t=this.$(".btn-primary")[0];if(!t.disabled){t.disabled=!0;var i={id:null,label:null};if(this.socket.isConnected()){var n=this.$id("user").select2("data");n&&(i.id=n.id,i.label=n.name)}else i.label=this.$id("user").val().trim().replace(/[^0-9]+/g,"");this.trigger("userPicked",null!==i.label&&i.label.length?i:null)}}},initialize:function(){this.idPrefix=e.uniqueId("personelPicker")},serialize:function(){var e=!this.socket.isConnected();return{idPrefix:this.idPrefix,offline:e,label:t("production","personelPicker:"+(e?"offline":"online")+":label"),placeholder:t("production","personelPicker:"+(e?"offline":"online")+":placeholder")}},afterRender:function(){var e=this.$id("user");this.socket.isConnected()?(this.setUpSelect2(e.removeClass("form-control")),e.select2("focus")):e.focus()},onDialogShown:function(){this.$id("user").focus().select2("focus")},setUpSelect2:function(e){e.select2({dropdownCssClass:"production-dropdown",openOnEnter:null,allowClear:!0,minimumInputLength:3,ajax:{cache:!0,quietMillis:500,url:function(e){e=e.trim();var t=/^[0-9]+$/.test(e)?"personellId":"lastName";return e=encodeURIComponent("^"+e),"/users?select(personellId,lastName,firstName)&sort(lastName)&limit(20)&regex("+t+","+e+",i)"},results:function(e){return{results:(e.collection||[]).map(function(e){var t=e.lastName&&e.firstName?e.firstName+" "+e.lastName:"-",i=e.personellId?e.personellId:"-";return{id:e._id,text:t+" ("+i+")",name:t}})}}}})}})});