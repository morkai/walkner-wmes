define(["jquery","app/i18n","app/viewport","app/core/View","app/production/templates/bomChecker","app/production/templates/bomCheckerRow"],function(n,e,t,o,s,a){"use strict";return o.extend({snManagerMode:"bom",template:s,dialogClassName:"production-modal production-bomChecker-modal",events:{"click .production-bomChecker-reset":function(n){return this.updateComponent(this.components[this.$(n.target).closest("tr").attr("data-id")],"todo"),!1}},initialize:function(){var n=this.model.orderData,t=this.model.logEntry.data;this.components=[{_id:0,status:t.serialNo?"success":"todo",nc12:n.no,description:n.description,single:!0,unique:!0,patternInfo:{pattern:function(n){var e=n.match(/([A-Z0-9]{4}\.([0-9]{9})\.([0-9]{4}))$/);return e&&/^[A-Z0-9]+\.[0-9]+\.[0-9]+\.[A-Z0-9]+$/.test(n)&&(e=null),e},nc12:[2],sn:[3]},scanInfo:{raw:t.serialNo?t._id:"?",nc12:n.no,sn:t.serialNo},icon:t.serialNo?"fa-thumbs-up":"fa-question",message:e("production","bomChecker:message:"+(t.serialNo?"success":"todo")+":sn")}].concat(this.model.components.map(function(n,t){return{_id:t+1,status:"todo",nc12:n.nc12,description:n.description,single:n.single,unique:n.unique,patternInfo:{pattern:new RegExp(n.labelPattern),nc12:n.nc12Index,sn:n.snIndex},scanInfo:{raw:"?",nc12:"",sn:""},icon:"fa-question",message:e("production","bomChecker:message:todo")}}))},afterRender:function(){var n=this,e=[];n.components.forEach(function(t){e.push(n.renderPartial(a,{component:t}))}),n.$id("components").append(e)},onSnScanned:function(n){for(var e=n._id,t=0;t<this.components.length;++t){var o=this.components[t],s="function"==typeof o.patternInfo.pattern?o.patternInfo.pattern(e):e.match(o.patternInfo.pattern);if(s){if(o.unique&&o.scanInfo.raw===e)return this.updateComponent(o,"todo");if(o.single||"success"!==o.status&&"checking"!==o.status)return o.scanInfo.raw=e,0===o._id?(o.scanInfo.nc12=n.orderNo,o.scanInfo.sn=n.serialNo):(o.scanInfo.nc12=o.nc12,o.scanInfo.sn="",o.patternInfo.nc12.forEach(function(n){s[n]&&(o.scanInfo.nc12=s[n])}),o.patternInfo.sn.forEach(function(n){s[n]&&(o.scanInfo.sn=s[n])})),this.handleComponent(o)}}this.snMessage.show(n,"error","BOM_CHECKER:NO_MATCH")},handleComponent:function(n){var t=this;if(n.scanInfo.nc12!==n.nc12)return t.updateComponent(n,"failure",e("production","bomChecker:message:nc12",{nc12:n.nc12}));if(n.unique){t.updateComponent(n,"checking");var o=t.ajax({method:"POST",url:"/production/checkAnySerialNumber",data:JSON.stringify({sn:0===n._id?n.scanInfo.raw:n.scanInfo.nc12+":"+n.scanInfo.sn}),timeout:2e4});o.fail(function(){t.updateComponent(n,"failure")}),o.done(function(o){o?t.updateComponent(n,"failure",e("production","bomChecker:message:used"+(0===n._id?":sn":""),{psn:o})):s()})}else s();function s(){t.updateComponent(n,"success"),t.timers&&(clearTimeout(t.timers.checkAll),t.timers.checkAll=setTimeout(t.checkAll.bind(t),333))}},checkAll:function(){if(!this.components.filter(function(n){return"success"!==n.status}).length){var n=this.model.logEntry.data;n.scannedAt=new Date,n.bom=[],this.components.forEach(function(e){0===e._id?(n.orderNo=e.scanInfo.nc12,n.serialNo=e.scanInfo.sn):n.bom.push(e.scanInfo.nc12+":"+e.scanInfo.sn)}),this.trigger("checked",this.model.logEntry)}},updateComponent:function(n,t,o){switch(t&&(n.status=t),n.status){case"checking":n.icon="fa-spinner fa-spin";break;case"failure":n.icon="fa-thumbs-down";break;case"success":n.icon="fa-thumbs-up";break;case"todo":n.icon="fa-question",n.scanInfo.raw="?"}n.message=o||e("production","bomChecker:message:"+n.status+(0===n._id?":sn":"")),0===n._id&&(this.model.logEntry.data._id=n.scanInfo.raw,this.model.logEntry.data.serialNo=n.scanInfo.sn),this.$('tr[data-id="'+n._id+'"]').replaceWith(this.renderPartial(a,{component:n}))}})});