// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/core/View","app/production/templates/bomChecker"],function(e,t,n,a,o){"use strict";return a.extend({snManagerMode:"bom",template:o,dialogClassName:"production-modal production-bomChecker-modal",localTopics:{"production.taktTime.snScanned":"onSnScanned"},getTemplateData:function(){return{components:this.model.components}},onSnScanned:function(e){if(e.orderNo)return this.snMessage.show(e,"error","BOM_CHECKER:NO_ORDER");for(var t=0;t<this.model.components.length;++t){var n=this.model.components[t],a=null;try{a=new RegExp(n.pattern)}catch(e){continue}var o=e._id.match(a);if(o){var c=n.nc12,s="";return n.nc12Index.forEach(function(e){o[e]&&(c=o[e])}),n.snIndex.forEach(function(e){o[e]&&(s=o[e])}),this.handleComponent(t,e._id,n,c,s)}}this.snMessage.show(e,"error","BOM_CHECKER:NO_MATCH")},handleComponent:function(e,n,a,o,c){function s(){u.attr("data-status","success").attr("data-sn",o+":"+c),d.attr("class","fa fa-check"),m.text(n),h.text(t("production","bomChecker:message:success")),clearTimeout(i.timers.checkAll),i.timers.checkAll=setTimeout(i.checkAll.bind(i),333)}function r(e){u.attr("data-status","failure"),d.attr("class","fa fa-times"),h.text(e)}var i=this,u=i.$('tr[data-i="'+e+'"]'),d=u.find(".fa"),m=u.find(".production-bomChecker-scanBuffer"),h=u.find(".production-bomChecker-message");if(o!==a.nc12)return r(t("production","bomChecker:message:nc12",{nc12:o}));if(a.unique){u.attr("data-status","checking"),d.attr("class","fa fa-spinner fa-spin"),m.text(n),h.text(t("production","bomChecker:message:checking"));var l=i.ajax({method:"POST",url:"/production/checkBomSerialNumber",data:JSON.stringify({sn:o+":"+c}),timeout:6e3});l.fail(function(){r(t("production","bomChecker:message:failure"))}),l.done(function(e){e?r(t("production","bomChecker:message:used",{psn:e})):s()})}else s()},checkAll:function(){this.$('tr[data-status="success"]').length===this.model.components.length&&this.trigger("checked",this.$("tr[data-sn]").map(function(){return this.dataset.sn}).get())}})});