define(["underscore","app/i18n","app/viewport","app/core/View","app/users/util/setUpUserSelect2","app/production/templates/personnelPicker"],function(e,t,n,i,s,o){"use strict";return i.extend({template:o,dialogClassName:"production-modal",localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){13===e.which&&(this.$el.submit(),e.preventDefault())},"click .btn[data-id]":function(e){this.trigger("userPicked",{id:e.currentTarget.dataset.id,label:e.currentTarget.textContent.trim()})},"input #-user":function(){this.options.embedded&&this.onVkbValueChange()},submit:function(e){e.preventDefault();var t=this.$(".btn-primary")[0];if(!t.disabled){t.disabled=!0;var n={id:null,label:null};if(this.socket.isConnected()){if(this.options.embedded)return void this.$(".btn[data-id]").first().click();var i=this.$id("user").select2("data");i&&(n.id=i.id,n.label=i.text)}else n.label=this.$id("user").val().trim().replace(/[^0-9]+/g,"");this.trigger("userPicked",null!==n.label&&n.label.length?n:null)}}},initialize:function(){this.lastPhrase="",this.lastUsers=[],this.searchReq=null},destroy:function(){this.options.vkb&&this.options.vkb.hide()},getTemplateData:function(){var e=!this.socket.isConnected(),t=e?"offline":this.options.embedded?"embedded":"online";return{offline:e,label:this.t("personnelPicker:"+t+":label")}},afterRender:function(){this.setUpField(),this.setUpList()},onDialogShown:function(){this.$id("user").focus().select2("focus")},setUpField:function(){if(this.options.embedded)return this.setUpEmbeddedField();var e=this.$id("user");this.socket.isConnected()?(s(e.removeClass("form-control"),{dropdownCssClass:"production-dropdown"}),e.select2("focus")):e.focus()},setUpEmbeddedField:function(){this.options.vkb.show(this.$id("user").addClass("is-embedded")[0],this.onVkbValueChange.bind(this))},onVkbValueChange:function(){var e=!this.socket.isConnected(),n=this.$id("user").val();n=e?n.replace(/[^0-9]+/g,""):s.transliterate(n);var i=this.$id("list"),o="",r="";(!i.length||n.length<3&&this.options.vkb)&&this.options.vkb.enableKeys(),i.length&&(n.length?(o="matches",(r=this.buildPersonnelList(n)).length||(r='<p><i class="fa fa-spinner fa-spin"></i></p>')):(o="recent",r=this.recentHtml||"<p>"+t("production","personnelPicker:notFound")+"</p>"),i.find("label").html(t("production","personnelPicker:"+o)),i.find("div").html(r),i.removeClass("hidden"))},setUpList:function(){var n=this,i=n.$id("list");if(!this.socket.isConnected())return i.remove();n.recentHtml="",this.ajax({url:"/production/getRecentPersonnel",data:{type:this.options.type,prodLine:this.model.prodLine.id,shift:this.model.get("shift")}}).success(function(t){var s="";t.forEach(function(t){s+='<button type="button" class="btn btn-lg btn-default" data-id="'+t._id+'">'+e.escape(t.label)+"</button>"}),s.length&&(i.find(".btn-group-vertical").html(s),n.recentHtml=s,n.options.vkb&&n.options.vkb.reposition())}).always(function(){var e=i.find(".fa-spinner");e.length&&e.replaceWith(t("production","personnelPicker:notFound"))})},buildPersonnelList:function(e){var n=this;if(e.length<3)return"<p>"+t("production","personnelPicker:tooShort")+"</p>";var i=e.substring(0,3);return i===n.lastPhrase?n.searchReq?"":this.buildFilteredPersonnelList():(n.searchReq&&n.searchReq.abort(),n.searchReq=this.ajax({url:"/users?select(firstName,lastName,searchName,personnelId)&sort(searchName)&limit(999)&searchName=regex="+encodeURIComponent("^"+e)}),n.searchReq.fail(function(){n.$(".fa-spin").removeClass("fa-spin")}),n.searchReq.done(function(e){n.lastUsers=e.collection||[],n.$id("list").removeClass("hidden").find("div").html(n.buildFilteredPersonnelList()),n.options.vkb&&n.options.vkb.reposition()}),n.searchReq.always(function(){n.searchReq=null}),n.lastPhrase=i,"")},buildFilteredPersonnelList:function(){var n=s.transliterate(this.$id("user").val()||""),i={},o="";return this.lastUsers.filter(function(e){return 0===e.searchName.indexOf(n)}).forEach(function(t){var s=t.lastName||"";t.firstName.length&&(s.length&&(s+=" "),s+=t.firstName),t.personnelId&&(s.length?s+=" ("+t.personnelId+")":s=t.personnelId),o+='<button type="button" class="btn btn-lg btn-default" data-id="'+t._id+'">'+e.escape(s)+"</button>";var r=t.searchName.substr(n.length,1);r&&(i[r]=!0)}),this.options.vkb&&this.options.vkb.disableKeys(i),o.length?o:"<p>"+t("production","personnelPicker:notFound")+"</p>"}})});