define(["underscore","app/i18n","app/viewport","app/core/View","app/users/util/setUpUserSelect2","app/production/templates/personnelPicker"],function(e,t,i,s,n,r){"use strict";return s.extend({template:r,dialogClassName:"production-modal",localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){13===e.which&&(this.$el.submit(),e.preventDefault())},"click .btn[data-id]":function(e){this.trigger("userPicked",{id:e.currentTarget.dataset.id,label:e.currentTarget.textContent.trim()})},"input #-user":function(){this.options.embedded&&this.onVkbValueChange()},submit:function(e){e.preventDefault();var t=this.$(".btn-primary")[0];if(!t.disabled){t.disabled=!0;var i={id:null,label:null};if(this.socket.isConnected()){if(this.options.embedded)return void this.$(".btn[data-id]").first().click();var s=this.$id("user").select2("data");s&&(i.id=s.id,i.label=s.text)}else i.label=this.$id("user").val().trim().replace(/[^0-9]+/g,"");this.trigger("userPicked",null!==i.label&&i.label.length?i:null)}}},initialize:function(){this.lastPhrase="",this.lastUsers=[],this.searchReq=null},destroy:function(){this.options.vkb&&this.options.vkb.hide()},serialize:function(){var e=!this.socket.isConnected(),i=e?"offline":this.options.embedded?"embedded":"online";return{idPrefix:this.idPrefix,offline:e,label:t("production","personnelPicker:"+i+":label")}},afterRender:function(){this.setUpField(),this.setUpList()},onDialogShown:function(){this.$id("user").focus().select2("focus")},setUpField:function(){if(this.options.embedded)return this.setUpEmbeddedField();var e=this.$id("user");this.socket.isConnected()?(n(e.removeClass("form-control"),{dropdownCssClass:"production-dropdown"}),e.select2("focus")):e.focus()},setUpEmbeddedField:function(){this.options.vkb.show(this.$id("user").addClass("is-embedded")[0],this.onVkbValueChange.bind(this))},onVkbValueChange:function(){var e=!this.socket.isConnected(),i=this.$id("user").val();i=e?i.replace(/[^0-9]+/g,""):n.transliterate(i);var s=this.$id("list"),r="",o="";(!s.length||i.length<3&&this.options.vkb)&&this.options.vkb.enableKeys(),s.length&&(i.length?(r="matches",(o=this.buildPersonnelList(i)).length||(o='<p><i class="fa fa-spinner fa-spin"></i></p>')):(r="recent",o=this.recentHtml||"<p>"+t("production","personnelPicker:notFound")+"</p>"),s.find("label").html(t("production","personnelPicker:"+r)),s.find("div").html(o),s.removeClass("hidden"))},setUpList:function(){var i=this,s=i.$id("list");if(!this.socket.isConnected())return s.remove();i.recentHtml="",this.ajax({url:"/production/getRecentPersonnel",data:{type:this.options.type,prodLine:this.model.prodLine.id,shift:this.model.get("shift")}}).success(function(t){var n="";t.forEach(function(t){n+='<button type="button" class="btn btn-lg btn-default" data-id="'+t._id+'">'+e.escape(t.label)+"</button>"}),n.length&&(s.find(".btn-group-vertical").html(n),i.recentHtml=n,i.options.vkb&&i.options.vkb.reposition())}).always(function(){var e=s.find(".fa-spinner");e.length&&e.replaceWith(t("production","personnelPicker:notFound"))})},buildPersonnelList:function(e){var i=this;if(e.length<3)return"<p>"+t("production","personnelPicker:tooShort")+"</p>";var s=e.substring(0,3);return s===i.lastPhrase?i.searchReq?"":this.buildFilteredPersonnelList():(i.searchReq&&i.searchReq.abort(),i.searchReq=this.ajax({url:"/users?select(firstName,lastName,searchName,personellId)&sort(searchName)&limit(999)&searchName=regex="+encodeURIComponent("^"+e)}),i.searchReq.fail(function(){i.$(".fa-spin").removeClass("fa-spin")}),i.searchReq.done(function(e){i.lastUsers=e.collection||[],i.$id("list").removeClass("hidden").find("div").html(i.buildFilteredPersonnelList()),i.options.vkb&&i.options.vkb.reposition()}),i.searchReq.always(function(){i.searchReq=null}),i.lastPhrase=s,"")},buildFilteredPersonnelList:function(){var i=n.transliterate(this.$id("user").val()||""),s={},r="";return this.lastUsers.filter(function(e){return 0===e.searchName.indexOf(i)}).forEach(function(t){var n=t.lastName||"";t.firstName.length&&(n.length&&(n+=" "),n+=t.firstName),t.personellId&&(n.length?n+=" ("+t.personellId+")":n=t.personellId),r+='<button type="button" class="btn btn-lg btn-default" data-id="'+t._id+'">'+e.escape(n)+"</button>";var o=t.searchName.substr(i.length,1);o&&(s[o]=!0)}),this.options.vkb&&this.options.vkb.disableKeys(s),r.length?r:"<p>"+t("production","personnelPicker:notFound")+"</p>"}})});