define(["underscore","app/i18n","app/viewport","app/core/View","app/core/views/DialogView","app/data/isaPalletKinds","./IsaPalletDeliveryDialogView","app/production/templates/isa","app/production/templates/isaCancelDialog"],function(e,t,i,s,a,n,r,l,o){"use strict";return s.extend({template:l,localTopics:{"socket.disconnected":"render","isaPalletKinds.synced":"render"},events:{"click #-pickup":function(){var e=this.model.isaRequests.getFirstPickup();if(!e)return this.pickup();"new"===e.get("status")&&this.cancel(e)},"click #-deliver":function(){var e=this.model.isaRequests.getFirstDelivery();if(e)"new"===e.get("status")&&this.cancel(e);else{var t=new r({embedded:this.options.embedded,vkb:this.options.vkb});this.listenTo(t,"picked",function(e,i){t.closeDialog(),this.deliver(e,i)}),i.showDialog(t,this.t("isa:deliver:title"))}}},initialize:function(){var t=this;t.syncing=!1,t.rendered=!1;var i=t.model.isaRequests,s=e.debounce(function(){t.rendered&&t.render()},1);t.listenTo(i,"request",function(){t.syncing=!0,s()}),t.listenTo(i,"error sync",function(){t.syncing=!1,s()}),t.listenTo(i,"add remove change reset",s)},getTemplateData:function(){var e=this.syncing,t=this.socket.isConnected(),i=this.model.isLocked(),s=this.model.isaRequests.getFirstPickup(),a=this.model.isaRequests.getFirstDelivery(),n=!!s,r=!!a,l=!!s&&"accepted"===s.get("status"),o=!!a&&"accepted"===a.get("status"),c=a?a.getQty():0,d=a?a.getFullPalletKind():null;return{pickupIndicatorColor:this.serializeIndicatorColor(s),deliveryIndicatorColor:this.serializeIndicatorColor(a),pickupStatusLabel:this.serializeStatusLabel(s),pickupActive:n,pickupDisabled:!this.rendered||i||e||!t||l,deliveryStatusLabel:this.serializeStatusLabel(a),deliveryActive:r,deliveryDisabled:!this.rendered||i||e||!t||o,selectedQty:c,selectedPalletKind:d}},serializeIndicatorColor:function(e){if(!e||this.model.isLocked())return"grey";switch(e.get("status")){case"new":return"orange";case"accepted":return"green";default:return"grey"}},serializeStatusLabel:function(e){return this.t("isa:status:"+(e?e.get("status"):"idle"))},afterRender:function(){this.rendered=!0},pickup:function(){this.model.isaRequests.pickup(this.model.getSecretKey(),this.showErrorMessage.bind(this,"pickup"))},deliver:function(e,t){this.model.isaRequests.deliver(e,t,this.model.getSecretKey(),this.showErrorMessage.bind(this,"deliver"))},cancel:function(e){var t=this,s=new a({dialogClassName:"production-modal",template:o,nlsDomain:this.model.getNlsDomain(),model:{requestType:e.get("type")}});t.listenTo(s,"answered",function(i){"yes"===i&&t.model.isaRequests.get(e.id)&&t.model.isaRequests.cancel(e.id,t.model.getSecretKey(),t.showErrorMessage.bind(t,"cancel"))}),i.showDialog(s,t.t("isa:cancel:title"))},showErrorMessage:function(e,s){s&&i.msg.show({type:"error",time:5e3,text:t.has("isa",e+":"+s.message)?t("isa",e+":"+s.message):t("isa",e+":failure")})}})});