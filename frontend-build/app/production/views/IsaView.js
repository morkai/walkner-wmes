// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","app/core/View","app/data/isaPalletKinds","app/production/templates/isa"],function(e,i,t,s,n,r){"use strict";return s.extend({template:r,localTopics:{"socket.disconnected":"render","isaPalletKinds.synced":"render"},events:{"click #-pickup":function(){var e=this.model.isaLineState.get("requestType");"pickup"===e?this.cancel():null===e&&this.pickup()},"click #-deliver":function(){var e=this.model.isaLineState.get("requestType");"delivery"===e&&this.cancel()},"click a[data-pallet-kind]":function(e){this.deliver(e.currentTarget.dataset.palletKind)}},initialize:function(){var i=this;i.syncing=!1,i.rendered=!1;var t=i.model.isaLineState,s=e.debounce(function(){i.rendered&&i.render()},1);i.listenTo(t,"request",function(){i.syncing=!0,s()}),i.listenTo(t,"error sync",function(){i.syncing=!1,s()}),i.listenTo(t,"change",s)},serialize:function(){if(!this.model.isaLineState.get("status"))return{idPrefix:this.idPrefix,palletKinds:[],requestIndicatorColor:"grey",responseIndicatorColor:"grey",pickupActive:!1,pickupDisabled:!0,deliveryActive:!1,deliveryDisabled:!0,selectedPalletKind:null,dropdownEnabled:!1};var i=this.syncing,t=this.socket.isConnected(),s=this.model.isLocked(),r=this.model.isaLineState.serialize(),a="pickup"===r.requestType,d="delivery"===r.requestType,l="request"===r.status,c="response"===r.status,o=!l&&!c;return{idPrefix:this.idPrefix,palletKinds:n.toJSON(),requestIndicatorColor:s||!t||o?"grey":"orange",responseIndicatorColor:!s&&t&&c?"green":"grey",pickupActive:a,pickupDisabled:s||i||!t||c||d,deliveryActive:d,deliveryDisabled:s||i||!t||c||a,selectedPalletKind:r.palletKind,dropdownEnabled:e.isEmpty(r.palletKind)}},afterRender:function(){this.rendered=!0},cancel:function(){this.model.isaLineState.cancel(this.model.getSecretKey(),this.showErrorMessage.bind(this,"cancel"))},pickup:function(){this.model.isaLineState.pickup(this.model.getSecretKey(),this.showErrorMessage.bind(this,"pickup"))},deliver:function(e){this.model.isaLineState.deliver(e,this.model.getSecretKey(),this.showErrorMessage.bind(this,"deliver"))},showErrorMessage:function(e,s){s&&t.msg.show({type:"error",time:5e3,text:i.has("isa",e+":"+s.message)?i("isa",e+":"+s.message):i("isa",e+":failure")})}})});