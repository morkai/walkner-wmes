// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","app/core/View","app/core/views/DialogView","app/data/isaPalletKinds","app/production/templates/isa","app/production/templates/isaCancelDialog"],function(e,t,i,s,r,a,n,o){"use strict";return s.extend({template:n,localTopics:{"socket.disconnected":"render","isaPalletKinds.synced":"render"},events:{"click #-pickup":function(){var e=this.model.isaRequests.getFirstPickup();return e?void("new"===e.get("status")&&this.cancel(e)):this.pickup()},"click #-deliver":function(){var e=this.model.isaRequests.getFirstDelivery();e&&"new"===e.get("status")&&this.cancel(e)},"click a[data-pallet-kind]":function(e){this.deliver(e.currentTarget.dataset.palletKind)}},initialize:function(){var t=this;t.syncing=!1,t.rendered=!1;var i=t.model.isaRequests,s=e.debounce(function(){t.rendered&&t.render()},1);t.listenTo(i,"request",function(){t.syncing=!0,s()}),t.listenTo(i,"error sync",function(){t.syncing=!1,s()}),t.listenTo(i,"add remove change reset",s)},serialize:function(){var t=this.syncing,i=this.socket.isConnected(),s=this.model.isLocked(),r=this.model.isaRequests.getFirstPickup(),n=this.model.isaRequests.getFirstDelivery(),o=!!r,l=!!n,c=!!r&&"accepted"===r.get("status"),d=!!n&&"accepted"===n.get("status"),u=n?n.getFullPalletKind():null;return{idPrefix:this.idPrefix,palletKinds:a.toJSON(),pickupIndicatorColor:this.serializeIndicatorColor(r),deliveryIndicatorColor:this.serializeIndicatorColor(n),pickupStatusLabel:this.serializeStatusLabel(r),pickupActive:o,pickupDisabled:!this.rendered||s||t||!i||c,deliveryStatusLabel:this.serializeStatusLabel(n),deliveryActive:l,deliveryDisabled:!this.rendered||s||t||!i||d,selectedPalletKind:u,dropdownEnabled:e.isEmpty(u)}},serializeIndicatorColor:function(e){if(!e||this.model.isLocked())return"grey";switch(e.get("status")){case"new":return"orange";case"accepted":return"green";default:return"grey"}},serializeStatusLabel:function(e){return t("production","isa:status:"+(e?e.get("status"):"idle"))},afterRender:function(){this.rendered=!0},pickup:function(){this.model.isaRequests.pickup(this.model.getSecretKey(),this.showErrorMessage.bind(this,"pickup"))},deliver:function(e){this.model.isaRequests.deliver(e,this.model.getSecretKey(),this.showErrorMessage.bind(this,"deliver"))},cancel:function(e){var s=this,a=new r({dialogClassName:"production-modal",template:o,model:{requestType:e.get("type")}});s.listenTo(a,"answered",function(t){"yes"===t&&s.model.isaRequests.cancel(e.id,s.model.getSecretKey(),s.showErrorMessage.bind(s,"cancel"))}),i.showDialog(a,t("production","isa:cancel:title"))},showErrorMessage:function(e,s){s&&i.msg.show({type:"error",time:5e3,text:t.has("isa",e+":"+s.message)?t("isa",e+":"+s.message):t("isa",e+":failure")})}})});