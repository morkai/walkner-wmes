// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","app/time","app/i18n","app/viewport","app/core/View","./QuantityEditorView","app/production/templates/quantities"],function(t,e,i,n,o,s,d){return o.extend({template:d,events:{"click .production-quantities-actual .btn-link":"showQuantityEditor"},initialize:function(){this.onKeyDown=this.onKeyDown.bind(this),this.editorHiders=[],this.listenTo(this.model,"change:quantitiesDone change:shift locked unlocked",this.render),t("body").on("keydown",this.onKeyDown)},destroy:function(){t("body").off("keydown",this.onKeyDown),this.editorHiders=null},serialize:function(){var t=e.getMoment().valueOf(),i=this.model.getCurrentShiftMoment(),n=!this.model.isLocked();return{quantityRows:(this.model.get("quantitiesDone")||[]).map(function(e,o){var s=n,d=i.format("HH:mm:ss");return i.add(59,"minutes").add(59,"seconds"),s=7===o?s&&t>i.valueOf()-6e5:s&&t>i.valueOf(),d+="-"+i.format("HH:mm:ss"),i.add(1,"seconds"),{time:d,planned:e.planned,actual:e.actual,editable:s||e.actual>0}})}},afterRender:function(){this.timers.nextRender&&clearTimeout(this.timers.nextRender),this.model.isLocked()||this.scheduleNextRender()},onKeyDown:function(t){27===t.keyCode&&this.hideEditors()},scheduleNextRender:function(){var t=this.model.getCurrentShiftMoment().add(7,"hours").hours(),i=e.getMoment(),n=i.valueOf(),o=i.hours(),s=i.minutes(0).seconds(0).milliseconds(0).add(1,"hours").valueOf(),d=o===t?s-6e5:s,r=d+1e3-n;r>0?this.timers.nextRender=setTimeout(function(t){t.render(),t.showEditorDialog()},r,this):delete this.timers.nextRender},showQuantityEditor:function(e){function n(){d.editorHiders.splice(d.editorHiders.indexOf(n),1),l.remove(),a.show(),u.show()}function o(){var t=parseInt(c.val(),10);n();var e=s.attr("data-hour");return t!==h&&t>=0&&r>=t&&(u.text(t),d.model.changeQuantitiesDone(parseInt(e,0),t)),d.$("td[data-hour="+e+"] .btn-link").focus(),!1}var s=this.$(e.target).closest("td");if(!s.find("input").length){this.hideEditors();var d=this,r=this.model.getMaxQuantitiesDone(),a=s.find(".btn-link").hide(),u=s.find("span").hide(),h=parseInt(u.text(),10),l=t("<form></form>").submit(o),c=t('<input class="form-control" type="number" min="0">').attr("placeholder",i("production","quantities:newValuePlaceholder")).attr("max",r).val(h).on("keydown",function(t){27===t.which&&setTimeout(n,1)}).appendTo(l);l.appendTo(s),c.select(),this.editorHiders.push(n)}},hideEditors:function(){this.editorHiders.forEach(function(t){t()}),this.editorHiders=[]},showEditorDialog:function(t){t||(t=this.$(".btn-link").last().closest("td"));var e=t.parent().find("td:first-child").text().trim().split("-"),o=parseInt(t.attr("data-hour"),10),d={from:e[0],to:e[1],currentQuantity:parseInt(t.find("span").text(),10),maxQuantity:this.model.getMaxQuantitiesDone()},r=new s(d);this.listenTo(r,"quantityChanged",function(t){n.closeDialog(),null!==t&&this.model.changeQuantitiesDone(o,t)}),n.showDialog(r,i("production","quantityEditor:title"))}})});