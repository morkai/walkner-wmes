// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/time","app/i18n","app/viewport","app/core/View","./QuantityEditorView","app/production/templates/quantities"],function(t,e,n,i,o,s,a,d){"use strict";return s.extend({template:d,events:{"click .production-quantities-actual":"showQuantityEditor","mousedown .production-quantities-actual":"showQuantityEditor"},initialize:function(){this.onQuantitiesDoneChanged=this.onQuantitiesDoneChanged.bind(this),this.listenTo(this.model,"change:shift locked unlocked",this.render),this.listenTo(this.model.settings,"reset change",function(t){(!t||/taktTime/.test(t.id))&&this.render()})},serialize:function(){var t=n.getMoment().valueOf(),e=this.model.getCurrentShiftMoment(),i=!this.model.isLocked(),o=this.model.isTaktTimeEnabled();return{quantityRows:(this.model.get("quantitiesDone")||[]).map(function(n,s){var a=i,d=e.format("HH:00");return e.add(59,"minutes").add(59,"seconds"),a=7===s?a&&t>e.valueOf()-6e5:a&&t>e.valueOf(),d+="-"+e.add(1,"seconds").format("HH:00"),{time:d,planned:n.planned,actual:n.actual,editable:(a||n.actual>0)&&!o}})}},beforeRender:function(){this.stopListening(this.model,"change:quantitiesDone",this.onQuantitiesDoneChanged)},afterRender:function(){this.listenTo(this.model,"change:quantitiesDone",this.onQuantitiesDoneChanged),this.timers.nextRender&&clearTimeout(this.timers.nextRender),this.model.isLocked()||this.scheduleNextRender(),window.qv=this},scheduleNextRender:function(){var t=this.model.getCurrentShiftMoment().add(7,"hours").hours(),e=n.getMoment(),i=e.valueOf(),o=e.hours(),s=e.minutes(0).seconds(0).milliseconds(0).add(1,"hours").valueOf(),a=o===t?s-6e5:s,d=a+1e3-i;d>0?this.timers.nextRender=setTimeout(function(t){t.render(),t.showEditorDialog()},d,this):delete this.timers.nextRender},showQuantityEditor:function(n){function o(){c.remove(),u.show(),h.show()}function s(){var t=parseInt(m.val(),10);o();var e=a.attr("data-hour");t!==l&&t>=0&&r>=t&&(h.text(t+" "+i("production","quantities:unit")),d.model.changeQuantitiesDone(parseInt(e,0),t,{render:!1}))}var a=this.$(n.target).closest("td");if(!a.find("input").length&&!this.model.isTaktTimeEnabled()){var d=this,r=this.model.getMaxQuantitiesDone(),u=a.find(".btn-link").hide(),h=a.find("span").hide(),l=parseInt(h.text(),10),c=e("<form></form>").submit(function(){return s(),!1}),m=e('<input class="form-control production-quantities-editor" type="number" min="0">').attr({placeholder:i("production","quantities:newValuePlaceholder"),max:r,value:l}).on("keydown",function(e){27===e.which&&t.defer(o)}).appendTo(c);c.appendTo(a),t.defer(function(){m.select().on("blur",function(){t.defer(s)})})}},showEditorDialog:function(t){if(!this.model.isTaktTimeEnabled()){t||(t=this.$(".btn-link").last().closest("td"));var e=t.parent().find("td:first-child").text().trim().split("-"),n=parseInt(t.attr("data-hour"),10),s={from:e[0],to:e[1],currentQuantity:parseInt(t.find("span").text(),10),maxQuantity:this.model.getMaxQuantitiesDone()},d=new a(s);this.listenTo(d,"quantityChanged",function(t){o.closeDialog(),null!==t&&this.model.changeQuantitiesDone(n,t,{render:!0})}),o.showDialog(d,i("production","quantityEditor:title"))}},onQuantitiesDoneChanged:function(t,e,n){n.render!==!1&&this.render()}})});