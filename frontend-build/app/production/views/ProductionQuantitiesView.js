// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/time","app/i18n","app/viewport","app/core/View","./QuantityEditorView","app/production/templates/quantities"],function(t,e,i,n,o,s,a,d){"use strict";return s.extend({template:d,events:{"click .production-quantities-actual":"showQuantityEditor","mousedown .production-quantities-actual":"showQuantityEditor"},initialize:function(){this.onQuantitiesDoneChanged=this.onQuantitiesDoneChanged.bind(this),this.listenTo(this.model,"change:shift locked unlocked",this.render),this.listenTo(this.model.settings,"reset change",function(t){t&&!/taktTime/.test(t.id)||this.render()})},serialize:function(){var t=i.getMoment().valueOf(),e=this.model.getCurrentShiftMoment(),n=!this.model.isLocked(),o=this.model.isTaktTimeEnabled();return{quantityRows:(this.model.get("quantitiesDone")||[]).map(function(i,s){var a=n,d=e.format("HH:00");return e.add(59,"minutes").add(59,"seconds"),a=7===s?a&&t>e.valueOf()-6e5:a&&t>e.valueOf(),d+="-"+e.add(1,"seconds").format("HH:00"),{time:d,planned:i.planned,actual:i.actual,editable:(a||i.actual>0)&&!o}})}},beforeRender:function(){this.stopListening(this.model,"change:quantitiesDone",this.onQuantitiesDoneChanged)},afterRender:function(){this.listenTo(this.model,"change:quantitiesDone",this.onQuantitiesDoneChanged),this.timers.nextRender&&clearTimeout(this.timers.nextRender),this.model.isLocked()||this.scheduleNextRender(),window.qv=this},scheduleNextRender:function(){var t=this.model.getCurrentShiftMoment().add(7,"hours").hours(),e=i.getMoment(),n=e.valueOf(),o=e.hours(),s=e.minutes(0).seconds(0).milliseconds(0).add(1,"hours").valueOf(),a=o===t?s-6e5:s,d=a+1e3-n;d>0?this.timers.nextRender=setTimeout(function(t){t.render(),t.showEditorDialog()},d,this):delete this.timers.nextRender},showQuantityEditor:function(i){function o(){c.remove(),u.show(),h.show()}function s(){var t=parseInt(f.val(),10);o();var e=a.attr("data-hour");t!==l&&t>=0&&t<=r&&(h.text(t+" "+n("production","quantities:unit")),d.model.changeQuantitiesDone(parseInt(e,0),t,{render:!1}))}var a=this.$(i.target).closest("td");if(!(a.find("input").length||this.model.isLocked()||this.model.isTaktTimeEnabled())){if(this.options.embedded)return void this.showEditorDialog(a);if(a.find(".btn-link").length){var d=this,r=this.model.getMaxQuantitiesDone(),u=a.find(".btn-link").hide(),h=a.find("span").hide(),l=parseInt(h.text(),10),c=e("<form></form>").submit(function(){return s(),!1}),f=e('<input class="form-control production-quantities-editor" type="number" min="0">').attr({placeholder:n("production","quantities:newValuePlaceholder"),max:r,value:l}).on("keydown",function(e){27===e.which&&t.defer(o)}).appendTo(c);c.appendTo(a),t.defer(function(){f.select().on("blur",function(){t.defer(s)})})}}},showEditorDialog:function(t){if(!(this.model.isTaktTimeEnabled()||o.currentDialog&&o.currentDialog instanceof a)){var i=this.$(".btn-link");if(t&&t.length&&t.find(".btn-link").length||(t=i.last().closest("td")),t.length){var s={hours:[],maxQuantity:this.model.getMaxQuantitiesDone(),selected:parseInt(t.attr("data-hour"),10)};this.$(".production-quantities-actual").each(function(){var t=e(this),i=t.parent().find("td:first-child").text().trim().split("-"),n=parseInt(t.attr("data-hour"),10);s.hours.push({from:i[0],to:i[1],index:n,value:parseInt(t.find("span").text(),10),disabled:0===t.find(".btn-link").length})});var d=new a({model:s,embedded:this.options.embedded,vkb:this.options.vkb});this.listenTo(d,"quantityChanged",function(t,e){o.closeDialog(),null!==e&&this.model.changeQuantitiesDone(t,e,{render:!0})}),o.closeDialogs(function(t){return!(t instanceof a)}),o.showDialog(d,n("production","quantityEditor:title"))}}},onQuantitiesDoneChanged:function(t,e,i){!1!==i.render&&this.render()}})});