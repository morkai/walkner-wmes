define(["jquery","app/i18n","app/time","app/core/View","app/core/util/getShiftStartInfo","app/data/downtimeReasons","app/data/aors","app/production/templates/executionTimeline","app/production/templates/executionTimelineItem","app/production/templates/executionOrderPopover","app/production/templates/executionDowntimePopover"],function(t,e,i,r,o,n,s,d,a,m,p){"use strict";return r.extend({template:d,events:{'click .production-timeline-item[data-type="order"]':function(t){if(""===document.getSelection().toString()){var e=this.model.get(this.orderProp)[t.currentTarget.dataset.id];this.model.trigger("newOrderRequested",e)}}},initialize:function(){this.orderProp=this.options.type+"Orders",this.downtimeProp=this.options.type+"Downtimes",this.listenTo(this.model,"change:"+this.orderProp,this.renderOrders),this.listenTo(this.model,"change:"+this.downtimeProp,this.renderDowntimes),"done"===this.options.type&&(this.listenTo(this.model,"change:lastOrder",this.updateLastItem.bind(this,"order")),this.listenTo(this.model,"change:lastDowntime",this.updateLastItem.bind(this,"downtime")))},afterRender:function(){var t=this;t.$el.popover({container:"body",selector:".production-timeline-item",trigger:"hover",placement:"auto top",html:!0,className:"production-execution-popover",content:function(){return"order"===this.dataset.type?t.renderOrderPopover(this.dataset.id):"downtime"===this.dataset.type?t.renderDowntimePopover(this.dataset.id):void 0}}),t.renderOrders(),t.renderDowntimes(),t.scheduleExtendLastItems()},renderOrders:function(){this.renderItems("order")},renderDowntimes:function(){this.renderItems("downtime")},renderItems:function(t){var e=this,i=e.model.get(e[t+"Prop"])||[],r="";if(i.length){var o=e.prodShift.get("date").getTime(),n=o+288e5,s=Date.now();i.forEach(function(i,d){i.startedAt<o||i.startedAt>=n||(r+=e.renderItem(t,i,d,o,s))})}e.$el.find('.production-timeline-item[data-type="'+t+'"]').remove(),e.$el.append(r),e.scheduleExtendLastItems()},renderItem:function(t,i,r,n,s){n||(n=o(i.startedAt).startTime),s||(s=Date.now());var d=i.startedAt,m=((i.finishedAt||s)-d)/288e5*100,p=(d-n)/288e5*100;return a({type:t,id:r,label:e("production","execution:"+t+":label",i),taktTime:i.taktTime||"na",width:m,left:p})},updateLastItem:function(t){var e=this.model.get(this[t+"Prop"])||[],i=e.length-1;if(-1!==i){var r=e[i];this.$('.production-timeline-item[data-type="'+t+'"][data-id="'+i+'"]').replaceWith(this.renderItem(t,r,i))}},scheduleExtendLastItems:function(){"done"===this.options.type&&(clearTimeout(this.timers.extendLastItems),this.timers.extendLastItems=setTimeout(this.extendLastItems.bind(this),6e3))},extendLastItems:function(){this.extendLastItem("order"),this.extendLastItem("downtime"),this.scheduleExtendLastItems()},extendLastItem:function(t){var e=this.model.get(this[t+"Prop"])||[],i=e.length-1,r=e[i];if(r&&!r.finishedAt){var o=this.$('.production-timeline-item[data-type="'+t+'"][data-id="'+i+'"]');if(o.length){var n=(Date.now()-r.startedAt)/288e5*100;o[0].style.width=n+"%"}}},renderOrderPopover:function(t){var e=this.model.get(this.orderProp)[t];return e?this.renderPartialHtml(m,{order:{orderNo:e.orderId,operationNo:e.operationNo,quantityDone:(e.quantityDone||0).toLocaleString(),workerCount:(e.workerCount||0).toLocaleString(),startedAt:i.format(e.startedAt,"HH:mm:ss"),finishedAt:e.finishedAt?i.format(e.finishedAt,"HH:mm:ss"):"-"}}):void 0},renderDowntimePopover:function(t){var e=this.model.get(this.downtimeProp)[t],r=n.get(e.reason),o=s.get(e.aor);return e?this.renderPartialHtml(p,{downtime:{reason:r?r.getLabel():e.reason,aor:o?o.getLabel():o.reason,startedAt:i.format(e.startedAt,"HH:mm:ss"),finishedAt:e.finishedAt?i.format(e.finishedAt,"HH:mm:ss"):"-"}}):void 0}})});