define(["jquery","app/i18n","app/time","app/core/View","app/core/util/getShiftStartInfo","app/data/downtimeReasons","app/data/aors","app/production/templates/executionTimeline","app/production/templates/executionTimelineItem","app/production/templates/executionOrderPopover","app/production/templates/executionDowntimePopover"],function(t,e,i,r,n,o,s,d,a,m,p){"use strict";return r.extend({template:d,events:{'click .production-timeline-item[data-type="order"]':function(t){if(""===document.getSelection().toString()){var e=this.model.get(this.orderProp)[t.currentTarget.dataset.id];this.model.trigger("newOrderRequested",e)}}},initialize:function(){this.orderProp=this.options.type+"Orders",this.downtimeProp=this.options.type+"Downtimes",this.listenTo(this.model,"change:"+this.orderProp,this.renderOrders),this.listenTo(this.model,"change:"+this.downtimeProp,this.renderDowntimes),"done"===this.options.type&&(this.listenTo(this.model,"change:lastOrder",this.updateLastItem.bind(this,"order")),this.listenTo(this.model,"change:lastDowntime",this.updateLastItem.bind(this,"downtime")))},afterRender:function(){var e=this;e.$el.popover({container:"body",selector:".production-timeline-item",trigger:"hover",placement:"auto top",html:!0,content:function(){return"order"===this.dataset.type?e.renderOrderPopover(this.dataset.id):"downtime"===this.dataset.type?e.renderDowntimePopover(this.dataset.id):void 0},template:function(e){return t(e).addClass("production-execution-popover")}}),this.renderOrders(),this.renderDowntimes(),this.scheduleExtendLastItems()},renderOrders:function(){this.renderItems("order")},renderDowntimes:function(){this.renderItems("downtime")},renderItems:function(t){var e=this,i=e.model.get(e[t+"Prop"])||[],r=i.length?n(i[0].startedAt).startTime:0,o=Date.now(),s=i.map(function(i,n){return e.renderItem(t,i,n,r,o)}).join("");e.$el.find('.production-timeline-item[data-type="'+t+'"]').remove(),e.$el.append(s),e.scheduleExtendLastItems()},renderItem:function(t,i,r,o,s){o||(o=n(i.startedAt).startTime),s||(s=Date.now());var d=Date.parse(i.startedAt),m=(Math.min(Date.parse(i.finishedAt)||s,s)-d)/288e5*100,p=(d-o)/288e5*100;return a({type:t,id:r,label:e("production","execution:"+t+":label",i),taktTime:i.taktTime||"na",width:m,left:p})},updateLastItem:function(t){var e=this.model.get(this[t+"Prop"])||[],i=e.length-1;if(-1!==i){var r=e[i];this.$('.production-timeline-item[data-type="'+t+'"][data-id="'+i+'"]').replaceWith(this.renderItem(t,r,i))}},scheduleExtendLastItems:function(){clearTimeout(this.timers.extendLastItems),this.timers.extendLastItems=setTimeout(this.extendLastItems.bind(this),1e3)},extendLastItems:function(){this.extendLastItem("order"),this.extendLastItem("downtime")},extendLastItem:function(t){this.scheduleExtendLastItems();var e=this.model.get(this[t+"Prop"]),i=e.length-1,r=e[i];if(r&&!r.finishedAt){var n=this.$('.production-timeline-item[data-type="'+t+'"][data-id="'+i+'"]'),o=Date.parse(r.startedAt),s=(Date.now()-o)/288e5*100;n[0].style.width=s+"%"}},renderOrderPopover:function(t){var e=this.model.get(this.orderProp)[t];return e?m({order:{orderNo:e.orderId,operationNo:e.operationNo,quantityDone:e.quantityDone.toLocaleString(),workerCount:e.workerCount.toLocaleString(),startedAt:i.format(e.startedAt,"HH:mm:ss"),finishedAt:e.finishedAt?i.format(e.finishedAt,"HH:mm:ss"):"-"}}):void 0},renderDowntimePopover:function(t){var e=this.model.get(this.downtimeProp)[t],r=o.get(e.reason),n=s.get(e.aor);return e?p({downtime:{reason:r?r.getLabel():e.reason,aor:n?n.getLabel():n.reason,startedAt:i.format(e.startedAt,"HH:mm:ss"),finishedAt:e.finishedAt?i.format(e.finishedAt,"HH:mm:ss"):"-"}}):void 0}})});