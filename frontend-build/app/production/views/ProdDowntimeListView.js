define(["app/i18n","app/time","app/viewport","app/data/aors","app/data/downtimeReasons","app/core/views/ListView","./DowntimePickerView"],function(e,t,o,i,n,r,s){"use strict";return r.extend({localTopics:{"downtimeReasons.synced":"render","aors.synced":"render"},remoteTopics:function(){var e={};return this.model.prodLine&&(e["prodDowntimes.corroborated."+this.model.prodLine.id+".*"]="onCorroborated"),e},events:{"click .warning":function(e){this.showEditDialog(e.currentTarget.dataset.id)}},initialize:function(){this.collection=this.model.prodDowntimes,r.prototype.initialize.apply(this,arguments),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"remove",this.render)},destroy:function(){this.$el.popover("destroy")},serializeColumns:function(){return[{id:"time",label:e("production","prodDowntime:time"),className:"is-min"},{id:"reason",label:e("production","prodDowntime:reason"),className:"is-min"},{id:"aor",label:e("production","prodDowntime:aor")}]},serializeRows:function(){var e=this.model.id;return this.model.prodDowntimes.filter(function(t){return t.get("prodShift")===e}).map(function(e){var o=e.toJSON(),r=i.get(o.aor),s=n.get(o.reason);return o.className=e.getCssClassName(),o.time=t.format(o.startedAt,"LTS"),o.finishedAt&&(o.time+="-"+t.format(o.finishedAt,"LTS")),r&&(o.aor=r.get("name")),s&&(o.reason=s.get("label")),o.reasonComment&&(o.className+=" has-comment",o.reason+=' <i class="fa fa-info-circle"></i>'),o})},serializeActions:function(){return[]},afterRender:function(){r.prototype.afterRender.call(this);var e=this;this.$el.popover({selector:".has-comment",trigger:"hover",placement:"top",container:this.el.ownerDocument.body,content:function(){return e.model.prodDowntimes.get(this.dataset.id).get("reasonComment")}}).on("shown.bs.popover",function(t){e.$(t.target).data("bs.popover").tip().addClass("production-downtimes-popover")})},onCorroborated:function(e){var t=this.model.prodDowntimes.get(e._id);t&&(delete e.changes,t.set(e),this.trigger("corroborated",e._id))},showEditDialog:function(t){var i=this.model,n=i.prodDowntimes.get(t);if(n){var r=new s({embedded:this.options.embedded,vkb:this.options.vkb,model:{mode:"edit",prodShift:i,startedAt:new Date(n.get("startedAt")),reason:n.get("reason"),aor:n.get("aor"),reasonComment:n.get("reasonComment")}});this.listenTo(r,"downtimePicked",function(e){delete e.startedAt,i.editDowntime(n,e),o.closeDialog()}),o.showDialog(r,e("production","downtimePicker:title:edit"))}}})});