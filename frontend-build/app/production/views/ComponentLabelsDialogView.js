define(["underscore","app/viewport","app/core/View","app/data/localStorage","app/componentLabels/ComponentLabel","app/componentLabels/ComponentLabelCollection","app/production/templates/componentLabels"],function(e,t,i,o,s,n,a){"use strict";return i.extend({template:a,dialogClassName:"production-modal production-componentLabels-modal",events:{"focus [data-vkb]":function(e){this.options.embedded&&this.options.vkb&&this.options.vkb.show(e.target)},"click .btn-default[value]":function(e){this.$(".btn.active[value]").removeClass("active"),e.currentTarget.classList.add("active")},"click #-test":function(){this.submitForm(!0)},submit:function(){return this.submitForm(!1),!1}},initialize:function(){this.selected=null,this.labelShift=JSON.parse(o.getItem("WMES_OPERATOR_COMPONENT_LABEL_SHIFT")||"[0, 0]"),this.componentLabels=new n(null,{url:"/orders/"+this.model.prodShiftOrder.get("orderId")+"/componentLabels/"+this.model.prodShiftOrder.get("operationNo")}),this.once("afterRender",function(){this.promised(this.componentLabels.fetch({reset:!0}))}),this.listenTo(this.componentLabels,"reset",this.renderComponentLabels)},destroy:function(){this.options.vkb&&this.options.vkb.hide()},getTemplateData:function(){return{orderNo:this.model.prodShiftOrder.get("orderId"),operationNo:this.model.prodShiftOrder.get("operationNo"),shiftX:this.labelShift[0],shiftY:this.labelShift[1]}},renderComponentLabels:function(){var e=this.$id("componentsList"),t=this.$id("componentsMessage"),i=this.$id("submit"),o=this.$id("test");if(!this.componentLabels.length)return e.addClass("hidden").empty(),t.html(this.t("componentLabels:noComponents")).removeClass("hidden"),i.prop("disabled",!0),void o.prop("disabled",!0);var s="";this.componentLabels.forEach(function(e){s+='<button type="button" class="btn btn-lg btn-default" value="'+e.id+'"><em>'+e.get("componentCode")+"</em><span>"+e.get("description")+"</span></button>"}),t.addClass("hidden"),e.html(s).removeClass("hidden"),i.prop("disabled",!1),o.prop("disabled",!1),1===this.componentLabels.length&&e.children().first().click()},submitForm:function(i){var s=this,n=+s.$id("labelQty").val().replace(/[^0-9]+/g,""),a=s.componentLabels.get(s.$(".btn.active[value]").val());if(n)if(a){var r=s.model.prodShiftOrder.get("orderData"),d=r&&r.bom||[],l=e.find(d,function(e){return e.nc12===a.get("componentCode")}),p=l&&l.qty||50;n>p&&(n=p),s.$id("labelQty").val(n),s.$id("submit").prop("disabled",!0),s.$id("test").prop("disabled",!0),s.$id(i?"test":"submit").find(".fa-spin").removeClass("hidden");var h=Math.max(Math.min(parseInt(s.$id("shiftX").val(),10)||0,9999),-9999),m=Math.max(Math.min(parseInt(s.$id("shiftY").val(),10)||0,120),-120);s.$id("shiftX").val(h),s.$id("shiftY").val(m),this.labelShift[0]===h&&this.labelShift[1]===m||(this.labelShift=[h,m],o.setItem("WMES_OPERATOR_COMPONENT_LABEL_SHIFT",JSON.stringify(this.labelShift)));var c=s.ajax({method:"POST",url:"/componentLabels/"+a.id+";print",data:JSON.stringify({test:i,labelQty:n,shiftX:h,shiftY:m,orderNo:this.model.prodShiftOrder.get("orderId"),prodLine:s.model.prodLine.id,secretKey:s.model.getSecretKey()})});c.fail(function(){var e=c.responseJSON&&c.responseJSON.error&&c.responseJSON.error.code||"";t.msg.show({type:"error",time:3e3,text:s.t.has("componentLabels:error:"+e)?s.t("componentLabels:error:"+e):s.t("componentLabels:error")}),s.$id("submit").prop("disabled",!1),s.$id("test").prop("disabled",!1),s.$id(i?"test":"submit").find(".fa-spin").addClass("hidden")}),c.done(function(){i||t.closeDialog()})}else s.$id("componentsList").find(".btn").first().focus();else s.$id("labelQty").focus()}})});