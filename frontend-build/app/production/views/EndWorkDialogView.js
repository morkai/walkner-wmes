// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/core/View","app/production/templates/endWorkDialog"],function(t,e,i,n){"use strict";return i.extend({template:n,dialogClassName:"production-modal",events:{submit:function(t){t.preventDefault();var i=this.$(".btn-warning")[0];if(!i.disabled){i.disabled=!0;var n=this.$id("spigot-nc12");if(n.length){var o=n.val().match(/([0-9]{12})/),s=o?o[1]:"";if(!s.length||!this.model.checkSpigot(null,s))return n[0].setCustomValidity(e("production","endWorkDialog:spigot:invalid")),void(this.timers.submit=setTimeout(function(){i.disabled=!1,i.click()},1,this))}var r=this.parseInt("quantitiesDone"),a=this.parseInt("quantityDone"),u=this.parseInt("workerCount");this.model.changeCurrentQuantitiesDone(r),a!==this.model.prodShiftOrder.get("quantityDone")&&this.model.changeQuantityDone(a),u!==this.model.prodShiftOrder.get("workerCount")&&this.model.changeWorkerCount(u),this.model.endWork(),this.closeDialog()}}},initialize:function(){this.lastKeyPressAt=0,t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("keypress."+this.idPrefix,this.onKeyPress.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},serialize:function(){var t=this.model,e=t.prodShiftOrder;return{idPrefix:this.idPrefix,spigot:t.settings.getValue("spigotFinish")&&!!e.get("spigot"),downtime:t.isDowntime(),hourRange:t.getCurrentQuantityDoneHourRange(),quantitiesDone:t.getQuantityDoneInCurrentHour(),quantityDone:e.get("quantityDone")||0,workerCount:e.getWorkerCountForEdit(),maxQuantitiesDone:t.getMaxQuantitiesDone(),maxQuantityDone:e.getMaxQuantityDone(),maxWorkerCount:e.getMaxWorkerCount()}},onDialogShown:function(t){this.closeDialog=t.closeDialog.bind(t)},closeDialog:function(){},parseInt:function(t){var e=parseInt(this.$id(t).val(),10);return isNaN(e)||e<0?0:e},onKeyDown:function(t){if(8===t.keyCode&&"number"!==t.target.type)return this.lastKeyPressAt=Date.now(),this.$id("spigot-nc12").val("")[0].setCustomValidity(""),!1},onKeyPress:function(t){var e=this.$id("spigot-nc12");if(13===t.keyCode)return e[0]!==t.target;if(!(t.keyCode<32||t.keyCode>126||"number"===t.target.type)){var i=Date.now(),n=i-this.lastKeyPressAt>333?"":e.val(),o=String.fromCharCode(t.keyCode);return e.val(n+o)[0].setCustomValidity(""),e.focus(),this.lastKeyPressAt=i,!1}}})});