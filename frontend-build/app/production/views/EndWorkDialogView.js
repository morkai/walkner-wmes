// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/core/View","app/production/templates/endWorkDialog"],function(t,e,i,n){"use strict";return i.extend({template:n,dialogClassName:"production-modal",events:{"focus [data-vkb]":function(t){this.options.embedded&&this.options.vkb&&this.options.vkb.show(t.target,this.onVkbValueChange)},"focus #-spigot-nc12":function(){this.options.embedded&&this.options.vkb&&this.options.vkb.hide()},'input input[type="text"][max]':"checkMinMaxValidity",'blur input[type="text"][max]':"checkMinMaxValidity",submit:function(t){t.preventDefault();var i=this.$(".btn-warning")[0];if(!i.disabled){i.disabled=!0;var n=this.$id("spigot-nc12");if(n.length){var o=n.val().match(/([0-9]{12})/),s=o?o[1]:"";if(!s.length||!this.model.checkSpigot(null,s))return n[0].setCustomValidity(e("production","endWorkDialog:spigot:invalid")),void(this.timers.submit=setTimeout(function(){i.disabled=!1,i.click()},1,this))}var a=this.parseInt("quantitiesDone"),r=this.parseInt("quantityDone"),d=this.parseInt("workerCount");this.model.changeCurrentQuantitiesDone(a),r!==this.model.prodShiftOrder.get("quantityDone")&&this.model.changeQuantityDone(r),d!==this.model.prodShiftOrder.get("workerCount")&&this.model.changeWorkerCount(d),this.model.endWork(),this.closeDialog()}}},initialize:function(){this.onVkbValueChange=this.onVkbValueChange.bind(this),this.lastKeyPressAt=0,t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("keypress."+this.idPrefix,this.onKeyPress.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide()},serialize:function(){var t=this.model,e=t.prodShiftOrder;return{idPrefix:this.idPrefix,spigot:t.settings.getValue("spigotFinish")&&!!e.get("spigot"),downtime:t.isDowntime(),hourRange:t.getCurrentQuantityDoneHourRange(),quantitiesDone:t.getQuantityDoneInCurrentHour(),quantityDone:e.get("quantityDone")||0,workerCount:e.getWorkerCountForEdit(),maxQuantitiesDone:t.getMaxQuantitiesDone(),maxQuantityDone:e.getMaxQuantityDone(),maxWorkerCount:e.getMaxWorkerCount(),embedded:this.options.embedded}},onDialogShown:function(t){this.closeDialog=t.closeDialog.bind(t)},closeDialog:function(){},parseInt:function(t){var e=parseInt(this.$id(t).val(),10);return isNaN(e)||e<0?0:e},isIgnoredTarget:function(t){return"number"===t.type||t.className.indexOf("select2")!==-1||"1"===t.dataset.ignoreKey},onVkbValueChange:function(t){this.checkMinMaxValidity({target:t})},onKeyDown:function(t){if(8===t.keyCode&&!this.isIgnoredTarget(t.target))return this.lastKeyPressAt=Date.now(),this.$id("spigot-nc12").val("")[0].setCustomValidity(""),!1},onKeyPress:function(t){var e=this.$id("spigot-nc12");if(e.length){if(13===t.keyCode)return e[0]!==t.target;if(!(t.keyCode<32||t.keyCode>126||this.isIgnoredTarget(t.target))){var i=Date.now(),n=i-this.lastKeyPressAt>333?"":e.val(),o=String.fromCharCode(t.keyCode);return e.val(n+o)[0].setCustomValidity(""),e.focus(),this.lastKeyPressAt=i,!1}}},checkMinMaxValidity:function(t){var i=t.target,n=parseInt(i.getAttribute("max"),10);if(!isNaN(n)){var o=parseInt(i.getAttribute("min"),10)||0,s=parseInt(i.value,10)||0,a="";s<o?a=e("production","error:min",{min:o}):s>n&&(a=e("production","error:max",{max:n})),i.setCustomValidity(a)}}})});