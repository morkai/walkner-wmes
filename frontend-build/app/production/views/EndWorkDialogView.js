define(["jquery","app/i18n","app/core/View","../util/limitQuantityDone","app/production/templates/endWorkDialog"],function(t,i,e,o,n){"use strict";return e.extend({template:n,dialogClassName:"production-modal",remoteTopics:function(){var t={};return t["production.spigotCheck.scanned."+this.model.prodLine.id]="onSpigotScanned",t},events:{"focus [data-vkb]":function(t){this.options.embedded&&this.options.vkb&&this.options.vkb.show(t.target,this.onVkbValueChange)},"focus #-spigot-nc12":function(){this.options.embedded&&this.options.vkb&&this.options.vkb.hide()},'input input[type="text"][max]':"checkMinMaxValidity",'blur input[type="text"][max]':"checkMinMaxValidity",submit:function(t){t.preventDefault();var e=this.$(".btn-warning")[0];if(!e.disabled){e.disabled=!0;var o=this.$id("spigot-nc12");if(o.length){var n=o.val().match(/([0-9]{12})/),s=n?n[1]:"";if(!s.length||!this.model.checkSpigot(null,s))return o[0].setCustomValidity(i("production","endWorkDialog:spigot:invalid")),void(this.timers.submit=setTimeout(function(){e.disabled=!1,e.click()},1,this))}if(this.ft.checkCredentials)return this.ft.checkCredentials();var r=this.parseInt("quantitiesDone"),d=this.parseInt("quantityDone"),a=this.parseInt("workerCount");this.model.changeCurrentQuantitiesDone(r),d!==this.model.prodShiftOrder.get("quantityDone")&&this.model.changeQuantityDone(d),a!==this.model.prodShiftOrder.get("workerCount")&&this.model.changeWorkerCount(a),this.model.endWork(),this.closeDialog()}}},initialize:function(){this.onVkbValueChange=this.onVkbValueChange.bind(this),this.lastKeyPressAt=0,this.listenTo(this.model.prodShiftOrder,"qtyMaxChanged",this.limitQuantityDone),t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("keypress."+this.idPrefix,this.onKeyPress.bind(this))},destroy:function(){t(window).off("."+this.idPrefix),this.options.vkb&&this.options.vkb.hide(),this.$id("spigot-nc12").length&&this.pubsub.publish("production.spigotCheck.aborted."+this.model.prodLine.id,{prodLineId:this.model.prodLine.id})},serialize:function(){var t=this.model,i=t.prodShiftOrder;return{idPrefix:this.idPrefix,spigot:t.settings.getValue("spigotFinish")&&!!i.get("spigot"),downtime:t.isDowntime(),hourRange:t.getCurrentQuantityDoneHourRange(),quantitiesDone:t.getQuantityDoneInCurrentHour(),quantityDone:i.get("quantityDone")||0,workerCount:i.getWorkerCountForEdit(),maxQuantitiesDone:t.getMaxQuantitiesDone(),maxQuantityDone:i.getMaxQuantityDone(),maxWorkerCount:i.getMaxWorkerCount(),embedded:this.options.embedded}},afterRender:function(){this.limitQuantityDone(),this.notifySpigotCheckRequest()},notifySpigotCheckRequest:function(){this.$id("spigot-nc12").length&&(clearTimeout(this.timers.notifySpigotCheckRequest),this.timers.notifySpigotCheckRequest=setTimeout(this.notifySpigotCheckRequest.bind(this),5e3),this.pubsub.publish("production.spigotCheck.requested."+this.model.prodLine.id,{prodLine:this.model.prodLine.id,component:this.model.prodShiftOrder.get("spigot").component,orderNo:this.model.prodShiftOrder.get("orderId"),source:"endWork"}))},onSpigotScanned:function(t){var i=this.$id("spigot-nc12").val(t.nc12);if(i.length){i[0].setCustomValidity("");var e=this.model.prodLine.id,o=this.model.prodShiftOrder,n=o.get("spigot");n&&(this.model.checkSpigotValidity(t.nc12,n.component.nc12)?this.pubsub.publish("production.spigotCheck.success."+e,{prodLine:e,component:n.component,orderNo:o.get("orderId"),input:t.nc12,nc12:n.component.nc12,source:"endWork"}):this.pubsub.publish("production.spigotCheck.failure."+e,{prodLine:e,component:n.component,orderNo:o.get("orderId"),input:t.nc12,source:"endWork"}))}},limitQuantityDone:function(){o(this,this.model.prodShiftOrder)},onDialogShown:function(t){this.closeDialog=t.closeDialog.bind(t)},closeDialog:function(){},parseInt:function(t){var i=parseInt(this.$id(t).val(),10);return isNaN(i)||i<0?0:i},isIgnoredTarget:function(t){return"number"===t.type||-1!==t.className.indexOf("select2")||"1"===t.dataset.ignoreKey},onVkbValueChange:function(t){this.checkMinMaxValidity({target:t})},onKeyDown:function(t){if(8===t.keyCode&&!this.isIgnoredTarget(t.target)){this.lastKeyPressAt=Date.now();var i=this.$id("spigot-nc12");return i.length&&i.val("")[0].setCustomValidity(""),!1}},onKeyPress:function(t){var i=this.$id("spigot-nc12");if(i.length){if(13===t.keyCode)return i[0]!==t.target;if(!(t.keyCode<32||t.keyCode>126||this.isIgnoredTarget(t.target))){var e=Date.now(),o=e-this.lastKeyPressAt>333?"":i.val(),n=String.fromCharCode(t.keyCode);return i.val(o+n)[0].setCustomValidity(""),i.focus(),this.lastKeyPressAt=e,!1}}},checkMinMaxValidity:function(t){var e=t.target,o=parseInt(e.getAttribute("max"),10);if(!isNaN(o)){var n=parseInt(e.getAttribute("min"),10)||0,s=parseInt(e.value,10)||0,r="";s<n?r=i("production","error:min",{min:n}):s>o&&(r=i("production","error:max",{max:o})),e.setCustomValidity(r)}}})});