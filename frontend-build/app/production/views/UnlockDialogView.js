// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/viewport","app/core/View","app/production/templates/unlockDialog"],function(i,o,e,s){return e.extend({template:s,dialogClassName:"production-modal",events:{submit:function(i){i.preventDefault();var o=this.$id("submit")[0];if(!o.disabled){o.disabled=!0;var e={prodLine:this.model.prodLine.id,login:this.$id("login").val(),password:this.$id("password").val()};this.socket.emit("production.unlock",e,this.handleUnlockResponse.bind(this))}}},serialize:function(){return{idPrefix:this.idPrefix,type:"unlock",prodLine:this.model.prodLine.id}},onDialogShown:function(i){this.closeDialog=i.closeDialog.bind(i)},closeDialog:function(){},handleUnlockResponse:function(e,s){if(e)return this.$id("password").val(""),"INVALID_PASSWORD"===e.message?this.$id("password").focus():this.$id("login").val("").focus(),o.msg.show({type:"error",time:3e3,text:i.has("production","unlockDialog:error:"+e.message)?i("production","unlockDialog:error:"+e.message):i("production","unlockDialog:error:UNLOCK_FAILURE")}),this.$id("submit").prop("disabled",!1);var t=s.prodShift;t&&(t.prodShiftOrder=s.prodShiftOrder,t.prodDowntimes=s.prodDowntimes),this.model.setSecretKey(s.secretKey,t),this.closeDialog()}})});