// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","app/core/View","app/data/dictionaries","app/data/orgUnits","app/prodLines/ProdLineCollection","app/production/templates/unlockDialog"],function(e,i,t,o,r,s,n,d){"use strict";return o.extend({template:d,dialogClassName:"production-modal",events:{submit:function(e){e.preventDefault();var i=this.$id("submit")[0];if(!i.disabled){i.disabled=!0;var t={prodLine:this.model.get("prodLine")||this.$id("prodLine").val(),login:this.$id("login").val(),password:this.$id("password").val()};this.socket.emit("production.unlock",t,this.handleUnlockResponse.bind(this))}}},serialize:function(){return{idPrefix:this.idPrefix,type:"unlock",prodLine:this.model.get("prodLine")}},afterRender:function(){this.model.get("prodLine")||this.setUpProdLineSelect2()},setUpProdLineSelect2:function(){var i=this,t=new n(null,{rqlQuery:"deactivatedAt=null&sort(_id)"});t.once("reset",function(){var o=i.$id("prodLine");o.length&&(o.parent().addClass("has-required-select2"),o.removeClass("form-control").select2({data:t.map(function(e){return{id:e.id,text:e.id,description:e.get("description")}}),matcher:function(e,i,t){return e=e.toUpperCase(),i.toUpperCase().indexOf(e)!==-1||t.description.toUpperCase().indexOf(e)!==-1},formatResult:function(i){var t='<div class="production-select2">';return t+="<p><strong>"+e.escape(i.id)+"</strong><br>",t+=e.escape(i.description)+"</p>",t+="</div>"}}).select2("focus"))}),this.promised(t.fetch({reset:!0}))},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.$id("prodLine").select2("focus")},closeDialog:function(){},handleUnlockResponse:function(o,n){if(o)return this.$id("password").val(""),"INVALID_PASSWORD"===o.message?this.$id("password").focus():this.$id("login").val("").focus(),t.msg.show({type:"error",time:3e3,text:i.has("production","unlockDialog:error:"+o.message)?i("production","unlockDialog:error:"+o.message):i("production","unlockDialog:error:UNLOCK_FAILURE")}),this.$id("submit").prop("disabled",!1);this.model.get("prodLine")||e.forEach(n.dictionaries,function(e,i){var t=r[i];t&&t.reset(e)}),delete n.dictionaries;var d=n.prodShift;if(d?(d.prodShiftOrder=n.prodShiftOrder,d.prodDowntimes=n.prodDowntimes):d={},!this.model.get("prodLine")){var a=s.getByTypeAndId("prodLine",n.prodLine);if(null===a)return this.closeDialog();d=e.assign(d,s.getAllForProdLine(a))}this.model.setSecretKey(n.secretKey,d,!0),this.closeDialog()}})});