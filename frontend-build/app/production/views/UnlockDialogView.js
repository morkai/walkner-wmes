// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/viewport","app/core/View","app/data/dictionaries","app/data/orgUnits","app/prodLines/ProdLineCollection","app/production/templates/unlockDialog"],function(e,i,o,t,r,s,n,d){"use strict";return t.extend({template:d,dialogClassName:"production-modal",events:{submit:function(e){e.preventDefault();var i=this.$id("submit")[0];if(!i.disabled){i.disabled=!0;var o={prodLine:this.model.prodLine.id||this.$id("prodLine").val(),login:this.$id("login").val(),password:this.$id("password").val()};this.socket.emit("production.unlock",o,this.handleUnlockResponse.bind(this))}}},serialize:function(){return{idPrefix:this.idPrefix,type:"unlock",prodLine:this.model.prodLine.id}},afterRender:function(){this.model.prodLine.id||this.setUpProdLineSelect2()},setUpProdLineSelect2:function(){var i=this,o=new n(null,{rqlQuery:"deactivatedAt=null&sort(_id)"});o.once("reset",function(){var t=i.$id("prodLine");t.length&&(t.parent().addClass("has-required-select2"),t.removeClass("form-control").select2({data:o.map(function(e){return{id:e.id,text:e.id,description:e.get("description")}}),matcher:function(e,i,o){return e=e.toUpperCase(),-1!==i.toUpperCase().indexOf(e)||-1!==o.description.toUpperCase().indexOf(e)},formatResult:function(i){var o='<div class="production-select2">';return o+="<p><strong>"+e.escape(i.id)+"</strong><br>",o+=e.escape(i.description)+"</p>",o+="</div>"}}).select2("focus"))}),this.promised(o.fetch({reset:!0}))},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.$id("prodLine").select2("focus")},closeDialog:function(){},handleUnlockResponse:function(t,n){if(t)return this.$id("password").val(""),"INVALID_PASSWORD"===t.message?this.$id("password").focus():this.$id("login").val("").focus(),o.msg.show({type:"error",time:3e3,text:i.has("production","unlockDialog:error:"+t.message)?i("production","unlockDialog:error:"+t.message):i("production","unlockDialog:error:UNLOCK_FAILURE")}),this.$id("submit").prop("disabled",!1);this.model.prodLine.id||e.forEach(n.dictionaries,function(e,i){var o=r[i];o&&o.reset(e)}),delete n.dictionaries;var d=n.prodShift;if(d?(d.prodShiftOrder=n.prodShiftOrder,d.prodDowntimes=n.prodDowntimes):d={},!this.model.prodLine.id){var a=s.getByTypeAndId("prodLine",n.prodLine);if(null===a)return this.closeDialog();d=e.assign(d,s.getAllForProdLine(a))}this.model.setSecretKey(n.secretKey,d,!0),this.closeDialog()}})});