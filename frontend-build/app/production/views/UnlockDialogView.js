define(["underscore","app/i18n","app/viewport","app/core/View","app/data/dictionaries","app/data/orgUnits","app/prodLines/ProdLineCollection","app/production/templates/unlockDialog"],function(i,t,o,e,n,s,a,d){"use strict";return e.extend({template:d,dialogClassName:"production-modal",events:{submit:function(i){i.preventDefault();var t=this.$id("list").find(".active").text().trim(),o=this.$('input[name="station"]:checked').val();if(t&&o){var e=this.$id("submit")[0];if(!e.disabled){e.disabled=!0;var n={prodLine:t,station:+o,apiKey:this.$id("apiKey").val(),login:this.$id("login").val(),password:this.$id("password").val()};this.socket.emit("production.unlock",n,this.handleUnlockResponse.bind(this))}}},"click #-list .btn":function(i){this.$id("list").find(".active").removeClass("active"),this.$(i.currentTarget).addClass("active")},"click .btn":function(){this.options.vkb&&this.options.vkb.hide()},"focus [data-vkb]":function(i){this.options.embedded&&this.options.vkb&&this.options.vkb.show(i.target)}},destroy:function(){this.options.vkb&&this.options.vkb.hide()},getTemplateData:function(){return{type:"unlock",apiKey:window.WMES_CLIENT&&window.WMES_CLIENT.apiKey||"",prodLine:""}},afterRender:function(){this.loadLines(),this.$('input[name="station"][value="1"]').click()},selectActiveLine:function(){var i=this.$id("list").find(".active");i.length&&i[0].scrollIntoView({block:"center"})},loadLines:function(){var t=this;t.$id("submit").prop("disabled",!0);var o=t.ajax({url:"/production/getActiveLines?subdivisionType=assembly"});o.fail(function(){t.$(".fa-spin").removeClass("fa-spin")}),o.done(function(o){var e="",n=window.WMES_CLIENT&&window.WMES_CLIENT.config||{};i.forEach(o.collection,function(t){var o="btn btn-lg btn-default";t._id===n.line&&(o+=" active"),e+='<button type="button" class="'+o+'">'+i.escape(t._id)+"</button>"}),t.$id("list").html(e),t.$id("submit").prop("disabled",!1),t.options.vkb&&t.options.vkb.reposition();var s=t.$id("list").find(".active")[0];s&&n.station&&(s.scrollIntoView(),t.$('input[name="station"][value="'+n.station+'"]').click(),t.$id("submit").click())})},onDialogShown:function(i){this.closeDialog=i.closeDialog.bind(i)},closeDialog:function(){},handleUnlockResponse:function(t,e){if(t){this.$id("password").val(""),"INVALID_PASSWORD"===t.message?this.$id("password").focus():this.$id("login").val("").focus();var a=t.code||t.message;return o.msg.show({type:"error",time:3e3,text:this.t.has("unlockDialog:error:"+a)?this.t("unlockDialog:error:"+a):this.t("unlockDialog:error:UNLOCK_FAILURE")}),this.$id("submit").prop("disabled",!1)}this.model.get("prodLine")||i.forEach(e.dictionaries,function(i,t){var o=n[t];o&&o.reset(i)}),delete e.dictionaries;var d=e.prodShift;if(d?(d.prodShiftOrder=e.prodShiftOrder,d.prodDowntimes=e.prodDowntimes):d={},!this.model.get("prodLine")){var r=s.getByTypeAndId("prodLine",e.prodLine);if(null===r)return this.closeDialog();d=i.assign(d,s.getAllForProdLine(r))}d.station=e.station>=1&&e.station<=7?e.station:0,this.model.setSecretKey(e.secretKey,d,!0),this.closeDialog()}})});