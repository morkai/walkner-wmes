// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/user","app/core/util/idAndLabel","app/core/util/formatResultWithDescription","app/data/downtimeReasons","app/data/orgUnits","app/settings/views/SettingsView","app/production/templates/lineAutoDowntimeRow","app/production/templates/settings"],function(t,e,i,o,n,s,u,a,l,r){"use strict";return a.extend({clientUrl:"#production;settings",template:r,events:t.extend({"change input[data-setting]":function(t){this.updateSetting(t.target.name,t.target.value)},"change #-lineAutoDowntimes-groups":function(t){t.added?this.selectAutoDowntimeGroup(t.added.id):this.clearAutoDowntimeGroup()},"change #-lineAutoDowntimes-group":"updateAutoDowntimeGroupName","input #-lineAutoDowntimes-group":"updateAutoDowntimeGroupName","change #-lineAutoDowntimes-lines":"updateAutoDowntimeLines","change #-lineAutoDowntimes-reasons":function(t){if(t.added){var e={reason:t.added.id,when:"always",time:[]};this.selectedAutoDowntimeGroup.downtimes.push(e),this.addAutoDowntimeRow(e),this.scheduleAutoDowntimeSave(),this.$id("lineAutoDowntimes-reasons").select2("val",null)}},'click .btn[data-auto-downtime-action="up"]':function(t){var e=this.$(t.target).closest("tr"),i=e.prev();i.length&&(e.insertBefore(i),this.updateAutoDowntimes())},'click .btn[data-auto-downtime-action="down"]':function(t){var e=this.$(t.target).closest("tr"),i=e.next();i.length&&(e.insertAfter(i),this.updateAutoDowntimes())},'click .btn[data-auto-downtime-action="remove"]':function(t){var e=this,i=e.$(t.target).closest("tr").fadeOut("fast",function(){i.remove(),e.updateAutoDowntimes()})},'change [name$="when"]':function(t){var e=this.$(t.target).closest("tr"),i=e.find('[name$="when"]:checked').val();e.find('[name$="time"]').prop("disabled","time"!==i),this.updateAutoDowntimes()},'change [name$="time"]':function(t){for(var e,i=/(?:([0-9]+)\s*@\s*)?([0-9]{1,2}):([0-9]{1,2})/g,o=[];null!==(e=i.exec(t.target.value));){var n=+e[1]||0;n<0?n=0:n>480&&(n=480);var s=+e[2];if(!(s>=24)){var u=+e[3];u>=60||(s<10&&(s="0"+s),u<10&&(u="0"+u),o.push((n?n+"@":"")+s+":"+u))}}t.target.value=o.join(", "),this.updateAutoDowntimes()}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),this.autoDowntimeIndex=0,this.selectedAutoDowntimeGroup=null},serialize:function(){var e=!i.isAllowedTo("SUPER")&&i.isAllowedTo("PROD_DATA:MANAGE:SPIGOT_ONLY");return t.assign(a.prototype.serialize.apply(this,arguments),{subtabs:e?["spigot"]:["taktTime","downtimes","spigot"],onlySpigot:e})},afterRender:function(){a.prototype.afterRender.apply(this,arguments);var t=s.map(o),i=u.getAllByType("prodLine").filter(function(t){return!t.get("deactivatedAt")}).map(o);this.$id("rearmDowntimeReason").select2({allowClear:!0,placeholder:" ",data:t}),this.$id("spigotLines").select2({allowClear:!0,placeholder:" ",multiple:!0,data:i}),this.$id("taktTime-lines").select2({allowClear:!0,placeholder:" ",multiple:!0,data:i}),this.$id("taktTime-ignoredDowntimes").select2({allowClear:!0,placeholder:" ",multiple:!0,data:t}),this.setUpAutoDowntimeGroups(),this.$id("lineAutoDowntimes-reasons").select2({width:"400px",placeholder:e("production","settings:lineAutoDowntimes:reasons:placeholder"),data:s.map(function(t){return{id:t.id,text:t.id+" - "+t.getLabel()}})}),this.$id("lineAutoDowntimes-lines").select2({placeholder:" ",multiple:!0,data:u.getAllByType("prodLine").filter(function(t){if(t.get("deactivatedAt"))return!1;var e=u.getSubdivisionFor(t);return e&&"assembly"===e.get("type")}).map(o).sort(function(t,e){return t.text.localeCompare(e.text)})}),this.selectedAutoDowntimeGroup?this.selectAutoDowntimeGroup(this.selectedAutoDowntimeGroup.id):this.clearAutoDowntimeGroup()},setUpAutoDowntimeGroups:function(){this.$id("lineAutoDowntimes-groups").select2({allowClear:!0,placeholder:e("production","settings:lineAutoDowntimes:groups:placeholder"),data:(this.settings.getValue("lineAutoDowntimes")||[]).map(function(t){return{id:t.id,text:t.name,lines:t.lines.join(", ")}}),formatResult:n.bind(null,"text","lines")}),this.selectedAutoDowntimeGroup&&this.$id("lineAutoDowntimes-groups").select2("val",this.selectedAutoDowntimeGroup.id)},selectAutoDowntimeGroup:function(e){var i=t.find(this.settings.getValue("lineAutoDowntimes"),function(t){return t.id===e});i&&(this.$id("lineAutoDowntimes-groups").select2("val",i.id),this.$id("lineAutoDowntimes-group").val(i.name),this.$id("lineAutoDowntimes-lines").select2("val",i.lines),this.$id("lineAutoDowntimes-body").html(""),i.downtimes.forEach(this.addAutoDowntimeRow,this),this.selectedAutoDowntimeGroup=t.clone(i))},addAutoDowntimeRow:function(t){this.$id("lineAutoDowntimes-body").append(l({lineAutoDowntime:{i:++this.autoDowntimeIndex,reason:o(s.get(t.reason)),when:t.when,time:t.time.map(function(t){return(t.d>0?t.d+"@":"")+(t.h<10?"0":"")+t.h+":"+(t.m<10?"0":"")+t.m}).join(", ")}}))},clearAutoDowntimeGroup:function(){this.$id("lineAutoDowntimes-groups").select2("val",null),this.$id("lineAutoDowntimes-group").val(""),this.$id("lineAutoDowntimes-lines").select2("val",[]),this.$id("lineAutoDowntimes-body").html(""),this.selectedAutoDowntimeGroup={id:Date.now().toString(36).toUpperCase()+Math.round(1e6+8999998*Math.random()).toString(36).toUpperCase(),name:"",lines:[],downtimes:[]}},updateAutoDowntimeGroupName:function(){this.selectedAutoDowntimeGroup.name=this.$id("lineAutoDowntimes-group").val(),this.scheduleAutoDowntimeSave()},updateAutoDowntimeLines:function(){var t=this.$id("lineAutoDowntimes-lines").val();this.selectedAutoDowntimeGroup.lines=t.length?t.split(","):[],this.scheduleAutoDowntimeSave()},updateAutoDowntimes:function(){var t=[];this.$id("lineAutoDowntimes-body").find("tr").each(function(){t.push({reason:this.querySelector('[name$="reason"]').value,when:this.querySelector('[name$="when"]:checked').value,time:this.querySelector('[name$="time"]').value.split(",").map(function(t){var e=t.match(/(?:([0-9]+)@)?([0-9]{1,2}):([0-9]{1,2})/);return e?{h:+e[2],m:+e[3],d:+e[1]||0}:null}).filter(function(t){return!!t})})}),this.selectedAutoDowntimeGroup.downtimes=t,this.scheduleAutoDowntimeSave()},scheduleAutoDowntimeSave:function(){this.saveAutoDowntimesTimer&&clearTimeout(this.saveAutoDowntimesTimer),this.saveAutoDowntimesTimer=setTimeout(this.saveAutoDowntimes.bind(this),1e3)},saveAutoDowntimes:function(){this.saveAutoDowntimesTimer=null;var e=[].concat(this.settings.getValue("lineAutoDowntimes")||[]),i=this.selectedAutoDowntimeGroup,o=t.findIndex(e,function(t){return t.id===i.id}),n=e[o];n?e[o]=i:(e.push(i),e.sort(function(t,e){return t.name.localeCompare(e.name)})),e=e.filter(function(t){return t.name.length>0&&t.lines.length>0&&t.downtimes.length>0}),n||(this.setUpAutoDowntimeGroups(),this.$id("lineAutoDowntimes-groups").select2("val",i.id)),this.updateSetting("production.lineAutoDowntimes",e)},updateSetting:function(t){/^lineAutoDowntime/.test(t)||a.prototype.updateSetting.apply(this,arguments)},updateSettingField:function(t){"production.lineAutoDowntimes"===t.id&&this.updateLineAutoDowntimesFields()},updateLineAutoDowntimesFields:function(){this.setUpAutoDowntimeGroups();var e=this.selectedAutoDowntimeGroup,i=t.find(this.settings.getValue("lineAutoDowntimes"),function(t){return t.id===e.id});i&&(t.isEqual(e,i)||this.selectAutoDowntimeGroup(i.id))}})});