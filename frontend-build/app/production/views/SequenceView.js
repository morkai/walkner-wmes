define(["underscore","jquery","app/viewport","app/core/View","app/wmes-fap-entries/Entry","app/wmes-fap-entries/pages/DetailsPage","app/production/templates/sequence"],function(e,t,o,r,n,i,d){"use strict";return r.extend({template:d,events:{"click a[data-order]":function(e){var t=this.model.execution.get("todoOrders")[e.currentTarget.dataset.order];this.model.trigger("newOrderRequested",t)},"click a[data-fap]":function(e){o.msg.loading();var r=new i({dialogClassName:"production-fapEntry-dialog",model:new n({_id:e.currentTarget.dataset.fap})});r.load(t.when).fail(function(){o.msg.loadingFailed()}).done(function(){o.msg.loaded(),r.setView(r.view),o.showDialog(r)})}},remoteTopics:function(){var e={};return this.model.prodLine&&(e["old.wh.problems."+this.model.prodLine.id+".*"]="onWhProblem",e["production.fapEntries.updated"]="onFapUpdated"),e},initialize:function(){this.scheduleRender=e.debounce(this.render.bind(this),1),this.once("afterRender",function(){this.listenTo(this.model.execution,"change",this.scheduleRender),this.listenTo(this.model.prodShiftOrder,"change",this.scheduleRender)})},getTemplateData:function(){return{rows:this.serializeRows()}},serializeRows:function(){var e=this,t=e.model.prodShiftOrder.get("orderId")+e.model.prodShiftOrder.get("operationNo"),o=e.model.execution.get("whProblems")||[],r={};(e.model.execution.get("doneOrders")||[]).forEach(function(e){var t=e.orderId+e.operationNo;r[t]||(r[t]=0),r[t]+=e.quantityDone});var n={},i=(e.model.execution.get("todoOrders")||[]).map(function(i){var d=i.orderId+i.operationNo,a=i.quantityDone,s=0;r[d]>=a?(s=a,r[d]-=a):(s=r[d]||0,r[d]=0),r[d]||delete r[d];var l={className:"default",shift:e.t("core","SHIFT:"+i.shift),order:i.orderId,name:i.productName,quantityDone:s,quantityTodo:a,faps:i.fapEntries};return d===t?l.className="info":s>=a?l.className="success":-1!==o.indexOf(i.orderId)?l.className="danger":s&&(l.className="warning"),n[d]=l,l});return Object.keys(r).forEach(function(e){n[e]&&(n[e].quantityDone+=r[e])}),i},afterRender:function(){var e=this.$(".info");e.length||(e=this.$(".default").first()),e.length&&(this.$(".table-responsive")[0].scrollTop=e[0].offsetTop)},onWhProblem:function(e){if(e.order&&null!==e.state){var t=this.model.execution.get("whProblems")||[];e.state?this.model.execution.set("whProblems",t.concat([e.order])):this.model.execution.set("whProblems",t.filter(function(t){return t!==e.order}))}else this.reloadWhProblems()},reloadWhProblems:function(){var e=this;e.reloadReq||(e.reloadReq=e.ajax({url:"/old/wh/orders?select(order)&status=problem&lines._id="+encodeURIComponent(this.model.prodLine.id)}),e.reloadReq.done(function(t){var o={};(t.collection||[]).forEach(function(e){o[e.order]=1}),e.model.execution.set({whProblems:Object.keys(o)})}),e.reloadReq.always(function(){e.reloadReq=null}))},onFapUpdated:function(e){(e.added||[]).forEach(this.addFapEntry,this),(e.deleted||[]).forEach(this.deleteFapEntry,this),(e.updated||[]).forEach(this.updateFapEntry,this)},addFapEntry:function(e){var t=!1;(this.model.execution.get("todoOrders")||[]).forEach(function(o){o.orderId===e.orderNo&&(o.fapEntries.push(e),t=!0)}),t&&this.scheduleRender()},deleteFapEntry:function(e){var t=!1;(this.model.execution.get("todoOrders")||[]).forEach(function(o){var r=o.fapEntries.length;o.fapEntries=o.fapEntries.filter(function(t){return t._id!==e._id}),t=t||r!==o.fapEntries.length}),t&&this.scheduleRender()},updateFapEntry:function(e){var t=!1;(this.model.execution.get("todoOrders")||[]).forEach(function(o){o.fapEntries.forEach(function(o){o._id===e._id&&(Object.assign(o,e),t=!0)})}),t&&this.scheduleRender()}})});