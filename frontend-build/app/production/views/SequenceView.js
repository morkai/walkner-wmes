define(["underscore","app/core/View","app/production/templates/sequence"],function(e,o,t){"use strict";return o.extend({template:t,remoteTopics:function(){var e={};return this.model.prodLine&&(e["old.wh.problems."+this.model.prodLine.id+".*"]="onProblem"),e},initialize:function(){var o=e.debounce(this.render.bind(this),1);this.once("afterRender",function(){this.listenTo(this.model.execution,"change",o),this.listenTo(this.model.prodShiftOrder,"change",o)})},getTemplateData:function(){return{rows:this.serializeRows()}},serializeRows:function(){var e=this,o=e.model.prodShiftOrder.get("orderId")+e.model.prodShiftOrder.get("operationNo"),t=e.model.execution.get("whProblems")||[],r={};(e.model.execution.get("doneOrders")||[]).forEach(function(e){var o=e.orderId+e.operationNo;r[o]||(r[o]=0),r[o]+=e.quantityDone});var n={},i=(e.model.execution.get("todoOrders")||[]).map(function(i){var s=i.orderId+i.operationNo,d=i.quantityDone,a=0;r[s]>=d?(a=d,r[s]-=d):(a=r[s]||0,r[s]=0),r[s]||delete r[s];var l={className:"default",shift:e.t("core","SHIFT:"+i.shift),order:i.orderId,quantityDone:a,quantityTodo:d};return s===o?l.className="info":a>=d?l.className="success":-1!==t.indexOf(i.orderId)?l.className="danger":a&&(l.className="warning"),n[s]=l,l});return Object.keys(r).forEach(function(e){n[e]&&(n[e].quantityDone+=r[e])}),i},afterRender:function(){var e=this.$(".info");e.length||(e=this.$(".default").first()),e.length&&(this.$(".table-responsive")[0].scrollTop=e[0].offsetTop)},onProblem:function(e){if(e.order&&null!==e.state){var o=this.model.execution.get("whProblems")||[];e.state?this.model.execution.set("whProblems",o.concat([e.order])):this.model.execution.set("whProblems",o.filter(function(o){return o!==e.order}))}else this.reloadWhProblems()},reloadWhProblems:function(){var e=this;e.reloadReq||(e.reloadReq=e.ajax({url:"/old/wh/orders?select(order)&status=problem&lines._id="+encodeURIComponent(this.model.prodLine.id)}),e.reloadReq.done(function(o){var t={};(o.collection||[]).forEach(function(e){t[e.order]=1}),e.model.execution.set({whProblems:Object.keys(t)})}),e.reloadReq.always(function(){e.reloadReq=null}))}})});