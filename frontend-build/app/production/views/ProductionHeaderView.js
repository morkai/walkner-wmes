define(["app/i18n","app/viewport","app/core/View","app/data/prodLog","app/orgUnits/util/renderOrgUnitPath","app/users/UserCollection","./PersonnelPickerView","./MultiPersonnelPickerView","app/production/templates/header"],function(e,t,i,r,o,n,s,a,l){"use strict";return i.extend({template:l,localTopics:{"divisions.synced":"updateOrgUnit","subdivisions.synced":"updateOrgUnit","mrpControllers.synced":"updateOrgUnit","prodFlows.synced":"updateOrgUnit","workCenters.synced":"updateOrgUnit","prodLines.synced":"updateOrgUnit","socket.connected":"fillPersonnelData"},events:{"click #-master":"showMasterPickerDialog","click #-leader":"showLeaderPickerDialog","click #-operator":"showOperatorPickerDialog"},initialize:function(){var e=this.model;this.listenTo(e.prodLine,"change:description",this.updatePageHeader),this.listenTo(e,"second",this.updateCurrentTime),this.listenTo(e,"change:shift",this.updateShift),this.listenTo(e,"change:master",this.updateMaster),this.listenTo(e,"change:leader",this.updateLeader),this.listenTo(e,"change:operator",this.updateOperator),this.listenTo(e,"locked unlocked",function(){this.updateMaster(),this.updateLeader(),this.updateOperator()})},afterRender:function(){this.$currentTime=this.$property("currentTime"),this.updatePageHeader(),this.updateCurrentTime(),this.updateShift(),this.updateOrgUnit(),this.updateMaster(),this.updateLeader(),this.updateOperator(),this.socket.isConnected()&&this.fillPersonnelData()},updatePageHeader:function(){this.$(".production-pageHeader").text(this.model.prodLine.get("description")||this.model.prodLine.id||"?")},updateCurrentTime:function(){this.$currentTime&&this.$currentTime.text(this.model.getCurrentTime())},updateShift:function(){var t=this.model.get("shift");t="number"==typeof t?e("core","SHIFT:"+t):"?",this.$property("shift").text(t)},updateOrgUnit:function(){this.$property("orgUnit").html(o(this.model.prodLine.getSubdivision(),!1,!1)||"?")},updateMaster:function(){this.updatePersonnel("master")},updateLeader:function(){this.updatePersonnel("leader")},updateOperator:function(){this.updatePersonnel("operator")},updatePersonnel:function(t){var i;if(!this.model.isLocked()){var r=this.model.get(t),o=r&&r.label?r.label:null;if(o){var n=o.match(/^(.*?) \(.*?\)$/);if(n&&(o=n[1]),"operator"===t){var s=this.model.get("operators");Array.isArray(s)&&s.length>1&&(o+=" +"+(s.length-1))}i=o+' <button class="btn btn-link">'+e("production","property:"+t+":change")+"</button>"}else i='<button class="btn btn-link">'+e("production","property:"+t+":noData:unlocked")+"</a>"}else i="?";this.$property(t).html(i)},$property:function(e){return this.$(".production-property-"+e+" .production-property-value")},showMasterPickerDialog:function(e){e&&(e.preventDefault(),e.target.blur()),t.currentDialog||this.showPickerDialog("master",this.model.changeMaster.bind(this.model))},showLeaderPickerDialog:function(e){e&&(e.preventDefault(),e.target.blur()),t.currentDialog||this.showPickerDialog("leader",this.model.changeLeader.bind(this.model))},showOperatorPickerDialog:function(e){e&&(e.preventDefault(),e.target.blur()),t.currentDialog||this.showMultiPickerDialog("operator",this.model.changeOperators.bind(this.model))},showPickerDialog:function(i,r){if(!this.model.isLocked()){var o=new s({type:i,embedded:this.options.embedded,vkb:this.options.vkb,model:this.model});this.listenTo(o,"userPicked",function(e){t.closeDialog();var o=this.model.get(i);null===o?null!==e&&r(e):(o!==e||e&&(e.id!==o.id||e.label!==o.label))&&r(e),this.$(".production-property-"+i+" .btn-link").focus()}),t.showDialog(o,e("production","personnelPicker:title:"+i))}},showMultiPickerDialog:function(i,r){if(!this.model.isLocked()){var o=new a({type:i,embedded:this.options.embedded,vkb:this.options.vkb,model:this.model});this.listenTo(o,"usersPicked",function(e){t.closeDialog(),r(e),this.$(".production-property-"+i+" .btn-link").focus()}),t.showDialog(o,e("production","multiPersonnelPicker:title:"+i))}},fillPersonnelData:function(){var e=[],t=[],i=this.model;["master","leader","operator"].forEach(function(r){var o=i.get(r);o&&null===o.id&&o.label.trim().length>0&&(e.push(o.label),t.push(r))}),e.length>0&&this.fillUserInfo(e,t)},fillUserInfo:function(e,t){if(r.isSyncing())return this.broker.subscribe("production.synced",this.fillPersonnelData.bind(this)).setLimit(1);var i=new n(null,{rqlQuery:{fields:{firstName:1,lastName:1,personellId:1},selector:{name:e.length>1?"in":"eq",args:["personellId",e.length>1?e:e[0]]}}}),o=this.model;this.promised(i.fetch()).then(function(){e.forEach(function(e,r){var n=i.findWhere({personellId:e});n&&o.set(t[r],{id:n.id,label:n.get("firstName")+" "+n.get("lastName")})})})}})});