// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/views/DialogView","app/data/prodLog","./NewOrderPickerView","./DowntimePickerView","./EndWorkDialogView","app/production/templates/data","app/production/templates/endDowntimeDialog","app/production/templates/continueOrderDialog"],function(t,e,o,i,r,n,d,s,a,c,p,h,u,l){return n.extend({template:h,localTopics:{"socket.connected":"fillOrderData"},events:{"click .production-newOrder":"newOrder","click .production-continueOrder":"continueOrder","click .production-startDowntime":"startDowntime","click .production-startBreak":"startBreak","click .production-endDowntime":"endDowntime","click .production-endWork":"endWork","click .production-property-orderNo .btn-link":"correctOrder","click .production-property-nc12 .btn-link":"correctOrder","click .production-property-quantityDone .btn-link":"showQuantityDoneEditor","click .production-property-workerCount .btn-link":"showWorkerCountEditor"},initialize:function(){this.onKeyDown=this.onKeyDown.bind(this),this.editorHiders=[],this.$actions=null,this.listenTo(this.model,"locked unlocked",function(){this.updateWorkerCount(),this.updateQuantityDone(),this.toggleActions()}),this.listenTo(this.model,"change:state",this.toggleActions);var o=this.model.prodShiftOrder;this.listenTo(o,"change:_id change:orderId change:operationNo",t.debounce(function(){this.updateOrderData(),this.updateOrderInfo(),this.updateWorkerCount(),this.updateTaktTime()},1)),this.listenTo(o,"change:quantityDone",this.updateQuantityDone),this.listenTo(o,"change:workerCount",t.debounce(function(){this.updateWorkerCount(),this.updateTaktTime()},1)),e("body").on("keydown",this.onKeyDown)},destroy:function(){e("body").off("keydown",this.onKeyDown),this.editorHiders=null,this.$actions=null},afterRender:function(){this.$actions=this.$(".production-actions"),this.updateOrderData(),this.updateOrderInfo(),this.updateQuantityDone(),this.toggleActions(),this.socket.isConnected()&&this.fillOrderData()},onKeyDown:function(t){27===t.keyCode&&this.hideEditors()},updateOrderInfo:function(){var t=this.model.prodShiftOrder;this.updateOrderNo(),this.updateNc12(),this.$property("productName").text(t.getProductName()),this.$property("operationName").text(t.getOperationName())},updateOrderData:function(){this.$el.toggleClass("has-order",this.model.hasOrder()),this.updateTaktTime(),this.updateWorkerCount(),this.$property("startedAt").text(this.model.prodShiftOrder.getStartedAt())},updateOrderNo:function(){var t=this.model.prodShiftOrder.getOrderNo();this.model.isLocked()||!this.model.hasOrder()||this.model.prodShiftOrder.isMechOrder()||(t+=' <button class="btn btn-link">'+o("production","property:orderNo:change")+"</button>"),this.$property("orderNo").html(t)},updateNc12:function(){var t=this.model.prodShiftOrder.getNc12();!this.model.isLocked()&&this.model.hasOrder()&&this.model.prodShiftOrder.isMechOrder()&&(t+=' <button class="btn btn-link">'+o("production","property:nc12:change")+"</button>"),this.$property("nc12").html(t)},updateWorkerCount:function(){this.$property("workerCountSap").text(this.model.prodShiftOrder.getWorkerCountSap());var t=this.model.prodShiftOrder.getWorkerCount(),e="";if(this.model.isIdle())e="-";else if(this.model.isLocked())e="number"==typeof t?t:"-";else{var i="property:workerCount:change:noData";t>0&&(i="property:workerCount:change:data",e+=t+" "),e+='<button class="btn btn-link">'+o("production",i)+"</button>"}this.$property("workerCount").html(e)},updateTaktTime:function(){this.$property("taktTime").text(this.model.prodShiftOrder.getTaktTime())},updateQuantityDone:function(){var t;this.model.isIdle()?t="-":(t=String(this.model.prodShiftOrder.getQuantityDone()),this.model.isLocked()||(t+=' <button class="btn btn-link">'+o("production","property:quantityDone:change")+"</button>")),this.$property("quantityDone").html(t)},toggleActions:function(){this.$actions.empty(),this.model.isLocked()||(this.model.isIdle()?this.toggleIdleActions():this.model.isWorking()?this.toggleWorkingActions():this.toggleDowntimeActions())},toggleIdleActions:function(){t.defer(function(t){t.appendAction("danger","startDowntime"),t.model.getDefaultAor()&&t.appendAction("danger","startBreak"),t.model.prodShiftOrder.hasOrderData()&&t.appendAction("success","continueOrder"),t.appendAction("success","newOrder")},this)},toggleWorkingActions:function(){this.appendAction("danger","startDowntime"),this.model.getDefaultAor()&&this.appendAction("danger","startBreak"),this.appendAction("success","newOrder"),this.appendAction("warning","endWork")},toggleDowntimeActions:function(){this.model.hasOrder()?(this.appendAction("success","endDowntime"),this.appendAction("warning","endWork")):this.appendAction("warning","endDowntime")},appendAction:function(t,e){var i=["btn","btn-"+t,"production-action","production-"+e],r=o("production","action:"+e);this.$actions.append('<button class="'+i.join(" ")+'">'+r+"</button>")},$property:function(t){return this.$(".production-property-"+t+" .production-property-value")},newOrder:function(t){t&&t.target.blur(),r.showDialog(new a({model:this.model}),o("production","newOrderPicker:title"+(this.model.hasOrder()?":replacing":"")))},continueOrder:function(t){t&&t.target.blur();var e=new d({dialogClassName:"production-modal",template:l});this.listenTo(e,"answered",function(t){"yes"===t&&this.model.continueOrder()}),r.showDialog(e,o("production","continueOrderDialog:title"))},correctOrder:function(t){t&&t.target.blur(),r.showDialog(new a({model:this.model,correctingOrder:!0}),o("production","newOrderPicker:title:correcting"))},startDowntime:function(e,n){var d=i.getMoment().toDate();e&&e.target.blur(),n||(n={}),n.model=t.defaults(n.model||{},{mode:"start",prodShift:this.model,startedAt:d,reason:null,aor:null,reasonComment:null});var s=new c(n);this.listenTo(s,"downtimePicked",function(t){r.closeDialog(),this.model.startDowntime(t)}),r.showDialog(s,o("production","downtimePicker:title:start"))},startBreak:function(t){this.startDowntime(t,{model:{prodShift:this.model,reason:this.model.getBreakReason(),aor:this.model.getDefaultAor()}})},endDowntime:function(t){t&&t.target.blur();var e=new d({dialogClassName:"production-modal",template:u,model:{yesSeverity:this.model.hasOrder()?"success":"warning"}});this.listenTo(e,"answered",function(t){"yes"===t&&this.model.endDowntime()}),r.showDialog(e,o("production","endDowntimeDialog:title"))},endWork:function(t){t&&t.target.blur(),r.showDialog(new p({model:this.model}),o("production","endWorkDialog:title"))},showEditor:function(o,i,r,n,d){function s(){p.editorHiders.splice(p.editorHiders.indexOf(s),1),u.remove()}function a(){var e=parseInt(u.val(),10);s(),!isNaN(e)&&e>=r&&n>=e&&p.model[d](e),t.defer(function(){o.find(".btn-link").focus()})}this.hideEditors();var c=o.find(".production-property-value"),p=this,h=e("<form></form>").submit(function(){return a(),!1}),u=e('<input class="form-control input-lg" type="number">').val(i).attr("min",r).attr("max",n).on("keydown",function(t){27===t.which&&setTimeout(s,1)}).css({position:"absolute",width:c.width()+"px"}).appendTo(h);h.appendTo(c),u.select(),this.editorHiders.push(s)},hideEditors:function(){this.editorHiders.forEach(function(t){t()}),this.editorHiders=[]},showQuantityDoneEditor:function(){this.showEditor(this.$(".production-property-quantityDone"),this.model.prodShiftOrder.getQuantityDone(),0,this.model.prodShiftOrder.getMaxQuantityDone(),"changeQuantityDone")},showWorkerCountEditor:function(){this.showEditor(this.$(".production-property-workerCount"),this.model.prodShiftOrder.getWorkerCountForEdit(),1,this.model.prodShiftOrder.getMaxWorkerCount(),"changeWorkerCount")},fillOrderData:function(){var e=this.model.prodShiftOrder.get("orderId"),o=this.model.prodShiftOrder.get("orderData");if(e&&(!o||t.isEmpty(o.operations))){if(s.isSyncing())return this.broker.subscribe("production.synced",this.fillOrderData.bind(this)).setLimit(1);this.fetchOrderData()}},fetchOrderData:function(){var t=this,o=this.model,i=o.prodShiftOrder.get("mechOrder")?"nc12":"no",r=o.prodShiftOrder.get("orderId"),n=e.ajax({type:"GET",url:"/production/orders?"+i+"="+encodeURIComponent(r)});this.promised(n).then(function(e){if(Array.isArray(e)&&e.length){var r=e[0];"no"===i?r.no=r._id:(r.nc12=r._id,r.no=null),delete r._id,o.prodShiftOrder.set("orderData",o.prodShiftOrder.prepareOperations(r)),o.saveLocalData(),t.updateOrderData(),t.updateOrderInfo()}})}})});