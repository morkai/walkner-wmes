define(["underscore","jquery","app/i18n","app/time","app/viewport","app/core/View","app/core/views/DialogView","app/data/prodLog","./NewOrderPickerView","./DowntimePickerView","./EndWorkDialogView","./OrderQueueView","./SnCheckerView","./PropertyEditorDialogView","app/production/templates/data","app/production/templates/endDowntimeDialog","app/production/templates/continueOrderDialog"],function(t,e,o,i,n,r,d,s,a,c,l,u,p,h,m,g,k){"use strict";return r.extend({template:m,localTopics:{"socket.connected":function(){this.toggleNextOrderAction(),this.fillOrderData()},"socket.disconnected":"toggleNextOrderAction"},events:{"click .production-newOrder":"newOrder","click .production-nextOrder":"nextOrder","click .production-continueOrder":"continueOrder","click .production-startDowntime":"startDowntime","click .production-startBreak":"startBreak","click .production-endDowntime":"endDowntime","click .production-endWork":"endWork","click #-orderNo":"correctOrder","click #-nc12":"correctOrder","click #-quantityDone":"showQuantityDoneEditor","click #-workerCount":"showWorkerCountEditor","click #-checkSn":function(){n.showDialog(new p({model:this.model}),o("production","taktTime:check:title"))}},initialize:function(){this.listenTo(this.model,"locked unlocked",function(){this.updateWorkerCount(),this.updateTotalQuantityDone(),this.updateQuantityDone(),this.toggleActions()}),this.listenTo(this.model,"change:state",this.toggleActions),this.listenTo(this.model,"newOrderRequested",function(t){this.newOrder(null,t)});var e=this.model.prodShiftOrder;this.listenTo(e,"change:_id change:orderId change:operationNo",t.debounce(function(){this.updateOrderData(),this.updateOrderInfo()},1)),this.listenTo(e,"change:totalQuantityDone change:orderData",t.debounce(function(){this.updateTotalQuantityDone()},1)),this.listenTo(e,"change:quantityDone",t.debounce(function(){this.updateQuantityDone(),this.updateTaktTime()},1)),this.listenTo(e,"change:workerCount",t.debounce(function(){this.updateTaktTime(),this.updateWorkerCount()},1)),this.listenTo(this.model.settings,"reset change",function(t){t&&!/taktTime/.test(t.id)||(this.updateQuantityDone(),this.updateTaktTime())})},destroy:function(){document.body.classList.remove("is-tt-ok","is-tt-nok")},afterRender:function(){this.$actions=this.$(".production-actions"),this.updateOrderData(),this.updateOrderInfo(),this.updateTotalQuantityDone(),this.updateQuantityDone(),this.toggleActions(),this.socket.isConnected()&&this.fillOrderData()},updateOrderInfo:function(){var t=this.model.prodShiftOrder;this.updateOrderNo(),this.updateNc12(),this.$property("productName").text(t.getProductName()),this.$property("operationName").text(t.getOperationName())},updateOrderData:function(){this.$el.toggleClass("has-order",this.model.hasOrder()),this.updateTaktTime(),this.updateWorkerCount(),this.$property("createdAt").text(this.model.prodShiftOrder.getStartedAt())},updateOrderNo:function(){var t=this.model.prodShiftOrder.getOrderNo();this.model.isLocked()||!this.model.hasOrder()||this.model.prodShiftOrder.isMechOrder()||(t+=' <button class="btn btn-link">'+o("production","property:orderNo:change")+"</button>"),this.$property("orderNo").html(t)},updateNc12:function(){var t=this.model.prodShiftOrder.getNc12();!this.model.isLocked()&&this.model.hasOrder()&&this.model.prodShiftOrder.isMechOrder()&&(t+=' <button class="btn btn-link">'+o("production","property:nc12:change")+"</button>"),this.$property("nc12").html(t)},updateWorkerCount:function(){this.$property("workerCountSap").text(this.model.prodShiftOrder.getWorkerCountSap());var t=this.model.prodShiftOrder.getWorkerCount(),e="";if(this.model.isIdle())e="-";else if(this.model.isLocked())e="number"==typeof t?t:"-";else{var i="property:workerCount:change:noData";t>0&&(i="property:workerCount:change:data",e+=t+" "),e+='<button class="btn btn-link">'+o("production",i)+"</button>"}this.$property("workerCount").html(e)},updateTaktTime:function(){var t=this.model,i=t.isTaktTimeEnabled(),n=t.settings.showLastTaktTime(),r=t.settings.showAvgTaktTime(),d=t.settings.showSapTaktTime(),s=t.settings.showSmiley(),a=t.prodShiftOrder,c=this.$property("lastTaktTime"),l=this.$property("avgTaktTime"),u=this.$property("taktTime"),p=a.getAvgTaktTime(),h=a.getLastTaktTime(),m=a.getSapTaktTime();i&&n&&h?c.parent().removeClass("is-tt-sap").addClass("is-tt-last"):c.parent().addClass("is-tt-sap").removeClass("is-tt-last");var g,k=!i||!n,f=!i||!r||!(a.get("quantityDone")>1&&p>0);if(u.text(m||"-").parent().toggleClass("hidden",!d),c.text(h||"-").parent().toggleClass("hidden",k).removeClass("is-ok is-nok").addClass(h<=m?"is-ok":"is-nok"),l.text(p||"-").parent().toggleClass("hidden",f).removeClass("is-ok is-nok").addClass(p<=m?"is-ok":"is-nok"),g=f?k?e("<div></div>"):c:l,s||g.append(' <button id="'+this.idPrefix+'-checkSn" class="btn btn-link">'+o("production","property:taktTime:checkSn")+"</button>"),document.body.classList.remove("is-tt-ok","is-tt-nok"),i&&m){var D=p?p<=m:h<=m;document.body.classList.add(D?"is-tt-ok":"is-tt-nok")}},updateTotalQuantityDone:function(){var t="",e=this.model,o=e.prodShiftOrder;if(e.isIdle())t="-";else{var i,n,r=o.getOperation(),d=o.get("totalQuantityDone")||{total:0,byOperation:{}};r?(i=r.qty,n=d.byOperation?d.byOperation[r.no]:-1):i=(o.get("orderData")||{}).qty||-1,t+=n>=0?n.toLocaleString():"?",t+="/",t+=i>=0?i.toLocaleString():"?"}this.$property("totalQuantityDone").html(t)},updateQuantityDone:function(){var t;this.model.isIdle()?t="-":(t=String(this.model.prodShiftOrder.getQuantityDone()),this.model.isLocked()||this.model.isTaktTimeEnabled()||(t+=' <button class="btn btn-link">'+o("production","property:quantityDone:change")+"</button>")),this.$property("quantityDone").html(t)},toggleActions:function(){this.$actions&&this.$actions.empty(),this.model.isLocked()||(this.model.isIdle()?this.toggleIdleActions():this.model.isWorking()?this.toggleWorkingActions():this.toggleDowntimeActions())},toggleIdleActions:function(){t.defer(function(t){t.model.prodShiftOrder.hasOrderData()&&t.appendAction("success","continueOrder"),t.appendAction("success","newOrder"),t.appendAction("success","nextOrder")},this)},toggleWorkingActions:function(){this.appendAction("danger","startDowntime"),this.model.getDefaultAor()&&this.appendAction("danger","startBreak"),this.appendAction("success","newOrder"),this.appendAction("success","nextOrder"),this.appendAction("warning","endWork"),this.toggleNextOrderAction()},toggleDowntimeActions:function(){this.model.hasOrder()?(this.appendAction("success","endDowntime"),this.appendAction("warning","endWork")):this.appendAction("warning","endDowntime")},appendAction:function(t,e){var i=["btn","btn-"+t,"production-action","production-"+e],n=o("production","action:"+e);this.$actions.append('<button class="'+i.join(" ")+'">'+n+"</button>")},$property:function(t){return this.$(".production-property-"+t+" .production-property-value")},newOrder:function(t,e){t&&t.target.blur(),n.currentDialog||n.showDialog(new a({model:this.model,embedded:this.options.embedded,vkb:this.options.vkb,order:e}),o("production","newOrderPicker:title"+(this.model.hasOrder()?":replacing":"")))},nextOrder:function(t){t&&t.target.blur(),n.currentDialog||n.showDialog(new u({model:this.model,embedded:this.options.embedded,vkb:this.options.vkb}),o("production","orderQueue:title"))},continueOrder:function(t){if(t&&t.target.blur(),!n.currentDialog){var e=new d({dialogClassName:"production-modal",template:k});this.listenTo(e,"answered",function(t){"yes"===t&&this.model.continueOrder()}),n.showDialog(e,o("production","continueOrderDialog:title"))}},correctOrder:function(t){t&&t.target.blur(),n.currentDialog||this.model.isLocked()||"idle"===this.model.get("state")||n.showDialog(new a({model:this.model,correctingOrder:!0,embedded:this.options.embedded,vkb:this.options.vkb}),o("production","newOrderPicker:title:correcting"))},startDowntime:function(e,r){if(e&&e.target.blur(),!n.currentDialog){r||(r={}),r.embedded=this.options.embedded,r.vkb=this.options.vkb,r.model=t.defaults(r.model||{},{mode:"start",prodShift:this.model,startedAt:i.getMoment().toDate(),reason:null,aor:null,reasonComment:null});var d=new c(r);this.listenTo(d,"downtimePicked",function(t){n.closeDialog(),this.model.startDowntime(t)}),n.showDialog(d,o("production","downtimePicker:title:start"))}},startBreak:function(t){this.startDowntime(t,{model:{prodShift:this.model,reason:this.model.getBreakReason(),aor:this.model.getDefaultAor()}})},endDowntime:function(t){if(t&&t.target.blur(),!n.currentDialog){var e=new d({dialogClassName:"production-modal",template:g,model:{yesSeverity:this.model.hasOrder()?"success":"warning"}});this.listenTo(e,"answered",function(t){"yes"===t&&this.model.endDowntime()}),n.showDialog(e,o("production","endDowntimeDialog:title"))}},endWork:function(t){t&&t.target.blur(),n.currentDialog||n.showDialog(new l({model:this.model,embedded:this.options.embedded,vkb:this.options.vkb}),o("production","endWorkDialog:title"))},showEditor:function(o,i,n,r,d){if(o.find(".btn").length&&!this.model.isLocked()){var s=o.find(".production-property-value"),a=this,c=e("<form></form>").submit(function(){return p(),!1}),l=e('<input class="form-control input-lg" type="number">').val(i).attr("min",n).attr("max",r).on("keydown",function(e){27===e.which&&t.defer(u)}).css({position:"absolute",width:s.width()+"px"}).appendTo(c);c.appendTo(s),t.defer(function(){l.select().on("blur",function(){t.defer(p)})})}function u(){c.remove()}function p(){var t=parseInt(l.val(),10);u(),!isNaN(t)&&t>=n&&t<=r&&a.model[d](t)}},showQuantityDoneEditor:function(){var t=this,e=t.model.prodShiftOrder;if(!t.model.isTaktTimeEnabled())return t.options.embedded?n.showDialog(new h({model:t.model,vkb:t.options.vkb,property:"quantityDone",value:e.getQuantityDone(),max:e.getMaxQuantityDone(),getValue:function(){return e.get("quantityDone")||0},setValue:function(e){t.model.changeQuantityDone(e)}}),o("production","propertyEditorDialog:title:quantityDone")):void t.showEditor(t.$(".production-property-quantityDone"),e.getQuantityDone(),0,e.getMaxQuantityDone(),"changeQuantityDone")},showWorkerCountEditor:function(){var t=this,e=t.model.prodShiftOrder;if(t.options.embedded)return n.showDialog(new h({model:t.model,vkb:t.options.vkb,property:"workerCount",value:e.getWorkerCountForEdit(),min:1,max:e.getMaxWorkerCount(),getValue:function(){return e.get("workerCount")||0},setValue:function(e){t.model.changeWorkerCount(e)}}),o("production","propertyEditorDialog:title:workerCount"));this.showEditor(t.$(".production-property-workerCount"),e.getWorkerCountForEdit(),1,e.getMaxWorkerCount(),"changeWorkerCount")},fillOrderData:function(){var e=this.model.prodShiftOrder.get("orderId"),o=this.model.prodShiftOrder.get("orderData");if(e&&(!o||t.isEmpty(o.operations))){if(s.isSyncing())return this.broker.subscribe("production.synced",this.fillOrderData.bind(this)).setLimit(1);this.fetchOrderData()}},fetchOrderData:function(){var t=this,o=this.model,i=o.prodShiftOrder.get("mechOrder")?"nc12":"no",n=o.prodShiftOrder.get("orderId"),r=e.ajax({type:"GET",url:"/production/orders?"+i+"="+encodeURIComponent(n)});this.promised(r).then(function(e){if(Array.isArray(e)&&e.length){var n=e[0];"no"===i?n.no=n._id:(n.nc12=n._id,n.no=null),delete n._id,o.prodShiftOrder.set("orderData",o.prodShiftOrder.prepareOperations(n)),o.saveLocalData(),t.updateOrderData(),t.updateOrderInfo()}})},toggleNextOrderAction:function(){this.$(".production-nextOrder").toggleClass("hidden",!this.socket.isConnected())}})});