// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/core/View","app/data/localStorage","app/data/isaPalletKinds","app/production/templates/isaPalletDeliveryDialog"],function(i,t,e,a,n){"use strict";var d="PRODUCTION:ISA:LAST_DELIVERY";return t.extend({template:n,dialogClassName:"production-modal",events:{"input #-qty":"checkQtyValidity","click .btn[data-id]":function(i){this.$id("palletKind").find(".active").removeClass("active"),this.$(i.currentTarget).addClass("active").blur(),this.toggleSubmit()},submit:function(i){i.preventDefault();var t=this.$id("palletKind").find(".active").attr("data-id"),a=+this.$id("qty").val();e.setItem(d,JSON.stringify({palletKind:t,qty:a})),this.trigger("picked",t,a)}},destroy:function(){this.options.vkb&&this.options.vkb.hide()},serialize:function(){return{idPrefix:this.idPrefix,palletKinds:a.map(function(i){return{id:i.id,text:i.get("fullName")}})}},afterRender:function(){this.options.embedded&&this.options.vkb.show(this.$id("qty").addClass("is-embedded")[0],this.onVkbValueChange.bind(this));var i=JSON.parse(e.getItem(d)||"{}");this.$id("qty").val(i.qty||8),this.$id("palletKind").find('.btn[data-id="'+i.palletKind+'"]').click(),this.checkQtyValidity()},toggleSubmit:function(){this.$id("submit").prop("disabled",!this.$id("palletKind").find(".active").length)},checkQtyValidity:function(){var t=this.$id("qty"),e=t.val().replace(/[^0-9]+/g,"")||0,a=1,n=9,d="";e<a?d=i("production","error:min",{min:a}):e>n&&(d=i("production","error:max",{max:n})),t.val(e||"")[0].setCustomValidity(d),this.toggleSubmit()},onVkbValueChange:function(){this.checkQtyValidity()},onDialogShown:function(i){this.closeDialog=i.closeDialog.bind(i),this.$id("qty").focus()},closeDialog:function(){}})});