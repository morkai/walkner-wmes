define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/orders/util/resolveProductName","../util/orderPickerHelpers","app/production/templates/orderQueue","app/production/templates/orderQueueRow"],function(e,t,o,i,r,s,n,d,a){"use strict";return r.extend({template:d,dialogClassName:"production-modal production-orderQueueDialog",localTopics:{"socket.disconnected":"closeDialog"},events:{"click #-enqueue":function(){var e=this.$id("order"),t=this.$id("operation"),o=e.select2("data"),r=t.val();o?r?(this.addRow(n.prepareOrderInfo(this.model,o),r),t.hasClass("form-control")?t.val(""):t.select2("val","",!0),e.select2("val","",!0).select2("focus"),i.adjustDialogBackdrop()):t.focus():e.focus()},"click #-clear":function(){this.$id("rows").empty(),this.$id("queue").addClass("hidden"),this.$id("empty").html(o("production","orderQueue:message:empty")),i.adjustDialogBackdrop()},'click .btn[data-action="remove"]':function(e){this.$(e.target).closest("tr").remove(),this.$id("rows").children().length||(this.$id("queue").addClass("hidden"),this.$id("empty").html(o("production","orderQueue:message:empty"))),i.adjustDialogBackdrop()},'click .btn[data-action="moveDown"]':function(e){var t=this.$id("rows").children(),o=this.$(e.target).closest("tr"),i=o.next();1!==t.length&&(i.length?o.insertAfter(i):o.insertBefore(t.first()),this.recountRows())},'click .btn[data-action="moveUp"]':function(e){var t=this.$id("rows").children(),o=this.$(e.target).closest("tr"),i=o.prev();1!==t.length&&(i.length?o.insertBefore(i):o.insertAfter(t.last()),this.recountRows())},"click #-submit":function(){var e=this.orderCache,t=[];this.$("tr[data-order]").each(function(){t.push({order:e[this.dataset.order],operationNo:this.dataset.operation})}),this.model.setNextOrder(t),this.closeDialog()}},initialize:function(){this.orderCache={}},afterRender:function(){e.forEach(this.model.getNextOrders(),function(e){this.addRow(e.order,e.operationNo)},this),this.setUpOrderSelect2(),this.setUpOperationSelect2(),this.focusFirstInput(),i.adjustDialogBackdrop()},addRow:function(e,t){this.orderCache[e.no]=e,delete e.bom,delete e.documents,delete e.statusesSetAt;var i=this.$id("rows");i.append(a({no:i[0].childElementCount+1,order:e,operation:e.operations[t]||{no:t},productName:s(e)})),this.$id("empty").html(o("production","orderQueue:message:queue")),this.$id("queue").removeClass("hidden")},recountRows:function(){this.$id("rows").children().each(function(e){this.children[0].textContent=e+1+"."})},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.focusFirstInput()},closeDialog:function(){},focusFirstInput:function(){this.$id("order").select2("focus")},setUpOrderSelect2:function(){n.setUpOrderSelect2(this.$id("order"),this.$id("operation"),this.model,{dropdownCssClass:"production-dropdown",allowClear:!0})},setUpOperationSelect2:function(){n.setUpOperationSelect2(this.$id("operation"),[],{dropdownCssClass:"production-dropdown"})}})});