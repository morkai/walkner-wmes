// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/viewport","app/core/View","../util/orderPickerHelpers","app/production/templates/newOrderPicker"],function(e,t,i,r,o,s){"use strict";return r.extend({template:s,dialogClassName:function(){var e="production-modal production-newOrderPickerDialog";return this.options.correctingOrder?e+=" is-correcting":this.model.hasOrder()&&(e+=" is-replacing"),e},localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){if(13===e.which)return this.$el.submit(),!1},submit:function(e){e.preventDefault();var i=this.$id("submit")[0];if(!i.disabled){i.disabled=!0;var r=this.$id("spigot-nc12");if(r.length){var o=r.val().match(/([0-9]{12})/),s=o?o[1]:"";if(!s.length||!this.model.checkSpigot(null,s))return r[0].setCustomValidity(t("production","newOrderPicker:spigot:invalid")),void(this.timers.submit=setTimeout(function(){i.disabled=!1,i.click()},1,this))}this.socket.isConnected()?this.handleOnlinePick(i):this.handleOfflinePick(i)}}},initialize:function(){this.lastKeyPressAt=0,e(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("keypress."+this.idPrefix,this.onKeyPress.bind(this))},destroy:function(){e(window).off("."+this.idPrefix)},serialize:function(){var e=this.model,t=e.prodShiftOrder;return{idPrefix:this.idPrefix,spigot:e.settings.getValue("spigotFinish")&&!!t.get("spigot"),offline:!this.socket.isConnected(),replacingOrder:!this.options.correctingOrder&&e.hasOrder(),correctingOrder:!!this.options.correctingOrder,quantityDone:t.get("quantityDone")||0,workerCount:t.getWorkerCountForEdit(),orderIdType:e.getOrderIdType(),maxQuantityDone:t.getMaxQuantityDone(),maxWorkerCount:t.getMaxWorkerCount()}},afterRender:function(){this.socket.isConnected()?(this.setUpOrderSelect2(),this.setUpOperationSelect2(),this.options.correctingOrder&&this.selectCurrentOrder()):this.options.correctingOrder&&(this.$id("order").val(this.model.prodShiftOrder.get("orderId")),this.$id("operation").val(this.model.prodShiftOrder.get("operationNo"))),this.focusFirstInput()},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.focusFirstInput()},closeDialog:function(){},focusFirstInput:function(){var e=this.$id("spigot-nc12");e.length?e.focus():!this.options.correctingOrder&&this.model.hasOrder()?this.$id("quantityDone").select():this.socket.isConnected()?this.$id("order").select2("focus"):this.$id("order").select()},setUpOrderSelect2:function(){o.setUpOrderSelect2(this.$id("order"),this.$id("operation"),this.model,{dropdownCssClass:"production-dropdown"})},setUpOperationSelect2:function(){o.setUpOperationSelect2(this.$id("operation"),[],{dropdownCssClass:"production-dropdown"})},selectCurrentOrder:function(){o.selectOrder(this.$id("order"),this.model.prodShiftOrder)},handleOnlinePick:function(e){var r=this.$id("order").select2("data"),s=this.$id("operation"),n=s.hasClass("form-control")?s.val():this.$id("operation").select2("val");return r?n?(r.sameOrder?r=this.model.prodShiftOrder.get("orderData"):o.prepareOrderInfo(this.model,r),void this.pickOrder(r,n)):(s.focus(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production","newOrderPicker:msg:emptyOperation")})):(this.$id("order").select2("focus"),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production","newOrderPicker:msg:emptyOrder")}))},handleOfflinePick:function(e){var r=this.model.getOrderIdType(),o={no:null,nc12:null},s=this.$id("order").val().trim().replace(/[^a-zA-Z0-9]+/g,""),n=this.$id("operation").val().trim().replace(/[^0-9]+/g,"");if("no"===r&&/^[0-9]{9,}$/.test(s))o.no=s;else{if("nc12"!==r||!(12===s.length||s.length<9&&/^[a-zA-Z]+[a-zA-Z0-9]*$/.test(s)))return this.$id("order").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production",""===s?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOrderId:"+r)});o.nc12=s}return/^[0-9]{1,4}$/.test(n)?void this.pickOrder(o,n):(this.$id("operation").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production",""===s?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOperationNo")}))},pickOrder:function(e,t){for(;t.length<4;)t="0"+t;!this.options.correctingOrder&&this.model.hasOrder()&&(this.model.changeQuantityDone(this.parseInt("quantityDone")),this.model.changeWorkerCount(this.parseInt("workerCount"))),this.options.correctingOrder?this.model.correctOrder(e,t):this.model.changeOrder(e,t),this.closeDialog()},parseInt:function(e){var t=parseInt(this.$id(e).val(),10);return isNaN(t)||t<0?0:t},isIgnoredTarget:function(e){return"number"===e.type||e.className.indexOf("select2")!==-1||"1"===e.dataset.ignoreKey},onKeyDown:function(e){if(8===e.keyCode&&!this.isIgnoredTarget(e.target))return this.lastKeyPressAt=Date.now(),this.$id("spigot-nc12").val("")[0].setCustomValidity(""),!1},onKeyPress:function(e){var t=this.$id("spigot-nc12"),i=e.target,r=e.keyCode;if(13===r)return t[0]!==i;if(!(r<32||r>126||this.isIgnoredTarget(i))){var o=Date.now(),s=o-this.lastKeyPressAt>333?"":t.val(),n=String.fromCharCode(r);return t.val(s+n)[0].setCustomValidity(""),t.focus(),this.lastKeyPressAt=o,!1}}})});