// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/viewport","app/core/View","../util/orderPickerHelpers","app/production/templates/newOrderPicker"],function(e,r,t,i,o,n,s){return o.extend({template:s,dialogClassName:function(){var e="production-modal production-newOrderPickerDialog";return this.options.correctingOrder?e+=" is-correcting":this.model.hasOrder()&&(e+=" is-replacing"),e},localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){13===e.which&&(this.$el.submit(),e.preventDefault())},submit:function(e){e.preventDefault();var r=this.$("button[type=submit]")[0];r.disabled||(r.disabled=!0,this.socket.isConnected()?this.handleOnlinePick(r):this.handleOfflinePick(r))}},initialize:function(){this.idPrefix=e.uniqueId("newOrderPicker")},destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},serialize:function(){return{idPrefix:this.idPrefix,offline:!this.socket.isConnected(),replacingOrder:!this.options.correctingOrder&&this.model.hasOrder(),correctingOrder:!!this.options.correctingOrder,quantityDone:this.model.prodShiftOrder.get("quantityDone")||0,workerCount:this.model.prodShiftOrder.getWorkerCountForEdit(),orderIdType:this.model.getOrderIdType(),maxQuantityDone:this.model.prodShiftOrder.getMaxQuantityDone(),maxWorkerCount:this.model.prodShiftOrder.getMaxWorkerCount()}},afterRender:function(){this.socket.isConnected()?(this.setUpOrderSelect2(),this.setUpOperationSelect2(),this.options.correctingOrder&&this.selectCurrentOrder()):this.options.correctingOrder&&(this.$id("order").val(this.model.prodShiftOrder.get("orderId")),this.$id("operation").val(this.model.prodShiftOrder.get("operationNo"))),this.focusFirstInput()},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.focusFirstInput()},closeDialog:function(){},focusFirstInput:function(){!this.options.correctingOrder&&this.model.hasOrder()?this.$id("quantityDone").select():this.socket.isConnected()?this.$id("order").select2("focus"):this.$id("order").select()},setUpOrderSelect2:function(){n.setUpOrderSelect2(this.$id("order").removeClass("form-control"),this.$id("operation"),this.model,{dropdownCssClass:"production-dropdown"})},setUpOperationSelect2:function(){var e=this.$id("operation").attr("placeholder",null).removeClass("form-control");n.setUpOperationSelect2(e,[],{dropdownCssClass:"production-dropdown"})},selectCurrentOrder:function(){n.selectOrder(this.$id("order"),this.model.prodShiftOrder)},handleOnlinePick:function(e){var r=this.$id("order").select2("data"),o=this.$id("operation").select2("val");return r?o?(r.sameOrder?r=this.model.prodShiftOrder.get("orderData"):n.prepareOrderInfo(this.model,r),void this.pickOrder(r,o)):(this.$id("order").select2("focus"),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production","newOrderPicker:msg:emptyOperation")})):(this.$id("order").select2("focus"),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production","newOrderPicker:msg:emptyOrder")}))},handleOfflinePick:function(e){var r=this.model.getOrderIdType(),o={no:null,nc12:null},n=this.$id("order").val().trim().replace(/[^a-zA-Z0-9]+/g,""),s=this.$id("operation").val().trim().replace(/[^0-9]+/g,"");if("no"===r&&/^[0-9]{9,}$/.test(n))o.no=n;else{if("nc12"!==r||!(12===n.length||n.length<9&&/^[a-zA-Z]+[a-zA-Z0-9]*$/.test(n)))return this.$id("order").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production",""===n?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOrderId:"+r)});o.nc12=n}if(!/^[0-9]{1,4}$/.test(s))return this.$id("operation").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:t("production",""===n?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOperationNo")});for(;s.length<4;)s="0"+s;this.pickOrder(o,s)},pickOrder:function(e,r){!this.options.correctingOrder&&this.model.hasOrder()&&(this.model.changeQuantityDone(this.parseInt("quantityDone")),this.model.changeWorkerCount(this.parseInt("workerCount"))),this.options.correctingOrder?this.model.correctOrder(e,r):this.model.changeOrder(e,r),this.closeDialog()},parseInt:function(e){var r=parseInt(this.$id(e).val(),10);return isNaN(r)||0>r?0:r}})});