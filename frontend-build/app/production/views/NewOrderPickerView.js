define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/production/templates/newOrderPicker"],function(e,t,n,r,i,o){return i.extend({template:o,localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){13===e.which&&(this.$el.submit(),e.preventDefault())},submit:function(e){e.preventDefault(),this.socket.isConnected()?this.handleOnlinePick():this.handleOfflinePick()}},initialize:function(){this.idPrefix=e.uniqueId("newOrderPicker")},serialize:function(){return{idPrefix:this.idPrefix,offline:!this.socket.isConnected(),replacingOrder:this.model.hasOrder(),quantityDone:this.model.prodShiftOrder.get("quantityDone")||0,workerCount:this.model.prodShiftOrder.get("workerCount")||0}},afterRender:function(){this.socket.isConnected()&&(this.setUpOrderSelect2(),this.setUpOperationSelect2()),this.focusFirstInput()},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.focusFirstInput()},closeDialog:function(){},focusFirstInput:function(){this.model.hasOrder()?this.$id("quantityDone").select():this.socket.isConnected()?this.$id("order").select2("focus"):this.$id("order").select()},setUpOrderSelect2:function(){var i=this,o=this.$id("order").removeClass("form-control");o.select2({dropdownCssClass:"production-dropdown",openOnEnter:null,allowClear:!0,minimumInputLength:3,ajax:{cache:!0,quietMillis:500,url:this.getOrdersUrl.bind(this),results:function(e){return{results:(Array.isArray(e)?e:[]).map(function(e){return e.id=e._id,e.text=e._id+" - "+(e.name||"?"),e})}},transport:function(e){return t.ajax.apply(t,arguments).fail(function(){r.msg.show({type:"error",time:2e3,text:n("production","newOrderPicker:msg:searchFailure")}),e.success({collection:[]})})}}}),o.on("change",function(t){var n=t.added&&Array.isArray(t.added.operations)?t.added.operations:[],r=i.setUpOperationSelect2(n.map(function(e){return{id:e.no,text:e.no+" - "+e.name}}));n.length?r.select2("val",n[0].no).select2("focus"):e.defer(function(){o.select2("focus")})})},getOrdersUrl:function(e){var t=/^114[0-9]{0,6}/.test(e)?"no":"nc12";return this.$id("order").attr("data-type",t),"/production/orders?"+t+"="+encodeURIComponent(e)},setUpOperationSelect2:function(e){var t=this.$id("operation").attr("placeholder",null).removeClass("form-control");return t.select2({dropdownCssClass:"production-dropdown",placeholder:n("production","newOrderPicker:online:operation:placeholder"),openOnEnter:null,allowClear:!1,data:e||[]}),t},handleOnlinePick:function(){var e=this.$id("order").select2("data"),t=this.$id("operation").select2("val");return e?t?(delete e.__v,delete e.id,delete e.text,/^114[0-9]{6}$/.test(e._id)?e.no=e._id:(e.no=null,e.nc12=e._id),delete e._id,this.pickOrder(e,t),void 0):(this.$id("order").select2("focus"),r.msg.show({type:"error",time:2e3,text:n("production","newOrderPicker:msg:emptyOperation")})):(this.$id("order").select2("focus"),r.msg.show({type:"error",time:2e3,text:n("production","newOrderPicker:msg:emptyOrder")}))},handleOfflinePick:function(){var e={no:null,nc12:null},t=this.$id("order").val().trim().replace(/[^a-zA-Z0-9]+/g,""),i=this.$id("operation").val().trim().replace(/[^0-9]+/g,"");if(/^114[0-9]{6}$/.test(t))e.no=t;else{if(!(12===t.length||t.length<9&&/^[a-zA-Z]+[a-zA-Z0-9]*$/.test(t)))return this.$id("order").select(),r.msg.show({type:"error",time:2e3,text:n("production",""===t?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOrderOrNc12")});e.nc12=t}if(!/^[0-9]{1,4}$/.test(i))return this.$id("operation").select(),r.msg.show({type:"error",time:2e3,text:n("production",""===t?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOperationNo")});for(;i.length<4;)i="0"+i;this.pickOrder(e,i)},pickOrder:function(e,t){if(this.model.hasOrder()){var n=this.parseInt("quantityDone"),r=this.parseInt("workerCount");n!==this.model.prodShiftOrder.get("quantityDone")&&this.model.changeQuantityDone(n),r!==this.model.prodShiftOrder.get("workerCount")&&this.model.changeWorkerCount(r)}this.model.changeOrder(e,t),this.closeDialog()},parseInt:function(e){var t=parseInt(this.$id(e).val(),10);return isNaN(t)||0>t?0:t}})});