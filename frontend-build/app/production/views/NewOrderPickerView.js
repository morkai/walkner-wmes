// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","app/core/View","../util/orderPickerHelpers","app/production/templates/newOrderPicker"],function(e,t,r,i,o,s,n){"use strict";return o.extend({template:n,dialogClassName:function(){var e="production-modal production-newOrderPickerDialog";return this.options.correctingOrder?e+=" is-correcting":this.model.hasOrder()&&(e+=" is-replacing"),e},localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){return 13===e.which?(this.$el.submit(),!1):void 0},submit:function(e){e.preventDefault();var t=this.$id("submit")[0];if(!t.disabled){t.disabled=!0;var i=this.$id("spigot-nc12");if(i.length){var o=i.val().match(/([0-9]{12})/),s=o?o[1]:"";if(!s.length||!this.model.checkSpigot(null,s))return i[0].setCustomValidity(r("production","newOrderPicker:spigot:invalid")),void(this.timers.submit=setTimeout(function(){t.disabled=!1,t.click()},1,this))}this.socket.isConnected()?this.handleOnlinePick(t):this.handleOfflinePick(t)}}},initialize:function(){this.lastKeyPressAt=0,t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this)).on("keypress."+this.idPrefix,this.onKeyPress.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},serialize:function(){var e=this.model,t=e.prodShiftOrder;return{idPrefix:this.idPrefix,spigot:e.settings.getValue("spigotFinish")&&!!t.get("spigot"),offline:!this.socket.isConnected(),replacingOrder:!this.options.correctingOrder&&e.hasOrder(),correctingOrder:!!this.options.correctingOrder,quantityDone:t.get("quantityDone")||0,workerCount:t.getWorkerCountForEdit(),orderIdType:e.getOrderIdType(),maxQuantityDone:t.getMaxQuantityDone(),maxWorkerCount:t.getMaxWorkerCount()}},afterRender:function(){this.socket.isConnected()?(this.setUpOrderSelect2(),this.setUpOperationSelect2(),this.options.correctingOrder?this.selectCurrentOrder():this.selectNextOrder()):this.options.correctingOrder&&(this.$id("order").val(this.model.prodShiftOrder.get("orderId")),this.$id("operation").val(this.model.prodShiftOrder.get("operationNo"))),this.focusFirstInput()},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.focusFirstInput()},closeDialog:function(){},focusFirstInput:function(){var e=this.$id("spigot-nc12");e.length?e.focus():!this.options.correctingOrder&&this.model.hasOrder()?this.$id("quantityDone").select():this.socket.isConnected()?this.$id("order").select2("focus"):this.$id("order").select()},setUpOrderSelect2:function(){s.setUpOrderSelect2(this.$id("order"),this.$id("operation"),this.model,{dropdownCssClass:"production-dropdown"})},setUpOperationSelect2:function(){s.setUpOperationSelect2(this.$id("operation"),[],{dropdownCssClass:"production-dropdown"})},selectCurrentOrder:function(){s.selectOrder(this.$id("order"),this.model.prodShiftOrder)},selectNextOrder:function(){var t=this.model.get("nextOrder");if(!e.isEmpty(t)){var r=t[0],i=r.order,o=this.$id("order");o.select2("data",e.assign({},i,{id:i.no,text:i.no+" - "+(i.description||i.name||"?"),sameOrder:!1})),o.trigger({type:"change",operations:e.values(i.operations),selectedOperationNo:r.operationNo})}},handleOnlinePick:function(e){var t=this.$id("order").select2("data"),o=this.$id("operation"),n=o.hasClass("form-control")?o.val():this.$id("operation").select2("val");return t?n?(t.sameOrder?t=this.model.prodShiftOrder.get("orderData"):s.prepareOrderInfo(this.model,t),void this.pickOrder(t,n)):(o.focus(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production","newOrderPicker:msg:emptyOperation")})):(this.$id("order").select2("focus"),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production","newOrderPicker:msg:emptyOrder")}))},handleOfflinePick:function(e){var t=this.model.getOrderIdType(),o={no:null,nc12:null},s=this.$id("order").val().trim().replace(/[^a-zA-Z0-9]+/g,""),n=this.$id("operation").val().trim().replace(/[^0-9]+/g,"");if("no"===t&&/^[0-9]{9,}$/.test(s))o.no=s;else{if("nc12"!==t||!(12===s.length||s.length<9&&/^[a-zA-Z]+[a-zA-Z0-9]*$/.test(s)))return this.$id("order").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production",""===s?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOrderId:"+t)});o.nc12=s}return/^[0-9]{1,4}$/.test(n)?void this.pickOrder(o,n):(this.$id("operation").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production",""===s?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOperationNo")}))},pickOrder:function(e,t){for(;t.length<4;)t="0"+t;!this.options.correctingOrder&&this.model.hasOrder()&&(this.model.changeQuantityDone(this.parseInt("quantityDone")),this.model.changeWorkerCount(this.parseInt("workerCount"))),this.options.correctingOrder?this.model.correctOrder(e,t):this.model.changeOrder(e,t),this.closeDialog()},parseInt:function(e){var t=parseInt(this.$id(e).val(),10);return isNaN(t)||0>t?0:t},isIgnoredTarget:function(e){return"number"===e.type||-1!==e.className.indexOf("select2")||"1"===e.dataset.ignoreKey},onKeyDown:function(e){return 8!==e.keyCode||this.isIgnoredTarget(e.target)?void 0:(this.lastKeyPressAt=Date.now(),this.$id("spigot-nc12").val("")[0].setCustomValidity(""),!1)},onKeyPress:function(e){var t=this.$id("spigot-nc12"),r=e.target,i=e.keyCode;if(13===i)return t[0]!==r;if(!(32>i||i>126||this.isIgnoredTarget(r))){var o=Date.now(),s=o-this.lastKeyPressAt>333?"":t.val(),n=String.fromCharCode(i);return t.val(s+n)[0].setCustomValidity(""),t.focus(),this.lastKeyPressAt=o,!1}}})});