define(["underscore","jquery","app/i18n","app/viewport","app/core/View","app/production/templates/newOrderPicker"],function(e,t,r,i,n,o){return n.extend({template:o,localTopics:{"socket.connected":"render","socket.disconnected":"render"},events:{"keypress .select2-container":function(e){13===e.which&&(this.$el.submit(),e.preventDefault())},submit:function(e){e.preventDefault();var t=this.$(".btn-success")[0];t.disabled||(t.disabled=!0,this.socket.isConnected()?this.handleOnlinePick(t):this.handleOfflinePick(t))}},initialize:function(){this.idPrefix=e.uniqueId("newOrderPicker")},serialize:function(){return{idPrefix:this.idPrefix,offline:!this.socket.isConnected(),replacingOrder:this.model.hasOrder(),quantityDone:this.model.prodShiftOrder.get("quantityDone")||0,workerCount:this.model.prodShiftOrder.get("workerCount")||0,orderIdType:this.model.getOrderIdType(),maxQuantityDone:this.model.prodShiftOrder.getMaxQuantityDone(),maxWorkerCount:this.model.prodShiftOrder.getMaxWorkerCount()}},afterRender:function(){this.socket.isConnected()&&(this.setUpOrderSelect2(),this.setUpOperationSelect2()),this.focusFirstInput()},onDialogShown:function(e){this.closeDialog=e.closeDialog.bind(e),this.focusFirstInput()},closeDialog:function(){},focusFirstInput:function(){this.model.hasOrder()?this.$id("quantityDone").select():this.socket.isConnected()?this.$id("order").select2("focus"):this.$id("order").select()},setUpOrderSelect2:function(){var n=this,o=this.$id("order").removeClass("form-control");o.select2({dropdownCssClass:"production-dropdown",openOnEnter:null,allowClear:!0,minimumInputLength:3,ajax:{cache:!0,quietMillis:500,url:this.getOrdersUrl.bind(this),results:function(e){return{results:(Array.isArray(e)?e:[]).map(function(e){return e.id=e._id,e.text=e._id+" - "+(e.name||"?"),e})}},transport:function(e){return t.ajax.apply(t,arguments).fail(function(){i.msg.show({type:"error",time:2e3,text:r("production","newOrderPicker:msg:searchFailure")}),e.success({collection:[]})})}}}),o.on("change",function(t){var r=t.added&&Array.isArray(t.added.operations)?t.added.operations:[],i=n.setUpOperationSelect2(r.map(function(e){return{id:e.no,text:e.no+" - "+e.name}}));r.length?i.select2("val",r[0].no).select2("focus"):e.defer(function(){o.select2("focus")})})},getOrdersUrl:function(e){var t=this.model.getOrderIdType();return this.$id("order").attr("data-type",t),"/production/orders?"+t+"="+encodeURIComponent(e)},setUpOperationSelect2:function(e){var t=this.$id("operation").attr("placeholder",null).removeClass("form-control");return t.select2({dropdownCssClass:"production-dropdown",placeholder:r("production","newOrderPicker:online:operation:placeholder"),openOnEnter:null,allowClear:!1,data:e||[]}),t},handleOnlinePick:function(e){var t=this.$id("order").select2("data"),n=this.$id("operation").select2("val");return t?n?(delete t.__v,delete t.id,delete t.text,/^114[0-9]{6}$/.test(t._id)?t.no=t._id:(t.no=null,t.nc12=t._id),delete t._id,this.pickOrder(t,n),void 0):(this.$id("order").select2("focus"),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production","newOrderPicker:msg:emptyOperation")})):(this.$id("order").select2("focus"),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production","newOrderPicker:msg:emptyOrder")}))},handleOfflinePick:function(e){var t=this.model.getOrderIdType(),n={no:null,nc12:null},o=this.$id("order").val().trim().replace(/[^a-zA-Z0-9]+/g,""),s=this.$id("operation").val().trim().replace(/[^0-9]+/g,"");if("no"===t&&/^114[0-9]{6}$/.test(o))n.no=o;else{if("nc12"!==t||!(12===o.length||o.length<9&&/^[a-zA-Z]+[a-zA-Z0-9]*$/.test(o)))return this.$id("order").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production",""===o?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOrderId:"+t)});n.nc12=o}if(!/^[0-9]{1,4}$/.test(s))return this.$id("operation").select(),e.disabled=!1,i.msg.show({type:"error",time:2e3,text:r("production",""===o?"newOrderPicker:msg:emptyOrder":"newOrderPicker:msg:invalidOperationNo")});for(;s.length<4;)s="0"+s;this.pickOrder(n,s)},pickOrder:function(e,t){if(this.model.hasOrder()){var r=this.parseInt("quantityDone"),i=this.parseInt("workerCount");r!==this.model.prodShiftOrder.get("quantityDone")&&this.model.changeQuantityDone(r),i!==this.model.prodShiftOrder.get("workerCount")&&this.model.changeWorkerCount(i)}this.model.changeOrder(e,t),this.closeDialog()},parseInt:function(e){var t=parseInt(this.$id(e).val(),10);return isNaN(t)||0>t?0:t}})});