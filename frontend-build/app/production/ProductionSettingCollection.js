define(["underscore","jquery","../data/localStorage","../settings/SettingCollection","../prodShiftOrders/ProdShiftOrder","./ProductionSetting"],function(t,e,n,i,r,a){"use strict";return i.extend({model:a,topicSuffix:"production.**",nlsDomain:"production",initialize:function(t,e){i.prototype.initialize.apply(this,arguments),this.resetCache(),e.localStorage&&this.setUpLocalStorage(),this.on("reset change",this.resetCache)},resetCache:function(){this.cache={taktTimeEnabled:{}}},getValue:function(t){var e=this.get("production."+t);return e?e.getValue():null},prepareValue:function(e,n){return/rearmDowntimeReason$/.test(e)?t.isEmpty(n)?null:n:/spigot(Not)?Patterns$/.test(e)?this.prepareSpigotPatterns(n):/lines$/i.test(e)?this.prepareLines(n):/spigot.*?Groups$/.test(e)?this.prepareSpigotGroups(n):/(spigotFinish|enabled|last|avg|sap|smiley)$/.test(e)?!!n:/taktTime.coeffs$/.test(e)?this.mapTaktTimeCoeffs(n):/ignoredDowntimes$/i.test(e)?this.prepareMultiSelect2Value(n):/lineAutoDowntimes$/.test(e)&&Array.isArray(n)?n:this.prepareNumericValue(n,0,60)},prepareFormValue:function(t,e){return/taktTime.coeffs$/.test(t)?this.prepareTaktTimeCoeffs(e):i.prototype.prepareFormValue.apply(this,arguments)},prepareSpigotPatterns:function(t){return"string"!=typeof t?void 0:t.split("\n").filter(function(t){try{new RegExp(t)}catch(t){return!1}return!!t.trim().length}).join("\n")},prepareLines:function(t){return"string"!=typeof t?void 0:t.split(",").filter(function(t){return!!t.length}).join(",")},prepareSpigotGroups:function(t){return(t||"").split("\n").map(function(t){var e=t.split(/[^0-9]+/).filter(function(t){return t.length>0});return 0===e.length?"":e.shift()+": "+e.join(", ")}).join("\n").replace(/\n{2,}/g,"\n")},getAutoDowntimes:function(e){var n=t.find(this.getValue("lineAutoDowntimes"),function(n){return t.includes(n.lines,e)});return n?(n.downtimes.sort(function(t,e){return t.when===e.when?0:"initial"===t.when?-1:"initial"===e.when?1:"always"===t.when?-1:"always"===e.when?1:0}),n.downtimes):[]},isTaktTimeEnabled:function(e){var n=this.cache.taktTimeEnabled[e];return void 0!==n?n:(n=!!this.getValue("taktTime.enabled")&&(!e||!t.includes((this.getValue("taktTime.ignoredLines")||"").split(","),e)),this.cache.taktTimeEnabled[e]=n,n)},showLastTaktTime:function(){return!!this.getValue("taktTime.last")},showAvgTaktTime:function(){return!!this.getValue("taktTime.avg")},showSapTaktTime:function(){return!!this.getValue("taktTime.sap")},showSmiley:function(){return!!this.getValue("taktTime.smiley")},mapTaktTimeCoeffs:function(t){if(!t)return{};var e="",n=0,i={};return t.replace(/\s*:\s*/g,": ").replace(/\s*<\s*/g," <").replace(/\s*=\s*/g,"=").split(/\s+/).forEach(function(t){if(/^(\*|[A-Z0-9_]+):$/i.test(t))return e=t.substring(0,t.length-1).toUpperCase(),void(n=0);if(/^<(\*|[0-9]+)$/.test(t))n=parseInt(t.substring(1),10)||0;else{var r=t.match(/^(\*|[A-Z0-9_]+)(\/(?:\*|[0-9])+)?=([0-9]+(?:[.,][0-9]+)?)$/i);if(r){var a=r[1].toUpperCase(),s=r[2]&&"*"!==r[2]?r[2]:"",o=parseFloat(r[3].replace(",","."));i[e]||(i[e]={0:{}}),i[e][n]||(i[e][n]={}),i[e][n][a+s]=o}}}),Object.keys(i).forEach(function(t){var e=[];Object.keys(i[t]).sort(function(t,e){return"0"===t?-1:"0"===e?1:e-t}).forEach(function(n){e.push({qty:+n,wcs:i[t][n]})}),i[t]=e}),i},prepareTaktTimeCoeffs:function(t){return Object.keys(t||{}).sort(function(t,e){return t.localeCompare(e,void 0,{ignorePunctuation:!0,numeric:!0})}).map(function(e){var n=e+":",i="".padStart(n.length," "),r=t[e].reduce(function(t,e){return Math.max(t,e.qty.toString().length)},0);return t[e].forEach(function(t){var e=t.qty?t.qty.toString():"*",a=i+" <"+e+"".padEnd(r-e.length," "),s="".padStart(a.length," "),o=Object.keys(t.wcs);n+="\n"+a,o.sort(function(t,e){return t.localeCompare(e,void 0,{ignorePunctuation:!0,numeric:!0})}).forEach(function(e,i){n+=" "+e+"="+t.wcs[e],(i+1)%10==0&&i!==o.length-1&&(n+="\n"+s)})}),n}).join("\n")},setUpLocalStorage:function(){this.length||this.readLocalData(),this.on("reset change",this.saveLocalData.bind(this))},readLocalData:function(){try{this.reset(JSON.parse(n.getItem("PRODUCTION:SETTINGS")))}catch(t){}},saveLocalData:function(){n.setItem("PRODUCTION:SETTINGS",JSON.stringify(this.models))}})});