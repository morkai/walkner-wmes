// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/user","app/i18n","app/viewport","app/updater/index","app/core/View","app/data/prodLog","app/prodShifts/ProdShift","app/prodDowntimes/ProdDowntime","app/isa/IsaRequest","../views/ProductionControlsView","../views/ProductionHeaderView","../views/ProductionDataView","../views/ProdDowntimeListView","../views/ProductionQuantitiesView","../views/IsaView","../views/SpigotCheckerView","app/production/templates/productionPage","app/production/templates/duplicateWarning"],function(e,i,t,o,n,s,d,r,a,c,u,l,h,p,m,f,g,w,b){"use strict";return s.extend({template:w,layoutName:"blank",remoteTopics:function(){var e={};return e["isaRequests.created."+this.model.prodLine.id+".**"]="onIsaRequestUpdated",e["isaRequests.updated."+this.model.prodLine.id+".**"]="onIsaRequestUpdated",e},localTopics:{"socket.connected":function(){this.joinProduction()},"socket.disconnected":function(){this.productionJoined=!1},"updater.frontendReloading":function(){this.model.saveLocalData()},"router.dispatching":function(e){e.path!=="/production/"+this.model.prodLine.id&&this.leaveProduction()},"production.locked":"onProductionLocked","production.duplicateDetected":"onDuplicateDetected"},breadcrumbs:function(){return[t("production","breadcrumbs:base"),this.model.getLabel()]},initialize:function(){this.delayProductionJoin=this.delayProductionJoin.bind(this),this.onBeforeUnload=this.onBeforeUnload.bind(this),this.layout=null,this.shiftEditedSub=null,this.productionJoined=!1,this.enableProdLog=!1,this.pendingIsaChanges=[],n.disableViews(),this.defineViews(),this.defineBindings(),e(window).on("beforeunload."+this.idPrefix,this.onBeforeUnload).on("keydown."+this.idPrefix,this.onKeyDown)},setUpLayout:function(e){this.layout=e},destroy:function(){e(document.body).removeClass("is-production"),this.layout=null,this.shiftEditedSub=null,e(window).off("."+this.idPrefix),this.model.stopShiftChangeMonitor(),n.enableViews(),d.disable()},serialize:function(){return{idPrefix:this.idPrefix,locked:this.model.isLocked(),state:this.model.get("state"),mechOrder:!!this.model.prodShiftOrder.get("mechOrder")}},load:function(i){o.msg.loading();var t=this,n=e.Deferred(),s=e.Deferred();return n.done(function(){t.timers.readLocalData=setTimeout(function(){t.timers.readLocalData=null,t.model.readLocalData()},1)}),n.fail(function(){document.body.innerHTML=b()}),n.always(function(){o.msg.loaded(),"rejected"===n.state()?(t.enableProdLog=!1,s.reject()):(t.enableProdLog=!0,s.resolve())}),d.enable(n),i(s.promise())},defineViews:function(){var e=this,i=e.model;e.controlsView=new u({model:i}),e.headerView=new l({model:i}),e.dataView=new h({model:i}),e.downtimesView=new p({model:i}),e.quantitiesView=new m({model:i}),e.isaView=new f({model:i});var t="#"+e.idPrefix+"-";e.setView(t+"controls",e.controlsView),e.setView(t+"header",e.headerView),e.setView(t+"data",e.dataView),e.setView(t+"downtimes",e.downtimesView),e.setView(t+"quantities",e.quantitiesView),e.setView(t+"isa",e.isaView)},defineBindings:function(){var e=this,i=e.model;e.listenTo(i,"locked",function(){e.$el.removeClass("is-unlocked").addClass("is-locked"),e.leaveProduction()}),e.listenTo(i,"unlocked",function(){e.$el.removeClass("is-locked").addClass("is-unlocked"),e.joinProduction()}),e.listenTo(i,"change:state",function(){null!==e.layout&&e.layout.setBreadcrumbs(e.breadcrumbs,e);var t=i.previous("state"),o=i.get("state");t&&e.$el.removeClass("is-"+t),o&&e.$el.addClass("is-"+o),e.checkSpigot()}),e.listenTo(i,"change:shift",function(){return o.closeAllDialogs(),e.$el.hasClass("hidden")?void e.$el.removeClass("hidden"):void(i.get("shift")&&o.msg.show({type:"info",time:2e3,text:t("production","msg:shiftChange")}))}),e.listenTo(i,"change:_id",e.subscribeForShiftChanges),i.id&&this.subscribeForShiftChanges(),e.listenTo(i.prodShiftOrder,"change:mechOrder",function(){e.$el.toggleClass("is-mechOrder",i.prodShiftOrder.isMechOrder())}),e.listenTo(e.downtimesView,"corroborated",function(){i.saveLocalData()}),e.socket.on("production.locked",e.broker.publish.bind(e.broker,"production.locked"))},beforeRender:function(){this.enableProdLog&&(d.enable(),this.enableProdLog=!1)},afterRender:function(){e(document.body).addClass("is-production"),this.socket.isConnected()&&this.joinProduction(),(this.model.isLocked()||this.model.id)&&this.$el.removeClass("hidden")},onKeyDown:function(e){var i=e.target.tagName,t="INPUT"===i&&"BUTTON"!==e.target.type||"SELECT"===i||"TEXTAREA"===i;8!==e.keyCode||t&&!e.target.readOnly&&!e.target.disabled||e.preventDefault()},onBeforeUnload:function(){return this.model.isLocked()||(d.disable(),this.model.isIdle()||n.isFrontendReloading())?void 0:(this.timers.enableProdLog=setTimeout(d.enable.bind(d),1e3),this.model.isDowntime()?t("production","unload:downtime"):t("production","unload:order"))},onProductionLocked:function(e){e.prodLine===this.model.prodLine.id&&e.secretKey===this.model.getSecretKey()&&(this.model.setSecretKey(null),o.msg.show({time:5e3,type:"warning",text:t("production","msg:locked")}))},onDuplicateDetected:function(){this.remove(),document.body.innerHTML=b()},onIsaRequestUpdated:function(e){this.pendingIsaChanges?this.pendingIsaChanges.push(e):this.applyIsaChange(e)},applyIsaChange:function(e){e=c.parse(e);var i=this.model.isaRequests,t=i.get(e._id);t?t.set(e):(i.add(e),t=i.get(e._id)),t.isCompleted()&&i.remove(t)},joinProduction:function(){var e=this,i=e.model;if(e.timers.joinProduction&&(clearTimeout(e.timers.joinProduction),delete e.timers.joinProduction),!e.productionJoined&&!i.isLocked()&&e.socket.isConnected()){if(d.isSyncing())return e.broker.subscribe("production.synced",e.delayProductionJoin).setLimit(1);if(!i.id)return e.listenToOnce(i,"change:_id",e.delayProductionJoin);this.pendingIsaChanges||(this.pendingIsaChanges=[]);var t=i.prodDowntimes.findFirstUnfinished(),o={prodLineId:i.prodLine.id,prodShiftId:i.id,prodShiftOrderId:i.prodShiftOrder.id||null,prodDowntimeId:t?t.id:null};this.socket.emit("production.join",o,function(t){t&&(t.plannedQuantities&&i.updatePlannedQuantities(t.plannedQuantities),t.prodDowntimes&&i.prodDowntimes.reset(t.prodDowntimes.map(function(e){return a.parse(e)})),t.settings&&i.settings.reset(t.settings),t.isaRequests&&(i.isaRequests.reset(t.isaRequests.map(function(e){return c.parse(e)})),e.pendingIsaChanges&&(e.pendingIsaChanges.forEach(e.applyIsaChange,e),e.pendingIsaChanges=null)))}),this.productionJoined=!0}},leaveProduction:function(){this.productionJoined&&(this.socket.isConnected()&&this.socket.emit("production.leave",this.model.prodLine.id),this.productionJoined=!1)},delayProductionJoin:function(){var e=this;e.timers.joinProduction&&clearTimeout(e.timers.joinProduction),e.timers.joinProduction=setTimeout(function(){e.timers.joinProduction=null,e.joinProduction()},333)},subscribeForShiftChanges:function(){this.shiftEditedSub&&(this.shiftEditedSub.cancel(),this.shiftEditedSub=null);var e=this.model;e.id&&(this.shiftEditedSub=this.pubsub.subscribe("production.edited.shift."+e.id,function(i){e.set(i)}))},checkSpigot:function(){var e=this.model,i=e.prodShiftOrder.get("spigot")||null;if("downtime"===e.get("state")&&!i&&e.isSpigotLine()){var t=e.settings,o=t.getValue("rearmDowntimeReason"),n=e.prodDowntimes.findFirstUnfinished().get("reason");if(n===o){var s=e.getSpigotComponent();s&&this.showSpigotDialog(s)}}},showSpigotDialog:function(e){var i=new g({model:this.model,component:e});this.broker.subscribe("viewport.dialog.hidden").setLimit(1).setFilter(function(e){return e===i}).on("message",this.checkSpigot.bind(this)),o.showDialog(i,t("production","spigotChecker:title"))}})});