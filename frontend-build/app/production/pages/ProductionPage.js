// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","hammer","app/time","app/user","app/i18n","app/viewport","app/updater/index","app/core/View","app/data/prodLog","app/data/aors","app/data/downtimeReasons","app/data/dictionaries","app/prodShifts/ProdShift","app/prodDowntimes/ProdDowntime","app/isa/IsaRequest","../snManager","../views/ProductionControlsView","../views/ProductionHeaderView","../views/ProductionDataView","../views/ProdDowntimeListView","../views/ProductionQuantitiesView","../views/IsaView","../views/SpigotCheckerView","app/production/templates/productionPage","app/production/templates/duplicateWarning"],function(e,i,t,o,n,s,d,r,a,u,c,h,l,m,p,w,g,f,b,D,S,T,v,C,A,P){"use strict";return a.extend({template:A,layoutName:"blank",remoteTopics:function(){var e={};return this.model.prodLine.id&&(e["production.autoDowntimes."+this.model.get("subdivision")]="onAutoDowntime",e["isaRequests.created."+this.model.prodLine.id+".**"]="onIsaRequestUpdated",e["isaRequests.updated."+this.model.prodLine.id+".**"]="onIsaRequestUpdated"),e},localTopics:{"socket.connected":function(){this.joinProduction()},"socket.disconnected":function(){this.productionJoined=0},"updater.frontendReloading":function(){this.model.saveLocalData()},"router.dispatching":function(e){e.path!=="/production/"+this.model.prodLine.id&&this.leaveProduction()},"production.locked":"onProductionLocked","production.duplicateDetected":"onDuplicateDetected","production.taktTime.snScanned":"onSnScanned"},events:{"click #-currentDowntime":function(){var e=this.model.prodDowntimes.findFirstUnfinished();e&&this.downtimesView.showEditDialog(e.id)},"click #-snMessage":"hideSnMessage","mousedown #-switchApps":function(e){this.startActionTimer("switchApps",e)},"touchstart #-switchApps":function(){this.startActionTimer("switchApps")},"mouseup #-switchApps":function(){this.stopActionTimer("switchApps")},"touchend #-switchApps":function(){this.stopActionTimer("switchApps")},"mousedown #-reboot":function(e){this.startActionTimer("reboot",e)},"touchstart #-reboot":function(){this.startActionTimer("reboot")},"mouseup #-reboot":function(){this.stopActionTimer("reboot")},"touchend #-reboot":function(){this.stopActionTimer("reboot")},"mousedown #-shutdown":function(e){this.startActionTimer("shutdown",e)},"touchstart #-shutdown":function(){this.startActionTimer("shutdown")},"mouseup #-shutdown":function(){this.stopActionTimer("shutdown")},"touchend #-shutdown":function(){this.stopActionTimer("shutdown")}},breadcrumbs:function(){return[s("production","breadcrumbs:base"),this.model.getLabel()]},initialize:function(){this.delayProductionJoin=this.delayProductionJoin.bind(this),this.onBeforeUnload=this.onBeforeUnload.bind(this),this.onWindowResize=e.debounce(this.onWindowResize.bind(this),33),this.layout=null,this.shiftEditedSub=null,this.productionJoined=0,this.enableProdLog=!1,this.pendingIsaChanges=[],this.actionTimer={action:null,time:null},r.disableViews(),this.defineViews(),this.defineBindings(),i(window).on("resize."+this.idPrefix,this.onWindowResize).on("beforeunload."+this.idPrefix,this.onBeforeUnload).on("keydown."+this.idPrefix,this.onKeyDown),window.parent!==window&&i(window).on("contextmenu."+this.idPrefix,function(e){e.preventDefault()})},setUpLayout:function(e){this.layout=e},destroy:function(){i(document.body).removeClass("is-production is-embedded"),this.layout=null,this.shiftEditedSub=null,i(window).off("."+this.idPrefix),this.model.stopShiftChangeMonitor(),r.enableViews(),u.disable()},serialize:function(){return{idPrefix:this.idPrefix,locked:this.model.isLocked(),state:this.model.get("state"),mechOrder:!!this.model.prodShiftOrder.get("mechOrder"),showBottomControls:window.parent!==window}},load:function(e){d.msg.loading();var t=this,o=i.Deferred(),n=i.Deferred();return o.done(function(){t.timers.readLocalData=setTimeout(function(){t.timers.readLocalData=null,t.model.readLocalData()},1)}),o.fail(function(){document.body.innerHTML=P()}),o.always(function(){d.msg.loaded(),"rejected"===o.state()?(t.enableProdLog=!1,n.reject()):(t.enableProdLog=!0,n.resolve())}),u.enable(o),e(n.promise())},defineViews:function(){var e=this,i=e.model;e.controlsView=new f({model:i}),e.headerView=new b({model:i}),e.dataView=new D({model:i}),e.downtimesView=new S({model:i}),e.quantitiesView=new T({model:i}),e.isaView=new v({model:i});var t="#"+e.idPrefix+"-";e.setView(t+"controls",e.controlsView),e.setView(t+"header",e.headerView),e.setView(t+"data",e.dataView),e.setView(t+"downtimes",e.downtimesView),e.setView(t+"quantities",e.quantitiesView),e.setView(t+"isa",e.isaView)},defineBindings:function(){var e=this,i=e.model;e.listenTo(i,"locked",function(){e.$el.removeClass("is-unlocked").addClass("is-locked"),e.leaveProduction()}),e.listenTo(i,"unlocked",function(){e.$el.removeClass("is-locked").addClass("is-unlocked"),e.joinProduction()}),e.listenTo(i,"change:state",function(){null!==e.layout&&e.layout.setBreadcrumbs(e.breadcrumbs,e);var t=i.previous("state"),o=i.get("state");t&&e.$el.removeClass("is-"+t),o&&e.$el.addClass("is-"+o),e.checkSpigot(),e.updateCurrentDowntime()}),e.listenTo(i,"change:shift",function(){return d.closeAllDialogs(),e.$el.hasClass("hidden")?void e.$el.removeClass("hidden"):void(i.get("shift")&&d.msg.show({type:"info",time:2e3,text:s("production","msg:shiftChange")}))}),e.listenTo(i,"change:_id",e.subscribeForShiftChanges),i.id&&this.subscribeForShiftChanges(),e.listenTo(i.prodDowntimes,"change:finishedAt",function(){e.updateCurrentDowntime()}),e.listenTo(i,"second",function(){e.updateCurrentDowntime()}),e.listenTo(i,"orderCorrected",function(){e.checkSpigot()}),e.listenTo(i.prodShiftOrder,"change:mechOrder",function(){e.$el.toggleClass("is-mechOrder",i.prodShiftOrder.isMechOrder())}),e.listenTo(e.downtimesView,"corroborated",function(){i.saveLocalData()}),e.socket.on("production.locked",function(){e.broker.publish(e.broker,"production.locked")})},beforeRender:function(){this.enableProdLog&&(u.enable(),this.enableProdLog=!1)},afterRender:function(){i(document.body).addClass("is-production").toggleClass("is-embedded",window.parent!==window),this.socket.isConnected()&&this.joinProduction(),this.updateCurrentDowntime(),(this.model.isLocked()||this.model.id)&&this.$el.removeClass("hidden"),window.parent!==window&&(this.hammer=new t(document.body),this.hammer.on("swipe",function(e){e.deltaX<0&&e.changedPointers[0].pageX-e.deltaX>Math.max(300,.7*window.innerWidth)&&window.parent.postMessage({type:"switch",app:"operator"},"*")}),window.parent.postMessage({type:"ready",app:"operator"},"*"))},onKeyDown:function(e){var i=e.target.tagName,t="INPUT"===i&&"BUTTON"!==e.target.type||"SELECT"===i||"TEXTAREA"===i;8!==e.keyCode||t&&!e.target.readOnly&&!e.target.disabled||e.preventDefault(),g.handleKeyboardEvent(e)},onBeforeUnload:function(){return this.model.isLocked()||window.parent!==window||(u.disable(),this.model.isIdle()||r.isFrontendReloading())?void 0:(this.timers.enableProdLog=setTimeout(u.enable.bind(u),1e3),this.model.isDowntime()?s("production","unload:downtime"):s("production","unload:order"))},onWindowResize:function(){this.adjustCurrentDowntimeBox()},onProductionLocked:function(e){e.prodLine===this.model.prodLine.id&&e.secretKey===this.model.getSecretKey()&&(this.model.setSecretKey(null),d.msg.show({time:5e3,type:"warning",text:s("production","msg:locked")}))},onDuplicateDetected:function(){this.remove(),document.body.innerHTML=P()},onIsaRequestUpdated:function(e){this.pendingIsaChanges?this.pendingIsaChanges.push(e):this.applyIsaChange(e)},applyIsaChange:function(e){e=w.parse(e);var i=this.model.isaRequests,t=i.get(e._id);t?t.set(e):(i.add(e),t=i.get(e._id)),t.isCompleted()&&i.remove(t)},joinProduction:function(){var i=this,t=i.model;if(i.timers.joinProduction&&(clearTimeout(i.timers.joinProduction),delete i.timers.joinProduction),!i.productionJoined&&!t.isLocked()&&i.socket.isConnected()){if(u.isSyncing())return i.broker.subscribe("production.synced",i.delayProductionJoin).setLimit(1);if(!t.id)return i.listenToOnce(t,"change:_id",i.delayProductionJoin);this.pendingIsaChanges||(this.pendingIsaChanges=[]);var o=t.prodDowntimes.findFirstUnfinished(),n={prodLineId:t.prodLine.id,prodShiftId:t.id,prodShiftOrderId:t.prodShiftOrder.id||null,prodDowntimeId:o?o.id:null,dictionaries:{}};e.forEach(l,function(e,i){/^[A-Z0-9_]+$/.test(i)||(n.dictionaries[i]=e.updatedAt)}),this.socket.emit("production.join",n,function(o){o&&(o.plannedQuantities&&t.updatePlannedQuantities(o.plannedQuantities),o.prodDowntimes&&t.prodDowntimes.refresh(o.prodDowntimes),o.settings&&t.settings.reset(o.settings),o.isaRequests&&(t.isaRequests.reset(o.isaRequests.map(function(e){return w.parse(e)})),i.pendingIsaChanges&&(i.pendingIsaChanges.forEach(i.applyIsaChange,i),i.pendingIsaChanges=null)),e.forEach(o.dictionaries,function(e,i){l[i].reset(e)}))}),this.productionJoined=Date.now()}},leaveProduction:function(){this.productionJoined&&(this.socket.isConnected()&&this.socket.emit("production.leave",this.model.prodLine.id),this.productionJoined=0)},delayProductionJoin:function(){var e=this;e.timers.joinProduction&&clearTimeout(e.timers.joinProduction),e.timers.joinProduction=setTimeout(function(){e.timers.joinProduction=null,e.joinProduction()},333)},subscribeForShiftChanges:function(){this.shiftEditedSub&&(this.shiftEditedSub.cancel(),this.shiftEditedSub=null);var e=this.model;e.id&&(this.shiftEditedSub=this.pubsub.subscribe("production.edited.shift."+e.id,function(i){e.set(i)}))},checkSpigot:function(){var e=this.model,i=e.prodShiftOrder.get("spigot")||null,t=e.getSpigotComponent();if(t){if(i&&i.forceCheck&&t)return void this.showSpigotDialog(t);if("downtime"===e.get("state")&&!i&&e.isSpigotLine()){var o=e.settings,n=o.getValue("rearmDowntimeReason"),s=e.prodDowntimes.findFirstUnfinished().get("reason");s===n&&t&&this.showSpigotDialog(t)}}},showSpigotDialog:function(e){var i=new C({model:this.model,component:e});this.broker.subscribe("viewport.dialog.hidden").setLimit(1).setFilter(function(e){return e===i}).on("message",this.checkSpigot.bind(this)),d.showDialog(i,s("production","spigotChecker:title"))},adjustCurrentDowntimeBox:function(){var e=this.$id("downtimes-header"),i=e.offset();if(i){var t=this.$id("currentDowntime"),o=this.$id("currentDowntime-message").css("margin-top","");t.css({top:i.top+e.outerHeight()+1+"px",left:i.left+"px",width:e.width()+"px"}),o.css("margin-top",(t.outerHeight()-o.outerHeight())/2+"px")}},updateCurrentDowntime:function(){var e,i,t,n,d=this.$id("currentDowntime"),r=this.incomingAutoDowntime,a=this.model.prodDowntimes.findFirstUnfinished();if(a)d.removeClass("is-incoming"),e=a.getReasonLabel(),i=a.getAorLabel(),t=a.getDurationString(null,!0),n=(a.get("auto")||{d:0}).d;else{if(!r)return void d.addClass("hidden");r.remainingTime=r.startingAt-Date.now(),e=h.get(r.reason),e=e?e.getLabel():null,i=c.get(this.model.getDefaultAor()),i=i?i.getLabel():null,t=s("production","autoDowntimes:remainingTime",{time:o.toString(r.remainingTime/1e3,!1,!1)}),n=r.duration,d.addClass("is-incoming")}return e&&i?(this.$id("currentDowntime-reason").text(e),this.$id("currentDowntime-aor").text(i),this.$id("currentDowntime-elapsedTime").text(t),n?this.$id("currentDowntime-duration").text(o.toString(60*n)).removeClass("hidden"):this.$id("currentDowntime-duration").addClass("hidden"),d.removeClass("hidden"),this.adjustCurrentDowntimeBox(),void(r&&r.remainingTime<-1e3&&(this.incomingAutoDowntime=null,this.model.startTimedAutoDowntime(r.reason,r.duration)))):void d.addClass("hidden")},onAutoDowntime:function(e){this.model.shouldStartTimedAutoDowntime(e.reason)&&this.productionJoined&&(-1===e.remainingTime?(this.incomingAutoDowntime=null,this.model.startTimedAutoDowntime(e.reason,e.duration)):(e.startingAt=Date.now()+e.remainingTime,this.incomingAutoDowntime=e,this.updateCurrentDowntime()))},onSnScanned:function(e){var i,t=this,o=t.model,n=o.get("state"),s=u.create(o,"checkSerialNumber",e);if("working"!==n?i="INVALID_STATE:"+n:e.orderNo!==o.prodShiftOrder.get("orderId")?i="INVALID_ORDER":g.contains(e._id)&&(i="ALREADY_USED"),i)return s.data.error=i,u.record(o,s),this.showSnMessage(e,"error",i);t.showSnMessage(e,"warning","CHECKING");var d=this.ajax({method:"POST",url:"/production/checkSerialNumber",data:JSON.stringify(s),timeout:5e3});d.fail(function(){s.data.error="SERVER_FAILURE",u.record(o,s),t.showSnMessage(e,"error","SERVER_FAILURE")}),d.done(function(i){"SUCCESS"===i.result?(o.updateTaktTime(i.serialNumber,i.quantityDone,i.avgTaktTime),t.showSnMessage(e,"success","SUCCESS")):(s.data.error=i.result,u.record(o,s),t.showSnMessage(e,"error",i.result))})},showSnMessage:function(e,i,t){var o=this.$id("snMessage"),n=this.$(".production-actions");this.$id("snMessage-text").html(s("production","snMessage:"+t)),this.$id("snMessage-scannedValue").text(e._id),this.$id("snMessage-orderNo").text(e.orderNo),this.$id("snMessage-serialNo").text(e.serialNo),o.css({top:n.position().top+parseInt(n.css("marginTop"),10)+"px"}).removeClass("hidden is-success is-error is-warning").addClass("is-"+i).fadeIn("fast"),this.timers.hideSnMessage&&clearTimeout(this.timers.hideSnMessage),this.timers.hideSnMessage=setTimeout(this.hideSnMessage.bind(this),6e3)},hideSnMessage:function(){this.timers.hideSnMessage=null,this.$id("snMessage").fadeOut("fast")},startActionTimer:function(e,i){this.actionTimer.action=e,this.actionTimer.time=Date.now(),i&&i.preventDefault()},stopActionTimer:function(e){if(this.actionTimer.action===e){var i=Date.now()-this.actionTimer.time>3e3;"switchApps"===e?i?window.parent.postMessage({type:"config"},"*"):window.parent.postMessage({type:"switch",app:"operator"},"*"):"reboot"===e?i?window.parent.postMessage({type:"reboot"},"*"):window.location.reload():i&&"shutdown"===e&&window.parent.postMessage({type:"shutdown"},"*"),this.actionTimer.action=null,this.actionTimer.time=null}}})});