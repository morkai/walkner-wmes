// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/user","app/i18n","app/viewport","app/updater/index","app/core/View","app/data/prodLog","app/prodShifts/ProdShift","app/isa/IsaLineState","../views/ProductionControlsView","../views/ProductionHeaderView","../views/ProductionDataView","../views/ProdDowntimeListView","../views/ProductionQuantitiesView","../views/IsaView","app/production/templates/productionPage","app/production/templates/duplicateWarning"],function(e,i,t,s,o,n,d,r,h,a,l,c,u,m,f,p,w){"use strict";return n.extend({template:p,layoutName:"blank",remoteTopics:function(){var e={};return e["isaLineStates.updated."+this.model.prodLine.id]="onIsaLineStateUpdated",e},localTopics:{"socket.connected":function(){this.joinProduction(),this.refreshDowntimes(),this.refreshPlannedQuantities(),this.refreshIsaLineState()},"socket.disconnected":function(){this.productionJoined=!1},"updater.frontendReloading":function(){this.model.saveLocalData()},"router.dispatching":function(e){e.path!=="/production/"+this.model.prodLine.id&&this.leaveProduction()},"production.locked":"onProductionLocked","production.duplicateDetected":"onDuplicateDetected"},breadcrumbs:function(){return[t("production","breadcrumbs:productionPage"),this.model.getLabel()]},initialize:function(){this.delayProductionJoin=this.delayProductionJoin.bind(this),this.onBeforeUnload=this.onBeforeUnload.bind(this),this.layout=null,this.shiftEditedSub=null,this.productionJoined=!1,this.enableProdLog=!1,this.pendingIsaChanges=[],o.disableViews(),this.defineViews(),this.defineBindings(),e(window).on("beforeunload."+this.idPrefix,this.onBeforeUnload)},setUpLayout:function(e){this.layout=e},destroy:function(){e(document.body).removeClass("is-production"),this.layout=null,this.shiftEditedSub=null,e(window).off("."+this.idPrefix),this.model.stopShiftChangeMonitor(),o.enableViews(),d.disable()},serialize:function(){return{idPrefix:this.idPrefix,locked:this.model.isLocked(),state:this.model.get("state"),mechOrder:!!this.model.prodShiftOrder.get("mechOrder")}},load:function(i){s.msg.loading();var t=this,o=e.Deferred(),n=e.Deferred();return o.done(function(){t.timers.readLocalData=setTimeout(function(){t.timers.readLocalData=null,t.model.readLocalData()},1)}),o.fail(function(){document.body.innerHTML=w()}),o.always(function(){s.msg.loaded(),"rejected"===o.state()?(t.enableProdLog=!1,n.reject()):(t.enableProdLog=!0,n.resolve())}),d.enable(o),i(n.promise())},defineViews:function(){this.controlsView=new a({model:this.model}),this.headerView=new l({model:this.model}),this.dataView=new c({model:this.model}),this.downtimesView=new u({model:this.model}),this.quantitiesView=new m({model:this.model}),this.isaView=new f({model:this.model}),this.setView("#"+this.idPrefix+"-controls",this.controlsView),this.setView("#"+this.idPrefix+"-header",this.headerView),this.setView("#"+this.idPrefix+"-data",this.dataView),this.setView("#"+this.idPrefix+"-downtimes",this.downtimesView),this.setView("#"+this.idPrefix+"-quantities",this.quantitiesView),this.setView("#"+this.idPrefix+"-isa",this.isaView)},defineBindings:function(){this.listenTo(this.model,"locked",function(){this.$el.removeClass("is-unlocked").addClass("is-locked"),this.leaveProduction()}),this.listenTo(this.model,"unlocked",function(){this.$el.removeClass("is-locked").addClass("is-unlocked"),this.refreshDowntimes(),this.refreshPlannedQuantities(),this.refreshIsaLineState(),this.joinProduction()}),this.listenTo(this.model,"change:state",function(){null!==this.layout&&this.layout.setBreadcrumbs(this.breadcrumbs,this);var e=this.model.previous("state"),i=this.model.get("state");e&&this.$el.removeClass("is-"+e),i&&this.$el.addClass("is-"+i)}),this.listenTo(this.model,"change:shift",function(){return s.closeAllDialogs(),this.$el.hasClass("hidden")?void this.$el.removeClass("hidden"):void(this.model.get("shift")&&s.msg.show({type:"info",time:2e3,text:t("production","msg:shiftChange")}))}),this.listenTo(this.model,"change:_id",this.subscribeForShiftChanges),this.model.id&&this.subscribeForShiftChanges(),this.listenTo(this.model.prodShiftOrder,"change:mechOrder",function(){this.$el.toggleClass("is-mechOrder",this.model.prodShiftOrder.isMechOrder())}),this.listenTo(this.downtimesView,"corroborated",function(){this.model.saveLocalData()}),this.listenTo(this.model.isaLineState,"request",function(){this.pendingIsaChanges=[]}),this.listenTo(this.model.isaLineState,"error sync",function(){this.pendingIsaChanges&&(this.pendingIsaChanges.forEach(this.applyIsaChange,this),this.pendingIsaChanges=null)}),this.socket.on("production.locked",this.broker.publish.bind(this.broker,"production.locked"))},beforeRender:function(){this.enableProdLog&&(d.enable(),this.enableProdLog=!1)},afterRender:function(){e(document.body).addClass("is-production"),this.socket.isConnected()&&(this.joinProduction(),this.refreshDowntimes(),this.refreshPlannedQuantities(),this.refreshIsaLineState()),(this.model.isLocked()||this.model.id)&&this.$el.removeClass("hidden")},onBeforeUnload:function(){return this.model.isLocked()||(d.disable(),this.model.isIdle()||o.isFrontendReloading())?void 0:(this.timers.enableProdLog=setTimeout(d.enable.bind(d),1e3),this.model.isDowntime()?t("production","unload:downtime"):t("production","unload:order"))},onProductionLocked:function(e){e.prodLine===this.model.prodLine.id&&e.secretKey===this.model.getSecretKey()&&(this.model.setSecretKey(null),s.msg.show({time:5e3,type:"warning",text:t("production","msg:locked")}))},onDuplicateDetected:function(){this.remove(),document.body.innerHTML=w()},onIsaLineStateUpdated:function(e){e=h.parse(e),this.pendingIsaChanges?this.pendingIsaChanges.push(e):this.applyIsaChange(e)},applyIsaChange:function(e){var i=this.model.isaLineState.get("updatedAt")||0;e.updatedAt>i&&this.model.isaLineState.set(e)},refreshDowntimes:function(){if(d.isSyncing())return this.broker.subscribe("production.synced",this.delayDowntimesRefresh.bind(this)).setLimit(1);if(this.model.isLocked())return this.listenToOnce(this.model,"unlocked",this.delayDowntimesRefresh);if(!this.model.id)return this.listenToOnce(this.model,"change:_id",this.delayDowntimesRefresh);this.timers.refreshingDowntimes&&clearTimeout(this.timers.refreshingDowntimes);var e=this;this.timers.refreshingDowntimes=setTimeout(function(){if(delete e.timers.refreshingDowntimes,e.socket.isConnected()&&!e.model.isLocked()){var i=e.model.prodDowntimes.fetch({reset:!0});e.promised(i).done(function(){e.model.saveLocalData()})}},2500)},delayDowntimesRefresh:function(){this.timers.refreshDowntimes&&clearTimeout(this.timers.refreshDowntimes),this.timers.refreshDowntimes=setTimeout(function(e){e.timers.refreshDowntimes=null,e.refreshDowntimes()},2500,this)},refreshPlannedQuantities:function(){if(d.isSyncing())return this.broker.subscribe("production.synced",this.delayPlannedQuantitiesRefresh.bind(this)).setLimit(1);if(this.model.isLocked())return this.listenToOnce(this.model,"unlocked",this.delayPlannedQuantitiesRefresh);if(!this.model.id)return this.listenToOnce(this.model,"change:_id",this.delayPlannedQuantitiesRefresh);var e=this;this.socket.emit("production.getPlannedQuantities",this.model.id,function(i,t){e.shiftEditedSub&&(i||e.model.updatePlannedQuantities(t))})},delayPlannedQuantitiesRefresh:function(){this.timers.refreshPlannedQuantities&&clearTimeout(this.timers.refreshPlannedQuantities),this.timers.refreshPlannedQuantities=setTimeout(function(e){e.timers.refreshPlannedQuantities=null,e.refreshPlannedQuantities()},5e3,this)},refreshIsaLineState:function(){this.promised(this.model.isaLineState.fetch())},joinProduction:function(){if(this.timers.joinProduction&&(clearTimeout(this.timers.joinProduction),delete this.timers.joinProduction),!this.productionJoined&&!this.model.isLocked()&&this.socket.isConnected()){if(d.isSyncing())return this.broker.subscribe("production.synced",this.delayProductionJoin).setLimit(1);if(!this.model.id)return this.listenToOnce(this.model,"change:_id",this.delayProductionJoin);var e=this.model.prodDowntimes.findFirstUnfinished();this.socket.emit("production.join",{prodLineId:this.model.prodLine.id,prodShiftId:this.model.id,prodShiftOrderId:this.model.prodShiftOrder.id||null,prodDowntimeId:e?e.id:null}),this.productionJoined=!0}},leaveProduction:function(){this.productionJoined&&(this.socket.isConnected()&&this.socket.emit("production.leave",this.model.prodLine.id),this.productionJoined=!1)},delayProductionJoin:function(){this.timers.joinProduction&&clearTimeout(this.timers.joinProduction),this.timers.joinProduction=setTimeout(function(e){e.timers.joinProduction=null,e.joinProduction()},1337,this)},subscribeForShiftChanges:function(){if(this.shiftEditedSub&&this.shiftEditedSub.cancel(),this.model.id){var e=this.model;this.shiftEditedSub=this.pubsub.subscribe("production.edited.shift."+this.model.id).on("message",function(i){e.set(i)})}}})});