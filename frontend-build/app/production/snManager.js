// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/broker"],function(e,t){"use strict";function n(e){e&&(o=e);var n=o.match(/P0*([0-9]{9})([0-9]{4})/);n||(n=o.match(/[A-Z0-9]{4}\.([0-9]{9})\.([0-9]{4})/)),n?t.publish("production.taktTime.snScanned",{_id:n[0],scannedAt:new Date,orderNo:n[1],serialNo:+n[2]}):o.length>5&&t.publish("production.taktTime.snScanned",{_id:o,scannedAt:new Date,orderNo:null,serialNo:null}),o=""}var a=/[A-Z0-9]{4}\.000000000\.0000/,r=null,o="",i=JSON.parse(localStorage.getItem("PRODUCTION:SN")||"{}");return window.fakeSN=n,{handleKeyboardEvent:function(e){e.target.classList.contains("form-control")&&void 0===e.target.dataset.snAccept||e.key&&1===e.key.length&&(o+=e.key.toUpperCase(),clearTimeout(r),r=setTimeout(n,50))},contains:function(e){return!a.test(e)&&!!i[e]},add:function(e){a.test(e)||(i[e._id]=[Date.parse(e.scannedAt),e.prodShiftOrder,e.prodLine],localStorage.setItem("PRODUCTION:SN",JSON.stringify(i)))},clear:function(){i={},localStorage.removeItem("PRODUCTION:SN")},getLocalTaktTime:function(t,n,a){var r=1,o=1,s=t.scannedAt.getTime(),c=new Date(n.get("startedAt")).getTime(),d=(new Date).getHours(),u=n.get("prodLine");Object.keys(i).forEach(function(e){var t=i[e];t[1]===n.id&&(r+=1,c=t[0]),t[2]===u&&new Date(t[0]).getHours()===d&&(o+=1)});var l=s-c;return{result:"SUCCESS",serialNumber:e.assign({taktTime:l,prodShiftOrder:n.id,prodLine:u},t),quantityDone:r,lastTaktTime:l,avgTaktTime:0,hourlyQuantityDone:{index:a,value:o}}}}});