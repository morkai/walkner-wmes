define(["underscore","app/broker","app/viewport"],function(e,t,n){"use strict";var a=/[A-Z0-9]{4}\.000000000\.0000/,r=null,o="",i=JSON.parse(localStorage.getItem("PRODUCTION:SN")||"{}");function s(e){if(e&&(o=e),e=o.trim(),o="","<ESC>"===e||"1337000027"===e)return n.closeAllDialogs();var a=e.match(/P0*([0-9]{9})([0-9]{4})/);a||(a=e.match(/([A-Z0-9]{4}\.([0-9]{9})\.([0-9]{4}))(?:[^.]|$)/)),a?t.publish("production.taktTime.snScanned",{_id:a[1],scannedAt:new Date,orderNo:a[2],serialNo:+a[3]}):e.length>5&&t.publish("production.taktTime.snScanned",{_id:e,scannedAt:new Date,orderNo:null,serialNo:null})}return window.fakeSN=s,{handleKeyboardEvent:function(e){e.target.classList.contains("form-control")&&void 0===e.target.dataset.snAccept||e.key&&1===e.key.length&&(o+=e.key.toUpperCase(),clearTimeout(r),r=setTimeout(s,50))},contains:function(e){return!a.test(e)&&!!i[e]},add:function(e){a.test(e)||(i[e._id]=[Date.parse(e.scannedAt),e.prodShiftOrder,e.prodLine],localStorage.setItem("PRODUCTION:SN",JSON.stringify(i)))},clear:function(){i={},localStorage.removeItem("PRODUCTION:SN")},getLocalTaktTime:function(t,n,a){var r=1,o=1,s=t.scannedAt.getTime(),c=new Date(n.get("startedAt")).getTime(),d=(new Date).getHours(),l=n.get("prodLine");Object.keys(i).forEach(function(e){var t=i[e];t[1]===n.id&&(r+=1,c=t[0]),t[2]===l&&new Date(t[0]).getHours()===d&&(o+=1)});var u=s-c;return{result:"SUCCESS",serialNumber:e.assign({taktTime:u,prodShiftOrder:n.id,prodLine:l},t),quantityDone:r,lastTaktTime:u,avgTaktTime:0,hourlyQuantityDone:{index:a,value:o}}}}});