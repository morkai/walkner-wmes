// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/broker"],function(e,t){"use strict";function n(){var e=i.match(/P0*([0-9]{9})([0-9]{4})/);e||(e=i.match(/[A-Z0-9]{4}\.([0-9]+)\.([0-9]+)/)),e?t.publish("production.taktTime.snScanned",{_id:e[0],scannedAt:new Date,orderNo:e[1],serialNo:+e[2]}):i.length>5&&t.publish("production.taktTime.snScanned",{_id:i,scannedAt:new Date,orderNo:null,serialNo:null}),i=""}var a="PRODUCTION:SN",r=null,i="",o=JSON.parse(localStorage.getItem(a)||"{}");return{handleKeyboardEvent:function(e){if(!e.target.classList.contains("form-control")||void 0!==e.target.dataset.snAccept){var t=e.which>=48&&e.which<=57,a=e.which>=65&&e.which<=90,o=190===e.which;(t||a||o)&&(i+=o?".":String.fromCharCode(e.which),clearTimeout(r),r=setTimeout(n,50))}},contains:function(e){return!!o[e]},add:function(e){o[e._id]=[Date.parse(e.scannedAt),e.prodShiftOrder,e.prodLine],localStorage.setItem(a,JSON.stringify(o))},clear:function(){o={},localStorage.removeItem(a)},getLocalTaktTime:function(t,n,a){var r=1,i=1,c=t.scannedAt.getTime(),s=new Date(n.get("startedAt")).getTime(),d=(new Date).getHours(),u=n.get("prodLine");Object.keys(o).forEach(function(e){var t=o[e];t[1]===n.id&&(r+=1,s=t[0]),t[2]===u&&new Date(t[0]).getHours()===d&&(i+=1)});var l=c-s;return{result:"SUCCESS",serialNumber:e.assign({taktTime:l,prodShiftOrder:n.id,prodLine:u},t),quantityDone:r,lastTaktTime:l,avgTaktTime:0,hourlyQuantityDone:{index:a,value:i}}}}});