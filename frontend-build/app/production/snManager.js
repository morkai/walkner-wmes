define(["underscore","jquery","app/broker","app/viewport","app/i18n","app/time","app/user","app/data/prodLog","app/production/views/BomCheckerDialogView","app/production/templates/snMessage","i18n!app/nls/production"],function(e,t,a,n,r,s,i,o,d,c){"use strict";var l=/[A-Z0-9]{4}\.000000000\.0000/,u=null,g="",h=JSON.parse(localStorage.getItem("PRODUCTION:SN")||"{}");function p(e){if(e&&(g=e),e=g.trim(),g="","<ESC>"===e||"1337000027"===e)return n.closeAllDialogs();var t=e.match(/P0*([0-9]{9})([0-9]{4})/);t||(t=e.match(/([A-Z0-9]{4}\.([0-9]{9})\.([0-9]{4}))(?:[^.]|$)/)),t?a.publish("production.taktTime.snScanned",{_id:t[1],scannedAt:new Date,orderNo:t[2],serialNo:+t[3]}):e.length>5&&a.publish("production.taktTime.snScanned",{_id:e,scannedAt:new Date,orderNo:null,serialNo:null})}return window.fakeSN=p,{handleKeyboardEvent:function(e){e.target.classList.contains("form-control")&&void 0===e.target.dataset.snAccept||e.key&&1===e.key.length&&(g+=e.key.toUpperCase(),clearTimeout(u),u=setTimeout(p,50))},contains:function(e){return!l.test(e)&&!!h[e]},add:function(e){l.test(e)||(h[e._id]=[Date.parse(e.scannedAt),e.prodShiftOrder,e.prodLine],localStorage.setItem("PRODUCTION:SN",JSON.stringify(h)))},clear:function(){h={},localStorage.removeItem("PRODUCTION:SN")},getLocalTaktTime:function(t,a,n){var r=1,s=1,i=t.scannedAt.getTime(),o=new Date(a.get("startedAt")).getTime(),d=(new Date).getHours(),c=a.get("prodLine");Object.keys(h).forEach(function(e){var t=h[e];t[1]===a.id&&(r+=1,o=t[0]),t[2]===c&&new Date(t[0]).getHours()===d&&(s+=1)});var l=i-o;return{result:"SUCCESS",serialNumber:e.assign({taktTime:l,prodShiftOrder:a.id,prodLine:c},t),quantityDone:r,lastTaktTime:l,avgTaktTime:0,hourlyQuantityDone:{index:n,value:s}}},showMessage:function(e,a,n){if(this.view){var s=t("#snMessage");s.length||(s=t(c()).appendTo("body")).on("click",this.hideMessage.bind(this));var i=e._id.length>43?e._id.substring(0,40)+"...":e._id;t("#snMessage-text").html(r("production","snMessage:"+n)),t("#snMessage-scannedValue").text(i),t("#snMessage-orderNo").text(e.orderNo||"-"),t("#snMessage-serialNo").text(e.serialNo||"-"),s.css({top:"50%",marginTop:"-80px"}).removeClass("hidden is-success is-error is-warning").addClass("is-"+a),this.view.timers.hideSnMessage&&clearTimeout(this.view.timers.hideSnMessage),this.view.timers.hideSnMessage=setTimeout(this.hideMessage.bind(this),6e3)}},hideMessage:function(){this.view&&(this.view.timers.hideSnMessage&&clearTimeout(this.view.timers.hideSnMessage),this.view.timers.hideSnMessage=null,t("#snMessage").addClass("hidden"))},bind:function(e){var a=this;if(a.view)throw new Error("snManager already bound!");a.view=e;var c=e.destroy;function l(e){var t=e.target.tagName,a="INPUT"===t&&"BUTTON"!==e.target.type||"SELECT"===t||"TEXTAREA"===t;8!==e.keyCode||a&&!e.target.readOnly&&!e.target.disabled||e.preventDefault(),e.target.classList.contains("form-control")&&void 0===e.target.dataset.snAccept||e.key&&1===e.key.length&&(g+=e.key.toUpperCase(),clearTimeout(u),u=setTimeout(p,50))}function h(t,n){if(e.createCheckSn)e.createCheckSn(t,n,m);else{if(a.contains(t._id))return a.showMessage(t,"error","ALREADY_USED");var r={_id:null,instanceId:window.INSTANCE_ID,type:"checkSerialNumber",data:t,createdAt:s.getMoment().toDate(),creator:i.getInfo(),prodLine:window.WMES_LINE_ID};t.sapTaktTime=-1,m(r,n)}}function m(t,s){var i=e.model,c=i&&i.updateTaktTime&&i.updateTaktTimeLocally;a.showMessage(t.data,"warning","CHECKING");var l=e.ajax({method:"POST",url:"/production/checkSerialNumber?bomCheck="+(s?1:0),data:JSON.stringify(t),timeout:6e3});l.fail(function(e){if(e.status<200)return c&&i.updateTaktTimeLocally(t),void a.showMessage(t.data,"success","SUCCESS");c&&(t.data.error="SERVER_FAILURE",o.record(i,t)),a.showMessage(t.data,"error","SERVER_FAILURE")}),l.done(function(l){"CHECK_BOM"===l.result?function(t,s){a.hideMessage(),s&&(t.logEntry.data._id="0000.000000000.0000",t.logEntry.data.serialNo=0);var i=new d({model:t,snMessage:{show:a.showMessage.bind(a),hide:a.hideMessage.bind(a)}});e.listenToOnce(i,"dialog:shown",function(){s&&i.onSnScanned(s)}),e.listenToOnce(i,"checked",function(e){n.closeDialog(),m(e)}),n.showDialog(i,r("production","bomChecker:title"))}(l,s):"SUCCESS"===l.result?(c&&i.updateTaktTime(l),a.showMessage(l.serialNumber,"success","SUCCESS")):("ALREADY_USED"===l.result&&a.add(l.serialNumber),c&&(t.data.error=l.result,o.record(i,t)),a.showMessage(t.data,"error",l.result))})}e.destroy=function(){t(window).off("keydown",l),c.apply(e,arguments)},e.broker.subscribe("production.taktTime.snScanned",function(e){if(n.currentDialog){if(!(n.currentDialog instanceof d))return;return void(e.orderNo?function(e){var t=n.currentDialog.model.logEntry.data;if(e._id===t._id)return;0===e.serialNo&&/^0+$/.test(e.orderNo)||e.orderNo!==t.orderNo?(n.closeDialog(),h(e)):n.currentDialog.onSnScanned(e)}(e):n.currentDialog.onSnScanned(e))}e.orderNo?h(e):h({_id:"0000.000000000.0000",orderNo:"000000000",serialNo:0,scannedAt:(t=e).scannedAt},t);var t}),t(window).on("keydown",l)}}});