// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/broker","app/viewport"],function(e,t,n){"use strict";function a(e){e&&(i=e);var a=null;n.currentDialog&&"bom"===n.currentDialog.snManagerMode||(a=i.match(/P0*([0-9]{9})([0-9]{4})/))||(a=i.match(/[A-Z0-9]{4}\.([0-9]+)\.([0-9]+)/)),a?t.publish("production.taktTime.snScanned",{_id:a[0],scannedAt:new Date,orderNo:a[1],serialNo:+a[2]}):i.length>5&&t.publish("production.taktTime.snScanned",{_id:i,scannedAt:new Date,orderNo:null,serialNo:null}),i=""}var r=/[A-Z0-9]{4}\.000000000\.0000/,o=null,i="",s=JSON.parse(localStorage.getItem("PRODUCTION:SN")||"{}");return window.fakeSN=a,{handleKeyboardEvent:function(e){e.target.classList.contains("form-control")&&void 0===e.target.dataset.snAccept||e.key&&1===e.key.length&&(i+=e.key,clearTimeout(o),o=setTimeout(a,50))},contains:function(e){return!r.test(e)&&!!s[e]},add:function(e){r.test(e)||(s[e._id]=[Date.parse(e.scannedAt),e.prodShiftOrder,e.prodLine],localStorage.setItem("PRODUCTION:SN",JSON.stringify(s)))},clear:function(){s={},localStorage.removeItem("PRODUCTION:SN")},getLocalTaktTime:function(t,n,a){var r=1,o=1,i=t.scannedAt.getTime(),c=new Date(n.get("startedAt")).getTime(),d=(new Date).getHours(),l=n.get("prodLine");Object.keys(s).forEach(function(e){var t=s[e];t[1]===n.id&&(r+=1,c=t[0]),t[2]===l&&new Date(t[0]).getHours()===d&&(o+=1)});var u=i-c;return{result:"SUCCESS",serialNumber:e.assign({taktTime:u,prodShiftOrder:n.id,prodLine:l},t),quantityDone:r,lastTaktTime:u,avgTaktTime:0,hourlyQuantityDone:{index:a,value:o}}}}});