// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/broker"],function(e,t){"use strict";function n(e){e&&(o=e);var n=o.match(/P0*([0-9]{9})([0-9]{4})/);n||(n=o.match(/[A-Z0-9]{4}\.([0-9]+)\.([0-9]+)/)),n?t.publish("production.taktTime.snScanned",{_id:n[0],scannedAt:new Date,orderNo:n[1],serialNo:+n[2]}):o.length>5&&t.publish("production.taktTime.snScanned",{_id:o,scannedAt:new Date,orderNo:null,serialNo:null}),o=""}var a="PRODUCTION:SN",r=/[A-Z0-9]{4}\.000000000\.0000/,i=null,o="",c=JSON.parse(localStorage.getItem(a)||"{}");return window.fakeSN=n,{handleKeyboardEvent:function(e){if(!e.target.classList.contains("form-control")||void 0!==e.target.dataset.snAccept){var t=e.which>=48&&e.which<=57,a=e.which>=65&&e.which<=90,r=190===e.which;(t||a||r)&&(o+=r?".":String.fromCharCode(e.which),clearTimeout(i),i=setTimeout(n,50))}},contains:function(e){return!r.test(e)&&!!c[e]},add:function(e){r.test(e)||(c[e._id]=[Date.parse(e.scannedAt),e.prodShiftOrder,e.prodLine],localStorage.setItem(a,JSON.stringify(c)))},clear:function(){c={},localStorage.removeItem(a)},getLocalTaktTime:function(t,n,a){var r=1,i=1,o=t.scannedAt.getTime(),s=new Date(n.get("startedAt")).getTime(),d=(new Date).getHours(),u=n.get("prodLine");Object.keys(c).forEach(function(e){var t=c[e];t[1]===n.id&&(r+=1,s=t[0]),t[2]===u&&new Date(t[0]).getHours()===d&&(i+=1)});var l=o-s;return{result:"SUCCESS",serialNumber:e.assign({taktTime:l,prodShiftOrder:n.id,prodLine:u},t),quantityDone:r,lastTaktTime:l,avgTaktTime:0,hourlyQuantityDone:{index:a,value:i}}}}});