define(["underscore","jquery","app/broker","app/viewport","app/i18n","app/time","app/user","app/data/prodLog","app/data/localStorage","app/production/views/BomCheckerDialogView","app/production/templates/snMessage","i18n!app/nls/production"],function(e,t,n,i,s,a,o,r,d,c,l){"use strict";var u=/[A-Z0-9]{4}\.000000000\.0000/,g=null,p="",h=JSON.parse(d.getItem("PRODUCTION:SN")||"{}"),m={_id:"",count:0,time:0},f=null,S=!1;function w(e){if(e&&(p=e),e=p.trim(),p="","<ESC>"===e||"1337000027"===e)return i.closeAllDialogs();var t=e.match(/P0*([0-9]{9})([0-9]{4})/);t||(t=e.match(/([A-Z0-9]{4}\.([0-9]{9})\.([0-9]{4}))$/))&&/^[A-Z0-9]+\.[0-9]+\.[0-9]+\.[A-Z0-9]+$/.test(e)&&(t=null),t?n.publish("production.taktTime.snScanned",{_id:t[1],scannedAt:new Date,orderNo:t[2],serialNo:+t[3]}):e.length>5&&n.publish("production.taktTime.snScanned",{_id:e,scannedAt:new Date,orderNo:null,serialNo:null})}return window.fakeSN=w,{contains:function(e){return!u.test(e)&&!!h[e]},add:function(e){u.test(e)||(h[e._id]=[Date.parse(e.scannedAt),e.prodShiftOrder,e.prodLine],d.setItem("PRODUCTION:SN",JSON.stringify(h)))},clear:function(){h={},d.removeItem("PRODUCTION:SN")},getLocalTaktTime:function(t,n,i){var s=1,a=1,o=t.scannedAt.getTime(),r=new Date(n.get("startedAt")).getTime(),d=(new Date).getHours(),c=n.get("prodLine");Object.keys(h).forEach(function(e){var t=h[e];t[1]===n.id&&(s+=1,r=t[0]),t[2]===c&&new Date(t[0]).getHours()===d&&(a+=1)});var l=o-r;return{result:"SUCCESS",serialNumber:e.assign({taktTime:l,prodShiftOrder:n.id,prodLine:c},t),quantityDone:s,lastTaktTime:l,avgTaktTime:0,hourlyQuantityDone:{index:i,value:a}}},showMessage:function(n,i,a,o){if(this.view){n||(n={_id:""});var r=t("#snMessage");r.length||(r=t(l()).appendTo("body")).on("click",this.hideMessage.bind(this));var d=n._id.length>43?n._id.substring(0,40)+"...":n._id;!o&&e.includes(["MAX_TOTAL","MAX_LINE"],a)&&(o=18e3),t("#snMessage-text").html("function"==typeof a?a():s("production","snMessage:"+a));var c=0===d.length,u=0===(n.orderNo||"").length,g=0===(n.serialNo||"").length;r.find(".production-snMessage-props").toggleClass("hidden",c&&u&&g),t("#snMessage-scannedValue").text(d).closest(".production-snMessage-prop").toggleClass("hidden",c),t("#snMessage-orderNo").text(n.orderNo||"-").closest(".production-snMessage-prop").toggleClass("hidden",u),t("#snMessage-serialNo").text(n.serialNo||"-").closest(".production-snMessage-prop").toggleClass("hidden",g),r.removeClass("hidden is-info is-success is-error is-warning").addClass("is-"+i),document.body.classList.add("production-snMessage-active"),this.view.timers.hideSnMessage&&clearTimeout(this.view.timers.hideSnMessage),this.view.timers.hideSnMessage=setTimeout(this.hideMessage.bind(this),o||6e3)}},hideMessage:function(){this.view&&(this.view.timers.hideSnMessage&&clearTimeout(this.view.timers.hideSnMessage),this.view.timers.hideSnMessage=null,t("#snMessage").addClass("hidden"),document.body.classList.remove("production-snMessage-active"))},createDynamicLogEntry:function(e){var t={_id:null,instanceId:window.INSTANCE_ID,type:"checkSerialNumber",data:e,createdAt:a.getMoment().toDate(),creator:o.getInfo(),prodLine:window.WMES_LINE_ID,station:window.WMES_STATION||0};return e.sapTaktTime=-1,e.extraPsn=S,t},bind:function(e){var n=this;if(n.view)throw new Error("snManager already bound!");n.view=e;var a=e.destroy;function o(e){var t=e.target.tagName,n="INPUT"===t&&"BUTTON"!==e.target.type||"SELECT"===t||"TEXTAREA"===t;8!==e.keyCode||n&&!e.target.readOnly&&!e.target.disabled||e.preventDefault(),e.target.classList.contains("form-control")&&void 0===e.target.dataset.snAccept||e.key&&1===e.key.length&&(p+=e.key.toUpperCase(),clearTimeout(g),g=setTimeout(w,50))}function d(e){if(e){if(i.currentDialog){if(!(i.currentDialog instanceof c))return;return void(e.orderNo?function(e){var t=i.currentDialog.model.logEntry.data;if(e._id===t._id)return void d();0===e.serialNo&&/^0+$/.test(e.orderNo)||e.orderNo!==t.orderNo?(i.closeAllDialogs(),l(e)):(i.currentDialog.onSnScanned(e),d())}(e):(i.currentDialog.onSnScanned(e),d()))}e.orderNo?l(e):l({_id:"0000.000000000.0000",orderNo:"000000000",serialNo:0,scannedAt:(t=e).scannedAt},t)}else{var t;f&&(f.length?d(f.shift()):f=null)}}function l(t,i){if(e.createCheckSn)e.createCheckSn(t,i,u);else{var s=n.contains(t._id)?"ALREADY_USED":null;s&&n.showMessage(t,"error",s),u(s,n.createDynamicLogEntry(t),i)}}function u(t,a,o){if(t)d();else{var l=e.model,g=l&&l.updateTaktTime&&l.updateTaktTimeLocally;n.showMessage(a.data,"warning","CHECKING"),m._id===a.data._id&&m.count>=2&&a.data.scannedAt-m.time<3e3&&(a.data.skipMaxCheck=!0);var p=e.ajax({method:"POST",url:"/production/checkSerialNumber?bomCheck="+(o?1:0),data:JSON.stringify(a),timeout:6e3});p.fail(function(e){if(e.status<200)return g&&l.updateTaktTimeLocally(a),n.showMessage(a.data,"success","SUCCESS"),void d();g&&a._id&&(a.data.error="SERVER_FAILURE",r.record(l,a)),n.showMessage(a.data,"error","SERVER_FAILURE"),d()}),p.done(function(t){"MAX_TOTAL"===t.result||"MAX_LINE"===t.result?(m._id===a.data._id&&a.data.scannedAt-m.time<3e3?m.count+=1:(m._id=a.data._id,m.count=1),m.time=a.data.scannedAt.getTime()):m._id="","CHECK_BOM"===t.result?function(t,a){n.hideMessage(),a&&(t.logEntry.data._id="0000.000000000.0000",t.logEntry.data.serialNo=0);var o=!1,r=new c({model:t,snMessage:{show:n.showMessage.bind(n),hide:n.hideMessage.bind(n)}});e.listenToOnce(r,"dialog:hidden",function(){o||(o=!0,d())}),e.listenToOnce(r,"dialog:shown",function(){a&&r.onSnScanned(a),o||(o=!0,d())}),e.listenToOnce(r,"checked",function(e){o=!0,i.closeAllDialogs(),u(null,e)}),i.showDialog(r,s("production","bomChecker:title"))}(t,o):"SUCCESS"===t.result?(g&&l.updateTaktTime(t),n.showMessage(t.serialNumber,"success","SUCCESS"),d()):("ALREADY_USED"===t.result&&n.add(t.serialNumber),g&&a._id&&(a.data.error=t.result,r.record(l,a)),n.showMessage(a.data,"error",t.result),d())})}}e.destroy=function(){t(window).off("keydown",o),a.apply(e,arguments)},e.broker.subscribe("production.taktTime.snScanned",function(e){if(n.view&&n.view.onSnScanned)return void n.view.onSnScanned(e);if(f)return void f.push(e);f=[],d(e)}),t(window).on("keydown",o)},isExtraPsnEnabled:function(){return S},toggleExtraPsn:function(){S=!S}}});