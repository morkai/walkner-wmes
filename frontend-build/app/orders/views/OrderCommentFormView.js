define(["underscore","app/user","app/core/views/FormView","app/core/util/idAndLabel","app/orders/templates/commentForm"],function(e,t,a,s,n){"use strict";return a.extend({template:n,updateOnChange:!1,events:e.assign({"change #-delayReason":"handleDelayReason",'change input[name="m4"]':"handleDelayReason"},a.prototype.events),afterRender:function(){a.prototype.afterRender.call(this),this.$id("delayReason").select2({allowClear:!0,placeholder:" ",data:this.delayReasons.filter(function(e){return e.get("active")}).map(s)});var e=t.isAllowedTo("PAINT_SHOP:PAINTER"),n=t.isAllowedTo("PLANNING:WHMAN"),i=e&&n||!e&&!n?"other":n?"wh":"ps";this.$('input[name="source"][value="'+i+'"]').prop("checked",!0),this.$id("comment").val("")},request:function(e){return e.delayReason||(e.delayReason="",e.m4=""),this.ajax({type:"POST",url:"/orders/"+this.model.id,data:JSON.stringify(e)})},handleSuccess:function(){this.$id("comment").val("").focus()},handleDelayReason:function(e){var t=this.$id("delayReason").val(),a=this.$id('input[name="m4"]:checked').val()||"",s=this.delayReasons.get(t),n=!!s,i=t!==(this.model.get("delayReason")||""),o=a!==(this.model.get("m4")||""),l=i||o;if(this.$('input[name="m4"]').prop("required",n).closest(".form-group").find(".control-label").toggleClass("is-required",n),"delayReason"===e.target.name)if(s){var r=s.get("drm"),d=Object.keys(r).filter(function(e){return!!r[e]}).shift()||"man";this.$('input[name="m4"][value="'+d+'"]').prop("checked",!0)}else this.$('input[name="m4"]:checked').prop("checked",!1);this.$id("submit-comment").toggleClass("hidden",l),this.$id("submit-edit").toggleClass("hidden",!l),this.$id("comment").prop("required",!l).prev().toggleClass("is-required",!l)}})});