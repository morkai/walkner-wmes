define(["underscore","app/user","app/core/views/FormView","app/core/util/idAndLabel","app/orders/templates/commentForm"],function(e,t,a,n,s){"use strict";return a.extend({template:s,updateOnChange:!1,events:e.assign({"change #-delayReason":"handleDelayReason",'change input[name="m4"]':"handleDelayReason"},a.prototype.events),afterRender:function(){a.prototype.afterRender.call(this),this.$id("delayReason").select2({allowClear:!0,placeholder:" ",data:this.delayReasons.filter(function(e){return e.get("active")}).map(n)});var e=t.isAllowedTo("PAINT_SHOP:PAINTER"),s=t.isAllowedTo("PLANNING:WHMAN"),o=e&&s||!e&&!s?"other":s?"wh":"ps";this.$('input[name="source"][value="'+o+'"]').prop("checked",!0),this.$id("comment").val(""),this.handleDelayReason()},request:function(e){return e.delayReason?e.delayComponent=(e.delayComponent||"").toUpperCase():(e.delayReason="",e.delayComponent="",e.m4=""),this.ajax({type:"POST",url:"/orders/"+this.model.id,data:JSON.stringify(e)})},handleSuccess:function(){this.$id("comment").val("").focus()},handleDelayReason:function(e){var t=this.$id("delayReason").val(),a=this.$id('input[name="m4"]:checked').val()||"",n=this.delayReasons.get(t),s=!!n,o=t!==(this.model.get("delayReason")||""),i=a!==(this.model.get("m4")||""),l=o||i,d=s&&!!n.get("requireComponent");if(this.$('input[name="m4"]').prop("required",s).closest(".form-group").find(".control-label").toggleClass("is-required",s),this.$id("delayComponent").prop("disabled",!d).closest(".form-group").find(".control-label").toggleClass("is-required",d),e&&"delayReason"===e.target.name)if(n){var r=n.get("drm"),p=Object.keys(r).filter(function(e){return!!r[e]}).shift()||"man";this.$('input[name="m4"][value="'+p+'"]').prop("checked",!0)}else this.$('input[name="m4"]:checked').prop("checked",!1);this.$id("submit-comment").toggleClass("hidden",l),this.$id("submit-edit").toggleClass("hidden",!l),this.$id("comment").prop("required",!l).prev().toggleClass("is-required",!l)}})});