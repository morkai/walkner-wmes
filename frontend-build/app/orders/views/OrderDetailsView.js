// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/user","app/viewport","app/core/views/DetailsView","app/data/orderStatuses","app/orders/templates/details","app/orderStatuses/util/renderOrderStatusLabel"],function(e,t,a,s,i,o,n,r){"use strict";return i.extend({template:n,remoteTopics:{},localTopics:{"orderStatuses.synced":"render"},events:{"click #-changeQtyMax":function(t){function a(){var e=n.model.get("qtyMax")||n.model.get("qty")||0,t=n.model.get("unit")||"PCE";n.$id("qtyMax").text(e.toLocaleString()+" "+t)}function i(){d.remove(),r.removeClass("hidden")}function o(){var e=n.model.get("qtyMax")||0,t=Math.min(9999,Math.max(0,parseInt(d.val(),10)))||0;if(t===n.model.get("qty")&&(t=0),t===e)return i();n.$id("qtyMax").html('<i class="fa fa-spinner fa-spin"></i>'),d.remove(),s.msg.saving();var o=n.ajax({method:"POST",url:"/orders/"+n.model.id,data:JSON.stringify({qtyMax:t})});o.fail(function(){s.msg.savingFailed(),a(),i()}),o.done(function(){s.msg.saved(),i(),n.model.set("qtyMax",t)})}var n=this,r=n.$(t.currentTarget).addClass("hidden"),l=r.closest(".prop-value").css({position:"relative"}),d=e('<input class="form-control" type="number" min="0" max="9999">').val(n.model.get("qtyMax")||n.model.get("qty")||0).css({position:"absolute",top:"-1px",left:0,width:"100px",height:"36px"});return d.on("blur",i),d.on("keyup",function(e){27===e.keyCode?i():13===e.keyCode&&o()}),d.appendTo(l).select(),!1}},serialize:function(){var e=this.model.toJSON(),s=this.delayReasons.get(e.delayReason);return e.statusLabels=o.findAndFill(e.statuses).map(r).join(" "),e.delayReason=s?s.getLabel():null,{idPrefix:this.idPrefix,model:e,panelType:this.options.panelType||"primary",panelTitle:this.options.panelTitle||t("orders","PANEL:TITLE:details"),linkOrderNo:!!this.options.linkOrderNo,showQtyMax:!!this.options.showQtyMax,canChangeQtyMax:!!this.options.showQtyMax&&a.isAllowedTo("ORDERS:MANAGE","FN:master","FN:leader")}}})});