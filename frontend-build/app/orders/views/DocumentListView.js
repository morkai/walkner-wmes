// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/user","app/core/View","app/orders/templates/documentList"],function(e,t,n){"use strict";return window.ORDER_DOCUMENT_PREVIEW_NC15=null,window.ORDER_DOCUMENT_PREVIEW_WINDOW=null,t.extend({template:n,events:{"click a":function(e){e.preventDefault();var t=this,n=e.currentTarget;return!n.dataset.checking&&(e.currentTarget.textContent.trim()===window.ORDER_DOCUMENT_PREVIEW_NC15&&window.ORDER_DOCUMENT_PREVIEW_WINDOW&&!window.ORDER_DOCUMENT_PREVIEW_WINDOW.closed?(window.ORDER_DOCUMENT_PREVIEW_WINDOW.focus(),!1):n.dataset.checked?(t.openDocumentWindow(n),!1):(t.tryOpenDocument(n),!1))}},serialize:function(){return{orderNo:this.model.id,documents:this.model.get("documents").toJSON(),canView:e.isAllowedTo("LOCAL","DOCUMENTS:VIEW")}},beforeRender:function(){this.stopListening(this.model,"change:documents",this.render)},afterRender:function(){this.listenToOnce(this.model,"change:documents",this.render),this.$el.toggleClass("hidden",0===this.model.get("documents").length)},tryOpenDocument:function(e){var t=this;e.dataset.checking=1,t.ajax({method:"HEAD",url:e.href}).fail(function(){e.parentElement.textContent=e.textContent}).done(function(){t.openDocumentWindow(e)}).always(function(){e.dataset.checking="",e.dataset.checked=1})},openDocumentWindow:function(e,t){var n=this,o=!1,i=e.textContent.trim(),r=window.screen,c=.8*r.availWidth,a=.9*r.availHeight,d=Math.floor((r.availWidth-c)/2),s=Math.floor((r.availHeight-a)/2),l="resizable,scrollbars,location=no,top="+s+",left="+d+",width="+Math.floor(c)+",height="+Math.floor(a),E=window.open(e.href,"WMES_ORDER_DOCUMENT_PREVIEW",l);E&&(window.ORDER_DOCUMENT_PREVIEW_NC15=i,window.ORDER_DOCUMENT_PREVIEW_WINDOW=E,n.timers[t]=setInterval(function(){E.closed?(window.ORDER_DOCUMENT_PREVIEW_NC15=null,window.ORDER_DOCUMENT_PREVIEW_WINDOW=null,n.trigger("documentClosed",i),clearInterval(n.timers[t])):!o&&E.ready&&(o=!0,n.trigger("documentOpened",i,E),E.focus())},250))},openBestDocument:function(e,t){var n={};this.model.get("bom").forEach(function(o){var i=o.get("item");t[i]&&Object.keys(t[i]).forEach(function(t){n[t]||(n[t]=i===e?1e3:0),n[t]+=1})});var o=0,i=null;Object.keys(n).forEach(function(e){var t=n[e];t>o&&(o=t,i=e)}),this.$('tr[data-nc15="'+i+'"]').find("a").click()}})});