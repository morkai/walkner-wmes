define(["app/user","app/viewport","app/core/View","app/core/views/DialogView","app/data/loadedModules","./AddDocumentFormView","app/orders/templates/documentList","app/orders/templates/removeDocumentDialog","app/orders/templates/reloadDocumentsDialog"],function(e,t,n,o,i,a,s,r,d){"use strict";var c=null,l=null;return n.extend({template:s,events:{"click a":function(e){e.preventDefault();var t=e.currentTarget;return!t.dataset.checking&&(e.currentTarget.textContent.trim()===c&&l&&!l.closed?(l.focus(),!1):t.dataset.checked?(this.openDocumentWindow(t),!1):(this.tryOpenDocument(t),!1))},"click #-reload":function(){var e=new o({template:d,nlsDomain:this.model.getNlsDomain()});t.showDialog(e,this.t("documents:reload:title")),this.listenTo(e,"answered",function(e){"yes"===e&&this.reloadDocuments()})},"click #-add":function(){var e=new a({model:this.model});t.showDialog(e,this.t("documents:add:title"))},'click .btn[data-action="remove"]':function(e){var n=this.$(e.target).closest("tr")[0].dataset.nc15,i=new o({template:r,model:this.model});t.showDialog(i,this.t("documents:remove:title")),this.listenTo(i,"answered",function(e){"yes"===e&&this.removeDocument(n)})}},initialize:function(){this.once("afterRender",function(){this.listenTo(this.model,"change:documents",this.onChange)})},getTemplateData:function(){return{orderNo:this.model.id,documents:this.model.get("documents").toJSON(),canView:!window.IS_EMBEDDED&&i.isLoaded("orderDocuments")&&e.isAllowedTo("LOCAL","USER","DOCUMENTS:VIEW"),canManage:!window.IS_EMBEDDED&&e.isAllowedTo("ORDERS:MANAGE")}},tryOpenDocument:function(e){var t=this;e.dataset.checking=1,t.ajax({method:"HEAD",url:e.href}).fail(function(){e.parentElement.textContent=e.textContent}).done(function(){t.openDocumentWindow(e)}).always(function(){e.dataset.checking="",e.dataset.checked=1})},openDocumentWindow:function(e){var t=this,n=!1,o=e.textContent.trim(),i=window.screen,a=.8*i.availWidth,s=.9*i.availHeight,r=Math.floor((i.availWidth-a)/2),d="resizable,scrollbars,location=no,top="+Math.floor((i.availHeight-s)/2)+",left="+r+",width="+Math.floor(a)+",height="+Math.floor(s),u="WMES_ORDER_DOCUMENT_PREVIEW",m=window.open(e.href,u,d);m&&(c=o,l=m,clearInterval(t.timers[u]),t.timers[u]=setInterval(function(){m.closed?(c=null,l=null,t.trigger("documentClosed",o),clearInterval(t.timers[u])):!n&&m.ready&&(n=!0,t.trigger("documentOpened",o,m),m.focus())},250))},openBestDocument:function(e,t){var n=this,o={};n.model.get("bom").forEach(function(i){var a=i.get("item");a===e&&t[a]&&Object.keys(t[a]).forEach(function(e){if(!o[e]){o[e]=0;var i=n.model.get("documents").get(e),s=(i&&i.get("name")||"").replace(/[^A-Za-z0-9]+/g,"").toUpperCase();-1!==s.indexOf("ASSEMBL")?o[e]+=10:-1!==s.indexOf("ASS")&&(o[e]+=5),-1!==s.indexOf("QAP")&&(o[e]-=10),-1!==s.indexOf("PALLET")&&(o[e]-=20)}o[e]+=1,t[a][e].forEach(function(t){t.s===a&&(o[e]+=15)})})});var i=0,a=null;Object.keys(o).forEach(function(e){var t=o[e];t>i&&(i=t,a=e)}),n.$('tr[data-nc15="'+a+'"]').find("a").click()},removeDocument:function(e){t.msg.saving();var n=this.model.get("documents").toJSON().filter(function(t){return t.nc15!==e}),o=this.ajax({method:"POST",url:this.model.url(),data:JSON.stringify({documents:n})});o.fail(function(){t.msg.savingFailed()}),o.done(function(){t.msg.saved()})},reloadDocuments:function(){this.$id("reload").prop("disabled",!0),this.ajax({url:"/orderDocuments;fix-missing-docs?order="+this.model.id})},onChange:function(){var t=this.$el.hasClass("hidden"),n=!e.isAllowedTo("ORDERS:MANAGE")&&0===this.model.get("documents").length;this.render(),t!==n&&this.model.trigger("panelToggle")}})});