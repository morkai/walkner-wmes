define(["app/user","app/core/View","app/data/loadedModules","app/orders/templates/documentList"],function(e,t,n,o){"use strict";var a=null,i=null;return t.extend({template:o,events:{"click a":function(e){e.preventDefault();var t=e.currentTarget;return!t.dataset.checking&&(e.currentTarget.textContent.trim()===a&&i&&!i.closed?(i.focus(),!1):t.dataset.checked?(this.openDocumentWindow(t),!1):(this.tryOpenDocument(t),!1))}},initialize:function(){this.once("afterRender",function(){this.listenTo(this.model,"change:documents",this.render)})},getTemplateData:function(){return{orderNo:this.model.id,documents:this.model.get("documents").toJSON(),canView:!window.IS_EMBEDDED&&n.isLoaded("orderDocuments")&&e.isAllowedTo("LOCAL","DOCUMENTS:VIEW")}},tryOpenDocument:function(e){var t=this;e.dataset.checking=1,t.ajax({method:"HEAD",url:e.href}).fail(function(){e.parentElement.textContent=e.textContent}).done(function(){t.openDocumentWindow(e)}).always(function(){e.dataset.checking="",e.dataset.checked=1})},openDocumentWindow:function(e){var t=this,n=!1,o=e.textContent.trim(),r=window.screen,c=.8*r.availWidth,d=.9*r.availHeight,l=Math.floor((r.availWidth-c)/2),s="resizable,scrollbars,location=no,top="+Math.floor((r.availHeight-d)/2)+",left="+l+",width="+Math.floor(c)+",height="+Math.floor(d),u="WMES_ORDER_DOCUMENT_PREVIEW",f=window.open(e.href,u,s);f&&(a=o,i=f,clearInterval(t.timers[u]),t.timers[u]=setInterval(function(){f.closed?(a=null,i=null,t.trigger("documentClosed",o),clearInterval(t.timers[u])):!n&&f.ready&&(n=!0,t.trigger("documentOpened",o,f),f.focus())},250))},openBestDocument:function(e,t){var n=this,o={};n.model.get("bom").forEach(function(a){var i=a.get("item");i===e&&t[i]&&Object.keys(t[i]).forEach(function(e){if(!o[e]){o[e]=0;var a=n.model.get("documents").get(e),r=(a&&a.get("name")||"").replace(/[^A-Za-z0-9]+/g,"").toUpperCase();-1!==r.indexOf("ASSEMBL")?o[e]+=10:-1!==r.indexOf("ASS")&&(o[e]+=5),-1!==r.indexOf("QAP")&&(o[e]-=10),-1!==r.indexOf("PALLET")&&(o[e]-=20)}o[e]+=1,t[i][e].forEach(function(t){t.s===i&&(o[e]+=15)})})});var a=0,i=null;Object.keys(o).forEach(function(e){var t=o[e];t>a&&(a=t,i=e)}),n.$('tr[data-nc15="'+i+'"]').find("a").click()}})});