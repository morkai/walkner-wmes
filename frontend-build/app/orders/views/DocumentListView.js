// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/user","app/core/View","app/orders/templates/documentList"],function(e,t,n){"use strict";return t.extend({template:n,events:{"click a":function(e){var t=e.currentTarget;if(t.dataset.checking)return!1;var n="DOC_"+t.textContent.trim();return t.dataset.checked?!!e.ctrlKey||(window.open(t.href,"DOC_"+n),!1):(this.tryOpenDocument(t,n),!1)}},serialize:function(){return{orderNo:this.model.id,documents:this.model.get("documents").toJSON(),canView:e.isAllowedTo("LOCAL","DOCUMENTS:VIEW")}},beforeRender:function(){this.stopListening(this.model,"change:documents",this.render)},afterRender:function(){this.listenToOnce(this.model,"change:documents",this.render)},tryOpenDocument:function(e,t){e.dataset.checking=1,this.ajax({method:"HEAD",url:e.href}).fail(function(){e.parentElement.textContent=e.textContent}).done(function(){window.open(e.href,"DOC_"+t)}).always(function(){e.dataset.checking="",e.dataset.checked=1})}})});