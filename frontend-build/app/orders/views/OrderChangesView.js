define(["underscore","jquery","app/time","app/i18n","app/viewport","app/user","app/data/orderStatuses","app/data/localStorage","app/core/View","./OrderCommentFormView","./OperationListView","./DocumentListView","./ComponentListView","../Order","../OperationCollection","../DocumentCollection","../ComponentCollection","app/orders/templates/change","app/orders/templates/changes","app/orderStatuses/util/renderOrderStatusLabel","app/core/templates/userInfo"],function(e,t,n,s,a,i,o,r,l,d,h,c,u,m,g,p,f,w,L,v,y){"use strict";return l.extend({template:L,events:{"click .orders-changes-operations":"toggleOperations","click .orders-changes-documents":"toggleDocuments","click .orders-changes-bom":"toggleComponents","mouseover .orders-changes-noTimeAndUser":function(e){var t=this.$(e.target).closest("tbody").children().first();t.find(".orders-changes-time").addClass("is-hovered"),t.find(".orders-changes-user").addClass("is-hovered")},"mouseout .orders-changes-noTimeAndUser":function(){this.$(".is-hovered").removeClass("is-hovered")},"click #-toggleSystemChanges":function(){var e=this.$id("toggleSystemChanges").toggleClass("active").hasClass("active");r.setItem("WMES_NO_SYSTEM_CHANGES",e?"1":"0"),this.$el.toggleClass("orders-no-system-changes",e)},"click .orders-changes-time-editable":function(e){this.$(e.target).closest("form").length||(this.hideTimeEditor(),this.showTimeEditor(e.currentTarget))}},initialize:function(){this.renderPropertyLabel=this.renderPropertyLabel.bind(this),this.renderValueChange=this.renderValueChange.bind(this),this.$lastToggle=null,this.operationListView=null,this.documentListView=null,this.componentListView=null,this.setView("#-commentForm",new d({model:this.model,delayReasons:this.delayReasons})),this.listenTo(this.model,"push:change",this.onChangePush),t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){null!==this.$lastToggle&&(this.$lastToggle.click(),this.$lastToggle=null)},getTemplateData:function(){return{showPanel:!1!==this.options.showPanel,changes:this.serializeChanges(),renderChange:w,renderPropertyLabel:this.renderPropertyLabel,renderValueChange:this.renderValueChange,canEditTime:i.isAllowedTo("ORDERS:MANAGE"),canComment:i.can.commentOrders(),noSystemChanges:"1"===r.getItem("WMES_NO_SYSTEM_CHANGES")}},serializeChanges:function(){return(this.model.get("changes")||[]).map(this.serializeChange,this)},serializeChange:function(t){return(t=e.clone(t)).user||(t.user={id:null,label:"System"}),t.timeEditable=!1,t.timeText=n.format(t.time,"L<br>LTS"),t.userText=y({userInfo:t.user}),t.values=Object.keys(t.oldValues||{}).map(function(e){return t.timeEditable=t.timeEditable||"statuses"===e,{property:e,oldValue:t.oldValues[e],newValue:t.newValues[e]}}),t.comment=e.isEmpty(t.comment)?"":e.escape(t.comment.trim()),"ps"===t.source?t.comment='<i class="fa fa-paint-brush"></i> '+t.comment:"wh"===t.source&&(t.comment='<i class="fa fa-truck"></i> '+t.comment),t.rowSpan=t.values.length+(""===t.comment?0:1),t},beforeRender:function(){this.stopListening(this.model,"change:changes",this.render)},afterRender:function(){this.listenToOnce(this.model,"change:changes",this.render)},renderPropertyLabel:function(e){switch(e.property){case"qtyMax":return this.t("changes:qtyMax",{operationNo:e.newValue.operationNo});case"change":var t=e.newValue.oldIndex+1;return t!==e.newValue.newIndex+1&&(t+="->"+(e.newValue.newIndex+1)),this.t("changes:change",{no:t});default:return this.t("PROPERTY:"+e.property)}},renderValueChange:function(t,a,i){var r=t[i];if(null==r||0===r.length)return"-";switch(t.property){case"operations":return'<a class="orders-changes-operations" data-i="'+a+'" data-property="'+i+'">'+this.t("changes:operations",{count:r.length})+"</a>";case"documents":return'<a class="orders-changes-documents" data-i="'+a+'" data-property="'+i+'">'+this.t("changes:documents",{count:r.length})+"</a>";case"bom":return'<a class="orders-changes-bom" data-i="'+a+'" data-property="'+i+'">'+this.t("changes:bom",{count:r.length})+"</a>";case"statuses":return o.findAndFill(r).map(v).join(" ");case"delayReason":var l=this.delayReasons.get(r);return l?e.escape(l.getLabel()):r;case"startDate":case"finishDate":case"scheduledStartDate":case"scheduledFinishDate":return n.format(r,"LL");case"sapCreatedAt":return n.format(r,"LLL");case"whTime":return n.format(r,"HH:mm");case"whStatus":case"m4":case"psStatus":return this.t(t.property+":"+r);case"qtyMax":return r.value.toLocaleString();case"change":return n.format(r.time,"L LTS");case"etoCont":return s("core","BOOL:"+r);default:return e.escape(String(r))}},hideLastToggle:function(e){return null===this.$lastToggle||(this.$lastToggle[0]!==e.target?(this.$lastToggle.click(),!0):(null!==this.operationListView&&(this.operationListView.remove(),this.operationListView=null),null!==this.documentListView&&(this.documentListView.remove(),this.documentListView=null),null!==this.componentListView&&(this.componentListView.remove(),this.componentListView=null),this.$lastToggle=null,!1))},toggleOperations:function(e){this.hideLastToggle(e)&&this.showLastToggle(e,g,h,"operations","operationListView")},toggleDocuments:function(e){this.hideLastToggle(e)&&this.showLastToggle(e,p,c,"documents","documentListView")},toggleComponents:function(e){this.hideLastToggle(e)&&this.showLastToggle(e,f,u,"bom","componentListView")},showLastToggle:function(e,t,n,s,a){var i=this.$(e.target),o=i.attr("data-i"),r=i.attr("data-property")+"s",l=new t(this.model.get("changes")[o][r][s]),d={};d[s]=l;var h=new n({model:new m(d)}),c=i.closest("tr")[0].offsetTop+i.closest("td").outerHeight()+(!1!==this.options.showPanel?this.$(".panel-heading").first().outerHeight():0);h.render(),h.$el.css("top",c),this.$el.append(h.$el),this.$lastToggle=i,this[a]=h},onChangePush:function(e){var t=this,s=t.$id("table"),a=t.model.get("changes"),i=e.newValues.change;if(t.$id("empty").remove(),i){a[i.oldIndex].time=new Date(i.time).toISOString();var o=t.$('tbody[data-index="'+i.oldIndex+'"]').find(".orders-changes-time");if(o.find("a").length&&(o=o.find("a")),o.html(n.format(i.time,"L<br>LTS")),i.oldIndex!==i.newIndex){a.sort(function(e,t){return Date.parse(e.time)-Date.parse(t.time)}),s.find("tbody").remove();var r="",l=-1;return a.forEach(function(n,s){n===e&&(l=s),r+=t.renderPartialHtml(w,{renderPropertyLabel:t.renderPropertyLabel,renderValueChange:t.renderValueChange,change:t.serializeChange(n),i:s})}),void s.append(r).find("tbody").eq(l).find("td").addClass("highlight")}}t.renderPartial(w,{renderPropertyLabel:t.renderPropertyLabel,renderValueChange:t.renderValueChange,change:t.serializeChange(e),i:a.length}).appendTo(s).find("td").addClass("highlight")},onKeyDown:function(e){"Escape"===e.key&&this.hideTimeEditor()},hideTimeEditor:function(){this.$(".orders-changes-time-editor").remove()},showTimeEditor:function(e){for(var s=this,i="YYYY-MM-DD HH:mm:ss",o=s.$(e),r=+o.closest("tbody")[0].dataset.index,l=s.model.get("changes"),d=l[r],h=null,c=null,u=r-1;u>=0;--u)if(l[u].oldValues.statuses){h=l[u];break}for(var m=r+1;m<l.length;++m)if(l[m].oldValues.statuses){c=l[m];break}var g=n.getMoment(d.time),p=n.getMoment(h?h.time:s.model.get("importTs")),f=n.getMoment(c?c.time:s.model.get("updatedAt")),w=t('<form class="orders-changes-time-editor"></form>'),L=t('<input type="text" class="form-control" required>').val(g.format(i)),v=t('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');function y(e,t){L[0].setCustomValidity(s.t("changes:timeEditor:error:"+e,t)),setTimeout(function(){v.click()})}L.on("input",function(){L[0].setCustomValidity("")}),w.on("submit",function(e){e.preventDefault();var t=n.getMoment(L.val(),i);if(t.valueOf()===g.valueOf())return s.hideTimeEditor();if(!t.isValid())return y("format");if(t.valueOf()<=p.valueOf())return y("min",{time:p.format(i)});if(t.valueOf()>=f.valueOf())return y("max",{time:f.format(i)});a.msg.saving();var o=s.ajax({method:"POST",url:"/orders/"+s.model.id,data:JSON.stringify({change:{index:r,time:t.valueOf()}})});o.fail(function(){a.msg.savingFailed()}),o.done(function(){a.msg.saved(),s.hideTimeEditor()})}),w.append(L).append(v).appendTo(o),L.focus()}})});