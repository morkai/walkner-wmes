// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/time","app/i18n","app/viewport","app/data/orderStatuses","app/core/View","./OrderCommentFormView","./OperationListView","../Order","../OperationCollection","app/orders/templates/change","app/orders/templates/changes","app/orderStatuses/util/renderOrderStatusLabel","app/core/templates/userInfo"],function(e,t,s,n,i,a,r,o,l,h,d,g,u,c,p){"use strict";return r.extend({template:u,events:{"click .orders-changes-operations":"toggleOperations","mouseover .orders-changes-noTimeAndUser":function(e){var t=this.$(e.target).closest("tbody").children().first();t.find(".orders-changes-time").addClass("is-hovered"),t.find(".orders-changes-user").addClass("is-hovered")},"mouseout .orders-changes-noTimeAndUser":function(){this.$(".is-hovered").removeClass("is-hovered")}},initialize:function(){this.$lastToggle=null,this.operationListView=null,this.renderValueChange=this.renderValueChange.bind(this),this.setView(".orders-commentForm-container",new o({model:this.model,delayReasons:this.delayReasons})),this.listenTo(this.model,"push:change",this.onChangePush)},destroy:function(){null!==this.$lastToggle&&(this.$lastToggle.click(),this.$lastToggle=null)},serialize:function(){return{idPrefix:this.idPrefix,showPanel:this.options.showPanel!==!1,changes:this.serializeChanges(),renderChange:g,renderValueChange:this.renderValueChange}},serializeChanges:function(){return(this.model.get("changes")||[]).map(this.serializeChange,this)},serializeChange:function(t){return t.timeText=s.format(t.time,"YYYY-MM-DD<br>HH:mm:ss"),t.userText=p({userInfo:t.user}),t.values=Object.keys(t.oldValues||{}).map(function(e){return{property:e,oldValue:t.oldValues[e],newValue:t.newValues[e]}}),t.comment=e.isEmpty(t.comment)?"":t.comment.trim(),t.rowSpan=t.values.length+(""===t.comment?0:1),t},beforeRender:function(){this.stopListening(this.model,"change:changes",this.render)},afterRender:function(){this.listenToOnce(this.model,"change:changes",this.render)},renderValueChange:function(t,i,r){var o=t[r];if(null==o||0===o.length)return"-";switch(t.property){case"operations":return'<a class="orders-changes-operations" data-i="'+i+'" data-property="'+r+'">'+n("orders","CHANGES:operations",{count:o.length})+"</a>";case"statuses":return a.findAndFill(o).map(c).join("");case"delayReason":var l=this.delayReasons.get(o);return l?e.escape(l.getLabel()):o;case"startDate":case"finishDate":return s.format(o,"LL");default:return e.escape(String(o))}},toggleOperations:function(e){if(null!==this.$lastToggle){if(this.$lastToggle[0]===e.target)return this.$lastToggle=null,this.operationListView.remove(),void(this.operationListView=null);this.$lastToggle.click()}var t=this.$(e.target),s=t.attr("data-i"),n=t.attr("data-property")+"s",i=new d(this.model.get("changes")[s][n].operations),a=new l({model:new h({operations:i})}),r=t.closest("tr")[0].offsetTop+t.closest("td").outerHeight()+(this.options.showPanel!==!1?this.$(".panel-heading").first().outerHeight():0);a.render(),a.$el.css("top",r),this.$el.append(a.$el),this.$lastToggle=t,this.operationListView=a},onChangePush:function(e){var s=t(g({renderValueChange:this.renderValueChange,change:this.serializeChange(e),i:this.model.get("changes").length}));this.$id("empty").remove(),this.$id("table").append(s),s.find("td").addClass("highlight")}})});