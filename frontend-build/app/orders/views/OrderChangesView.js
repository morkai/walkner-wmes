define(["underscore","jquery","app/time","app/i18n","app/viewport","app/user","app/data/orderStatuses","app/data/localStorage","app/core/View","./OrderCommentFormView","./OperationListView","./DocumentListView","./ComponentListView","./NoteListView","../Order","../OperationCollection","../DocumentCollection","../ComponentCollection","app/orders/templates/change","app/orders/templates/changes","app/orderStatuses/util/renderOrderStatusLabel","app/core/templates/userInfo"],function(e,t,s,n,a,r,o,i,l,d,h,c,g,u,m,p,f,y,T,v,w,C){"use strict";return l.extend({template:v,events:{"click .orders-changes-operations":"toggleOperations","click .orders-changes-documents":"toggleDocuments","click .orders-changes-bom":"toggleComponents","click .orders-changes-notes":"toggleNotes","mouseover .orders-changes-noTimeAndUser":function(e){var t=this.$(e.target).closest("tbody").children().first();t.find(".orders-changes-time").addClass("is-hovered"),t.find(".orders-changes-user").addClass("is-hovered")},"mouseout .orders-changes-noTimeAndUser":function(){this.$(".is-hovered").removeClass("is-hovered")},"click #-toggleSystemChanges":function(){var e=this.$id("toggleSystemChanges").toggleClass("active").hasClass("active");i.setItem("WMES_NO_SYSTEM_CHANGES",e?"1":"0"),this.$el.toggleClass("orders-no-system-changes",e)},"click .orders-changes-time-editable":function(e){this.$(e.target).closest("form").length||(this.hideTimeEditor(),this.showTimeEditor(e.currentTarget))}},initialize:function(){this.renderPropertyLabel=this.renderPropertyLabel.bind(this),this.renderValueChange=this.renderValueChange.bind(this),this.$lastToggle=null,this.toggleViews={operations:null,documents:null,bom:null,notes:null},this.setView("#-commentForm",new d({model:this.model,delayReasons:this.delayReasons})),this.listenTo(this.model,"push:change",this.onChangePush),t(window).on("keydown."+this.idPrefix,this.onKeyDown.bind(this))},destroy:function(){null!==this.$lastToggle&&(this.$lastToggle.click(),this.$lastToggle=null)},getTemplateData:function(){return{showPanel:!1!==this.options.showPanel,changes:this.serializeChanges(),renderChange:T,renderPropertyLabel:this.renderPropertyLabel,renderValueChange:this.renderValueChange,canEditTime:r.isAllowedTo("ORDERS:MANAGE"),canComment:r.can.commentOrders(),noSystemChanges:"1"===i.getItem("WMES_NO_SYSTEM_CHANGES")}},serializeChanges:function(){return(this.model.get("changes")||[]).map(this.serializeChange,this)},serializeChange:function(t){return(t=e.clone(t)).user||(t.user={id:null,label:"System"}),t.timeEditable=!1,t.timeText=s.format(t.time,"L<br>LTS"),t.userText=C({userInfo:t.user}),t.values=Object.keys(t.oldValues||{}).map(function(e){return t.timeEditable=t.timeEditable||"statuses"===e,{property:e,oldValue:t.oldValues[e],newValue:t.newValues[e]}}),t.comment=e.isEmpty(t.comment)?"":e.escape(t.comment.trim()),"ps"===t.source?t.comment='<i class="fa fa-paint-brush"></i> '+t.comment:"wh"===t.source&&(t.comment='<i class="fa fa-truck"></i> '+t.comment),t.rowSpan=t.values.length+(""===t.comment?0:1),t},beforeRender:function(){this.stopListening(this.model,"change:changes",this.render)},afterRender:function(){this.listenToOnce(this.model,"change:changes",this.render)},renderPropertyLabel:function(e){switch(e.property){case"qtyMax":return this.t("changes:qtyMax",{operationNo:e.newValue.operationNo});case"change":var t=e.newValue.oldIndex+1;return t!==e.newValue.newIndex+1&&(t+="->"+(e.newValue.newIndex+1)),this.t("changes:change",{no:t});default:return this.t("PROPERTY:"+e.property)}},renderValueChange:function(t,a,r){var i=t[r];if(null==i||0===i.length)return"-";switch(t.property){case"operations":return'<a class="orders-changes-operations" data-i="'+a+'" data-property="'+r+'">'+this.t("changes:operations",{count:i.length})+"</a>";case"documents":return'<a class="orders-changes-documents" data-i="'+a+'" data-property="'+r+'">'+this.t("changes:documents",{count:i.length})+"</a>";case"bom":return'<a class="orders-changes-bom" data-i="'+a+'" data-property="'+r+'">'+this.t("changes:bom",{count:i.length})+"</a>";case"notes":return'<a class="orders-changes-notes" data-i="'+a+'" data-property="'+r+'">'+this.t("changes:notes",{count:i.length})+"</a>";case"statuses":return o.findAndFill(i).map(w).join(" ");case"delayReason":var l=this.delayReasons.get(i);return l?e.escape(l.getLabel()):i;case"startDate":case"finishDate":case"scheduledStartDate":case"scheduledFinishDate":return s.format(i,"LL");case"sapCreatedAt":return s.format(i,"LLL");case"whTime":return s.format(i,"HH:mm");case"whStatus":case"m4":case"psStatus":return this.t(t.property+":"+i);case"qtyMax":return i.value.toLocaleString();case"change":return s.format(i.time,"L LTS");case"etoCont":return n("core","BOOL:"+i);default:return e.escape(String(i))}},hideLastToggle:function(t){if(null===this.$lastToggle)return!0;if(!t||this.$lastToggle[0]!==t.target)return this.$lastToggle.click(),!0;this.$lastToggle=null;var s=this.toggleViews;return e.forEach(s,function(e,t){null!==e&&(e.remove(),s[t]=null)}),!1},toggleOperations:function(e){this.hideLastToggle(e)&&this.showLastToggle(e,p,h,"operations")},toggleDocuments:function(e){this.hideLastToggle(e)&&this.showLastToggle(e,f,c,"documents")},toggleComponents:function(e){this.hideLastToggle(e)&&this.showLastToggle(e,y,g,"bom")},toggleNotes:function(e){this.hideLastToggle(e)&&this.showLastToggle(e,null,u,"notes")},showLastToggle:function(e,t,s,n){var a=this.$(e.target),r=a.attr("data-i"),o=a.attr("data-property")+"s",i=this.model.get("changes")[r][o][n],l=t?new t(i):i,d={};d[n]=l;var h=new s({model:new m(d)}),c=a.closest("tr")[0].offsetTop+a.closest("td").outerHeight()+(!1!==this.options.showPanel?this.$(".panel-heading").first().outerHeight():0);h.render(),h.$el.css("top",c+"px"),this.$el.append(h.$el);var g=a.closest("td")[0].getBoundingClientRect(),u=h.$el.outerWidth(),p=Math.round(g.left-u/2);p<0&&(p=0),h.$el.css("left",p+"px"),this.$lastToggle=a,this.toggleViews[n]=h},onChangePush:function(e){var t=this,n=t.$id("table"),a=t.model.get("changes"),r=e.newValues.change;if(t.$id("empty").remove(),r){a[r.oldIndex].time=new Date(r.time).toISOString();var o=t.$('tbody[data-index="'+r.oldIndex+'"]').find(".orders-changes-time");if(o.find("a").length&&(o=o.find("a")),o.html(s.format(r.time,"L<br>LTS")),r.oldIndex!==r.newIndex){a.sort(function(e,t){return Date.parse(e.time)-Date.parse(t.time)}),n.find("tbody").remove();var i="",l=-1;return a.forEach(function(s,n){s===e&&(l=n),i+=t.renderPartialHtml(T,{renderPropertyLabel:t.renderPropertyLabel,renderValueChange:t.renderValueChange,change:t.serializeChange(s),i:n})}),void n.append(i).find("tbody").eq(l).find("td").addClass("highlight")}}t.renderPartial(T,{renderPropertyLabel:t.renderPropertyLabel,renderValueChange:t.renderValueChange,change:t.serializeChange(e),i:a.length}).appendTo(n).find("td").addClass("highlight")},onKeyDown:function(e){"Escape"===e.key&&(this.hideTimeEditor(),this.hideLastToggle())},hideTimeEditor:function(){this.$(".orders-changes-time-editor").remove()},showTimeEditor:function(e){for(var n=this,r="YYYY-MM-DD HH:mm:ss",o=n.$(e),i=+o.closest("tbody")[0].dataset.index,l=n.model.get("changes"),d=l[i],h=null,c=null,g=i-1;g>=0;--g)if(l[g].oldValues.statuses){h=l[g];break}for(var u=i+1;u<l.length;++u)if(l[u].oldValues.statuses){c=l[u];break}var m=s.getMoment(d.time),p=s.getMoment(h?h.time:n.model.get("importTs")),f=s.getMoment(c?c.time:n.model.get("updatedAt")),y=t('<form class="orders-changes-time-editor"></form>'),T=t('<input type="text" class="form-control" required>').val(m.format(r)),v=t('<button class="btn btn-primary"><i class="fa fa-save"></i></button>');function w(e,t){T[0].setCustomValidity(n.t("changes:timeEditor:error:"+e,t)),setTimeout(function(){v.click()})}T.on("input",function(){T[0].setCustomValidity("")}),y.on("submit",function(e){e.preventDefault();var t=s.getMoment(T.val(),r);if(t.valueOf()===m.valueOf())return n.hideTimeEditor();if(!t.isValid())return w("format");if(t.valueOf()<=p.valueOf())return w("min",{time:p.format(r)});if(t.valueOf()>=f.valueOf())return w("max",{time:f.format(r)});a.msg.saving();var o=n.ajax({method:"POST",url:"/orders/"+n.model.id,data:JSON.stringify({change:{index:i,time:t.valueOf()}})});o.fail(function(){a.msg.savingFailed()}),o.done(function(){a.msg.saved(),n.hideTimeEditor()})}),y.append(T).append(v).appendTo(o),T.focus()}})});