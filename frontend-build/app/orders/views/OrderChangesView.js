define(["underscore","jquery","moment","app/i18n","app/viewport","app/data/orderStatuses","app/core/View","./OperationListView","../Order","../OperationCollection","app/orders/templates/changes","app/orderStatuses/templates/_orderStatus"],function(e,t,n,r,i,o,a,s,u,l,c,d){return a.extend({template:c,events:{"click .orders-changes-more":"showMoreChanges","click .orders-changes-operations":"toggleOperations"},initialize:function(){this.$lastToggle=null,this.operationListView=null},destroy:function(){null!==this.$lastToggle&&this.$lastToggle.click()},serialize:function(){return{changes:(this.model.get("changes")||[]).reverse().map(function(e){return e.timeText=n(e.time).format("YYYY-MM-DD HH:mm:ss"),e.values=Object.keys(e.oldValues||{}).map(function(t){return{property:t,oldValue:e.oldValues[t],newValue:e.newValues[t]}}),e}).filter(function(e){return e.values.length}),renderValueChange:this.renderValueChange}},afterRender:function(){this.listenToOnce(this.model,"change:changes",this.render)},renderValueChange:function(t,i,a){var s=t[a];if(null==s||0===s.length)return"-";switch(t.property){case"operations":return'<a class="orders-changes-operations" data-i="'+i+'" data-property="'+a+'">'+r("orders","CHANGES:operations",{count:s.length})+"</a>";case"statuses":return o.findAndFill(s).map(function(e){return d(e)}).join("");case"startDate":case"finishDate":return n(s).format("LL");default:return e.escape(String(s))}},showMoreChanges:function(){var e=this.$(".orders-changes-page.hidden");e.first().removeClass("hidden"),1===e.length&&this.$(".orders-changes-more").hide()},toggleOperations:function(e){if(null!==this.$lastToggle){if(this.$lastToggle[0]===e.target)return this.$lastToggle=null,this.operationListView.remove(),void 0;this.$lastToggle.click()}var n=t(e.target),r=n.attr("data-i"),i=n.attr("data-property")+"s",o=new l(this.model.get("changes")[r][i].operations),a=new s({model:new u({operations:o})}),c=n.closest("tr")[0].offsetTop+41+31;a.render(),a.$el.css("top",c),this.$el.append(a.$el),this.$lastToggle=n,this.operationListView=a}})});