// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","moment","app/i18n","app/viewport","app/data/orderStatuses","app/core/View","./OperationListView","../Order","../OperationCollection","app/orders/templates/changes","app/orderStatuses/templates/_orderStatus"],function(e,t,r,n,s,a,o,i,l,u,h,c){return o.extend({template:h,events:{"click .orders-changes-more":"showMoreChanges","click .orders-changes-operations":"toggleOperations"},initialize:function(){this.$lastToggle=null,this.operationListView=null},destroy:function(){null!==this.$lastToggle&&this.$lastToggle.click()},serialize:function(){return{changes:(this.model.get("changes")||[]).reverse().map(function(e){return e.timeText=r(e.time).format("YYYY-MM-DD HH:mm:ss"),e.values=Object.keys(e.oldValues||{}).map(function(t){return{property:t,oldValue:e.oldValues[t],newValue:e.newValues[t]}}),e}).filter(function(e){return e.values.length}),renderValueChange:this.renderValueChange}},afterRender:function(){this.listenToOnce(this.model,"change:changes",this.render)},renderValueChange:function(t,s,o){var i=t[o];if(null==i||0===i.length)return"-";switch(t.property){case"operations":return'<a class="orders-changes-operations" data-i="'+s+'" data-property="'+o+'">'+n("orders","CHANGES:operations",{count:i.length})+"</a>";case"statuses":return a.findAndFill(i).map(function(e){return c(e)}).join("");case"startDate":case"finishDate":return r(i).format("LL");default:return e.escape(String(i))}},showMoreChanges:function(){var e=this.$(".orders-changes-page.hidden");e.first().removeClass("hidden"),1===e.length&&this.$(".orders-changes-more").hide()},toggleOperations:function(e){if(null!==this.$lastToggle){if(this.$lastToggle[0]===e.target)return this.$lastToggle=null,void this.operationListView.remove();this.$lastToggle.click()}var r=t(e.target),n=r.attr("data-i"),s=r.attr("data-property")+"s",a=new u(this.model.get("changes")[n][s].operations),o=new i({model:new l({operations:a})}),h=r.closest("tr")[0].offsetTop+41+31;o.render(),o.$el.css("top",h),this.$el.append(o.$el),this.$lastToggle=r,this.operationListView=o}})});