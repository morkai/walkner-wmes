define(["app/user","app/viewport","app/time","app/core/View","app/core/util/decimalSeparator","app/core/templates/userInfo","app/orders/templates/componentList"],function(e,t,n,o,s,i,r){"use strict";return o.extend({template:r,events:{"click .orders-bom-item":function(e){if(this.options.linkDocuments)return this.item=e.currentTarget.textContent.trim(),null===this.contents?this.loadContents():null===this.document?this.trigger("bestDocumentRequested",this.item,this.contents):this.mark(),!1},"mousedown .orders-bom-pfep":function(e){e.preventDefault()},"mouseup .orders-bom-pfep":function(e){t.msg.loading();var n=this,o=n.model.get("nc12"),s=n.ajax({url:"/pfep/entries?select(_id)&nc12=string:"+o});return s.fail(function(){t.msg.loadingFailed()}),s.done(function(s){var i;if(t.msg.loaded(),1===s.totalCount)i="#pfep/entries/"+s.collection[0]._id;else{if(!(s.totalCount>1)){var r=n.$(e.target).closest("td");return void r.html(r.text())}i="#pfep/entries?sort(-rid)&limit(15)&nc12=string:"+o}1===e.button?window.open(i):window.location.href=i}),!1}},initialize:function(){this.item=null,this.document=null,this.window=null,this.contents=null,this.once("afterRender",function(){this.listenTo(this.model,"change:bom change:compRels",this.render)})},getTemplateData:function(){var t=[],o={},r={},a=!1,l=[];return(this.model.get("compRels")||[]).forEach(function(e){e.newComponents.forEach(function(e){r[e._id]||(r[e._id]=[])}),0===e.oldComponents.length&&l.push(e),e.oldComponents.forEach(function(t){o[t._id]||(o[t._id]=[]),o[t._id].push(e),e.newComponents.forEach(function(n){r[n._id].push({compRel:e,oldComponent:t})})})}),this.model.get("bom").forEach(function(e){if(e.get("nc12")){var l=(e=e.toJSON()).qty.toString().split(".");e.qty=[l[0].toString(),l[1]?s+l[1]:""],t.push(e);var m=o[e.nc12];if(m)return a=!0,e.rowClassName="danger",void m.forEach(function(o){o.newComponents.forEach(function(s){t.push({compRel:!0,rowClassName:"success",orderNo:e.orderNo,mrp:e.mrp,nc12:s._id,name:s.name,releasedAt:n.format(o.releasedAt,"L HH:mm"),releasedBy:i({userInfo:o.releasedBy,noIp:!0})})})});var c=r[e.nc12];c&&(a=!0,e.rowClassName="success",c.forEach(function(o){var s=o.compRel;e.releasedAt=n.format(s.releasedAt,"L HH:mm"),e.releasedBy=i({userInfo:s.releasedBy,noIp:!0}),t.push({compRel:!0,rowClassName:"danger",orderNo:e.orderNo,mrp:e.mrp,nc12:o.oldComponent._id,name:o.oldComponent.name})}))}}),l.length&&(a=!0,l.forEach(e=>{e.newComponents.forEach(o=>{t.unshift({compRel:!0,rowClassName:"success",orderNo:"",mrp:"",nc12:o._id,name:o.name,releasedAt:n.format(e.releasedAt,"L HH:mm"),releasedBy:e.releasedBy.label})})})),{colored:a,empty:0===t.length,paint:!!this.options.paint,linkPfep:!!this.options.linkPfep&&e.isAllowedTo("PFEP:VIEW"),bom:t}},afterRender:function(){this.updateItems()},markDocument:function(e,t){this.document=e,this.window=t,null===this.contents?this.loadContents():this.updateItems()},unmarkDocument:function(){this.document=null,this.window=null,this.updateItems()},loadContents:function(){var e=this;e.loadContentsReq||(e.loadContentsReq=e.ajax({url:"/orders/"+e.model.id+"/documentContents"}),e.loadContentsReq.always(function(){e.loadContentsReq=null}),e.loadContentsReq.done(function(t){e.contents=t,null===e.document?e.trigger("bestDocumentRequested",e.item,t):e.updateItems()}))},updateItems:function(){var e=this;e.contents&&(e.$(".orders-bom-item").each(function(){var t=this.textContent.trim();e.contents[t]&&e.contents[t][e.document]&&this.nextElementSibling.textContent.trim().length&&(t="<a>"+t+"</a>"),this.innerHTML=t}),this.mark())},mark:function(){var e=this.window;if(e&&e.showMarks){e&&e.focus();var t=this.item,n=this.document,o=this.contents;t&&n&&o&&o[t]&&e.showMarks(o[t][n]||[])}}})});