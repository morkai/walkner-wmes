define(["app/user","app/viewport","app/time","app/core/View","app/core/util/decimalSeparator","app/core/templates/userInfo","app/orders/templates/componentList"],function(t,e,n,o,i,s,r){"use strict";return o.extend({template:r,events:{"click .orders-bom-item":function(t){if(this.options.linkDocuments)return this.item=t.currentTarget.textContent.trim(),null===this.contents?this.loadContents():null===this.document?this.trigger("bestDocumentRequested",this.item,this.contents):this.mark(),!1},"mousedown .orders-bom-pfep":function(t){t.preventDefault()},"mouseup .orders-bom-pfep":function(t){e.msg.loading();var n=this,o=n.model.get("nc12"),i=n.ajax({url:"/pfep/entries?select(_id)&nc12=string:"+o});return i.fail(function(){e.msg.loadingFailed()}),i.done(function(i){var s;if(e.msg.loaded(),1===i.totalCount)s="#pfep/entries/"+i.collection[0]._id;else{if(!(i.totalCount>1)){var r=n.$(t.target).closest("td");return void r.html(r.text())}s="#pfep/entries?sort(-rid)&limit(15)&nc12=string:"+o}1===t.button?window.open(s):window.location.href=s}),!1}},initialize:function(){this.item=null,this.document=null,this.window=null,this.contents=null,this.once("afterRender",function(){this.listenTo(this.model,"change:bom change:compRels",this.render)})},getTemplateData:function(){var e=[],o={},r={},a=!1;return(this.model.get("compRels")||[]).forEach(function(t){t.newComponents.forEach(function(t){r[t._id]||(r[t._id]=[])}),t.oldComponents.forEach(function(e){o[e._id]||(o[e._id]=[]),o[e._id].push(t),t.newComponents.forEach(function(n){r[n._id].push({compRel:t,oldComponent:e})})})}),this.model.get("bom").forEach(function(t){if(t.get("nc12")){var l=(t=t.toJSON()).qty.toString().split(".");t.qty=[l[0].toString(),l[1]?i+l[1]:""],e.push(t);var c=o[t.nc12];if(c)return a=!0,t.rowClassName="danger",void c.forEach(function(o){o.newComponents.forEach(function(i){e.push({compRel:!0,rowClassName:"success",orderNo:t.orderNo,mrp:t.mrp,nc12:i._id,name:i.name,releasedAt:n.format(o.releasedAt,"L HH:mm"),releasedBy:s({userInfo:o.releasedBy,noIp:!0})})})});var m=r[t.nc12];m&&(a=!0,t.rowClassName="success",m.forEach(function(o){var i=o.compRel;t.releasedAt=n.format(i.releasedAt,"L HH:mm"),t.releasedBy=s({userInfo:i.releasedBy,noIp:!0}),e.push({compRel:!0,rowClassName:"danger",orderNo:t.orderNo,mrp:t.mrp,nc12:o.oldComponent._id,name:o.oldComponent.name})}))}}),{colored:a,empty:0===e.length,paint:!!this.options.paint,linkPfep:!!this.options.linkPfep&&t.isAllowedTo("PFEP:VIEW"),bom:e}},afterRender:function(){this.updateItems()},markDocument:function(t,e){this.document=t,this.window=e,null===this.contents?this.loadContents():this.updateItems()},unmarkDocument:function(){this.document=null,this.window=null,this.updateItems()},loadContents:function(){var t=this;t.loadContentsReq||(t.loadContentsReq=t.ajax({url:"/orders/"+t.model.id+"/documentContents"}),t.loadContentsReq.always(function(){t.loadContentsReq=null}),t.loadContentsReq.done(function(e){t.contents=e,null===t.document?t.trigger("bestDocumentRequested",t.item,e):t.updateItems()}))},updateItems:function(){var t=this;t.contents&&(t.$(".orders-bom-item").each(function(){var e=this.textContent.trim();t.contents[e]&&t.contents[e][t.document]&&this.nextElementSibling.textContent.trim().length&&(e="<a>"+e+"</a>"),this.innerHTML=e}),this.mark())},mark:function(){var t=this.window;if(t&&t.showMarks){t&&t.focus();var e=this.item,n=this.document,o=this.contents;e&&n&&o&&o[e]&&t.showMarks(o[e][n]||[])}}})});