define(["app/user","app/viewport","app/core/View","app/core/util/decimalSeparator","app/orders/templates/componentList"],function(t,n,e,i,o){"use strict";return e.extend({template:o,events:{"click .orders-bom-item":function(t){if(this.options.linkDocuments)return this.item=t.currentTarget.textContent.trim(),null===this.contents?this.loadContents():null===this.document?this.trigger("bestDocumentRequested",this.item,this.contents):this.mark(),!1},"mousedown .orders-bom-pfep":function(t){t.preventDefault()},"mouseup .orders-bom-pfep":function(t){n.msg.loading();var e=this,i=e.model.get("nc12"),o=e.ajax({url:"/pfep/entries?select(_id)&nc12=string:"+i});return o.fail(function(){n.msg.loadingFailed()}),o.done(function(o){var s;if(n.msg.loaded(),1===o.totalCount)s="#pfep/entries/"+o.collection[0]._id;else{if(!(o.totalCount>1)){var r=e.$(t.target).closest("td");return void r.html(r.text())}s="#pfep/entries?sort(-rid)&limit(15)&nc12=string:"+i}1===t.button?window.open(s):window.location.href=s}),!1}},initialize:function(){this.item=null,this.document=null,this.window=null,this.contents=null,this.once("afterRender",function(){this.listenTo(this.model,"change:bom",this.onChange)})},getTemplateData:function(){var n=[];return this.model.get("bom").forEach(function(t){if(t.get("nc12")){var e=(t=t.toJSON()).qty.toString().split(".");t.qty=[e[0].toString(),e[1]?i+e[1]:""],n.push(t)}}),{empty:0===n.length,paint:!!this.options.paint,linkPfep:!!this.options.linkPfep&&t.isAllowedTo("PFEP:VIEW"),bom:n}},afterRender:function(){this.updateItems()},onChange:function(){this.$el.hasClass("hidden")!==(0===this.model.get("bom").length)&&(this.render(),this.model.trigger("panelToggle"))},markDocument:function(t,n){this.document=t,this.window=n,null===this.contents?this.loadContents():this.updateItems()},unmarkDocument:function(){this.document=null,this.window=null,this.updateItems()},loadContents:function(){var t=this;t.loadContentsReq||(t.loadContentsReq=t.ajax({url:"/orders/"+t.model.id+"/documentContents"}),t.loadContentsReq.always(function(){t.loadContentsReq=null}),t.loadContentsReq.done(function(n){t.contents=n,null===t.document?t.trigger("bestDocumentRequested",t.item,n):t.updateItems()}))},updateItems:function(){var t=this;t.contents&&(t.$(".orders-bom-item").each(function(){var n=this.textContent.trim();t.contents[n]&&t.contents[n][t.document]&&this.nextElementSibling.textContent.trim().length&&(n="<a>"+n+"</a>"),this.innerHTML=n}),this.mark())},mark:function(){var t=this.window;if(t&&t.showMarks){t&&t.focus();var n=this.item,e=this.document,i=this.contents;n&&e&&i&&i[n]&&t.showMarks(i[n][e]||[])}}})});