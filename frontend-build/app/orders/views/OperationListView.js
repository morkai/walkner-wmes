// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/decimalSeparator","app/orders/templates/operationList"],function(e,t,i,a,n,o,s){"use strict";function r(e,t){if(e[t]){e[t]=(Math.round(1e3*e[t])/1e3).toLocaleString();var i=e[t].split(o);for(i[1]||(i[1]="");i[1].length<3;)i[1]+="0";e[t]=i.join(o)}else e[t]=""}var p={machineSetupTime:"sapMachineSetupTime",laborSetupTime:"sapLaborSetupTime",machineTime:"sapMachineTime",laborTime:"sapLaborTime"};return n.extend({template:s,events:{'click [data-action="changeQtyMax"]':function(i){function n(){u.remove(),r.removeClass("hidden")}function o(){var t=Math.min(9999,Math.max(0,parseInt(u.val(),10)))||0;if(t===l&&(t=0),t===m)return n();r.html('<i class="fa fa-spinner fa-spin"></i>'),u.remove(),a.msg.saving();var i=s.ajax({method:"POST",url:"/orders/"+s.model.id,data:JSON.stringify({operationNo:c,qtyMax:t})});i.fail(function(){a.msg.savingFailed(),r.text(m.toLocaleString()+" "+(s.model.get("unit")||"PCE")),n()}),i.done(function(){a.msg.saved(),n();var i={};i[c]=t,s.model.set("qtyMax",e.defaults(i,s.model.get("qtyMax")))})}var s=this,r=s.$(i.currentTarget).find("a").addClass("hidden");if(r.length){var p=r.closest("td").css({position:"relative"}),c=r[0].dataset.operationNo,l=+r[0].dataset.qty,m=+r[0].dataset.qtyMax,u=t('<input class="form-control" type="number" min="0" max="9999">').val(m).css({position:"absolute",top:"-1px",left:0,width:"100px",height:"36px"});return u.on("blur",n),u.on("keyup",function(e){27===e.keyCode?n():13===e.keyCode&&o()}),u.appendTo(p).select(),!1}}},serialize:function(){return{operations:this.serializeOperations(),highlighted:this.options.highlighted,timeProps:Object.keys(p),showQtyMax:!!this.options.showQtyMax,canChangeQtyMax:!!this.options.showQtyMax&&i.isAllowedTo("ORDERS:MANAGE","FN:master")}},serializeOperations:function(){var t={};e.forEach(this.options.summedTimes,function(e,i){t[i]=(Math.round(1e3*e)/1e3).toLocaleString()});var i=this.model.get("qtyDone")||{byOperation:{}},a=this.model.get("qtyMax")||{};return this.model.get("operations").toJSON().map(function(e){return e.qtyDone=(i.byOperation||{})[e.no]||0,e.qtyMax=a[e.no]||e.qty||0,e.qtyMaxUnit=e.qtyMax.toLocaleString(),e.unit&&(e.qtyMaxUnit+=" "+e.unit),e.times={actual:{},sap:{},summed:{}},Object.keys(p).forEach(function(i){var a=p[i];r(e,i),r(e,a),e.times.actual[i]=e[i],e.times.sap[i]=e[a],e.times.summed[i]=t[i]}),e}).sort(function(e,t){return e.no-t.no})},beforeRender:function(){this.stopListening(this.model)},afterRender:function(){this.listenToOnce(this.model,"change:operations change:qtyMax change:qtyDone",this.render)}})});