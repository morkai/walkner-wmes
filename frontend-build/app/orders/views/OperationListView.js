define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/decimalSeparator","app/orders/templates/operationList"],function(t,e,i,a,n,o,s){"use strict";var r={machineSetupTime:"sapMachineSetupTime",laborSetupTime:"sapLaborSetupTime",machineTime:"sapMachineTime",laborTime:"sapLaborTime"};function p(t){if(!t)return"";var e=(Math.round(1e3*t)/1e3).toLocaleString().split(o);for(e[1]||(e[1]="");e[1].length<3;)e[1]+="0";return e.join(o)}return n.extend({template:s,nlsDomain:"orders",events:{'click [data-action="changeQtyMax"]':function(i){var n=this,o=n.$(i.currentTarget).find("a").addClass("hidden");if(o.length){var s=o.closest("td").css({position:"relative"}),r=o[0].dataset.operationNo,p=+o[0].dataset.qty,l=+o[0].dataset.qtyMax,h=e('<input class="form-control" type="number" min="0" max="9999">').val(l).css({position:"absolute",top:"-1px",left:0,width:"100px",height:"36px"});return h.on("blur",m),h.on("keyup",function(e){27===e.keyCode?m():13===e.keyCode&&function(){var e=Math.min(9999,Math.max(0,parseInt(h.val(),10)))||0;e===p&&(e=0);if(e===l)return m();o.html('<i class="fa fa-spinner fa-spin"></i>'),h.remove(),a.msg.saving();var i=n.ajax({method:"POST",url:"/orders/"+n.model.id,data:JSON.stringify({operationNo:r,qtyMax:e})});i.fail(function(){a.msg.savingFailed(),o.text(l.toLocaleString()+" "+(n.model.get("unit")||"PCE")),m()}),i.done(function(){a.msg.saved(),m();var i={};i[r]=e,n.model.set("qtyMax",t.defaults(i,n.model.get("qtyMax")))})}()}),h.appendTo(s).select(),!1}function m(){h.remove(),o.removeClass("hidden")}}},initialize:function(){this.once("afterRender",function(){this.listenTo(this.model,"change:operations change:qtyMax change:qtyDone",this.onChange)})},getTemplateData:function(){return{operations:this.serializeOperations(),highlighted:this.options.highlighted,timeProps:Object.keys(r),showQty:!1!==this.options.showQty,showQtyMax:!!this.options.showQtyMax,canChangeQtyMax:!!this.options.showQtyMax&&i.isAllowedTo("ORDERS:MANAGE","FN:master")}},serializeOperations:function(){var t=this.options.summedTimes||{},e=this.model.get("qtyDone")||{byOperation:{}},i=this.model.get("qtyMax")||{};return this.model.get("operations").toJSON().map(function(a){return a.qty||(a.qty=0),a.unit||(a.unit="PCE"),a.qtyDone=(e.byOperation||{})[a.no]||0,a.qtyMax=i[a.no]||a.qty||0,a.qtyMaxUnit=a.qtyMax.toLocaleString()+" "+a.unit,a.times={actual:{},sap:{},summed:{}},Object.keys(r).forEach(function(e){var i=r[e];a.times.actual[e]=p(a[e]),a.times.sap[e]=p(a[i]),a.times.summed[e]=p(t[e])}),a}).sort(function(t,e){return t.no-e.no})},onChange:function(){var t=this.$el.hasClass("hidden"),e=0===this.model.get("operations").length;this.render(),t!==e&&this.model.trigger("panelToggle")}})});