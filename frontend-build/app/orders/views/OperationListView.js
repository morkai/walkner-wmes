define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/decimalSeparator","app/orders/templates/operationList"],function(t,e,i,a,n,o,s){"use strict";var r={machineSetupTime:"sapMachineSetupTime",laborSetupTime:"sapLaborSetupTime",machineTime:"sapMachineTime",laborTime:"sapLaborTime"};function l(t,e){if(t[e]){t[e]=(Math.round(1e3*t[e])/1e3).toLocaleString();var i=t[e].split(o);for(i[1]||(i[1]="");i[1].length<3;)i[1]+="0";t[e]=i.join(o)}else t[e]=""}return n.extend({template:s,events:{'click [data-action="changeQtyMax"]':function(i){var n=this,o=n.$(i.currentTarget).find("a").addClass("hidden");if(o.length){var s=o.closest("td").css({position:"relative"}),r=o[0].dataset.operationNo,l=+o[0].dataset.qty,p=+o[0].dataset.qtyMax,h=e('<input class="form-control" type="number" min="0" max="9999">').val(p).css({position:"absolute",top:"-1px",left:0,width:"100px",height:"36px"});return h.on("blur",c),h.on("keyup",function(e){27===e.keyCode?c():13===e.keyCode&&function(){var e=Math.min(9999,Math.max(0,parseInt(h.val(),10)))||0;e===l&&(e=0);if(e===p)return c();o.html('<i class="fa fa-spinner fa-spin"></i>'),h.remove(),a.msg.saving();var i=n.ajax({method:"POST",url:"/orders/"+n.model.id,data:JSON.stringify({operationNo:r,qtyMax:e})});i.fail(function(){a.msg.savingFailed(),o.text(p.toLocaleString()+" "+(n.model.get("unit")||"PCE")),c()}),i.done(function(){a.msg.saved(),c();var i={};i[r]=e,n.model.set("qtyMax",t.defaults(i,n.model.get("qtyMax")))})}()}),h.appendTo(s).select(),!1}function c(){h.remove(),o.removeClass("hidden")}}},initialize:function(){this.once("afterRender",function(){this.listenTo(this.model,"change:operations change:qtyMax change:qtyDone",this.onChange)})},getTemplateData:function(){return{operations:this.serializeOperations(),highlighted:this.options.highlighted,timeProps:Object.keys(r),showQty:!1!==this.options.showQty,showQtyMax:!!this.options.showQtyMax,canChangeQtyMax:!!this.options.showQtyMax&&i.isAllowedTo("ORDERS:MANAGE","FN:master")}},serializeOperations:function(){var e={};t.forEach(this.options.summedTimes,function(t,i){e[i]=(Math.round(1e3*t)/1e3).toLocaleString()});var i=this.model.get("qtyDone")||{byOperation:{}},a=this.model.get("qtyMax")||{};return this.model.get("operations").toJSON().map(function(t){return t.qty||(t.qty=0),t.unit||(t.unit="PCE"),t.qtyDone=(i.byOperation||{})[t.no]||0,t.qtyMax=a[t.no]||t.qty||0,t.qtyMaxUnit=t.qtyMax.toLocaleString()+" "+t.unit,t.times={actual:{},sap:{},summed:{}},Object.keys(r).forEach(function(i){var a=r[i];l(t,i),l(t,a),t.times.actual[i]=t[i],t.times.sap[i]=t[a],t.times.summed[i]=e[i]}),t}).sort(function(t,e){return t.no-e.no})},onChange:function(){var t=this.$el.hasClass("hidden"),e=0===this.model.get("operations").length;this.render(),t!==e&&this.model.trigger("panelToggle")}})});