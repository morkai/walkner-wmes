// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/decimalSeparator","app/orders/templates/operationList"],function(t,e,i,a,n,o,s){"use strict";function r(t,e){if(t[e]){t[e]=(Math.round(1e3*t[e])/1e3).toLocaleString();var i=t[e].split(o);for(i[1]||(i[1]="");i[1].length<3;)i[1]+="0";t[e]=i.join(o)}else t[e]=""}var p={machineSetupTime:"sapMachineSetupTime",laborSetupTime:"sapLaborSetupTime",machineTime:"sapMachineTime",laborTime:"sapLaborTime"};return n.extend({template:s,events:{'click [data-action="changeQtyMax"]':function(i){function n(){h.remove(),r.removeClass("hidden")}function o(){var e=Math.min(9999,Math.max(0,parseInt(h.val(),10)))||0;if(e===l&&(e=0),e===u)return n();r.html('<i class="fa fa-spinner fa-spin"></i>'),h.remove(),a.msg.saving();var i=s.ajax({method:"POST",url:"/orders/"+s.model.id,data:JSON.stringify({operationNo:c,qtyMax:e})});i.fail(function(){a.msg.savingFailed(),r.text(u.toLocaleString()+" "+(s.model.get("unit")||"PCE")),n()}),i.done(function(){a.msg.saved(),n();var i={};i[c]=e,s.model.set("qtyMax",t.defaults(i,s.model.get("qtyMax")))})}var s=this,r=s.$(i.currentTarget).find("a").addClass("hidden");if(r.length){var p=r.closest("td").css({position:"relative"}),c=r[0].dataset.operationNo,l=+r[0].dataset.qty,u=+r[0].dataset.qtyMax,h=e('<input class="form-control" type="number" min="0" max="9999">').val(u).css({position:"absolute",top:"-1px",left:0,width:"100px",height:"36px"});return h.on("blur",n),h.on("keyup",function(t){27===t.keyCode?n():13===t.keyCode&&o()}),h.appendTo(p).select(),!1}}},serialize:function(){return{operations:this.serializeOperations(),highlighted:this.options.highlighted,timeProps:Object.keys(p),showQty:!1!==this.options.showQty,showQtyMax:!!this.options.showQtyMax,canChangeQtyMax:!!this.options.showQtyMax&&i.isAllowedTo("ORDERS:MANAGE","FN:master")}},serializeOperations:function(){var e={};t.forEach(this.options.summedTimes,function(t,i){e[i]=(Math.round(1e3*t)/1e3).toLocaleString()});var i=this.model.get("qtyDone")||{byOperation:{}},a=this.model.get("qtyMax")||{};return this.model.get("operations").toJSON().map(function(t){return t.qty||(t.qty=0),t.unit||(t.unit="PCE"),t.qtyDone=(i.byOperation||{})[t.no]||0,t.qtyMax=a[t.no]||t.qty||0,t.qtyMaxUnit=t.qtyMax.toLocaleString()+" "+t.unit,t.times={actual:{},sap:{},summed:{}},Object.keys(p).forEach(function(i){var a=p[i];r(t,i),r(t,a),t.times.actual[i]=t[i],t.times.sap[i]=t[a],t.times.summed[i]=e[i]}),t}).sort(function(t,e){return t.no-e.no})},beforeRender:function(){this.stopListening(this.model)},afterRender:function(){this.listenToOnce(this.model,"change:operations change:qtyMax change:qtyDone",this.render)}})});