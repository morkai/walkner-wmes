define(["underscore","moment","js2form","reltime","app/i18n","app/core/View","app/core/util/fixTimeRange","app/orders/templates/filter","i18n!app/nls/events"],function(e,t,i,r,a,n,s,l){return n.extend({template:l,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()},"change input[name=from]":function(e){var t=this.$("input[name=to]");"true"!==t.attr("data-changed")&&t.val(e.target.value)},"change input[name=to]":function(e){e.target.setAttribute("data-changed","true")}},initialize:function(){this.idPrefix=e.uniqueId("orderFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();i(this.el.querySelector(".filter-form"),e)},serializeRqlQuery:function(){var i=this.model.rqlQuery,r={_id:"",nc12:"",date:"finish",from:"",to:"",user:"",limit:i.limit<5?5:i.limit>100?100:i.limit,statuses:[]};return i.selector.args.forEach(function(i){var a=i.args[0];switch(a){case"startDate":case"finishDate":r["ge"===i.name?"from":"to"]=t(i.args[1]).format("YYYY-MM-DD");break;case"_id":case"nc12":var n=i.args[1];r[a]=e.isString(n)?n.replace(/[^0-9]/g,""):"-"}}),r},changeFilter:function(){var e=this.model.rqlQuery,t=s(this.$id("from"),this.$id("to"),"YYYY-MM-DD"),i=[],r=this.$("[name=date]:checked").val()+"Date";this.serializeRegexTerm(i,"_id",9),this.serializeRegexTerm(i,"nc12",12),-1!==t.from&&i.push({name:"ge",args:[r,t.from]}),-1!==t.to&&i.push({name:"le",args:[r,t.to]}),e.selector={name:"and",args:i},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},serializeRegexTerm:function(e,t,i){var r=this.$id(t),a=r.val().trim();"-"!==a&&(a=a.replace(/[^0-9]/g,"")),r.val(a),"-"===a&&(a=null),null===a||a.length===i?e.push({name:"eq",args:[t,a]}):a.length>0&&e.push({name:"regex",args:[t,a]})}})});