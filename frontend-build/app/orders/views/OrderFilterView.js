define(["underscore","moment","js2form","reltime","app/i18n","app/core/View","app/core/util/fixTimeRange","app/orders/templates/filter","i18n!app/nls/events"],function(e,t,n,r,i,o,a,s){return o.extend({template:s,events:{"submit .filter-form":function(e){e.preventDefault(),this.changeFilter()},"change input[name=from]":function(e){var t=this.$("input[name=to]");"true"!==t.attr("data-changed")&&t.val(e.target.value)},"change input[name=to]":function(e){e.target.setAttribute("data-changed","true")}},initialize:function(){this.idPrefix=e.uniqueId("orderFilter")},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){var e=this.serializeRqlQuery();n(this.el.querySelector(".filter-form"),e)},serializeRqlQuery:function(){var n=this.model.rqlQuery,r={_id:"",nc12:"",date:"finish",from:"",to:"",user:"",limit:n.limit<5?5:n.limit>100?100:n.limit,statuses:[]};return n.selector.args.forEach(function(n){var i=n.args[0];switch(i){case"startDate":case"finishDate":r["ge"===n.name?"from":"to"]=t(n.args[1]).format("YYYY-MM-DD");break;case"_id":case"nc12":var o=n.args[1];r[i]=e.isString(o)?o.replace(/[^0-9]/g,""):"-"}}),r},changeFilter:function(){var e=this.model.rqlQuery,t=a(this.$id("from"),this.$id("to"),"YYYY-MM-DD"),n=[],r=this.$("[name=date]:checked").val()+"Date";this.serializeRegexTerm(n,"_id",9),this.serializeRegexTerm(n,"nc12",12),-1!==t.from&&n.push({name:"ge",args:[r,t.from]}),-1!==t.to&&n.push({name:"le",args:[r,t.to]}),e.selector={name:"and",args:n},e.limit=parseInt(this.$id("limit").val(),10)||15,e.skip=0,this.trigger("filterChanged",e)},serializeRegexTerm:function(e,t,n){var r=this.$id(t),i=r.val().trim();"-"!==i&&(i=i.replace(/[^0-9]/g,"")),r.val(i),"-"===i&&(i=null),null===i||i.length===n?e.push({name:"eq",args:[t,i]}):i.length>0&&e.push({name:"regex",args:[t,i]})}})});