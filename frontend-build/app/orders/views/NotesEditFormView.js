define(["app/viewport","app/core/views/FormView","app/orders/templates/notesForm"],function(t,e,s){"use strict";return e.extend({template:s,updateOnChange:!1,events:Object.assign({'click .btn[data-action="up"]':function(t){var e=this.$(t.currentTarget).closest("tr"),s=e.prev();s.length?e.insertBefore(s):e.appendTo(this.$id("notes")),this.recountNotes(),t.currentTarget.focus()},'click .btn[data-action="down"]':function(t){var e=this.$(t.currentTarget).closest("tr"),s=e.next();s.length?e.insertAfter(s):e.prependTo(this.$id("notes")),this.recountNotes(),t.currentTarget.focus()},"click #-add":function(){this.addNote({}),this.serializeNotes()},"click #-clear":function(){this.$id("notes").html(""),this.addNote({}),this.serializeNotes(),this.recountTargets()},"click .btn[data-target]":function(t){var e=t.currentTarget.dataset.target;e!==this.target&&(this.serializeNotes(),this.recountTargets(),this.target=e,this.updateTarget())},"change textarea":function(){this.serializeNotes(),this.recountTargets()},"change select":function(t){t.currentTarget.dataset.value=t.currentTarget.value,this.serializeNotes()}},e.prototype.events),afterRender:function(){e.prototype.afterRender.apply(this,arguments),this.$template=this.$id("notes").children().first().detach(),this.notes||this.cacheNotes(),this.recountTargets(),this.updateTarget()},updateTarget:function(){this.target||(this.target=Object.keys(this.notes)[0]||"docs"),this.$(".active[data-target]").removeClass("active"),this.$('.btn[data-target="'+this.target+'"]').addClass("active");var t=this.notes[this.target];t||(t=this.notes[this.target]=[]),this.$id("notes").html(""),t.forEach(this.addNote,this),""!==t[t.length-1]&&this.addNote({})},cacheNotes:function(){var t=this;t.notes={},(t.model.get("notes")||[]).forEach(function(e){t.notes[e.target]||(t.notes[e.target]=[]),t.notes[e.target].push(e)})},addNote:function(t){var e=this.$id("notes"),s=this.$template.clone(),a=s.find("td"),i=a[1].firstElementChild,r=a[2].firstElementChild;a[0].textContent=e[0].childElementCount+1+".",i.value=t.text||"",r.value=t.priority||"warning",r.dataset.value=r.value,e.append(s)},recountNotes:function(){this.$("tbody > tr > td:first-child").each(function(t){this.textContent=t+1+"."})},recountTargets:function(){var t=this;t.$(".btn[data-target]").each(function(){var e=t.notes[this.dataset.target]||[];this.querySelector(".orders-notes-count").textContent=e.length})},serializeNotes:function(){var t=this,e={},s=[];t.$id("notes").find("tr").each(function(){var a=this.querySelector("textarea").value.trim(),i=a.replace(/[^0-9a-zA-Z]+/,"");i&&!e[i]&&(s.push({target:t.target,priority:this.querySelector("select").value,text:a}),e[i]=!0)}),t.notes[t.target]=s},serializeForm:function(){var t=this;t.serializeNotes();var e=[];return Object.keys(t.notes).forEach(function(s){t.notes[s].forEach(function(t){e.push(t)})}),{notes:e}},request:function(t){return this.ajax({method:"POST",url:this.model.url(),data:JSON.stringify(t)})},handleSuccess:function(){t.closeDialog()}})});