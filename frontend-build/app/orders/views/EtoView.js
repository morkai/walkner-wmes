// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/core/View","app/orders/templates/eto"],function(e,t,o,n){"use strict";return o.extend({template:n,remoteTopics:{"orderDocuments.eto.synced":function(e){e.nc12===this.model.get("nc12")&&this.tryLoadDocument()}},events:{"click #-external":function(){window.open(this.$("iframe").prop("src"),"ETO_"+this.model.id)},"click #-toggle":function(){var e=this.$("iframe"),t=!!e.data("expanded"),o=e[0].contentWindow.document.body,n=o.parentNode.getClientRects()[0].height;o.style.overflowY="scroll",t&&(n=250),e.stop(!0,!1).animate({height:n}).data("expanded",!t),this.$id("toggle").find(".fa").removeClass("fa-chevron-up fa-chevron-down").addClass("fa-chevron-"+(t?"down":"up"))}},serialize:function(){return{idPrefix:this.idPrefix}},afterRender:function(){this.tryLoadDocument()},tryLoadDocument:function(){var e=this,o="/orderDocuments/ETO?order="+e.model.id+"&header=0";if(this.$el.hasClass("orders-eto-loaded"))return void this.$("iframe")[0].contentWindow.location.reload();e.ajax({method:"HEAD",url:o}).fail(function(o){o.status>=500?e.$el.removeClass("panel-default").addClass("panel-danger").find(".fa-spin").removeClass("fa-spin"):e.$(".panel-body").text(t("orders","ETO:NO_DATA"))}).done(function(){e.loadDocument(o)})},loadDocument:function(t){var o=e("<iframe></iframe>").prop("src",t);this.$el.addClass("orders-eto-loaded"),this.$(".panel-body").empty().append(o)}})});