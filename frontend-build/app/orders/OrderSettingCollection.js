// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","../settings/SettingCollection","./OrderSetting"],function(e,t,r,n){"use strict";return r.extend({model:n,topicSuffix:"orders.**",getValue:function(e){var t=this.get("orders."+e);return t?t.getValue():null},prepareValue:function(e,t){return/useCatalog$/.test(e)?!!t:/documents.(path|remoteServer)$/.test(e)?t:/documents.extra$/.test(e)?this.prepareExtraDocumentsValue(t):/operations.groups$/.test(e)?this.prepareOperationGroups(t):/operations.timeCoeffs$/.test(e)?this.prepareOperationTimeCoeffs(t):void 0},prepareExtraDocumentsValue:function(t){var r={},n="";t.split("\n").forEach(function(e){if(e=e.trim(),e.length){var t=e.match(/^([0-9]{15})\s+(.*?)$/);if(t){if(!r[n])return;r[n][t[1]]=t[2]}else n=e,r[n]={}}});var o=[];return e.forEach(r,function(e,t){var r=Object.keys(e);r.length&&(o.push(t),r.forEach(function(t){o.push(t+" "+e[t])}))}),o.join("\n")},prepareOperationGroups:function(e){return e.split("\n").map(function(e){return e.split("|").map(function(e){var t=e.split("@");return{name:t[0].trim(),workCenter:(t[1]||"").trim()}}).filter(function(e){return e.name.length})}).filter(function(e){return e.length>1}).map(function(e){return e.map(function(e){var t=e.name;return e.workCenter.length&&(t+=" @ "+e.workCenter),t}).join(" | ")}).join("\n")},prepareOperationTimeCoeffs:function(e){var t={LABOR:"labor",MACHINE:"machine",LABORSETUP:"laborSetup",MACHINESETUP:"machineSetup"},r={};return e.split("\n").forEach(function(e){for(var t,n={},o=e,a=/((?:labor|machine)(?:setup)?).*?([0-9]+(?:(?:\.|,)[0-9]+)?)/gi,i=0;null!==(t=a.exec(e));)n[t[1].toUpperCase()]=parseFloat(t[2].replace(",",".")),o=o.replace(t[0],""),i+=1;var u=o.split(/[^A-Za-z0-9]/)[0].toUpperCase();i&&u.length&&(r[u]=n)}),Object.keys(r).map(function(e){var n=e+":";return Object.keys(r[e]).forEach(function(o){n+=" "+t[o]+"="+r[e][o]}),n}).join("\n")}})});