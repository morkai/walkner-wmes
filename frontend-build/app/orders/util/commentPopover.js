define(["underscore","jquery","app/i18n","app/broker","app/viewport","app/orders/templates/commentPopover","css!app/orders/assets/commentPopover.css"],function(o,e,n,t,i,r){"use strict";return{isVisible:function(o){return!!o.$commentPopover},hide:function(o,n){var i=o.$commentPopover;if(i){e(document.body).click(),t.publish("orders.commentPopover.hiding",{$menu:i});var r=i.data("options");e(window).off(".commentPopover."+o.idPrefix),e(document.body).off(".commentPopover."+o.idPrefix),i.data("backdrop").remove(),i.removeData("backdrop"),i.removeData("options"),!1===r.animate||!1===n?i.remove():i.fadeOut("fast",function(){i.remove()}),o.$commentPopover=null,t.publish("orders.commentPopover.hidden")}},show:function(o,n,a,d,c){c||(c={});var s=this.hide.bind(this,o);s(!1);var m=e(r({className:c.className||"",top:a}));m.on("mousedown",function(o){if(1!==o.which)return!1;o.stopPropagation()}),m.on("mouseup",function(o){if(1!==o.which)return!1}),m.on("contextmenu",!1),m.on("submit",function(){var e=m.find(".form-control").val().trim();if(!e.length)return s(),!1;if(!e.replace(/[^0-9a-zA-Z]+/g,"").length)return m.find(".form-control").val("").focus(),!1;i.msg.saving();var t=m.find(".btn-primary").prop("disabled",!0),r=o.ajax({method:"POST",url:"/orders/"+n,data:JSON.stringify({comment:e,source:c.source||"other"})});return r.fail(function(){i.msg.savingFailed(),t.prop("disabled",!1)}),r.done(function(){i.msg.saved(),s()}),!1}),m.find(".btn-link").on("click",s),m.find(".form-control").on("keyup",function(o){if(o.ctrlKey&&"Enter"===o.key)return m.find(".btn-primary").click(),!1});var p=e('<div class="planning-menu-backdrop"></div>').one("mousedown",s);m.data("backdrop",p),m.data("options",c),e(window).on("keydown.commentPopover."+o.idPrefix,function(o){if("Escape"===o.key)return s(),!1}),e(document.body).one("mousedown.commentPopover."+o.idPrefix,function(o){c.hideFilter&&!c.hideFilter(o)||s()}).append(p).append(m),o.$commentPopover=m,this.position(o,a,d),!1!==c.autoFocus&&m.find("textarea").focus(),t.publish("orders.commentPopover.shown",{$menu:m})},position:function(e,n,t){if(e.$commentPopover){var i=e.$commentPopover,r=i.outerWidth(),a=i.outerHeight();t+r>=document.body.clientWidth&&(t-=t+r-document.body.clientWidth+5);var d=window.innerHeight+window.pageYOffset;n+a>=d&&(n-=n+a-d+5),i.css({top:n+"px",left:t+"px"}),o.assign(i.data("options"),{top:n,left:t})}}}});