// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/i18n","app/viewport","app/core/util/pageActions","app/core/util/bindLoadingMessage","app/core/View","app/core/templates/jumpAction","app/delayReasons/storage","app/users/ownMrps","../OrderCollection","../views/OrderListView","../views/OrderFilterView","../views/OpenOrdersPrintView","app/core/templates/listPage"],function(e,i,r,t,s,n,o,a,l,d,u,c,p){"use strict";return s.extend({template:p,layoutName:"page",pageId:"orderList",breadcrumbs:[e.bound("orders","BREADCRUMBS:browse")],actions:function(){var r=this;return[{template:function(){return n({nlsDomain:"orders"})},afterRender:function(e){var i=e.find("form");i.submit(r.onJumpFormSubmit.bind(r,i))}},{label:e.bound("orders","PAGE_ACTION:openOrdersPrint"),icon:"print",callback:function(){i.showDialog(new c,e.bound("orders","openOrdersPrint:title"))}},{label:e.bound("orders","PAGE_ACTION:settings"),icon:"cogs",privileges:"ORDERS:MANAGE",href:"#orders;settings"}]},initialize:function(){this.defineModels(),this.defineViews(),this.setView(".filter-container",this.filterView),this.setView(".list-container",this.listView)},destroy:function(){o.release()},defineModels:function(){this.collection=t(new l(null,{rqlQuery:this.options.rql}),this),this.delayReasons=t(o.acquire(),this)},defineViews:function(){this.filterView=new u({model:{rqlQuery:this.collection.rqlQuery}}),this.listView=new d({collection:this.collection,delayReasons:this.delayReasons}),this.listenTo(this.filterView,"filterChanged",this.refreshList)},load:function(e){return e(this.collection.fetch({reset:!0}),this.delayReasons.isEmpty()?this.delayReasons.fetch({reset:!0}):null,a.load(this))},afterRender:function(){o.acquire()},refreshList:function(e){this.collection.rqlQuery=e,this.listView.refreshCollectionNow(),this.broker.publish("router.navigate",{url:this.collection.genClientUrl()+"?"+e,trigger:!1,replace:!0})},onJumpFormSubmit:function(r){var t=r[0].rid;if(t.readOnly)return!1;var s=parseInt(t.value,10);if(isNaN(s)||s<=0)return t.value="",!1;t.readOnly=!0,t.value=s;var n=r.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),o=this,a=o.ajax({method:"HEAD",url:"/orders/"+s});return a.done(function(){o.broker.publish("router.navigate",{url:"/orders/"+s,trigger:!0})}),a.fail(function(){i.msg.show({type:"error",time:2e3,text:e("orders","MSG:jump:404",{rid:s})}),n.removeClass("fa-spinner fa-spin").addClass("fa-search"),t.readOnly=!1,t.select()}),!1}})});