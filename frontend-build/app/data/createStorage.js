define(["app/time","app/broker","app/pubsub"],function(e,t,n){return function(o,a,d){function i(){localStorage.setItem(o,JSON.stringify({time:Date.now(),data:m.models})),t.publish(a+".synced")}var r=window[o]||[],s=JSON.parse(localStorage.getItem(o)||"null");(!s||navigator.onLine)&&(s={time:e.appData,data:r},localStorage.setItem(o,JSON.stringify(s)));var l=s.time>r.time?s:r,m=new d(l);return m.on("add",i),m.on("remove",i),m.on("destroy",i),m.on("change",i),m.on("sync",i),n.subscribe(a+".added",function(e){m.add(e.model)}),n.subscribe(a+".edited",function(e){var t=m.get(e.model._id);t?t.set(e.model):m.add(e.model)}),n.subscribe(a+".deleted",function(e){m.remove(e.model._id)}),m}});