// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/time","app/broker","app/pubsub"],function(e,t,n){"use strict";return n.subscribe("dictionaries.updated",function(e){var n=e.topic,o=e.message,a=e.meta;a.remote=!0,a.json&&"string"==typeof o&&(o=JSON.parse(o)),t.publish(n,o,a)}),function(n,o,a){function d(){localStorage.setItem(n,JSON.stringify({time:Date.now(),data:u.models})),t.publish(o+".synced")}var i={time:e.appData,data:window[n]||[]},s=JSON.parse(localStorage.getItem(n)||"null"),r=s&&s.time>i.time?s:i,u=new a(r.data);return r===i&&d(),u.on("add",d),u.on("remove",d),u.on("destroy",d),u.on("change",d),u.on("sync",d),t.subscribe(o+".added",function(e){u.add(e.model)}),t.subscribe(o+".edited",function(e){var t=u.get(e.model._id);t?t.set(e.model):u.add(e.model)}),t.subscribe(o+".deleted",function(e){u.remove(e.model._id)}),u}});