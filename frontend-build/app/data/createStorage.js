define(["app/time","app/broker","app/pubsub","./localStorage"],function(e,t,d,a){"use strict";return d.subscribe("dictionaries.updated",function(e){var d=e.topic,a=e.message,n=e.meta;n.remote=!0,n.json&&"string"==typeof a&&(a=JSON.parse(a)),t.publish(d,a,n)}),function(d,n,i){var o={time:e.appData,data:window[d]||null},s=JSON.parse(a.getItem(d)||'{"time":0,"data":null}'),r=s&&s.time>o.time||!o.data?s:o,u=new i(r.data);function m(){u.updatedAt=Date.now(),a.setItem(d,JSON.stringify({time:u.updatedAt,data:u.models})),t.publish(n+".synced")}return u.updatedAt=r.time,r!==o&&s.data||m(),u.on("add",m),u.on("remove",m),u.on("destroy",m),u.on("change",m),u.on("sync",m),u.on("reset",m),t.subscribe(n+".added",function(e){u.add(e.model)}),t.subscribe(n+".edited",function(e){var t=u.get(e.model._id);t?t.set(e.model):u.add(e.model)}),t.subscribe(n+".deleted",function(e){u.remove(e.model._id)}),u}});