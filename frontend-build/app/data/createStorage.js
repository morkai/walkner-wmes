define(["app/time","app/broker","app/pubsub"],function(e,t,i){return function(n,o,r){function s(){localStorage.setItem(n,JSON.stringify({time:Date.now(),data:u.models})),t.publish(o+".synced")}var a=window[n]||[],l=JSON.parse(localStorage.getItem(n)||"null");(!l||navigator.onLine)&&(l={time:e.appData,data:a},localStorage.setItem(n,JSON.stringify(l)));var c=l.time>a.time?l:a,u=new r(c);return u.on("add",s),u.on("remove",s),u.on("destroy",s),u.on("change",s),u.on("sync",s),i.subscribe(o+".added",function(e){u.add(e.model)}),i.subscribe(o+".edited",function(e){var t=u.get(e.model._id);t?t.set(e.model):u.add(e.model)}),i.subscribe(o+".deleted",function(e){u.remove(e.model._id)}),u}});