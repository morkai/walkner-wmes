// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["app/time","app/broker","app/pubsub"],function(e,t,d){"use strict";return d.subscribe("dictionaries.updated",function(e){var d=e.topic,a=e.message,n=e.meta;n.remote=!0,n.json&&"string"==typeof a&&(a=JSON.parse(a)),t.publish(d,a,n)}),function(d,a,n){function o(){u.updatedAt=Date.now(),localStorage.setItem(d,JSON.stringify({time:u.updatedAt,data:u.models})),t.publish(a+".synced")}var i={time:e.appData,data:window[d]||null},s=JSON.parse(localStorage.getItem(d)||'{"time":0,"data":null}'),r=s&&s.time>i.time||!i.data?s:i,u=new n(r.data);return u.updatedAt=r.time,r===i&&o(),u.on("add",o),u.on("remove",o),u.on("destroy",o),u.on("change",o),u.on("sync",o),u.on("reset",o),t.subscribe(a+".added",function(e){u.add(e.model)}),t.subscribe(a+".edited",function(e){var t=u.get(e.model._id);t?t.set(e.model):u.add(e.model)}),t.subscribe(a+".deleted",function(e){u.remove(e.model._id)}),u}});