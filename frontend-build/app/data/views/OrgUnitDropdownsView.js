// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/core/View","../divisions","../subdivisions","../mrpControllers","../prodFlows","../workCenters","../prodLines"],function(e,i,n,o,t,r,s,l,d,a){function c(e){return{id:e.id,text:e.getLabel()}}var h={DIVISION:1,SUBDIVISION:2,MRP_CONTROLLER:3,PROD_FLOW:4,WORK_CENTER:5,PROD_LINE:6},p={1:"division",2:"subdivision",3:"mrpController",4:"prodFlow",5:"workCenter",6:"prodLine"},u=function(){return!0};return o.extend({tagName:"div",className:"orgUnitDropdowns",initialize:function(){this.idPrefix=e.uniqueId("orgUnitDropdown")},destroy:function(){this.$('.select2-offscreen[tabindex="-1"]').select2("destroy")},afterRender:function(){0!==this.$el.children().length&&this.$el.empty(),this.options.noGrid!==!0&&this.$el.addClass("row");var e=this.options.orgUnit||h.DIVISION;e>=h.DIVISION&&this.renderDivisionDropdown(),e>=h.SUBDIVISION&&this.renderSubdivisionDropdown(),e>=h.MRP_CONTROLLER&&this.renderMrpControllerDropdown(),e>=h.PROD_FLOW&&this.renderProdFlowDropdown(),e>=h.WORK_CENTER&&this.renderWorkCenterDropdown(),e>=h.PROD_LINE&&this.renderProdLineDropdown()},focus:function(){return this.$id("division").select2("focus"),this},selectValue:function(e,i){var n=!i;switch(i||this.options.orgUnit){case h.DIVISION:this.selectDivision(e,n);break;case h.SUBDIVISION:this.selectSubdivision(e,n);break;case h.MRP_CONTROLLER:this.selectMrpController(e,n);break;case h.PROD_FLOW:this.selectProdFlow(e,n);break;case h.WORK_CENTER:this.selectWorkCenter(e,n);break;case h.PROD_LINE:this.selectProdLine(e,n)}return this},selectDivision:function(e,i){return this.selectModel(e,null,t,"division",i)},selectSubdivision:function(e,i){return this.selectModel(e,"selectDivision",r,"subdivision",i)},selectMrpController:function(e,i){return this.selectModel(e,"selectSubdivision",s,"mrpController",i)},selectProdFlow:function(e,i){return e?e.get("prodFlow")?this.selectModel(e,"selectMrpController",l,"prodFlow",i):e.get("mrpController")?(e=this.selectMrpController(e,i),e&&this.$id("prodFlow").select2("val",null),e):null:null},selectWorkCenter:function(e,i){return this.selectModel(e,"selectProdFlow",d,"workCenter",i)},selectProdLine:function(){throw new Error("TODO")},selectModel:function(e,i,n,o,t){if(!e)return null;var r=e.get(o);Array.isArray(r)&&(r=r[0]);var s=n.get(r);return null!==i&&(s=this[i](s,t)),s?(this.$id(o).select2("val",r).trigger({type:"change",val:r,selectFirst:t}),e):null},createDropdownElement:function(e,o){var t=this.idPrefix+"-"+e,r=i('<div class="form-group"><label for="'+t+'">'+n("core","ORG_UNIT:"+e)+'</label><input id="'+t+'" name="'+e+'"></div>');return this.options.noGrid!==!0&&r.addClass("col-lg-"+Math.floor(12/this.options.orgUnit)),r.appendTo(this.el).find("input").select2({data:o||[],placeholder:" ",allowClear:this.options.allowClear||this.options.orgUnit===h.PROD_FLOW,multiple:this.options.multiple&&e===p[this.options.orgUnit]})},onChange:function(e,i,n,o){var t=[];null!==o.val&&(t=i.filter(function(e){var i=e.get(n);return Array.isArray(i)?-1!==i.indexOf(o.val):i===o.val}).map(c));var r={data:t,placeholder:" ",allowClear:!!this.options.allowClear||"mrpController"===n&&this.options.orgUnit===h.PROD_FLOW,multiple:this.options.multiple&&e.attr("name")===p[this.options.orgUnit]};e.select2("val",null),e.select2(r),t.length&&o.selectFirst!==!1&&e.select2("val",t[0].id),e.trigger({type:"change",val:t.length?t[0].id:null})},renderDivisionDropdown:function(){this.createDropdownElement("division",t.filter(this.options.divisionFilter||u).map(c))},renderSubdivisionDropdown:function(){var e=this.createDropdownElement("subdivision");this.$id("division").on("change",this.onChange.bind(this,e,r,"division"))},renderMrpControllerDropdown:function(){var e=this.createDropdownElement("mrpController");this.$id("subdivision").on("change",this.onChange.bind(this,e,s,"subdivision"))},renderProdFlowDropdown:function(){var e=this.createDropdownElement("prodFlow");this.$id("mrpController").on("change",this.onChange.bind(this,e,l,"mrpController"))},renderWorkCenterDropdown:function(){var e=this.createDropdownElement("workCenter");this.$id("prodFlow").on("change",this.onChange.bind(this,e,d,"prodFlow"))},renderProdLineDropdown:function(){var e=this.createDropdownElement("prodLine");this.$id("workCenter").on("change",this.onChange.bind(this,e,a,"prodLine"))}},{ORG_UNIT:h})});