// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,o,r,i,l,a){"use strict";function u(){if(null!==f){var e=localStorage.getItem(p);null===e?localStorage.setItem(p,f):localStorage.setItem(p,f+"\n"+e),f=null,localStorage.removeItem(m),i.publish("production.synced",{message:"DISCONNECT"})}}function c(e){if(S&&null===f&&!a.isRestarting()&&(f=localStorage.getItem(p),null!==f)){var n=localStorage.getItem(m);null!==n&&(f=n+"\n"+f),localStorage.setItem(m,f),localStorage.removeItem(p),i.publish("production.syncing");var o=t.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:f,timeout:1e4});o.fail(function(t){var n=localStorage.getItem(p);n=null===n?f:f+"\n"+n,localStorage.setItem(p,n),localStorage.removeItem(m),f=null,i.publish("production.synced",{message:t.responseText}),e=e?e+1:1,setTimeout(c,Math.min(1e3*e,2e4),e)}),o.done(function(e){localStorage.removeItem(m),f=null,i.publish("production.synced",null),e&&e.lock&&i.publish("production.locked",e.lock),setTimeout(c,100)})}}function s(e){for(var t=0,n=0,o=e.length;n<o;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function d(e,t){return e.getTime().toString(36)+s(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var g=Math.round(Date.now()+9999999*Math.random()).toString(36).toUpperCase(),p="PRODUCTION:LOG",m="PRODUCTION:LOG:SYNCING",I="PRODUCTION:LOCK",f=null,S=!1,v=null,h=null,b=e.debounce(c,33);return i.subscribe("socket.connected",setTimeout.bind(null,c,1337)),window.addEventListener("unload",u),{generateId:d,isEnabled:function(){return S},enable:function(e){function t(){localStorage.setItem(I,JSON.stringify({instanceId:g,time:Date.now()}))}function n(){v=null,e&&"pending"===e.state()&&(S=!0,setTimeout(c,1e3),e.resolve())}function o(t){if(t.key===I){var n=JSON.parse(t.newValue);n.instanceId!==g&&(e?(e.reject(),e=null):i.publish("production.duplicateDetected",{thisInstanceId:g,thatInstanceId:n.instanceId}))}}return S?void(e&&(v=setTimeout(function(){v=null,e.resolve()},1))):e?(h&&clearInterval(h),v&&clearTimeout(v),window.removeEventListener("storage",o),window.addEventListener("storage",o),h=setInterval(t,333),void(v=setTimeout(n,2e3))):void(S=!0)},disable:function(){S&&(v&&(clearTimeout(v),v=null),h&&(clearInterval(h),h=null),S=!1)},isSyncing:function(){return null!==f},record:function(e,t,n){if(!e.isLocked()){if(!S)throw new Error("Production log is disabled!");var i={_id:null,instanceId:g,secretKey:e.getSecretKey(),type:t,data:n||{},createdAt:r.getMoment().toDate(),creator:o.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};i._id=d(i.createdAt,e.id);var l,a=localStorage.getItem(p);l=null===a?JSON.stringify(i):a+"\n"+JSON.stringify(i),localStorage.setItem(p,l),e.saveLocalData(),b()}}}});