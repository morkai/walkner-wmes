// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,o,r,i,l,a){"use strict";function u(){if(null!==I){var e=localStorage.getItem(p);null===e?localStorage.setItem(p,I):localStorage.setItem(p,I+"\n"+e),I=null,localStorage.removeItem(m),i.publish("production.synced",{message:"DISCONNECT"})}}function c(e){if(S&&null===I&&!a.isRestarting()&&(I=localStorage.getItem(p),null!==I)){var n=localStorage.getItem(m);null!==n&&(I=n+"\n"+I),localStorage.setItem(m,I),localStorage.removeItem(p),i.publish("production.syncing");var o=t.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:I,timeout:1e4});o.fail(function(t){var n=localStorage.getItem(p);n=null===n?I:I+"\n"+n,localStorage.setItem(p,n),localStorage.removeItem(m),I=null,i.publish("production.synced",{message:t.responseText}),e=e?e+1:1,setTimeout(c,Math.min(1e3*e,2e4),e)}),o.done(function(e){localStorage.removeItem(m),I=null,i.publish("production.synced",null),e&&e.lock&&i.publish("production.locked",e.lock),setTimeout(c,100)})}}function d(e){for(var t=0,n=0,o=e.length;o>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function s(e,t){return e.getTime().toString(36)+d(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var g=Math.round(Date.now()+9999999*Math.random()).toString(36).toUpperCase(),p="PRODUCTION:LOG",m="PRODUCTION:LOG:SYNCING",f="PRODUCTION:LOCK",I=null,S=!1,v=null,h=null,w=e.debounce(c,33);return i.subscribe("socket.connected",setTimeout.bind(null,c,1337)),window.addEventListener("unload",u),{generateId:s,isEnabled:function(){return S},enable:function(e){function t(){localStorage.setItem(f,JSON.stringify({instanceId:g,time:Date.now()}))}function n(){v=null,e&&"pending"===e.state()&&(S=!0,setTimeout(c,1e3),e.resolve())}function o(t){if(t.key===f){var n=JSON.parse(t.newValue);n.instanceId!==g&&(e?(e.reject(),e=null):i.publish("production.duplicateDetected",{thisInstanceId:g,thatInstanceId:n.instanceId}))}}if(S)return void(e&&(v=setTimeout(function(){v=null,e.resolve()},1)));if(!e)return void(S=!0);h&&clearInterval(h),v&&clearTimeout(v),window.removeEventListener("storage",o),window.addEventListener("storage",o);var r=window.parent!==window;h=setInterval(t,r?333333:333),v=setTimeout(n,r?1:2e3)},disable:function(){S&&(v&&(clearTimeout(v),v=null),h&&(clearInterval(h),h=null),S=!1)},isSyncing:function(){return null!==I},record:function(e,t,n){if(!e.isLocked()){if(!S)throw new Error("Production log is disabled!");var i={_id:null,instanceId:g,secretKey:e.getSecretKey(),type:t,data:n||{},createdAt:r.getMoment().toDate(),creator:o.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};i._id=s(i.createdAt,e.id);var l,a=localStorage.getItem(p);l=null===a?JSON.stringify(i):a+"\n"+JSON.stringify(i),localStorage.setItem(p,l),e.saveLocalData(),w()}}}});