// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,o,r,i,l){"use strict";function a(){if(null!==f){var e=localStorage.getItem(g);null===e?localStorage.setItem(g,f):localStorage.setItem(g,f+"\n"+e),f=null,localStorage.removeItem(p),r.publish("production.synced",{message:"DISCONNECT"})}}function u(t){if(S&&null===f&&!l.isRestarting()&&(f=localStorage.getItem(g),null!==f)){var n=localStorage.getItem(p);null!==n&&(f=n+"\n"+f),localStorage.setItem(p,f),localStorage.removeItem(g),r.publish("production.syncing");var o=e.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:f,timeout:1e4});o.fail(function(e){var n=localStorage.getItem(g);n=null===n?f:f+"\n"+n,localStorage.setItem(g,n),localStorage.removeItem(p),f=null,r.publish("production.synced",{message:e.responseText}),t=t?t+1:1,setTimeout(u,Math.min(1e3*t,2e4),t)}),o.done(function(e){localStorage.removeItem(p),f=null,r.publish("production.synced",null),e&&e.lock&&r.publish("production.locked",e.lock),setTimeout(u,100)})}}function s(e){for(var t=0,n=0,o=e.length;o>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function c(e,t){return e.getTime().toString(36)+s(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var d=Math.round(Date.now()+9999999*Math.random()).toString(36).toUpperCase(),g="PRODUCTION:LOG",p="PRODUCTION:LOG:SYNCING",m="PRODUCTION:LOCK",f=null,S=!1,v=null,I=null;return r.subscribe("socket.connected",setTimeout.bind(null,u,1337)),window.addEventListener("unload",a),{generateId:c,isEnabled:function(){return S},enable:function(e){function t(t){if(t.key===m){var n=JSON.parse(t.newValue);n.instanceId!==d&&e.reject()}}return S?void(e&&(v=setTimeout(function(){v=null,e.resolve()},1))):e?(window.addEventListener("storage",t),I=setInterval(function(){localStorage.setItem(m,JSON.stringify({instanceId:d,time:Date.now()}))},333),void(v=setTimeout(function(){v=null,window.removeEventListener("storage",t),"pending"===e.state()&&(S=!0,setTimeout(u,1e3),e.resolve())},2e3))):void(S=!0)},disable:function(){S&&(null!==v&&(clearTimeout(v),v=null),null!==I&&(clearInterval(I),I=null),S=!1)},isSyncing:function(){return null!==f},record:function(e,t,r){if(!e.isLocked()){if(!S)throw new Error("Production log is disabled!");var i={instanceId:d,secretKey:e.getSecretKey(),type:t,data:r||{},createdAt:o.getMoment().toDate(),creator:n.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};i._id=c(i.createdAt,e.id);var l,a=localStorage.getItem(g);l=null===a?JSON.stringify(i):a+"\n"+JSON.stringify(i),localStorage.setItem(g,l),e.saveLocalData(),u()}}}});