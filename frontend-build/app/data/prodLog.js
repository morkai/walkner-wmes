// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/data/localStorage","app/updater/index"],function(e,t,n,i,o,r,l,u,d){"use strict";function a(){if(null!==w){var e=u.getItem(I);null===e?u.setItem(I,w):u.setItem(I,w+"\n"+e),w=null,u.removeItem(g),r.publish("production.synced",{message:"DISCONNECT"})}}function s(e){if(h&&null===w&&!d.isRestarting()&&(w=u.getItem(I),null!==w)){var n=u.getItem(g);null!==n&&(w=n+"\n"+w),u.setItem(g,w),u.removeItem(I),r.publish("production.syncing");var i=t.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:w,timeout:1e4});i.fail(function(t){var n=u.getItem(I);n=null===n?w:w+"\n"+n,u.setItem(I,n),u.removeItem(g),w=null,r.publish("production.synced",{message:t.responseText}),e=e?e+1:1,setTimeout(s,Math.min(1e3*e,2e4),e)}),i.done(function(e){u.removeItem(g),w=null,r.publish("production.synced",null),e&&e.lock&&r.publish("production.locked",e.lock),setTimeout(s,100)})}}function c(e){for(var t=0,n=0,i=e.length;n<i;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function p(e,t){return e.getTime().toString(36)+c(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}function m(e,t,n,r){return r||(r=o.getMoment().toDate()),{_id:p(r,e.id),instanceId:f,secretKey:e.getSecretKey(),type:t,data:n||{},createdAt:r,creator:i.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null}}var f=window.INSTANCE_ID,I="PRODUCTION:LOG",g="PRODUCTION:LOG:SYNCING",v="PRODUCTION:LOCK",w=null,h=!1,b=null,T=null,O=e.debounce(s,33);return r.subscribe("socket.connected",setTimeout.bind(null,s,1337)),window.addEventListener("unload",a),{generateId:p,isEnabled:function(){return h},enable:function(e){function t(){u.setItem(v,JSON.stringify({instanceId:f,time:Date.now()}))}function n(){b=null,e&&"pending"===e.state()&&(h=!0,setTimeout(s,1e3),e.resolve())}function i(t){if(t.key===v){var n=JSON.parse(t.newValue);n.instanceId!==f&&(e?(e.reject(),e=null):r.publish("production.duplicateDetected",{thisInstanceId:f,thatInstanceId:n.instanceId}))}}if(h)return void(e&&(b=setTimeout(function(){b=null,e.resolve()},1)));if(!e)return void(h=!0);T&&clearInterval(T),b&&clearTimeout(b),window.removeEventListener("storage",i),window.addEventListener("storage",i);var o=window.parent!==window||"development"===window.ENV;T=setInterval(t,o?333333:333),b=setTimeout(n,o?1:2e3)},disable:function(){h&&(b&&(clearTimeout(b),b=null),T&&(clearInterval(T),T=null),h=!1)},isSyncing:function(){return null!==w},create:m,record:function(e,t,n,i){if(!e.isLocked()){if(!h)throw new Error("Production log is disabled!");var o,r="object"==typeof t?t:m(e,t,n,i),l=u.getItem(I);o=null===l?JSON.stringify(r):l+"\n"+JSON.stringify(r),u.setItem(I,o),e.saveLocalData(),O()}}}});