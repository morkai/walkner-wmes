define(["underscore","jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/data/localStorage","app/updater/index"],function(e,t,n,i,o,r,l,u,s){"use strict";var a=window.INSTANCE_ID,d="PRODUCTION:LOG",c="PRODUCTION:LOG:SYNCING",p="PRODUCTION:LOCK",m=null,I=!1,f=null,g=null,v=e.debounce(w,33);function w(e){if(I&&null===m&&!s.isRestarting()&&null!==(m=u.getItem(d)||null)){var n=u.getItem(c)||null;null!==n&&(m=n+"\n"+m),u.setItem(c,m),u.setItem(d,""),u.removeItem(d),r.publish("production.syncing");var i=t.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:m,timeout:1e4});i.fail(function(t){var n=u.getItem(d)||null;n=null===n?m:m+"\n"+n,u.setItem(d,n),u.setItem(c,""),u.removeItem(c),m=null,r.publish("production.synced",{message:t.responseText}),e=e?e+1:1,setTimeout(w,Math.min(1e3*e,2e4),e)}),i.done(function(e){u.setItem(c,""),u.removeItem(c),m=null,r.publish("production.synced",null),e&&e.lock&&r.publish("production.locked",e.lock),setTimeout(w,100)})}}function h(e,t){return e.getTime().toString(36)+function(e){for(var t=0,n=0,i=e.length;n<i;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}function b(e,t,n,r){return r||(r=o.getMoment().toDate()),{_id:h(r,e.id),instanceId:a,secretKey:e.getSecretKey(),type:t,data:n||{},createdAt:r,creator:i.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,station:e.prodLine.station,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null}}return r.subscribe("socket.connected",setTimeout.bind(null,w,1337)),window.addEventListener("unload",function(){if(null===m)return;var e=u.getItem(d);null===e?u.setItem(d,m):u.setItem(d,m+"\n"+e);m=null,u.setItem(c,""),u.removeItem(c),r.publish("production.synced",{message:"DISCONNECT"})}),{generateId:h,isEnabled:function(){return I},enable:function(e){if(I)e&&(f=setTimeout(function(){f=null,e.resolve()},1));else if(e){g&&clearInterval(g),f&&clearTimeout(f),window.removeEventListener("storage",n),window.addEventListener("storage",n);var t=window.parent!==window||"development"===window.ENV;g=setInterval(function(){u.setItem(p,JSON.stringify({instanceId:a,time:Date.now()}))},t?333333:333),f=setTimeout(function(){f=null,e&&"pending"===e.state()&&(I=!0,setTimeout(w,1e3),e.resolve())},t?1:2e3)}else I=!0;function n(t){if(t.key===p){var n=JSON.parse(t.newValue);n.instanceId!==a&&(e?(e.reject(),e=null):r.publish("production.duplicateDetected",{thisInstanceId:a,thatInstanceId:n.instanceId}))}}},disable:function(){I&&(f&&(clearTimeout(f),f=null),g&&(clearInterval(g),g=null),I=!1)},isSyncing:function(){return null!==m},create:b,record:function(e,t,n,i){if(!e.isLocked()){if(!I)throw new Error("Production log is disabled!");var o,r="object"==typeof t?t:b(e,t,n,i),l=u.getItem(d);o=null===l?JSON.stringify(r):l+"\n"+JSON.stringify(r),u.setItem(d,o),e.saveLocalData(),v()}}}});