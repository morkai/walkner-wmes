// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,o,r,i,l,a){"use strict";function u(){if(null!==S){var e=localStorage.getItem(p);null===e?localStorage.setItem(p,S):localStorage.setItem(p,S+"\n"+e),S=null,localStorage.removeItem(m),i.publish("production.synced",{message:"DISCONNECT"})}}function s(e){if(v&&null===S&&!a.isRestarting()&&(S=localStorage.getItem(p),null!==S)){var n=localStorage.getItem(m);null!==n&&(S=n+"\n"+S),localStorage.setItem(m,S),localStorage.removeItem(p),i.publish("production.syncing");var o=t.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:S,timeout:1e4});o.fail(function(t){var n=localStorage.getItem(p);n=null===n?S:S+"\n"+n,localStorage.setItem(p,n),localStorage.removeItem(m),S=null,i.publish("production.synced",{message:t.responseText}),e=e?e+1:1,setTimeout(s,Math.min(1e3*e,2e4),e)}),o.done(function(e){localStorage.removeItem(m),S=null,i.publish("production.synced",null),e&&e.lock&&i.publish("production.locked",e.lock),setTimeout(s,100)})}}function c(e){for(var t=0,n=0,o=e.length;o>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function d(e,t){return e.getTime().toString(36)+c(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var g=Math.round(Date.now()+9999999*Math.random()).toString(36).toUpperCase(),p="PRODUCTION:LOG",m="PRODUCTION:LOG:SYNCING",f="PRODUCTION:LOCK",S=null,v=!1,I=null,h=null,O=e.debounce(s,33);return i.subscribe("socket.connected",setTimeout.bind(null,s,1337)),window.addEventListener("unload",u),{generateId:d,isEnabled:function(){return v},enable:function(e){function t(t){if(t.key===f){var n=JSON.parse(t.newValue);n.instanceId!==g&&e.reject()}}return v?void(e&&(I=setTimeout(function(){I=null,e.resolve()},1))):e?(window.addEventListener("storage",t),h=setInterval(function(){localStorage.setItem(f,JSON.stringify({instanceId:g,time:Date.now()}))},333),void(I=setTimeout(function(){I=null,window.removeEventListener("storage",t),"pending"===e.state()&&(v=!0,setTimeout(s,1e3),e.resolve())},2e3))):void(v=!0)},disable:function(){v&&(null!==I&&(clearTimeout(I),I=null),null!==h&&(clearInterval(h),h=null),v=!1)},isSyncing:function(){return null!==S},record:function(e,t,n){if(!e.isLocked()){if(!v)throw new Error("Production log is disabled!");var i={instanceId:g,secretKey:e.getSecretKey(),type:t,data:n||{},createdAt:r.getMoment().toDate(),creator:o.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};i._id=d(i.createdAt,e.id);var l,a=localStorage.getItem(p);l=null===a?JSON.stringify(i):a+"\n"+JSON.stringify(i),localStorage.setItem(p,l),e.saveLocalData(),O()}}}});