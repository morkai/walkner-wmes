// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/data/localStorage","app/updater/index"],function(e,t,n,o,i,r,l,u,a){"use strict";function d(){if(null!==h){var e=u.getItem(g);null===e?u.setItem(g,h):u.setItem(g,h+"\n"+e),h=null,u.removeItem(I),r.publish("production.synced",{message:"DISCONNECT"})}}function s(e){if(w&&null===h&&!a.isRestarting()&&(h=u.getItem(g),null!==h)){var n=u.getItem(I);null!==n&&(h=n+"\n"+h),u.setItem(I,h),u.removeItem(g),r.publish("production.syncing");var o=t.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:h,timeout:1e4});o.fail(function(t){var n=u.getItem(g);n=null===n?h:h+"\n"+n,u.setItem(g,n),u.removeItem(I),h=null,r.publish("production.synced",{message:t.responseText}),e=e?e+1:1,setTimeout(s,Math.min(1e3*e,2e4),e)}),o.done(function(e){u.removeItem(I),h=null,r.publish("production.synced",null),e&&e.lock&&r.publish("production.locked",e.lock),setTimeout(s,100)})}}function c(e){for(var t=0,n=0,o=e.length;o>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function p(e,t){return e.getTime().toString(36)+c(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}function m(e,t,n){var r=i.getMoment().toDate();return{_id:p(r,e.id),instanceId:f,secretKey:e.getSecretKey(),type:t,data:n||{},createdAt:r,creator:o.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null}}var f=Math.round(Date.now()+9999999*Math.random()).toString(36).toUpperCase(),g="PRODUCTION:LOG",I="PRODUCTION:LOG:SYNCING",v="PRODUCTION:LOCK",h=null,w=!1,b=null,O=null,S=e.debounce(s,33);return r.subscribe("socket.connected",setTimeout.bind(null,s,1337)),window.addEventListener("unload",d),{generateId:p,isEnabled:function(){return w},enable:function(e){function t(){u.setItem(v,JSON.stringify({instanceId:f,time:Date.now()}))}function n(){b=null,e&&"pending"===e.state()&&(w=!0,setTimeout(s,1e3),e.resolve())}function o(t){if(t.key===v){var n=JSON.parse(t.newValue);n.instanceId!==f&&(e?(e.reject(),e=null):r.publish("production.duplicateDetected",{thisInstanceId:f,thatInstanceId:n.instanceId}))}}if(w)return void(e&&(b=setTimeout(function(){b=null,e.resolve()},1)));if(!e)return void(w=!0);O&&clearInterval(O),b&&clearTimeout(b),window.removeEventListener("storage",o),window.addEventListener("storage",o);var i=window.parent!==window||"development"===window.ENV;O=setInterval(t,i?333333:333),b=setTimeout(n,i?1:2e3)},disable:function(){w&&(b&&(clearTimeout(b),b=null),O&&(clearInterval(O),O=null),w=!1)},isSyncing:function(){return null!==h},create:m,record:function(e,t,n){if(!e.isLocked()){if(!w)throw new Error("Production log is disabled!");var o,i="object"==typeof t?t:m(e,t,n),r=u.getItem(g);o=null===r?JSON.stringify(i):r+"\n"+JSON.stringify(i),u.setItem(g,o),e.saveLocalData(),S()}}}});