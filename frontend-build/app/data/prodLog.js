// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,o,r,i){"use strict";function l(){if(null!==p){var e=localStorage.getItem(d);null===e?localStorage.setItem(d,p):localStorage.setItem(d,p+"\n"+e),p=null,localStorage.removeItem(g),o.publish("production.synced",{message:"DISCONNECT"})}}function a(){if(f&&r.isConnected()&&null===p&&!i.isRestarting()&&(p=localStorage.getItem(d),null!==p)){localStorage.removeItem(d);var e=localStorage.getItem(g);null!==e&&(p=e+"\n"+p),localStorage.setItem(g,p),o.publish("production.syncing"),r.emit("production.sync",p,function(e){p=null,localStorage.removeItem(g),o.publish("production.synced",e),setTimeout(a,1)})}}function s(e){for(var t=0,n=0,o=e.length;o>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function u(e,t){return e.getTime().toString(36)+s(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var c=(Date.now()+Math.random()).toString(),d="PRODUCTION:LOG",g="PRODUCTION:LOG:SYNCING",m="PRODUCTION:LOCK",p=null,f=!1,S=null,v=null;return o.subscribe("socket.connected",setTimeout.bind(null,a,1337)),o.subscribe("socket.disconnected",l),window.addEventListener("unload",l),r.isConnected()&&a(),{generateId:u,isEnabled:function(){return f},enable:function(e){function t(t){if(t.key===m){var n=JSON.parse(t.newValue);n.instanceId!==c&&e.reject()}}return f?void(e&&(S=setTimeout(function(){S=null,e.resolve()}))):e?(window.addEventListener("storage",t),v=setInterval(function(){localStorage.setItem(m,JSON.stringify({instanceId:c,time:Date.now()}))},333),void(S=setTimeout(function(){S=null,window.removeEventListener("storage",t),"pending"===e.state()&&(f=!0,e.resolve())},2e3))):void(f=!0)},disable:function(){f&&(null!==S&&(clearTimeout(S),S=null),null!==v&&(clearInterval(v),v=null),f=!1)},isSyncing:function(){return null!==p},record:function(e,o,r){if(!e.isLocked()){if(!f)throw new Error("Production log is disabled!");var i={secretKey:e.getSecretKey(),type:o,data:r||{},createdAt:n.getMoment().toDate(),creator:t.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};i._id=u(i.createdAt,e.id);var l,s=localStorage.getItem(d);l=null===s?JSON.stringify(i):s+"\n"+JSON.stringify(i),localStorage.setItem(d,l),e.saveLocalData(),setTimeout(a,1)}}}});