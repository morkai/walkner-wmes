define(["app/user","app/time","app/broker","app/socket"],function(e,t,i,n){function r(){if(p&&null!==u){var e=c.getItem(l);null===e?c.setItem(l,u+"\n"+e):c.setItem(l,u),u=null,i.publish("production.synced",{message:"DISCONNECT"})}}function o(){p&&n.isConnected()&&null===u&&(u=c.getItem(l),null!==u&&(c.removeItem(l),i.publish("production.syncing"),n.emit("production.sync",u,function(e){u=null,i.publish("production.synced",e),setTimeout(o,1)})))}function s(e){for(var t=0,i=0,n=e.length;n>i;++i)t=0|(t<<5)-t+e.charCodeAt(i);return t}function a(e,t){return e.getTime().toString(36)+s(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var l="PRODUCTION:LOG",c=localStorage,u=null,p=!1;return i.subscribe("socket.connected",o.bind(null,!0)),i.subscribe("socket.disconnected",r),window.addEventListener("unload",r),n.isConnected()&&o(),{generateId:a,enable:function(){p=!0},disable:function(){p=!1},isSyncing:function(){return null!==u},record:function(i,n,r){if(!i.isLocked()){if(!p)throw new Error("Production log is disabled!");var s={secretKey:i.getSecretKey(),type:n,data:r||{},createdAt:t.getServerMoment().toDate(),creator:e.getInfo(),division:i.get("division"),subdivision:i.get("subdivision"),mrpControllers:i.get("mrpControllers"),prodFlow:i.get("prodFlow"),workCenter:i.get("workCenter"),prodLine:i.prodLine.id,prodShift:i.id,prodShiftOrder:i.prodShiftOrder.id||null};s._id=a(s.createdAt,i.id);var u,d=localStorage.getItem(l);u=null===d?JSON.stringify(s):d+"\n"+JSON.stringify(s),c.setItem(l,u),i.saveLocalData(),setTimeout(o,1)}}}});