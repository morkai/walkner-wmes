define(["app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,i,o){function r(){if(p&&null!==a){var e=l.getItem(c);null===e?l.setItem(c,a+"\n"+e):l.setItem(c,a),a=null,n.publish("production.synced",{message:"DISCONNECT"})}}function d(){p&&i.isConnected()&&null===a&&!o.isRestarting()&&(a=l.getItem(c),null!==a&&(l.removeItem(c),n.publish("production.syncing"),i.emit("production.sync",a,function(e){a=null,n.publish("production.synced",e),setTimeout(d,1)})))}function s(e){for(var t=0,n=0,i=e.length;i>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function u(e,t){return e.getTime().toString(36)+s(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var c="PRODUCTION:LOG",l=localStorage,a=null,p=!1;return n.subscribe("socket.connected",setTimeout.bind(null,d,1337)),n.subscribe("socket.disconnected",r),window.addEventListener("unload",r),i.isConnected()&&d(),{generateId:u,enable:function(){p=!0},disable:function(){p=!1},isSyncing:function(){return null!==a},record:function(n,i,o){if(!n.isLocked()){if(!p)throw new Error("Production log is disabled!");var r={secretKey:n.getSecretKey(),type:i,data:o||{},createdAt:t.getMoment().toDate(),creator:e.getInfo(),division:n.get("division"),subdivision:n.get("subdivision"),mrpControllers:n.get("mrpControllers"),prodFlow:n.get("prodFlow"),workCenter:n.get("workCenter"),prodLine:n.prodLine.id,prodShift:n.id,prodShiftOrder:n.prodShiftOrder.id||null};r._id=u(r.createdAt,n.id);var s,a=localStorage.getItem(c);s=null===a?JSON.stringify(r):a+"\n"+JSON.stringify(r),l.setItem(c,s),n.saveLocalData(),setTimeout(d,1)}}}});