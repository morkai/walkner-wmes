// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,o,r,i,l,a){"use strict";function u(){if(null!==S){var e=localStorage.getItem(m);null===e?localStorage.setItem(m,S):localStorage.setItem(m,S+"\n"+e),S=null,localStorage.removeItem(f),i.publish("production.synced",{message:"DISCONNECT"})}}function c(e){if(v&&null===S&&!a.isRestarting()&&(S=localStorage.getItem(m),null!==S)){var n=localStorage.getItem(f);null!==n&&(S=n+"\n"+S),localStorage.setItem(f,S),localStorage.removeItem(m),i.publish("production.syncing");var o=t.ajax({method:"POST",url:"/prodLogEntries",contentType:"text/plain; charset=UTF-8",data:S,timeout:1e4});o.fail(function(t){var n=localStorage.getItem(m);n=null===n?S:S+"\n"+n,localStorage.setItem(m,n),localStorage.removeItem(f),S=null,i.publish("production.synced",{message:t.responseText}),e=e?e+1:1,setTimeout(c,Math.min(1e3*e,2e4),e)}),o.done(function(e){localStorage.removeItem(f),S=null,i.publish("production.synced",null),e&&e.lock&&i.publish("production.locked",e.lock),setTimeout(c,100)})}}function s(e){for(var t=0,n=0,o=e.length;o>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function d(e,t){return e.getTime().toString(36)+s(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}function g(e,t,n){var i=r.getMoment().toDate();return{_id:d(i,e.id),instanceId:p,secretKey:e.getSecretKey(),type:t,data:n||{},createdAt:i,creator:o.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null}}var p=Math.round(Date.now()+9999999*Math.random()).toString(36).toUpperCase(),m="PRODUCTION:LOG",f="PRODUCTION:LOG:SYNCING",I="PRODUCTION:LOCK",S=null,v=!1,h=null,w=null,b=e.debounce(c,33);return i.subscribe("socket.connected",setTimeout.bind(null,c,1337)),window.addEventListener("unload",u),{generateId:d,isEnabled:function(){return v},enable:function(e){function t(){localStorage.setItem(I,JSON.stringify({instanceId:p,time:Date.now()}))}function n(){h=null,e&&"pending"===e.state()&&(v=!0,setTimeout(c,1e3),e.resolve())}function o(t){if(t.key===I){var n=JSON.parse(t.newValue);n.instanceId!==p&&(e?(e.reject(),e=null):i.publish("production.duplicateDetected",{thisInstanceId:p,thatInstanceId:n.instanceId}))}}if(v)return void(e&&(h=setTimeout(function(){h=null,e.resolve()},1)));if(!e)return void(v=!0);w&&clearInterval(w),h&&clearTimeout(h),window.removeEventListener("storage",o),window.addEventListener("storage",o);var r=window.parent!==window||!0;w=setInterval(t,r?333333:333),h=setTimeout(n,r?1:2e3)},disable:function(){v&&(h&&(clearTimeout(h),h=null),w&&(clearInterval(w),w=null),v=!1)},isSyncing:function(){return null!==S},create:g,record:function(e,t,n){if(!e.isLocked()){if(!v)throw new Error("Production log is disabled!");var o,r="object"==typeof t?t:g(e,t,n),i=localStorage.getItem(m);o=null===i?JSON.stringify(r):i+"\n"+JSON.stringify(r),localStorage.setItem(m,o),e.saveLocalData(),b()}}}});