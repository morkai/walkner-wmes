define(["app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,i,o,r){function d(){if(b&&null!==m){var e=f.getItem(p);null===e?f.setItem(p,m+"\n"+e):f.setItem(p,m),m=null,i.publish("production.synced",{message:"DISCONNECT"})}}function u(){b&&o.isConnected()&&null===m&&!r.isRestarting()&&(m=f.getItem(p),null!==m&&(f.removeItem(p),i.publish("production.syncing"),o.emit("production.sync",m,function(e){m=null,i.publish("production.synced",e),setTimeout(u,1)})))}function c(e){for(var t=0,n=0,i=e.length;i>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function s(e,t){return e.getTime().toString(36)+c(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}function l(){return parseInt(localStorage.getItem(g)||"0",10)}function a(e){localStorage.setItem(g,e)}var p="PRODUCTION:LOG",g="PRODUCTION:LOCK",f=localStorage,m=null,b=!1;return i.subscribe("socket.connected",setTimeout.bind(null,u,1337)),i.subscribe("socket.disconnected",d),window.addEventListener("unload",d),o.isConnected()&&u(),{generateId:s,isEnabled:function(){return b},enable:function(){if(!b){var t=l();if(0!==t){var n=window.confirm(e("production","locked"));if(!n)return}a(1),b=!0}},disable:function(){b&&(a(0),b=!1)},isSyncing:function(){return null!==m},record:function(e,i,o){if(!e.isLocked()){if(!b)throw new Error("Production log is disabled!");var r={secretKey:e.getSecretKey(),type:i,data:o||{},createdAt:n.getMoment().toDate(),creator:t.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};r._id=s(r.createdAt,e.id);var d,c=localStorage.getItem(p);d=null===c?JSON.stringify(r):c+"\n"+JSON.stringify(r),f.setItem(p,d),e.saveLocalData(),setTimeout(u,1)}}}});