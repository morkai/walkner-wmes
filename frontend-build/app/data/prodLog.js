define(["app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,i,n,r){function o(){if(d&&null!==p){var e=u.getItem(c);null===e?u.setItem(c,p+"\n"+e):u.setItem(c,p),p=null,i.publish("production.synced",{message:"DISCONNECT"})}}function s(){d&&n.isConnected()&&null===p&&!r.isRestarting()&&(p=u.getItem(c),null!==p&&(u.removeItem(c),i.publish("production.syncing"),n.emit("production.sync",p,function(e){p=null,i.publish("production.synced",e),setTimeout(s,1)})))}function a(e){for(var t=0,i=0,n=e.length;n>i;++i)t=0|(t<<5)-t+e.charCodeAt(i);return t}function l(e,t){return e.getTime().toString(36)+a(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}var c="PRODUCTION:LOG",u=localStorage,p=null,d=!1;return i.subscribe("socket.connected",setTimeout.bind(null,s,1337)),i.subscribe("socket.disconnected",o),window.addEventListener("unload",o),n.isConnected()&&s(),{generateId:l,enable:function(){d=!0},disable:function(){d=!1},isSyncing:function(){return null!==p},record:function(i,n,r){if(!i.isLocked()){if(!d)throw new Error("Production log is disabled!");var o={secretKey:i.getSecretKey(),type:n,data:r||{},createdAt:t.getMoment().toDate(),creator:e.getInfo(),division:i.get("division"),subdivision:i.get("subdivision"),mrpControllers:i.get("mrpControllers"),prodFlow:i.get("prodFlow"),workCenter:i.get("workCenter"),prodLine:i.prodLine.id,prodShift:i.id,prodShiftOrder:i.prodShiftOrder.id||null};o._id=l(o.createdAt,i.id);var a,p=localStorage.getItem(c);a=null===p?JSON.stringify(o):p+"\n"+JSON.stringify(o),u.setItem(c,a),i.saveLocalData(),setTimeout(s,1)}}}});