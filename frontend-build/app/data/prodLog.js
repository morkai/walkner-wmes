define(["app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,n,o,r,i){function d(){if(null!==I){var e=m.getItem(p);null===e?m.setItem(p,I):m.setItem(p,I+"\n"+e),I=null,m.removeItem(g),o.publish("production.synced",{message:"DISCONNECT"})}}function u(){if(v&&r.isConnected()&&null===I&&!i.isRestarting()&&(I=m.getItem(p),null!==I)){m.removeItem(p);var e=m.getItem(g);null!==e&&(I=e+"\n"+I),m.setItem(g,I),o.publish("production.syncing"),r.emit("production.sync",I,function(e){I=null,m.removeItem(g),o.publish("production.synced",e),setTimeout(u,1)})}}function c(e){for(var t=0,n=0,o=e.length;o>n;++n)t=(t<<5)-t+e.charCodeAt(n)|0;return t}function l(e,t){return e.getTime().toString(36)+c(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}function s(){return parseInt(localStorage.getItem(f)||"0",10)}function a(e){localStorage.setItem(f,e)}var p="PRODUCTION:LOG",g="PRODUCTION:LOG:SYNCING",f="PRODUCTION:LOCK",m=localStorage,I=null,v=!1;return o.subscribe("socket.connected",setTimeout.bind(null,u,1337)),o.subscribe("socket.disconnected",d),window.addEventListener("unload",d),r.isConnected()&&u(),{generateId:l,isEnabled:function(){return v},enable:function(){if(!v){var t=s();if(0!==t){var n=window.confirm(e("production","locked"));if(!n)return}a(1),v=!0}},disable:function(){v&&(a(0),v=!1)},isSyncing:function(){return null!==I},record:function(e,o,r){if(!e.isLocked()){if(!v)throw new Error("Production log is disabled!");var i={secretKey:e.getSecretKey(),type:o,data:r||{},createdAt:n.getMoment().toDate(),creator:t.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};i._id=l(i.createdAt,e.id);var d,c=localStorage.getItem(p);d=null===c?JSON.stringify(i):c+"\n"+JSON.stringify(i),m.setItem(p,d),e.saveLocalData(),setTimeout(u,1)}}}});