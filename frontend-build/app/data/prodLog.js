// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["app/i18n","app/user","app/time","app/broker","app/socket","app/updater/index"],function(e,t,o,n,r,i){function l(){if(null!==m){var e=localStorage.getItem(g);null===e?localStorage.setItem(g,m):localStorage.setItem(g,m+"\n"+e),m=null,localStorage.removeItem(p),n.publish("production.synced",{message:"DISCONNECT"})}}function a(){if(S&&r.isConnected()&&null===m&&!i.isRestarting()&&(m=localStorage.getItem(g),null!==m)){localStorage.removeItem(g);var e=localStorage.getItem(p);null!==e&&(m=e+"\n"+m),localStorage.setItem(p,m),n.publish("production.syncing"),r.emit("production.sync",m,function(e){m=null,localStorage.removeItem(p),n.publish("production.synced",e),setTimeout(a,1)})}}function c(e){for(var t=0,o=0,n=e.length;n>o;++o)t=(t<<5)-t+e.charCodeAt(o)|0;return t}function d(e,t){return e.getTime().toString(36)+c(t).toString(36)+Math.round(1e16*Math.random()).toString(36)}function u(){return parseInt(localStorage.getItem(f)||"0",10)}function s(e){localStorage.setItem(f,e)}var g="PRODUCTION:LOG",p="PRODUCTION:LOG:SYNCING",f="PRODUCTION:LOCK",m=null,S=!1;return n.subscribe("socket.connected",setTimeout.bind(null,a,1337)),n.subscribe("socket.disconnected",l),window.addEventListener("unload",l),r.isConnected()&&a(),{generateId:d,isEnabled:function(){return S},enable:function(){if(!S){var t=u();if(0!==t){var o=window.confirm(e("production","locked"));if(!o)return}s(1),S=!0}},disable:function(){S&&(s(0),S=!1)},isSyncing:function(){return null!==m},record:function(e,n,r){if(!e.isLocked()){if(!S)throw new Error("Production log is disabled!");var i={secretKey:e.getSecretKey(),type:n,data:r||{},createdAt:o.getMoment().toDate(),creator:t.getInfo(),division:e.get("division"),subdivision:e.get("subdivision"),mrpControllers:e.get("mrpControllers"),prodFlow:e.get("prodFlow"),workCenter:e.get("workCenter"),prodLine:e.prodLine.id,prodShift:e.id,prodShiftOrder:e.prodShiftOrder.id||null};i._id=d(i.createdAt,e.id);var l,c=localStorage.getItem(g);l=null===c?JSON.stringify(i):c+"\n"+JSON.stringify(i),localStorage.setItem(g,l),e.saveLocalData(),setTimeout(a,1)}}}});