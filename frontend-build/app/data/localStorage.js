// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery"],function(e){"use strict";function t(e){var o=e.data;"localStorage"===o.type&&(window.removeEventListener("message",t),c=o.data,0===Object.keys(c).length&&(Object.keys(localStorage).forEach(function(e){c[e]=localStorage[e]}),window.parent.postMessage({type:"localStorage",action:"write",data:c},"*")),r&&(clearTimeout(r),r=null),l&&(l(),l=null))}function o(e,t){c[e]=t,window.parent.postMessage({type:"localStorage",action:"setItem",key:e,value:t},"*")}function n(e){delete c[e],window.parent.postMessage({type:"localStorage",action:"remoteItem",key:e},"*")}function a(){window.parent.postMessage({type:"localStorage",action:"clear"},"*")}var l=null,r=null,c=null;return window.addEventListener("message",t),{start:function(e){if(c)return e();if(l){var o=l;return void(l=function(){o(),e()})}l=e,r=setTimeout(function(){l(),window.removeEventListener("message",t),l=null,r=null},333),window.parent.postMessage({type:"localStorage",action:"read"},"*")},getItem:function(e){var t=(c?c:localStorage)[e];return void 0===t?null:t},setItem:function(e,t){c?o(e,t):localStorage.setItem(e,t)},removeItem:function(e){c?n(e):localStorage.removeItem(e)},clear:function(){c?a():localStorage.clear()}}});