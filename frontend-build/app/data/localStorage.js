define(function(){"use strict";var e=null,t=null,a=null;function o(o){var l=o.data;window.parent!==window&&window.IS_EMBEDDED&&"localStorage"===l.type&&(l.action?function(e){var t=e.data,o=e.source;switch(t.action){case"read":return o.postMessage({type:"localStorage",data:a},"*");case"setItem":return n(t.key,t.value);case"remoteItem":return n(t.key);case"clear":r()}}(o):l.data&&(a=l.data,0===Object.keys(a).length&&(Object.keys(localStorage).forEach(function(e){a[e]=localStorage[e]}),window.parent.postMessage({type:"localStorage",action:"write",data:a},"*")),t&&(clearTimeout(t),t=null),e&&(e(),e=null)))}function n(e,t){a[e]=t,window.parent.postMessage({type:"localStorage",action:"setItem",key:e,value:t},"*")}function r(){a={},window.parent.postMessage({type:"localStorage",action:"clear"},"*")}return window.addEventListener("message",o),{start:function(n){if(a)return n();if(e){var r=e;e=function(){r(),n()}}else e=n,t=setTimeout(function(){e(),window.removeEventListener("message",o),e=null,t=null},3333),window.parent.postMessage({type:"localStorage",action:"read"},"*")},getItem:function(e){var t=(a||localStorage)[e];return void 0===t?null:t},setItem:function(e,t){localStorage.setItem(e,t),a&&n(e,t)},removeItem:function(e){localStorage.removeItem(e),a&&function(e){delete a[e],window.parent.postMessage({type:"localStorage",action:"removeItem",key:e},"*")}(e)},clear:function(){localStorage.clear(),a&&r()}}});