define(["underscore","jquery","app/viewport","app/user","app/core/views/FormView","../dictionaries"],function(t,e,i,o,l,a){"use strict";return l.extend({events:Object.assign({"click #-cancel":function(){i.currentDialog===this?i.closeDialog():window.history.length?window.history.back():window.location.href=this.model.genClientUrl("base")},change:function(){this.dirty=!0},"change #-division":function(){this.$id("workplace").val(""),this.setUpWorkplaceSelect2(),this.$id("workplace").trigger("change")},"change #-workplace":function(){this.$id("department").val(""),this.setUpDepartmentSelect2(),this.$id("department").trigger("change")},"change #-department":function(){this.$id("building").val(""),this.setUpBuildingSelect2(),this.$id("building").trigger("change")},"change #-building":function(){this.$id("location").val(""),this.setUpLocationSelect2(),this.$id("location").trigger("change")},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()}},l.prototype.events),initialize:function(){l.prototype.initialize.apply(this,arguments),this.dirty=!1,e(document).on(`click.${this.idPrefix}`,"a",this.onLinkClick.bind(this)),e(window).on(`beforeunload.${this.idPrefix}`,this.onWindowBeforeUnload.bind(this)),this.on("afterRender",()=>this.dirty=!1)},destroy:function(){l.prototype.destroy.apply(this,arguments),e(document).off(`.${this.idPrefix}`),e(window).off(`.${this.idPrefix}`)},showUnsavedDialog:function(t){const e=Date.now();window.confirm(this.t("wmes-osh-common","FORM:unsaved"))||Date.now()-e<100?(this.dirty=!1,t.click()):document.body.click()},onLinkClick:function(t){if(!this.dirty||0!==t.button||i.currentDialog===this)return;const e=t.currentTarget,o=e.getAttribute("href");return o&&!o.startsWith("javascript")&&"_blank"!==e.target?(this.showUnsavedDialog(e),!1):void 0},onWindowBeforeUnload:function(t){if(this.dirty&&i.currentDialog!==this)return t.originalEvent.returnValue=this.t("wmes-osh-common","FORM:unsaved")},setUpUserWorkplaceSelect2:function(){const t=this.$id("userWorkplace");if(!t.length)return;if(this.options.editMode){const e=this.model.get("creator").oshWorkplace,i=a.workplaces.get(e);return t.val(e).select2({width:"100%",placeholder:" ",data:i?[{id:e,text:i?i.getLabel({long:!0}):`?${e}?`,model:i}]:[]}),void t.select2("enable",!1)}t.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let e=a.workplaces.get(+t.val());e&&(e={id:e.id,text:e.getLabel({long:!0}),model:e});const i={};a.workplaces.forEach(t=>{t.get("active")&&(i[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),e&&!i[e.id]&&(i[e.id]=e),t.select2({width:"100%",data:Object.values(i).sort((t,e)=>t.text.localeCompare(e.text))});const l=a.workplaces.get(o.data.oshWorkplace);this.options.editMode&&e?t.select2("enable",!1).select2("data",e):l?t.select2("enable",!1).select2("data",{id:l.id,text:l.getLabel({long:!0}),model:l}):t.select2("enable",!0)},setUpUserDepartmentSelect2:function(){const t=this.$id("userDepartment");if(!t.length)return;if(this.options.editMode){const e=this.model.get("creator").oshDepartment,i=a.departments.get(e);return t.val(e).select2({width:"100%",placeholder:" ",data:i?[{id:e,text:i?i.getLabel({long:!0}):`?${e}?`,model:i}]:[]}),void t.select2("enable",!1)}const e=+this.$id("userWorkplace").val();let i=a.departments.get(+t.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const l={};a.departments.forEach(t=>{t.get("active")&&t.get("workplace")===e&&(l[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!l[i.id]&&i.model.get("workplace")===e&&(l[i.id]=i);const n=Object.values(l).sort((t,e)=>t.text.localeCompare(e.text));let s=" ",d=!0;e||0!==n.length||(s=this.t("wmes-osh-common","FORM:placeholder:noUserWorkplace"),d=!1),t.select2({width:"100%",placeholder:s,data:n});const c=a.departments.get(o.data.oshDepartment);this.options.editMode&&i?t.select2("enable",!1).select2("data",i):c?t.select2("enable",!1).select2("data",{id:c.id,text:c.getLabel({long:!0}),model:c}):(t.select2("enable",d),1===n.length?t.select2("data",n[0]):l[t.val()]||t.select2("data",null).val(""))},setUpDivisionSelect2:function(){const t=this.$id("division");if(!t.length)return;const e=+t.val();e||!o.data.oshDivision||this.options.editMode||t.val(o.data.oshDivision);let i=a.divisions.get(e);i?i={id:i.id,text:i.getLabel({long:!0}),model:i}:e&&(i={id:e,text:`?${e}?`});const l={};a.divisions.forEach(t=>{t.get("active")&&(l[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!l[i.id]&&(l[i.id]=i),t.select2({width:"100%",allowClear:!t.prop("required"),data:Object.values(l).sort((t,e)=>t.text.localeCompare(e.text))}),t.select2("enable",!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator())},setUpWorkplaceSelect2:function(){const t=this.$id("workplace");if(!t.length)return;const e=+t.val();e||!o.data.oshWorkplace||this.options.editMode||t.val(o.data.oshWorkplace);let i=a.workplaces.get(e);i?i={id:i.id,text:i.getLabel({long:!0}),model:i}:e&&(i={id:e,text:`?${e}?`});const l=+this.$id("division").val(),n={};a.workplaces.forEach(t=>{t.get("active")&&t.hasDivision(l)&&(n[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!n[i.id]&&(n[i.id]=i);const s=Object.values(n).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:l?" ":this.t("wmes-osh-common","FORM:placeholder:noDivision"),allowClear:!t.prop("required"),data:s}),1===s.length?t.select2("data",s[0]):n[t.val()]||t.val("").select2("data",null),t.select2("enable",!!l&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpDepartmentSelect2:function(){const t=this.$id("department");if(!t.length)return;const e=+t.val();e||!o.data.oshDepartment||this.options.editMode||t.val(o.data.oshDepartment);let i=a.departments.get(e);i?i={id:i.id,text:i.getLabel({long:!0}),model:i}:e&&(i={id:e,text:`?${e}?`});const l=+this.$id("workplace").val(),n={};a.departments.forEach(t=>{t.get("active")&&t.hasWorkplace(l)&&(n[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!n[i.id]&&(n[i.id]=i);const s=Object.values(n).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:l?" ":this.t("wmes-osh-common","FORM:placeholder:noWorkplace"),allowClear:!t.prop("required"),data:s}),1===s.length?t.select2("data",s[0]):n[t.val()]||t.val("").select2("data",null),t.select2("enable",!!l&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(t){const e=this.$id("building");if(!e.length)return;const i=+e.val();let o=a.buildings.get(i);o?o={id:o.id,text:o.getLabel({long:!0}),model:o}:i&&(o={id:i,text:`?${i}?`});const l=+this.$id("department").val(),n={};a.buildings.forEach(t=>{t.get("active")&&t.hasDepartment(l)&&(n[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),o&&!n[o.id]&&(n[o.id]=o);const s=Object.values(n).sort((t,e)=>t.text.localeCompare(e.text));e.select2({width:"100%",placeholder:l?" ":this.t("wmes-osh-common","FORM:placeholder:noDepartment"),allowClear:!e.prop("required"),data:s}),!1!==t&&1===s.length&&e.select2("data",s[0]),e.select2("enable",!!l&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const t=this.$id("location");if(!t.length)return;const e=+t.val();let i=a.locations.get(e);i?i={id:i.id,text:i.getLabel({long:!0}),model:i}:e&&(i={id:e,text:`?${e}?`});const o=+this.$id("building").val(),l={};a.locations.forEach(t=>{t.get("active")&&t.hasBuilding(o)&&(l[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!l[i.id]&&(l[i.id]=i);const n=Object.values(l).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:o?" ":this.t("wmes-osh-common","FORM:placeholder:noBuilding"),allowClear:!t.prop("required"),data:n}),1===n.length&&t.select2("data",n[0]),t.select2("enable",!!o&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const t=this.$id("station");if(!t.length)return;const e=+t.val();let i=a.stations.get(e);i?i={id:i.id,text:i.getLabel({long:!0}),model:i}:e&&(i={id:e,text:`?${e}?`});const o=+this.$id("location").val(),l={};a.stations.forEach(t=>{t.get("active")&&t.hasLocation(o)&&(l[t.id]={id:t.id,text:t.getLabel({long:!0}),model:t})}),i&&!l[i.id]&&(l[i.id]=i);const n=Object.values(l).sort((t,e)=>t.text.localeCompare(e.text));t.select2({width:"100%",placeholder:o?" ":this.t("wmes-osh-common","FORM:placeholder:noLocation"),allowClear:!0,data:n}),this.options.editMode||1!==n.length||t.select2("data",n[0]),t.select2("enable",n.length>0&&!!o&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))}})});