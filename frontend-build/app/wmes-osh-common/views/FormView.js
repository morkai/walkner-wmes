define(["underscore","jquery","app/viewport","app/user","app/core/views/FormView","../dictionaries"],function(e,t,o,i,a,l){"use strict";return a.extend({events:Object.assign({"click #-cancel":function(){o.currentDialog===this?o.closeDialog():window.history.length?window.history.back():window.location.href=this.model.genClientUrl("base")},change:function(){this.dirty=!0},"change #-division":function(){this.$id("workplace").val(""),this.setUpWorkplaceSelect2(),this.$id("workplace").trigger("change")},"change #-workplace":function(){this.$id("department").val(""),this.setUpDepartmentSelect2(),this.$id("department").trigger("change")},"change #-department":function(){this.$id("building").val(""),this.setUpBuildingSelect2(),this.$id("building").trigger("change")},"change #-building":function(){this.$id("location").val(""),this.setUpLocationSelect2(),this.$id("location").trigger("change")},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),this.dirty=!1,t(document).on(`click.${this.idPrefix}`,"a",this.onLinkClick.bind(this)),t(window).on(`beforeunload.${this.idPrefix}`,this.onWindowBeforeUnload.bind(this)),this.on("afterRender",()=>this.dirty=!1)},destroy:function(){a.prototype.destroy.apply(this,arguments),t(document).off(`.${this.idPrefix}`),t(window).off(`.${this.idPrefix}`)},showUnsavedDialog:function(e){const t=Date.now();window.confirm(this.t("wmes-osh-common","FORM:unsaved"))||Date.now()-t<100?(this.dirty=!1,e.click()):document.body.click()},onLinkClick:function(e){if(!this.dirty||0!==e.button)return;const t=e.currentTarget,o=t.getAttribute("href");return o&&!o.startsWith("javascript")&&"_blank"!==t.target?(this.showUnsavedDialog(t),!1):void 0},onWindowBeforeUnload:function(e){if(this.dirty)return e.originalEvent.returnValue=this.t("wmes-osh-common","FORM:unsaved")},setUpUserWorkplaceSelect2:function(){const e=this.$id("userWorkplace");if(this.options.editMode){const t=this.model.get("creator").oshWorkplace,o=l.workplaces.get(t);return e.val(t).select2({width:"100%",placeholder:" ",data:o?[{id:t,text:o?o.getLabel({long:!0}):`?${t}?`,model:o}]:[]}),void e.select2("enable",!1)}e.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let t=l.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o={};l.workplaces.forEach(e=>{e.get("active")&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!o[t.id]&&(o[t.id]=t),e.select2({width:"100%",data:Object.values(o).sort((e,t)=>e.text.localeCompare(t.text))});const a=l.workplaces.get(i.data.oshWorkplace);this.options.editMode&&t?e.select2("enable",!1).select2("data",t):a?e.select2("enable",!1).select2("data",{id:a.id,text:a.getLabel({long:!0}),model:a}):e.select2("enable",!0)},setUpUserDepartmentSelect2:function(){const e=this.$id("userDepartment");if(this.options.editMode){const t=this.model.get("creator").oshDepartment,o=l.departments.get(t);return e.val(t).select2({width:"100%",placeholder:" ",data:o?[{id:t,text:o?o.getLabel({long:!0}):`?${t}?`,model:o}]:[]}),void e.select2("enable",!1)}const t=+this.$id("userWorkplace").val();let o=l.departments.get(+e.val());o&&(o={id:o.id,text:o.getLabel({long:!0}),model:o});const a={};l.departments.forEach(e=>{e.get("active")&&e.get("workplace")===t&&(a[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),o&&!a[o.id]&&o.model.get("workplace")===t&&(a[o.id]=o);const s=Object.values(a).sort((e,t)=>e.text.localeCompare(t.text));let n=" ",d=!0;t||0!==s.length||(n=this.t("wmes-osh-common","FORM:placeholder:noUserWorkplace"),d=!1),e.select2({width:"100%",placeholder:n,data:s});const c=l.departments.get(i.data.oshDepartment);this.options.editMode&&o?e.select2("enable",!1).select2("data",o):c?e.select2("enable",!1).select2("data",{id:c.id,text:c.getLabel({long:!0}),model:c}):(e.select2("enable",d),1===s.length?e.select2("data",s[0]):a[e.val()]||e.select2("data",null).val(""))},setUpDivisionSelect2:function(){const e=this.$id("division");e.val()||!i.data.oshDivision||this.options.editMode||e.val(i.data.oshDivision);let t=l.divisions.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o={};l.divisions.forEach(e=>{e.get("active")&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!o[t.id]&&(o[t.id]=t),e.select2({width:"100%",allowClear:!e.prop("required"),data:Object.values(o).sort((e,t)=>e.text.localeCompare(t.text))}),e.select2("enable",!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator())},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");e.val()||!i.data.oshWorkplace||this.options.editMode||e.val(i.data.oshWorkplace);let t=l.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o=+this.$id("division").val(),a={};l.workplaces.forEach(e=>{e.get("active")&&e.hasDivision(o)&&(a[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!a[t.id]&&(a[t.id]=t);const s=Object.values(a).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:o?" ":this.t("wmes-osh-common","FORM:placeholder:noDivision"),allowClear:!e.prop("required"),data:s}),1===s.length?e.select2("data",s[0]):a[e.val()]||e.val("").select2("data",null),e.select2("enable",!!o&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpDepartmentSelect2:function(){const e=this.$id("department");e.val()||!i.data.oshDepartment||this.options.editMode||e.val(i.data.oshDepartment);let t=l.departments.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o=+this.$id("workplace").val(),a={};l.departments.forEach(e=>{e.get("active")&&e.hasWorkplace(o)&&(a[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!a[t.id]&&(a[t.id]=t);const s=Object.values(a).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:o?" ":this.t("wmes-osh-common","FORM:placeholder:noWorkplace"),allowClear:!e.prop("required"),data:s}),1===s.length?e.select2("data",s[0]):a[e.val()]||e.val("").select2("data",null),e.select2("enable",!!o&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(e){const t=this.$id("building"),o=+this.$id("department").val(),i={};l.buildings.forEach(e=>{e.get("active")&&e.hasDepartment(o)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const a=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));t.select2({width:"100%",placeholder:o?" ":this.t("wmes-osh-common","FORM:placeholder:noDepartment"),allowClear:!t.prop("required"),data:a}),!1!==e&&1===a.length&&t.select2("data",a[0]),t.select2("enable",!!o&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const e=this.$id("location"),t=+this.$id("building").val(),o={};l.locations.forEach(e=>{e.get("active")&&e.hasBuilding(t)&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const i=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("wmes-osh-common","FORM:placeholder:noBuilding"),allowClear:!e.prop("required"),data:i}),1===i.length&&e.select2("data",i[0]),e.select2("enable",!!t&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const e=this.$id("station"),t=+this.$id("location").val(),o={};l.stations.forEach(e=>{e.get("active")&&e.hasLocation(t)&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const i=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("wmes-osh-common","FORM:placeholder:noLocation"),allowClear:!0,data:i}),this.options.editMode||1!==i.length||e.select2("data",i[0]),e.select2("enable",i.length>0&&!!t&&(!this.options.editMode||this.model.constructor.can.manage()||this.model.isCoordinator()))}})});