define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/core/util/html","app/wmes-osh-common/dictionaries","app/wmes-osh-common/templates/history/panel","app/wmes-osh-common/templates/history/item"],function(t,e,s,i,o,a,n,r,l,c,h,m){"use strict";const u={statusComment:!0,statusUpdater:!0,startedAt:!0,implementedAt:!0,finishedAt:!0};return n.extend({nlsDomain:"wmes-osh-common",template:h,events:{"click #-commentsOnly":function(){this.commentsOnly=!this.commentsOnly,this.commentsOnly?localStorage.setItem("OSH_HISTORY_COMMENTS_ONLY","1"):localStorage.removeItem("OSH_HISTORY_COMMENTS_ONLY"),this.render(),this.commentsOnly&&(this.scrollToBottom(),this.scrollIntoView())},"click #-maximize":function(){this.commentsOnly&&this.scrollToBottom(),this.scrollIntoView()},"keyup #-comment":function(t){if(t.ctrlKey&&"Enter"===t.key)return this.$id("submit").click(),!1},"submit form":function(){const t=this.$id("submit"),e=this.$id("comment"),s=e.val().trim();if(this.scrollIntoView(),!s.replace(/[^a-zA-Z0-9]+/g,"").length)return e.val("").focus(),!1;t.prop("disabled",!0),e.prop("disabled",!0);const i=this.ajax({method:"PUT",url:this.model.url(),data:JSON.stringify({comment:s})});return i.fail(()=>a.msg.savingFailed()),i.done(()=>{a.msg.saved(),e.val("")}),i.always(()=>{t.prop("disabled",!1),e.prop("disabled",!1).focus()}),!1}},initialize:function(){this.commentsOnly="1"===localStorage.getItem("OSH_HISTORY_COMMENTS_ONLY"),this.once("afterRender",()=>{this.listenTo(this.model,"change:changes",t.debounce(this.updateHistory,1)),this.listenTo(this.model,"seen",this.onSeen)}),e(window).on(`resize.${this.idPrefix}`,t.debounce(this.resize.bind(this),33))},getTemplateData:function(){return{renderItem:this.renderPartialHtml.bind(this,m),items:this.serializeItems(),canComment:this.model.constructor.can.comment(this.model),commentsOnly:this.commentsOnly,maxHeight:this.calcHeight()}},serializeItems:function(){return this.model.get("changes").map(this.serializeItem,this).filter(this.filterItem,this)},filterItem:function(t){return!(this.commentsOnly&&!t.comment)&&(!!t.comment||!!t.changes.length)},serializeItem:function(e,s){const o=this.model.getObserver(),a=Date.parse(e.date),n=o.notify&&o.lastSeenAt<a,l=this.commentsOnly?[]:t.map(e.data,(t,e)=>{if(u[e])return null;const i=this.translateProperty(e);return this.diff[e]&&(t=this.diff[e](t[0],t[1])),null===t[0]&&t[1]&&(t[1].added||t[1].edited||t[1].deleted)?{label:i,values:this.serializeItemValues(e,t[1],s)}:{label:i,oldValue:this.serializeItemValue(e,t[0],!0,s),newValue:this.serializeItemValue(e,t[1],!1,s)}}).filter(t=>!!t);return{i:s,time:i.toTagData(a),user:r(e.user,{noIp:!0}),changes:l,comment:e.comment.trim(),unseen:n}},translate:function(t,e){const s=this.model.getNlsDomain();return this.t.has(s,t)?this.t(s,t,e):this.t(t,e)},translateProperty:function(t){const e=this.model.getNlsDomain();return this.t.has(e,`history:${t}`)?this.t(e,`history:${t}`):this.t.has(`history:${t}`)?this.t(`history:${t}`):this.translate(`PROPERTY:${t}`)},serializeItemValue:function(e,s,o,a){if(null==s||""===s||Array.isArray(s)&&0===s.length)return"-";if(0===s)return 0;if("boolean"==typeof s)return this.t("core","BOOL:"+s);switch("string"==typeof s&&(s=t.escape(s)),e){case"implementer":case"implementers":case"coordinators":return r(s);case"plannedAt":return i.utc.format(s,"LL");case"date":case"eventDate":return i.utc.format(s,this.translate(`details:${e}:format`));case"problem":case"reason":case"suggestion":case"solution":case"companyName":return s.length<=43?s:{more:s,toString:()=>`${s.substr(0,40)}...`};case"priority":case"status":case"kind":case"workplace":case"division":case"building":case"location":case"station":case"eventCategory":case"reasonCategory":case"company":{const i=t.escape(c.getLabel(e,s,{long:!0})),o=t.escape(c.getLabel(e,s,{long:!1}));return i>43?o>43?{more:i,toString:()=>`${i.substr(0,40)}...`}:{more:i,toString:()=>o}:i}case"attachments":{const e=`<a href="${this.model.getAttachmentUrl(s)}&change=${a}" target="_blank">`;let i="";return s.kind&&this.t.has(`history:attachmentKind:${s.kind}`)&&(i=" ("+this.t(`history:attachmentKind:${s.kind}`)+")"),s.name.length<=43?`${e}${t.escape(s.name)}</a>${i}`:{more:s.name,toString:()=>`${e}${t.escape(s.name).substr(0,40)}...</a>${i}`}}case"relations":return this.translate(`relation:${s.type}`,s);case"resolution":return s._id?this.translate(`resolution:link:${s.type}`,s):this.translate(`resolution:desc:${s.type}`);case"rootCauses":{const t=c.getLabel("rootCauseCategories",s.category).toLocaleLowerCase();return s.why.length?l.tag("a",{href:"javascript:void(0)",className:"has-more",data:{change:a,value:o?0:1,property:e,category:s.category}},`${t} (${s.why.length})`):`${t} (0)`}case"behaviors":case"workConditions":return this.translate("history:observations",{count:s.length});default:return s||""}},serializeItemValues:function(t,{added:e,edited:s,deleted:i},o){const a=[];return(i||[]).forEach(e=>a.push({oldValue:this.serializeItemValue(t,e,!0,o),newValue:"-"})),(e||[]).forEach(e=>a.push({oldValue:"-",newValue:this.serializeItemValue(t,e,!1,o)})),(s||[]).forEach(e=>a.push({oldValue:this.serializeItemValue(t,Object.assign({},e,e.old),!0,o),newValue:this.serializeItemValue(t,e,!1,o)})),a},serializeRootCausesPopover:function(e,s,i){const o=this.model.get("changes")[e];if(!o||!o.data.rootCauses)return;const a=o.data.rootCauses[s];if(!a||!a.length)return;const n=a.find(t=>t.category===i);return n?"<ol><li>"+n.why.filter(t=>!!t).map(e=>t.escape(e)).join("<li>")+"</ol>":void 0},afterRender:function(){const s=this;s.lastChangeCount=s.model.get("changes").length,s.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",className:"osh-history-popover",html:!0,title:function(){return"rootCauses"===this.dataset.property?c.getLabel("rootCauseCategories",+this.dataset.category,{long:!0}):e(this).closest("tr").children().first().text()},content:function(){return"rootCauses"===this.dataset.property?s.serializeRootCausesPopover(+this.dataset.change,+this.dataset.value,+this.dataset.category):t.escape(this.title)}}),s.timers.updateTimes||(s.timers.updateTimes=setInterval(s.updateTimes.bind(s),3e4)),s.resize(),s.scrollToBottom()},updateHistory:function(){const t=this.model.get("changes");let s="";for(let e=this.lastChangeCount;e<t.length;++e){const i=this.serializeItem(t[e],e);this.filterItem(i)&&(s+=this.renderPartialHtml(m,{item:i}))}if(s.length){const t=this.$id("items"),i=e(s),o=t[0].scrollTop+t.outerHeight()>=t[0].scrollHeight;t.append(i),o&&this.scrollToBottom(),i.addClass("highlight")}this.lastChangeCount=t.length},updateTimes:function(){this.$(".osh-history-time").each(function(){var t=i.toTagData(this.getAttribute("datetime"));this.textContent=t.daysAgo>3?t.long:t.human})},calcHeight:function(){const t=this.$(".panel-heading"),e=this.$id(".panel-footer");return window.innerHeight-(t.outerHeight()||41)-(e.outerHeight()||139)-30},resize:function(){this.$id("items").css("max-height",this.calcHeight()+"px")},scrollToBottom:function(){const t=this.$id("items");t[0].scrollTop=t[0].scrollHeight},scrollIntoView:function(){document.scrollingElement.scrollTop=this.el.offsetTop-15},onSeen:function(){this.$(".osh-unseen").removeClass("osh-unseen")},diff:{rootCauses:(t,e)=>{const s=new Map,i=new Map;(t||[]).forEach(t=>{s.set(t.category,t.why.filter(t=>!!t))}),(e||[]).forEach(t=>{i.set(t.category,t.why.filter(t=>!!t))});const o=[],a=[],n=[];return s.forEach((t,e)=>{const s=i.get(e);i.delete(e),s?JSON.stringify(t)!==JSON.stringify(s)&&a.push({category:e,why:s,old:{category:e,why:t}}):n.push({category:e,why:t})}),i.forEach((t,e)=>{o.push({category:e,why:t})}),[null,{added:o,edited:a,deleted:n}]}}})});