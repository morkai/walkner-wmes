define(["underscore","jquery","app/i18n","app/time","app/user","app/viewport","app/core/View","app/core/templates/userInfo","app/core/util/html","app/wmes-osh-common/dictionaries","app/wmes-osh-common/templates/history/panel","app/wmes-osh-common/templates/history/item"],function(e,t,s,i,o,n,a,r,l,c,h,m){"use strict";const u={statusComment:!0,statusUpdater:!0,startedAt:!0,implementedAt:!0,finishedAt:!0};return a.extend({nlsDomain:"wmes-osh-common",template:h,events:{"click #-commentsOnly":function(){this.commentsOnly=!this.commentsOnly,this.commentsOnly?localStorage.setItem("OSH_HISTORY_COMMENTS_ONLY","1"):localStorage.removeItem("OSH_HISTORY_COMMENTS_ONLY"),this.render(),this.commentsOnly&&(this.scrollToBottom(),this.scrollIntoView())},"click #-maximize":function(){this.commentsOnly&&this.scrollToBottom(),this.scrollIntoView()},"keyup #-comment":function(e){if(e.ctrlKey&&"Enter"===e.key)return this.$id("submit").click(),!1},"submit form":function(){const e=this.$id("submit"),t=this.$id("comment"),s=t.val().trim();if(this.scrollIntoView(),!s.replace(/[^a-zA-Z0-9]+/g,"").length)return t.val("").focus(),!1;e.prop("disabled",!0),t.prop("disabled",!0);const i=this.ajax({method:"PUT",url:this.model.url(),data:JSON.stringify({comment:s})});return i.fail(()=>n.msg.savingFailed()),i.done(()=>{n.msg.saved(),t.val("")}),i.always(()=>{e.prop("disabled",!1),t.prop("disabled",!1).focus()}),!1}},initialize:function(){this.commentsOnly="1"===localStorage.getItem("OSH_HISTORY_COMMENTS_ONLY"),this.once("afterRender",()=>{this.listenTo(this.model,"change:changes",e.debounce(this.updateHistory,1)),this.listenTo(this.model,"seen",this.onSeen)}),t(window).on(`resize.${this.idPrefix}`,e.debounce(this.resize.bind(this),33))},getTemplateData:function(){return{renderItem:this.renderPartialHtml.bind(this,m),items:this.serializeItems(),canComment:this.model.constructor.can.comment(this.model),commentsOnly:this.commentsOnly,maxHeight:this.calcHeight()}},serializeItems:function(){return this.model.get("changes").map(this.serializeItem,this).filter(this.filterItem,this)},filterItem:function(e){return!(this.commentsOnly&&!e.comment)&&(!!e.comment||!!e.changes.length)},serializeItem:function(t,s){const o=this.model.getObserver(),n=Date.parse(t.date),a=o.notify&&o.lastSeenAt<n,l=this.commentsOnly?[]:e.map(t.data,(e,t)=>{if(u[t])return null;const i=this.translate(`PROPERTY:${t}`);return this.diff[t]&&(e=this.diff[t](e[0],e[1])),null===e[0]&&e[1]&&(e[1].added||e[1].edited||e[1].deleted)?{label:i,values:this.serializeItemValues(t,e[1],s)}:{label:i,oldValue:this.serializeItemValue(t,e[0],!0,s),newValue:this.serializeItemValue(t,e[1],!1,s)}}).filter(e=>!!e);return{i:s,time:i.toTagData(n),user:r(t.user,{noIp:!0}),changes:l,comment:t.comment.trim(),unseen:a}},translate:function(e,t){const s=this.model.getNlsDomain();return this.t.has(s,e)?this.t(s,e,t):this.t(e,t)},serializeItemValue:function(t,s,o,n){if(null==s||""===s||Array.isArray(s)&&0===s.length)return"-";if(0===s)return 0;if("boolean"==typeof s)return this.t("core","BOOL:"+s);switch("string"==typeof s&&(s=e.escape(s)),t){case"implementer":case"implementers":case"coordinators":return r(s);case"plannedAt":return i.utc.format(s,"LL");case"eventDate":return i.utc.format(s,this.translate("details:eventDate:format"));case"problem":case"reason":case"suggestion":case"solution":return s.length<=43?s:{more:s,toString:()=>`${s.substr(0,40)}...`};case"priority":case"status":case"kind":case"workplace":case"division":case"building":case"location":case"station":case"eventCategory":case"reasonCategory":{const i=e.escape(c.getLabel(t,s,{long:!0})),o=e.escape(c.getLabel(t,s,{long:!1}));return i>43?o>43?{more:i,toString:()=>`${i.substr(0,40)}...`}:{more:i,toString:()=>o}:i}case"attachments":{const t=`<a href="${this.model.getAttachmentUrl(s)}&change=${n}" target="_blank">`;let i="";return s.kind&&this.t.has(`history:attachmentKind:${s.kind}`)&&(i=" ("+this.t(`history:attachmentKind:${s.kind}`)+")"),s.name.length<=43?`${t}${e.escape(s.name)}</a>${i}`:{more:s.name,toString:()=>`${t}${e.escape(s.name).substr(0,40)}...</a>${i}`}}case"relations":return this.translate(`relation:${s.type}`,s);case"resolution":return s._id?this.translate(`resolution:link:${s.type}`,s):this.translate(`resolution:desc:${s.type}`);case"rootCauses":{const e=c.getLabel("rootCauseCategories",s.category).toLocaleLowerCase();return s.why.length?l.tag("a",{href:"javascript:void(0)",className:"has-more",data:{change:n,value:o?0:1,property:t,category:s.category}},`${e} (${s.why.length})`):`${e} (0)`}default:return s||""}},serializeItemValues:function(e,{added:t,edited:s,deleted:i},o){const n=[];return(i||[]).forEach(t=>n.push({oldValue:this.serializeItemValue(e,t,!0,o),newValue:"-"})),(t||[]).forEach(t=>n.push({oldValue:"-",newValue:this.serializeItemValue(e,t,!1,o)})),(s||[]).forEach(t=>n.push({oldValue:this.serializeItemValue(e,Object.assign({},t,t.old),!0,o),newValue:this.serializeItemValue(e,t,!1,o)})),n},serializeRootCausesPopover:function(t,s,i){const o=this.model.get("changes")[t];if(!o||!o.data.rootCauses)return;const n=o.data.rootCauses[s];if(!n||!n.length)return;const a=n.find(e=>e.category===i);return a?"<ol><li>"+a.why.filter(e=>!!e).map(t=>e.escape(t)).join("<li>")+"</ol>":void 0},afterRender:function(){const s=this;s.lastChangeCount=s.model.get("changes").length,s.$el.popover({container:"body",selector:".has-more",placement:"top",trigger:"hover",className:"osh-history-popover",html:!0,title:function(){return"rootCauses"===this.dataset.property?c.getLabel("rootCauseCategories",+this.dataset.category,{long:!0}):t(this).closest("tr").children().first().text()},content:function(){return"rootCauses"===this.dataset.property?s.serializeRootCausesPopover(+this.dataset.change,+this.dataset.value,+this.dataset.category):e.escape(this.title)}}),s.timers.updateTimes||(s.timers.updateTimes=setInterval(s.updateTimes.bind(s),3e4)),s.resize(),s.scrollToBottom()},updateHistory:function(){const e=this.model.get("changes");let s="";for(let t=this.lastChangeCount;t<e.length;++t){const i=this.serializeItem(e[t],t);this.filterItem(i)&&(s+=this.renderPartialHtml(m,{item:i}))}if(s.length){const e=this.$id("items"),i=t(s),o=e[0].scrollTop+e.outerHeight()>=e[0].scrollHeight;e.append(i),o&&this.scrollToBottom(),i.addClass("highlight")}this.lastChangeCount=e.length},updateTimes:function(){this.$(".osh-history-time").each(function(){var e=i.toTagData(this.getAttribute("datetime"));this.textContent=e.daysAgo>3?e.long:e.human})},calcHeight:function(){const e=this.$(".panel-heading"),t=this.$id(".panel-footer");return window.innerHeight-(e.outerHeight()||41)-(t.outerHeight()||139)-30},resize:function(){this.$id("items").css("max-height",this.calcHeight()+"px")},scrollToBottom:function(){const e=this.$id("items");e[0].scrollTop=e[0].scrollHeight},scrollIntoView:function(){document.scrollingElement.scrollTop=this.el.offsetTop-15},onSeen:function(){this.$(".osh-unseen").removeClass("osh-unseen")},diff:{rootCauses:(e,t)=>{const s=new Map,i=new Map;(e||[]).forEach(e=>{s.set(e.category,e.why.filter(e=>!!e))}),(t||[]).forEach(e=>{i.set(e.category,e.why.filter(e=>!!e))});const o=[],n=[],a=[];return s.forEach((e,t)=>{const s=i.get(t);i.delete(t),s?JSON.stringify(e)!==JSON.stringify(s)&&n.push({category:t,why:s,old:{category:t,why:e}}):a.push({category:t,why:e})}),i.forEach((e,t)=>{o.push({category:t,why:e})}),[null,{added:o,edited:n,deleted:a}]}}})});