define(["jquery","underscore","js2form","select2","app/data/localStorage","app/core/View","app/wmes-osh-common/dictionaries","app/wmes-osh-common/templates/orgUnits/pickerDialog"],function(t,e,i,a,n,o,r,c){"use strict";const s={long:!1};return o.extend({template:c,nlsDomain:"wmes-osh-common",events:{submit:function(t){t.preventDefault();const e=this.$('input[name="orgUnitType"]:checked').val(),i=this.$id(e).select2("val");this.trigger("picked",e,i)},'change input[type="radio"]':function(t){this.$id(t.currentTarget.value).select2("focus")},"click #-deactivated":function(){var t="1"===(n.getItem("WMES:OrgUnitPicker:deactivated")||"0")?"0":"1";n.setItem("WMES:OrgUnitPicker:deactivated",t),this.$id("deactivated").toggleClass("active","1"===t),this.setUpOrgUnitsSelect2()},"change .osh-orgUnitPicker-orgUnits":function(t){this.$(t.target).closest(".form-group").find('input[type="radio"]').click()}},initialize:function(){this.model.orgUnitTypes||(this.model.orgUnitTypes=r.ORG_UNITS.filter(t=>"station"!==t))},getTemplateData:function(){var t=this;return{orgUnits:t.model.orgUnitTypes.map(e=>({type:e,label:t.model.resolveLabel(e)})),deactivated:"1"===n.getItem("WMES:OrgUnitPicker:deactivated")}},afterRender:function(){i(this.el,this.serializeFormData()),this.setUpOrgUnitsSelect2()},onDialogShown:function(){var t=this.$('input[name="orgUnitType"]:checked').val();t?this.$id(t).select2("focus"):this.$('input[name="orgUnitType"]').first().click()},serializeFormData:function(){const t={orgUnitType:this.model.orgUnitType};return t[t.orgUnitType]=this.model.orgUnitIds.join(","),t},setUpOrgUnitsSelect2:function(){this.model.orgUnitTypes.forEach(this.setUpOrgUnitSelect2,this)},setUpOrgUnitSelect2:function(t){const i=[];return"department"===t?this.serializeDepartmentData(i):this.serializeData(t,i),this.$id(t).select2({multiple:!0,data:i,formatSelection:t=>{const i=e.escape(t.selection||t.text);return t.deactivated?'<span style="text-decoration: line-through">'+i+"</span>":i},formatResult:(t,e,i,n)=>{const o=[];return o.push('<span style="text-decoration: '+(t.deactivated?"line-through":"initial")+'">'),a.util.markMatch(t.text,i.term,o,n),o.push("</span>"),o.join("")}})},serializeData:function(t,e){const i="1"===n.getItem("WMES:OrgUnitPicker:deactivated");r.forProperty(t).forEach(a=>{if(!i&&!a.get("active"))return;let n,o=a.getLabel(),c=a.getLabel(s);"department"===t?n=r.workplaces.getLabel(a.get("workplace"),s):"station"===t&&(n=r.locations.getLabel(a.get("location"),s)),n&&(o=`${n} > ${o}`,c=`${n} > ${c}`);const l={id:a.id,selection:c,text:o,deactivated:!a.get("active"),orgUnit:a};e.push(l)}),e.sort((t,e)=>t.text.localeCompare(e.text,void 0,{numeric:!0,ignorePunctuation:!0}))},serializeDepartmentData:function(t){const e="1"===n.getItem("WMES:OrgUnitPicker:deactivated"),i={};r.departments.forEach(t=>{if(!e&&!t.get("active"))return;const a=t.get("workplace");i[a]||(i[a]=[]),i[a].push({id:t.id.toString(),selection:r.workplaces.getLabel(a,s)+" > "+t.getLabel(s),text:t.getLabel(),deactivated:!t.get("active"),orgUnit:t})}),Object.keys(i).sort((t,e)=>(t=r.workplaces.getLabel(t),e=r.workplaces.getLabel(e),t.localeCompare(e,void 0,{numeric:!0,ignorePunctuation:!0}))).forEach(e=>{const a=r.workplaces.get(e),n=i[e];n.sort((t,e)=>t.text.localeCompare(e.text,void 0,{numeric:!0,ignorePunctuation:!0})),t.push({text:a?a.getLabel():e,children:n,deactivated:!a||!a.get("active")})})}})});