define(["underscore","jquery","app/viewport","app/core/View","app/core/views/DialogView","app/core/util/fileIcons","app/planning/util/contextMenu","./EditAttachmentView","app/wmes-osh-common/templates/attachments/panel","app/wmes-osh-common/templates/attachments/preview","app/wmes-osh-common/templates/attachments/delete"],function(t,e,i,n,s,h,a,o,r,d,c){"use strict";return n.extend({nlsDomain:"wmes-osh-common",template:r,events:{"click .osh-attachment":function(t){const e=this.$(t.currentTarget);if(0===t.button&&!t.ctrlKey&&e.find(".osh-attachment-img").length)return this.showPreview(e[0].dataset.id),!1},"contextmenu .osh-attachment":function(t){t.preventDefault();const e=this.model.get("attachments").find(e=>e._id===t.currentTarget.dataset.id);if(!e)return;const i=[{icon:"fa-external-link",label:this.t("attachments:open"),handler:this.handleOpenAttachment.bind(this,e)}];this.model.constructor.can.editAttachment(this.model,e)&&i.push({icon:"fa-edit",label:this.t("attachments:edit"),handler:this.handleEditAttachment.bind(this,e)}),this.model.constructor.can.deleteAttachment(this.model,e)&&i.push({icon:"fa-trash",label:this.t("attachments:delete"),handler:this.handleDeleteAttachment.bind(this,e)}),a.show(this,t.pageY,t.pageX,i)}},initialize:function(){this.$preview=null,this.once("afterRender",()=>{this.listenTo(this.model,"change:attachments",t.debounce(this.render,1)),this.listenTo(this.model,"seen",this.onSeen)}),e(window).on(`keydown.${this.idPrefix}`,this.onWindowKeyDown.bind(this)).on(`resize.${this.idPrefix}`,t.debounce(this.onWidowResize.bind(this),33))},destroy:function(){e(window).off(`.${this.idPrefix}`),this.$preview&&(this.$preview.remove(),this.$preview=null)},getTemplateData:function(){const t=this.model.getObserver();return{panelTitle:this.getPanelTitle(),attachments:this.serializeAttachments(),unseen:t.notify&&(t.changes.all||!!t.changes.attachments),hideEmpty:!!this.options.hideEmpty}},getPanelTitle:function(){return this.t(`attachments:panelTitle:${this.options.kind||"default"}`)},serializeAttachments:function(){return this.model.get("attachments").filter(this.filterAttachment,this).map(t=>({_id:t._id,time:Date.parse(t.date),name:t.name,icon:h.getByMime(t.type),image:t.type.startsWith("image/"),url:this.model.getAttachmentUrl(t)})).sort((t,e)=>t.image&&!e.image?-1:!t.image&&e.image?1:t.time-e.time)},filterAttachment:function(t){return!this.options.kind||(t.kind||"other")===this.options.kind},afterRender:function(){this.toggleBorders()},toggleBorders:function(){const t=this.$(".osh-attachments");if(!t.length)return;const e=t.parent().outerWidth()-(this.$el.hasClass("osh-attachments-bordered")?30:0);this.$el.toggleClass("osh-attachments-bordered",t.outerWidth()<e)},handleOpenAttachment:function(t){window.open(this.model.getAttachmentUrl(t),"_blank")},handleEditAttachment:function(t){const e=new o({model:this.model,attachment:t});i.showDialog(e,this.t("attachments:edit:title"))},handleDeleteAttachment:function(t){const e=new s({template:c,nlsDomain:this.nlsDomain,model:t});i.showDialog(e,this.t("attachments:delete:title")),this.listenTo(e,"answered",e=>{"yes"===e&&this.deleteAttachment(t)})},deleteAttachment:function(t){i.msg.saving();const e=this.ajax({method:"PUT",url:this.model.url(),data:JSON.stringify({attachments:{deleted:[t._id]}})});e.fail(function(){i.msg.savingFailed()}),e.done(function(){i.msg.saved()})},showPreview:function(t){const e=this.model.get("attachments").find(e=>e._id===t);if(!e&&this.$preview)return this.hidePreview();this.$preview||(this.$preview=this.renderPartial(d).appendTo(document.body),this.$preview.find(".osh-attachment-preview-close").on("click",this.hidePreview.bind(this)),this.$preview.find(".osh-attachment-preview-prev").on("click",this.prevPreview.bind(this)),this.$preview.find(".osh-attachment-preview-next").on("click",this.nextPreview.bind(this)),this.$preview.on("wheel",()=>!1));const i=this.model.getAttachmentUrl(e),n=this.$preview.find(".osh-attachment-preview-img"),s=this.$preview.find(".osh-attachment-preview-name");n.css("background-image",`url(${i})`),s.text(e.name),this.$preview.data("attachmentId",t),this.$preview.removeClass("hidden"),s.css("margin-left",s.outerWidth()/2*-1+"px")},hidePreview:function(){this.$preview&&this.$preview.addClass("hidden")},prevPreview:function(){if(!this.$preview||this.$preview.hasClass("hidden"))return;const t=this.model.get("attachments").filter(t=>t.type.startsWith("image/")&&this.filterAttachment(t));if(!t.length)return this.hidePreview();const e=this.$preview.data("attachmentId"),i=t.findIndex(t=>t._id===e);let n=0;0===i?n=t.length-1:-1!==i&&1!==i&&(n=i-1),this.showPreview(t[n]._id)},nextPreview:function(){if(!this.$preview||this.$preview.hasClass("hidden"))return;const t=this.model.get("attachments").filter(t=>t.type.startsWith("image/")&&this.filterAttachment(t));if(!t.length)return this.hidePreview();const e=this.$preview.data("attachmentId"),i=t.findIndex(t=>t._id===e);let n=0;-1!==i&&i!==t.length-1&&(n=i+1),this.showPreview(t[n]._id)},onWindowKeyDown:function(t){const e=t.key.toLowerCase();"escape"===e?this.hidePreview():"arrowleft"===e||"a"===e?this.prevPreview():"arrowright"!==e&&"d"!==e||this.nextPreview()},onWidowResize:function(){this.toggleBorders()},onSeen:function(){this.$(".osh-unseen").removeClass("osh-unseen")}})});