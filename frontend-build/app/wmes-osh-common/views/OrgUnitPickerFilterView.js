define(["underscore","jquery","app/i18n","app/viewport","app/core/View","../dictionaries","./OrgUnitPickerDialogView","app/orgUnits/templates/pickerFilter"],function(e,t,i,n,r,o,s,l){"use strict";var a={division:"division",workplace:"workplace",mrpControllers:"mrpControllers",prodFlow:"prodFlow",workCenter:"workCenter",prodLine:"prodLine"};return r.extend({template:l,events:{"click #-showDialog":function(){var t=new s({model:{subdivisionFilter:this.options.subdivisionFilter,resolveLabel:this.resolveLabel.bind(this),orgUnitTypes:this.options.orgUnitTypes,orgUnitType:this.model.type,orgUnitIds:e.pluck(this.model.units,"id")}});this.listenTo(t,"picked",function(e,t){n.closeDialog(),0===t.length?(this.model.type=null,this.model.units=[]):(this.model.type=e,this.model.units=t.map(function(t){return orgUnits.getByTypeAndId(e,t)})),this.render()}),n.showDialog(t,i("orgUnits","picker:dialog:title"))},"click #-clear":function(){this.model={type:null,units:[]},this.render()}},initialize:function(){var t=this;t.termToType={},t.typeToTerm={},e.forEach(t.options.orgUnitTerms||a,function(e,i){t.termToType[i]=e,t.typeToTerm[e]=i}),t.model=t.getOrgUnitsFromRql(),t.listenTo(t.filterView,"filtering",t.onFiltering),t.listenTo(t.filterView,"filterChanged",t.onFilterChanged)},getTemplateData:function(){var e=this.model;return{active:!!e.type,label:this.resolveLabel(e.type),button:e.type?e.units.map(function(t){var i=t.getLabel();return"subdivision"===e.type&&(i=t.get("division")+" > "+i),i}).join("; "):i("orgUnits","picker:any")}},resolveLabel:function(e){if(!e)return i("orgUnits","picker:label");var t=this.options.orgUnitLabels;return t&&t[e]?String(t[e]):i("core","ORG_UNIT:"+e)},getOrgUnitsFromRql:function(){var e="array"===this.options.mode,t=this.termToType,i=null,n=[];return this.filterView.model.rqlQuery.selector.args.forEach(function(r){i||(e||"eq"!==r.name&&"in"!==r.name?e&&"orgUnit"===r.name&&(n=[].concat(r.args),i=t[n.shift()]):(i=t[r.args[0]],n=Array.isArray(r.args[1])?r.args[1]:[r.args[1]]))}),{type:n.length?i:null,units:n.map(function(e){return orgUnits.getByTypeAndId(i,e)}).filter(function(e){return!!e})}},onFiltering:function(t){if(this.model.type&&this.model.units.length){var i=e.pluck(this.model.units,"id");"array"===this.options.mode?t.push({name:"orgUnit",args:[this.typeToTerm[this.model.type]].concat(i)}):t.push({name:1===i.length?"eq":"in",args:[this.typeToTerm[this.model.type],1===i.length?i[0]:i]})}}})});