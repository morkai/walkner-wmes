define(["jquery","app/broker","app/pubsub","app/user","app/i18n","app/wmes-osh-companies/CompanyCollection","app/wmes-osh-divisions/DivisionCollection","app/wmes-osh-workplaces/WorkplaceCollection","app/wmes-osh-departments/DepartmentCollection","app/wmes-osh-buildings/BuildingCollection","app/wmes-osh-locations/LocationCollection","app/wmes-osh-stations/StationCollection","app/wmes-osh-kinds/KindCollection","app/wmes-osh-activityKinds/ActivityKindCollection","app/wmes-osh-observationKinds/ObservationKindCollection","app/wmes-osh-observationCategories/ObservationCategoryCollection","app/wmes-osh-eventCategories/EventCategoryCollection","app/wmes-osh-reasonCategories/ReasonCategoryCollection","app/wmes-osh-rootCauseCategories/RootCauseCategoryCollection","app/wmes-osh-kaizenCategories/KaizenCategoryCollection","app/wmes-osh-nearMisses/NearMiss","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-actions/Action","app/wmes-osh-observations/Observation","./SettingCollection","i18n!app/nls/wmes-osh-common"],function(e,o,n,s,t,i,a,r,l,c,d,p,u,m,g,w,y,C,b,h,v,f,k,O,T){"use strict";const A="osh",K={company:"companies",division:"divisions",workplace:"workplaces",department:"departments",building:"buildings",location:"locations",station:"stations",kind:"kinds",activityKind:"activityKinds",observationKind:"observationKinds",observationCategory:"observationCategories",eventCategory:"eventCategories",reasonCategory:"reasonCategories",rootCauseCategory:"rootCauseCategories",kaizenCategory:"kaizenCategories"},_={nearMiss:"Z",kaizen:"K",action:"A",observation:"O",accident:"W"},z={nearMiss:v,kaizen:f,action:k,observation:O};let E=null,P=null,M=null,L=null,D=null;const R=new WeakSet,S={TYPE_TO_PREFIX:_,PREFIX_TO_TYPE:{Z:"nearMiss",K:"kaizen",A:"action",O:"observation"},TYPE_TO_MODULE:{nearMiss:"nearMisses",kaizen:"kaizens",action:"actions",observation:"observations"},TYPE_TO_MODEL:z,ORG_UNITS:["division","workplace","department","building","location","station"],statuses:{nearMiss:[],kaizen:[],actions:[],observations:[]},priorities:[],kindTypes:[],entryTypes:Object.keys(_),settings:new T,companies:new i,divisions:new a,workplaces:new r,departments:new l,buildings:new c,locations:new d,stations:new p,kinds:new u,activityKinds:new m,observationKinds:new g,observationCategories:new w,eventCategories:new y,reasonCategories:new C,rootCauseCategories:new b,kaizenCategories:new h,currencyFormatter:new Intl.NumberFormat("pl",{style:"currency",currency:"PLN"}),loaded:!1,load:function(){return null!==P&&(clearTimeout(P),P=null),S.loaded?e.Deferred().resolve():null!==E?E:((E=e.ajax({url:"/osh/dictionaries"})).done(e=>{S.loaded=!0,I(e)}),E.fail($),E.always(()=>E=null),M=n.sandbox(),Object.keys(K).forEach(e=>{M.subscribe(`${A}.${K[e]}.**`,N)}),S.settings.setUpPubsub(M),j(),E)},unload:function(){null!==P&&clearTimeout(P),P=setTimeout($,3e4)},getLabel:function(e,o,n){if(null==o)return"";if("priority"===e)return t("wmes-osh-common",`priority:${o}`);if("status"===e)return t("wmes-osh-common",`status:${o}`);if(!o)return"";if("string"==typeof e&&(e=this.forProperty(e)||S[e]),!e||Array.isArray(e))return String(o);if(Array.isArray(o))return o.map(o=>{const s=e.get(o);return s?s.getLabel(n):String(o)}).join("; ");const s=e.get(o);return s?s.getLabel(n):String(o)},getDescription:function(e,o){if("string"==typeof e&&(e=this.forProperty(e)||S[e]),!e||Array.isArray(e))return"";if(Array.isArray(o))return o.map(o=>{const n=e.get(o);return n&&n.get("description")||""}).filter(e=>!!e).join("; ");const n=e.get(o);return n&&n.get("description")||""},forProperty:function(e){return this[K[e]]||null},bind:function(e){return R.has(e)?e:(R.add(e),e.on("beforeLoad",(e,o)=>{o.push({priority:!0,promise:this.load()})}),e.on("afterRender",()=>{this.load()}),e.once("remove",()=>{this.unload(),R.delete(e)}),e)},isCoordinator:function(){return null===D&&(D=s.isAllowedTo("OSH:COORDINATOR")||S.kinds.some(e=>e.get("coordinators").some(e=>e.id===s.data._id))||S.departments.some(e=>e.get("coordinators").some(e=>e.id===s.data._id))),D}};function j(){L&&(L.cancel(),L=null),M&&s.isLoggedIn()&&(L=M.subscribe(`${A}.*.seen.${s.data._id}`,(e,n)=>o.publish(n,e)))}function I(e){e&&["statuses","priorities","kindTypes"].forEach(o=>{e[o]&&(S[o]=e[o])}),Object.keys(K).forEach(o=>{const n=K[o];Array.isArray(S[n])?S[n]=e?e[n]:[]:S[n]&&S[n].reset&&S[n].reset(e?e[n]:[])}),S.settings.reset(e?e.settings:[])}function $(){P=null,null!==M&&(M.destroy(),M=null,L=null),S.loaded=!1,I()}function N(e,n){const s=n.split("."),t=S[s[1]];if(t){switch(s[2]){case"added":t.add(e.model);break;case"edited":{const o=t.get(e.model._id);o&&o.set(e.model);break}case"deleted":t.remove(t.get(e.model._id))}o.publish(n,e)}}return o.subscribe("user.reloaded",()=>j()),S.kinds.on("reset change:coordinators",()=>D=null),S.departments.on("reset change:coordinators",()=>D=null),window.oshDictionaries=S});