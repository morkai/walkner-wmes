define(["jquery","app/broker","app/pubsub","app/user","app/i18n","app/wmes-osh-companies/CompanyCollection","app/wmes-osh-workplaces/WorkplaceCollection","app/wmes-osh-divisions/DivisionCollection","app/wmes-osh-buildings/BuildingCollection","app/wmes-osh-locations/LocationCollection","app/wmes-osh-stations/StationCollection","app/wmes-osh-kinds/KindCollection","app/wmes-osh-activityKinds/ActivityKindCollection","app/wmes-osh-observationKinds/ObservationKindCollection","app/wmes-osh-observationCategories/ObservationCategoryCollection","app/wmes-osh-eventCategories/EventCategoryCollection","app/wmes-osh-reasonCategories/ReasonCategoryCollection","app/wmes-osh-rootCauseCategories/RootCauseCategoryCollection","./SettingCollection"],function(e,o,i,n,s,t,r,a,l,d,c,u,p,g,C,b,m,w,y){"use strict";const v="osh",h={company:"companies",workplace:"workplaces",division:"divisions",building:"buildings",location:"locations",station:"stations",kind:"kinds",activityKind:"activityKinds",observationKind:"observationKinds",observationCategory:"observationCategories",eventCategory:"eventCategories",reasonCategory:"reasonCategories",rootCauseCategory:"rootCauseCategories"};let f=null,k=null,K=null,A=null,$=null;const L={statuses:{nearMiss:[],kaizen:[]},priorities:[],kindTypes:[],settings:new y,companies:new t,workplaces:new r,divisions:new a,buildings:new l,locations:new d,stations:new c,kinds:new u,activityKinds:new p,observationKinds:new g,observationCategories:new C,eventCategories:new b,reasonCategories:new m,rootCauseCategories:new w,loaded:!1,load:function(){return null!==k&&(clearTimeout(k),k=null),L.loaded?null:null!==f?f:((f=e.ajax({url:"/osh/dictionaries"})).done(e=>{L.loaded=!0,_(e)}),f.fail(j),f.always(()=>f=null),K=i.sandbox(),Object.keys(h).forEach(e=>{K.subscribe(`${v}.${h[e]}.**`,E)}),L.settings.setUpPubsub(K),T(),f)},unload:function(){null!==k&&clearTimeout(k),k=setTimeout(j,3e4)},getLabel:function(e,o,i){if("priority"===e)return s("wmes-osh-common",`priority:${o}`);if(!o)return"";if("status"===e)return s("wmes-osh-common",`status:${o}`);if("string"==typeof e&&(e=this.forProperty(e)||L[e]),!e||Array.isArray(e))return String(o);var n=e.get(o);return n?n.getLabel(i):String(o)},getDescription:function(e,o){if("string"==typeof e&&(e=this.forProperty(e)||L[e]),!e||Array.isArray(e))return"";var i=e.get(o);return i&&i.get("description")||""},forProperty:function(e){return this[h[e]]||null},bind:function(e){var o=this;return e.on("beforeLoad",(e,i)=>{i.push(o.load())}),e.on("afterRender",o.load.bind(o)),e.once("remove",o.unload.bind(o)),e},isCoordinator:function(){return null===$&&($=L.kinds.some(e=>e.get("coordinators").some(e=>e.id===n.data._id))||L.divisions.some(e=>e.get("coordinators").some(e=>e.id===n.data._id))),$}};function T(){A&&(A.cancel(),A=null),K&&n.isLoggedIn()&&(A=K.subscribe(`${v}.*.seen.${n.data._id}`,(e,i)=>o.publish(i,e)))}function _(e){e&&["statuses","priorities","kindTypes"].forEach(o=>{e[o]&&(L[o]=e[o])}),Object.keys(h).forEach(o=>{var i=h[o];Array.isArray(L[i])?L[i]=e?e[i]:[]:L[i]&&L[i].reset&&L[i].reset(e?e[i]:[])}),L.settings.reset(e?e.settings:[])}function j(){k=null,null!==K&&(K.destroy(),K=null,A=null),L.loaded=!1,_()}function E(e,i){const n=i.split("."),s=L[n[1]];if(s){switch(n[2]){case"added":s.add(e.model);break;case"edited":{const o=s.get(e.model._id);o&&o.set(e.model);break}case"deleted":s.remove(s.get(e.model._id))}o.publish(i,e)}}return o.subscribe("user.reloaded",()=>T()),L.kinds.on("reset change:coordinators",()=>$=null),L.divisions.on("reset change:coordinators",()=>$=null),window.oshDictionaries=L});