define(["jquery","app/broker","app/pubsub","app/user","app/i18n","app/wmes-osh-workplaces/WorkplaceCollection","app/wmes-osh-divisions/DivisionCollection","app/wmes-osh-buildings/BuildingCollection","app/wmes-osh-locations/LocationCollection","app/wmes-osh-kinds/KindCollection","app/wmes-osh-activityKinds/ActivityKindCollection","app/wmes-osh-eventCategories/EventCategoryCollection","app/wmes-osh-reasonCategories/ReasonCategoryCollection","./SettingCollection"],function(e,i,n,o,t,s,r,a,l,u,d,c,p,g){"use strict";const y="osh",b={workplace:"workplaces",division:"divisions",building:"buildings",location:"locations",kind:"kinds",activityKind:"activityKinds",eventCategory:"eventCategories",reasonCategory:"reasonCategories"};let f=null,w=null,h=null,m=null;const v={statuses:{nearMiss:[],kaizen:[]},priorities:[],kindTypes:[],settings:new g,workplaces:new s,divisions:new r,buildings:new a,locations:new l,kinds:new u,activityKinds:new d,eventCategories:new c,reasonCategories:new p,loaded:!1,load:function(){return null!==w&&(clearTimeout(w),w=null),v.loaded?null:null!==f?f:((f=e.ajax({url:"/osh/dictionaries"})).done(e=>{v.loaded=!0,k(e)}),f.fail(A),f.always(()=>f=null),h=n.sandbox(),Object.keys(b).forEach(e=>{h.subscribe(`${y}.${b[e]}.**`,K)}),v.settings.setUpPubsub(h),C(),f)},unload:function(){null!==w&&clearTimeout(w),w=setTimeout(A,3e4)},getLabel:function(e,i,n){if("priority"===e)return t("wmes-osh-common",`priority:${i}`);if("status"===e)return t("wmes-osh-common",`status:${i}`);if("string"==typeof e&&(e=this.forProperty(e)||v[e]),!e||Array.isArray(e))return String(i);var o=e.get(i);return o?o.getLabel(n):String(i)},getDescription:function(e,i){if("string"==typeof e&&(e=this.forProperty(e)||v[e]),!e||Array.isArray(e))return"";var n=e.get(i);return n&&n.get("description")||""},forProperty:function(e){return this[b[e]]||null},bind:function(e){var i=this;return e.on("beforeLoad",(e,n)=>{n.push(i.load())}),e.on("afterRender",i.load.bind(i)),e.once("remove",i.unload.bind(i)),e}};function C(){m&&(m.cancel(),m=null),h&&o.isLoggedIn()&&(m=h.subscribe(`${y}.*.seen.${o.data._id}`,(e,n)=>i.publish(n,e)))}function k(e){e&&["statuses","priorities","kindTypes"].forEach(i=>{e[i]&&(v[i]=e[i])}),Object.keys(b).forEach(i=>{var n=b[i];Array.isArray(v[n])?v[n]=e?e[n]:[]:v[n]&&v[n].reset&&v[n].reset(e?e[n]:[])}),v.settings.reset(e?e.settings:[])}function A(){w=null,null!==h&&(h.destroy(),h=null,m=null),v.loaded=!1,k()}function K(e,n){const o=n.split("."),t=v[o[1]];if(t){switch(o[2]){case"added":t.add(e.model);break;case"edited":{const i=t.get(e.model._id);i&&i.set(e.model);break}case"deleted":t.remove(t.get(e.model._id))}i.publish(n,e)}}return i.subscribe("user.reloaded",()=>C()),v});