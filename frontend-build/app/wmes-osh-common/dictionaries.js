define(["jquery","app/broker","app/pubsub","app/user","app/wmes-osh-workplaces/WorkplaceCollection","app/wmes-osh-divisions/DivisionCollection","app/wmes-osh-buildings/BuildingCollection","app/wmes-osh-eventCategories/EventCategoryCollection","app/wmes-osh-reasonCategories/ReasonCategoryCollection","./SettingCollection"],function(e,n,o,i,s,r,t,a,l,u){"use strict";var d={workplace:"workplaces",division:"divisions",building:"buildings",eventCategory:"eventCategories",reasonCategory:"reasonCategories"},c=null,p=null,g=null,b={nearMiss:{kinds:[],priorities:[]},settings:new u,workplaces:new s,divisions:new r,buildings:new t,eventCategories:new a,reasonCategories:new l,loaded:!1,load:function(){return null!==p&&(clearTimeout(p),p=null),b.loaded?null:null!==c?c:((c=e.ajax({url:"/osh/dictionaries"})).done(e=>{b.loaded=!0,f(e)}),c.fail(v),c.always(()=>c=null),g=o.sandbox(),Object.keys(d).forEach(e=>{g.subscribe(`osh.${d[e]}.**`,w)}),b.settings.setUpPubsub(g),c)},unload:function(){null!==p&&clearTimeout(p),p=setTimeout(v,3e4)},getLabel:function(e,n,o){if("string"==typeof e&&(e=this.forProperty(e)||b[e]),!e||Array.isArray(e))return n;var i=e.get(n);return i?i.getLabel(o):n},forProperty:function(e){return this[d[e]]||null},bind:function(e){var n=this;return e.on("beforeLoad",(e,o)=>{o.push(n.load())}),e.on("afterRender",n.load.bind(n)),e.once("remove",n.unload.bind(n)),e}};function f(e){Object.keys(d).forEach(n=>{var o=d[n];Array.isArray(b[o])?b[o]=e?e[o]:[]:b[o]&&b[o].reset&&b[o].reset(e?e[o]:[])}),b.settings.reset(e?e.settings:[]),e&&["nearMiss"].forEach(n=>{e[n]&&(b[n]=e[n])})}function v(){p=null,null!==g&&(g.destroy(),g=null),b.loaded=!1,f()}function w(e,o){var i=o.split("."),s=b[i[1]];if(s){switch(i[2]){case"added":s.add(e.model);break;case"edited":var r=s.get(e.model._id);r&&r.set(e.model);break;case"deleted":s.remove(s.get(e.model._id))}n.publish(o,e)}}return b});