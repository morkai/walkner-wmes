define(["jquery","app/broker","app/pubsub","app/user","app/i18n","app/wmes-osh-workplaces/WorkplaceCollection","app/wmes-osh-divisions/DivisionCollection","app/wmes-osh-buildings/BuildingCollection","app/wmes-osh-locations/LocationCollection","app/wmes-osh-stations/StationCollection","app/wmes-osh-kinds/KindCollection","app/wmes-osh-activityKinds/ActivityKindCollection","app/wmes-osh-eventCategories/EventCategoryCollection","app/wmes-osh-reasonCategories/ReasonCategoryCollection","app/wmes-osh-rootCauseCategories/RootCauseCategoryCollection","./SettingCollection"],function(e,o,i,n,t,s,r,a,l,d,u,c,p,g,C,w){"use strict";const y="osh",f={workplace:"workplaces",division:"divisions",building:"buildings",location:"locations",station:"stations",kind:"kinds",activityKind:"activityKinds",eventCategory:"eventCategories",reasonCategory:"reasonCategories",rootCauseCategory:"rootCauseCategories"};let m=null,b=null,h=null,v=null,k=null;const A={statuses:{nearMiss:[],kaizen:[]},priorities:[],kindTypes:[],settings:new w,workplaces:new s,divisions:new r,buildings:new a,locations:new l,stations:new d,kinds:new u,activityKinds:new c,eventCategories:new p,reasonCategories:new g,rootCauseCategories:new C,loaded:!1,load:function(){return null!==b&&(clearTimeout(b),b=null),A.loaded?null:null!==m?m:((m=e.ajax({url:"/osh/dictionaries"})).done(e=>{A.loaded=!0,$(e)}),m.fail(L),m.always(()=>m=null),h=i.sandbox(),Object.keys(f).forEach(e=>{h.subscribe(`${y}.${f[e]}.**`,T)}),A.settings.setUpPubsub(h),K(),m)},unload:function(){null!==b&&clearTimeout(b),b=setTimeout(L,3e4)},getLabel:function(e,o,i){if("priority"===e)return t("wmes-osh-common",`priority:${o}`);if(!o)return"";if("status"===e)return t("wmes-osh-common",`status:${o}`);if("string"==typeof e&&(e=this.forProperty(e)||A[e]),!e||Array.isArray(e))return String(o);var n=e.get(o);return n?n.getLabel(i):String(o)},getDescription:function(e,o){if("string"==typeof e&&(e=this.forProperty(e)||A[e]),!e||Array.isArray(e))return"";var i=e.get(o);return i&&i.get("description")||""},forProperty:function(e){return this[f[e]]||null},bind:function(e){var o=this;return e.on("beforeLoad",(e,i)=>{i.push(o.load())}),e.on("afterRender",o.load.bind(o)),e.once("remove",o.unload.bind(o)),e},isCoordinator:function(){return null===k&&(k=A.kinds.some(e=>e.get("coordinators").some(e=>e.id===n.data._id))||A.divisions.some(e=>e.get("coordinators").some(e=>e.id===n.data._id))),k}};function K(){v&&(v.cancel(),v=null),h&&n.isLoggedIn()&&(v=h.subscribe(`${y}.*.seen.${n.data._id}`,(e,i)=>o.publish(i,e)))}function $(e){e&&["statuses","priorities","kindTypes"].forEach(o=>{e[o]&&(A[o]=e[o])}),Object.keys(f).forEach(o=>{var i=f[o];Array.isArray(A[i])?A[i]=e?e[i]:[]:A[i]&&A[i].reset&&A[i].reset(e?e[i]:[])}),A.settings.reset(e?e.settings:[])}function L(){b=null,null!==h&&(h.destroy(),h=null,v=null),A.loaded=!1,$()}function T(e,i){const n=i.split("."),t=A[n[1]];if(t){switch(n[2]){case"added":t.add(e.model);break;case"edited":{const o=t.get(e.model._id);o&&o.set(e.model);break}case"deleted":t.remove(t.get(e.model._id))}o.publish(i,e)}}return o.subscribe("user.reloaded",()=>K()),A.kinds.on("reset change:coordinators",()=>k=null),A.divisions.on("reset change:coordinators",()=>k=null),window.oshDictionaries=A});