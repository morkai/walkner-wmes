define(["jquery","app/broker","app/pubsub","app/user","app/i18n","app/wmes-osh-companies/CompanyCollection","app/wmes-osh-workplaces/WorkplaceCollection","app/wmes-osh-divisions/DivisionCollection","app/wmes-osh-buildings/BuildingCollection","app/wmes-osh-locations/LocationCollection","app/wmes-osh-stations/StationCollection","app/wmes-osh-kinds/KindCollection","app/wmes-osh-activityKinds/ActivityKindCollection","app/wmes-osh-observationKinds/ObservationKindCollection","app/wmes-osh-observationCategories/ObservationCategoryCollection","app/wmes-osh-eventCategories/EventCategoryCollection","app/wmes-osh-reasonCategories/ReasonCategoryCollection","app/wmes-osh-rootCauseCategories/RootCauseCategoryCollection","app/wmes-osh-kaizenCategories/KaizenCategoryCollection","app/wmes-osh-nearMisses/NearMiss","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-actions/Action","app/wmes-osh-observations/Observation","./SettingCollection"],function(e,o,i,s,n,t,a,r,l,c,d,u,p,g,C,b,w,m,v,y,h,f,k,O){"use strict";const K="osh",T={company:"companies",workplace:"workplaces",division:"divisions",building:"buildings",location:"locations",station:"stations",kind:"kinds",activityKind:"activityKinds",observationKind:"observationKinds",observationCategory:"observationCategories",eventCategory:"eventCategories",reasonCategory:"reasonCategories",rootCauseCategory:"rootCauseCategories",kaizenCategory:"kaizenCategories"};let z=null,_=null,A=null,E=null,M=null;const P={TYPE_TO_PREFIX:{nearMiss:"Z",kaizen:"K",action:"A",observation:"O"},PREFIX_TO_TYPE:{Z:"nearMiss",K:"kaizen",A:"action",O:"observation"},TYPE_TO_MODULE:{nearMiss:"nearMisses",kaizen:"kaizens",action:"actions",observation:"observations"},TYPE_TO_MODEL:{nearMiss:y,kaizen:h,action:f,observation:k},statuses:{nearMiss:[],kaizen:[],actions:[],observations:[]},priorities:[],kindTypes:[],settings:new O,companies:new t,workplaces:new a,divisions:new r,buildings:new l,locations:new c,stations:new d,kinds:new u,activityKinds:new p,observationKinds:new g,observationCategories:new C,eventCategories:new b,reasonCategories:new w,rootCauseCategories:new m,kaizenCategories:new v,loaded:!1,load:function(){return null!==_&&(clearTimeout(_),_=null),P.loaded?null:null!==z?z:((z=e.ajax({url:"/osh/dictionaries"})).done(e=>{P.loaded=!0,R(e)}),z.fail(D),z.always(()=>z=null),A=i.sandbox(),Object.keys(T).forEach(e=>{A.subscribe(`${K}.${T[e]}.**`,$)}),P.settings.setUpPubsub(A),L(),z)},unload:function(){null!==_&&clearTimeout(_),_=setTimeout(D,3e4)},getLabel:function(e,o,i){if("priority"===e)return n("wmes-osh-common",`priority:${o}`);if(!o)return"";if("status"===e)return n("wmes-osh-common",`status:${o}`);if("string"==typeof e&&(e=this.forProperty(e)||P[e]),!e||Array.isArray(e))return String(o);var s=e.get(o);return s?s.getLabel(i):String(o)},getDescription:function(e,o){if("string"==typeof e&&(e=this.forProperty(e)||P[e]),!e||Array.isArray(e))return"";var i=e.get(o);return i&&i.get("description")||""},forProperty:function(e){return this[T[e]]||null},bind:function(e){var o=this;return e.on("beforeLoad",(e,i)=>{i.push(o.load())}),e.on("afterRender",o.load.bind(o)),e.once("remove",o.unload.bind(o)),e},isCoordinator:function(){return null===M&&(M=s.isAllowedTo("OSH:COORDINATOR")||P.kinds.some(e=>e.get("coordinators").some(e=>e.id===s.data._id))||P.divisions.some(e=>e.get("coordinators").some(e=>e.id===s.data._id))),M}};function L(){E&&(E.cancel(),E=null),A&&s.isLoggedIn()&&(E=A.subscribe(`${K}.*.seen.${s.data._id}`,(e,i)=>o.publish(i,e)))}function R(e){e&&["statuses","priorities","kindTypes"].forEach(o=>{e[o]&&(P[o]=e[o])}),Object.keys(T).forEach(o=>{var i=T[o];Array.isArray(P[i])?P[i]=e?e[i]:[]:P[i]&&P[i].reset&&P[i].reset(e?e[i]:[])}),P.settings.reset(e?e.settings:[])}function D(){_=null,null!==A&&(A.destroy(),A=null,E=null),P.loaded=!1,R()}function $(e,i){const s=i.split("."),n=P[s[1]];if(n){switch(s[2]){case"added":n.add(e.model);break;case"edited":{const o=n.get(e.model._id);o&&o.set(e.model);break}case"deleted":n.remove(n.get(e.model._id))}o.publish(i,e)}}return o.subscribe("user.reloaded",()=>L()),P.kinds.on("reset change:coordinators",()=>M=null),P.divisions.on("reset change:coordinators",()=>M=null),window.oshDictionaries=P});