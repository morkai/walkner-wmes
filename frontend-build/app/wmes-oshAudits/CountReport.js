define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","../kaizenOrders/dictionaries"],function(t,o,e,r,s,i){"use strict";var a=["total","countBySection","countByStatus","nok","nokBySection","nokByCategory"];return r.extend({urlRoot:"/oshAudits/reports/count",nlsDomain:"wmes-oshAudits",defaults:function(){return{from:0,to:0,interval:"month",sections:[],auditor:""}},fetch:function(o){return t.isObject(o)||(o={}),o.data=t.assign(o.data||{},t.pick(this.attributes,["from","to","interval","sections","auditor"])),o.data.sections=o.data.sections.join(","),r.prototype.fetch.call(this,o)},genClientUrl:function(){return"/oshAudits/reports/count?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&auditor="+this.get("auditor")},parse:function(o){var e=this,r=o.totals,s={total:{rows:[{id:"audit",abs:r.count,rel:1,color:"#337ab7"}],series:{audit:{data:[],color:"#337ab7"}}},auditors:{categories:this.prepareUserCategories(o.users,r.auditors),series:this.prepareAuditorSeries(r.auditors,o.groups)},nok:{rows:[{id:"nok",abs:r.nok,rel:1,color:"#d9534f"}],series:{nok:{data:[],color:"#d9534f"}}}};return i.controlCategories.forEach(function(t){o.categories[t.id]=t.get("shortName")}),t.forEach(a,function(t){if(!s[t]){var i=r[t.replace("BySection","").replace("ByCategory","")],a=r[t],n="sections",u=o.sections;/ByCategory$/.test(t)?(n="categories",u=o.categories):/ByStatus$/.test(t)&&(n="statuses",u={}),s[t]={rows:e.prepareRows(i,a,n,u),series:{}}}}),t.forEach(o.groups,function(o){var r;"number"==typeof o?o={key:r=o,type:{}}:r=o.key,s.total.series.audit.data.push({x:r,y:o.count||null}),s.nok.series.nok.data.push({x:r,y:o.nok||null}),t.forEach(a,function(t){e.createSeriesFromRows(t,s,o)})}),s},prepareRows:function(t,e,r,i){var a=this.nlsDomain,n={id:"total",abs:0,rel:1,color:"#DDD",label:o(a,"report:series:total")},u=e.map(function(e){var u;return n.abs+=e[1],u="statuses"===r?o(a,"status:"+e[0]):i[e[0]]||e[0],{id:e[0],abs:e[1],rel:e[1]/t,color:s.getColor("oshAudits/count/"+r,e[0]),label:u}});return u.push(n),u},createSeriesFromRows:function(o,e,r){var s=e[o].series;t.forEach(e[o].rows,function(t){s[t.id]||(s[t.id]={name:t.label,data:[],color:t.color}),s[t.id].data.push({x:r.key,y:r[o]&&r[o][t.id]||null})})},prepareUserCategories:function(t,o){return o.map(function(o){var e=o[0];return t[e]||e})},prepareAuditorSeries:function(e){var r=[{id:"audit",name:o(this.nlsDomain,"report:series:audit"),data:[],color:"#337ab7"}];return t.forEach(e,function(t){r[0].data.push(t[1])}),r}},{TABLE_AND_CHART_METRICS:a,fromQuery:function(o){return void 0===o.from&&void 0===o.to&&(o.from=e.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+o.from||void 0,to:+o.to||void 0,interval:o.interval||void 0,sections:t.isEmpty(o.sections)?[]:o.sections.split(","),auditor:o.auditor||""})}})});