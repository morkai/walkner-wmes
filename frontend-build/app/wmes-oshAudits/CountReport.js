define(["underscore","../i18n","../time","../core/Model","../data/colorFactory","../kaizenOrders/dictionaries"],function(t,e,o,r,s,i){"use strict";var a=["total","countBySection","countByStatus","nok","nokBySection","nokByCategory"];return r.extend({urlRoot:"/oshAudits/reports/count",nlsDomain:"wmes-oshAudits",defaults:function(){return{from:0,to:0,interval:"month",sections:[],auditor:""}},fetch:function(e){return t.isObject(e)||(e={}),e.data=t.assign(e.data||{},t.pick(this.attributes,["from","to","interval","sections","auditor"])),e.data.sections=e.data.sections.join(","),r.prototype.fetch.call(this,e)},genClientUrl:function(){return"/oshAuditCountReport?from="+this.get("from")+"&to="+this.get("to")+"&interval="+this.get("interval")+"&sections="+this.get("sections")+"&auditor="+this.get("auditor")},parse:function(e){var o=this,r=e.totals,s={total:{rows:[{id:"audit",abs:r.count,rel:1,color:"#337ab7"}],series:{audit:{data:[],color:"#337ab7"}}},auditors:{categories:this.prepareUserCategories(e.users,r.auditors),series:this.prepareAuditorSeries(r.auditors,e.groups)},owners:{categories:this.prepareUserCategories(e.users,r.owners),series:this.prepareOwnerSeries(r.owners,e.groups)},nok:{rows:[{id:"nok",abs:r.nok,rel:1,color:"#d9534f"}],series:{nok:{data:[],color:"#d9534f"}}}};return i.controlCategories.forEach(function(t){e.categories[t.id]=t.get("shortName")}),t.forEach(a,function(t){if(!s[t]){var i=r[t.replace("BySection","").replace("ByCategory","")],a=r[t],n="sections",u=e.sections;/ByCategory$/.test(t)?(n="categories",u=e.categories):/ByStatus$/.test(t)&&(n="statuses",u={}),s[t]={rows:o.prepareRows(i,a,n,u),series:{}}}}),t.forEach(e.groups,function(e){var r;"number"==typeof e?e={key:r=e,type:{}}:r=e.key,s.total.series.audit.data.push({x:r,y:e.count||null}),s.nok.series.nok.data.push({x:r,y:e.nok||null}),t.forEach(a,function(t){o.createSeriesFromRows(t,s,e)})}),s},prepareRows:function(t,o,r,i){var a=this.nlsDomain,n={id:"total",abs:0,rel:1,color:"#DDD",label:e(a,"report:series:total")},u=o.map(function(o){var u;return n.abs+=o[1],u="statuses"===r?e(a,"status:"+o[0]):i[o[0]]||o[0],{id:o[0],abs:o[1],rel:o[1]/t,color:s.getColor("oshAudits/count/"+r,o[0]),label:u}});return u.push(n),u},createSeriesFromRows:function(e,o,r){var s=o[e].series;t.forEach(o[e].rows,function(t){s[t.id]||(s[t.id]={name:t.label,data:[],color:t.color}),s[t.id].data.push({x:r.key,y:r[e]&&r[e][t.id]||null})})},prepareUserCategories:function(t,e){return e.map(function(e){var o=e[0];return t[o]||o})},prepareAuditorSeries:function(o){var r=[{id:"audit",name:e(this.nlsDomain,"report:series:audit"),data:[],color:"#337ab7"}];return t.forEach(o,function(t){r[0].data.push(t[1])}),r},prepareOwnerSeries:function(o){var r=[{id:"nok",name:e(this.nlsDomain,"report:series:nok"),data:[],color:"#d9534f"}];return t.forEach(o,function(t){r[0].data.push(t[1])}),r}},{TABLE_AND_CHART_METRICS:a,fromQuery:function(e){return void 0===e.from&&void 0===e.to&&(e.from=o.getMoment().startOf("month").subtract(3,"months").valueOf()),new this({from:+e.from||void 0,to:+e.to||void 0,interval:e.interval||void 0,sections:t.isEmpty(e.sections)?[]:e.sections.split(","),auditor:e.auditor||""})}})});