define(["underscore","app/time","app/user","app/core/util/idAndLabel","app/core/util/buttonGroup","app/core/views/FormView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","../OshAudit","app/wmes-oshAudits/templates/form","app/wmes-oshAudits/templates/_formResult","app/wmes-oshAudits/templates/_formRidEditor"],function(t,e,i,o,n,s,r,a,d,l,u,c){"use strict";return s.extend({template:l,events:Object.assign({"click .oshAudits-form-radio":function(t){"TD"===t.target.tagName&&t.target.querySelector('input[type="radio"]').click()},'mousedown input[type="radio"]':function(t){t.preventDefault()},'mouseup input[type="radio"]':function(t){t.preventDefault()},'click input[type="radio"]':function(t){var e=this,i=t.target,o=e.$(i).closest("tr"),n=o.find('input[name="'+i.name+'"][value="-1"]');n.length&&(t.preventDefault(),setTimeout(function(){i.checked=!i.checked,i.checked&&"0"===i.value&&e.$id("nokConfirmValue").prop("checked",!1),i.checked||n.prop("checked",!0),e.toggleResult(o),e.toggleValidity()},1))},"click #-addOther":function(){var t=a.controlCategories.get("000000000000000000000000");this.addResult({category:t.id,shortName:t.get("shortName"),fullName:t.get("fullName"),ok:!1,comment:""}),this.toggleValidity()},"change #-auditor":function(){this.setUpSectionSelect2(),this.renderResults()},"change #-section":function(){this.renderResults()},"click .oshAudits-form-rid-message > a":function(){sessionStorage.setItem("AUD_LAST",JSON.stringify(t.assign(this.model.toJSON(),this.getFormData())))},"click a[role=rid]":function(t){return this.showRidEditor(t.currentTarget.dataset.kind,t.currentTarget),!1}},s.prototype.events),initialize:function(){s.prototype.initialize.apply(this,arguments),this.resultI=0},toggleValidity:function(){var t=!!this.$('input[value="1"]:checked').length,e=!!this.$('input[value="0"]:checked').length,i=this.$id("results")[0].childElementCount>0;this.$id("results").find('input[value="1"]').first()[0].setCustomValidity(t||e?"":this.t("FORM:empty")),this.$id("nokConfirmGroup").toggleClass("hidden",!i||!e),this.$id("nokConfirmValue").prop("required",e)},checkValidity:function(t){return t.results.some(function(t){return null!==t.ok})},serializeToForm:function(){var t=this.model.toJSON();return t.status||(t.status="new"),t.date=e.format(t.date||new Date,"YYYY-MM-DD"),t},serializeForm:function(t){var i=this.$id("auditor").select2("data"),o=e.getMoment(t.date,"YYYY-MM-DD");t.auditor={id:i.id,label:i.text},t.date=o.isValid()?o.toISOString():null;var n=!1;return t.results=(t.results||[]).map(function(t){return t.ok="1"===t.ok||"0"!==t.ok&&null,!1===t.ok?n=!0:t.comment="",t.comment||(t.comment=""),t}),n||(t.nearMiss=0),t.comment||(t.comment=""),t},afterRender:function(){s.prototype.afterRender.call(this),n.toggle(this.$id("statusGroup")),this.setUpAuditorSelect2(),this.setUpSectionSelect2(),this.renderResults()},setUpAuditorSelect2:function(){var t=this.model.get("auditor")||i.getInfo(),e={};e[t.id]={id:t.id,text:t.label},a.sections.forEntryType("audits").forEach(function(t){t.get("active")&&t.get("auditors").forEach(function(t){e[t.id]={id:t.id,text:t.label}})}),this.$id("auditor").val(t.id).select2({data:Object.values(e)}).select2("enable",!this.options.editMode&&d.can.manage())},setUpSectionSelect2:function(){var t=d.can.manage(),e=a.sections.get(this.model.get("section")),i=this.$id("auditor").val(),n={};e&&(n[e.id]=o(e)),a.sections.forEntryType("audits").forEach(function(e){e.get("active")&&(t||e.get("auditors").some(function(t){return t.id===i}))&&(n[e.id]=o(e))}),n=Object.values(n);var s=this.$id("section");e?s.val(e.id):1===n.length?s.val(n[0].id):s.val(""),s.select2({data:n}),s.select2("enable",!this.options.editMode&&t)},renderResults:function(){var t=this,e=t.model.get("results");if(e&&e.length)return e.forEach(t.addResult,t),void t.toggleValidity();var i=a.sections.get(t.$id("section").val());t.$id("results").empty(),i&&(i.get("controlLists").forEach(function(e){var i=a.controlLists.get(e);if(i&&i.get("active")){var o={};i.get("categories").forEach(function(e){o[e._id]||(o[e._id]=!0,t.addResult({category:e._id,shortName:e.shortName,fullName:e.fullName,ok:null,comment:""}))})}}),t.toggleValidity())},addResult:function(t){var e=this.renderPartial(u,{i:++this.resultI,result:t});this.$id("results").append(e)},toggleResult:function(t){var e=0===+t.find('input[name$=".ok"]:checked').val();t.find("textarea").prop("disabled",!e)},handleSuccess:function(){sessionStorage.removeItem("AUD_LAST"),s.prototype.handleSuccess.apply(this,arguments)},showRidEditor:function(t,e){var i=this,o=i.$(e);if(o.next(".popover").length)o.popover("destroy");else{o.popover({placement:"auto top",html:!0,trigger:"manual",content:this.renderPartialHtml(c,{property:t,rid:this.model.get(t)||""})}).popover("show");var n=o.next(".popover"),s=n.find(".form-control").select(),r=n.find(".btn-default"),a=n.find(".btn-link");a.on("click",function(){o.popover("destroy")}),s.on("keydown",function(t){if(13===t.keyCode)return!1}),s.on("keyup",function(t){if(13===t.keyCode)return r.click(),!1}),r.on("click",function(){s.prop("disabled",!0),r.prop("disabled",!0),a.prop("disabled",!0);var e=parseInt(s.val(),10)||0;if(e<=0)return d(null);var o=("nearMiss"===t?"/kaizen/orders":"/suggestions")+"/"+e,n=i.ajax({url:o});return n.fail(function(t){i.showErrorMessage(i.t("FORM:ridEditor:"+(404===t.status?"notFound":"failure"))),s.prop("disabled",!1),r.prop("disabled",!1),a.prop("disabled",!1),(404===t.status?s:r).focus()}),n.done(function(){d(e)}),!1})}function d(e){o.popover("destroy").closest(".message").find(".oshAudits-form-rid-message").html(i.t("FORM:MSG:"+t+":"+(e?"edit":"add"),{rid:e})),i.model.attributes[t]=e,i.$('input[name="'+t+'"]').val(e||"")}}})});