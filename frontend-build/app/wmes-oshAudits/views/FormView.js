define(["underscore","app/time","app/user","app/core/util/idAndLabel","app/core/util/buttonGroup","app/core/views/FormView","app/users/util/setUpUserSelect2","app/kaizenOrders/dictionaries","../OshAudit","app/wmes-oshAudits/templates/form","app/wmes-oshAudits/templates/_formResult"],function(t,e,i,o,n,s,a,r,l,u,d){"use strict";return s.extend({template:u,events:Object.assign({"click .oshAudits-form-radio":function(t){"TD"===t.target.tagName&&t.target.querySelector('input[type="radio"]').click()},'mousedown input[type="radio"]':function(t){t.preventDefault()},'mouseup input[type="radio"]':function(t){t.preventDefault()},'click input[type="radio"]':function(t){var e=this,i=t.target,o=e.$(i).closest("tr"),n=o.find('input[name="'+i.name+'"][value="-1"]');n.length&&(t.preventDefault(),setTimeout(function(){i.checked=!i.checked,i.checked&&"0"===i.value&&e.$id("nokConfirmValue").prop("checked",!1),i.checked||n.prop("checked",!0),e.toggleResult(o),e.toggleValidity()},1))},"click #-addOther":function(){var t=r.controlCategories.get("000000000000000000000000");this.addResult({category:t.id,shortName:t.get("shortName"),fullName:t.get("fullName"),ok:!1,comment:""})},"change #-auditor":function(){this.setUpSectionSelect2(),this.renderResults()},"change #-section":function(){this.renderResults()}},s.prototype.events),initialize:function(){s.prototype.initialize.apply(this,arguments),this.resultI=0},toggleValidity:function(){var t=!!this.$('input[value="1"]:checked').length,e=!!this.$('input[value="0"]:checked').length;this.$('input[value="1"]').first()[0].setCustomValidity(t||e?"":this.t("FORM:empty")),this.$id("nokConfirmGroup").toggleClass("hidden",!e),this.$id("nokConfirmValue").prop("required",e)},checkValidity:function(t){return t.results.some(function(t){return null!==t.ok})},serializeToForm:function(){var t=this.model.toJSON();return t.status||(t.status="new"),t.date=e.format(t.date||new Date,"YYYY-MM-DD"),t.nokConfirm=1,t},serializeForm:function(t){var i=this.$id("auditor").select2("data"),o=e.getMoment(t.date,"YYYY-MM-DD");return t.auditor={id:i.id,label:i.text},t.date=o.isValid()?o.toISOString():null,t.results=(t.results||[]).map(function(t,e){return t.ok="1"===t.ok||"0"!==t.ok&&null,!1!==t.ok&&(t.comment=""),t.comment||(t.comment=""),t}),t.comment||(t.comment=""),t},afterRender:function(){s.prototype.afterRender.call(this),n.toggle(this.$id("statusGroup")),this.setUpAuditorSelect2(),this.setUpSectionSelect2(),this.renderResults()},setUpAuditorSelect2:function(){var t=this.model.get("auditor")||i.getInfo(),e={};e[t.id]={id:t.id,text:t.label},r.sections.forEntryType("audits").forEach(function(t){t.get("active")&&t.get("auditors").forEach(function(t){e[t.id]={id:t.id,text:t.label}})}),this.$id("auditor").val(t.id).select2({data:Object.values(e)}).select2("enable",!this.options.editMode&&l.can.manage())},setUpSectionSelect2:function(){var t=l.can.manage(),e=r.sections.get(this.model.get("section")),i=this.$id("auditor").val(),n={};e&&(n[e.id]=o(e)),r.sections.forEntryType("audits").forEach(function(e){e.get("active")&&(t||e.get("auditors").some(function(t){return t.id===i}))&&(n[e.id]=o(e))}),n=Object.values(n);var s=this.$id("section");e?s.val(e.id):1===n.length?s.val(n[0].id):s.val(""),s.select2({data:n}),s.select2("enable",!this.options.editMode&&t)},renderResults:function(){var t=this;if(t.options.editMode)return t.model.get("results").forEach(t.addResult,t),void t.toggleValidity();var e=r.sections.get(t.$id("section").val());t.$id("results").empty(),e&&(e.get("controlLists").forEach(function(e){var i=r.controlLists.get(e);if(i&&i.get("active")){var o={};i.get("categories").forEach(function(e){o[e._id]||(o[e._id]=!0,t.addResult({category:e._id,shortName:e.shortName,fullName:e.fullName,ok:null,comment:""}))})}}),t.toggleValidity())},addResult:function(t){var e=this.renderPartial(d,{i:++this.resultI,result:t});this.$id("results").append(e)},toggleResult:function(t){var e=0===+t.find('input[name$=".ok"]:checked').val();t.find("textarea").prop("disabled",!e)}})});