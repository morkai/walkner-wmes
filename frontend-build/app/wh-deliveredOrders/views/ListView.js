define(["jquery","app/user","app/viewport","app/core/views/ListView","../WhDeliveredOrderCollection","./FormView","./RedirView","app/wh-deliveredOrders/templates/confirm","i18n!app/nls/wh-deliveredOrders"],function(e,i,t,o,n,s,r,c){"use strict";return o.extend({className:"is-colored",localTopics:{"socket.connected":"refreshCollectionNow"},remoteTopics:function(){var e={};return e[this.collection.getTopicPrefix()+".updated"]="onUpdated",e},events:Object.assign({"click .action-edit":function(e){this.hidePopover();var i=this.$(e.currentTarget).closest(".list-item")[0].dataset.id,o=this.collection.get(i),n=new s({model:o});t.showDialog(n,this.t("FORM:edit:title"))},"click .action-redir":function(e){this.hidePopover();var i=this.$(e.currentTarget).closest(".list-item")[0].dataset.id,o=this.collection.get(i),n=new r({model:o});t.showDialog(n,this.t("redir:title"))},"click .action-finish":function(e){this.confirm(e.currentTarget,this.finish.bind(this))},"click .action-block":function(e){this.confirm(e.currentTarget,this.block.bind(this))},"click .action-unblock":function(e){this.confirm(e.currentTarget,this.unblock.bind(this))}},o.prototype.events),columns:function(){return[{id:"line",className:"is-min",tdClassName:"text-fixed",titleProperty:"redirLine",visible:!1!==this.options.showLineColumn},{id:"sapOrder",className:"is-min"},{id:"qty",className:"is-min text-right",tdClassName:"text-right"},{id:"pceTime",className:"is-min"},{id:"date",className:"is-min"},{id:"set",className:"is-min"},{id:"status",valueProperty:"statusText",className:"is-min"},"-"]},actions:function(){var e=this,i=n.can.manage();return function(t){var o=[];return i?(o.push({id:"finish",icon:"check",label:e.t("LIST:ACTION:finish"),className:"done"===t.status?"disabled":""}),o.push({id:"redir",icon:"arrow-right",label:e.t("LIST:ACTION:redir"),className:"done"===t.status?"disabled":""}),"blocked"===t.status?o.push({id:"unblock",icon:"unlock",label:e.t("LIST:ACTION:unblock")}):o.push({id:"block",icon:"lock",label:e.t("LIST:ACTION:block"),className:"done"===t.status?"disabled":""}),o.push({id:"edit",icon:"edit",label:e.t("core","LIST:ACTION:edit")}),o):o}},initialize:function(){o.prototype.initialize.apply(this,arguments),this.once("afterRender",function(){this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"remove",this.onRemoved),this.listenTo(this.collection,"change:status",this.onStatusChanged)}),e(window).on("resize."+this.idPrefix,this.onWindowResize.bind(this)).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){o.prototype.destroy.apply(this,arguments),e(window).off("."+this.idPrefix),this.hidePopover()},onUpdated:function(e){var i=this,t=i.collection.getLineFilter(),o=i.collection.getSapOrderFilter(),n=!t&&!o;(e.added||[]).forEach(function(e){e.line!==t&&e.sapOrder!==o||(n=!0)}),(e.updated||[]).forEach(function(e){var s=i.collection.get(e._id);s?(s.set(e),t&&s.get("line")!==t&&(n=!0)):e.line!==t&&e.sapOrder!==o||(n=!0)}),(e.deleted||[]).forEach(function(e){i.collection.get(e._id)&&(n=!0)}),n&&i.refreshCollection()},hidePopover:function(){this.$popover&&(this.$popover.popover("destroy"),this.$popover=null)},confirm:function(e,i){var t=this,o=t.$popover&&t.$popover.data("actionId")||null,n=e.dataset.id,s=t.$popover&&t.$popover.data("modelId")||null,r=t.$(e).closest(".list-item")[0].dataset.id;if(t.hidePopover(),n!==o||r!==s){t.$popover=t.$(e).popover({container:t.el,trigger:"manual",placement:"left",html:!0,title:function(){return""},content:t.renderPartialHtml(c,{action:e.dataset.id}),css:{marginLeft:"2px"},contentCss:{padding:"0"}}),t.$popover.data("actionId",n).data("modelId",r).popover("show");var d=t.$popover.data("bs.popover").$tip;d.find(".btn-danger").on("click",function(){return t.hidePopover(),!1}),d.find(".btn-success").on("click",function(){return t.hidePopover(),i(r),!1})}},finish:function(e){this.edit(e,{qtyDone:this.collection.get(e).get("qtyTodo")})},block:function(e){this.edit(e,{blocked:!0})},unblock:function(e){this.edit(e,{blocked:!1})},edit:function(e,i){t.msg.saving();var o=this.collection.get(e),n=this.promised(o.save(i,{wait:!0}));n.fail(function(){t.msg.savingFailed()}),n.done(function(){t.msg.saved()})},onWindowResize:function(){this.hidePopover()},onWindowKeyDown:function(e){if("Escape"===e.key&&this.$popover)return this.hidePopover(),!1},onReset:function(){o.prototype.onReset.apply(this,arguments),this.$popover&&!this.collection.get(this.$popover.data("modelId"))&&this.hidePopover()},onStatusChanged:function(e){clearTimeout(this.timers[e.id]),-1===this.collection.getStatusFilter().indexOf(e.get("status"))&&(this.timers[e.id]=setTimeout(this.removeOrder.bind(this),3e4,e))},removeOrder:function(e){delete this.timers[e.id],-1===this.collection.getStatusFilter().indexOf(e.get("status"))&&this.collection.remove(e)},onRemoved:function(e){this.$row(e.id).remove(),this.$(".list-item").length||this.refreshCollectionNow()}})});