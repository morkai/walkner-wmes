define(["jquery","app/user","app/viewport","app/core/views/ListView","../WhDeliveredOrderCollection","./FormView","./RedirView","app/wh-deliveredOrders/templates/confirm"],function(i,e,t,o,n,s,c,r){"use strict";return o.extend({className:"is-colored",localTopics:{"socket.connected":"refreshCollectionNow"},remoteTopics:function(){var i={};return i[this.collection.getTopicPrefix()+".updated"]="onUpdated",i},events:Object.assign({"click .action-edit":function(i){this.hidePopover();var e=this.$(i.currentTarget).closest(".list-item")[0].dataset.id,o=this.collection.get(e),n=new s({model:o});t.showDialog(n,this.t("FORM:edit:title"))},"click .action-redir":function(i){this.hidePopover();var e=this.$(i.currentTarget).closest(".list-item")[0].dataset.id,o=this.collection.get(e),n=new c({model:o});t.showDialog(n,this.t("redir:title"))},"click .action-finish":function(i){this.confirm(i.currentTarget,this.finish.bind(this))},"click .action-block":function(i){this.confirm(i.currentTarget,this.block.bind(this))},"click .action-unblock":function(i){this.confirm(i.currentTarget,this.unblock.bind(this))}},o.prototype.events),columns:[{id:"line",className:"is-min",tdClassName:"text-fixed",titleProperty:"redirLine"},{id:"sapOrder",className:"is-min"},{id:"qty",className:"is-min text-right",tdClassName:"text-right"},{id:"pceTime",className:"is-min"},{id:"date",className:"is-min"},{id:"set",className:"is-min"},{id:"status",valueProperty:"statusText",className:"is-min"},"-"],actions:function(){var i=this,e=n.can.manage();return function(t){var o=[];return e?(o.push({id:"finish",icon:"check",label:i.t("LIST:ACTION:finish"),className:"done"===t.status?"disabled":""}),o.push({id:"redir",icon:"arrow-right",label:i.t("LIST:ACTION:redir"),className:"done"===t.status?"disabled":""}),"blocked"===t.status?o.push({id:"unblock",icon:"unlock",label:i.t("LIST:ACTION:unblock")}):o.push({id:"block",icon:"lock",label:i.t("LIST:ACTION:block"),className:"done"===t.status?"disabled":""}),o.push({id:"edit",icon:"edit",label:i.t("core","LIST:ACTION:edit")}),o):o}},initialize:function(){o.prototype.initialize.apply(this,arguments),this.once("afterRender",function(){this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"reset",this.onReset)}),i(window).on("resize."+this.idPrefix,this.onWindowResize.bind(this)).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){o.prototype.destroy.apply(this,arguments),i(window).off("."+this.idPrefix),this.hidePopover()},onUpdated:function(i){var e=this,t=!1,o=e.collection.getLineFilter(),n=e.collection.getSapOrderFilter();(i.added||[]).forEach(function(i){i.line!==o&&i.sapOrder!==n||(t=!0)}),(i.updated||[]).forEach(function(i){var s=e.collection.get(i._id);s?(s.set(i),s.get("line")!==o&&(t=!0)):i.line!==o&&i.sapOrder!==n||(t=!0)}),t&&e.refreshCollection()},hidePopover:function(){this.$popover&&(this.$popover.popover("destroy"),this.$popover=null)},confirm:function(i,e){var t=this,o=t.$popover&&t.$popover.data("actionId")||null,n=i.dataset.id,s=t.$popover&&t.$popover.data("modelId")||null,c=t.$(i).closest(".list-item")[0].dataset.id;if(t.hidePopover(),n!==o||c!==s){t.$popover=t.$(i).popover({container:t.el,trigger:"manual",placement:"left",html:!0,title:function(){return""},content:t.renderPartialHtml(r,{action:i.dataset.id}),css:{marginLeft:"2px"},contentCss:{padding:"0"}}),t.$popover.data("actionId",n).data("modelId",c).popover("show");var a=t.$popover.data("bs.popover").$tip;a.find(".btn-danger").on("click",function(){return t.hidePopover(),!1}),a.find(".btn-success").on("click",function(){return t.hidePopover(),e(c),!1})}},finish:function(i){this.edit(i,{qtyDone:this.collection.get(i).get("qtyTodo")})},block:function(i){this.edit(i,{blocked:!0})},unblock:function(i){this.edit(i,{blocked:!1})},edit:function(i,e){t.msg.saving();var o=this.collection.get(i),n=this.promised(o.save(e,{wait:!0}));n.fail(function(){t.msg.savingFailed()}),n.done(function(){t.msg.saved()})},onWindowResize:function(){this.hidePopover()},onWindowKeyDown:function(i){"Escape"===i.key&&this.hidePopover()},onReset:function(){o.prototype.onReset.apply(this,arguments),this.$popover&&!this.collection.get(this.$popover.data("modelId"))&&this.hidePopover()}})});