define(["jquery","app/user","app/viewport","app/core/views/ListView","./FormView","app/wh-deliveredOrders/templates/confirm"],function(i,t,e,o,n,s){"use strict";return o.extend({className:"is-colored",localTopics:{"socket.connected":"refreshCollectionNow"},remoteTopics:function(){var i={};return i[this.collection.getTopicPrefix()+".updated"]="onUpdated",i},events:Object.assign({"click .action-edit":function(i){this.hidePopover();var t=this.$(i.currentTarget).closest(".list-item")[0].dataset.id,o=this.collection.get(t),s=new n({model:o});e.showDialog(s,this.t("FORM:edit:title"))},"click .action-finish":function(i){this.confirm(i.currentTarget,this.finish.bind(this))},"click .action-block":function(i){this.confirm(i.currentTarget,this.block.bind(this))},"click .action-unblock":function(i){this.confirm(i.currentTarget,this.unblock.bind(this))}},o.prototype.events),columns:[{id:"line",className:"is-min",tdClassName:"text-fixed"},{id:"sapOrder",className:"is-min"},{id:"qty",className:"is-min text-right",tdClassName:"text-right"},{id:"pceTime",className:"is-min"},{id:"date",className:"is-min"},{id:"set",className:"is-min"},{id:"status",valueProperty:"statusText",className:"is-min"},"-"],actions:function(){var i=this,e=t.isAllowedTo("WH:MANAGE");return function(t){var o=[];return e?(o.push({id:"finish",icon:"check",label:i.t("LIST:ACTION:finish"),className:"done"===t.status?"disabled":""}),"blocked"===t.status?o.push({id:"unblock",icon:"unlock",label:i.t("LIST:ACTION:unblock")}):o.push({id:"block",icon:"lock",label:i.t("LIST:ACTION:block"),className:"done"===t.status?"disabled":""}),o.push({id:"edit",icon:"edit",label:i.t("core","LIST:ACTION:edit")}),o):o}},initialize:function(){o.prototype.initialize.apply(this,arguments),this.once("afterRender",function(){this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"reset",this.onReset)}),i(window).on("resize."+this.idPrefix,this.onWindowResize.bind(this)).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){o.prototype.destroy.apply(this,arguments),i(window).off("."+this.idPrefix),this.hidePopover()},onUpdated:function(i){var t=this,e=!1,o=t.collection.getLineFilter(),n=t.collection.getSapOrderFilter();(i.added||[]).forEach(function(i){i.line!==o&&i.sapOrder!==n||(e=!0)}),(i.updated||[]).forEach(function(i){var s=t.collection.get(i._id);s?s.set(i):i.line!==o&&i.sapOrder!==n||(e=!0)}),e&&t.refreshCollection()},hidePopover:function(){this.$popover&&(this.$popover.popover("destroy"),this.$popover=null)},confirm:function(i,t){var e=this,o=e.$popover&&e.$popover.data("actionId")||null,n=i.dataset.id,c=e.$popover&&e.$popover.data("modelId")||null,r=e.$(i).closest(".list-item")[0].dataset.id;if(e.hidePopover(),n!==o||r!==c){e.$popover=e.$(i).popover({container:e.el,trigger:"manual",placement:"left",html:!0,title:function(){return""},content:e.renderPartialHtml(s,{action:i.dataset.id}),css:{marginLeft:"2px"},contentCss:{padding:"0"}}),e.$popover.data("actionId",n).data("modelId",r).popover("show");var a=e.$popover.data("bs.popover").$tip;a.find(".btn-danger").on("click",function(){return e.hidePopover(),!1}),a.find(".btn-success").on("click",function(){return e.hidePopover(),t(r),!1})}},finish:function(i){this.edit(i,{qtyDone:this.collection.get(i).get("qtyTodo")})},block:function(i){this.edit(i,{blocked:!0})},unblock:function(i){this.edit(i,{blocked:!1})},edit:function(i,t){e.msg.saving();var o=this.collection.get(i),n=this.promised(o.save(t,{wait:!0}));n.fail(function(){e.msg.savingFailed()}),n.done(function(){e.msg.saved()})},onWindowResize:function(){this.hidePopover()},onWindowKeyDown:function(i){"Escape"===i.key&&this.hidePopover()},onReset:function(){this.$popover&&!this.collection.get(this.$popover.data("modelId"))&&this.hidePopover()}})});