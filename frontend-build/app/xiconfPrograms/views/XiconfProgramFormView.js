// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","underscore","app/i18n","app/time","app/core/views/FormView","../XiconfProgram","app/xiconfPrograms/templates/form","app/xiconfPrograms/templates/_waitForm","app/xiconfPrograms/templates/_peForm","app/xiconfPrograms/templates/_isoForm","app/xiconfPrograms/templates/_solForm","app/xiconfPrograms/templates/_programForm","app/xiconfPrograms/templates/_fnForm","app/xiconfPrograms/templates/_visForm"],function(e,t,n,a,r,o,i,s,l,p,c,m,f,u){"use strict";var d={wait:s,pe:l,iso:p,sol:c,program:m,fn:f,vis:u},h=["startTime","duration","maxDuration","ramp"];return r.extend({template:i,events:t.extend({"blur .xiconfPrograms-form-duration":function(e){e.target.value=a.toString(a.toSeconds(e.target.value),!1,!0),this.recalcTotalTime(this.$(e.target).closest(".panel-body"))},"click #-addStep":function(){var e=this.$id("stepType")[0],t=e.value;return""===t?void e.focus():(e.selectedIndex=0,this.addStep(t).find("input").first().focus(),this.validateSteps(),void this.recalcStepNo())},'click .btn[role="moveStepUp"]':function(e){var t=this.$(e.currentTarget).closest(".panel"),n=t.prev();n.length&&(t.insertBefore(n),this.recalcStepNo(),e.currentTarget.focus())},'click .btn[role="moveStepDown"]':function(e){var t=this.$(e.currentTarget).closest(".panel"),n=t.next();n.length&&(t.insertAfter(n),this.recalcStepNo(),e.currentTarget.focus())},'click .btn[role="removeStep"]':function(t){this.$(t.currentTarget).closest(".panel").fadeOut("fast",function(){e(this).remove()})},'change [name="type"]':function(e){this.$id("steps").empty();var t=this.$id("stepType");t.find('option[value!=""]').remove(),o.TYPES_TO_STEPS[e.target.value].forEach(function(e){t.append('<option value="'+e+'">'+n("xiconfPrograms","step:"+e)+"</option>")})},'change [name$="uration"]':function(e){this.validateDuration(this.$(e.target))},'change [name$="powerReq"], [name$="powerRel"]':function(e){var t=this.getPowerData(e.target);if(""!==t.rel){var n=t.rel/100;t.min=Math.round(t.req*(1-n)),t.max=Math.round(t.req*(1+n))}this.setPowerData(t)},'change [name$="powerMin"], [name$="powerMax"]':function(e){var t=this.getPowerData(e.target),n=Math.abs(Math.round(100-t.min/t.req*100)),a=Math.abs(Math.round(100-t.max/t.req*100));t.rel=n===a?n:"",this.setPowerData(t)},"change .xiconfPrograms-form-glp2-mode":function(e){this.updateGlp2SetValue(this.$(e.currentTarget).closest(".panel"))},"change .xiconfPrograms-form-glp2-tolerance":function(e){this.toggleGlp2Tolerance(this.$(e.currentTarget).closest(".panel"))},'change .xiconfPrograms-form-glp2-tolerances input[type="number"]':function(e){this.recalcGlp2Tolerance(this.$(e.currentTarget).closest(".panel"))},"change .xiconfPrograms-form-glp2-setValue":function(e){this.recalcGlp2Tolerance(this.$(e.currentTarget).closest(".panel"))}},r.prototype.events),initialize:function(){r.prototype.initialize.apply(this,arguments),this.nextStepIndex=0},afterRender:function(){var t=this,n=this.options.editMode===!0;this.nextStepIndex=0,this.model.get("steps").forEach(function(e){e.enabled&&this.addStep(e.type,t.model.get("type"))},this),r.prototype.afterRender.call(this),this.recalcStepNo(),this.validateSteps(),this.$(".xiconfPrograms-stepPanel").each(function(){var a=e(this);t.recalcTotalTime(a),t.recalcPower(a),t.updateGlp2SetValue(a,!n)})},serialize:function(){return t.extend(r.prototype.serialize.call(this),{programTypes:Object.keys(o.TYPES_TO_STEPS),stepTypes:o.TYPES_TO_STEPS[this.model.get("type")]})},serializeToForm:function(){var e=this.model.toJSON();return e.steps=t.map(t.where(e.steps,{enabled:!0}),function(e){return t.forEach(h,function(t){void 0!==e[t]&&(e[t]=a.toString(e[t]))}),e}),e},serializeForm:function(e){return e.prodLines=(e.prodLines||"").split(";").map(function(e){return e.trim()}).filter(function(e){return e.length>0}).join("; "),e.steps=t.map(e.steps,function(e){return e.enabled=!0,t.forEach(h,function(t){void 0!==e[t]&&(e[t]=a.toSeconds(e[t]))}),Object.keys(e).forEach(function(t){var n=e[t];"string"==typeof n&&/^[0-9]+(\.[0-9]+)?$/.test(n)&&(e[t]=parseFloat(e[t]))}),e}),e},addStep:function(t,n){var a=d[t];if(!a)throw new Error("Invalid step type: "+t);n||(n=this.$('[name="type"]:checked').val());var r=e(a({idPrefix:this.idPrefix+"-"+this.nextStepIndex,stepIndex:this.nextStepIndex,programType:n,inputs:o.GLP2_INPUTS}));return this.$id("steps").append(r),++this.nextStepIndex,this.recalcTotalTime(r),r},getPowerData:function(e){var t=this.$(e).closest(".row"),n=t.find('input[name$="powerReq"]'),a=t.find('input[name$="powerRel"]'),r=t.find('input[name$="powerMin"]'),o=t.find('input[name$="powerMax"]');return{$req:n,$rel:a,$min:r,$max:o,req:parseInt(n.val(),10)||0,rel:parseInt(a.val(),10)||"",min:parseInt(r.val(),10)||0,max:parseInt(o.val(),10)||0}},setPowerData:function(e){e.req<e.min&&(e.min=e.req),e.req>e.max&&(e.max=e.req),e.$req.val(e.req),e.$rel.val(e.rel||""),e.$min.val(e.min),e.$max.val(e.max)},validateDuration:function(e){if(e.length){var t=a.toSeconds(e.val())<1;e[0].setCustomValidity(t?n("xiconfPrograms","FORM:ERROR:minDuration"):"");var r=e.closest(".xiconfPrograms-stepPanel-vis");if(r.length){var o=r.find('input[name$="duration"]'),i=r.find('input[name$="maxDuration"]'),s=a.toSeconds(o.val()),l=a.toSeconds(i.val()),p="";if(s<l){if(t&&e[0]===i[0])return}else p=n("xiconfPrograms","FORM:ERROR:minMaxDurations");i[0].setCustomValidity(p)}}},validateSteps:function(){this.$id("stepType")[0].setCustomValidity(this.$id("steps").children().length?"":n("xiconfPrograms","FORM:ERROR:requiredStep"))},recalcStepNo:function(){this.$(".xiconfPrograms-form-stepNo").each(function(e){this.innerText=e+1+"."})},recalcTotalTime:function(e){var t=e.find(".xiconfPrograms-form-totalTime");if(t.length){var n=0;e.find(".xiconfPrograms-form-duration").each(function(){n+=a.toSeconds(this.value)}),t.text(a.toString(n,!1,!0))}},recalcPower:function(e){var t=e.find('input[name$="powerMin"]');t.length||t.change()},updateGlp2SetValue:function(e,t){if(e.hasClass("xiconfPrograms-stepPanel-glp2")){var a=e.find('[name$="mode"]'),r=a.find("option[value="+a.val()+"]")[0],o=r.dataset,i=e.find('[name$="setValue"]'),s=i.closest(".form-group").find("label"),l=e.find(".xiconfPrograms-form-glp2-tolerances"),p=l.find('[name$="lowerToleranceAbs"]'),c=l.find('[name$="upperToleranceAbs"]'),m=n("xiconfPrograms",o.label);if(s.html(m),void 0===o.min?(i.prop({min:0,max:1,step:1,value:0,readonly:!0}),l.find('input[type="number"]').prop({value:0,readonly:!0})):(i.prop({min:o.min,max:o.max,step:o.step,value:t?o.min:i.val(),readonly:!1}),p.prop("step",o.step),c.prop("step",o.step)),l.length){var f=m.match(/( \[.*?\])/),u=f?f[1]:"";p.prev().find("span").html(u),c.prev().find("span").html(u),this.toggleGlp2Tolerance(e,t)}}},toggleGlp2Tolerance:function(e,t){var n="5"===e.find('[name$="mode"]').val(),a=e.find(".xiconfPrograms-form-glp2-tolerance:checked").val(),r=e.find('[name$="lowerToleranceRel"]'),o=e.find('[name$="upperToleranceRel"]');void 0===a&&(a="0"===r.val()&&"0"===o.val()?"abs":"rel",e.find('.xiconfPrograms-form-glp2-tolerance[value="'+a+'"]').prop("checked",!0));var i="rel"===a,s=e.find('[name$="lowerToleranceAbs"]'),l=e.find('[name$="upperToleranceAbs"]'),p=n||!i,c=n||i;r.prop("readonly",p),o.prop("readonly",p),s.prop("readonly",c),l.prop("readonly",c),t!==!1&&(r.val(p?"0":"10"),o.val(p?"0":"10"),s.val("0"),l.val("0")),this.recalcGlp2Tolerance(e)},recalcGlp2Tolerance:function(e){var t=e.find('[name$="lowerToleranceRel"]');if(t.length){var n=e.find('[name$="upperToleranceRel"]'),a=e.find('[name$="lowerToleranceAbs"]'),r=e.find('[name$="upperToleranceAbs"]'),o=parseFloat(e.find('[name$="setValue"]').val()),i=!t.prop("readonly");if(i){var s=a.attr("step").split("."),l=2===s.length?s[1].length:0,p=o*((100-parseInt(t.val(),10))/100),c=o*((100+parseInt(n.val(),10))/100);a.val(p.toFixed(l)),r.val(c.toFixed(l))}else t.val("0"),n.val("0")}}})});