// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/time","app/core/views/FormView","app/xiconfPrograms/templates/form"],function(e,t,r,a,n){return a.extend({template:n,events:e.extend({},a.prototype.events,{"blur .xiconfPrograms-form-duration":function(e){e.target.value=r.toString(r.toSeconds(e.target.value)),this.recalcTotalTime(this.$(e.target).closest(".panel-body"))},'change [name$="enabled"]':function(e){var r=this.$(e.target),a=r.closest(".checkbox").next(),n=r.prop("checked");a.stop(!0,!1)[n?"fadeIn":"fadeOut"]("fast"),a.find("input").attr("required",n);var i=this.$('input[name$="enabled"]'),o=i.filter(":checked");i[0].setCustomValidity(o.length?"":t("xiconfPrograms","FORM:ERROR:requiredStep")),this.validateDuration(a.find('[name$="duration"]'))},'change [name$="duration"]':function(e){this.validateDuration(this.$(e.target))},"change #-fn-powerReq":function(){this.recalcPowerRelExtremes(),this.recalcPowerMinMaxExtremes()},"change #-fn-powerRel":function(e){e.target.value=Math.min(Math.max(parseInt(e.target.value,10)||0,0),100)||"",this.recalcPowerRelExtremes()},"change #-fn-powerMin, #-fn-powerMax":"recalcPowerMinMaxExtremes"}),afterRender:function(){a.prototype.afterRender.call(this);var t=this;e.forEach(this.model.get("steps"),function(e){e.enabled||t.$id("panel-"+e.type).hide()}),this.recalcTotalTime(this.$id("panel-pe")),this.recalcTotalTime(this.$id("panel-fn")),this.recalcPowerRelExtremes()},serializeToForm:function(){var e=this.model.toJSON();return e.steps=e.steps.map(function(e){return void 0!==e.startTime&&(e.startTime=r.toString(e.startTime)),void 0!==e.duration&&(e.duration=r.toString(e.duration)),e}),e},serializeForm:function(e){var t=["voltage","powerReq","powerRel","powerMin","powerMax","resistanceMax"];return e.steps=e.steps.map(function(e){return e.enabled="1"===e.enabled,void 0!==e.startTime&&(e.startTime=r.toSeconds(e.startTime)),void 0!==e.duration&&(e.duration=r.toSeconds(e.duration)),t.forEach(function(t){void 0!==e[t]&&(e[t]=parseFloat(e[t])||0)}),e}),e},validateDuration:function(e){if(e.length){var a=e.closest(".panel").prev().find("input").prop("checked");e[0].setCustomValidity(a&&r.toSeconds(e.val())<1?t("xiconfPrograms","FORM:ERROR:minDuration"):"")}},recalcTotalTime:function(e){var t=0;e.find(".xiconfPrograms-form-duration").each(function(){t+=r.toSeconds(this.value)}),e.find(".xiconfPrograms-form-totalTime").text(r.toString(t))},recalcPowerMinMaxExtremes:function(){var e=parseInt(this.$id("fn-powerReq").val(),10),t=parseInt(this.$id("fn-powerMin").val(),10),r=parseInt(this.$id("fn-powerMax").val(),10);if((!t||t>e)&&(t=e),(!r||e>r)&&(r=e),t>r){var a=t;t=r,r=a}this.$id("fn-powerMin").val(t),this.$id("fn-powerMax").val(r);var n=Math.round(100*(1-t/e)),i=Math.round(100*(r/e-1));this.$id("fn-powerRel").val(n===i&&0!==n?n:"")},recalcPowerRelExtremes:function(){var e=parseInt(this.$id("fn-powerRel").val(),10);if(!e)return this.$id("fn-powerRel").val("");var t=parseInt(this.$id("fn-powerReq").val(),10),r=Math.round(t*(1-e/100)),a=Math.round(t*(1+e/100));this.$id("fn-powerMin").val(r).attr("max",t),this.$id("fn-powerMax").val(a).attr("min",t)}})});