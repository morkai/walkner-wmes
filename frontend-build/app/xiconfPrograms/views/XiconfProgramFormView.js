// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-xiconf project <http://lukasz.walukiewicz.eu/p/walkner-xiconf>

define(["jquery","underscore","app/i18n","app/time","app/core/views/FormView","app/xiconfPrograms/templates/form","app/xiconfPrograms/templates/_waitForm","app/xiconfPrograms/templates/_peForm","app/xiconfPrograms/templates/_solForm","app/xiconfPrograms/templates/_fnForm"],function(e,t,r,n,a,i,o,s,c,p){"use strict";var l={wait:o,pe:s,sol:c,fn:p};return a.extend({template:i,events:t.extend({"blur .xiconfPrograms-form-duration":function(e){e.target.value=n.toString(n.toSeconds(e.target.value)),this.recalcTotalTime(this.$(e.target).closest(".panel-body"))},"click #-addStep":function(){var e=this.$id("stepType")[0],t=e.value;return""===t?void e.focus():(e.selectedIndex=0,this.addStep(t).find("input").first().focus(),this.validateSteps(),void this.recalcStepNo())},'click .btn[role="moveStepUp"]':function(e){var t=this.$(e.currentTarget).closest(".panel"),r=t.prev();r.length&&(t.insertBefore(r),this.recalcStepNo(),e.currentTarget.focus())},'click .btn[role="moveStepDown"]':function(e){var t=this.$(e.currentTarget).closest(".panel"),r=t.next();r.length&&(t.insertAfter(r),this.recalcStepNo(),e.currentTarget.focus())},'click .btn[role="removeStep"]':function(t){this.$(t.currentTarget).closest(".panel").fadeOut("fast",function(){e(this).remove()})},'change [name$="duration"]':function(e){this.validateDuration(this.$(e.target))},'change [name$="powerReq"], [name$="powerRel"]':function(e){var t=this.getPowerData(e.target);if(""!==t.rel){var r=t.rel/100;t.min=Math.round(t.req*(1-r)),t.max=Math.round(t.req*(1+r))}this.setPowerData(t)},'change [name$="powerMin"], [name$="powerMax"]':function(e){var t=this.getPowerData(e.target),r=Math.abs(Math.round(100-t.min/t.req*100)),n=Math.abs(Math.round(100-t.max/t.req*100));t.rel=r===n?r:"",this.setPowerData(t)}},a.prototype.events),initialize:function(){a.prototype.initialize.apply(this,arguments),this.nextStepIndex=0},afterRender:function(){this.nextStepIndex=0,this.model.get("steps").forEach(function(e){e.enabled&&this.addStep(e.type)},this),a.prototype.afterRender.call(this),this.recalcStepNo(),this.validateSteps();var t=this;this.$(".xiconfPrograms-stepPanel").each(function(){var r=e(this);t.recalcTotalTime(r),t.recalcPower(r)})},serialize:function(){return t.extend(a.prototype.serialize.call(this),{stepTypes:this.model.constructor.STEP_TYPES})},serializeToForm:function(){var e=this.model.toJSON();return e.steps=t.map(t.where(e.steps,{enabled:!0}),function(e){return void 0!==e.startTime&&(e.startTime=n.toString(e.startTime)),void 0!==e.duration&&(e.duration=n.toString(e.duration)),e}),e},serializeForm:function(e){var r=["voltage","powerReq","powerRel","powerMin","powerMax","resistanceMax"];return e.steps=t.map(e.steps,function(e){return e.enabled=!0,void 0!==e.startTime&&(e.startTime=n.toSeconds(e.startTime)),void 0!==e.duration&&(e.duration=n.toSeconds(e.duration)),t.forEach(r,function(t){void 0!==e[t]&&(e[t]=parseFloat(e[t])||0)}),e}),e},addStep:function(t){var r=l[t];if(!r)throw new Error("Invalid step type: "+t);var n=e(r({idPrefix:this.idPrefix+"-"+this.nextStepIndex,stepIndex:this.nextStepIndex}));return this.$id("steps").append(n),++this.nextStepIndex,this.recalcTotalTime(n),n},getPowerData:function(e){var t=this.$(e).closest(".row"),r=t.find('input[name$="powerReq"]'),n=t.find('input[name$="powerRel"]'),a=t.find('input[name$="powerMin"]'),i=t.find('input[name$="powerMax"]');return{$req:r,$rel:n,$min:a,$max:i,req:parseInt(r.val(),10)||0,rel:parseInt(n.val(),10)||"",min:parseInt(a.val(),10)||0,max:parseInt(i.val(),10)||0}},setPowerData:function(e){e.req<e.min&&(e.min=e.req),e.req>e.max&&(e.max=e.req),e.$req.val(e.req),e.$rel.val(e.rel||""),e.$min.val(e.min),e.$max.val(e.max)},validateDuration:function(e){e.length&&e[0].setCustomValidity(n.toSeconds(e.val())<1?r("xiconfPrograms","FORM:ERROR:minDuration"):"")},validateSteps:function(){this.$id("stepType")[0].setCustomValidity(this.$id("steps").children().length?"":r("xiconfPrograms","FORM:ERROR:requiredStep"))},recalcStepNo:function(){this.$(".xiconfPrograms-form-stepNo").each(function(e){this.innerText=e+1+"."})},recalcTotalTime:function(e){var t=e.find(".xiconfPrograms-form-totalTime");if(t.length){var r=0;e.find(".xiconfPrograms-form-duration").each(function(){r+=n.toSeconds(this.value)}),t.text(n.toString(r))}},recalcPower:function(e){var t=e.find('input[name$="powerMin"]');t.length||t.change()}})});