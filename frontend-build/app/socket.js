define(["underscore","socket.io","app/broker","app/core/Socket"],function(e,t,n,r){function i(e){""!==e||a||(o.off("error",i),o.reconnect())}var o=new r(t.connect("",{resource:"socket.io",transports:["websocket"],"auto connect":!1,"connect timeout":5e3,reconnect:!0,"reconnection delay":e.random(100,500),"reconnection limit":e.random(4e3,8e3),"max reconnection attempts":1/0})),a=!1,s=!1;return o.on("connecting",function(){n.publish("socket.connecting",!1)}),o.on("connect",function(){a||(a=!0,n.publish("socket.connected"))}),o.on("connect_failed",function(){n.publish("socket.connectFailed",!1)}),o.on("message",function(e){n.publish("socket.message",e)}),o.on("disconnect",function(){n.publish("socket.disconnected")}),o.on("reconnecting",function(){s=!0,n.publish("socket.connecting",!0)}),o.on("reconnect",function(){s=!1,n.publish("socket.connected",!0)}),o.on("reconnect_failed",function(){s=!1,n.publish("socket.connectFailed",!0)}),o.on("error",i),o.on("error",function(){s&&n.publish("socket.connectFailed",!0)}),window.socket=o,o});