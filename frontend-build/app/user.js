// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/broker","app/socket","app/viewport","app/data/divisions","app/data/subdivisions","app/core/pages/ErrorPage","app/users/pages/LogInFormPage"],function(e,a,i,n,t,r,o,d,s){"use strict";var l={};return n.on("user.reload",function(e){l.reload(e)}),n.on("user.deleted",function(){window.location.reload()}),l.data=e.extend(window.GUEST_USER||{},{name:a.bound("core","GUEST_USER_NAME")}),delete window.GUEST_USER,l.noReload=!1,l.reload=function(n){if(!e.isEqual(n,l.data)){var t=l.isLoggedIn();e.isObject(n)&&Object.keys(n).length>0&&(n.loggedIn===!1&&(n.name=a.bound("core","GUEST_USER_NAME")),"unspecified"===n.orgUnitType&&(n.orgUnitType=null,n.orgUnitId=null),l.data=n),l.data.privilegesMap=null,l.noReload?l.noReload=!1:i.publish("user.reloaded"),t&&!l.isLoggedIn()?i.publish("user.loggedOut"):!t&&l.isLoggedIn()&&i.publish("user.loggedIn")}},l.isLoggedIn=function(){return l.data.loggedIn===!0},l.getLabel=function(e){return l.data.name?String(l.data.name):l.data.lastName&&l.data.firstName?e?l.data.firstName+" "+l.data.lastName:l.data.lastName+" "+l.data.firstName:l.data.login},l.getInfo=function(){return{id:l.data._id,ip:l.data.ip||l.data.ipAddress||"0.0.0.0",cname:window.COMPUTERNAME,label:l.getLabel()}},l.isAllowedTo=function(e){if(l.data.super)return!0;var a=l.data.privileges,i=(1===arguments.length?[e]:Array.prototype.slice.call(arguments)).map(function(e){return Array.isArray(e)?e:[e]});if(i.length&&l.data.local&&i[0].some(function(e){return"LOCAL"===e}))return!0;if(!a)return!1;var n=l.isLoggedIn();if(!i.length)return n;for(var t=0,r=i.length;t<r;++t){for(var o=i[t],d=0,s=o.length,g=0;g<s;++g){var u=o[g];d+="USER"===u?n?1:0:/^FN:/.test(u)?l.data.prodFunction===u.substring(3)?1:0:l.hasPrivilege(o[g])?1:0}if(d===s)return!0}return!1},l.hasAccessToAor=function(e){return!e||l.data.super||!l.data.aors||!l.data.aors.length||l.data.aors.indexOf(e)!==-1},l.hasAccessToSubdivision=function(e){if(!e)return!0;if("division"===l.data.orgUnitType){var a=o.get(e);return a&&l.data.orgUnitId===a.get("division")}return"subdivision"!==l.data.orgUnitType||l.data.orgUnitId===e},l.auth=function(){var e=Array.prototype.slice.call(arguments);return function(a,i,n){l.isAllowedTo.apply(l,e)?n():l.isLoggedIn()?require(["app/core/pages/ErrorPage"],function(e){t.showPage(new e({model:{code:403,req:a,previousUrl:i}}))}):t.showPage(new s)}},l.getDivision=function(){var e=null;switch(l.data.orgUnitType){case"division":e=l.data.orgUnitId;break;case"subdivision":var a=o.get(l.data.orgUnitId);a&&(e=a.get("division"))}return r.get(e)||null},l.getSubdivision=function(){return"subdivision"!==l.data.orgUnitType?null:o.get(l.data.orgUnitId)||null},l.hasPrivilege=function(a){return l.data.privilegesMap||(Array.isArray(l.data.privileges)||(l.data.privileges=[]),l.data.privilegesString="|"+l.data.privileges.join("|"),l.data.privilegesMap={},e.forEach(l.data.privileges,function(e){l.data.privilegesMap[e]=!0})),"*"===a.charAt(a.length-1)?l.data.privilegesString.indexOf("|"+a.substr(0,a.length-1))!==-1:l.data.privilegesMap[a]===!0},l.getGuestUserData=function(){return window.GUEST_USER||{id:null,login:"guest",name:a.bound("core","GUEST_USER_NAME"),loggedIn:!1,super:!1,privileges:[]}},l.getRootUserData=function(){return window.ROOT_USER||{id:null,login:"root",name:"root",loggedIn:!0,super:!0,privileges:[]}},l.can={commentOrders:function(){return l.isAllowedTo("ORDERS:MANAGE","PLANNING:PLANNER","PLANNING:WHMAN","PAINT_SHOP:PAINTER","FN:master","FN:leader")}},window.user=l,l});