// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

define(["underscore","app/i18n","app/broker","app/socket","app/viewport","app/data/divisions","app/data/subdivisions","app/core/pages/ErrorPage"],function(e,a,i,t,r,n,o,d){"use strict";var s=null;-1!==window.location.search.indexOf("COMPUTERNAME=")&&window.location.search.substr(1).split("&").forEach(function(e){e=e.split("="),"COMPUTERNAME"===e[0]&&e[1]&&(s=e[1])});var g={};return t.on("user.reload",function(e){g.reload(e)}),g.data=e.extend(window.GUEST_USER||{},{name:a.bound("core","GUEST_USER_NAME")}),delete window.GUEST_USER,g.reload=function(t){if(!e.isEqual(t,g.data)){var r=g.isLoggedIn();e.isObject(t)&&Object.keys(t).length>0&&(t.loggedIn===!1&&(t.name=a.bound("core","GUEST_USER_NAME")),"unspecified"===t.orgUnitType&&(t.orgUnitType=null,t.orgUnitId=null),g.data=t),i.publish("user.reloaded"),r&&!g.isLoggedIn()?i.publish("user.loggedOut"):!r&&g.isLoggedIn()&&i.publish("user.loggedIn")}},g.isLoggedIn=function(){return g.data.loggedIn===!0},g.getLabel=function(){return g.data.name?String(g.data.name):g.data.lastName&&g.data.firstName?g.data.firstName+" "+g.data.lastName:g.data.login},g.getInfo=function(){return{id:g.data._id,ip:g.data.ip||g.data.ipAddress||"0.0.0.0",cname:s,label:g.getLabel()}},g.isAllowedTo=function(e){if(g.data["super"])return!0;var a=g.data.privileges,i=(1===arguments.length?[e]:Array.prototype.slice.call(arguments)).map(function(e){return Array.isArray(e)?e:[e]});if(i.length&&g.data.local&&i[0].some(function(e){return"LOCAL"===e}))return!0;if(!a)return!1;if(!i.length)return g.isLoggedIn();for(var t=0,r=i.length;r>t;++t){for(var n=i[t],o=0,d=n.length,s=0;d>s;++s)o+=g.hasPrivilege(n[s])?1:0;if(o===d)return!0}return!1},g.hasAccessToAor=function(e){return!e||g.data["super"]||!g.data.aors||!g.data.aors.length||-1!==g.data.aors.indexOf(e)},g.hasAccessToSubdivision=function(e){if(!e)return!0;if("division"===g.data.orgUnitType){var a=o.get(e);return a&&g.data.orgUnitId===a.get("division")}return"subdivision"===g.data.orgUnitType?g.data.orgUnitId===e:!0},g.auth=function(){var e=Array.prototype.slice.call(arguments);return function(a,t,n){g.isAllowedTo.apply(g,e)?n():g.isLoggedIn()?r.showPage(new d({code:401,req:a,referer:t})):i.publish("router.navigate",{url:"/login",trigger:!0,replace:!0})}},g.getDivision=function(){var e=null;switch(g.data.orgUnitType){case"division":e=g.data.orgUnitId;break;case"subdivision":var a=o.get(g.data.orgUnitId);a&&(e=a.get("division"))}return n.get(e)||null},g.getSubdivision=function(){return"subdivision"!==g.data.orgUnitType?null:o.get(g.data.orgUnitId)||null},g.hasPrivilege=function(a){return g.data.privilegesMap||(Array.isArray(g.data.privileges)||(g.data.privileges=[]),g.data.privilegesString="|"+g.data.privileges.join("|"),g.data.privilegesMap={},e.forEach(g.data.privileges,function(e){g.data.privilegesMap[e]=!0})),"*"===a.charAt(a.length-1)?-1!==g.data.privilegesString.indexOf("|"+a.substr(0,a.length-1)):g.data.privilegesMap[a]===!0},g.getGuestUserData=function(){return window.GUEST_USER||{id:null,login:"guest",name:a.bound("core","GUEST_USER_NAME"),loggedIn:!1,"super":!1,privileges:[]}},g.getRootUserData=function(){return window.ROOT_USER||{id:null,login:"root",name:"root",loggedIn:!0,"super":!0,privileges:[]}},window.user=g,g});