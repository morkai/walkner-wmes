define(["underscore","app/i18n","app/broker","app/socket","app/viewport","app/data/divisions","app/data/subdivisions","app/core/pages/ErrorPage","app/users/pages/LogInFormPage"],function(e,a,n,i,t,r,o,d,s){"use strict";var l=document.body.classList.contains("is-embedded"),u=[],g=0,p={};i.on("user.reload",function(e){p.reload(e)}),i.on("user.deleted",function(){window.location.reload()});var c=e.assign(window.GUEST_USER||{},{name:a.bound("core","GUEST_USER_NAME")});return delete window.GUEST_USER,p.data=c,p.noReload=!1,p.isReloadLocked=function(){return u.length>0},p.lockReload=function(){return u.push(++g)},p.unlockReload=function(e){u=u.filter(function(a){return a!==e})},p.reload=function(i){if(l&&e.assign(i,{loggedIn:!1,super:!1,privileges:c.privileges,login:c.login,name:c.name}),!e.isEqual(i,p.data)){var t=p.isLoggedIn();e.isObject(i)&&Object.keys(i).length>0&&(!1===i.loggedIn&&(i.name=a.bound("core","GUEST_USER_NAME")),"unspecified"===i.orgUnitType&&(i.orgUnitType=null,i.orgUnitId=null),p.data=i),p.data.privilegesMap=null,p.noReload?p.noReload=!1:n.publish("user.reloaded"),t&&!p.isLoggedIn()?n.publish("user.loggedOut"):!t&&p.isLoggedIn()&&n.publish("user.loggedIn")}},p.isLoggedIn=function(){return!0===p.data.loggedIn},p.getLabel=function(e){return p.data.name?String(p.data.name):p.data.lastName&&p.data.firstName?p.data.lastName===p.data.firstName?p.data.lastName:e?p.data.firstName+" "+p.data.lastName:p.data.lastName+" "+p.data.firstName:p.data.login},p.getInfo=function(){return{id:p.data._id,ip:p.data.ip||p.data.ipAddress||"0.0.0.0",cname:window.COMPUTERNAME,label:p.getLabel()}},p.isAllowedTo=function(e){if(!1===p.data.active)return!1;if(p.data.super)return!0;var a=p.data.privileges,n=(1===arguments.length?[e]:Array.prototype.slice.call(arguments)).map(function(e){return Array.isArray(e)?e:[e]});if(n.length&&p.data.local&&n[0].some(function(e){return"LOCAL"===e}))return!0;if(!a)return!1;var i=p.isLoggedIn();if(!n.length)return i;for(var t=0,r=n.length;t<r;++t){for(var o=n[t],d=0,s=o.length,l=0;l<s;++l){var u=o[l];"string"==typeof u?"USER"===u?d+=i?1:0:/^FN:/.test(u)?d+=p.data.prodFunction===u.substring(3)?1:0:d+=p.hasPrivilege(o[l])?1:0:s-=1}if(d===s)return!0}return!1},p.hasAccessToAor=function(e){return!e||p.data.super||!p.data.aors||!p.data.aors.length||-1!==p.data.aors.indexOf(e)},p.hasAccessToSubdivision=function(e){if(!e)return!0;if("division"===p.data.orgUnitType){var a=o.get(e);return a&&p.data.orgUnitId===a.get("division")}return"subdivision"!==p.data.orgUnitType||p.data.orgUnitId===e},p.auth=function(){var e=Array.prototype.slice.call(arguments);return function(a,n,i){p.isAllowedTo.apply(p,e)?i():p.isLoggedIn()?require(["app/core/pages/ErrorPage"],function(e){t.showPage(new e({model:{code:403,req:a,previousUrl:n}}))}):require(["app/viewport"],function(e){e.showPage(new s)})}},p.getDivision=function(){var e=null;switch(p.data.orgUnitType){case"division":e=p.data.orgUnitId;break;case"subdivision":var a=o.get(p.data.orgUnitId);a&&(e=a.get("division"))}return r.get(e)||null},p.getSubdivision=function(){return"subdivision"!==p.data.orgUnitType?null:o.get(p.data.orgUnitId)||null},p.hasPrivilege=function(a){return p.data.privilegesMap||(Array.isArray(p.data.privileges)||(p.data.privileges=[]),p.data.privilegesString="|"+p.data.privileges.join("|"),p.data.privilegesMap={},e.forEach(p.data.privileges,function(e){p.data.privilegesMap[e]=!0})),"*"===a.charAt(a.length-1)?-1!==p.data.privilegesString.indexOf("|"+a.substr(0,a.length-1)):!0===p.data.privilegesMap[a]},p.getGuestUserData=function(){return window.GUEST_USER||{id:null,login:"guest",name:a.bound("core","GUEST_USER_NAME"),loggedIn:!1,super:!1,privileges:[]}},p.getRootUserData=function(){return window.ROOT_USER||{id:null,login:"root",name:"root",loggedIn:!0,super:!0,privileges:[]}},p.can={commentOrders:function(){return p.isAllowedTo("ORDERS:MANAGE","ORDERS:COMMENT","PLANNING:PLANNER","PLANNING:WHMAN","PAINT_SHOP:PAINTER","FN:master","FN:leader")}},window.user=p,p});