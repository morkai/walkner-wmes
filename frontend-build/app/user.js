// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/broker","app/socket","app/viewport","app/data/divisions","app/data/subdivisions","app/core/pages/ErrorPage","app/users/pages/LogInFormPage"],function(e,a,t,i,n,r,o,d,s){"use strict";var g=null;-1!==window.location.search.indexOf("COMPUTERNAME=")&&window.location.search.substr(1).split("&").forEach(function(e){e=e.split("="),"COMPUTERNAME"===e[0]&&e[1]&&(g=e[1])});var u={};return i.on("user.reload",function(e){u.reload(e)}),i.on("user.deleted",function(){window.location.reload()}),u.data=e.extend(window.GUEST_USER||{},{name:a.bound("core","GUEST_USER_NAME")}),delete window.GUEST_USER,u.reload=function(i){if(!e.isEqual(i,u.data)){var n=u.isLoggedIn();e.isObject(i)&&Object.keys(i).length>0&&(i.loggedIn===!1&&(i.name=a.bound("core","GUEST_USER_NAME")),"unspecified"===i.orgUnitType&&(i.orgUnitType=null,i.orgUnitId=null),u.data=i),u.data.privilegesMap=null,t.publish("user.reloaded"),n&&!u.isLoggedIn()?t.publish("user.loggedOut"):!n&&u.isLoggedIn()&&t.publish("user.loggedIn")}},u.isLoggedIn=function(){return u.data.loggedIn===!0},u.getLabel=function(e){return u.data.name?String(u.data.name):u.data.lastName&&u.data.firstName?e?u.data.lastName+" "+u.data.firstName:u.data.firstName+" "+u.data.lastName:u.data.login},u.getInfo=function(){return{id:u.data._id,ip:u.data.ip||u.data.ipAddress||"0.0.0.0",cname:g,label:u.getLabel()}},u.isAllowedTo=function(e){if(u.data["super"])return!0;var a=u.data.privileges,t=(1===arguments.length?[e]:Array.prototype.slice.call(arguments)).map(function(e){return Array.isArray(e)?e:[e]});if(t.length&&u.data.local&&t[0].some(function(e){return"LOCAL"===e}))return!0;if(!a)return!1;var i=u.isLoggedIn();if(!t.length)return i;for(var n=0,r=t.length;r>n;++n){for(var o=t[n],d=0,s=o.length,g=0;s>g;++g){var l=o[g];d+="USER"===l?i?1:0:/^FN:/.test(l)?u.data.prodFunction===l.substring(3)?1:0:u.hasPrivilege(o[g])?1:0}if(d===s)return!0}return!1},u.hasAccessToAor=function(e){return!e||u.data["super"]||!u.data.aors||!u.data.aors.length||-1!==u.data.aors.indexOf(e)},u.hasAccessToSubdivision=function(e){if(!e)return!0;if("division"===u.data.orgUnitType){var a=o.get(e);return a&&u.data.orgUnitId===a.get("division")}return"subdivision"===u.data.orgUnitType?u.data.orgUnitId===e:!0},u.auth=function(){var e=Array.prototype.slice.call(arguments);return function(a,t,i){u.isAllowedTo.apply(u,e)?i():u.isLoggedIn()?n.showPage(new d({code:401,req:a,referer:t})):n.showPage(new s)}},u.getDivision=function(){var e=null;switch(u.data.orgUnitType){case"division":e=u.data.orgUnitId;break;case"subdivision":var a=o.get(u.data.orgUnitId);a&&(e=a.get("division"))}return r.get(e)||null},u.getSubdivision=function(){return"subdivision"!==u.data.orgUnitType?null:o.get(u.data.orgUnitId)||null},u.hasPrivilege=function(a){return u.data.privilegesMap||(Array.isArray(u.data.privileges)||(u.data.privileges=[]),u.data.privilegesString="|"+u.data.privileges.join("|"),u.data.privilegesMap={},e.forEach(u.data.privileges,function(e){u.data.privilegesMap[e]=!0})),"*"===a.charAt(a.length-1)?-1!==u.data.privilegesString.indexOf("|"+a.substr(0,a.length-1)):u.data.privilegesMap[a]===!0},u.getGuestUserData=function(){return window.GUEST_USER||{id:null,login:"guest",name:a.bound("core","GUEST_USER_NAME"),loggedIn:!1,"super":!1,privileges:[]}},u.getRootUserData=function(){return window.ROOT_USER||{id:null,login:"root",name:"root",loggedIn:!0,"super":!0,privileges:[]}},window.user=u,u});