define(["jquery","underscore","app/i18n","app/broker","app/socket","app/viewport","app/data/divisions","app/data/subdivisions","app/core/pages/ErrorPage"],function(a,e,n,t,i,r,o,d,s){var u=null;-1!==window.location.search.indexOf("COMPUTERNAME=")&&window.location.search.substr(1).split("&").forEach(function(a){a=a.split("="),"COMPUTERNAME"===a[0]&&a[1]&&(u=a[1])});var l={};return i.on("user.reload",function(a){l.reload(a)}),l.data=e.extend(window.GUEST_USER||{},{name:n.bound("core","GUEST_USER_NAME")}),delete window.GUEST_USER,l.reload=function(a){if(!e.isEqual(a,l.data)){var i=l.isLoggedIn();e.isObject(a)&&Object.keys(a).length>0&&(a.loggedIn===!1&&(a.name=n.bound("core","GUEST_USER_NAME")),l.data=a),t.publish("user.reloaded"),i&&!l.isLoggedIn()&&t.publish("user.loggedOut")}},l.isLoggedIn=function(){return l.data.loggedIn===!0},l.getLabel=function(){return l.data.name?String(l.data.name):l.data.lastName&&l.data.firstName?l.data.firstName+" "+l.data.lastName:l.data.login},l.getInfo=function(){return{id:l.data._id,ip:l.data.ip||l.data.ipAddress||"0.0.0.0",cname:u,label:l.getLabel()}},l.isAllowedTo=function(a){if(l.data.super)return!0;var e=l.data.privileges;if(!e)return!1;if(!a||0===a.length)return l.isLoggedIn();for(var n=[].concat(a),t=0,i=0,r=n.length;r>i;++i)if(a=n[i],"string"==typeof a)for(var o=new RegExp("^"+a.replace("*",".*?")+"$"),d=0,s=e.length;s>d;++d)if(o.test(e[d])){++t;break}return t===n.length},l.hasAccessToAor=function(a){return!a||l.data.super||!l.data.aors||!l.data.aors.length||-1!==l.data.aors.indexOf(a)},l.auth=function(a){return function(e,n,t){l.isAllowedTo(a)?t():r.showPage(new s({code:401,req:e,referer:n}))}},l.getDivision=function(){var a=null;switch(l.data.orgUnitType){case"division":a=l.data.orgUnitId;break;case"subdivision":var e=d.get(l.data.orgUnitId);e&&(a=e.get("division"))}return o.get(a)||null},l.getSubdivision=function(){return"subdivision"!==l.data.orgUnitType?null:d.get(l.data.orgUnitId)||null},window.user=l,l});