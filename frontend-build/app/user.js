define(["jquery","underscore","app/i18n","app/broker","app/socket","app/viewport","app/data/divisions","app/data/subdivisions","app/core/pages/ErrorPage"],function(e,a,n,t,i,r,o,d,s){var u=null;-1!==window.location.search.indexOf("COMPUTERNAME=")&&window.location.search.substr(1).split("&").forEach(function(e){e=e.split("="),"COMPUTERNAME"===e[0]&&e[1]&&(u=e[1])});var l={};return i.on("user.reload",function(e){l.reload(e)}),l.data=a.extend(window.GUEST_USER||{},{name:n("core","GUEST_USER_NAME")}),delete window.GUEST_USER,l.reload=function(e){if(!a.isEqual(e,l.data)){var i=l.isLoggedIn();a.isObject(e)&&Object.keys(e).length>0&&(e.loggedIn===!1&&(e.name=n("core","GUEST_USER_NAME")),l.data=e),t.publish("user.reloaded"),i&&!l.isLoggedIn()&&t.publish("user.loggedOut")}},l.isLoggedIn=function(){return l.data.loggedIn===!0},l.getLabel=function(){return l.data.name?l.data.name:l.data.lastName&&l.data.firstName?l.data.firstName+" "+l.data.lastName:l.data.login},l.getInfo=function(){return{id:l.data._id,ip:l.data.ip||l.data.ipAddress||"0.0.0.0",cname:u,label:l.getLabel()}},l.isAllowedTo=function(e){if(l.data.super)return!0;var a=l.data.privileges;if(!a)return!1;if(!e||0===e.length)return l.isLoggedIn();for(var n=[].concat(e),t=0,i=0,r=n.length;r>i;++i)if(e=n[i],"string"==typeof e)for(var o=new RegExp("^"+e.replace("*",".*?")+"$"),d=0,s=a.length;s>d;++d)if(o.test(a[d])){++t;break}return t===n.length},l.auth=function(e){return function(a,n,t){l.isAllowedTo(e)?t():r.showPage(new s({code:401,req:a,referer:n}))}},l.getDivision=function(){var e=null;switch(l.data.orgUnitType){case"division":e=l.data.orgUnitId;break;case"subdivision":var a=d.get(l.data.orgUnitId);a&&(e=a.get("division"))}return o.get(e)||null},l.getSubdivision=function(){return"subdivision"!==l.data.orgUnitType?null:d.get(l.data.orgUnitId)||null},window.user=l,l});