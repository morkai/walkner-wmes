define(["require","app/i18n","app/time","app/user","app/core/Model","app/core/templates/userInfo"],function(t,e,i,n,r,s){"use strict";const a={new:"default",inProgress:"info",finished:"success",paused:"warning",cancelled:"danger"},o={long:!1},c={long:!0};return r.extend({urlRoot:"/osh/nearMisses",clientUrlRoot:"#osh/nearMisses",topicPrefix:"osh.nearMisses",privilegePrefix:"OSH:DICTIONARIES",nlsDomain:"wmes-osh-nearMisses",labelAttribute:"_id",defaults:{},getModelType:function(){return"nearMisses"},serialize:function(){const t=this.toJSON();return t.status=e(this.nlsDomain,`status:${t.status}`),t.priority=e("wmes-osh-common",`priority:${t.priority}`),t.materialLoss=e("core",`BOOL:${t.materialLoss}`),t.duration=this.getDuration(),t},serializeRow:function(){const e=t("app/wmes-osh-common/dictionaries"),n=this.serialize();return n.className=a[this.get("status")],["createdAt","startedAt","finishedAt"].forEach(t=>{n[t]=n[t]?i.format(n[t],"L"):""}),n.plannedAt=n.plannedAt?i.utc.format(n.plannedAt,"L"):"",n.eventDate=i.utc.format(n.eventDate,"L, H"),["workplace","division","building","location","kind","eventCategory","reasonCategory"].forEach(t=>{n[t]=e.getLabel(t,n[t],o)}),["creator","manager","implementer","coordinators"].forEach(t=>{n[t]=Array.isArray(n[t])?n[t].map(t=>s(t,{noIp:!0,clickable:!1})):s(n[t],{noIp:!0,clickable:!1})}),n},serializeDetails:function(){const e=t("app/wmes-osh-common/dictionaries"),n=this.serialize();return["createdAt","startedAt","finishedAt"].forEach(t=>{n[t]=n[t]?i.format(n[t],"LL, LT"):""}),n.plannedAt=n.plannedAt?i.utc.format(n.plannedAt,"LL"):"",n.eventDate=i.utc.format(n.eventDate,"LL, [godz.] H"),["workplace","division","building","location"].forEach(t=>{n[t]=e.getLabel(t,n[t],c)}),n.descriptions={},["kind","eventCategory","reasonCategory"].forEach(t=>{n.descriptions[t]=e.getDescription(t,n[t]),n[t]=e.getLabel(t,n[t],c)}),["creator","manager","implementer","coordinators"].forEach(t=>{n[t]=Array.isArray(n[t])?n[t].map(t=>s(t,{noIp:!0})):s(n[t],{noIp:!0})}),n},isParticipant:function(){return this.isCreator()||this.isImplementer()||this.isCoordinator()},isCreator:function(){return this.get("creator").id===n.data._id},isImplementer:function(){return(this.get("implementer")||{}).id===n.data._id},isCoordinator:function(){return(this.get("coordinators")||[]).some(t=>t.id===n.data._id)},getDuration:function(){const t=Date.parse(this.get("startedAt"));if(!t||"cancelled"===this.get("status"))return"";const e=Date.parse(this.get("finishedAt"))||Date.now();return Math.ceil((e-t)/1e3/3600).toLocaleString()},getAttachmentUrl:function(t){return`/osh/nearMisses/${this.id}/attachments/${t._id}`}},{can:{manage:function(){return n.isAllowedTo("OSH:NEAR_MISSES:MANAGE")},edit:function(t){if((this.can||this).manage())return!0;switch(t.get("status")){case"new":return t.isCreator()||t.isCoordinator();case"inProgress":return t.isImplementer()||t.isCoordinator();case"paused":return t.isCoordinator();default:return!1}},delete:function(t){return!!(this.can||this).manage()||!("new"!==t.get("status")||!t.isCreator()&&!t.isCoordinator())},todo:function(t){const e=t.get("status");return"inProgress"!==e&&"finished"!==e&&(!!(this.can||this).manage()||t.isCoordinator())},pause:function(t){const e=t.get("status");return("new"===e||"inProgress"===e)&&(!!(this.can||this).manage()||t.isCoordinator())},cancel:function(t){const e=t.get("status");return"finished"!==e&&"cancelled"!==e&&(!!(this.can||this).manage()||("new"===e?t.isCreator()||t.isCoordinator():"inProgress"===e&&t.isCoordinator()))},editAttachment:function(t){return!!(this.can||this).manage()||"finished"!==t.get("status")&&t.isParticipant()},deleteAttachment:function(t,e){return!!(this.can||this).manage()||"finished"!==t.get("status")&&(!!t.isCoordinator()||e.user.id===n.data._id)}}})});