define(["require","app/i18n","app/time","app/user","app/core/Model","app/core/templates/userInfo"],function(t,e,n,i,s,r){"use strict";e=e.forDomain("wmes-osh-nearMisses");const a={new:"default",inProgress:"info",finished:"success",paused:"warning",cancelled:"danger"},o={long:!1},c={long:!0},u=["createdAt","startedAt","finishedAt"],l=["creator","implementer","coordinators"],d=["workplace","division","building","location","kind","eventCategory","reasonCategory"],h=["kind","eventCategory","reasonCategory"];return s.extend({urlRoot:"/osh/nearMisses",clientUrlRoot:"#osh/nearMisses",topicPrefix:"osh.nearMisses",privilegePrefix:"OSH:NEAR_MISSES",nlsDomain:"wmes-osh-nearMisses",labelAttribute:"_id",initialize:function(){s.prototype.initialize.apply(this,arguments),this.observer=null,this.on("change:participants",()=>this.observer=null)},getModelType:function(){return"nearMiss"},serialize:function(){const n=t("app/wmes-osh-common/dictionaries"),i=this.toJSON();return i.status=n.getLabel("status",i.status),i.priority=n.getLabel("priority",i.priority),i.materialLoss=e("core",`BOOL:${i.materialLoss}`),i.duration=this.getDuration(),i},serializeRow:function(){const i=t("app/wmes-osh-common/dictionaries"),s=this.serialize();s.className=a[this.get("status")],s.plannedAt=s.plannedAt?n.utc.format(s.plannedAt,"L"):"",s.eventDate=n.utc.format(s.eventDate,"L, H"),s.resolution._id?s.resolution=e(`resolution:link:${s.resolution.type}`,{id:s.resolution._id}):s.resolution=e(`resolution:desc:${s.resolution.type}`),u.forEach(t=>{s[t]=s[t]?n.format(s[t],"L"):""}),d.forEach(t=>{s[t]=i.getLabel(t,s[t],o)}),l.forEach(t=>{s[t]=Array.isArray(s[t])?s[t].map(t=>r(t,{noIp:!0,clickable:!1})):r(s[t],{noIp:!0,clickable:!1})});const c=this.getUserParticipant();return s.unseen=c&&c.notify,s.unseen&&(s.className+=" osh-unseen"),s},serializeDetails:function(){const i=t("app/wmes-osh-common/dictionaries"),s=this.serialize();return s.plannedAt=s.plannedAt?n.utc.format(s.plannedAt,"LL"):"",s.eventDate=n.utc.format(s.eventDate,e(this.nlsDomain,"details:eventDate:format")),s.resolution._id?s.resolution=e(`resolution:desc:${s.resolution.type}`)+", "+e(`resolution:link:${s.resolution.type}`,{id:s.resolution._id}):s.resolution=e(`resolution:desc:${s.resolution.type}`),u.forEach(t=>{s[t]=s[t]?n.format(s[t],"LL, LT"):""}),d.forEach(t=>{s[t]=i.getLabel(t,s[t],c)}),s.descriptions={},h.forEach(t=>{s.descriptions[t]=i.getDescription(t,s[t])}),l.forEach(t=>{s[t]=Array.isArray(s[t])?s[t].map(t=>r(t,{noIp:!0})):r(s[t],{noIp:!0})}),s},getUserParticipant:function(){return this.getParticipant(i.data._id)},getParticipant:function(t){return(this.get("participants")||[]).find(e=>e.user.id===t)},getObserver:function(){if(this.observer)return this.observer;const t=this.getUserParticipant();return t?(this.observer=Object.assign({},t,{lastSeenAt:new Date(t.lastSeenAt),changes:Object.assign({},t.changes)}),t.notify&&(this.observer.changes.any=!0,this.observer.changes.all=!Object.keys(t.changes).length)):this.observer={user:i.getInfo(),roles:["viewer"],lastSeenAt:new Date,notify:!1,changes:{any:!1,all:!1}},this.observer},isParticipant:function(){return!!this.getUserParticipant()},isCreator:function(){return this.get("creator").id===i.data._id},isImplementer:function(){return(this.get("implementer")||{}).id===i.data._id},isCoordinator:function(){return(this.get("coordinators")||[]).some(t=>t.id===i.data._id)},getDuration:function(){const t=Date.parse(this.get("startedAt"));if(!t||"cancelled"===this.get("status"))return"";const n=Date.parse(this.get("finishedAt"))||Date.now(),i=Math.ceil((n-t)/1e3/3600);if(i>48){const t=Math[i%24>16?"ceil":"floor"](i/24);return e("wmes-osh-common","duration:days",{days:t})}return e("wmes-osh-common","duration:hours",{hours:i})},getAttachmentUrl:function(t){return`${this.urlRoot}/${this.id}/attachments/${t._id}/${t.file}`},handleSeen:function(){const t=this.getObserver(),e=this.getUserParticipant(),n=this.attributes.participants;t.lastSeenAt=new Date,t.notify=!1,t.changes={},e&&(e.lastSeenAt=t.lastSeenAt.toISOString(),e.notify=!1,e.changes={}),this.attributes.participants=null,this.set("participants",n),this.trigger("seen")},handleUpdate:function(t,e){const n=this.constructor,i={},s=Object.keys(t.data);(t.comment.length||s.length)&&(i.changes=this.get("changes").concat(t)),s.forEach(e=>{const s=n.changeHandlers[e],r=t.data[e][0],a=t.data[e][1];if(s){const o={prop:e,newData:i,newValue:a,oldValue:r,change:t,Model:n,model:this};"string"==typeof s?n.changeHandlers[s](o):s(o)}else i[e]=a});const r=this.attributes.participants,a=this.getUserParticipant();let o=!1;a&&(a.user.id===t.user.id?(o=!0,a.lastSeenAt=t.date,a.notify=!1,a.changes={any:!1,all:!1}):(a.notify=!0,a.changes=e[a.user.id]||{},a.changes.all=!Object.keys(a.changes).length,a.changes.any=!0),this.attributes.participants=null,i.participants=r),this.set(i),o&&this.trigger("seen")}},{changeHandlers:{list:({model:t,prop:e,newData:n,newValue:i})=>{const{added:s,edited:r,deleted:a}=i||{},o=new Map;(t.get(e)||[]).forEach(t=>o.set(t._id||t.id,t)),(s||[]).forEach(t=>o.set(t._id||t.id,t)),(a||[]).forEach(t=>o.delete(t._id||t.id)),(r||[]).forEach(t=>{const e=t._id||t.id,n=o.get(e);n?o.set(e,Object.assign({},n,t)):o.set(e,t)}),t.attributes[e]=null,n[e]=Array.from(o.values())},attachments:"list",coordinators:"list"},can:{manage:function(){return i.isAllowedTo("OSH:NEAR_MISSES:MANAGE")},edit:function(t){if((this.can||this).manage())return!0;switch(t.get("status")){case"new":return t.isCreator()||t.isCoordinator();case"inProgress":return t.isImplementer()||t.isCoordinator();case"paused":return t.isCoordinator();default:return!1}},editKind:function(t,e){if(!e||(this.can||this).manage())return!0;switch(t.get("status")){case"new":return t.isCreator()||t.isCoordinator();case"inProgress":case"paused":return t.isCoordinator();default:return!1}},delete:function(t){return!!(this.can||this).manage()||!("new"!==t.get("status")||!t.isCoordinator())},inProgress:function(t){const e=t.get("status");return("new"===e||"paused"===e)&&(!!(this.can||this).manage()||t.isCoordinator())},paused:function(t){const e=t.get("status");return("new"===e||"inProgress"===e)&&(!!(this.can||this).manage()||t.isCoordinator())},cancelled:function(t){const e=t.get("status");return"finished"!==e&&"cancelled"!==e&&(!!(this.can||this).manage()||("new"===e?t.isCreator()||t.isCoordinator():"inProgress"===e&&t.isCoordinator()))},editAttachment:function(t){return!!(this.can||this).manage()||"finished"!==t.get("status")&&t.isParticipant()},deleteAttachment:function(t,e){return!!(this.can||this).manage()||"finished"!==t.get("status")&&(!!t.isCoordinator()||e.user.id===i.data._id)},comment:function(){return i.isLoggedIn()},editResolutionType:function(t){return!!(this.can||this).manage()||t.isCoordinator()},editResolutionId:function(t){return!!(this.can||this).manage()||(!!t.isCoordinator()||!("inProgress"!==t.get("status")||!t.isImplementer()))}}})});