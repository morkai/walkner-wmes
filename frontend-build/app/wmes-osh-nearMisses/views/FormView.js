define(["underscore","jquery","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/util/userInfoDecorator","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","app/wmes-osh-actions/Action","app/wmes-osh-actions/views/FormView","../NearMiss","app/wmes-osh-nearMisses/templates/form","app/wmes-osh-nearMisses/templates/resolutionPopover"],function(e,t,i,o,s,n,l,a,r,d,c,p,h,u,m,g,v){"use strict";return n.extend({template:g,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-anonymous":function(){this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.toggleImplement(),this.toggleCreator()},"change #-selfImplement":function(){this.toggleImplement()},"change #-userWorkplace":function(){this.$id("userDepartment").val(""),this.setUpUserDepartmentSelect2()},"change #-workplace":function(){this.$id("department").val(""),this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-department":function(){this.$id("building").val(""),this.$id("location").val(""),this.$id("station").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-building":function(){this.$id("location").val(""),this.$id("station").val(""),this.setUpLocationSelect2(),this.setUpStationSelect2()},"change #-location":function(){this.$id("station").val(""),this.setUpStationSelect2()},'change input[name="kind"]':function(){this.$id("eventCategory").val(""),this.$id("reasonCategory").val(""),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2(),this.togglePriority()},"change #-eventCategory":function(){this.$id("reasonCategory").val(""),this.setUpReasonCategorySelect2(),this.toggleActionResolution()},"change #-attachments":function(){const e=this.$id("attachments"),t=this.options.editMode?5:2;e[0].setCustomValidity(e[0].files.length>t?this.t("FORM:ERROR:tooManyFiles",{max:t}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const t=this.$id("implementer"),i=this.$id("plannedAt"),o=this.$('input[name="resolution.type"]');if(!t.select2("data")||!i.val()||"unspecified"===o.filter(":checked").val()){const s=t.prop("required"),n=i.prop("required"),l=e.once(()=>{s||t.prop("required",!1).closest(".form-group").removeClass("has-required-select2"),i.prop("required",n),o.first()[0].setCustomValidity("")});t.prop("required",!0).one("select2-blur",l).closest(".form-group").addClass("has-required-select2"),i.prop("required",!0).one("blur",l),o.first()[0].setCustomValidity(this.t("FORM:resolution:required")),o.one("blur",l)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-paused":function(){this.newStatus="paused";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},'change input[name="resolution.type"]':function(){this.setUpResolution()},"mousedown #-showResolution":function(e){1===e.button&&e.preventDefault()},"mouseup #-showResolution":function(e){if(1===e.button)return this.resolution._id?window.open(`/#osh/${this.resolution.type}s/${this.resolution._id}`,"_blank"):this.resolution.rid&&this.$id("save").click(),!1},"click #-showResolution":function(e){e.ctrlKey&&this.resolution._id?window.open(`/#osh/${this.resolution.type}s/${this.resolution._id}`,"_blank"):this.showResolutionPopover(this.getResolutionType(),this.$id("resolutionId").val().trim())},"input #-resolutionId":function(){this.resetResolution()},"change #-resolutionId":function(){this.loadResolution()},"click #-addResolution":function(){this.showAddResolutionDialog()},'change input[name="eventTime"]':function(){const e=this.$id("eventTime"),t=e.val().match(/([0-9]{1,2})(?::([0-9]{1,2}))/)||[null,"00","00"],i=parseInt(t[1],10),o=parseInt(t[2],10),s=i>=0&&i<24?i.toString().padStart(2,"0"):"00",n=o>=0&&o<60?o.toString().padStart(2,"0"):"00";e.val(`${s}:${n}`)}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),this.resolution={added:{},type:"unspecified",_id:0,rid:"",data:null,req:null},this.listenToOnce(this.model,"change:resolution",()=>{Object.assign(this.resolution,this.model.get("resolution"))}),t(document).on(`click.${this.idPrefix}`,this.onDocumentClick.bind(this)).on(`keydown.${this.idPrefix}`,this.onDocumentKeyDown.bind(this))},destroy:function(){n.prototype.destroy.apply(this,arguments),t(document).off(`.${this.idPrefix}`),this.resetResolution()},getResolutionType:function(){return this.$('input[name="resolution.type"]:checked').val()||"unspecified"},getTemplateData:function(){return{today:o.getMoment().format("YYYY-MM-DD"),kinds:r.kinds.serialize("nearMiss",this.model.get("kind")),priorities:r.priorities.map(e=>({value:e,label:r.getLabel("priority",e)})),resolutionTypes:this.getResolutionTypes(),can:{inProgress:m.can.inProgress(this.model),paused:m.can.paused(this.model),cancelled:m.can.cancelled(this.model),editResolutionType:m.can.editResolutionType(this.model),editResolutionId:m.can.editResolutionId(this.model)},relation:this.options.relation}},getResolutionTypes:function(){if(!this.options.editMode)return[];const e=["action","kaizen"];return"new"===this.model.get("status")&&e.unshift("unspecified"),e},serializeToForm:function(){const t=this.model.toJSON();if(t.eventDate){const e=o.utc.getMoment(t.eventDate);t.eventDate=e.format("YYYY-MM-DD"),t.eventTime=e.format("HH:mm")}else{const e=o.getMoment();t.eventDate=e.format("YYYY-MM-DD"),t.eventTime=e.format("HH:mm")}return t.plannedAt&&(t.plannedAt=o.utc.format(t.plannedAt,"YYYY-MM-DD")),t.priority>=0||(t.priority=1),t.resolution?t.resolution=e.clone(t.resolution):t.resolution={_id:0,rid:"",type:"unspecified"},t.resolution.rid||(t.resolution.rid=""),delete t.coordinators,delete t.attachments,delete t.users,delete t.changes,t},serializeForm:function(e){this.newStatus&&(e.status=this.newStatus);const t=this.$id("userWorkplace").select2("data");e.userDivision=t.model.get("division"),e.userWorkplace=t.id,e.userDepartment=this.$id("userDepartment").select2("data").id;const s=this.options.relation;if(s)e.relation={_id:s.id,rid:s.get("rid"),type:s.getModelType()};else{const t=this.$id("workplace").select2("data");e.division=t.model.get("division"),e.workplace=t.id,e.department=this.$id("department").select2("data").id,e.building=this.$id("building").select2("data").id,e.location=this.$id("location").select2("data").id,e.station=parseInt(this.$id("station").val(),10)||0}e.eventDate=o.utc.getMoment(`${e.eventDate} ${e.eventTime||"00:00"}:00`,"YYYY-MM-DD HH:mm:ss").toISOString();const n=r.eventCategories.get(e.eventCategory),l=r.reasonCategories.get(e.reasonCategory);e.eventCategory=n.id,e.reasonCategory=l?l.id:null,e.materialLoss=n.get("materialLoss"),this.options.editMode?e.implementer=a.getUserInfo(this.$id("implementer")):(e.implementer=e.selfImplement&&!e.anonymous?i.getInfo():null,e.selfImplement=void 0),this.$id("plannedAt").prop("disabled")?delete e.plannedAt:e.plannedAt?e.plannedAt=o.utc.getMoment(e.plannedAt,"YYYY-MM-DD").toISOString():e.plannedAt=null,"string"==typeof e.priority&&(e.priority=+e.priority);const d=this.model.get("resolution")||{_id:0,rid:"",type:"unspecified"};return m.can.editResolutionType(this.model)&&(d.type=this.getResolutionType()),m.can.editResolutionId(this.model)&&(d._id=this.resolution._id,d.rid=this.resolution.rid),e.resolution=d,e.kind&&(e.kind=parseInt(e.kind,10)),e},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpImplementerSelect2(),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2(),this.setUpResolution(),this.setUpEventDate(),this.togglePriority(),this.toggleImplement(),this.toggleKind()},onDialogShown:function(){this.$id("subject").select()},isAnonymous:function(){return this.$id("anonymous").prop("checked")},setUpUserWorkplaceSelect2:function(){const e=this.$id("userWorkplace");if(this.options.editMode){const t=this.model.get("creator").oshWorkplace,i=r.workplaces.get(t);return e.val(t).select2({width:"100%",placeholder:" ",data:i?[{id:t,text:i?i.getLabel({long:!0}):`?${t}?`,model:i}]:[]}),void e.select2("enable",!1)}if(this.isAnonymous())return e.val("").select2({width:"100%",placeholder:" ",data:[]}),void e.select2("enable",!1).prop("required",!1).closest(".form-group").removeClass("has-required-select2").find(".control-label").removeClass("is-required");e.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let t=r.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o={};r.workplaces.forEach(e=>{e.get("active")&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!o[t.id]&&(o[t.id]=t),e.select2({width:"100%",data:Object.values(o).sort((e,t)=>e.text.localeCompare(t.text))});const s=r.workplaces.get(i.data.oshWorkplace);this.options.editMode&&t?e.select2("enable",!1).select2("data",t):s?e.select2("enable",!1).select2("data",{id:s.id,text:s.getLabel({long:!0}),model:s}):e.select2("enable",!0)},setUpUserDepartmentSelect2:function(){const e=this.$id("userDepartment");if(this.options.editMode){const t=this.model.get("creator").oshDepartment,i=r.departments.get(t);return e.val(t).select2({width:"100%",placeholder:" ",data:i?[{id:t,text:i?i.getLabel({long:!0}):`?${t}?`,model:i}]:[]}),void e.select2("enable",!1)}if(this.isAnonymous())return e.val("").select2({width:"100%",placeholder:" ",data:[]}),void e.select2("enable",!1).prop("required",!1).closest(".form-group").removeClass("has-required-select2").find(".control-label").removeClass("is-required");const t=+this.$id("userWorkplace").val();let o=r.departments.get(+e.val());o&&(o={id:o.id,text:o.getLabel({long:!0}),model:o});const s={};r.departments.forEach(e=>{e.get("active")&&e.get("workplace")===t&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),o&&!s[o.id]&&o.model.get("workplace")===t&&(s[o.id]=o);const n=Object.values(s).sort((e,t)=>e.text.localeCompare(t.text));let l=" ",a=!0;t||0!==n.length||(l=this.t("FORM:placeholder:noUserWorkplace"),a=!1),e.select2({width:"100%",placeholder:l,data:n});const d=r.departments.get(i.data.oshDepartment);this.options.editMode&&o?e.select2("enable",!1).select2("data",o):d?e.select2("enable",!1).select2("data",{id:d.id,text:d.getLabel({long:!0}),model:d}):(e.select2("enable",a),1===n.length?e.select2("data",n[0]):s[e.val()]||e.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");let t=r.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const i={};r.workplaces.forEach(e=>{e.get("active")&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!i[t.id]&&(i[t.id]=t),e.select2({width:"100%",data:Object.values(i).sort((e,t)=>e.text.localeCompare(t.text))}),e.select2("enable",!this.options.editMode||m.can.manage()||this.model.isCoordinator())},setUpDepartmentSelect2:function(){const e=this.$id("department"),t=+this.$id("workplace").val();let i=r.departments.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const o={};r.departments.forEach(e=>{e.get("active")&&e.hasWorkplace(t)&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!o[i.id]&&(o[i.id]=i);const s=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noWorkplace"),data:s}),1===s.length?e.select2("data",s[0]):o[e.val()]||e.val("").select2("data",null),e.select2("enable",!!t&&(!this.options.editMode||m.can.manage()||this.model.isCoordinator()))},setUpBuildingSelect2:function(){const e=this.$id("building"),t=+this.$id("department").val(),i={};r.buildings.forEach(e=>{e.get("active")&&e.hasDepartment(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noDepartment"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t&&(!this.options.editMode||m.can.manage()||this.model.isCoordinator()))},setUpLocationSelect2:function(){const e=this.$id("location"),t=+this.$id("building").val(),i={};r.locations.forEach(e=>{e.get("active")&&e.hasBuilding(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noBuilding"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t&&(!this.options.editMode||m.can.manage()||this.model.isCoordinator()))},setUpStationSelect2:function(){const e=this.$id("station"),t=+this.$id("location").val(),i={};r.stations.forEach(e=>{e.get("active")&&e.hasLocation(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noLocation"),allowClear:!0,data:o}),this.options.editMode||1!==o.length||e.select2("data",o[0]),e.select2("enable",o.length>0&&!!t&&(!this.options.editMode||m.can.manage()||this.model.isCoordinator()))},setUpImplementerSelect2:function(){a(this.$id("implementer"),{width:"100%",noPersonnelId:!0,userInfoDecorators:[d],currentUserInfo:this.model.get("implementer")})},setUpEventCategorySelect2:function(){const e=this.$id("eventCategory"),t=this.$('input[name="kind"]:checked').val(),i={};r.eventCategories.forEach(e=>{e.get("active")&&e.hasKind(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const o=this.model.get("eventCategory"),s=r.eventCategories.get(o);o&&!i[o]&&(s?s.hasKind(t)&&(i[o]={id:o,text:s.getLabel({long:!0}),description:s.get("description"),model:s}):i[o]={id:o,text:`?${o}?`});const n=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",allowClear:!1,placeholder:" ",data:n,dropdownCssClass:"select2-with-description",formatResult:l.bind(null,"text","description")}),1===n.length&&e.val(n[0].id).select2("data",n[0])},setUpReasonCategorySelect2:function(){const e=this.$id("reasonCategory"),t=this.$id("eventCategory").val()||null,i={};r.reasonCategories.forEach(e=>{e.get("active")&&e.hasEventCategory(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const o=this.model.get("reasonCategory"),s=r.reasonCategories.get(o);o&&!i[o]&&(s?s.hasEventCategory(t)&&(i[o]={id:o,text:s.getLabel({long:!0}),description:s.get("description"),model:s}):i[o]={id:o,text:`?${o}?`});const n=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));let a=" ";t||0!==n.length||(a=this.t("FORM:placeholder:noEventCategory")),e.select2({width:"100%",allowClear:!0,placeholder:a,data:n,dropdownCssClass:"select2-with-description",formatResult:l.bind(null,"text","description")}),e.select2("enable",0!==n.length)},setUpResolution:function(){if(!this.options.editMode)return;this.hideResolutionPopover();const e=this.model.get("resolution"),t=this.getResolutionType(),i=this.$id("resolutionGroup");let o="",s=m.can.editResolutionId(this.model);s&&"unspecified"===t&&(s=!1),i.find(".control-label").text(this.t(`FORM:resolution:${t}`)),i.find("input, button").prop("disabled",!s),s&&this.resolution.added[t]?o=this.resolution.added[t].toString():t===e.type&&e.rid&&(o=e.rid),this.$id("resolutionId").val(o)[0].setCustomValidity(""),this.toggleActionResolution()},toggleActionResolution:function(){const e=this.$('input[name="resolution.type"][value="action"]');if(!e.length)return;const t=r.eventCategories.get(+this.$id("eventCategory").val());let i=this.t("resolution:desc:action");if(t&&t.get("activityKind")){const e=r.activityKinds.get(t.get("activityKind"));e&&(i=e.getLabel({long:!0}))}e[0].nextSibling.textContent=i},setUpEventDate:function(){clearTimeout(this.timers.maxEventDate);const e=o.getMoment().add(1,"days").startOf("day").valueOf()-Date.now()+1e3;this.timers.maxEventDate=setTimeout(()=>{this.$id("eventDate").prop("max",o.format(Date.now(),"YYYY-MM-DD")),this.setUpEventDate()},Math.min(e,6e4))},toggleKind:function(){const e=this.$('input[name="kind"]');e.length&&!e.filter(":checked").length&&e.first().click(),e.prop("disabled",!m.can.editKind(this.model,this.options.editMode))},togglePriority:function(){const e=this.$('input[name="priority"]'),t=r.kinds.get(+this.$('input[name="kind"]:checked').val()||this.model.get("kind")),i=t?t.get("type"):null,o=this.options.editMode&&(this.model.isCoordinator()||m.can.manage());let s=+e.filter(":checked").val();this.options.editMode||(s="osh"===i?3:1),e.prop("disabled",!o).filter(`input[value="${s}"]`).prop("checked",!0),e.closest(".form-group").toggleClass("hidden",!o)},toggleCreator:function(){this.$id("creator").text(this.$id("anonymous").prop("checked")?this.t("wmes-osh-common","anonymous:label"):i.getLabel())},toggleImplement:function(){const e=!!this.$id("anonymous").prop("checked"),t=this.$id("selfImplement"),i=this.$id("implementer"),o=this.$id("plannedAt");t.length&&(t.prop("checked")&&e&&t.prop("checked",!1),t.prop("disabled",e),t.closest("label").toggleClass("disabled",e));const s=m.can.manage(),n=this.model.isCoordinator();i.length&&i.select2("enable",s||n),this.options.editMode?o.prop("disabled",!s&&!n):o.val("").prop("disabled",!t.prop("checked"))},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var e=n.prototype.request.apply(this,arguments);return e.always(function(){s.msg.saved()}),e},submitRequest:function(e,t){const i=this,o=new FormData;let l=0;if(this.$id("anonymous").prop("checked")&&o.append("anonymous","1"),i.$('input[type="file"]').each(function(){for(let e=0;e<this.files.length;++e)o.append("file",this.files[e]),l+=1}),0===l)return n.prototype.submitRequest.call(i,e,t);s.msg.saving();const a=i.ajax({type:"POST",url:"/osh/attachments",data:o,processData:!1,contentType:!1});a.done(o=>{t.attachments={added:o},n.prototype.submitRequest.call(i,e,t),s.msg.saved()}),a.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),e.attr("disabled",!1)})},toggleActions:function(e){this.$(".form-actions .btn").prop("disabled",!e)},showResolutionPopover:function(e,t){if(e!==this.resolution.type||t!==this.resolution.rid||!this.resolution.data)return this.loadResolution(e,t,!0);if(!this.resolution.rid)return void this.$id("resolutionId").focus();if(!this.resolution.data)return void this.$id("save").click();if(this.$id("showResolution").data("bs.popover"))return;const i=this.$id("showResolution").popover({container:this.$id("resolutionGroup"),trigger:"click",placement:"top",html:!0,title:function(){return""},content:this.renderPartialHtml(v,this.resolution)}).popover("show");i.prop("title",i[0].dataset.originalTitle)},hideResolutionPopover:function(){this.$id("showResolution").popover("destroy")},resetResolution:function(){if(!this.options.editMode)return;this.$id("resolutionId")[0].setCustomValidity(""),this.hideResolutionPopover();const e=this.resolution.req;this.resolution.type="unspecified",this.resolution._id=0,this.resolution.rid="",this.resolution.data=null,this.resolution.req=null,e&&e.abort()},loadResolution:function(e,t,i){e||(e=this.getResolutionType()),t||(t=this.$id("resolutionId").val());const n=t.trim().match(/([akAK]-)?([0-9]{4}-)?([0-9]{1,6})/);if(t="",n&&(t+=(n[1]||e).charAt(0).toUpperCase(),t+="-"+(n[2]||o.format(Date.now(),"YYYY")).substring(0,4),t+="-"+n[3].padStart(6,"0"),this.$id("resolutionId").val(t)),this.resetResolution(),!t)return void this.$id("resolutionId").val("");const l=this.$id("showResolution").prop("disabled",!0);this.toggleActions(!1);const a=this.resolution.req=this.ajax({url:`/osh/${r.TYPE_TO_MODULE[e]}/${t}?select(subject,status)`});a.fail(()=>{if(404!==a.status)return this.$id("resolutionId")[0].setCustomValidity(this.t("FORM:resolution:failure")),s.msg.loadingFailed();s.msg.loaded(),this.resolution.type=e,this.resolution.rid=t,this.$id("resolutionId")[0].setCustomValidity(this.t("FORM:resolution:notFound"))}),a.done(o=>{s.msg.loaded(),this.$id("resolutionId")[0].setCustomValidity(""),this.resolution.type=e,this.resolution._id=o._id,this.resolution.rid=t,this.resolution.data=o,i&&this.showResolutionPopover(e,t)}),a.always(()=>{this.resolution.req===a&&(this.resolution.req=null,l.prop("disabled",!1),this.toggleActions(!0))})},showAddResolutionDialog:function(){if(!this.el.checkValidity())return this.$id("save").click();const e=Object.assign(this.model.toJSON(),this.getFormData()),t=this.getResolutionType();let i=null;if("kaizen"===t)i=new p({relation:this.model,newStatus:"inProgress",model:new c({subject:e.subject,kind:e.kind,division:e.division,workplace:e.workplace,department:e.department,building:e.building,location:e.location,station:e.station,eventCategory:e.eventCategory,problem:e.problem,reason:e.reason,suggestion:e.suggestion,plannedAt:e.plannedAt,implementers:e.implementer?[e.implementer]:[]})});else{if("action"!==t)return;i=new u({relation:this.model,newStatus:"inProgress",forcedActivityKind:r.eventCategories.get(e.eventCategory).get("activityKind"),model:new h({subject:e.subject,kind:e.kind,division:e.division,workplace:e.workplace,department:e.department,building:e.building,location:e.location,station:e.station,problem:e.problem,reason:e.reason,suggestion:e.suggestion,plannedAt:e.plannedAt,implementers:e.implementer?[e.implementer]:[]})})}s.showDialog(i,this.t(`FORM:resolution:title:${t}`)),i.handleSuccess=(()=>{this.resolution.added[t]=i.model.get("rid"),this.resolution.type=t,this.resolution._id=i.model.id,this.resolution.rid=i.model.get("rid"),this.resolution.data=i.model.toJSON(),this.$id("resolutionId").val(this.resolution.rid),s.closeDialog()})},onDocumentClick:function(e){this.$(e.target).closest(`#${this.idPrefix}-resolutionGroup`).length||this.hideResolutionPopover()},onDocumentKeyDown:function(e){if("Escape"===e.key&&this.$id("showResolution").data("bs.popover"))return this.hideResolutionPopover(),!1}})});