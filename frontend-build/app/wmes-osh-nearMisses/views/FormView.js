define(["app/user","app/core/views/FormView","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-nearMisses/templates/form"],function(e,t,i,o,s,l){"use strict";return t.extend({template:l,events:Object.assign({"change #-anonymous":function(){this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpCoordinatorSelect2()},"change #-workplace":function(){this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpCoordinatorSelect2()},"change #-division":function(){this.setUpBuildingSelect2(),this.setUpCoordinatorSelect2()}},t.prototype.events),getTemplateData:function(){return{dictionaries:s}},serializeToForm:function(){const e=this.model.toJSON();return this.options.editMode||(e.kind="osh",e.priority="normal"),e},checkValidity:function(e){return console.log(e),!0},serializeForm:function(e){e.workplace=this.$id("workplace").select2("data").id,e.division=this.$id("division").select2("data").id,e.building=this.$id("building").select2("data").id,e.coordinator=o.getUserInfo(this.$id("coordinator")),e.implementer=o.getUserInfo(this.$id("implementer"));const t=s.divisions.get(e.division);return e.manager=t.get("manager")||null,e},afterRender:function(){t.prototype.afterRender.apply(this,arguments),this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpCoordinatorSelect2(this.model.get("coordinator")),this.setUpImplementerSelect2(),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2()},isAnonymous:function(){return this.$id("anonymous").prop("checked")},setUpWorkplaceSelect2:function(){const t=this.$id("workplace");let i=s.workplaces.get(+t.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const o={};s.workplaces.forEach(e=>{e.get("active")&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!o[i.id]&&(o[i.id]=i),t.select2({width:"100%",data:Object.values(o).sort((e,t)=>e.text.localeCompare(t.text))});const l=s.workplaces.get(e.data.oshWorkplace);this.options.editMode&&i?t.select2("enable",!1).select2("data",i):this.isAnonymous()||!l?t.select2("enable",!0):t.select2("enable",!1).select2("data",{id:l.id,text:l.getLabel({long:!0}),model:l})},setUpDivisionSelect2:function(){const t=this.$id("division"),i=+this.$id("workplace").val();let o=s.divisions.get(+t.val());o&&(o={id:o.id,text:o.getLabel({long:!0}),model:o});const l={};s.divisions.forEach(e=>{e.get("active")&&e.get("workplace")===i&&(l[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),o&&!l[o.id]&&o.model.get("workplace")===i&&(l[o.id]=o);const n=Object.values(l).sort((e,t)=>e.text.localeCompare(t.text));t.select2({width:"100%",data:n});const a=s.divisions.get(e.data.oshDivision);this.options.editMode&&o?t.select2("enable",!1).select2("data",o):this.isAnonymous()||!a?(t.select2("enable",!0),1===n.length?t.select2("data",n[0]):l[t.val()]||t.select2("data",null).val("")):t.select2("enable",!1).select2("data",{id:a.id,text:a.getLabel({long:!0}),model:a})},setUpBuildingSelect2:function(){const e=this.$id("building"),t=+this.$id("division").val(),i={};s.buildings.forEach(e=>{e.get("active")&&e.get("divisions").includes(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",data:o}),1===o.length&&e.select2("data",o[0])},setUpCoordinatorSelect2:function(e){const t=this.$id("coordinator"),i=s.divisions.get(+this.$id("division").val()),o={};(i?i.get("coordinators"):[]).forEach(e=>{o[e.id]={id:e.id,text:e.label}}),e?(o[e.id]||(o[e.id]={id:e.id,text:e.label}),t.val(e.id)):o[t.val()]||t.val("");const l=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));t.select2({width:"100%",data:l}),1===l.length&&t.select2("data",l[0])},setUpImplementerSelect2:function(){const e=this.$id("implementer");o(e,{width:"100%"});const t=this.model.get("implementer");t&&e.select2("data",{id:t.id,text:t.label})},setUpEventCategorySelect2:function(){const e=this.$id("eventCategory"),t={};s.eventCategories.forEach(e=>{e.get("active")&&(t[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const o=this.model.get("eventCategory"),l=s.eventCategories.get(o);o&&!t[o]&&(t[o]=l?{id:o,text:l.getLabel({long:!0}),description:l.get("description"),model:l}:{id:o,text:`?${o}?`,model:null});const n=Object.values(t).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",allowClear:!0,placeholder:" ",data:n,formatResult:i.bind(null,"text","description")})},setUpReasonCategorySelect2:function(){const e=this.$id("reasonCategory"),t={};s.reasonCategories.forEach(e=>{e.get("active")&&(t[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const o=this.model.get("reasonCategory"),l=s.reasonCategories.get(o);o&&!t[o]&&(t[o]=l?{id:o,text:l.getLabel({long:!0}),description:l.get("description"),model:l}:{id:o,text:`?${o}?`,model:null});const n=Object.values(t).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",allowClear:!0,placeholder:" ",data:n,formatResult:i.bind(null,"text","description")})}})});