define(["underscore","jquery","app/user","app/time","app/viewport","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-common/util/userInfoDecorator","app/wmes-osh-common/views/FormView","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","app/wmes-osh-actions/Action","app/wmes-osh-actions/views/FormView","../NearMiss","app/wmes-osh-nearMisses/templates/form","app/wmes-osh-nearMisses/templates/resolutionPopover"],function(t,e,i,o,s,n,l,r,a,d,u,c,h,p,m,g,f){"use strict";return d.extend({template:g,dialogClassName:"osh-entries-form-dialog",events:Object.assign({"change #-anonymous":function(){this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.toggleImplement(),this.toggleCreator()},"change #-selfImplement":function(){this.toggleImplement()},"change #-implementer":function(){const t=this.$id("plannedAt");t.length&&!t.val()&&t.val(o.getMoment().add(2,"weeks").format("YYYY-MM-DD"))},"change #-userWorkplace":function(){this.$id("userDepartment").val(""),this.setUpUserDepartmentSelect2()},'change input[name="kind[]"]':function(){const t=this.$id("eventCategory").val()||null,e=this.$id("reasonCategory").val()||null;this.$id("eventCategory").val(""),this.$id("reasonCategory").val(""),this.setUpEventCategorySelect2(t),this.setUpReasonCategorySelect2(e),this.togglePriority(),this.$('input[name="kind[]"]').first()[0].required=!this.$('input[name="kind[]"]:checked').length},"change #-eventCategory":function(){const t=this.$id("reasonCategory").val()||null;this.$id("reasonCategory").val(""),this.setUpReasonCategorySelect2(t),this.toggleActionResolution()},"change #-attachments":function(){const t=this.$id("attachments"),e=this.options.editMode?5:2;t[0].setCustomValidity(t[0].files.length>e?this.t("FORM:ERROR:tooManyFiles",{max:e}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const e=this.$id("implementer"),i=this.$id("plannedAt"),o=this.$('input[name="resolution.type"]');if(!e.select2("data")||!i.val()||"unspecified"===o.filter(":checked").val()){const s=e.prop("required"),n=i.prop("required"),l=t.once(()=>{s||e.prop("required",!1).closest(".form-group").removeClass("has-required-select2"),i.prop("required",n),o.first()[0].setCustomValidity("")});e.prop("required",!0).one("select2-blur",l).closest(".form-group").addClass("has-required-select2"),i.prop("required",!0).one("blur",l),o.first()[0].setCustomValidity(this.t("FORM:resolution:required")),o.one("blur",l)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-paused":function(){this.newStatus="paused";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const t=this.$id("comment");if(!t.val().trim().replace(/[^a-zA-Z]+/g,"").length){const e=()=>{t.prop("required",!1)};t.prop("required",!0),t.one("blur",e)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},'change input[name="resolution.type"]':function(){this.setUpResolution()},"mousedown #-showResolution":function(t){1===t.button&&t.preventDefault()},"mouseup #-showResolution":function(t){if(1===t.button)return this.resolution._id?window.open(`/#osh/${this.resolution.type}s/${this.resolution._id}`,"_blank"):this.resolution.rid&&this.$id("save").click(),!1},"click #-showResolution":function(t){t.ctrlKey&&this.resolution._id?window.open(`/#osh/${this.resolution.type}s/${this.resolution._id}`,"_blank"):this.showResolutionPopover(this.getResolutionType(),this.$id("resolutionId").val().trim())},"input #-resolutionId":function(){this.resetResolution()},"change #-resolutionId":function(){this.loadResolution()},"click #-addResolution":function(){this.showAddResolutionDialog()},'change input[name="eventTime"]':function(){const t=this.$id("eventTime"),e=t.val().match(/([0-9]{1,2})(?::([0-9]{1,2}))/)||[null,"00","00"],i=parseInt(e[1],10),o=parseInt(e[2],10),s=i>=0&&i<24?i.toString().padStart(2,"0"):"00",n=o>=0&&o<60?o.toString().padStart(2,"0"):"00";t.val(`${s}:${n}`)}},d.prototype.events),initialize:function(){d.prototype.initialize.apply(this,arguments),this.resolution={added:{},type:"unspecified",_id:0,rid:"",data:null,req:null},this.listenToOnce(this.model,"change:resolution",()=>{Object.assign(this.resolution,this.model.get("resolution"))}),e(document).on(`click.${this.idPrefix}`,this.onDocumentClick.bind(this)).on(`keydown.${this.idPrefix}`,this.onDocumentKeyDown.bind(this))},destroy:function(){d.prototype.destroy.apply(this,arguments),e(document).off(`.${this.idPrefix}`),this.resetResolution()},getResolutionType:function(){return this.$('input[name="resolution.type"]:checked').val()||"unspecified"},getTemplateData:function(){return{today:o.getMoment().format("YYYY-MM-DD"),kinds:r.kinds.serialize("nearMiss",this.model.get("kind")),priorities:r.priorities.map(t=>({value:t,label:r.getLabel("priority",t)})),resolutionTypes:this.getResolutionTypes(),can:{inProgress:m.can.inProgress(this.model),paused:m.can.paused(this.model),cancelled:m.can.cancelled(this.model),editResolutionType:m.can.editResolutionType(this.model),editResolutionId:m.can.editResolutionId(this.model)},relation:this.options.relation,hidden:this.options.hidden||{}}},getKinds:function(){const t=this.$('input[name="kind[]"]');return t.length?t.filter(":checked").get().map(t=>+t.value):this.model.get("kind")||[]},getResolutionTypes:function(){if(!this.options.editMode)return[];const t=["action","kaizen"];return"new"===this.model.get("status")&&t.unshift("unspecified"),t},serializeToForm:function(){const e=this.model.toJSON();if(e.eventDate){const t=o.utc.getMoment(e.eventDate);e.eventDate=t.format("YYYY-MM-DD"),e.eventTime=t.format("HH:mm")}else{const t=o.getMoment();e.eventDate=t.format("YYYY-MM-DD"),e.eventTime=t.format("HH:mm")}return e.plannedAt&&(e.plannedAt=o.utc.format(e.plannedAt,"YYYY-MM-DD")),e.priority>=0||(e.priority=1),e.resolution?e.resolution=t.clone(e.resolution):e.resolution={_id:0,rid:"",type:"unspecified"},e.resolution.rid||(e.resolution.rid=""),delete e.coordinators,delete e.attachments,delete e.users,delete e.changes,e},serializeForm:function(t){this.newStatus&&(t.status=this.newStatus);const e=this.$id("userWorkplace");if(e.length){const i=e.select2("data");t.userDivision=i.model.get("division"),t.userWorkplace=i.id,t.userDepartment=this.$id("userDepartment").select2("data").id}const s=this.options.relation;if(s)t.relation={_id:s.id,rid:s.get("rid"),type:s.getModelType()};else if(this.$id("workplace").length){const e=this.$id("workplace").select2("data");t.division=e.model.get("division"),t.workplace=e.id,t.department=this.$id("department").select2("data").id,t.building=this.$id("building").select2("data").id,t.location=this.$id("location").select2("data").id,t.station=parseInt(this.$id("station").val(),10)||0}t.eventDate&&(t.eventDate=o.utc.getMoment(`${t.eventDate} ${t.eventTime||"00:00"}:00`,"YYYY-MM-DD HH:mm:ss").toISOString()),delete t.eventTime;const n=r.eventCategories.get(t.eventCategory);n&&(t.eventCategory=n.id,t.materialLoss=n.get("materialLoss"));const d=r.reasonCategories.get(t.reasonCategory);if(d?t.reasonCategory=d?d.id:null:delete t.reasonCategory,this.options.editMode?this.$id("implementer").length&&(t.implementer=l.getUserInfo(this.$id("implementer"))):(t.implementer=t.selfImplement&&!t.anonymous?a(i.getInfo(),i.data):null,t.selfImplement=void 0),!this.$id("plannedAt").length||this.$id("plannedAt").prop("disabled")?delete t.plannedAt:t.plannedAt?t.plannedAt=o.utc.getMoment(t.plannedAt,"YYYY-MM-DD").toISOString():t.plannedAt=null,"string"==typeof t.priority&&(t.priority=+t.priority),this.$id("resolutionRow").length){const e=this.model.get("resolution")||{_id:0,rid:"",type:"unspecified"};m.can.editResolutionType(this.model)&&(e.type=this.getResolutionType()),m.can.editResolutionId(this.model)&&(e._id=this.resolution._id,e.rid=this.resolution.rid),t.resolution=e}return Array.isArray(t.kind)&&(t.kind=t.kind.map(t=>+t)),!t.reason&&this.$id("reason").length&&(t.reason=""),!t.suggestion&&this.$id("suggestion").length&&(t.suggestion=""),t},afterRender:function(){d.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDepartmentSelect2(),this.setUpDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDepartmentSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpStationSelect2(),this.setUpImplementerSelect2(),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2(),this.setUpResolution(),this.setUpEventDate(),this.togglePriority(),this.toggleImplement(),this.toggleKind()},onDialogShown:function(){this.$id("subject").select()},isAnonymous:function(){return this.$id("anonymous").prop("checked")},setUpImplementerSelect2:function(){const t=this.$id("implementer");t.length&&l(t,{width:"100%",noPersonnelId:!0,userInfoDecorators:[a],currentUserInfo:this.model.get("implementer")})},setUpEventCategorySelect2:function(t){const e=this.$id("eventCategory");if(!e.length)return;const i=this.getKinds(),o={};r.eventCategories.forEach(t=>{t.get("active")&&t.hasKind(i)&&(o[t.id]={id:t.id,text:t.getLabel({long:!0}),description:t.get("description"),model:t})});const s=this.model.get("eventCategory"),l=r.eventCategories.get(s);s&&!o[s]&&(l?l.hasKind(i)&&(o[s]={id:s,text:l.getLabel({long:!0}),description:l.get("description"),model:l}):o[s]={id:s,text:`?${s}?`});const a=Object.values(o).sort((t,e)=>t.text.localeCompare(e.text));e.select2({width:"100%",allowClear:!1,placeholder:" ",data:a,dropdownCssClass:"select2-with-description",formatResult:n.bind(null,"text","description")}),t&&o[t]?e.val(t).select2("data",o[t]):1===a.length&&e.val(a[0].id).select2("data",a[0])},setUpReasonCategorySelect2:function(t){const e=this.$id("reasonCategory");if(!e.length)return;const i=this.$id("eventCategory").val()||null,o={};r.reasonCategories.forEach(t=>{t.get("active")&&t.hasEventCategory(i)&&(o[t.id]={id:t.id,text:t.getLabel({long:!0}),description:t.get("description"),model:t})});const s=this.model.get("reasonCategory"),l=r.reasonCategories.get(s);s&&!o[s]&&(l?l.hasEventCategory(i)&&(o[s]={id:s,text:l.getLabel({long:!0}),description:l.get("description"),model:l}):o[s]={id:s,text:`?${s}?`});const a=Object.values(o).sort((t,e)=>t.text.localeCompare(e.text));let d=" ";i||0!==a.length||(d=this.t("FORM:placeholder:noEventCategory")),e.select2({width:"100%",allowClear:!0,placeholder:d,data:a,dropdownCssClass:"select2-with-description",formatResult:n.bind(null,"text","description")}),e.select2("enable",0!==a.length),t&&o[t]&&e.val(t).select2("data",o[t])},setUpResolution:function(){if(!this.options.editMode)return;this.hideResolutionPopover();const t=this.model.get("resolution"),e=this.getResolutionType(),i=this.$id("resolutionGroup");let o="",s=m.can.editResolutionId(this.model);s&&"unspecified"===e&&(s=!1),i.find(".control-label").text(this.t(`FORM:resolution:${e}`)),i.find("input, button").prop("disabled",!s),s&&this.resolution.added[e]?o=this.resolution.added[e].toString():e===t.type&&t.rid&&(o=t.rid),this.$id("resolutionId").val(o)[0].setCustomValidity(""),this.toggleActionResolution()},toggleActionResolution:function(){const t=this.$('input[name="resolution.type"][value="action"]');if(!t.length)return;const e=this.$id("eventCategory"),i=r.eventCategories.get(e.length?+this.$id("eventCategory").val():this.model.get("eventCategory"));let o=this.t("resolution:desc:action");if(i&&i.get("activityKind")){const t=r.activityKinds.get(i.get("activityKind"));t&&(o=t.getLabel({long:!0}))}t[0].nextSibling.textContent=o},setUpEventDate:function(){clearTimeout(this.timers.maxEventDate);const t=o.getMoment().add(1,"days").startOf("day").valueOf()-Date.now()+1e3;this.timers.maxEventDate=setTimeout(()=>{this.$id("eventDate").prop("max",o.format(Date.now(),"YYYY-MM-DD")),this.setUpEventDate()},Math.min(t,6e4))},toggleKind:function(){const t=this.$('input[name="kind[]"]');t.length&&(t.filter(":checked").length||t.first().click(),t.prop("disabled",!m.can.editKind(this.model,this.options.editMode)))},togglePriority:function(){const t=this.$('input[name="priority"]');if(!t.length)return;const e=this.getKinds().map(t=>r.kinds.get(t)).map(t=>t?t.get("type"):null),i=this.options.editMode&&(this.model.isCoordinator()||m.can.manage());let o=+t.filter(":checked").val();this.options.editMode||(o=e.includes("osh")?3:1),t.prop("disabled",!i).filter(`input[value="${o}"]`).prop("checked",!0),t.closest(".form-group").toggleClass("hidden",!i)},toggleCreator:function(){this.$id("creator").text(this.$id("anonymous").prop("checked")?this.t("wmes-osh-common","anonymous:label"):i.getLabel())},toggleImplement:function(){const t=!!this.$id("anonymous").prop("checked"),e=this.$id("selfImplement"),i=this.$id("implementer"),s=this.$id("plannedAt");e.length&&(e.prop("checked")&&t&&e.prop("checked",!1),e.prop("disabled",t),e.closest("label").toggleClass("disabled",t));const n=m.can.manage(),l=this.model.isCoordinator();if(i.length&&i.select2("enable",n||l),s.length)if(this.options.editMode)s.prop("disabled",!n&&!l);else{const t=e.prop("checked");s.val(t?o.getMoment().startOf("day").add(14,"days").format("YYYY-MM-DD"):"").prop("disabled",!t).prop("required",t).closest(".form-group").find(".control-label").toggleClass("is-required",t)}},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var t=d.prototype.request.apply(this,arguments);return t.always(function(){s.msg.saved()}),t},submitRequest:function(t,e){const i=this,o=new FormData;let n=0;if(this.$id("anonymous").prop("checked")&&o.append("anonymous","1"),i.$('input[type="file"]').each(function(){for(let t=0;t<this.files.length;++t)o.append("file",this.files[t]),n+=1}),0===n)return d.prototype.submitRequest.call(i,t,e);s.msg.saving();const l=i.ajax({type:"POST",url:"/osh/attachments",data:o,processData:!1,contentType:!1});l.done(o=>{e.attachments={added:o},d.prototype.submitRequest.call(i,t,e),s.msg.saved()}),l.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),t.attr("disabled",!1)})},toggleActions:function(t){this.$(".form-actions .btn").prop("disabled",!t)},showResolutionPopover:function(t,e){if(t!==this.resolution.type||e!==this.resolution.rid||!this.resolution.data)return this.loadResolution(t,e,!0);if(!this.resolution.rid)return void this.$id("resolutionId").focus();if(!this.resolution.data)return void this.$id("save").click();if(this.$id("showResolution").data("bs.popover"))return;const i=this.$id("showResolution").popover({container:this.$id("resolutionGroup"),trigger:"click",placement:"top",html:!0,title:function(){return""},content:this.renderPartialHtml(f,this.resolution)}).popover("show");i.prop("title",i[0].dataset.originalTitle)},hideResolutionPopover:function(){this.$id("showResolution").popover("destroy")},resetResolution:function(){if(!this.options.editMode)return;this.$id("resolutionId")[0].setCustomValidity(""),this.hideResolutionPopover();const t=this.resolution.req;this.resolution.type="unspecified",this.resolution._id=0,this.resolution.rid="",this.resolution.data=null,this.resolution.req=null,t&&t.abort()},loadResolution:function(t,e,i){t||(t=this.getResolutionType()),e||(e=this.$id("resolutionId").val());const n=e.trim().match(/([akAK]-)?([0-9]{4}-)?([0-9]{1,6})/);if(e="",n&&(e+=(n[1]||t).charAt(0).toUpperCase(),e+="-"+(n[2]||o.format(Date.now(),"YYYY")).substring(0,4),e+="-"+n[3].padStart(6,"0"),this.$id("resolutionId").val(e)),this.resetResolution(),!e)return void this.$id("resolutionId").val("");const l=this.$id("showResolution").prop("disabled",!0);this.toggleActions(!1);const a=this.resolution.req=this.ajax({url:`/osh/${r.TYPE_TO_MODULE[t]}/${e}?select(subject,status)`});a.fail(()=>{if(404!==a.status)return this.$id("resolutionId")[0].setCustomValidity(this.t("FORM:resolution:failure")),s.msg.loadingFailed();s.msg.loaded(),this.resolution.type=t,this.resolution.rid=e,this.$id("resolutionId")[0].setCustomValidity(this.t("FORM:resolution:notFound"))}),a.done(o=>{s.msg.loaded(),this.$id("resolutionId")[0].setCustomValidity(""),this.resolution.type=t,this.resolution._id=o._id,this.resolution.rid=e,this.resolution.data=o,i&&this.showResolutionPopover(t,e)}),a.always(()=>{this.resolution.req===a&&(this.resolution.req=null,l.prop("disabled",!1),this.toggleActions(!0))})},showAddResolutionDialog:function(){if(!this.el.checkValidity())return void this.$id("save").click();const t=Object.assign(this.model.toJSON(),this.getFormData()),e=this.getResolutionType();let i=null;if("kaizen"===e)i=new c({relation:this.model,newStatus:"inProgress",model:new u({subject:t.subject,kind:t.kind,division:t.division,workplace:t.workplace,department:t.department,building:t.building,location:t.location,station:t.station,eventCategory:t.eventCategory,problem:t.problem,reason:t.reason,suggestion:t.suggestion,plannedAt:t.plannedAt,implementers:t.implementer?[t.implementer]:[]})});else{if("action"!==e)return;i=new p({relation:this.model,newStatus:"inProgress",forcedActivityKind:r.eventCategories.get(t.eventCategory).get("activityKind"),model:new h({subject:t.subject,kind:t.kind,division:t.division,workplace:t.workplace,department:t.department,building:t.building,location:t.location,station:t.station,problem:t.problem,reason:t.reason,suggestion:t.suggestion,plannedAt:t.plannedAt,implementers:t.implementer?[t.implementer]:[]})})}return s.showDialog(i,this.t(`FORM:resolution:title:${e}`)),i.handleSuccess=(()=>{this.resolution.added[e]=i.model.get("rid"),this.resolution.type=e,this.resolution._id=i.model.id,this.resolution.rid=i.model.get("rid"),this.resolution.data=i.model.toJSON(),this.$id("resolutionId").val(this.resolution.rid).trigger("change"),s.closeDialog()}),i},onDocumentClick:function(t){this.$(t.target).closest(`#${this.idPrefix}-resolutionGroup`).length||this.hideResolutionPopover()},onDocumentKeyDown:function(t){if("Escape"===t.key&&this.$id("showResolution").data("bs.popover"))return this.hideResolutionPopover(),!1}})});