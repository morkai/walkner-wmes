define(["underscore","jquery","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","app/wmes-osh-kaizens/Kaizen","app/wmes-osh-kaizens/views/FormView","../NearMiss","app/wmes-osh-nearMisses/templates/form","app/wmes-osh-nearMisses/templates/resolutionPopover"],function(e,t,i,o,s,n,l,a,d,r,c,u,p,h){"use strict";return n.extend({template:p,events:Object.assign({"change #-anonymous":function(){this.setUpUserWorkplaceSelect2(),this.setUpUserDivisionSelect2(),this.toggleImplement(),this.toggleCreator()},"change #-selfImplement":function(){this.toggleImplement()},"change #-userWorkplace":function(){this.$id("userDivision").val(""),this.setUpUserDivisionSelect2()},"change #-workplace":function(){this.$id("division").val(""),this.$id("building").val(""),this.$id("location").val(""),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2()},"change #-division":function(){this.$id("building").val(""),this.$id("location").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2()},"change #-building":function(){this.$id("location").val(""),this.setUpLocationSelect2()},'change input[name="kind"]':function(){this.$id("eventCategory").val(""),this.$id("reasonCategory").val(""),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2(),this.togglePriority()},"change #-eventCategory":function(){this.$id("reasonCategory").val(""),this.setUpReasonCategorySelect2()},"change #-attachments":function(){const e=this.$id("attachments"),t=this.options.editMode?5:2;e[0].setCustomValidity(e[0].files.length>t?this.t("FORM:ERROR:tooManyFiles",{max:t}):"")},"click #-inProgress":function(){this.newStatus="inProgress";const t=this.$id("implementer"),i=this.$id("plannedAt"),o=this.$('input[name="resolution.type"]');if(!t.select2("data")||!i.val()||"unspecified"===o.filter(":checked").val()){const s=t.prop("required"),n=i.prop("required"),l=e.once(()=>{s||t.prop("required",!1).closest(".form-group").removeClass("has-required-select2"),i.prop("required",n),o.first()[0].setCustomValidity("")});t.prop("required",!0).one("select2-blur",l).closest(".form-group").addClass("has-required-select2"),i.prop("required",!0).one("blur",l),o.first()[0].setCustomValidity("Rodzaj działań korygujących jest wymagany."),o.one("blur",l)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-paused":function(){this.newStatus="paused";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancelled":function(){this.newStatus="cancelled";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},'change input[name="resolution.type"]':function(){this.setUpResolution()},"mousedown #-showResolution":function(e){1===e.button&&e.preventDefault()},"mouseup #-showResolution":function(e){if(1!==e.button)return;const t=this.getResolutionType(),i=parseInt(this.$id("resolutionId").val(),10);i>0&&window.open(`/#osh/${t}s/${i}`,"_blank")},"click #-showResolution":function(e){const t=this.getResolutionType(),i=parseInt(this.$id("resolutionId").val(),10);i>0?e.ctrlKey?window.open(`/#osh/${t}s/${i}`,"_blank"):this.showResolutionPopover(t,i):this.$id("resolutionId").val("").focus()},"input #-resolutionId":function(){this.resetResolution()},"change #-resolutionId":function(){this.loadResolution()},"click #-addResolution":function(){this.showAddResolutionDialog()}},n.prototype.events),initialize:function(){n.prototype.initialize.apply(this,arguments),this.resolution={added:{},type:"unspecified",id:0,data:null,req:null},t(document).on(`click.${this.idPrefix}`,this.onDocumentClick.bind(this)).on(`keydown.${this.idPrefix}`,this.onDocumentKeyDown.bind(this))},destroy:function(){n.prototype.destroy.apply(this,arguments),this.resetResolution()},getResolutionType:function(){return this.$('input[name="resolution.type"]:checked').val()||"unspecified"},resetResolution:function(){this.$id("resolutionId")[0].setCustomValidity(""),this.hideResolutionPopover();const e=this.resolution.req;this.resolution.type="unspecified",this.resolution.id=0,this.resolution.data=null,this.resolution.req=null,e&&e.abort()},getTemplateData:function(){return{today:o.getMoment().format("YYYY-MM-DD"),kinds:d.kinds.map(e=>({value:e.id,label:e.getLabel({long:!0}),title:e.get("description")})).sort((e,t)=>e.label.localeCompare(t.label)),priorities:d.priorities.map(e=>({value:e,label:d.getLabel("priority",e)})),resolutionTypes:this.getResolutionTypes(),can:{inProgress:u.can.inProgress(this.model),paused:u.can.paused(this.model),cancelled:u.can.cancelled(this.model),editResolutionType:u.can.editResolutionType(this.model),editResolutionId:u.can.editResolutionId(this.model)}}},getResolutionTypes:function(){if(!this.options.editMode)return[];const e=["action","kaizen"];return"new"===this.model.get("status")&&e.unshift("unspecified"),e},serializeToForm:function(){const t=this.model.toJSON();if(this.options.editMode){const e=o.utc.getMoment(t.eventDate);t.eventDate=e.format("YYYY-MM-DD"),t.eventTime=e.format("H")}else{const e=o.getMoment();t.eventDate=e.format("YYYY-MM-DD"),t.eventTime=e.format("H")}return t.plannedAt&&(t.plannedAt=o.utc.format(t.plannedAt,"YYYY-MM-DD")),t.priority>=0||(t.priority=1),t.resolution?t.resolution=e.clone(t.resolution):t.resolution={_id:0,type:"unspecified"},t.resolution._id||(t.resolution._id=""),delete t.coordinators,delete t.attachments,delete t.participants,delete t.changes,t},serializeForm:function(e){this.newStatus&&(e.status=this.newStatus),e.userWorkplace=this.$id("userWorkplace").select2("data").id,e.userDivision=this.$id("userDivision").select2("data").id,e.workplace=this.$id("workplace").select2("data").id,e.division=this.$id("division").select2("data").id,e.building=this.$id("building").select2("data").id,e.location=this.$id("location").select2("data").id,e.eventDate=o.utc.getMoment(`${e.eventDate} ${(e.eventTime||"00").padStart(2,"0")}:00:00`,"YYYY-MM-DD HH:mm:ss").toISOString();const t=d.eventCategories.get(e.eventCategory),s=d.reasonCategories.get(e.reasonCategory);e.eventCategory=t.id,e.reasonCategory=s?s.id:null,e.materialLoss=t.get("materialLoss"),this.options.editMode?e.implementer=a.getUserInfo(this.$id("implementer")):(e.implementer=e.selfImplement&&!e.anonymous?i.getInfo():null,e.selfImplement=void 0),this.$id("plannedAt").prop("disabled")?delete e.plannedAt:e.plannedAt?e.plannedAt=o.utc.getMoment(e.plannedAt,"YYYY-MM-DD").toISOString():e.plannedAt=null,"string"==typeof e.priority&&(e.priority=+e.priority);const n=this.model.get("resolution");return u.can.editResolutionType(this.model)&&(n.type=this.getResolutionType()),u.can.editResolutionId(this.model)&&(n._id=parseInt(this.$id("resolutionId").val(),10)||0),e.resolution=n,e},checkValidity:function(e){return console.log(e),!0},afterRender:function(){n.prototype.afterRender.apply(this,arguments),this.setUpUserWorkplaceSelect2(),this.setUpUserDivisionSelect2(),this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpImplementerSelect2(),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2(),this.setUpResolution(),this.setUpEventDate(),this.togglePriority(),this.toggleImplement(),this.toggleKind()},isAnonymous:function(){return this.$id("anonymous").prop("checked")},setUpUserWorkplaceSelect2:function(){const e=this.$id("userWorkplace");if(this.options.editMode){const t=d.workplaces.get(this.model.get("userWorkplace"));return e.val(t?t.id:"").select2({width:"100%",placeholder:" ",data:t?[{id:t.id,text:t.getLabel({long:!0}),model:t}]:[]}),void e.select2("enable",!1)}if(this.isAnonymous())return e.val("").select2({width:"100%",placeholder:" ",data:[]}),void e.select2("enable",!1).prop("required",!1).closest(".form-group").removeClass("has-required-select2").find(".control-label").removeClass("is-required");e.prop("required",!0).closest(".form-group").addClass("has-required-select2").find(".control-label").addClass("is-required");let t=d.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const o={};d.workplaces.forEach(e=>{e.get("active")&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!o[t.id]&&(o[t.id]=t),e.select2({width:"100%",data:Object.values(o).sort((e,t)=>e.text.localeCompare(t.text))});const s=d.workplaces.get(i.data.oshWorkplace);this.options.editMode&&t?e.select2("enable",!1).select2("data",t):s?e.select2("enable",!1).select2("data",{id:s.id,text:s.getLabel({long:!0}),model:s}):e.select2("enable",!0)},setUpUserDivisionSelect2:function(){const e=this.$id("userDivision");if(this.options.editMode){const t=d.divisions.get(this.model.get("userDivision"));return e.val(t?t.id:"").select2({width:"100%",placeholder:" ",data:t?[{id:t.id,text:t.getLabel({long:!0}),model:t}]:[]}),void e.select2("enable",!1)}if(this.isAnonymous())return e.val("").select2({width:"100%",placeholder:" ",data:[]}),void e.select2("enable",!1).prop("required",!1).closest(".form-group").removeClass("has-required-select2").find(".control-label").removeClass("is-required");const t=+this.$id("userWorkplace").val();let o=d.divisions.get(+e.val());o&&(o={id:o.id,text:o.getLabel({long:!0}),model:o});const s={};d.divisions.forEach(e=>{e.get("active")&&e.get("workplace")===t&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),o&&!s[o.id]&&o.model.get("workplace")===t&&(s[o.id]=o);const n=Object.values(s).sort((e,t)=>e.text.localeCompare(t.text));let l=" ",a=!0;t||0!==n.length||(l=this.t("FORM:placeholder:noUserWorkplace"),a=!1),e.select2({width:"100%",placeholder:l,data:n});const r=d.divisions.get(i.data.oshDivision);this.options.editMode&&o?e.select2("enable",!1).select2("data",o):r?e.select2("enable",!1).select2("data",{id:r.id,text:r.getLabel({long:!0}),model:r}):(e.select2("enable",a),1===n.length?e.select2("data",n[0]):s[e.val()]||e.select2("data",null).val(""))},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");let t=d.workplaces.get(+e.val());t&&(t={id:t.id,text:t.getLabel({long:!0}),model:t});const i={};d.workplaces.forEach(e=>{e.get("active")&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),t&&!i[t.id]&&(i[t.id]=t),e.select2({width:"100%",data:Object.values(i).sort((e,t)=>e.text.localeCompare(t.text))})},setUpDivisionSelect2:function(){const e=this.$id("division"),t=+this.$id("workplace").val();let i=d.divisions.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const o={};d.divisions.forEach(e=>{e.get("active")&&e.hasWorkplace(t)&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!o[i.id]&&(o[i.id]=i);const s=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noWorkplace"),data:s}),1===s.length?e.select2("data",s[0]):o[e.val()]||e.val("").select2("data",null),e.select2("enable",!!t)},setUpBuildingSelect2:function(){const e=this.$id("building"),t=+this.$id("division").val(),i={};d.buildings.forEach(e=>{e.get("active")&&e.hasDivision(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noDivision"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t)},setUpLocationSelect2:function(){const e=this.$id("location"),t=+this.$id("building").val(),i={};d.locations.forEach(e=>{e.get("active")&&e.hasBuilding(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const o=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",placeholder:t?" ":this.t("FORM:placeholder:noBuilding"),data:o}),1===o.length&&e.select2("data",o[0]),e.select2("enable",!!t)},setUpImplementerSelect2:function(){const e=this.$id("implementer");a(e,{width:"100%"});const t=this.model.get("implementer");t&&e.select2("data",{id:t.id,text:t.label})},setUpEventCategorySelect2:function(){const e=this.$id("eventCategory"),t=this.$('input[name="kind"]:checked').val(),i={};d.eventCategories.forEach(e=>{e.get("active")&&e.hasKind(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const o=this.model.get("eventCategory"),s=d.eventCategories.get(o);o&&!i[o]&&(s?s.hasKind(t)&&(i[o]={id:o,text:s.getLabel({long:!0}),description:s.get("description"),model:s}):i[o]={id:o,text:`?${o}?`});const n=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",allowClear:!1,placeholder:" ",data:n,dropdownCssClass:"select2-with-description",formatResult:l.bind(null,"text","description")}),1===n.length&&e.val(n[0].id).select2("data",n[0])},setUpReasonCategorySelect2:function(){const e=this.$id("reasonCategory"),t=this.$id("eventCategory").val()||null,i={};d.reasonCategories.forEach(e=>{e.get("active")&&e.hasEventCategory(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const o=this.model.get("reasonCategory"),s=d.reasonCategories.get(o);o&&!i[o]&&(s?s.hasEventCategory(t)&&(i[o]={id:o,text:s.getLabel({long:!0}),description:s.get("description"),model:s}):i[o]={id:o,text:`?${o}?`});const n=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));let a=" ";t||0!==n.length||(a=this.t("FORM:placeholder:noEventCategory")),e.select2({width:"100%",allowClear:!0,placeholder:a,data:n,dropdownCssClass:"select2-with-description",formatResult:l.bind(null,"text","description")}),e.select2("enable",0!==n.length)},setUpResolution:function(){if(!this.options.editMode)return;this.hideResolutionPopover();const e=this.model.get("resolution"),t=this.getResolutionType(),i=this.$id("resolutionGroup");let o="",s=u.can.editResolutionId(this.model);s&&"unspecified"===t&&(s=!1),i.find(".control-label").text(this.t(`FORM:resolution:${t}`)),i.find("input, button").prop("disabled",!s),s&&this.resolution.added[t]?o=this.resolution.added[t].toString():t===e.type&&e._id&&(o=e._id.toString()),this.$id("resolutionId").val(o)[0].setCustomValidity("")},setUpEventDate:function(){clearTimeout(this.timers.maxEventDate);const e=o.getMoment().add(1,"days").startOf("day").valueOf()-Date.now()+1e3;this.timers.maxEventDate=setTimeout(()=>{this.$id("eventDate").prop("max",o.format(Date.now(),"YYYY-MM-DD")),this.setUpEventDate()},Math.min(e,6e4))},toggleKind:function(){const e=this.$('input[name="kind"]');e.length&&!e.filter(":checked").length&&e.first().click(),e.prop("disabled",!u.can.editKind(this.model,this.options.editMode))},togglePriority:function(){const e=this.$('input[name="priority"]'),t=d.kinds.get(+this.$('input[name="kind"]:checked').val()||this.model.get("kind")),i=t?t.get("type"):null,o=this.options.editMode&&(this.model.isCoordinator()||u.can.manage());let s=+e.filter(":checked").val();this.options.editMode||(s="osh"===i?3:1),e.prop("disabled",!o).filter(`input[value="${s}"]`).prop("checked",!0),e.closest(".form-group").toggleClass("hidden",!o)},toggleCreator:function(){this.$id("creator").text(this.$id("anonymous").prop("checked")?this.t("wmes-osh-common","anonymous:label"):i.getLabel())},toggleImplement:function(){const e=!!this.$id("anonymous").prop("checked"),t=this.$id("selfImplement"),i=this.$id("implementer"),o=this.$id("plannedAt");t.length&&(t.prop("checked")&&e&&t.prop("checked",!1),t.prop("disabled",e),t.closest("label").toggleClass("disabled",e));const s=u.can.manage(),n=this.model.isImplementer(),l=this.model.isCoordinator();i.length&&i.select2("enable",s||l),this.options.editMode?o.prop("disabled",!s&&!n&&!l):o.val("").prop("disabled",!t.prop("checked"))},getSaveOptions:function(){return{wait:!0,patch:!0}},request:function(){s.msg.saving();var e=n.prototype.request.apply(this,arguments);return e.always(function(){s.msg.saved()}),e},submitRequest:function(e,t){const i=this,o=new FormData;let l=0;if(this.$id("anonymous").prop("checked")&&o.append("anonymous","1"),i.$('input[type="file"]').each(function(){for(let e=0;e<this.files.length;++e)o.append("file",this.files[e]),l+=1}),0===l)return n.prototype.submitRequest.call(i,e,t);s.msg.saving();const a=i.ajax({type:"POST",url:"/osh/attachments",data:o,processData:!1,contentType:!1});a.done(o=>{t.attachments={added:o},n.prototype.submitRequest.call(i,e,t),s.msg.saved()}),a.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("wmes-osh-common","FORM:ERROR:upload")),e.attr("disabled",!1)})},toggleActions:function(e){this.$(".form-actions .btn").prop("disabled",!e)},showResolutionPopover:function(e,t){if(e!==this.resolution.type||t!==this.resolution.id)return this.loadResolution(e,t,!0);this.resolution.id?this.resolution.data?this.$id("showResolution").data("bs.popover")||this.$id("showResolution").popover({container:this.$id("resolutionGroup"),trigger:"click",placement:"top",html:!0,title:function(){return""},content:this.renderPartialHtml(h,this.resolution)}).popover("show"):this.$id("save").click():this.$id("resolutionId").focus()},hideResolutionPopover:function(){this.$id("showResolution").popover("destroy")},loadResolution:function(e,t,i){if(e||(e=this.getResolutionType()),t||(t=parseInt(this.$id("resolutionId").val(),10)||0),this.resetResolution(),!t)return void this.$id("resolutionId").val("");const o=this.$id("showResolution").prop("disabled",!0);this.toggleActions(!1);const n=this.resolution.req=this.ajax({url:`/osh/${e}s/${t}?select(subject,status)`});n.fail(()=>{if(404!==n.status)return this.$id("resolutionId")[0].setCustomValidity(this.t("FORM:resolution:failure")),s.msg.loadingFailed();s.msg.loaded(),this.resolution.type=e,this.resolution.id=t,this.$id("resolutionId")[0].setCustomValidity(this.t("FORM:resolution:notFound"))}),n.done(o=>{this.$id("resolutionId")[0].setCustomValidity(""),this.resolution.type=e,this.resolution.id=t,this.resolution.data=o,i&&this.showResolutionPopover(e,t)}),n.always(()=>{this.resolution.req===n&&(this.resolution.req=null,o.prop("disabled",!1),this.toggleActions(!0))})},showAddResolutionDialog:function(){if(!this.el.checkValidity())return this.$id("save").click();const e=this.getFormData(),t=this.getResolutionType();let i=null;"kaizen"===t&&(i=new c({relation:this.model,model:new r({subject:e.subject,kind:e.kind,workplace:e.workplace,division:e.division,building:e.building,location:e.location,problem:e.problem,reason:e.reason,suggestion:e.suggestion,plannedAt:e.plannedAt})}),s.showDialog(i,this.t(`FORM:resolution:title:${t}`)),i.handleSuccess=(()=>{this.resolution.added[t]=i.model.id,this.resolution.type=t,this.resolution.id=i.model.id,this.resolution.data=i.model.toJSON(),this.$id("resolutionId").val(this.resolution.id.toString()),s.closeDialog()}))},onDocumentClick:function(e){this.$(e.target).closest(`#${this.idPrefix}-resolutionGroup`).length||this.hideResolutionPopover()},onDocumentKeyDown:function(e){if("Escape"===e.key&&this.$id("showResolution").data("bs.popover"))return this.hideResolutionPopover(),!1}})});