define(["underscore","app/user","app/time","app/viewport","app/core/views/FormView","app/core/util/formatResultWithDescription","app/users/util/setUpUserSelect2","app/wmes-osh-common/dictionaries","../NearMiss","app/wmes-osh-nearMisses/templates/form"],function(e,t,i,s,o,n,l,a,d,c){"use strict";return o.extend({template:c,events:Object.assign({"change #-anonymous":function(){this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.toggleImplement()},"change #-selfImplement":function(){this.toggleImplement()},"change #-workplace":function(){this.$id("division").val(""),this.$id("building").val(""),this.$id("location").val(""),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2()},"change #-division":function(){this.$id("building").val(""),this.$id("location").val(""),this.setUpBuildingSelect2(),this.setUpLocationSelect2()},"change #-building":function(){this.$id("location").val(""),this.setUpLocationSelect2()},'change input[name="kind"]':function(){this.$id("eventCategory").val(""),this.$id("reasonCategory").val(""),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2(),this.togglePriority()},"change #-eventCategory":function(){this.$id("reasonCategory").val(""),this.setUpReasonCategorySelect2()},"change #-attachments":function(){const e=this.$id("attachments"),t=this.options.editMode?5:2;e[0].setCustomValidity(e[0].files.length>t?this.t("FORM:ERROR:tooManyFiles",{max:t}):"")},"click #-todo":function(){this.newStatus="inProgress";const t=this.$id("implementer"),i=this.$id("plannedAt");if(!t.select2("data")||!i.val()){const s=t.prop("required"),o=i.prop("required"),n=e.once(()=>{s||t.prop("required",!1).closest(".form-group").removeClass("has-required-select2"),i.prop("required",o)});t.prop("required",!0).one("select2-blur",n).closest(".form-group").addClass("has-required-select2"),i.prop("required",!0).one("blur",n)}this.$id("save").click(),setTimeout(()=>this.newStatus=null)},"click #-pause":function(){this.newStatus="paused";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)},"click #-cancel":function(){this.newStatus="cancelled";const e=this.$id("comment");if(!e.val().trim().replace(/[^a-zA-Z]+/g,"").length){const t=()=>{e.prop("required",!1)};e.prop("required",!0),e.one("blur",t)}this.$id("save").click(),setTimeout(()=>this.newStatus=null,1)}},o.prototype.events),getTemplateData:function(){return{today:i.getMoment().format("YYYY-MM-DD"),kinds:a.kinds.map(e=>({value:e.id,label:e.getLabel({long:!0}),title:e.get("description")})).sort((e,t)=>e.label.localeCompare(t.label)),priorities:a.priorities.map(e=>({value:e,label:a.getLabel("priority",e)})),can:{todo:d.can.todo(this.model),pause:d.can.pause(this.model),cancel:d.can.cancel(this.model)}}},serializeToForm:function(){const e=this.model.toJSON();if(this.options.editMode){const t=i.utc.getMoment(e.eventDate);e.eventDate=t.format("YYYY-MM-DD"),e.eventTime=t.format("H")}else{const t=i.getMoment();e.eventDate=t.format("YYYY-MM-DD"),e.eventTime=t.format("H")}return e.plannedAt&&(e.plannedAt=i.utc.format(e.plannedAt,"YYYY-MM-DD")),e},serializeForm:function(e){this.newStatus&&(e.status=this.newStatus),e.workplace=this.$id("workplace").select2("data").id,e.division=this.$id("division").select2("data").id,e.building=this.$id("building").select2("data").id,e.location=this.$id("location").select2("data").id;const s=a.divisions.get(e.division);e.manager=s.get("manager")||null,e.eventDate=i.utc.getMoment(`${e.eventDate} ${(e.eventTime||"00").padStart(2,"0")}:00:00`,"YYYY-MM-DD HH:mm:ss").toISOString();const o=a.eventCategories.get(e.eventCategory),n=a.reasonCategories.get(e.reasonCategory);return e.eventCategory=o.id,e.reasonCategory=n?n.id:null,e.materialLoss=o.get("materialLoss"),this.options.editMode?e.implementer=l.getUserInfo(this.$id("implementer")):(e.implementer=e.selfImplement&&!e.anonymous?t.getInfo():null,e.selfImplement=void 0),this.$id("plannedAt").prop("disabled")?delete e.plannedAt:e.plannedAt?e.plannedAt=i.utc.getMoment(e.plannedAt,"YYYY-MM-DD").toISOString():e.plannedAt=null,"string"==typeof e.priority&&(e.priority=+e.priority),e},checkValidity:function(e){return console.log(e),!0},afterRender:function(){o.prototype.afterRender.apply(this,arguments),this.setUpWorkplaceSelect2(),this.setUpDivisionSelect2(),this.setUpBuildingSelect2(),this.setUpLocationSelect2(),this.setUpImplementerSelect2(),this.setUpEventCategorySelect2(),this.setUpReasonCategorySelect2(),this.togglePriority(),this.toggleImplement();const e=this.$('input[name="kind"]');e.length&&!e.filter(":checked").length&&e.first().click()},isAnonymous:function(){return this.$id("anonymous").prop("checked")},setUpWorkplaceSelect2:function(){const e=this.$id("workplace");let i=a.workplaces.get(+e.val());i&&(i={id:i.id,text:i.getLabel({long:!0}),model:i});const s={};a.workplaces.forEach(e=>{e.get("active")&&(s[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),i&&!s[i.id]&&(s[i.id]=i),e.select2({width:"100%",data:Object.values(s).sort((e,t)=>e.text.localeCompare(t.text))});const o=a.workplaces.get(t.data.oshWorkplace);this.options.editMode&&i?e.select2("enable",!1).select2("data",i):this.isAnonymous()||!o?e.select2("enable",!0):e.select2("enable",!1).select2("data",{id:o.id,text:o.getLabel({long:!0}),model:o})},setUpDivisionSelect2:function(){const e=this.$id("division"),i=+this.$id("workplace").val();let s=a.divisions.get(+e.val());s&&(s={id:s.id,text:s.getLabel({long:!0}),model:s});const o={};a.divisions.forEach(e=>{e.get("active")&&e.get("workplace")===i&&(o[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})}),s&&!o[s.id]&&s.model.get("workplace")===i&&(o[s.id]=s);const n=Object.values(o).sort((e,t)=>e.text.localeCompare(t.text));let l=" ",d=!0;i||0!==n.length||(l=this.t("FORM:placeholder:noWorkplace"),d=!1),e.select2({width:"100%",placeholder:l,data:n});const c=a.divisions.get(t.data.oshDivision);this.options.editMode&&s?e.select2("enable",!1).select2("data",s):this.isAnonymous()||!c?(e.select2("enable",d),1===n.length?e.select2("data",n[0]):o[e.val()]||e.select2("data",null).val("")):e.select2("enable",!1).select2("data",{id:c.id,text:c.getLabel({long:!0}),model:c})},setUpBuildingSelect2:function(){const e=this.$id("building"),t=+this.$id("division").val(),i={};a.buildings.forEach(e=>{e.get("active")&&e.hasDivision(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const s=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));let o=" ",n=!this.options.editMode;t||0!==s.length||(o=this.t("FORM:placeholder:noDivision"),n=!1),e.select2({width:"100%",placeholder:o,data:s}),e.select2("enable",n),1===s.length&&e.select2("data",s[0])},setUpLocationSelect2:function(){const e=this.$id("location"),t=+this.$id("building").val(),i={};a.locations.forEach(e=>{e.get("active")&&e.hasBuilding(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),model:e})});const s=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));let o=" ",n=!0;t||0!==s.length||(o=this.t("FORM:placeholder:noBuilding"),n=!1),e.select2({width:"100%",placeholder:o,data:s}),e.select2("enable",n),1===s.length&&e.select2("data",s[0])},setUpImplementerSelect2:function(){const e=this.$id("implementer");l(e,{width:"100%"});const t=this.model.get("implementer");t&&e.select2("data",{id:t.id,text:t.label})},setUpEventCategorySelect2:function(){const e=this.$id("eventCategory"),t=this.options.editMode?this.model.get("kind"):this.$('input[name="kind"]:checked').val(),i={};a.eventCategories.forEach(e=>{e.get("active")&&e.hasKind(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const s=this.model.get("eventCategory"),o=a.eventCategories.get(s);s&&!i[s]&&(o?o.hasKind(t)&&(i[s]={id:s,text:o.getLabel({long:!0}),description:o.get("description"),model:o}):i[s]={id:s,text:`?${s}?`});const l=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));e.select2({width:"100%",allowClear:!1,placeholder:" ",data:l,dropdownCssClass:"select2-with-description",formatResult:n.bind(null,"text","description")}),1===l.length&&e.val(l[0].id).select2("data",l[0])},setUpReasonCategorySelect2:function(){const e=this.$id("reasonCategory"),t=this.$id("eventCategory").val()||null,i={};a.reasonCategories.forEach(e=>{e.get("active")&&e.hasEventCategory(t)&&(i[e.id]={id:e.id,text:e.getLabel({long:!0}),description:e.get("description"),model:e})});const s=this.model.get("reasonCategory"),o=a.reasonCategories.get(s);s&&!i[s]&&(o?o.hasEventCategory(t)&&(i[s]={id:s,text:o.getLabel({long:!0}),description:o.get("description"),model:o}):i[s]={id:s,text:`?${s}?`});const l=Object.values(i).sort((e,t)=>e.text.localeCompare(t.text));let d=" ";t||0!==l.length||(d=this.t("FORM:placeholder:noEventCategory")),e.select2({width:"100%",allowClear:!0,placeholder:d,data:l,dropdownCssClass:"select2-with-description",formatResult:n.bind(null,"text","description")}),e.select2("enable",0!==l.length)},togglePriority:function(){const e=this.$('input[name="priority"]'),t=a.kinds.get(+this.$('input[name="kind"]:checked').val()||this.model.get("kind")),i=t?t.get("type"):null,s=this.model.get("priority"),o=this.model.get("status")||"new";let n=this.model.isCoordinator()||d.can.manage(),l=1;this.options.editMode&&n?l=s:"osh"===i?l=3:"inf"===i&&(n=n||"new"===o,"number"==typeof s&&(l=s)),e.prop("disabled",!n).filter(`input[value="${l}"]`).prop("checked",!0),e.closest(".form-group").toggleClass("hidden",!n)},toggleImplement:function(){const e=!!this.$id("anonymous").prop("checked"),t=this.$id("selfImplement"),i=this.$id("implementer"),s=this.$id("plannedAt");t.length&&(t.prop("checked")&&e&&t.prop("checked",!1),t.prop("disabled",e),t.closest("label").toggleClass("disabled",e));const o=d.can.manage(),n=this.model.isImplementer(),l=this.model.isCoordinator();i.length&&i.select2("enable",o||l),this.options.editMode?s.prop("disabled",!o&&!n&&!l):s.val("").prop("disabled",!t.prop("checked"))},request:function(){s.msg.saving();var e=o.prototype.request.apply(this,arguments);return e.always(function(){s.msg.saved()}),e},submitRequest:function(e,t){const i=this,n=new FormData;let l=0;if(this.$id("anonymous").prop("checked")&&n.append("anonymous","1"),i.$('input[type="file"]').each(function(){for(let e=0;e<this.files.length;++e)n.append("file",this.files[e]),l+=1}),0===l)return o.prototype.submitRequest.call(i,e,t);s.msg.saving();const a=i.ajax({type:"POST",url:"/osh/attachments",data:n,processData:!1,contentType:!1});a.done(n=>{t.attachments={added:n},o.prototype.submitRequest.call(i,e,t),s.msg.saved()}),a.fail(()=>{s.msg.saved(),i.showErrorMessage(i.t("FORM:ERROR:upload")),e.attr("disabled",!1)})}})});