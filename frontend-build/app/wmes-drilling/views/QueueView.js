define(["underscore","jquery","app/i18n","app/user","app/viewport","app/core/View","app/planning/util/contextMenu","./OrderDetailsView","app/wmes-drilling/templates/queue","app/wmes-drilling/templates/queueOrder"],function(e,r,t,i,s,o,l,n,d,a){"use strict";return o.extend({template:d,modelProperty:"orders",events:{"mousedown .drilling-order":function(e){this.lastClickEvent=e,this.options.embedded&&(this.timers.showMenu&&clearTimeout(this.timers.showMenu),this.timers.showMenu=setTimeout(this.showMenu.bind(this,e),300))},"mouseup .drilling-order":function(e){if(!this.options.embedded||this.timers.showMenu){clearTimeout(this.timers.showMenu),this.timers.showMenu=null;var r=this.lastClickEvent;this.lastClickEvent=null,r&&0===e.button&&""===window.getSelection().toString()&&(window.parent===window||r.offsetY===e.offsetY&&r.offsetX===e.offsetX&&r.screenX===e.screenX&&r.screenY===e.screenY)&&this.handleOrderClick(e.currentTarget.dataset.orderId,this.$(e.target).closest("td")[0].dataset.property)}},"contextmenu .visible":function(e){return this.showMenu(e),!1}},initialize:function(){this.onScroll=e.debounce(this.onScroll.bind(this),100,!1),this.lastClickEvent=null,this.lastFocusedOrder=null,this.listenTo(this.orders,"reset",e.after(2,this.render)),this.listenTo(this.orders,"change",this.onChange),this.listenTo(this.orders,"focus",this.onFocus),this.listenTo(this.orders,"mrpSelected",this.toggleVisibility)},getTemplateData:function(){var e=this,r=null,t=null,i=e.orders.serialize().map(function(i){return(i={order:i,visible:e.orders.isVisible(i),first:!1,last:!1,commentVisible:!0,rowSpan:"rowSpan",view:"queue"}).visible&&(r||(r=i),t=i),i});return r&&(r.first=!0),t&&(t.last=!0),{orders:i,renderQueueOrder:this.renderPartialHtml.bind(this,a)}},afterRender:function(){var e=this.$order(this.lastFocusedOrder);e.length&&(this.el.parentNode.scrollTop=e[0].offsetTop+1)},$order:function(e){return this.$('.drilling-order[data-order-id="'+e+'"]')},handleOrderClick:function(e,r){if(!s.currentDialog){var t=this.orders.get(e);if(t){var i=t.get("followups");if(!i.length||"no"!==r&&"order"!==r){var o=this.$order(e)[0];o&&(this.$el.parent().animate({scrollTop:o.offsetTop+1},200),this.lastFocusedOrder=e);var l=new n({model:t,orders:this.orders,height:o?o.clientHeight:0,vkb:this.options.vkb,embedded:this.options.embedded});s.showDialog(l)}else this.onFocus(i[0])}}},showMenu:function(e){var r=this;r.timers.showMenu&&(clearTimeout(r.timers.showMenu),r.timers.showMenu=null);var t=r.orders.get(e.currentTarget.dataset.orderId);if(t){var s=t.get("order"),o=t.get("mrp"),n=[t.get("order")];i.can.viewOrders()&&(n.push({icon:"fa-file-o",label:r.t("menu:openOrder",{orderNo:"parent"}),handler:r.trigger.bind(r,"actionRequested","openOrder",{orderNo:s})}),t.get("childOrders").forEach(function(e){e.order!==s&&n.push({label:r.t("menu:openOrder",{orderNo:e.order}),handler:r.trigger.bind(r,"actionRequested","openOrder",{orderNo:e.order})})})),n.push({icon:"fa-print",label:r.t("menu:printOrder"),handler:r.trigger.bind(r,"actionRequested","printOrders",{filterProperty:"order",filterValue:s})},{icon:"fa-clipboard",label:r.t("menu:copyOrder"),handler:r.trigger.bind(r,"actionRequested","copyOrders",e,{filterProperty:"order",filterValue:s}),visible:!r.options.embedded},{label:r.t("menu:copyChildOrders"),handler:r.trigger.bind(r,"actionRequested","copyChildOrders",e,{filterProperty:"order",filterValue:s}),visible:!r.options.embedded},"-",r.t("menu:header:mrp",{mrp:o}),{icon:"fa-print",label:r.t("menu:printOrders"),handler:r.trigger.bind(r,"actionRequested","printOrders",{filterProperty:"mrp",filterValue:o})},{icon:"fa-clipboard",label:r.t("menu:copyOrders"),handler:r.trigger.bind(r,"actionRequested","copyOrders",e,{filterProperty:"mrp",filterValue:o}),visible:!r.options.embedded},{label:r.t("menu:copyChildOrders"),handler:r.trigger.bind(r,"actionRequested","copyChildOrders",e,{filterProperty:"mrp",filterValue:o}),visible:!r.options.embedded},{icon:"fa-download",label:r.t("menu:exportOrders"),handler:r.trigger.bind(r,"actionRequested","exportOrders",{filterProperty:"mrp",filterValue:o}),visible:!r.options.embedded}),n.push("-",r.t("menu:header:all"),{icon:"fa-print",label:r.t("menu:printOrders"),handler:r.trigger.bind(r,"actionRequested","printOrders",{filterProperty:null,filterValue:null})},{icon:"fa-clipboard",label:r.t("menu:copyOrders"),handler:r.trigger.bind(r,"actionRequested","copyOrders",e,{filterProperty:null,filterValue:null}),visible:!r.options.embedded},{label:r.t("menu:copyChildOrders"),handler:r.trigger.bind(r,"actionRequested","copyChildOrders",e,{filterProperty:null,filterValue:null}),visible:!r.options.embedded},{icon:"fa-download",label:r.t("menu:exportOrders"),handler:r.trigger.bind(r,"actionRequested","exportOrders",{filterProperty:null,filterValue:null}),visible:!r.options.embedded}),l.show(r,e.pageY,e.pageX,n)}},hideMenu:function(){l.hide(this)},toggleVisibility:function(){var e=this.orders;this.$(".drilling-order").each(function(){var r=e.get(this.dataset.orderId),t=!r||!e.isVisible(r.serialize());this.classList.toggle("hidden",t),this.classList.toggle("visible",!t)}),this.$(".drilling-order.is-first, .drilling-order.is-last").removeClass("is-first is-last");var r=this.$(".visible");r.first().addClass("is-first"),r.last().addClass("is-last"),this.el.scrollTop=0},onScroll:function(){var e=this.$(".visible");if(e.length){var r=this.el.parentNode;if(r){this.lastFocusedOrder=e[0].dataset.orderId;for(var t=r.scrollTop,i=0;i<e.length;++i){var s=e[i];if(s.offsetTop>t)break;this.lastFocusedOrder=s.dataset.orderId,t>s.offsetTop+26&&e[i+1]&&(this.lastFocusedOrder=e[i+1].dataset.orderId)}}}},onChange:function(e){var r=this.$order(e.id),t=e.serialize();r.replaceWith(a({order:t,visible:this.orders.isVisible(t),first:r.hasClass("is-first"),last:r.hasClass("is-last"),commentVisible:!0,rowSpan:"rowSpan",view:"queue"}))},onFocus:function(e,r){var t=this.$order(e)[0];t?(t.classList.contains("hidden")&&this.orders.selectMrp(t.dataset.mrp),this.$el.parent().animate({scrollTop:t.offsetTop+1},200),this.lastFocusedOrder=e,r&&r.showDetails&&this.handleOrderClick(e)):this.handleOrderClick(e)}})});