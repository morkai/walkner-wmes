define(["underscore","jquery","../time","../core/util/getShiftStartInfo","../core/Collection","./DrillingOrder"],function(e,t,r,i,s,n){"use strict";return s.extend({model:n,comparator:"no",initialize:function(t,r){this.settings=r?r.settings:null,this.user=r?r.user:null,this.selectedMrp=r&&r.selectedMrp?r.selectedMrp:"all",this.allMrps=null,this.serializedList=null,this.serializedMap=null,this.totalQuantities={},this.on("request",function(){this.serializedList=null,this.serializedMap=null}),this.on("change",function(t){this.serializedMap&&this.serializedMap[t.id]&&e.assign(this.serializedMap[t.id],t.serialize(!0,this))})},parse:function(e){return s.prototype.parse.call(this,e).map(n.parse)},genClientUrl:function(){return"/drilling/"+this.getDateFilter()},isDateFilter:function(t){return e.some(this.rqlQuery.selector.args,function(e){return"eq"===e.name&&"date"===e.args[0]&&e.args[1]===t})},getDateFilter:function(e){var t=null;return this.rqlQuery.selector.args.forEach(function(i){"eq"===i.name&&"date"===i.args[0]&&(t=r.utc.getMoment(i.args[1],"YYYY-MM-DD").format(e||"YYYY-MM-DD"))}),t},setDateFilter:function(e){this.rqlQuery.selector.args.forEach(function(t){"eq"===t.name&&"date"===t.args[0]&&(t.args[1]=e)})},selectMrp:function(e){this.selectedMrp=this.selectedMrp===e?"all":e,this.trigger("mrpSelected")},isVisible:function(e){return this.isMrpVisible(e)},isMrpVisible:function(e){return"all"===this.selectedMrp||e.mrp===this.selectedMrp},getAllByOrderNo:function(t){return this.filter(function(r){return r.get("order")===t||e.some(r.get("childOrders"),function(e){return e.order===t})})},getFirstByOrderNo:function(t){return this.find(function(r){return r.get("order")===t||e.some(r.get("childOrders"),function(e){return e.order===t})})},serialize:function(e){var t=this;if(!e&&t.serializedList)return t.serializedList;var r=[],i={},s={},n={all:{new:0,started:0,partial:0,finished:0,painted:0,cancelled:0}};return t.forEach(function(e){var l=i[e.id]=e.serialize(!0,t);r.push(l),s[l.mrp]=1,t.recountOrder(n,l)}),t.serializedList=r,t.serializedMap=i,t.allMrps=Object.keys(s).sort(),t.totalQuantities=n,"all"===t.selectedMrp||s[t.selectedMrp]||t.selectMrp("all"),r},serializeTotals:function(){return this.totalQuantities[this.selectedMrp]||{new:0,started:0,partial:0,finished:0,painted:0,cancelled:0}},recountTotals:function(){this.totalQuantities={all:{new:0,started:0,partial:0,finished:0,painted:0,cancelled:0}},(this.serializedList||[]).forEach(this.recountOrder.bind(this,this.totalQuantities)),this.trigger("totalsRecounted")},recountOrder:function(e,t){var r=t.mrp,i=t.status,s=t.qtyDrill;e[r]||(e[r]={new:0,started:0,partial:0,finished:0,painted:0,cancelled:0}),e.all[i]+=s,e[r][i]+=s},act:function(e,r){var i=this,s=i.url;e.orderId&&(s="/drilling/orders/"+e.orderId),i.user&&(e.user=i.user);var n=t.ajax({method:"PATCH",url:s,data:JSON.stringify(e)});return i.trigger("request",this,n,{}),n.fail(function(e){var t=e.responseJSON?e.responseJSON.error:null;t||(t={message:e.statusText}),t.statusCode=e.status,r(t),i.trigger("error",n)}),n.done(function(e){r(null,e),i.trigger("sync",e,n)}),n},applyChanges:function(e){var t=this,r=e.removed.length>0||e.added.length>0,i=r;if(!r)for(var s=0;s<e.changed.length;++s)if(e.changed[s].no>0){r=!0;break}t.remove(e.removed,{silent:r}),e.added.forEach(function(e){t.add(n.parse(e),{silent:r})}),e.changed.forEach(function(e){var s=t.get(e._id);s&&(s.set(n.parse(e),{silent:r}),(e.qtyDrill||e.status)&&(i=!0))}),r?(t.allMrps=null,t.serializedList=null,t.serializedMap=null,t.sort({silent:!0}),t.trigger("reset",t)):i&&t.recountTotals()}},{forDate:function(t,r){return new this(null,e.assign({rqlQuery:"sort(date,no)&limit(0)&date="+t},r))}})});