define(["underscore","../time","../i18n","../core/Model"],function(t,r,e,i){"use strict";var s={};function n(t){return["date","startedAt","finishedAt"].forEach(function(r){"string"==typeof t[r]&&(t[r]=new Date(t[r]))}),t}return i.extend({urlRoot:"/drilling/orders",clientUrlRoot:"#drilling/orders",topicPrefix:"drilling.orders",privilegePrefix:"DRILLING",nlsDomain:"wmes-drilling",parse:n,serialize:function(i,n){if(n||(n=this.collection),!i&&n&&n.serializedMap&&n.serializedMap[this.id])return n.serializedMap[this.id];var o=this.toJSON(),a=o.childOrders.length,l=a-1;if(o.rowSpan=a+1,o.rowSpanDetails=o.rowSpan,o.mrps={},o.mrps[o.mrp]=1,o.childOrders=o.childOrders.map(function(r,e){o.mrps[r.mrp]=1;var i=[];r.components.forEach(function(t){s[t.nc12]||i.push(t)});var n=i.length,a=n;return o.rowSpan+=n,o.rowSpanDetails+=a,t.assign({rowSpan:n+1,rowSpanDetails:a+1,last:e===l},r,{components:i})}),o.mrps=Object.keys(o.mrps).join(" "),n&&o.followups.length){var d=o.followups;o.followups=[],d.forEach(function(t){var r=n.get(t);r&&o.followups.push({id:t,no:r.get("no")})})}if(o.startTime&&(o.startTimeTime=r.utc.format(o.startTime,"HH:mm:ss")),o.startedAt){var m=r.getMoment(o.startedAt);o.startedAtTime=m.format("HH:mm:ss"),o.startedAtDate=m.format("DD.MM, HH:mm:ss")}if(o.finishedAt){var f=r.getMoment(o.finishedAt);o.finishedAtTime=f.format("HH:mm:ss"),o.finishedAtDate=f.format("DD.MM, HH:mm:ss")}return"finished"===o.status&&o.painted&&(o.status="painted"),o.statusText=e("wmes-drilling","status:"+o.status),o},hasAnyChildOrderForComponents:function(t){for(var r=this.attributes.childOrders,e=0;e<r.length;++e)if(t[r[e].nc12])return!0;return!1}},{parse:n,isComponentBlacklisted:function(t){return s[t.nc12]}})});