define(["underscore","jquery","app/time","app/data/aors","app/data/downtimeReasons","app/orgUnits/views/OrgUnitDropdownsView","app/orgUnits/util/changeWarning","app/core/views/FormView","app/core/util/idAndLabel","app/subdivisions/templates/form","app/subdivisions/templates/autoDowntimeRow"],function(t,e,i,a,n,o,s,r,d,l,u){"use strict";return r.extend({template:l,events:t.assign(r.prototype.events,{"click #-addAutoDowntime":function(){var t=this.$id("autoDowntimeReason"),e=t.val();e&&this.addAutoDowntime({reason:e,when:"always",after:"",time:[]}),t.select2("val",null).select2("focus")},'click .btn[data-auto-downtime-action="up"]':function(t){var e=this.$(t.target).closest("tr"),i=e.prev();i.length&&e.insertBefore(i)},'click .btn[data-auto-downtime-action="down"]':function(t){var e=this.$(t.target).closest("tr"),i=e.next();i.length&&e.insertAfter(i)},'click .btn[data-auto-downtime-action="remove"]':function(t){var e=this.$(t.target).closest("tr").fadeOut("fast",function(){e.remove()})},'change [name$="when"]':function(t){this.toggleAutoDowntimeOptions(this.$(t.currentTarget).closest("tr"))},'change [name$="after"]':function(t){this.toggleAutoDowntimeOptions(this.$(t.currentTarget).closest("tr"))},'change [name$="time"]':function(t){for(var e,i=/(?:([0-9]+)@)?([0-9]{1,2}):([0-9]{1,2})/g,a=[];null!==(e=i.exec(t.target.value));){var n=+e[1]||0;n<0?n=0:n>480&&(n=480);var o=+e[2];if(!(o>=24)){var s=+e[3];s>=60||(o<10&&(o="0"+o),s<10&&(s="0"+s),a.push((n?n+"@":"")+o+":"+s))}}t.target.value=a.join(", ")}}),initialize:function(){r.prototype.initialize.call(this),this.autoDowntimeI=0,this.orgUnitDropdownsView=new o({orgUnit:o.ORG_UNIT.DIVISION,required:!0}),this.setView(".orgUnitDropdowns-container",this.orgUnitDropdownsView)},afterRender:function(){r.prototype.afterRender.call(this);var t=this.orgUnitDropdownsView;this.listenToOnce(t,"afterRender",function(){t.selectValue(this.model).focus(),t.$id("division").select2("enable",!this.options.editMode)}),this.$id("prodTaskTags").select2({tags:this.model.allTags||[],tokenSeparators:[","]}),this.$id("aor").select2({placeholder:" ",allowClear:!0,data:a.map(d)}),this.$id("autoDowntimeReason").select2({width:"400px",allowClear:!1,data:n.map(function(t){return{id:t.id,text:t.id+" - "+t.getLabel()}})}),this.model.get("autoDowntimes").forEach(this.addAutoDowntime,this),s(this)},serializeToForm:function(){var t=this.model.toJSON();return t.prodTaskTags=t.prodTaskTags?t.prodTaskTags.join(","):"",t.deactivatedAt&&(t.deactivatedAt=i.format(t.deactivatedAt,"YYYY-MM-DD")),t},serializeForm:function(e){e.prodTaskTags="string"==typeof e.prodTaskTags?e.prodTaskTags.split(","):[],e.aor=a.get(e.aor)?e.aor:null,e.autoDowntimes||(e.autoDowntimes=[]),t.forEach(e.autoDowntimes,function(t){"time"===t.when?t.time=t.time.split(",").map(function(t){var e=t.match(/(?:([0-9]+)@)?([0-9]{1,2}):([0-9]{1,2})/);return{h:+e[2],m:+e[3],d:+e[1]||0}}):t.time=[],"after"!==t.when&&(t.after="")});var n=i.getMoment(e.deactivatedAt||null);return e.deactivatedAt=n.isValid()?n.toISOString():null,e},addAutoDowntime:function(t){if(this.$id("autoDowntimes").find('input[value="'+t.reason+'"]').length)return;const e=this.renderPartial(u,{autoDowntime:{i:++this.autoDowntimeI,reason:d(n.get(t.reason)),when:t.when,after:t.after||"",time:t.time.map(t=>(t.d>0?`${t.d}@`:"")+t.h.toString().padStart(2,"0")+":"+t.m.toString().padStart(2,"0")).join(", ")}});this.$id("autoDowntimes").append(e),e.find('input[name$="after"]').select2({width:"400px",placeholder:this.t("autoDowntimes:when:after:placeholder"),data:n.filter(e=>e.id!==t.reason).map(d)}),this.toggleAutoDowntimeOptions(e)},toggleAutoDowntimeOptions:function(t){const e=t.find('select[name$="when"]').val(),i=t.find('input[name$="after"]'),a=t.find('input[name$="time"]');i.select2("container").toggleClass("hidden","after"!==e),a.toggleClass("hidden","time"!==e)}})});