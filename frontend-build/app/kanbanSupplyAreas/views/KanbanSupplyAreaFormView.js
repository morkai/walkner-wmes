define(["underscore","app/data/orgUnits","app/core/util/idAndLabel","app/core/views/FormView","../KanbanSupplyAreaCollection","app/kanbanSupplyAreas/templates/form"],function(e,t,n,i,s,r){"use strict";return i.extend({template:r,events:e.assign({"input #-name, #-workCenter":"checkUniqueness","click #-addLine":function(){this.addLine("-")},'click .btn[data-action="up"]':function(e){var t=this.$(e.currentTarget).closest("tr");t.prev().length&&(t.insertBefore(t.prev()),this.recountLines())},'click .btn[data-action="down"]':function(e){var t=this.$(e.currentTarget).closest("tr");t.next().length&&(t.insertAfter(t.next()),this.recountLines())},'click .btn[data-action="remove"]':function(e){this.$(e.currentTarget).closest("tr").remove(),this.recountLines()}},i.prototype.events),initialize:function(){i.prototype.initialize.apply(this,arguments),this.checkUniqueness=e.debounce(this.checkUniqueness.bind(this),500)},afterRender:function(){this.$lineRow=this.$id("lines").children().first().detach(),i.prototype.afterRender.apply(this,arguments);var s={};e.forEach(this.model.get("lines"),function(e){s[e]=!0}),this.prodLines=[{id:"-",text:this.t("lines:reserved")}].concat(t.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")||s[e.id]}).map(n)),this.options.editMode?this.model.get("lines").forEach(this.addLine,this):this.addLine("-"),this.$id("name").focus()},addLine:function(e){var t=this.$id("lines"),n=this.$lineRow.clone();n[0].children[0].textContent=t[0].childElementCount+1+".",n.find("input").val(e).select2({data:this.prodLines}),t.append(n)},recountLines:function(){this.$id("lines").children().each(function(e){this.children[0].textContent=e+1+"."})},serializeForm:function(e){return e.workCenter||(e.workCenter=""),e},checkUniqueness:function(){var e=this.$id("name"),t=this.$id("workCenter"),n="/kanban/supplyAreas?select(_id)&name=string:"+encodeURIComponent(e.val().trim())+"&workCenter=string:"+encodeURIComponent(t.val().trim());this.model.id&&(n+="&_id=ne="+this.model.id);var i=this.ajax({method:"GET",url:n});t[0].setCustomValidity(this.t("FORM:ERROR:alreadyExists")),i.done(function(e){0===e.totalCount&&t[0].setCustomValidity("")})}})});