// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/data/orgUnits","app/core/util/idAndLabel","app/core/views/FormView","../KanbanSupplyAreaCollection","app/kanbanSupplyAreas/templates/form"],function(e,t,n,i,r,s){"use strict";return i.extend({template:s,events:e.assign({"input #-name, #-workCenter":"checkUniqueness","click #-addLine":function(){this.addLine("-")},'click .btn[data-action="up"]':function(e){var t=this.$(e.currentTarget).closest("tr");t.prev().length&&(t.insertBefore(t.prev()),this.recountLines())},'click .btn[data-action="down"]':function(e){var t=this.$(e.currentTarget).closest("tr");t.next().length&&(t.insertAfter(t.next()),this.recountLines())},'click .btn[data-action="remove"]':function(e){this.$(e.currentTarget).closest("tr").remove(),this.recountLines()}},i.prototype.events),initialize:function(){i.prototype.initialize.apply(this,arguments),this.checkUniqueness=e.debounce(this.checkUniqueness.bind(this),500),this.prodLines=[{id:"-",text:this.t("lines:reserved")}].concat(t.getAllByType("prodLine").filter(function(e){return!e.get("deactivatedAt")}).map(n))},afterRender:function(){this.$lineRow=this.$id("lines").children().first().detach(),i.prototype.afterRender.apply(this,arguments),this.options.editMode?this.model.get("lines").forEach(this.addLine,this):this.addLine("-"),this.$id("name").focus()},addLine:function(e){var t=this.$id("lines"),n=this.$lineRow.clone();n[0].children[0].textContent=t[0].childElementCount+1+".",n.find("input").val(e).select2({data:this.prodLines}),t.append(n)},recountLines:function(){this.$id("lines").children().each(function(e){this.children[0].textContent=e+1+"."})},serializeForm:function(e){return e.workCenter||(e.workCenter=""),e},checkUniqueness:function(){var e=this,t=e.$id("name"),n=e.$id("workCenter"),i="/kanban/supplyAreas?select(_id)&name=string:"+encodeURIComponent(t.val().trim())+"&workCenter=string:"+encodeURIComponent(n.val().trim());e.model.id&&(i+="&_id=ne="+e.model.id);var r=e.ajax({method:"GET",url:i});n[0].setCustomValidity(e.t("FORM:ERROR:alreadyExists")),r.done(function(e){0===e.totalCount&&n[0].setCustomValidity("")})}})});