// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["../core/Collection","./KanbanSupplyArea"],function(e,t){"use strict";return e.extend({model:t,rqlQuery:"sort(name,workCenter)&limit(20)",initialize:function(){this.cached=null},setUpPubsub:function(e){e.subscribe("kanban.supplyAreas.*",this.handleMessage.bind(this))},getAsSelect2:function(e,t){var n={};return this.forEach(function(i){if(!t.length||-1!==t.indexOf(i.get("name"))){i.get(e).length&&(n[i.get(e)]=1)}}),Object.keys(n).sort().map(function(e){return{id:e,text:e}})},getNames:function(){return this.getAsSelect2("name",[])},getFamilies:function(e){return this.getAsSelect2("family",e)},getWorkCenters:function(e){return this.getAsSelect2("workCenter",e)},findByWorkCenters:function(e,t){var n=this.cache()[e];if(!n)return null;if(!t.length)return 1===n.list.length?n.list[0].sa:null;var i=[];return t.forEach(function(e){n.map[e]&&i.push(n.map[e])}),1===i.length?i[0]:null},handleMessage:function(e,t){var n=this.get(e.model._id);switch(this.cached=null,t){case"kanban.supplyAreas.deleted":this.remove(n);break;case"kanban.supplyAreas.added":case"kanban.supplyAreas.edited":n?n.set(e.model):this.add(e.model)}},cache:function(){if(null!==this.cached)return this.cached;var e=this.cached={};return this.forEach(function(t){var n=t.get("name"),i=t.get("workCenter");e[n]||(e[n]={map:{},list:[]}),e[n].map[i]=t,e[n].list.push({wc:i,sa:t})}),e}})});