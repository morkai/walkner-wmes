// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/user","app/viewport","app/core/pages/DetailsPage","app/core/util/pageActions","../dictionaries","../views/D8EntryDetailsView","../views/D8EntryHistoryView","app/d8Entries/templates/detailsPage"],function(e,t,i,s,n,o,r,d,a,l){"use strict";return n.extend({template:l,baseBreadcrumb:!0,localTopics:{"d8.entries.seen":"onSeen"},actions:function(){var e=[];this.model.isNotSeen()&&e.push({id:"markAsSeen",icon:"eye",label:t("d8Entries","PAGE_ACTION:markAsSeen"),callback:this.markAsSeen.bind(this)});var i=this.model.get("observer");return"subscriber"===i.role?e.push({id:"unobserve",icon:"eye-slash",label:t("d8Entries","PAGE_ACTION:unobserve"),callback:this.unobserve.bind(this)}):"viewer"===i.role&&e.push({id:"observe",icon:"eye",label:t("d8Entries","PAGE_ACTION:observe"),callback:this.observe.bind(this)}),e.push({id:"download",icon:"download",label:t("d8Entries","PAGE_ACTION:download"),callback:this.download.bind(this)}),this.model.canEdit()&&e.push(o.edit(this.model,!1)),this.model.canDelete()&&e.push(o["delete"](this.model,!1)),e},initialize:function(){n.prototype.initialize.apply(this,arguments),this.setView(".d8Entries-detailsPage-properties",this.detailsView),this.setView(".d8Entries-detailsPage-history",this.historyView)},destroy:function(){n.prototype.destroy.call(this),r.unload()},defineViews:function(){this.detailsView=new d({model:this.model}),this.historyView=new a({model:this.model})},load:function(e){return e(this.model.fetch(),r.load())},setUpLayout:function(e){this.listenTo(this.model,"reset change",function(){e.setActions(this.actions,this)})},afterRender:function(){n.prototype.afterRender.call(this),r.load()},markAsSeen:function(e){var i=e.currentTarget.querySelector(".btn");i.disabled=!0,this.socket.emit("d8.entries.markAsSeen",{_id:this.model.id},function(e){e&&(s.msg.show({type:"error",time:3e3,text:t("d8Entries","MSG:markAsSeen:failure")}),i.disabled=!1)})},observe:function(e){var i=e.currentTarget.querySelector(".btn");i.disabled=!0,this.socket.emit("d8.entries.observe",{_id:this.model.id,state:!0},function(e){e&&(s.msg.show({type:"error",time:3e3,text:t("d8Entries","MSG:observe:failure")}),i.disabled=!1)})},unobserve:function(e){var i=e.currentTarget.querySelector(".btn");i.disabled=!0,this.socket.emit("d8.entries.observe",{_id:this.model.id,state:!1},function(e){e&&(s.msg.show({type:"error",time:3e3,text:t("d8Entries","MSG:unobserve:failure")}),i.disabled=!1)})},download:function(){var e=this.model.get("attachment");return e?void(window.location.href="/d8/entries/"+this.model.id+"/attachments/"+e._id+"?download=1"):s.msg.show({type:"warning",time:3e3,text:t("d8Entries","MSG:noAttachment")})},onSeen:function(e){e===this.model.id&&this.model.markAsSeen()}})});