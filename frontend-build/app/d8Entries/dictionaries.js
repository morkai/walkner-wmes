// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../broker","../pubsub","../user","../d8Areas/D8AreaCollection","../d8EntrySources/D8EntrySourceCollection","../d8ProblemSources/D8ProblemSourceCollection"],function(e,r,n,u,l,o,t){"use strict";function s(e){["areas","entrySources","problemSources"].forEach(function(r){p[r].reset(e?e[r]:[])})}function a(){m&&(S=m.subscribe("d8.entries.seen."+u.data._id,d))}function c(){y=null,null!==m&&(m.destroy(),m=null,S=null),p.loaded=!1,p.statuses=[],s()}function i(e,n){var u=n.split("."),l=p[u[1]];if(l){switch(u[2]){case"added":l.add(e.model);break;case"edited":var o=l.get(e.model._id);o&&o.set(e.model);break;case"deleted":l.remove(l.get(e.model._id))}r.publish(n,e)}}function d(e){r.publish("d8.entries.seen",e.entryId)}var b={area:"areas",entrySource:"entrySources",problemSource:"problemSources"},f=null,y=null,m=null,S=null,p={statuses:[],areas:new l,entrySources:new o,problemSources:new t,loaded:!1,load:function(){return null!==y&&(clearTimeout(y),y=null),p.loaded?null:null!==f?f:(f=e.ajax({url:"/d8/dictionaries"}),f.done(function(e){p.loaded=!0,p.statuses=e.statuses,s(e)}),f.fail(c),f.always(function(){f=null}),m=n.sandbox(),m.subscribe("d8.areas.**",i),m.subscribe("d8.entrySources.**",i),m.subscribe("d8.problemSources.**",i),a(),f)},unload:function(){null!==y&&clearTimeout(y),y=setTimeout(c,3e4)},getLabel:function(e,r){if("string"==typeof e&&(e=this.forProperty(e)||p[e]),!e||Array.isArray(e))return r;var n=e.get(r);return n?n.getLabel():r},forProperty:function(e){return this[b[e]]||null}};return r.subscribe("user.reloaded",function(){S&&(S.cancel(),S=null),a()}),p});