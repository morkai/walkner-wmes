// Part of <http://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/user","app/core/util/buttonGroup","app/core/util/idAndLabel","app/core/views/FormView","app/users/util/setUpUserSelect2","app/d8Entries/dictionaries","../D8Entry","app/d8Entries/templates/form","app/d8Entries/templates/formStripRow"],function(t,e,i,r,s,a,n,o,d,l,p,u,c){"use strict";function m(t,e){return e}return o.extend({template:u,stripIndex:0,events:t.extend({"click #-addStrip":function(){this.addStrip({})},'click [data-action="removeStrip"]':function(t){this.$(t.target).closest("tr").remove()},'change [name="status"]':function(){this.toggleRequiredFlags()},'change [type="date"]':function(t){var a=r.getMoment(t.target.value,"YYYY-MM-DD"),n=a.isValid()?a.diff(new Date,"days"):0,o=Math.abs(n),d=this.$(t.target),l="TD"===d.parent()[0].tagName?d.parent():d.closest(".form-group"),p=l.find(".help-block");return 7>=o?(t.target.setCustomValidity(""),void p.remove()):(!s.isAllowedTo("D8:ALL")&&o>60&&t.target.setCustomValidity(i("d8Entries","FORM:ERROR:date",{days:60})),p.length||(p=e('<p class="help-block"></p>')),void p.text(i("d8Entries","FORM:help:date:diff",{dir:n>0?"future":"past",days:o})).appendTo(l))}},o.prototype.events),serialize:function(){return t.extend(o.prototype.serialize.call(this),{nextYear:r.getMoment().add(1,"year").format("YYYY-MM-DD"),statuses:l.statuses,hideOwnerFields:this.options.editMode&&!this.model.isOwner()&&!s.isAllowedTo("D8:ALL")})},checkValidity:function(){return!0},submitRequest:function(t,e){var r=this,s=new FormData,a=r.$('input[type="file"]')[0];if(!a.files.length)return o.prototype.submitRequest.call(r,t,e);s.append("attachment",a.files[0]),this.$el.addClass("is-uploading");var n=r.ajax({type:"POST",url:"/d8/entries;upload",data:s,processData:!1,contentType:!1});n.done(function(i){e.attachment=i,o.prototype.submitRequest.call(r,t,e)}),n.fail(function(){r.showErrorMessage(i("d8Entries","FORM:ERROR:upload")),t.attr("disabled",!1)}),n.always(function(){r.$el.removeClass("is-uploading")})},serializeToForm:function(){var e=this.model.toJSON();return p.DATE_PROPERTIES.forEach(function(t){e[t]&&(e[t]=r.format(e[t],"YYYY-MM-DD"))}),e.strips=t.map(e.strips,function(t){return{no:t.no,date:t.date?r.format(t.date,"YYYY-MM-DD"):"",family:t.family}}),e.subscribers="",e},serializeForm:function(e){var i=this.$id("owner");if(i.length){var s=i.select2("data");e.owner=s?{id:s.id,label:s.text}:null,e.members=this.$id("members").select2("data").map(function(t){return{id:t.id,label:t.text}}).filter(function(t){return!!t.id})}return e.subscribers=this.$id("subscribers").select2("data").map(function(t){return{id:t.id,label:t.text}}),e.strips=t.map(e.strips,function(t){return{no:t.no||"",date:t.date?r.getMoment(t.date,"YYYY-MM-DD").toISOString():null,family:t.family||""}}),p.DATE_PROPERTIES.forEach(function(t){var i=r.getMoment(e[t],"YYYY-MM-DD");e[t]=i.isValid()?i.toISOString():null}),delete e.attachment,e},afterRender:function(){o.prototype.afterRender.call(this),this.$id("division").select2({data:l.divisions.map(function(t){return{id:t.id,text:t.id+" - "+t.get("description")}})}),this.$id("entrySource").select2({data:l.entrySources.map(n)}),this.$id("problemSource").select2({data:l.problemSources.map(n)}),a.toggle(this.$id("status")),d(this.$id("subscribers"),{multiple:!0,textFormatter:m}),this.setUpOwnerSelect2(),this.setUpMembersSelect2(),this.setUpStrips()},setUpOwnerSelect2:function(){var t=this.model.get("owner"),e=d(this.$id("owner"),{textFormatter:m});t&&e.select2("data",{id:t.id,text:t.label})},setUpMembersSelect2:function(){var t=this.options.editMode,e=this.model,i=[];if(t){var r=e.get("members");Array.isArray(r)&&r.length&&(i=r.map(function(t){return{id:t.id,text:t.label}}))}d(this.$id("members"),{multiple:!0,textFormatter:m}).select2("data",i)},setUpStrips:function(){this.options.editMode?t.forEach(this.model.get("strips"),this.addStrip,this):this.addStrip({})},toggleRequiredFlags:function(){var t="closed"===a.getValue(this.$id("status"));this.$id("d8CloseDate").prop("required",t).closest(".form-group").find(".control-label").toggleClass("is-required",t)},addStrip:function(t){this.$id("strips").append(c({i:this.stripIndex++,strip:{no:t.no||"",date:t.date?r.format(t.date,"YYYY-MM-DD"):"",family:t.family||""}}))}})});