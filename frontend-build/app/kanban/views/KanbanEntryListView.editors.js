define(["jquery","app/core/util/idAndLabel","app/planning/util/contextMenu","../KanbanSettingCollection","app/kanban/templates/editors/input","app/kanban/templates/editors/select","app/kanban/templates/editors/textArea"],function(e,t,n,i,o,r,d){"use strict";return{editors:{input:function(t,n,i,r){var d=this,l=t.model.serialize(d.model);function a(){d.$id("editor-backdrop").remove(),d.$id("editor-form").remove(),d.afterEdit()}e(document.body).append(o({idPrefix:d.idPrefix,columnId:t.columnId,maxLength:n,pattern:i,placeholder:r,value:t.column.editorValue(t.arrayIndex>=0?l[t.columnId][t.arrayIndex]:l[t.columnId],t.column,t.arrayIndex,l)})),d.$id("editor-backdrop").one("click",a),d.$id("editor-form").on("submit",function(){var e=t.column.parseValue(d.$id("editor-input").val(),t.column,t.arrayIndex,t.model.serialize(d.model));return d.handleEditorValue(t.modelId,t.columnId,t.arrayIndex,e),a(),!1}),d.$id("editor-input").on("blur",a).on("keydown",function(e){"Escape"===e.originalEvent.key&&a()}).select(),d.editorPositioners.input.call(d,t)},select:function(t,n,i,o){var d=this,l=Number.MAX_VALUE;function a(){var e=t.column.parseValue(d.$id("editor-input").val(),t.column,t.arrayIndex,t.model.serialize(d.model));return d.handleEditorValue(t.modelId,t.columnId,t.arrayIndex,e),c(),!1}function c(){d.$id("editor-backdrop").remove(),d.$id("editor-form").remove(),d.afterEdit()}e(document.body).append(r({idPrefix:d.idPrefix,columnId:t.columnId,multiple:n,options:i.map(function(e){return e.selected=-1!==o.indexOf(e.id),e})})),d.$id("editor-backdrop").one("click",c),d.$id("editor-form").on("submit",a),d.$id("editor-input").on("blur",c).on("keydown",function(e){"Escape"===e.originalEvent.key?c():"Enter"===e.originalEvent.key&&a()}).on("click",function(){var e=Date.now()-l;e>=0&&e<50&&a()}).on("change",function(){l=Date.now()}).focus(),d.editorPositioners.input.call(d,t)},textArea:function(t){var n=this,i=t.model.serialize(n.model);e(document.body).append(d({idPrefix:n.idPrefix,columnId:t.columnId,value:t.column.editorValue(t.arrayIndex>=0?i[t.columnId][t.arrayIndex]:i[t.columnId],t.column,t.arrayIndex,i)})),n.$id("editor-backdrop").one("click",r);var o=n.$id("editor-input").on("blur",r).on("keydown",function(e){if("Enter"===e.key){if(e.shiftKey||e.ctrlKey||e.altKey){var i=n.$id("editor-input")[0],o=i.selectionStart;return i.value=i.value.substring(0,o)+"\n"+i.value.substring(i.selectionEnd),i.selectionStart=o+1,i.selectionEnd=o+1,!1}return d=t.column.parseValue(n.$id("editor-input").val(),t.column,t.arrayIndex,t.model.serialize(n.model)),n.handleEditorValue(t.modelId,t.columnId,t.arrayIndex,d),r(),!1}var d;"Escape"===e.key&&r()})[0];function r(){n.$id("editor-backdrop").remove(),n.$id("editor-form").remove(),n.afterEdit()}o.selectionStart=o.value.length,o.selectionEnd=o.value.length,o.focus(),n.editorPositioners.textArea.call(n,t)},kind:function(e){var t=this,i=e.td.getBoundingClientRect(),o=e.model.get("kind"),r=[];["kk","pk",null].forEach(function(n){r.push({label:t.t("kind:"+n),handler:t.handleEditorValue.bind(t,e.modelId,e.columnId,e.arrayIndex,n),disabled:o===n})}),n.show(t,i.top,i.left,r),t.broker.subscribe("planning.contextMenu.hidden",t.afterEdit.bind(t)).setLimit(1)},container:function(e){var n=[{id:null,text:this.t("container:null")}].concat(this.model.containers.map(t)),i=[e.model.get("container")];this.editors.select.call(this,e,!1,n,i)},workCenter:function(e){var t=[e.model.get("supplyArea")],n=[{id:"",text:this.t("workCenter:null")}].concat(this.model.supplyAreas.getWorkCenters(t)),i=[e.model.get("workCenter")];this.editors.select.call(this,e,!1,n,i)},discontinued:function(e){this.handleEditorValue(e.modelId,e.columnId,e.arrayIndex,!e.model.get("discontinued")),this.afterEdit()},componentQtyJit:function(e){this.editors.input.call(this,e,"99999.99".length,"^[0-9]{1,5}([,.][0-9]{1,2})?$")},workstations:function(e){this.editors.input.call(this,e,3,"^([0-9]|[1-9][0-9]|[0-9](.|,)5)$")},locations:function(e){this.editors.input.call(this,e,3,"^[A-Za-z]([0-9][0-9])$","X00")},comment:function(e){this.editors.textArea.call(this,e)},markerColor:function(e){var t=e.model.serialize(this.model),n=[{id:"",text:this.t("color:null")}].concat(i.getMarkerColors()),o=[t[e.columnId]||""];this.editors.select.call(this,e,!1,n,o)}},positioners:{contextMenu:function(e){var t=this.resolveCell(e);if(t){var i=t.td.getBoundingClientRect();n.position(this,i.top,i.left)}},input:function(e){var t=this.resolveCell(e);if(t){var n=t.td.getBoundingClientRect();this.$id("editor-form").css({top:n.top+"px",left:n.left+"px"})}},textArea:function(e){var t=this.resolveCell(e);if(t){var n=t.td.getBoundingClientRect(),i=n.top,o=n.left,r=this.$id("editor-input").outerHeight();i+r>=window.innerHeight-15&&(i+=window.innerHeight-(i+r)-15),o+n.width>=window.innerWidth-15&&(o+=window.innerWidth-(o+n.width)-15),this.$id("editor-form").css({top:i+"px",left:o+"px"})}},kind:"contextMenu",componentQtyJit:"input",workstations:"input",locations:"input",comment:"textArea"}}});