// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/planning/util/contextMenu","app/kanban/templates/entryList","app/kanban/templates/entryListColumns","app/kanban/templates/entryListRow"],function(e,n,t,l,i,o,d){"use strict";return t.extend({template:i,events:{contextmenu:function(){return!1},mousedown:function(e){if(1!==e.which)return!1},"dblclick .kanban-td":function(){return!1},"focus .kanban-td":function(e){var n=this.idCell(e);if(void 0!==n.value){if(this.focusedCell){if(n.td===this.focusedCell.td)return;this.focusedCell.td.classList.remove("kanban-is-focused"),this.focusedCell.tr.classList.remove("kanban-is-selected")}n.td.classList.add("kanban-is-focused"),n.tr.classList.add("kanban-is-selected"),this.focusedCell=n}},"click .kanban-is-editable":function(e){this.showCellEditor(this.idCell(e))},"click .kanban-is-with-menu":function(e){this.showColumnMenu(this.idCell(e),e.pageY,e.pageX)}},initialize:function(){this.focusedCell=null,this.listenTo(this.model.tableView,"change:filter change:order",this.onSortableChange),this.listenTo(this.model.tableView,"change:visibility",this.onVisibilityChange),this.listenTo(this.model.entries,"filter",this.onFilter),this.listenTo(this.model.entries,"sort",this.onSort),n(window).on("resize."+this.idPrefix,e.debounce(this.resize.bind(this),8)).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){n(window).off("."+this.idPrefix)},getTemplateData:function(){return{height:this.calcHeight()}},afterRender:function(){var e=this;e.$theadInner=e.$(".kanban-thead-innerContainer").on("scroll",e.onTheadScroll.bind(e)),e.$tbodyInner=e.$(".kanban-tbody-innerContainer").on("scroll",e.onTbodyScroll.bind(e)),e.$tbodyOuter=e.$(".kanban-tbody-outerContainer"),e.$scroller=e.$(".kanban-tbody-scroller"),e.$thead=e.$(".kanban-thead-table"),e.$table=e.$(".kanban-tbody-table"),e.$tbody=e.$(".kanban-tbody-tbody"),e.oldScrollTop=0,e.rowCache=null,e.afterRenderRows=null,e.renderColumns(),e.renderRows()},renderColumns:function(){this.$thead&&(this.columns=this.model.tableView.serializeColumns(),this.$thead.html(o({idPrefix:this.idPrefix,columns:this.columns})))},renderRow:function(e,t){var l=this;return l.rowCache[e.id]||(l.rowCache[e.id]=n.parseHTML(d({idPrefix:l.idPrefix,modelIndex:t,columns:l.columns,entry:e.serialize(l.model)}))[0]),l.rowCache[e.id]},renderRows:function(){var e=this;if(e.$tbody){var n=e.model.entries.filtered,t=e.$tbody[0],l=e.$tbodyOuter.outerHeight()-17,i=Math.ceil(l/25),o=e.$tbodyInner[0].scrollTop,d=Math.max(0,Math.floor(o/25)),r=d+i,s=r-1,a=-1,c=-1;t.childElementCount&&(a=+t.firstElementChild.dataset.modelIndex,c=+t.lastElementChild.dataset.modelIndex);var u=e.model.entries.filtered.length,h=25*(u+1),f=null;if(null===e.rowCache)e.rowCache={};else if(d>a&&s>c&&d<c-5)f="down";else if(d<a&&s<c&&s>a+5)f="up";else if(d===a&&s===c)return e.finalizeRenderRows();var m=document.createDocumentFragment();e.$table.css("top",o+"px"),e.$scroller.css("height",h+"px");var b,w,C,p,y,I;if("down"===f){for(w=d-a,b=s-c,C=1;C<=b;++C)y=c+C,(I=n[y])&&m.appendChild(e.renderRow(I,y));for(t.appendChild(m),p=0;p<w;++p)t.removeChild(t.firstElementChild)}else if("up"===f){for(w=c-s,b=a-d,C=0;C<b;++C)y=d+C,(I=n[y])&&m.appendChild(e.renderRow(I,y));for(t.insertBefore(m,t.firstElementChild),p=0;p<w;++p)t.removeChild(t.lastElementChild)}else{var v=n.slice(d,r);v.forEach(function(n,t){m.appendChild(e.renderRow(n,d+t))}),t.innerHTML="",t.appendChild(m)}e.finalizeRenderRows()}},renderRowsUp:function(){},finalizeRenderRows:function(){var e=this,n=e.$tbody;if(e.afterRenderRows)e.afterRenderRows.call(e),e.afterRenderRows=null;else if(e.focusedCell){var t=e.focusedCell.model.id,l=e.focusedCell.columnId,i=e.focusedCell.arrayIndex,o=n.find('tr[data-model-id="'+t+'"]'),d='td[data-column-id="'+l+'"]';i>=0&&(d+='[data-array-index="'+i+'"]');var r=o.find(d);r[0]!==document.activeElement&&r.focus()}else n[0].childElementCount&&n[0].children[0].children[0].focus()},calcHeight:function(){return window.innerHeight-(this.el.offsetTop||102)-15},resize:function(){var e=this.calcHeight();this.el.style.height=e+"px",this.$tbodyOuter[0].style.height=e-148+"px",this.renderRows()},idCell:function(e){var n=e.currentTarget,t=n.parentNode,l=t.dataset.modelId,i=n.dataset.columnId,o=parseInt(n.dataset.arrayIndex,10),d=this.model.entries.get(l),r=d?d.serialize(this.model):{},s=r[i];return s&&o>=0&&(s=s[o]),{td:n,tr:t,columnId:i,rowIndex:t.rowIndex,arrayIndex:o,modelIndex:parseInt(t.dataset.modelIndex,10),model:d,data:r,value:s}},showColumnMenu:function(e,n,t){var i=this,o=i.$theadInner.find('td[data-column-id="'+e.columnId+'"]');if(!n&&!t){var d=o[0].getBoundingClientRect();n=d.top+d.height,t=d.left}var r=i.columns.map[e.columnId],s=i.model.tableView,a=s.getSortOrder(e.columnId),c={menu:[s.getColumnText(e.columnId),{icon:"fa-sort-amount-asc",label:i.t("menu:sort:asc"),handler:i.handleSort.bind(i,e.columnId,1),disabled:!r.sortable||1===a},{icon:"fa-sort-amount-desc",label:i.t("menu:sort:desc"),handler:i.handleSort.bind(i,e.columnId,-1),disabled:!r.sortable||-1===a},"-",{icon:"fa-eye",label:i.t("menu:show"),handler:i.handleShowColumns.bind(i),disabled:!s.hasAnyHiddenColumn()},{icon:"fa-eye-slash",label:i.t("menu:hide"),handler:i.handleHideColumn.bind(i,e.columnId),disabled:"_id"===e.columnId},"-",{icon:"fa-filter",label:i.t("menu:filter:clear"),handler:i.handleClearFilter.bind(i),disabled:!s.hasAnyFilter()},{label:i.t("menu:filter:and"),handler:i.handleFilterMode.bind(i,"and"),disabled:"and"===s.getFilterMode()},{label:i.t("menu:filter:or"),handler:i.handleFilterMode.bind(i,"or"),disabled:"or"===s.getFilterMode()}]};l.show(i,n,t,c)},showCellEditor:function(e){},handleFilterMode:function(e){this.model.tableView.setFilterMode(e)},handleClearFilter:function(){this.model.tableView.clearFilters()},handleSort:function(e,n){this.model.tableView.setSortOrder(e,n)},showColumnVisibilityMenu:function(e){var n=this,t={animate:!1,menu:[n.t("menu:show")].concat(n.model.tableView.getHiddenColumns().map(function(t){return{label:n.model.tableView.getColumnText(t),handler:n.handleShowColumn.bind(n,t,e)}}))};this.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){l.show(n,e.top-5,e.left-1,t)})},handleShowColumns:function(e){this.showColumnVisibilityMenu(e.currentTarget.getBoundingClientRect())},handleShowColumn:function(e,n){this.model.tableView.setVisibility(e,!0),this.model.tableView.hasAnyHiddenColumn()&&this.showColumnVisibilityMenu(n)},handleHideColumn:function(e){this.model.tableView.setVisibility(e,!1)},clearCache:function(){this.rowCache=null},onFilter:function(){this.$tbodyInner},onSort:function(){var e=this;if(e.$tbodyInner){e.clearCache();var n=e.$tbodyInner[0],t=e.model.entries,l=e.focusedCell?t.filteredMap[e.focusedCell.model.id]:null,i=e.$tbodyOuter.outerHeight()-17;if(l){var o=t.filtered.indexOf(l),d=25*o;d>=n.scrollTop&&d<n.scrollTop+i-50?e.renderRows():n.scrollTop=d}else e.focusedCell=null,0===n.scrollTop?e.renderRows():n.scrollTop=0}},onSortableChange:function(e,n){this.renderColumns()},onVisibilityChange:function(e,n){if(this.focusedCell&&n===this.focusedCell.columnId&&!this.model.tableView.getVisibility(n)){var t=this.focusedCell.td;do{t=t.previousElementSibling}while(t&&t.dataset.columnId===n);t&&(t.parentNode.parentNode?t.focus():this.focusedCell=this.idCell({currentTarget:t}))}this.clearCache(),this.renderColumns(),this.renderRows()},onTheadScroll:function(){this.$tbodyInner[0].scrollLeft=this.$theadInner[0].scrollLeft},onTbodyScroll:function(){this.$theadInner[0].scrollLeft=this.$tbodyInner[0].scrollLeft;var e=this.$tbodyInner[0].scrollTop;this.oldScrollTop!==e&&(this.oldScrollTop=e,this.renderRows())},onWindowKeyDown:function(e){var n=e.target.tagName;"INPUT"!==n&&"SELECT"!==n&&"TEXTAREA"!==n&&(this.focusedCell||this.$tbody.find("tr:first-child > td:first-child").focus(),this.handleTdKeyDown(e,this.focusedCell))},handleTdKeyDown:function(e,n){var t=e.originalEvent.key;this.keyHandlers[t]&&(this.keyHandlers[t].call(this,e,n),e.preventDefault())},keyHandlers:{ArrowUp:function(e,n){var t=this;if(0===n.modelIndex)return void(n.tr.parentNode||(t.$tbodyInner[0].scrollTop=0));var l=n.tr.previousElementSibling;if(l)return void l.cells[n.td.cellIndex].focus();t.afterRenderRows=function(e,n){var l=t.$table.find('tr[data-model-index="'+e+'"]')[0];l&&l.cells[n]&&l.cells[n].focus()}.bind(null,n.modelIndex-1,n.td.cellIndex),n.tr.parentNode?t.$tbodyInner[0].scrollTop-=25:t.$tbodyInner[0].scrollTop=25*n.modelIndex-25},ArrowDown:function(e,n){var t=this,l=n.tr.nextElementSibling;if(n.modelIndex===t.model.entries.filtered.length-1)return void(n.tr.parentNode||(t.$tbodyInner[0].scrollTop=t.$tbodyInner[0].scrollHeight));if(n.tr.parentNode&&n.tr.rowIndex<n.tr.parentNode.childElementCount-1){if(l.offsetTop+l.offsetHeight<=t.$tbodyInner[0].offsetHeight-17)return void l.cells[n.td.cellIndex].focus()}t.afterRenderRows=function(e,n){var l=t.$table.find('tr[data-model-index="'+e+'"]')[0];l&&l.cells[n]&&l.cells[n].focus()}.bind(null,n.modelIndex+1,n.td.cellIndex),n.tr.parentNode?t.$tbodyInner[0].scrollTop+=25*(l?1:2):t.$tbodyInner[0].scrollTop=25*n.modelIndex+25},ArrowRight:function(e,n){var t=n.td.nextElementSibling;if(n.tr.parentNode)return void("filler"!==t.dataset.columnId&&t.focus());var l=this;l.afterRenderRows=function(e,n){var t=l.$table.find('tr[data-model-index="'+e+'"]')[0];if(t){var i=t.cells[n];"filler"===i.dataset.columnId?i.previousElementSibling.focus():i.focus()}}.bind(null,n.modelIndex,n.td.cellIndex+1),l.$tbodyInner[0].scrollTop=25*n.modelIndex},ArrowLeft:function(e,n){var t=n.td.previousElementSibling;if(n.tr.parentNode)return void(t&&t.focus());var l=this;l.afterRenderRows=function(e,n){var t=l.$table.find('tr[data-model-index="'+e+'"]')[0];t&&t.cells[Math.max(0,n)].focus()}.bind(null,n.modelIndex,n.td.cellIndex-1),l.$tbodyInner[0].scrollTop=25*n.modelIndex},Tab:function(e,n){},PageUp:function(e,n){},PageDown:function(e,n){},Home:function(e,n){},End:function(e,n){},Escape:function(){l.hide(this)}}})});