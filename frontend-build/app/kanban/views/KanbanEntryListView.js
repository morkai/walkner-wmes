define(["underscore","jquery","app/user","app/viewport","app/core/View","app/core/util/pageActions","app/data/clipboard","app/planning/util/contextMenu","app/orders/OrderCollection","app/pfepEntries/PfepEntryCollection","./KanbanEntryListView.keyHandlers","./KanbanEntryListView.filters","./KanbanEntryListView.editors","./SplitEntryDialogView","app/kanban/templates/entryList","app/kanban/templates/entryListColumns","app/kanban/templates/entryListRow"],function(e,t,n,i,l,o,a,d,r,s,h,c,u,f,m,p,b){"use strict";return l.extend({ROW_HEIGHT:25,SCROLLBAR_HEIGHT:17,template:m,filters:c,keyHandlers:h,editors:u.editors,editorPositioners:u.positioners,localTopics:{"planning.contextMenu.hiding":function(e){e.$menu.find('[aria-describedby^="popover"]').popover("destroy")}},events:{contextmenu:function(){return!1},"contextmenu .kanban-td":function(e){return e.currentTarget.classList.contains("kanban-is-with-menu")?this.showColumnMenu(this.idCell(e),e.pageY,e.pageX):this.showCellMenu(this.idCell(e),e.pageY,e.pageX),!1},mousedown:function(e){if(1!==e.which)return!1},"click .kanban-td":function(e){e.ctrlKey&&this.handleQueuePrint(e.currentTarget.parentNode.dataset.modelId)},"dblclick .kanban-td":function(){return!1},"focus .kanban-td":function(e){var t=this.idCell(e);if(void 0!==t.value){var n=this.focusedCell;n&&n.modelId===t.modelId&&n.columnId===t.columnId&&n.arrayIndex===t.arrayIndex&&(t.clicks=n.clicks),this.focusedCell=t,this.focusCell()}},"click .kanban-is-editable":function(e){if(!e.shiftKey&&!e.ctrlKey){var t=this.idCell(e);if(e.altKey)return t.column.handleAltClick&&t.column.handleAltClick(t),!1;this.focusedCell&&this.focusedCell.td===e.currentTarget||(this.focusedCell=t),this.focusedCell.clicks+=1,this.focusedCell.clicks>1&&this.showCellEditor(this.focusedCell)}},"click .kanban-is-with-menu":function(e){e.shiftKey||e.ctrlKey||e.altKey||this.showColumnMenu(this.idCell(e),e.pageY,e.pageX)},"mouseenter .kanban-td":function(e){this.$(".kanban-is-hovered").removeClass("kanban-is-hovered");var t=e.currentTarget,n='.kanban-td[data-column-id="'+t.dataset.columnId+'"]';t.dataset.arrayIndex&&(n+='[data-array-index="'+t.dataset.arrayIndex+'"]'),this.hovered=n,this.$(n).addClass("kanban-is-hovered");var i=this.columns.map[t.dataset.columnId];i&&t.parentNode.dataset.modelId&&(i.expand>=0?this.expandTdValue(t):i.popover&&this.showTdPopover(t))},"mouseleave .kanban-td":function(){this.hovered=null,this.$(".kanban-is-hovered").removeClass("kanban-is-hovered"),this.collapseTdValue(),this.hideTdPopover()}},initialize:function(){this.editing=null,this.focusedCell=null,this.prevFocusedCell=null,this.lastKeyPressAt={},this.listenTo(this.model.tableView,"change:filter change:order",this.onSortableChange),this.listenTo(this.model.tableView,"change:visibility",this.onVisibilityChange),this.listenTo(this.model.entries,"filter",this.onFilter),this.listenTo(this.model.entries,"sort",this.onSort),this.listenTo(this.model.entries,"change",this.onEntryChange),t(window).on("resize."+this.idPrefix,e.debounce(this.resize.bind(this),8)).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},getTemplateData:function(){return{height:this.calcHeight()}},afterRender:function(){this.$theadInner=this.$(".kanban-thead-innerContainer").on("scroll",this.onTheadScroll.bind(this)),this.$tbodyInner=this.$(".kanban-tbody-innerContainer").on("scroll",this.onTbodyScroll.bind(this)),this.$tbodyOuter=this.$(".kanban-tbody-outerContainer"),this.$scroller=this.$(".kanban-tbody-scroller"),this.$thead=this.$(".kanban-thead-table"),this.$table=this.$(".kanban-tbody-table"),this.$tbody=this.$(".kanban-tbody-tbody"),this.oldScrollTop=0,this.rowCache=null,this.afterRenderRows=null,this.editing=null,this.renderColumns(),this.renderRows()},renderColumns:function(){this.$thead&&(this.columns=this.model.tableView.serializeColumns(),this.$thead.html(p({idPrefix:this.idPrefix,columns:this.columns})))},renderRow:function(e,n){var i=this.rowCache[e.id];if(i){i.classList.remove("kanban-is-selected");for(var l=i.querySelectorAll(".kanban-is-hovered, .kanban-is-selected"),o=0;o<l.length;++o)l[o].classList.remove("kanban-is-hovered","kanban-is-selected")}else i=this.rowCache[e.id]=t.parseHTML(b({idPrefix:this.idPrefix,modelIndex:n,columns:this.columns,entry:e.serialize(this.model)}))[0];return this.hovered&&i.querySelector(this.hovered).classList.add("kanban-is-hovered"),this.rowCache[e.id]},renderRows:function(e,t){var n=this;if(n.$tbody){"number"!=typeof e&&(e=-1),"number"!=typeof t&&(t=-1);var i=n.model.entries.filtered,l=n.$tbody[0],o=n.$tbodyOuter.outerHeight()-n.SCROLLBAR_HEIGHT,a=Math.ceil(o/n.ROW_HEIGHT),d=n.model.entries.filtered.length,r=n.ROW_HEIGHT*(d+1),s=n.$tbodyInner[0].scrollTop;t>=0&&((e=t*n.ROW_HEIGHT)>=s&&e<s+o-2*n.ROW_HEIGHT?e=-1:(t+a)*n.ROW_HEIGHT>=r&&(e=r-a*n.ROW_HEIGHT)),e>=0&&(s=e);var h=Math.max(0,Math.floor(s/n.ROW_HEIGHT)),c=h+a,u=c-1,f=-1,m=-1;l.childElementCount&&(f=+l.firstElementChild.dataset.modelIndex,m=+l.lastElementChild.dataset.modelIndex);var p=null;if(null===n.rowCache?n.rowCache={}:h>f&&u>m&&h<m-5?p="down":h<f&&u<m&&u>f+5?p="up":h===f&&u===m&&(p="same"),n.$table.css("top",s+"px"),n.$scroller.css("height",r+"px"),e>=0&&(n.$tbodyInner[0].scrollTop=s),"same"===p)return n.finalizeRenderRows();var b,g,C,y,w,v,x=document.createDocumentFragment();if("down"===p){for(g=h-f,b=u-m,C=1;C<=b;++C)(v=i[w=m+C])&&x.appendChild(n.renderRow(v,w));for(l.appendChild(x),y=0;y<g;++y)l.removeChild(l.firstElementChild)}else if("up"===p){for(g=m-u,b=f-h,C=0;C<b;++C)(v=i[w=h+C])&&x.appendChild(n.renderRow(v,w));for(l.insertBefore(x,l.firstElementChild),y=0;y<g;++y)l.removeChild(l.lastElementChild)}else{i.slice(h,c).forEach(function(e,t){x.appendChild(n.renderRow(e,h+t))}),l.innerHTML="",l.appendChild(x)}n.finalizeRenderRows()}},finalizeRenderRows:function(){var e=this.$tbody;if(this.afterRenderRows)this.afterRenderRows.call(this),this.afterRenderRows=null,this.focusCell();else if(this.focusedCell){var t=this.focusedCell.modelId,n=this.focusedCell.columnId,i=this.focusedCell.arrayIndex,l=e.find('tr[data-model-id="'+t+'"]');if(l.length){var o='td[data-column-id="'+n+'"]';i>=0&&(o+='[data-array-index="'+i+'"]');var a=l.find(o);a[0]===document.activeElement?this.focusCell():document.hasFocus()?a.focus():this.focusCell()}else this.focusCell()}else if(e[0].childElementCount)if(this.prevFocusedCell){var d=this.prevFocusedCell.modelIndex,r=+e[0].firstElementChild.dataset.modelIndex,s=+e[0].lastElementChild.dataset.modelIndex;this.prevFocusedCell.modelIndex<r?d=r:this.prevFocusedCell.modelIndex>s&&(d=s);var h=e.find('tr[data-model-index="'+d+'"]'),c=h.find('td[data-column-id="'+this.prevFocusedCell.columnId+'"]');c.length?c.focus():h[0].children[0].focus()}else e[0].children[0].children[0].focus();if(this.editing){var u=this.editorPositioners[this.editing.columnId];"string"==typeof u&&(u=this.editorPositioners[u]),u&&u.call(this,this.editing)}},calcHeight:function(){return window.innerHeight-(this.el.offsetTop||102)-15},resize:function(){if(this.$tbodyOuter&&this.$tbodyOuter.length){var e=this.calcHeight();this.el.style.height=e+"px",this.$tbodyOuter[0].style.height=e-148+"px",this.renderRows()}},idCell:function(e){var t=e.currentTarget,n=t.parentNode,i=n.dataset.modelId,l=t.dataset.columnId,o=parseInt(t.dataset.arrayIndex,10),a=this.model.entries.get(i),d=a?a.serialize(this.model):{},r=d[l];return isNaN(o)&&(o=-1),r&&o>=0&&(r=r[o]),{td:t,tr:n,columnId:l,column:this.columns.map[l],rowIndex:n.rowIndex,arrayIndex:o,modelIndex:parseInt(n.dataset.modelIndex,10),modelId:i,model:a,data:d,value:r,clicks:e.clicks||0}},resolveCell:function(e){if(!this.$tbody)return null;if(e.tr.parentNode)return e;var t=this.$tbody.find('tr[data-model-id="'+e.modelId+'"] > td[data-column-id="'+e.columnId+'"]');return t.length?this.idCell({currentTarget:t[0],clicks:e.clicks}):null},showColumnMenu:function(t,n,i){var l=this,o=l.$theadInner.find('td[data-column-id="'+t.columnId+'"]');if(!n&&!i){var a=o[0].getBoundingClientRect();n=a.top+a.height,i=a.left}var r=t.column,s=l.model.tableView,h=s.getSortOrder(t.columnId),c={menu:[s.getColumnText(t.columnId),{icon:"fa-sort-amount-asc",label:l.t("menu:sort:asc"),handler:l.handleSort.bind(l,t.columnId,1),disabled:!r.sortable||1===h},{icon:"fa-sort-amount-desc",label:l.t("menu:sort:desc"),handler:l.handleSort.bind(l,t.columnId,-1),disabled:!r.sortable||-1===h},"-",{icon:"fa-eye",label:l.t("menu:show"),handler:l.handleShowColumns.bind(l),disabled:!s.hasAnyHiddenColumn()},{icon:"fa-eye-slash",label:l.t("menu:hide"),handler:l.handleHideColumn.bind(l,t.columnId),disabled:"_id"===t.columnId},"-",{icon:"fa-filter",label:l.t("menu:filter:clear"),handler:l.handleClearFilter.bind(l),disabled:!s.hasAnyFilter()},{label:l.t("menu:filter:and"),handler:l.handleFilterMode.bind(l,"and"),disabled:"and"===s.getFilterMode()},{label:l.t("menu:filter:or"),handler:l.handleFilterMode.bind(l,"or"),disabled:"or"===s.getFilterMode()}]};e.forEach(r.filters,function(e,n){c.menu.push({label:l.t("filters:"+n),handler:l.handleFilterValue.bind(l,t.columnId,"eval",e)})});var u=l.filters[t.columnId];"string"==typeof u&&(u=l.filters[u]),u&&c.menu.push({template:function(e){return e.columnId=t.columnId,u.template(e)},handler:function(e){u.handler.call(l,t,e),e.find(".kanban-filter-help").popover({container:"body",trigger:"hover",placement:"auto bottom",html:!0,title:l.t("filters:help:title:"+u.type),content:l.t("filters:help:content:"+u.type),css:{maxWidth:"375px"}})}}),d.show(l,n,i,c)},showCellMenu:function(e,t,l){if(e.model){var o=this,a={menu:[{icon:"fa-download",label:o.t("menu:export"),handler:o.handleExportTable.bind(o)},{icon:"fa-clipboard",label:o.t("menu:copy:table"),handler:o.handleCopyTable.bind(o)},{label:o.t("menu:copy:row"),handler:o.handleCopyRow.bind(o,e.modelId)},{label:o.t("menu:copy:cell"),handler:o.handleCopyCell.bind(o,e.modelId,e.columnId,e.arrayIndex)}]};if("_id"===e.column._id&&!/[a-z]$/.test(e.modelId)&&n.isAllowedTo("KANBAN:MANAGE","FN:process-engineer")&&a.menu.push({icon:"fa-chain-broken",label:o.t("menu:split"),handler:o.handleSplitEntry.bind(o,e.modelId)}),e.model.get("discontinued")||a.menu.unshift({icon:"fa-print",label:o.t("menu:queuePrint"),handler:o.handleQueuePrint.bind(o,e.modelId)}),"container"===e.column._id){var h=this.model.containers.get(e.model.get("container"));h&&h.get("image")&&a.menu.unshift({icon:"fa-image",label:o.t("menu:containerImage"),handler:function(){e.column.handleAltClick(e)}})}e.td.classList.contains("kanban-is-editable")&&a.menu.unshift({icon:"fa-pencil",label:o.t("menu:edit"),handler:function(){o.broker.subscribe("planning.contextMenu.hidden",o.showCellEditor.bind(o,o.focusedCell)).setLimit(1)}});var c=[];if("nc12"===e.columnId&&(n.isAllowedTo("PFEP:VIEW")&&c.push({label:o.t("menu:nc12:pfep"),handler:function(){var t=new s;t.rqlQuery.selector.args=[{name:"eq",args:["nc12",e.model.get("nc12")]}],i.msg.loading();var n=o.promised(t.fetch());n.fail(function(){i.msg.loadingFailed()}),n.done(function(){i.msg.loaded(),1===t.length?window.open(t.at(0).genClientUrl()):t.length?window.open(t.genClientUrl()+"?"+t.rqlQuery):i.msg.show({type:"warning",time:2500,text:o.t("menu:nc12:pfep:notFound")})})}}),n.isAllowedTo("ORDERS:VIEW")&&c.push({label:o.t("menu:nc12:orders"),handler:function(){var t=new r;t.rqlQuery.selector.args=[{name:"eq",args:["bom.nc12",e.model.get("nc12")]}],window.open(t.genClientUrl()+"?"+t.rqlQuery)}})),c.length&&(c[0].icon="fa-external-link",a.menu=a.menu.concat(c)),e.td.focus(),!t&&!l){var u=e.td.getBoundingClientRect();t=u.top+u.height/2,l=u.left+u.width/2}d.show(o,t,l,a)}},handleQueuePrint:function(e){var t=this.model.entries.get(e);if(t)return t.get("discontinued")?i.msg.show({type:"warning",time:2500,text:this.t("msg:discontinued",{id:e})}):void this.model.builder.addFromEntry(t.serialize(this.model))},handleCopyTable:function(){var e=this,t=[e.columns.list.map(function(t){if(!t.arrayIndex)return e.model.tableView.getColumnText(t._id);for(var n=[],i=0;i<t.arrayIndex;++i)n.push(e.model.tableView.getColumnText(t._id,i));return n.join("\t")}).join("\t")];e.model.entries.filtered.forEach(function(n){t.push(e.exportEntry(n))}),this.handleCopy("table",t)},handleCopyRow:function(e){this.handleCopy("row",[this.exportEntry(this.model.entries.get(e))])},handleCopyCell:function(e,t,n){var i=this.columns.map[t],l=this.model.entries.get(e).serialize(this.model),o=l[t];n>=0&&(o=o[n]),this.handleCopy("cell",[i.exportValue(o,i,n,l)])},handleCopy:function(e,t){var n=this;a.copy(function(l){l.setData("text/plain",t.join("\r\n")),n.$clipboardMsg&&i.msg.hide(n.$clipboardMsg,!0),n.$clipboardMsg=i.msg.show({type:"info",time:1500,text:n.t("msg:clipboard:"+e)})})},handleSplitEntry:function(e){var t=this.model.entries.get(e);if(t){var n=new f({model:t});i.showDialog(n,this.t("splitEntry:title"))}},exportEntry:function(e){e=e.serialize(this.model);var t=[];return this.columns.list.forEach(function(n){n.arrayIndex?e[n._id].forEach(function(i,l){t.push(n.exportValue(i,n,l,e))}):t.push(n.exportValue(e[n._id],n,-1,e))}),t.join("\t")},showCellEditor:function(e){var t=this.editors[e.columnId];t&&(this.editing=e,e.td.classList.remove("kanban-is-editable"),e.td.classList.add("kanban-is-editing"),"string"==typeof t&&(t=this.editors[t]),t.call(this,e))},handleFilterMode:function(e){this.model.tableView.setFilterMode(e)},handleClearFilter:function(){this.model.tableView.clearFilters()},handleSort:function(e,t){this.model.tableView.setSortOrder(e,t)},showColumnVisibilityMenu:function(e){var t=this,n={animate:!1,menu:[t.t("menu:show")].concat(t.model.tableView.getHiddenColumns().map(function(n){return{label:t.model.tableView.getColumnText(n),handler:t.handleShowColumn.bind(t,n,e)}}))};this.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){d.show(t,e.top-5,e.left-1,n)})},handleShowColumns:function(e){this.showColumnVisibilityMenu(e.currentTarget.getBoundingClientRect())},handleShowColumn:function(e,t){this.model.tableView.setVisibility(e,!0),this.model.tableView.hasAnyHiddenColumn()&&this.showColumnVisibilityMenu(t)},handleHideColumn:function(e){this.model.tableView.setVisibility(e,!1)},handleExportTable:function(){var e=this;e.$exportMsg=i.msg.show({type:"info",text:e.t("export:progress")});var t=e.model.tableView,n=e.model.entries.filtered,l={},a=[],d=e.columns.map.kanbanId.visible,r=e.columns.map.container.visible;e.columns.list.forEach(function(n){if(!n.arrayIndex)return l[n._id]={type:n.type,width:n.width,headerRotation:n.rotated?90:0,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:t.getColumnText(n._id,-1,!1).replace(/<br>/g,"\r\n")},void(d&&"family"===n._id?(l.line={type:"string",width:10,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:e.t("column:line")},l.workstations={type:"string",width:4,headerRotation:90,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:e.t("column:workstations")},l.locations={type:"string",width:4,headerRotation:90,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:e.t("column:locations")}):r&&"container"===n._id&&(l.containerLength={type:"integer",width:4,headerRotation:90,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:e.t("kanbanContainers","PROPERTY:length")},l.containerWidth={type:"integer",width:4,headerRotation:90,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:e.t("kanbanContainers","PROPERTY:width")},l.containerHeight={type:"integer",width:4,headerRotation:90,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:e.t("kanbanContainers","PROPERTY:height")}));for(var i=0;i<n.arrayIndex;++i)l[n._id+i]={type:n.type,width:n.width,headerRotation:90,headerAlignmentH:"Center",headerAlignmentV:"Center",caption:t.getColumnText(n._id,i,!1).replace(/<br>/g,"\r\n")}}),n.forEach(function(t){if(t=t.serialize(e.model),l.kanbanId){var n=-1;t.lines.forEach(function(e){t.workstations.forEach(function(i,l){for(var o=2*i,a=t.locations[l],d=0;d<o;++d)u(t,e,t.kanbanId[++n],n,"ST"+(l+1),a)})}),t.workstations.forEach(function(e,i){var l=2*e,o=t.locations[i];t.lines.forEach(function(e){for(var a=0;a<l;++a)u(t,e,t.kanbanId[++n],n,"ST"+(i+1),o)})})}else u(t)});var s={filename:e.t("export:fileName"),sheetName:e.t("export:sheetName"),freezeRows:1,freezeColumns:1+(t.getVisibility("nc12")?1:0)+(t.getVisibility("description")?1:0),headerHeight:100,subHeader:!1,columns:l},h=new FormData;h.append("meta",new Blob([JSON.stringify(s)],{type:"application/json"}),"KANABN_META.json"),h.append("data",new Blob([a.map(function(e){return JSON.stringify(e)}).join("\n")],{type:"text/plain"}),"KANBAN_DATA.txt");var c=e.ajax({type:"POST",url:"/xlsxExporter",processData:!1,contentType:!1,data:h});function u(t,n,i,l,o,d){var r={};e.columns.list.forEach(function(a){if("kanbanId"!==a._id){if(a.arrayIndex)for(var s=0;s<a.arrayIndex;++s)r[a._id+s]=a.exportValue(t[a._id][s],a,s,t);else if(r[a._id]=a.exportValue(t[a._id],a,-1,t),l>=0&&"family"===a._id)r.line=n,r.workstations=o,r.locations=d;else if("container"===a._id){var h=e.model.containers.get(t.container);h?(r.containerLength=h.get("length"),r.containerWidth=h.get("width"),r.containerHeight=h.get("height")):(r.containerLength=0,r.containerWidth=0,r.containerHeight=0)}}else r[a._id]=i}),a.push(r)}c.fail(function(){i.msg.hide(e.$exportMsg,!0),i.msg.show({type:"error",time:2500,text:e.t("export:failure")})}),c.done(function(t){o.exportXlsx("/xlsxExporter/"+t),i.msg.hide(e.$exportMsg,!0)})},clearCache:function(){this.rowCache=null},onFilter:function(){this.$tbodyInner&&(this.filtered=!0)},onSort:function(){var e=this.filtered;if(this.filtered=!1,this.$tbodyInner){this.clearCache();var t=this.$tbodyInner[0],n=this.model.entries,i=this.focusedCell?n.filteredMap[this.focusedCell.model.id]:null,l=this.$tbodyOuter.outerHeight()-this.SCROLLBAR_HEIGHT;if(i){var o=n.filtered.indexOf(i),a=o*this.ROW_HEIGHT;a>=t.scrollTop&&a<t.scrollTop+l-2*this.ROW_HEIGHT||e?this.renderRows(-1,o):t.scrollTop=a}else this.prevFocusedCell=this.focusedCell,this.focusedCell=null,0===t.scrollTop?this.renderRows(0):e&&this.prevFocusedCell?this.renderRows(t.scrollTop):t.scrollTop=0}},onEntryChange:function(e){if(this.rowCache){delete this.rowCache[e.id];var t=this.$tbody.find('tr[data-model-id="'+e.id+'"]');if(t.length){var n=this.focusedCell&&this.focusedCell.tr===t[0];if(t.replaceWith(this.renderRow(e,+t[0].dataset.modelIndex)),n){var i=(t=this.$tbody.find('tr[data-model-id="'+e.id+'"]')).find('.kanban-td[data-column-id="'+this.focusedCell.columnId+'"]');this.focusedCell.arrayIndex>=0&&(i=i.filter('[data-array-index="'+this.focusedCell.arrayIndex+'"]')),this.focusedCell=this.idCell({currentTarget:i[0],clicks:this.focusedCell.clicks}),this.focusCell()}}}},focusCell:function(){this.$(".kanban-is-selected").removeClass("kanban-is-selected"),this.$tbody.find(".kanban-is-focused").removeClass("kanban-is-focused");var e=this.focusedCell;if(e){e.td&&(e.td.parentNode.classList.add("kanban-is-selected"),e.td.classList.add("kanban-is-focused"));var t='.kanban-td[data-column-id="'+e.columnId+'"]';e.arrayIndex>=0&&(t+='[data-array-index="'+e.arrayIndex+'"]'),this.$(t).addClass("kanban-is-selected")}},onSortableChange:function(){this.renderColumns()},onVisibilityChange:function(e,t){if(this.focusedCell&&t===this.focusedCell.columnId&&!this.model.tableView.getVisibility(t)){var n=this.focusedCell.td;do{n=n.previousElementSibling}while(n&&n.dataset.columnId===t);n&&(n.parentNode.parentNode?n.focus():this.focusedCell=this.idCell({currentTarget:n}))}this.clearCache(),this.renderColumns(),this.renderRows()},onTheadScroll:function(){this.$tbodyInner[0].scrollLeft=this.$theadInner[0].scrollLeft},onTbodyScroll:function(){this.$theadInner[0].scrollLeft=this.$tbodyInner[0].scrollLeft;var e=this.$tbodyInner[0].scrollTop;this.oldScrollTop!==e&&(this.oldScrollTop=e,this.renderRows())},onWindowKeyDown:function(e){if(this.$tbody){var t=e.target.tagName;"INPUT"!==t&&"SELECT"!==t&&"TEXTAREA"!==t&&(this.focusedCell||this.$tbody.find("tr:first-child > td:first-child").focus(),this.focusedCell&&this.handleTdKeyDown(e,this.focusedCell))}},handleTdKeyDown:function(e,t){var n=e.originalEvent.key;if(1===n.length&&(n=n.toUpperCase()),this.keyHandlers[n]){if(e.preventDefault(),this.editing)return;this.lastKeyPressAt[n]||(this.lastKeyPressAt[n]=Number.MIN_VALUE),this.keyHandlers[n].call(this,e,t),this.lastKeyPressAt[n]=e.timeStamp}},find:function(e,t){var n=this;if("component"===e)n.model.tableView.setFilters({nc12:{type:"text",data:t.id}});else if("entry"===e){var i=n.$tbody.find('tr[data-model-id="'+t.id+'"]');if(i.length)return i[0].firstElementChild.focus();if(n.model.entries.filteredMap[t.id]||n.model.tableView.clearFilters(),(i=n.$tbody.find('tr[data-model-id="'+t.id+'"]')).length)return i[0].firstElementChild.focus();n.afterRenderRows=function(){n.$tbody.find('tr[data-model-id="'+t.id+'"]')[0].firstElementChild.focus()},n.$tbodyInner[0].scrollTop=n.model.entries.filtered.indexOf(t)*n.ROW_HEIGHT}},handleEditorValue:function(e,t,n,l){var o=this,a=o.columns.map[t];if(a){var d=o.model.entries.get(e);if(d){var r=d.serialize(o.model),s=r[t];if(n>=0&&(s=s[n]),l!==s){var h=o.$tbody.find('tr[data-model-id="'+e+'"]').find('td[data-column-id="'+t+'"]');n>=0&&(h=h.filter('[data-array-index="'+n+'"]')),h.attr("class","kanban-td "+a.tdClassName(l,a,n,r)).find(".kanban-td-value").html(a.renderValue(l,a,n,r)),h.focus(),o.updateEditorValue(d,a,n,l).fail(function(){i.msg.show({type:"error",time:2500,text:o.t("msg:update:failure")});var e=d.serialize(o.model);h.attr("class","kanban-td "+a.tdClassName(s,a,n,e)).find(".kanban-td-value").html(a.renderValue(s,a,n,e)),o.focusedCell&&o.focusedCell.td!==h[0]||h.focus()})}}}},updateEditorValue:function(e,t,n,i){var l=e.serialize(this.model);return"markerColor"===t._id?this.model.settings.updateRowColor(l.storageBinRow,i):"newMarkerColor"===t._id?this.model.settings.updateRowColor(l.newStorageBinRow,i):this.ajax({method:"PATCH",url:e.url(),data:JSON.stringify({property:t._id,arrayIndex:n,newValue:i})})},afterEdit:function(){this.$tbody.find(".kanban-is-editing").removeClass("kanban-is-editing").addClass("kanban-is-editable"),this.editing=null},handleFilterValue:function(e,t,n){d.hide(this);var i=null;return t&&(i={type:t,data:n}),this.model.tableView.setFilter(e,i),!1},expandTdValue:function(e){var t=e.firstElementChild,n=t.firstElementChild;if(n&&n.textContent.trim().length){var i=e.getBoundingClientRect(),l=n.getBoundingClientRect(),o=window.innerWidth-15-this.SCROLLBAR_HEIGHT,a=window.innerHeight-15-this.SCROLLBAR_HEIGHT;if(!(l.left+l.width<o&&l.width<=i.width-8)){var d=this.columns.map[e.dataset.columnId].expand||i.width;t.style.width=d+"px",i.left+d>o&&(t.style.left=o-(i.left+d)+"px"),e.classList.add("kanban-is-expanded"),(l=t.getBoundingClientRect()).top+l.height>a&&(t.style.top=a-(l.top+l.height)+"px")}}},collapseTdValue:function(){var e=this.$tbody.find(".kanban-is-expanded");e.length&&e.removeClass("kanban-is-expanded").find(".kanban-td-value").css({top:"",left:"",width:""})},showTdPopover:function(e){this.hideTdPopover();var t=this.idCell({currentTarget:e});this.$popover=t.column.popover(t)},hideTdPopover:function(){this.$popover&&(this.$popover.popover("destroy"),this.$popover=null)}})});