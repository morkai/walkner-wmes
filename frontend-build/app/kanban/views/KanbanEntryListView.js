// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/core/View","app/planning/util/contextMenu","app/kanban/templates/entryList","app/kanban/templates/entryListColumns","app/kanban/templates/entryListRow"],function(e,n,t,o,i,l,d){"use strict";return t.extend({template:i,events:{contextmenu:function(){return!1},mousedown:function(e){if(1!==e.which)return!1},"dblclick .kanban-td":function(){return!1},"focus .kanban-td":function(e){var n=this.idCell(e);if(void 0!==n.value){if(this.focusedCell){if(n.td===this.focusedCell.td)return;this.focusedCell.td.classList.remove("kanban-is-focused"),this.focusedCell.tr.classList.remove("kanban-is-selected")}n.td.classList.add("kanban-is-focused"),n.tr.classList.add("kanban-is-selected"),this.focusedCell=n}},"click .kanban-is-editable":function(e){this.showCellEditor(this.idCell(e))},"click .kanban-is-with-menu":function(e){this.showColumnMenu(this.idCell(e),e.pageY,e.pageX)}},initialize:function(){this.focusedCell=null,this.listenTo(this.model.tableView,"change:filter change:order",this.onSortableChange),this.listenTo(this.model.tableView,"change:visibility",this.onVisibilityChange),this.listenTo(this.model.entries,"filter",this.onFilter),this.listenTo(this.model.entries,"sort",this.onSort),n(window).on("resize."+this.idPrefix,e.debounce(this.resize.bind(this),8)).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){n(window).off("."+this.idPrefix)},getTemplateData:function(){return{height:this.calcHeight()}},afterRender:function(){var e=this;e.$theadInner=e.$(".kanban-thead-innerContainer").on("scroll",e.onTheadScroll.bind(e)),e.$tbodyInner=e.$(".kanban-tbody-innerContainer").on("scroll",e.onTbodyScroll.bind(e)),e.$tbodyOuter=e.$(".kanban-tbody-outerContainer"),e.$scroller=e.$(".kanban-tbody-scroller"),e.$thead=e.$(".kanban-thead-table"),e.$table=e.$(".kanban-tbody-table"),e.$tbody=e.$(".kanban-tbody-tbody"),e.oldScrollTop=0,e.rowCache=null,e.afterRenderRows=null,e.renderColumns(),e.renderRows()},renderColumns:function(){this.$thead&&(this.columns=this.model.tableView.serializeColumns(),this.$thead.html(l({idPrefix:this.idPrefix,columns:this.columns})))},renderRow:function(e,t){var o=this;return o.rowCache[e.id]||(o.rowCache[e.id]=n.parseHTML(d({idPrefix:o.idPrefix,modelIndex:t,columns:o.columns,entry:e.serialize(o.model)}))[0]),o.rowCache[e.id]},renderRows:function(){var e=this;if(e.$tbody){var n=e.model.entries.filtered,t=e.$tbody[0],o=e.$tbodyOuter.outerHeight()-17,i=Math.ceil(o/25),l=e.$tbodyInner[0].scrollTop,d=Math.max(0,Math.floor(l/25)),r=d+i,s=r-1,a=-1,c=-1;t.childElementCount&&(a=+t.firstElementChild.dataset.modelIndex,c=+t.lastElementChild.dataset.modelIndex);var h=e.model.entries.filtered.length,u=25*(h+1),f=null;if(null===e.rowCache)e.rowCache={};else if(d>a&&s>c&&d<c-5)f="down";else if(d<a&&s<c&&s>a+5)f="up";else if(d===a&&s===c)return e.finalizeRenderRows();var m=document.createDocumentFragment();e.$table.css("top",l+"px"),e.$scroller.css("height",u+"px");var b,w,p,C,y,I;if("down"===f){for(w=d-a,b=s-c,p=1;p<=b;++p)y=c+p,(I=n[y])&&m.appendChild(e.renderRow(I,y));for(t.appendChild(m),C=0;C<w;++C)t.removeChild(t.firstElementChild)}else if("up"===f){for(w=c-s,b=a-d,p=0;p<b;++p)y=d+p,(I=n[y])&&m.appendChild(e.renderRow(I,y));for(t.insertBefore(m,t.firstElementChild),C=0;C<w;++C)t.removeChild(t.lastElementChild)}else{var v=n.slice(d,r);v.forEach(function(n,t){m.appendChild(e.renderRow(n,d+t))}),t.innerHTML="",t.appendChild(m)}e.finalizeRenderRows()}},renderRowsUp:function(){},finalizeRenderRows:function(){var e=this;if(e.afterRenderRows)e.afterRenderRows.call(e),e.afterRenderRows=null;else if(e.focusedCell){var n=e.focusedCell.model.id,t=e.focusedCell.columnId,o=e.focusedCell.arrayIndex,i=e.$('tr[data-model-id="'+n+'"]'),l='td[data-column-id="'+t+'"]';o>=0&&(l+='[data-array-index="'+o+'"]');var d=i.find(l);document.activeElement!==d[0]&&d.focus()}else e.$tbody&&e.$tbody[0].childElementCount&&e.$tbody[0].children[0].children[0].focus()},calcHeight:function(){return window.innerHeight-(this.el.offsetTop||102)-15},resize:function(){var e=this.calcHeight();this.el.style.height=e+"px",this.$tbodyOuter[0].style.height=e-148+"px",this.renderRows()},idCell:function(e){var n=e.currentTarget,t=n.parentNode,o=t.dataset.modelId,i=n.dataset.columnId,l=parseInt(n.dataset.arrayIndex,10),d=this.model.entries.get(o),r=d?d.serialize(this.model):{},s=r[i];return s&&l>=0&&(s=s[l]),{td:n,tr:t,columnId:i,arrayIndex:l,modelIndex:parseInt(t.dataset.modelIndex,10),model:d,data:r,value:s}},showColumnMenu:function(e,n,t){var i=this,l=i.$theadInner.find('td[data-column-id="'+e.columnId+'"]');if(!n&&!t){var d=l[0].getBoundingClientRect();n=d.top+d.height,t=d.left}var r=i.columns.map[e.columnId],s=i.model.tableView.getSortOrder(e.columnId),a={menu:[i.model.tableView.getColumnText(e.columnId),{icon:"fa-sort-amount-asc",label:i.t("menu:sort:asc"),handler:i.handleSort.bind(i,e.columnId,1),disabled:!r.sortable||1===s},{icon:"fa-sort-amount-desc",label:i.t("menu:sort:desc"),handler:i.handleSort.bind(i,e.columnId,-1),disabled:!r.sortable||-1===s},"-",{icon:"fa-eye",label:i.t("menu:show"),handler:i.handleShowColumns.bind(i),disabled:!i.model.tableView.hasAnyHiddenColumn()},{icon:"fa-eye-slash",label:i.t("menu:hide"),handler:i.handleHideColumn.bind(i,e.columnId),disabled:"_id"===e.columnId},"-"]};o.show(i,n,t,a)},showCellEditor:function(e){},handleSort:function(e,n){this.model.tableView.setSortOrder(e,n)},showColumnVisibilityMenu:function(e){var n=this,t={animate:!1,menu:[n.t("menu:show")].concat(n.model.tableView.getHiddenColumns().map(function(t){return{label:n.model.tableView.getColumnText(t),handler:n.handleShowColumn.bind(n,t,e)}}))};this.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){o.show(n,e.top-5,e.left-1,t)})},handleShowColumns:function(e){this.showColumnVisibilityMenu(e.currentTarget.getBoundingClientRect())},handleShowColumn:function(e,n){this.model.tableView.setVisibility(e,!0),this.model.tableView.hasAnyHiddenColumn()&&this.showColumnVisibilityMenu(n)},handleHideColumn:function(e){this.model.tableView.setVisibility(e,!1)},clearCache:function(){this.rowCache=null},onFilter:function(){this.$tbodyInner&&(this.oldScrollTop=0,this.$tbodyInner[0].scrollTop=0)},onSort:function(){this.clearCache(),this.renderRows()},onSortableChange:function(e,n){this.renderColumns()},onVisibilityChange:function(e,n){if(this.focusedCell&&n===this.focusedCell.columnId&&!this.model.tableView.getVisibility(n)){var t=this.focusedCell.td;do{t=t.previousElementSibling}while(t&&t.dataset.columnId===n);t&&(t.parentNode.parentNode?t.focus():this.focusedCell=this.idCell({currentTarget:t}))}this.clearCache(),this.renderColumns(),this.renderRows()},onTheadScroll:function(){this.$tbodyInner[0].scrollLeft=this.$theadInner[0].scrollLeft},onTbodyScroll:function(){this.$theadInner[0].scrollLeft=this.$tbodyInner[0].scrollLeft;var e=this.$tbodyInner[0].scrollTop;this.oldScrollTop!==e&&(this.oldScrollTop=e,this.renderRows())},onWindowKeyDown:function(e){var n=e.target.tagName;"INPUT"!==n&&"SELECT"!==n&&"TEXTAREA"!==n&&(this.focusedCell||this.$tbody.find("tr:first-child > td:first-child").focus(),this.handleTdKeyDown(e,this.focusedCell))},handleTdKeyDown:function(e,n){var t=e.originalEvent.key;this.keyHandlers[t]&&(this.keyHandlers[t].call(this,e,n),e.preventDefault())},keyHandlers:{ArrowUp:function(e,n){var t=this;if(0===n.modelIndex)return void(n.tr.parentNode||(t.$tbodyInner[0].scrollTop=0));var o=n.tr.previousElementSibling;if(o)return void o.cells[n.td.cellIndex].focus();t.afterRenderRows=function(e,n){var o=t.$table.find('tr[data-model-index="'+e+'"]')[0];o&&o.cells[n]&&o.cells[n].focus()}.bind(null,n.modelIndex-1,n.td.cellIndex),n.tr.parentNode?t.$tbodyInner[0].scrollTop-=25:t.$tbodyInner[0].scrollTop=25*n.modelIndex-25},ArrowDown:function(e,n){var t=this,o=n.tr.nextElementSibling;if(n.modelIndex===t.model.entries.filtered.length-1)return void(n.tr.parentNode||(t.$tbodyInner[0].scrollTop=t.$tbodyInner[0].scrollHeight));if(n.tr.parentNode&&n.tr.rowIndex<n.tr.parentNode.childElementCount-1){if(o.offsetTop+o.offsetHeight<=t.$tbodyInner[0].offsetHeight-17)return void o.cells[n.td.cellIndex].focus()}t.afterRenderRows=function(e,n){var o=t.$table.find('tr[data-model-index="'+e+'"]')[0];o&&o.cells[n]&&o.cells[n].focus()}.bind(null,n.modelIndex+1,n.td.cellIndex),n.tr.parentNode?t.$tbodyInner[0].scrollTop+=25*(o?1:2):t.$tbodyInner[0].scrollTop=25*n.modelIndex+25},ArrowRight:function(e,n){var t=n.td.nextElementSibling;if(n.tr.parentNode)return void("filler"!==t.dataset.columnId&&t.focus());var o=this;o.afterRenderRows=function(e,n){var t=o.$table.find('tr[data-model-index="'+e+'"]')[0];if(t){var i=t.cells[n];"filler"===i.dataset.columnId?i.previousElementSibling.focus():i.focus()}}.bind(null,n.modelIndex,n.td.cellIndex+1),o.$tbodyInner[0].scrollTop=25*n.modelIndex},ArrowLeft:function(e,n){var t=n.td.previousElementSibling;if(n.tr.parentNode)return void(t&&t.focus());var o=this;o.afterRenderRows=function(e,n){var t=o.$table.find('tr[data-model-index="'+e+'"]')[0];t&&t.cells[Math.max(0,n)].focus()}.bind(null,n.modelIndex,n.td.cellIndex-1),o.$tbodyInner[0].scrollTop=25*n.modelIndex},Tab:function(e,n){},PageUp:function(e,n){},PageDown:function(e,n){},Home:function(e,n){},End:function(e,n){},Escape:function(){o.hide(this)}}})});