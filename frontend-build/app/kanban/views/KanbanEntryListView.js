// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/viewport","app/core/View","app/data/clipboard","app/planning/util/contextMenu","app/kanban/templates/entryList","app/kanban/templates/entryListColumns","app/kanban/templates/entryListRow","app/kanban/templates/inputEditor"],function(e,t,n,i,l,o,d,r,s,a){"use strict";return i.extend({template:d,events:{contextmenu:function(){return!1},mousedown:function(e){if(1!==e.which)return!1},"dblclick .kanban-td":function(){return!1},"focus .kanban-td":function(e){var t=this.idCell(e);if(void 0!==t.value){this.$tbody.find(".kanban-is-selected").removeClass("kanban-is-selected"),this.$tbody.find(".kanban-is-focused").removeClass("kanban-is-focused"),t.td.classList.add("kanban-is-focused"),t.tr.classList.add("kanban-is-selected");var n=this.focusedCell;n&&n.modelId===t.modelId&&n.columnId===t.columnId&&n.arrayIndex===t.arrayIndex&&(t.clicks=n.clicks),this.focusedCell=t}},"click .kanban-is-editable":function(e){this.focusedCell&&this.focusedCell.td===e.currentTarget||(this.focusedCell=this.idCell(e)),this.focusedCell.clicks+=1,this.focusedCell.clicks>1&&this.showCellEditor(this.idCell(e))},"click .kanban-is-with-menu":function(e){this.showColumnMenu(this.idCell(e),e.pageY,e.pageX)}},initialize:function(){this.editing=null,this.focusedCell=null,this.lastKeyPressAt={},this.listenTo(this.model.tableView,"change:filter change:order",this.onSortableChange),this.listenTo(this.model.tableView,"change:visibility",this.onVisibilityChange),this.listenTo(this.model.entries,"filter",this.onFilter),this.listenTo(this.model.entries,"sort",this.onSort),this.listenTo(this.model.entries,"change",this.onEntryChange),t(window).on("resize."+this.idPrefix,e.debounce(this.resize.bind(this),8)).on("keydown."+this.idPrefix,this.onWindowKeyDown.bind(this))},destroy:function(){t(window).off("."+this.idPrefix)},getTemplateData:function(){return{height:this.calcHeight()}},afterRender:function(){var e=this;e.$theadInner=e.$(".kanban-thead-innerContainer").on("scroll",e.onTheadScroll.bind(e)),e.$tbodyInner=e.$(".kanban-tbody-innerContainer").on("scroll",e.onTbodyScroll.bind(e)),e.$tbodyOuter=e.$(".kanban-tbody-outerContainer"),e.$scroller=e.$(".kanban-tbody-scroller"),e.$thead=e.$(".kanban-thead-table"),e.$table=e.$(".kanban-tbody-table"),e.$tbody=e.$(".kanban-tbody-tbody"),e.oldScrollTop=0,e.rowCache=null,e.afterRenderRows=null,e.editing=null,e.renderColumns(),e.renderRows()},renderColumns:function(){this.$thead&&(this.columns=this.model.tableView.serializeColumns(),this.$thead.html(r({idPrefix:this.idPrefix,columns:this.columns})))},renderRow:function(e,n){var i=this;return i.rowCache[e.id]||(i.rowCache[e.id]=t.parseHTML(s({idPrefix:i.idPrefix,modelIndex:n,columns:i.columns,entry:e.serialize(i.model)}))[0]),i.rowCache[e.id]},renderRows:function(){var e=this;if(e.$tbody){var t=e.model.entries.filtered,n=e.$tbody[0],i=e.$tbodyOuter.outerHeight()-17,l=Math.ceil(i/25),o=e.$tbodyInner[0].scrollTop,d=Math.max(0,Math.floor(o/25)),r=d+l,s=r-1,a=-1,c=-1;n.childElementCount&&(a=+n.firstElementChild.dataset.modelIndex,c=+n.lastElementChild.dataset.modelIndex);var u=e.model.entries.filtered.length,h=25*(u+1),f=null;if(null===e.rowCache)e.rowCache={};else if(d>a&&s>c&&d<c-5)f="down";else if(d<a&&s<c&&s>a+5)f="up";else if(d===a&&s===c)return e.finalizeRenderRows();var m=document.createDocumentFragment();e.$table.css("top",o+"px"),e.$scroller.css("height",h+"px");var b,p,C,y,I,g;if("down"===f){for(p=d-a,b=s-c,C=1;C<=b;++C)I=c+C,(g=t[I])&&m.appendChild(e.renderRow(g,I));for(n.appendChild(m),y=0;y<p;++y)n.removeChild(n.firstElementChild)}else if("up"===f){for(p=c-s,b=a-d,C=0;C<b;++C)I=d+C,(g=t[I])&&m.appendChild(e.renderRow(g,I));for(n.insertBefore(m,n.firstElementChild),y=0;y<p;++y)n.removeChild(n.lastElementChild)}else{var w=t.slice(d,r);w.forEach(function(t,n){m.appendChild(e.renderRow(t,d+n))}),n.innerHTML="",n.appendChild(m)}e.finalizeRenderRows()}},renderRowsUp:function(){},finalizeRenderRows:function(){var e=this,t=e.$tbody;if(e.afterRenderRows)e.afterRenderRows.call(e),e.afterRenderRows=null;else if(e.focusedCell){var n=e.focusedCell.modelId,i=e.focusedCell.columnId,l=e.focusedCell.arrayIndex,o=t.find('tr[data-model-id="'+n+'"]'),d='td[data-column-id="'+i+'"]';l>=0&&(d+='[data-array-index="'+l+'"]');var r=o.find(d);r[0]!==document.activeElement&&(document.hasFocus()?r.focus():(e.$tbody.find(".kanban-is-selected").removeClass("kanban-is-selected"),e.$tbody.find(".kanban-is-focused").removeClass("kanban-is-focused"),o.addClass("kanban-is-selected"),r.addClass("kanban-is-focused")))}else t[0].childElementCount&&t[0].children[0].children[0].focus();e.editing&&e.editorPositioners[e.editing.columnId]&&e.editorPositioners[e.editing.columnId].call(e,e.editing)},calcHeight:function(){return window.innerHeight-(this.el.offsetTop||102)-15},resize:function(){var e=this.calcHeight();this.el.style.height=e+"px",this.$tbodyOuter[0].style.height=e-148+"px",this.renderRows()},idCell:function(e){var t=e.currentTarget,n=t.parentNode,i=n.dataset.modelId,l=t.dataset.columnId,o=parseInt(t.dataset.arrayIndex,10),d=this.model.entries.get(i),r=d?d.serialize(this.model):{},s=r[l];return isNaN(o)&&(o=-1),s&&o>=0&&(s=s[o]),{td:t,tr:n,columnId:l,column:this.columns.map[l],rowIndex:n.rowIndex,arrayIndex:o,modelIndex:parseInt(n.dataset.modelIndex,10),modelId:i,model:d,data:r,value:s,clicks:e.clicks||0}},resolveCell:function(e){if(!this.$tbody)return null;if(e.tr.parentNode)return e;var t=this.$tbody.find('tr[data-model-id="'+e.modelId+'"] > td[data-column-id="'+e.columnId+'"]');return t.length?this.idCell({currentTarget:t[0],clicks:e.clicks}):null},showColumnMenu:function(e,t,n){var i=this,l=i.$theadInner.find('td[data-column-id="'+e.columnId+'"]');if(!t&&!n){var d=l[0].getBoundingClientRect();t=d.top+d.height,n=d.left}var r=i.columns.map[e.columnId],s=i.model.tableView,a=s.getSortOrder(e.columnId),c={menu:[s.getColumnText(e.columnId),{icon:"fa-sort-amount-asc",label:i.t("menu:sort:asc"),handler:i.handleSort.bind(i,e.columnId,1),disabled:!r.sortable||1===a},{icon:"fa-sort-amount-desc",label:i.t("menu:sort:desc"),handler:i.handleSort.bind(i,e.columnId,-1),disabled:!r.sortable||-1===a},"-",{icon:"fa-eye",label:i.t("menu:show"),handler:i.handleShowColumns.bind(i),disabled:!s.hasAnyHiddenColumn()},{icon:"fa-eye-slash",label:i.t("menu:hide"),handler:i.handleHideColumn.bind(i,e.columnId),disabled:"_id"===e.columnId},"-",{icon:"fa-filter",label:i.t("menu:filter:clear"),handler:i.handleClearFilter.bind(i),disabled:!s.hasAnyFilter()},{label:i.t("menu:filter:and"),handler:i.handleFilterMode.bind(i,"and"),disabled:"and"===s.getFilterMode()},{label:i.t("menu:filter:or"),handler:i.handleFilterMode.bind(i,"or"),disabled:"or"===s.getFilterMode()}]};o.show(i,t,n,c)},showCellEditor:function(e){this.editors[e.columnId]&&(this.editing=e,e.td.classList.remove("kanban-is-editable"),e.td.classList.add("kanban-is-editing"),this.editors[e.columnId].call(this,e))},handleFilterMode:function(e){this.model.tableView.setFilterMode(e)},handleClearFilter:function(){this.model.tableView.clearFilters()},handleSort:function(e,t){this.model.tableView.setSortOrder(e,t)},showColumnVisibilityMenu:function(e){var t=this,n={animate:!1,menu:[t.t("menu:show")].concat(t.model.tableView.getHiddenColumns().map(function(n){return{label:t.model.tableView.getColumnText(n),handler:t.handleShowColumn.bind(t,n,e)}}))};this.broker.subscribe("planning.contextMenu.hidden").setLimit(1).on("message",function(){o.show(t,e.top-5,e.left-1,n)})},handleShowColumns:function(e){this.showColumnVisibilityMenu(e.currentTarget.getBoundingClientRect())},handleShowColumn:function(e,t){this.model.tableView.setVisibility(e,!0),this.model.tableView.hasAnyHiddenColumn()&&this.showColumnVisibilityMenu(t)},handleHideColumn:function(e){this.model.tableView.setVisibility(e,!1)},clearCache:function(){this.rowCache=null},onFilter:function(){this.$tbodyInner},onSort:function(){var e=this;if(e.$tbodyInner){e.clearCache();var t=e.$tbodyInner[0],n=e.model.entries,i=e.focusedCell?n.filteredMap[e.focusedCell.model.id]:null,l=e.$tbodyOuter.outerHeight()-17;if(i){var o=n.filtered.indexOf(i),d=25*o;d>=t.scrollTop&&d<t.scrollTop+l-50?e.renderRows():t.scrollTop=d}else e.focusedCell=null,0===t.scrollTop?e.renderRows():t.scrollTop=0}},onEntryChange:function(e){if(this.rowCache){delete this.rowCache[e.id];var t=this.$tbody.find('tr[data-model-id="'+e.id+'"]');if(t.length){var n=this.focusedCell&&this.focusedCell.tr===t[0];if(t.replaceWith(this.renderRow(e,+t[0].dataset.modelIndex)),n){t=this.$tbody.find('tr[data-model-id="'+e.id+'"]');var i=t.find('.kanban-td[data-column-id="'+this.focusedCell.columnId+'"]');this.focusedCell.arrayIndex>=0&&(i=i.filter('[data-array-index="'+this.focusedCell.arrayIndex+'"]')),this.focusedCell=this.idCell({currentTarget:i[0],clicks:this.focusedCell.clicks}),this.$tbody.find(".kanban-is-selected").removeClass("kanban-is-selected"),this.$tbody.find(".kanban-is-focused").removeClass("kanban-is-focused"),t.addClass("kanban-is-selected"),i.addClass("kanban-is-focused")}}}},onSortableChange:function(e,t){this.renderColumns()},onVisibilityChange:function(e,t){if(this.focusedCell&&t===this.focusedCell.columnId&&!this.model.tableView.getVisibility(t)){var n=this.focusedCell.td;do{n=n.previousElementSibling}while(n&&n.dataset.columnId===t);n&&(n.parentNode.parentNode?n.focus():this.focusedCell=this.idCell({currentTarget:n}))}this.clearCache(),this.renderColumns(),this.renderRows()},onTheadScroll:function(){this.$tbodyInner[0].scrollLeft=this.$theadInner[0].scrollLeft},onTbodyScroll:function(){this.$theadInner[0].scrollLeft=this.$tbodyInner[0].scrollLeft;var e=this.$tbodyInner[0].scrollTop;this.oldScrollTop!==e&&(this.oldScrollTop=e,this.renderRows())},onWindowKeyDown:function(e){var t=e.target.tagName;"INPUT"!==t&&"SELECT"!==t&&"TEXTAREA"!==t&&(this.focusedCell||this.$tbody.find("tr:first-child > td:first-child").focus(),this.handleTdKeyDown(e,this.focusedCell))},handleTdKeyDown:function(e,t){var n=e.originalEvent.key;if(1===n.length&&(n=n.toUpperCase()),this.keyHandlers[n]){if(e.preventDefault(),this.editing)return;this.lastKeyPressAt[n]||(this.lastKeyPressAt[n]=Number.MIN_VALUE),this.keyHandlers[n].call(this,e,t),this.lastKeyPressAt[n]=e.timeStamp}},keyHandlers:{ArrowUp:function(e,t){var n=this;if(0===t.modelIndex)return void(t.tr.parentNode||(n.$tbodyInner[0].scrollTop=0));var i=t.tr.previousElementSibling;if(i)return void i.cells[t.td.cellIndex].focus();n.afterRenderRows=function(e,t){var i=n.$table.find('tr[data-model-index="'+e+'"]')[0];i&&i.cells[t]&&i.cells[t].focus()}.bind(null,t.modelIndex-1,t.td.cellIndex),t.tr.parentNode?n.$tbodyInner[0].scrollTop-=25:n.$tbodyInner[0].scrollTop=25*t.modelIndex-25},ArrowDown:function(e,t){var n=this,i=t.tr.nextElementSibling;if(t.modelIndex===n.model.entries.filtered.length-1)return void(t.tr.parentNode||(n.$tbodyInner[0].scrollTop=n.$tbodyInner[0].scrollHeight));if(t.tr.parentNode&&t.tr.rowIndex<t.tr.parentNode.childElementCount-1){if(i.offsetTop+i.offsetHeight<=n.$tbodyInner[0].offsetHeight-17)return void i.cells[t.td.cellIndex].focus()}n.afterRenderRows=function(e,t){var i=n.$table.find('tr[data-model-index="'+e+'"]')[0];i&&i.cells[t]&&i.cells[t].focus()}.bind(null,t.modelIndex+1,t.td.cellIndex),t.tr.parentNode?n.$tbodyInner[0].scrollTop+=25*(i?1:2):n.$tbodyInner[0].scrollTop=25*t.modelIndex+25},ArrowRight:function(e,t){var n=t.td.nextElementSibling;if(t.tr.parentNode)return void("filler"!==n.dataset.columnId&&n.focus());var i=this;i.afterRenderRows=function(e,t){var n=i.$table.find('tr[data-model-index="'+e+'"]')[0];if(n){var l=n.cells[t];"filler"===l.dataset.columnId?l.previousElementSibling.focus():l.focus()}}.bind(null,t.modelIndex,t.td.cellIndex+1),i.$tbodyInner[0].scrollTop=25*t.modelIndex},ArrowLeft:function(e,t){var n=t.td.previousElementSibling;if(t.tr.parentNode)return void(n&&n.focus());var i=this;i.afterRenderRows=function(e,t){var n=i.$table.find('tr[data-model-index="'+e+'"]')[0];n&&n.cells[Math.max(0,t)].focus()}.bind(null,t.modelIndex,t.td.cellIndex-1),i.$tbodyInner[0].scrollTop=25*t.modelIndex},Tab:function(e,t){},PageUp:function(e,t){},PageDown:function(e,t){},Home:function(e,t){},End:function(e,t){},Escape:function(){o.hide(this)}," ":function(){},Enter:function(e,t){t.td.classList.contains("kanban-is-editable")&&this.showCellEditor(t)},C:function(e,t){function i(e){e=e.serialize(),o=[],d.columns.list.forEach(function(t){Array.isArray(e[t._id])?e[t._id].forEach(function(n,i){o.push(t.exportValue(n,t,i,e))}):o.push(t.exportValue(e[t._id],t,-1,e))}),r.push(o.join("\t"))}if(e.ctrlKey){var o,d=this,r=[],s="cell";e.timeStamp-d.lastKeyPressAt.CtrlA<1e3?(d.model.entries.filtered.forEach(i),s="table"):e.timeStamp-d.lastKeyPressAt.C<500?(i(t.model),s="row"):t.arrayIndex>=0?r.push(t.column.exportValue(t.model.serialize()[t.columnId][t.arrayIndex],t.column,t.arrayIndex,t.model.serialize())):r.push(t.column.exportValue(t.model.serialize()[t.columnId],t.column,-1,t.model.serialize())),l.copy(function(e){e.setData("text/plain",r.join("\r\n")),d.$clipboardMsg&&n.msg.hide(d.$clipboardMsg,!0),d.$clipboardMsg=n.msg.show({type:"info",time:1500,text:d.t("msg:clipboard:"+s)})})}},A:function(e){e.ctrlKey&&(this.lastKeyPressAt.CtrlA=e.timeStamp)}},handleEditorValue:function(e,t,i,l){var o=this,d=o.columns.map[t];if(d){var r=o.model.entries.get(e);if(r){var s=r.serialize(),a=s[t];if(i>=0&&(a=a[i]),l!==a){var c=o.$tbody.find('tr[data-model-id="'+e+'"]'),u=c.find('td[data-column-id="'+t+'"]');i>=0&&(u=u.filter('[data-array-index="'+i+'"]')),u.attr("class","kanban-td "+d.tdClassName(l,d,i,s)).find(".kanban-td-value").html(d.renderValue(l,d,i,s)),u.focus();o.ajax({method:"PATCH",url:r.url(),data:JSON.stringify({property:t,arrayIndex:i,newValue:l})}).fail(function(){n.msg.show({type:"error",time:2500,text:o.t("msg:update:failure")});var e=r.serialize();u.attr("class","kanban-td "+d.tdClassName(a,d,i,e)).find(".kanban-td-value").html(d.renderValue(a,d,i,e)),o.focusedCell&&o.focusedCell.td!==u[0]||u.focus()})}}}},afterEdit:function(){this.$tbody.find(".kanban-is-editing").removeClass("kanban-is-editing").addClass("kanban-is-editable"),this.editing=null},editors:{input:function(e,n,i){function l(){var t=e.column.parseValue(r.$id("editor-input").val(),e.column,e.arrayIndex,e.model.serialize());return r.handleEditorValue(e.modelId,e.columnId,e.arrayIndex,t),o(),!1}function o(){r.$id("editor-backdrop").remove(),r.$id("editor-form").remove(),r.afterEdit()}function d(e){"Escape"===e.originalEvent.key&&o()}var r=this,s=e.td.getBoundingClientRect(),c=e.model.serialize();t(document.body).append(a({idPrefix:r.idPrefix,columnId:e.columnId,maxLength:n,pattern:i,value:e.column.editorValue(e.arrayIndex>=0?c[e.columnId][e.arrayIndex]:c[e.columnId],e.column,e.arrayIndex,c)})),r.$id("editor-backdrop").one("click",o),r.$id("editor-form").on("submit",l).css({top:s.top+"px",left:s.left+"px"}),r.$id("editor-input").on("blur",o).on("keydown",d).select()},kind:function(e){var t=this,n=e.td.getBoundingClientRect(),i=e.model.get("kind"),l=[];["kk","pk",null].forEach(function(n){l.push({label:t.t("kind:"+n),handler:t.handleEditorValue.bind(t,e.modelId,e.columnId,e.arrayIndex,n),disabled:i===n})}),o.show(t,n.top,n.left,l),t.broker.subscribe("planning.contextMenu.hidden",t.afterEdit.bind(t)).setLimit(1)},discontinued:function(e){this.handleEditorValue(e.modelId,e.columnId,e.arrayIndex,!e.model.get("discontinued")),this.afterEdit()},workstations:function(e){this.editors.input.call(this,e,2,"^([0-9]|[1-9][0-9])$")},locations:function(e){this.editors.input.call(this,e,3,"^[A-Za-z]([0-9][0-9])$")}},editorPositioners:{contextMenu:function(e){var t=this.resolveCell(e);if(t){var n=t.td.getBoundingClientRect();o.position(this,n.top,n.left)}},inputEditor:function(e){var t=this.resolveCell(e);if(t){var n=t.td.getBoundingClientRect();this.$id("editor-form").css({top:n.top+"px",left:n.left+"px"})}},kind:function(){this.editorPositioners.contextMenu.apply(this,arguments)},workstations:function(){this.editorPositioners.inputEditor.apply(this,arguments)},locations:function(){this.editorPositioners.inputEditor.apply(this,arguments)}}})});