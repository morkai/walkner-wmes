define(["jquery","app/viewport","app/planning/util/contextMenu","./KanbanSearchDialogView"],function(e,t,n,l){"use strict";return{ArrowUp:function(e,t){var n=this;if(0!==t.modelIndex){var l=t.tr.previousElementSibling;l?l.cells[t.td.cellIndex].focus():(n.afterRenderRows=function(e,t){var l=n.$table.find('tr[data-model-index="'+e+'"]')[0];l&&l.cells[t]&&l.cells[t].focus()}.bind(null,t.modelIndex-1,t.td.cellIndex),t.tr.parentNode?n.$tbodyInner[0].scrollTop-=n.ROW_HEIGHT:n.$tbodyInner[0].scrollTop=t.modelIndex*n.ROW_HEIGHT-n.ROW_HEIGHT)}else t.tr.parentNode||(n.$tbodyInner[0].scrollTop=0)},ArrowDown:function(e,t){var n=this,l=t.tr.nextElementSibling;if(t.modelIndex!==n.model.entries.filtered.length-1){if(t.tr.parentNode&&t.tr.rowIndex<t.tr.parentNode.childElementCount-1)if(l.offsetTop+l.offsetHeight<=n.$tbodyInner[0].offsetHeight-n.SCROLLBAR_HEIGHT)return void l.cells[t.td.cellIndex].focus();n.afterRenderRows=function(e,t){var l=n.$table.find('tr[data-model-index="'+e+'"]')[0];l&&l.cells[t]&&l.cells[t].focus()}.bind(null,t.modelIndex+1,t.td.cellIndex),t.tr.parentNode?n.$tbodyInner[0].scrollTop+=n.ROW_HEIGHT*(l?1:2):n.$tbodyInner[0].scrollTop=t.modelIndex*n.ROW_HEIGHT+n.ROW_HEIGHT}else t.tr.parentNode||(n.$tbodyInner[0].scrollTop=n.$tbodyInner[0].scrollHeight)},ArrowRight:function(e,t){var n=t.td.nextElementSibling;if(t.tr.parentNode)"filler2"!==n.dataset.columnId&&n.focus();else{var l=this;l.afterRenderRows=function(e,t){var n=l.$table.find('tr[data-model-index="'+e+'"]')[0];if(n){var o=n.cells[t];"filler2"===o.dataset.columnId?o.previousElementSibling.focus():o.focus()}}.bind(null,t.modelIndex,t.td.cellIndex+1),l.$tbodyInner[0].scrollTop=t.modelIndex*l.ROW_HEIGHT}},ArrowLeft:function(e,t){var n=t.td.previousElementSibling;if(t.tr.parentNode)n&&n.focus();else{var l=this;l.afterRenderRows=function(e,t){var n=l.$table.find('tr[data-model-index="'+e+'"]')[0];n&&n.cells[Math.max(0,t)].focus()}.bind(null,t.modelIndex,t.td.cellIndex-1),l.$tbodyInner[0].scrollTop=t.modelIndex*l.ROW_HEIGHT}},Tab:function(e,t){return e.shiftKey?this.keyHandlers.ShiftTab.call(this,e,t):-1!==t.td.nextElementSibling.tabIndex?t.td.nextElementSibling.focus():+t.tr.dataset.modelIndex==this.model.entries.filtered.length-1?(this.lastKeyPressAt.Home=e.timeStamp,this.keyHandlers.Home.call(this,e,t)):(t.tr.firstElementChild.focus(),void this.keyHandlers.ArrowDown.call(this,e,this.focusedCell))},ShiftTab:function(e,t){return t.tr.firstElementChild!==t.td?t.td.previousElementSibling.focus():"0"===t.tr.dataset.modelIndex?(this.lastKeyPressAt.End=e.timeStamp,this.keyHandlers.End.call(this,e,t)):(t.tr.lastElementChild.previousElementSibling.focus(),void this.keyHandlers.ArrowUp.call(this,e,this.focusedCell))},PageUp:function(e,t){var n=this,l=n.$tbodyOuter.outerHeight()-n.SCROLLBAR_HEIGHT,o=Math.ceil(l/n.ROW_HEIGHT),i=Math.max(0,t.modelIndex-o),d=n.$tbody.find('tr[data-model-index="'+i+'"]');if(d.length)return d.find('td[data-column-id="'+t.columnId+'"]').focus();n.afterRenderRows=function(){var e=n.$tbody[0].rows;(e[t.rowIndex]||e[0]).cells[t.td.cellIndex].focus()},n.$tbodyInner[0].scrollTop-=o*n.ROW_HEIGHT},PageDown:function(e,t){var n=this,l=n.$tbodyOuter.outerHeight()-n.SCROLLBAR_HEIGHT,o=Math.ceil(l/n.ROW_HEIGHT),i=Math.min(n.model.entries.filtered.length-1,t.modelIndex+o),d=n.$tbody.find('tr[data-model-index="'+i+'"]');if(d.length)return d.find('td[data-column-id="'+t.columnId+'"]').focus();n.afterRenderRows=function(){var e=n.$tbody[0].rows;(e[t.rowIndex]||e[e.length-1]).cells[t.td.cellIndex].focus()},n.$tbodyInner[0].scrollTop+=o*n.ROW_HEIGHT},Home:function(e,t){var n=this;if(e.timeStamp-n.lastKeyPressAt.Home<500){if("0"===n.$tbody[0].firstElementChild.dataset.modelIndex)return void n.$tbody[0].firstElementChild.firstElementChild.focus();n.afterRenderRows=function(){n.$tbody[0].firstElementChild.firstElementChild.focus()},n.$tbodyInner[0].scrollTop=0}else t.tr.firstElementChild.focus()},End:function(e,t){var n=this;if(e.timeStamp-n.lastKeyPressAt.End<500){if(+n.$tbody[0].lastElementChild.dataset.modelIndex==n.model.entries.filtered.length-1)return void n.$tbody[0].lastElementChild.lastElementChild.previousElementSibling.focus();n.afterRenderRows=function(){n.$tbody[0].lastElementChild.lastElementChild.previousElementSibling.focus()},n.$tbodyInner[0].scrollTop=n.$tbodyInner[0].scrollHeight}else t.tr.lastElementChild.previousElementSibling.focus()},Escape:function(){n.hide(this)}," ":function(){},Enter:function(e,t){e.altKey&&this.showCellMenu(t),!e.altKey&&t.td.classList.contains("kanban-is-editable")&&this.showCellEditor(t)},C:function(e,t){if(e.ctrlKey&&""===window.getSelection().toString()){e.timeStamp-this.lastKeyPressAt.CtrlA<1e3?this.handleCopyTable():e.timeStamp-this.lastKeyPressAt.C<500?this.handleCopyRow(t.modelId):this.handleCopyCell(t.modelId,t.columnId,t.arrayIndex)}},S:function(e){e.ctrlKey&&this.handleExportTable()},A:function(e){e.ctrlKey&&(this.lastKeyPressAt.CtrlA=e.timeStamp)},F:function(n){if(n.ctrlKey&&!t.currentDialog){var o=this,i=new l({model:o.model});return o.listenToOnce(i,"found",o.find.bind(o)),t.showDialog(i),e(".viewport-dialog").removeClass("fade"),o.broker.subscribe("viewport.dialog.hidden").setLimit(1).on("message",function(){o.editing=null,e(".viewport-dialog").addClass("fade")}),o.editing=o.focusedCell,!1}}}});