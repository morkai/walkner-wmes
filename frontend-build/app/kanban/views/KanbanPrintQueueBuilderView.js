define(["underscore","jquery","app/viewport","app/core/View","app/core/util/uuid","app/core/util/ExpandableSelect","app/data/localStorage","../KanbanPrintQueueBuilder","../layouts","app/kanban/templates/builder/builder"],function(t,e,i,n,o,s,r,a,l,d){"use strict";return n.extend({template:d,events:{submit:function(){return this.submit(),!1},"click #-hide":function(){return this.hide(),!1},"click #-clear":function(){this.model.builder.reset([])},'click .btn[data-action="remove"]':function(t){var e=this.model.builder.at(this.$(t.currentTarget).closest("tr").prop("rowIndex"));e&&this.model.builder.remove(e),this.lastRemoveClickAt=t.timeStamp},'click .btn[data-action="layout"]':function(t){this.model.builder.toggleLayout(t.currentTarget.value)},"click .kanban-builder-ccn":function(t){var e=this.model.entries.get(t.currentTarget.textContent.trim());e&&this.trigger("find","entry",e)},"keydown select":function(t){if("Enter"===t.key||" "===t.key)return t.currentTarget.blur(),!1},"change select":function(e){var i=t.pluck(e.currentTarget.selectedOptions,"value"),n=this.model.builder.at(this.$(e.currentTarget).closest("tr").prop("rowIndex"));n&&n.set("lines",i)},"mousedown #-dragHandle":function(t){var i=(t=t.originalEvent).currentTarget.getBoundingClientRect(),n={top:i.y-t.pageY,left:i.x-t.pageX};e(window).on("mouseup."+this.idPrefix,this.handleDragEnd.bind(this,n)).on("mousemove."+this.idPrefix,this.handleDrag.bind(this,n))},"resize #-tbody":function(){this.saveCss()},"click #-lines":function(){var i=this;if(i.$id("lines").find("select").length)return!1;var n={};i.model.builder.forEach(function(t){var e=i.model.entries.get(t.get("ccn")).serialize(i.model).lines,o=t.get("lines");e.forEach(function(t){n[t]=-1!==o.indexOf(t)})});var o=Object.keys(n).sort(function(t,e){return t.localeCompare(e,void 0,{ignorePunctuation:!0,numeric:!0})}),s=e('<select class="form-control is-expandable" multiple></select>');o.forEach(function(e){var i=n[e];e=t.escape(e),s.append('<option value="'+e+'" '+(i?"selected":"")+">"+e+"</option>")}),i.$id("lines").append(s),s.expandableSelect({expandedLength:Math.min(o.length,10)}).focus(),s.on("blur",function(){s.remove()}),s.on("change",function(){var n={};(s.val()||[]).forEach(function(t){n[t]=!0}),i.$rows.find("select").each(function(){var o=e(this).closest("tr"),s=i.model.builder.at(o[0].rowIndex),r=[];t.forEach(this.options,function(t){t.selected=n[t.value],t.selected&&r.push(t.value)}),s.attributes.lines=r,i.recountRow(s,o)}),i.model.builder.store(),i.recountTotals(),i.validate()})}},initialize:function(){var t=this.model.entries,e=this.model.builder;this.shown=!1,this.listenTo(t,"change",this.onEntryChange),this.listenTo(e,"focus",this.onFocus),this.listenTo(e,"reset",this.onReset),this.listenTo(e,"add",this.onAdd),this.listenTo(e,"multiAdd",this.onMultiAdd),this.listenTo(e,"remove",this.onRemove),this.listenTo(e,"change:layouts",this.onLayoutsChange),this.listenTo(e,"change:lines",this.onLinesChange)},destroy:function(){e(window).off("."+this.idPrefix),this.$(".is-expandable").expandableSelect("destroy")},getTemplateData:function(){var t=this.model.builder.layouts;return{layouts:l.map(function(e){return{id:e,active:-1!==t.indexOf(e)}})}},afterRender:function(){this.$tbody=this.$id("tbody"),this.$rows=this.$id("rows"),this.$row=this.$rows.find("tr").detach(),this.addRows(this.model.builder.models),this.recountTotals()},handleDragEnd:function(t,i){e(window).off("."+this.idPrefix),this.position(i.originalEvent.pageX,i.originalEvent.pageY,t),this.saveCss()},handleDrag:function(t,e){this.position(e.originalEvent.pageX,e.originalEvent.pageY,t)},position:function(t,e,i){this.$el.css({top:Math.max(0,Math.min(Math.max(0,e+i.top),window.innerHeight-100))+"px",left:Math.max(0,Math.min(Math.max(0,t+i.left),window.innerWidth-200))+"px"})},saveCss:function(){r.setItem("WMES_KANBAN_BUILDER_CSS",JSON.stringify({top:this.el.offsetTop,left:this.el.offsetLeft,height:this.$id("tbody")[0].clientHeight}))},show:function(){this.shown=!0;var t=JSON.parse(r.getItem("WMES_KANBAN_BUILDER_CSS")||"null")||{top:100,left:window.innerWidth/2-309,height:165};this.$tbody.css({height:t.height+"px"}),this.position(t.left,t.top,{left:0,top:0}),this.$el.removeClass("hidden"),this.$tbody[0].scrollTop=this.$tbody[0].scrollHeight,this.trigger("shown")},hide:function(){this.shown=!1,this.$el.addClass("hidden"),this.trigger("hidden")},recountNos:function(){this.$rows.children().each(function(t){this.children[0].textContent=t+1+"."})},recountTotals:function(){var t=this,e=t.model.builder.length,i={};t.model.builder.forEach(function(t){t.get("lines").forEach(function(t){i[t]=1})}),t.$id("totals-no").text(e),t.$id("totals-lines").text(Object.keys(i).length),l.forEach(function(e){var i=0;t.$('.kanban-builder-layout[data-layout="'+e+'"]').each(function(){i+=parseInt(this.textContent,10)}),t.$id("totals-"+e).text(i)})},recountRow:function(t,e){var i=e&&e.length?e[0]:this.$rows[0].rows[this.model.builder.models.indexOf(t)],n=this.model.entries.get(t.get("ccn")).serialize(this.model),o=n.kanbanQtyUser,s=t.get("lines").length,r=this.model.builder.layouts;l.forEach(function(t,e){var a=0;-1!==r.indexOf(t)&&("kk"===n.kind?a="kk"===t?o*s:0:"pk"===n.kind&&(a="kk"===t?0:o*s)),i.cells[3+e].textContent=a.toString()})},addRows:function(i){var n=this,o=e(document.createDocumentFragment()),s=n.$rows[0].childElementCount;i.forEach(function(e){var i=n.model.entries.get(e.get("ccn"));if(i){++s;var r=n.$row.clone(),a=r[0].children,l=a[2].firstElementChild,d=[],u=e.get("lines");a[0].textContent=s+".",a[1].textContent=i.id,i.serialize(n.model).lines.forEach(function(e){var i=-1===u.indexOf(e)?"":"selected";e=t.escape(e),d.push('<option value="'+e+'" '+i+">"+e+"</option>")}),l.innerHTML=d.join(""),n.recountRow(e,r),o.append(r)}}),o.find("select").expandableSelect(),n.$rows.append(o),1===i.length&&(clearTimeout(n.timers.focusLast),n.timers.focusLast=setTimeout(function(){var t=n.$rows[0].lastElementChild;t&&t.querySelector("select").focus()},1))},validate:function(){var e=this,i=e.model.builder,n="",o=[];i.layouts.length||(n=e.t("builder:error:noLayout")),e.$id("layoutError")[0].setCustomValidity(n),e.$rows.children().each(function(t){var n=i.at(t),s=e.model.entries.get(n.get("ccn"));if(s)if((s=s.serialize(e.model)).kind){for(var r=n.get("lines"),a=0;a<r.length;++a){var l=r[a],d=s.lines.indexOf(l);if(-1!==d)for(var u=d*s.kanbanQtyUser,c=d*s.kanbanQtyUser+s.kanbanQtyUser,h=u;h<c;++h)if(!(s.kanbanId[h]>0))return void o.push(e.t("builder:error:noKanbanId",{line:l,i:h+1}))}o.push("")}else o.push(e.t("builder:error:noKind"));else o.push(e.t("builder:error:noEntry"))});var s=e.$rows.find("select");return o.forEach(function(t,e){s[e].setCustomValidity(t)}),""===n&&t.all(o,function(t){return""===t})},submit:function(){var t=this;if(t.validate()){i.msg.saving();var e=t.$("button, select, input").prop("disabled",!0),n=[];if(t.model.builder.forEach(function(e){var i=t.model.entries.get(e.get("ccn")).serialize(t.model);if(i.workstationsTotal){var s=t.model.builder.layouts.filter(function(t){return"kk"===i.kind&&"kk"===t||"kk"!==i.kind&&"kk"!==t});s.length&&e.get("lines").forEach(function(t){var e=i.lines.indexOf(t),r=e*i.kanbanQtyUser,a=e*i.kanbanQtyUser+i.kanbanQtyUser;n.push({_id:o(),line:t,kanbans:i.kanbanId.slice(r,a),layouts:s,data:{ccn:i._id,nc12:i.nc12,description:i.description,supplyArea:i.supplyArea,family:i.family,componentQty:i.componentQty,unit:i.unit,storageBin:i.storageBin,minBinQty:i.minBinQty,maxBinQty:i.maxBinQty,replenQty:i.replenQty,workstations:i.workstations,locations:i.locations}})})}}),0===n.length)return i.msg.saved(),t.model.builder.reset([]),void e.prop("disabled",!1);n.sort(function(t,e){return t.line.localeCompare(e.line,void 0,{numeric:!0,ignorePunctuation:!0})});var s=t.ajax({method:"POST",url:"/kanban/printQueues",data:JSON.stringify({_id:o(),jobs:n})});s.fail(function(){i.msg.savingFailed()}),s.done(function(){i.msg.saved(),t.model.builder.reset([])}),s.always(function(){e.prop("disabled",!1)})}else setTimeout(function(){t.$id("submit").click()},1)},onEntryChange:function(t){var e=this.model.builder.findWhere({ccn:t.id});e&&(this.recountRow(e),this.recountTotals(),this.validate())},onFocus:function(t){var e=this.model.builder.models.indexOf(t);-1!==e&&this.$rows[0].rows[e].querySelector("select").focus()},onReset:function(){this.render(),0===this.model.builder.length&&this.hide()},onAdd:function(t,e,i){i&&i.multi||this.onMultiAdd([t.id])},onMultiAdd:function(t){this.addRows(t.map(function(t){return this.model.builder.get(t)},this)),this.recountTotals(),this.validate()},onRemove:function(t,e,i){this.$(this.$rows[0].rows[i.index]).remove(),this.recountNos(),this.recountTotals(),0===this.model.builder.length&&this.hide()},onLayoutsChange:function(t,e){this.$('.btn[value="'+t+'"]').toggleClass("active",e),this.model.builder.forEach(function(t){this.recountRow(t)},this),this.recountTotals(),this.validate()},onLinesChange:function(t){this.recountRow(t),this.recountTotals(),this.validate()}})});