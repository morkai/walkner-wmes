define(["underscore","jquery","app/viewport","app/core/View","app/core/util/uuid","app/core/util/ExpandableSelect","app/data/localStorage","../KanbanPrintQueueBuilder","../layouts","app/kanban/templates/builder/builder"],function(e,t,i,n,o,s,r,a,l,d){"use strict";return n.extend({template:d,events:{submit:function(){return this.submit(),!1},"click #-hide":function(){return this.hide(),!1},"click #-clear":function(){this.model.builder.reset([])},'click .btn[data-action="remove"]':function(e){var t=this.model.builder.at(this.$(e.currentTarget).closest("tr").prop("rowIndex"));t&&this.model.builder.remove(t),this.lastRemoveClickAt=e.timeStamp},'click .btn[data-action="layout"]':function(e){this.model.builder.toggleLayout(e.currentTarget.value)},"click .kanban-builder-ccn":function(e){var t=this.model.entries.get(e.currentTarget.textContent.trim());t&&this.trigger("find","entry",t)},"keydown select":function(e){if("Enter"===e.key||" "===e.key)return e.currentTarget.blur(),!1},"change select":function(t){var i=e.pluck(t.currentTarget.selectedOptions,"value"),n=this.model.builder.at(this.$(t.currentTarget).closest("tr").prop("rowIndex"));n&&n.set("lines",i)},"mousedown #-dragHandle":function(e){var i=(e=e.originalEvent).currentTarget.getBoundingClientRect(),n={top:i.y-e.pageY,left:i.x-e.pageX};t(window).on("mouseup."+this.idPrefix,this.handleDragEnd.bind(this,n)).on("mousemove."+this.idPrefix,this.handleDrag.bind(this,n))},"resize #-tbody":function(){this.saveCss()},"click #-lines":function(){var i=this;if(i.$id("lines").find("select").length)return!1;var n={};i.model.builder.forEach(function(e){var t=i.model.entries.get(e.get("ccn")).serialize(i.model).lines,o=e.get("lines");t.forEach(function(e){n[e]=-1!==o.indexOf(e)})});var o=Object.keys(n).sort(function(e,t){return e.localeCompare(t,void 0,{ignorePunctuation:!0,numeric:!0})}),s=t('<select class="form-control is-expandable" multiple></select>');o.forEach(function(t){var i=n[t];t=e.escape(t),s.append('<option value="'+t+'" '+(i?"selected":"")+">"+t+"</option>")}),i.$id("lines").append(s),s.expandableSelect({expandedLength:Math.min(o.length,10)}).focus(),s.on("blur",function(){s.remove()}),s.on("change",function(){var n={};(s.val()||[]).forEach(function(e){n[e]=!0}),i.$rows.find("select").each(function(){var o=t(this).closest("tr"),s=i.model.builder.at(o[0].rowIndex),r=[];e.forEach(this.options,function(e){e.selected=n[e.value],e.selected&&r.push(e.value)}),s.attributes.lines=r,i.recountRow(s,o)}),i.model.builder.store(),i.recountTotals(),i.validate()})},"change #-newStorageBin":function(){this.model.builder.toggleNewStorageBin(this.$id("newStorageBin").prop("checked"))}},initialize:function(){var e=this.model.entries,t=this.model.builder;this.shown=!1,this.listenTo(e,"change",this.onEntryChange),this.listenTo(t,"focus",this.onFocus),this.listenTo(t,"reset",this.onReset),this.listenTo(t,"add",this.onAdd),this.listenTo(t,"multiAdd",this.onMultiAdd),this.listenTo(t,"remove",this.onRemove),this.listenTo(t,"change:layouts",this.onLayoutsChange),this.listenTo(t,"change:lines",this.onLinesChange)},destroy:function(){t(window).off("."+this.idPrefix),this.$(".is-expandable").expandableSelect("destroy")},getTemplateData:function(){var e=this.model.builder.layouts;return{newStorageBin:this.model.builder.newStorageBin,layouts:l.map(function(t){return{id:t,active:-1!==e.indexOf(t)}})}},afterRender:function(){this.$tbody=this.$id("tbody"),this.$rows=this.$id("rows"),this.$row=this.$rows.find("tr").detach(),this.addRows(this.model.builder.models),this.recountTotals()},handleDragEnd:function(e,i){t(window).off("."+this.idPrefix),this.position(i.originalEvent.pageX,i.originalEvent.pageY,e),this.saveCss()},handleDrag:function(e,t){this.position(t.originalEvent.pageX,t.originalEvent.pageY,e)},position:function(e,t,i){this.$el.css({top:Math.max(0,Math.min(Math.max(0,t+i.top),window.innerHeight-100))+"px",left:Math.max(0,Math.min(Math.max(0,e+i.left),window.innerWidth-200))+"px"})},saveCss:function(){r.setItem("WMES_KANBAN_BUILDER_CSS",JSON.stringify({top:this.el.offsetTop,left:this.el.offsetLeft,height:this.$id("tbody")[0].clientHeight}))},show:function(){this.shown=!0;var e=JSON.parse(r.getItem("WMES_KANBAN_BUILDER_CSS")||"null")||{top:100,left:window.innerWidth/2-309,height:165};this.$tbody.css({height:e.height+"px"}),this.position(e.left,e.top,{left:0,top:0}),this.$el.removeClass("hidden"),this.$tbody[0].scrollTop=this.$tbody[0].scrollHeight,this.trigger("shown")},hide:function(){this.shown=!1,this.$el.addClass("hidden"),this.trigger("hidden")},recountNos:function(){this.$rows.children().each(function(e){this.children[0].textContent=e+1+"."})},recountTotals:function(){var e=this,t=e.model.builder.length,i={};e.model.builder.forEach(function(e){e.get("lines").forEach(function(e){i[e]=1})}),e.$id("totals-no").text(t),e.$id("totals-lines").text(Object.keys(i).length),l.forEach(function(t){var i=0;e.$('.kanban-builder-layout[data-layout="'+t+'"]').each(function(){i+=parseInt(this.textContent,10)}),e.$id("totals-"+t).text(i)})},recountRow:function(e,t){var i=t&&t.length?t[0]:this.$rows[0].rows[this.model.builder.models.indexOf(e)],n=this.model.entries.get(e.get("ccn")).serialize(this.model),o=n.kanbanQtyUser,s=e.get("lines").length,r=this.model.builder.layouts;l.forEach(function(e,t){var a=0;-1!==r.indexOf(e)&&("kk"===n.kind?a="kk"===e?o*s:0:"pk"===n.kind&&(a="kk"===e?0:o*s)),i.cells[3+t].textContent=a.toString()})},addRows:function(i){var n=this,o=t(document.createDocumentFragment()),s=n.$rows[0].childElementCount;i.forEach(function(t){var i=n.model.entries.get(t.get("ccn"));if(i){++s;var r=n.$row.clone(),a=r[0].children,l=a[2].firstElementChild,d=[],c=t.get("lines");a[0].textContent=s+".",a[1].textContent=i.id,i.serialize(n.model).lines.forEach(function(t){var i=-1===c.indexOf(t)?"":"selected";t=e.escape(t),d.push('<option value="'+t+'" '+i+">"+t+"</option>")}),l.innerHTML=d.join(""),n.recountRow(t,r),o.append(r)}}),o.find("select").expandableSelect(),n.$rows.append(o),1===i.length&&(clearTimeout(n.timers.focusLast),n.timers.focusLast=setTimeout(function(){var e=n.$rows[0].lastElementChild;e&&e.querySelector("select").focus()},1))},validate:function(){var t=this,i=t.model.builder,n="",o=[];i.layouts.length||(n=t.t("builder:error:noLayout")),t.$id("layoutError")[0].setCustomValidity(n),t.$rows.children().each(function(e){var n=i.at(e),s=t.model.entries.get(n.get("ccn")).serialize(t.model);if(s.kind){for(var r=n.get("lines"),a=0;a<r.length;++a){var l=r[a],d=s.lines.indexOf(l);if(-1!==d)for(var c=d*s.kanbanQtyUser,u=d*s.kanbanQtyUser+s.kanbanQtyUser,h=c;h<u;++h)if(!(s.kanbanId[h]>0))return void o.push(t.t("builder:error:noKanbanId",{line:l,i:h+1}))}o.push("")}else o.push(t.t("builder:error:noKind"))});var s=t.$rows.find("select");return o.forEach(function(e,t){s[t].setCustomValidity(e)}),""===n&&e.all(o,function(e){return""===e})},submit:function(){var e=this;if(e.validate()){i.msg.saving();var t=e.$("button, select, input").prop("disabled",!0),n=e.$id("newStorageBin").prop("checked"),s=[];if(e.model.builder.forEach(function(t){var i=e.model.entries.get(t.get("ccn")).serialize(e.model);if(i.workstationsTotal){var r=e.model.builder.layouts.filter(function(e){return"kk"===i.kind&&"kk"===e||"kk"!==i.kind&&"kk"!==e});r.length&&t.get("lines").forEach(function(e){var t=i.lines.indexOf(e),a=t*i.kanbanQtyUser,l=t*i.kanbanQtyUser+i.kanbanQtyUser,d=i.storageBin;n&&i.newStorageBin&&(d=i.newStorageBin),s.push({_id:o(),line:e,kanbans:i.kanbanId.slice(a,l),layouts:r,data:{ccn:i._id,nc12:i.nc12,description:i.description,supplyArea:i.supplyArea,family:i.family,componentQty:i.componentQty,storageBin:d,minBinQty:i.minBinQty,maxBinQty:i.maxBinQty,replenQty:i.replenQty,workstations:i.workstations,locations:i.locations}})})}}),0===s.length)return i.msg.saved(),e.model.builder.reset([]),void t.prop("disabled",!1);s.sort(function(e,t){return e.line.localeCompare(t.line,void 0,{numeric:!0,ignorePunctuation:!0})});var r=e.ajax({method:"POST",url:"/kanban/printQueues",data:JSON.stringify({_id:o(),jobs:s})});r.fail(function(){i.msg.savingFailed()}),r.done(function(){i.msg.saved(),e.model.builder.reset([])}),r.always(function(){t.prop("disabled",!1)})}else setTimeout(function(){e.$id("submit").click()},1)},onEntryChange:function(e){var t=this.model.builder.findWhere({ccn:e.id});t&&(this.recountRow(t),this.recountTotals(),this.validate())},onFocus:function(e){var t=this.model.builder.models.indexOf(e);-1!==t&&this.$rows[0].rows[t].querySelector("select").focus()},onReset:function(){this.render(),0===this.model.builder.length&&this.hide()},onAdd:function(e,t,i){i&&i.multi||this.onMultiAdd([e.id])},onMultiAdd:function(e){this.addRows(e.map(function(e){return this.model.builder.get(e)},this)),this.recountTotals(),this.validate()},onRemove:function(e,t,i){this.$(this.$rows[0].rows[i.index]).remove(),this.recountNos(),this.recountTotals(),0===this.model.builder.length&&this.hide()},onLayoutsChange:function(e,t){this.$('.btn[value="'+e+'"]').toggleClass("active",t),this.model.builder.forEach(function(e){this.recountRow(e)},this),this.recountTotals(),this.validate()},onLinesChange:function(e){this.recountRow(e),this.recountTotals(),this.validate()}})});