define(["underscore","jquery","../i18n","../user","../core/Model","../core/util/transliterate","../core/util/parseNumber","app/kanban/templates/popover","app/kanban/templates/containerPopover"],function(_,$,t,user,Model,transliterate,parseNumber,popoverTemplate,containerPopoverTemplate){"use strict";var defaultValueExporter=function(t){if(null==t)return"";var e=typeof t;if("number"===e)return(Math.round(1e3*t)/1e3).toString();if("boolean"===e)return t?"1":"0";if("object"===e)return JSON.stringify(t);var n=t.toString();return-1===n.indexOf("\t")?n:'"'+n.replace(/"/g,'""')+'"'},defaultValueParser=function(t){return t},defaultEditorValue=function(t){return t},defaultTdClassName=function(){return""},defaultTdValueRenderer=function(t){return t},invalidTdClassName=function(t){return t?"":"kanban-is-invalid"},invalidFifoTdClassName=function(t,e,n,r){return t||100===r.storageType?"":"kanban-is-invalid"},WORKSTATION_COUNT=10,VALIDATION_FILTER_PROPERTIES={workstations:"invalidWorkstations",locations:"invalidLocations"},COLUMNS={_id:{width:7,prepareFilter:function(t){return t.split(/[^0-9]+/).filter(function(t){return t.length>0}).join("; ")},renderValue:function(t){return/[a-z]$/.test(t)&&(t=t.substring(0,t.length-1)+'<span class="kanban-td-id-suffix">'+t.charAt(t.length-1)+"</span>"),t}},nc12:{width:13,prepareFilter:function(t){return t.split(/[^0-9]+/).filter(function(t){return t.length>0}).join("; ")},renderValue:function(t,e,n,r){return r.description?'<a href="#kanban/components/'+t+'" target="_blank">'+t+"</a>":t}},description:{width:45,tdClassName:invalidTdClassName},supplyArea:{width:12,tdClassName:invalidTdClassName,renderValue:function(t,e,n,r){return r.supplyAreaId?'<a href="#kanban/supplyAreas/'+r.supplyAreaId+'" target="_blank">'+t+"</a>":t}},workCenter:{width:12,expand:125,tdClassName:function(){return this.state.auth.manage||this.state.auth.processEngineer?"kanban-is-editable":""}},family:{width:10},storageType:{type:"integer",width:6,rotated:!0},kanbanQtyUser:{type:"integer",width:6,rotated:!0,renderValue:function(t){return t.toLocaleString().replace(/\s+/g,"")}},componentQty:{type:"integer",width:9,rotated:!0,tdClassName:invalidFifoTdClassName},storageBin:{width:10,rotated:!0,tdClassName:invalidTdClassName,prepareFilter:function(t){return t.split(/[;, ]+/).filter(function(t){return t.length>0}).join("; ")}},markerColor:{width:3,rotated:!0,expand:150,tdClassName:function(){return this.state.auth.manage||this.state.auth.whman?"kanban-is-editable":""},renderValue:function(t,e,n,r){if(!t)return"";var a=this.state.settings.getMarkerColor(r.markerColor);return'<span class="kanban-td-color-marker" style="background: '+a.color+'"></span><span class="kanban-td-color-label">'+a.text+"</span>"},exportValue:function(e){return e?t.has("kanban","color:"+e)?t("kanban","color:"+e):e:""}},newStorageBin:{width:10,rotated:!0,prepareFilter:function(t){return t.split(/[;, ]+/).filter(function(t){return t.length>0}).join("; ")}},newMarkerColor:{width:3,rotated:!0,expand:150,tdClassName:function(){return this.state.auth.manage||this.state.auth.whman?"kanban-is-editable":""},renderValue:function(t,e,n,r){if(!t)return"";var a=this.state.settings.getMarkerColor(r.newMarkerColor);return'<span class="kanban-td-color-marker" style="background: '+a.color+'"></span><span class="kanban-td-color-label">'+a.text+"</span>"},exportValue:function(e){return e?t.has("kanban","color:"+e)?t("kanban","color:"+e):e:""}},kanbanId:{width:10,expand:186,tdClassName:function(t,e,n,r){return 0===t.length&&100!==r.storageType?"kanban-is-invalid":""},prepareFilter:function(t){return t.split(/[^0-9]+/).filter(function(t){return t.length>0}).join("; ")},renderValue:function(t){return t.join(" ")},exportValue:function(t){return t.join(",")}},kanbanIdCount:{type:"integer",width:6,rotated:!0,tdClassName:function(t,e,n,r){return t===r.emptyFullCount?"":t<r.emptyFullCount?"kanban-is-invalid":"kanban-is-warning"},filters:{"kanbanIds:invalid":"$$.emptyFullCount == 0 || $ < $$.emptyFullCount || $ > $$.emptyFullCount","kanbanIds:tooMany":"$$.emptyFullCount > 0 && $ > $$.emptyFullCount","kanbanIds:tooFew":"$$.emptyFullCount != 0 && $ < $$.emptyFullCount"}},lineCount:{type:"integer",width:3,rotated:!0},emptyFullCount:{type:"integer",width:7,rotated:!0},stock:{type:"integer",width:7,rotated:!0},maxBinQty:{type:"integer",width:7,rotated:!0,tdClassName:invalidFifoTdClassName},minBinQty:{type:"integer",width:7,rotated:!0,tdClassName:invalidFifoTdClassName},replenQty:{type:"integer",width:7,rotated:!0,tdClassName:invalidFifoTdClassName},unit:{type:"string",width:4,prepareFilter:function(t){return t.split(/[;, ]+/).filter(function(t){return t.length>0}).join("; ")}},kind:{width:3,rotated:!0,tdClassName:function(t,e,n,r){var a=invalidFifoTdClassName(t,e,n,r);return 100!==r.storageType&&(this.state.auth.manage||this.state.auth.processEngineer)&&(a+=" kanban-is-editable"),a},renderValue:function(e){return t("kanban","kind:"+e+":short")},exportValue:function(e){return t("kanban","kind:"+e+":short")}},workstations:{width:5,type:"decimal",rowSpan:1,colSpan:WORKSTATION_COUNT,arrayIndex:WORKSTATION_COUNT,sortable:!1,tdClassName:function(t,e,n,r){var a=!r.workstationsTotal||!t&&r.locations[n]?"kanban-is-invalid":"";return(this.state.auth.manage||this.state.auth.processEngineer)&&(a+=" kanban-is-editable"),a},renderValue:function(t){return t.toLocaleString()},editorValue:function(t){return t.toLocaleString().replace(/\s+/g,"")},exportValue:function(t){return this.editorValue(t)},parseValue:function(t){return Math.min(99,Math.max(0,parseNumber(t)))}},container:{width:10,tdClassName:function(){return this.state.auth.manage||this.state.auth.processEngineer||this.state.auth.leader?"kanban-is-editable":""},renderValue:function(t){return t?'<a href="#kanban/containers/'+encodeURIComponent(t)+'" target="_blank">'+_.escape(t)+"</a>":""},popover:function(t){if(!t.value)return null;var e=this.state.containers.get(t.value);return $(t.td).popover({container:"body",placement:"auto left",trigger:"manual",html:!0,title:e.get("name"),template:popoverTemplate({type:"container"}),content:containerPopoverTemplate({container:e.toJSON()})}).popover("show")},handleAltClick:function(t){t.value&&window.open("/kanban/containers/"+encodeURIComponent(t.value)+".jpg")}},locations:{width:4,rowSpan:1,colSpan:WORKSTATION_COUNT,arrayIndex:WORKSTATION_COUNT,sortable:!1,tdClassName:function(t,e,n,r){var a=!r.workstationsTotal||!t&&r.workstations[n]?"kanban-is-invalid":"";return(this.state.auth.manage||this.state.auth.processEngineer||this.state.auth.leader)&&(a+=" kanban-is-editable"),a},parseValue:function(t){return t=String(t).toUpperCase(),/^[A-Z][0-9][0-9]$/.test(t)?t:""}},discontinued:{width:3,rotated:!0,tdClassName:function(){return this.state.auth.manage||this.state.auth.processEngineer?"kanban-is-editable":""},renderValue:function(t){return'<i class="fa fa-'+(t?"check":"times")+'"></i>'},exportValue:function(t){return t?"1":"0"}},comment:{width:40,sortable:!1,expand:0,tdClassName:function(){return this.state.auth.manage||this.state.auth.processEngineer||this.state.auth.leader?"kanban-is-editable":""},renderValue:function(t){return _.escape(t)},parseValue:function(t){return String(t).trim()}}};return Model.extend({urlRoot:"/kanban/tableViews",clientUrlRoot:"#kanban/tableViews",topicPrefix:"kanban.tableViews",privilegePrefix:"KANBAN",nlsDomain:"kanban",defaults:function(){return{name:"",columns:{},filterMode:"and",filters:{},sort:{_id:1}}},initialize:function(t,e){this.state=e.state},setUpPubsub:function(t){var e=this;t.subscribe("kanban.tableViews.edited",function(t){t.model._id===e.id&&e.handleEditMessage(t.model)})},getHiddenColumns:function(){return Object.keys(this.attributes.columns)},hasAnyHiddenColumn:function(){return this.getHiddenColumns().length>0},getVisibility:function(t){return!1!==this.attributes.columns[t]},setVisibility:function(t,e){e?delete this.attributes.columns[t]:this.attributes.columns[t]=!1,this.trigger("change:visibility",this,t,{}),this.trigger("change:columns",this,this.attributes.columns,{}),this.trigger("change",this,{save:!0})},getFilterMode:function(){return this.get("filterMode")},setFilterMode:function(t){this.set("filterMode",t,{save:!0})},hasAnyFilter:function(){return Object.keys(this.attributes.filters).length>0},getFilter:function(t){return this.attributes.filters[t]||null},setFilter:function(t,e){e?this.attributes.filters[t]=e:delete this.attributes.filters[t],this.trigger("change:filter",this,t,{}),this.trigger("change:filters",this,this.attributes.filters,{}),this.trigger("change",this,{save:!0})},setFilters:function(t){var e=this,n=e.attributes.filters;e.attributes.filters=t,Object.keys(n).forEach(function(n){t[n]||e.trigger("change:filter",e,n,{})}),Object.keys(t).forEach(function(t){e.trigger("change:filter",e,t,{})}),e.trigger("change:filters",e,e.attributes.filters,{}),e.trigger("change",e,{save:!0})},clearFilters:function(){var t=this,e=t.attributes.filters;t.attributes.filters={},Object.keys(e).forEach(function(e){t.trigger("change:filter",t,e,{})}),t.trigger("change:filters",t,t.attributes.filters,{}),t.trigger("change",t,{save:!0})},getSortOrder:function(t){return this.attributes.sort[t]||0},setSortOrder:function(t,e){var n=this,r=n.attributes.sort;n.attributes.sort={},Object.keys(r).forEach(function(t){n.trigger("change:order",n,t,{})}),n.attributes.sort[t]=e,n.trigger("change:order",n,t,{}),n.trigger("change:sort",n,n.attributes.sort,{}),n.trigger("change",n,{save:!0})},getColumnText:function(e,n,r){var a=0;n>=0&&(a=n+1,e+="N");var i=!1!==r&&t.has("kanban","column:"+e+":title")?t("kanban","column:"+e+":title",{n:a}):t("kanban","column:"+e,{n:a});return!1===r?i:i.replace(/\n/g,"<br>").replace(/<br>/g," ").replace(/\s+/," ")},serializeColumns:function(){var t=this,e={list:[],map:[]};return Object.keys(COLUMNS).forEach(function(n){var r=t.serializeColumn(n);r.visible&&e.list.push(r),e.map[n]=r}),e},serializeColumn:function(e){var n=_.assign({state:this.state,_id:e,type:"string",thClassName:"",labelClassName:"",tdClassName:defaultTdClassName,valueClassName:defaultTdClassName,arrayIndex:0,rowSpan:2,colSpan:1,visible:this.getVisibility(e),sortOrder:this.getSortOrder(e),filter:this.getFilter(e),rotated:!1,sortable:!0,withMenu:!0,label:t.bound("kanban","column:"+e),title:t.has("kanban","column:"+e+":title")?t.bound("kanban","column:"+e+":title"):"",renderValue:defaultTdValueRenderer,exportValue:defaultValueExporter,editorValue:defaultEditorValue,parseValue:defaultValueParser},COLUMNS[e]);n.rotated&&!n.title&&(n.title=n.label);var r=[],a=[];return n.withMenu&&r.push("kanban-is-with-menu"),n.filter&&r.push("kanban-is-filtered"),n.sortOrder&&r.push("kanban-is-"+(1===n.sortOrder?"asc":"desc")),n.rotated&&a.push("kanban-is-rotated"),n.thClassName=r.join(" "),n.labelClassName=a.join(" "),n},createSort:function(t){var e=_.keys(this.attributes.sort),n=_.values(this.attributes.sort);return _.includes(e,"_id")||(e.push("_id"),n.push(1)),function(r,a){return function t(r,a,i){if(r===e.length)return 0;var s=e[r],o=n[r],l=a[s],u=i[s];if(null===l)return null===u?t(r+1,a,i):1===o?-1:1;if(null===u)return 1===o?1:-1;var c=typeof l,d=0;return"number"===c?d=1===o?l-u:u-l:"string"===c&&(d=1===o?l.localeCompare(u||""):(u||"").localeCompare(l)),0===d?t(r+1,a,i):d}(0,r.serialize(t),a.serialize(t))}},createFilter:function(t){var e="and"===this.get("filterMode"),n=this.compileFilters(this.get("filters"));return 0===n.length?function(t){return!0!==t.attributes.deleted}:function(r){if(r.attributes.deleted)return!1;var a,i;if(r=r.serialize(t),e){for(a=0;a<n.length;++a)if(!(i=n[a]).check(r[i.columnId],r))return!1;return!0}for(a=0;a<n.length;++a)if((i=n[a]).check(r[i.columnId],r))return!0;return!1}},compileFilters:function(t){var e=this,n=[];return _.forEach(t,function(t,r){n.push({columnId:r,check:e.compileFilter(r,t)})}),n},compileFilter:function(t,e){return e.check||(e.check=this.filterCompilers[e.type](e.data,t)),e.check},filterCompilers:{empty:function(){return function(t){return void 0===t||null===t||0===t||0===t.length}},notEmpty:function(){return function(t){return void 0!==t&&null!==t&&0!==t&&0!==t.length}},eval:function(code){if("?"===code)return this.empty();if("!"===code)return this.notEmpty();var evalFilter=function(){return!0};try{eval("evalFilter = function($, $$) { return "+code+"; }")}catch(t){console.warn("Invalid eval filter:",code)}return evalFilter},numeric:function(code){if("?"===code)return this.empty();if("!"===code)return this.notEmpty();if(-1!==code.indexOf("$$"))return this.eval(code);var numericFilter=function(){return!0};/^[0-9]+$/.test(code)&&(code="="+code),-1===code.indexOf("$")&&(code="$"+code),code=code.replace(/={2,}/g,"=").replace(/([^<>])=/g,"$1==").replace(/<>/g,"!=");try{eval("numericFilter = function($) { return "+code+"; }")}catch(t){console.warn("Invalid numeric filter:",code)}return numericFilter},text:function(code){if("?"===code)return this.empty();if("!"===code)return this.notEmpty();if(-1!==code.indexOf("$$"))return this.eval(code);var textFilter=function(){return!0};if(/^\/.*?\/$/.test(code))code="return "+code+"i.test($)";else{var or=transliterate(code).replace(/[,;]+/g,"|").replace(/\s+/g," ").replace(/[^A-Za-z0-9 |]+/g,"").toUpperCase().split("|").map(function(t){return t.split(" ").filter(function(t){return t.length>0})}).filter(function(t){return t.length>0}).map(function(t){return"("+t.map(function(t){return"$.indexOf("+JSON.stringify(t)+") !== -1"}).join(" && ")+")"}).join(" || ");if(!or.length)return textFilter;code='$ = String($).replace(/[^A-Za-z0-9]+/g, "").toUpperCase(); return '+or}try{eval("textFilter = function($) { "+code+"; }")}catch(t){console.warn("Invalid text filter:",code)}return textFilter},select:function(t,e){var n=VALIDATION_FILTER_PROPERTIES[e];if(n){var r="invalid"===t[0];return function(t,e){return e[n]===r}}return function(e){return-1!==t.indexOf(void 0==e?"":String(e))}}},handleEditMessage:function(t){}})});