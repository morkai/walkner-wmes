// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../broker","../pubsub","../user","../core/Model","app/kanbanSupplyAreas/KanbanSupplyAreaCollection","app/kanbanComponents/KanbanComponentCollection","./KanbanSettingCollection","./KanbanTableView","./KanbanEntryCollection"],function(e,n,s,t,u,r,o,l,a,b){"use strict";function i(){w.auth={view:t.isAllowedTo("KANBAN:VIEW"),manage:t.isAllowedTo("KANBAN:MANAGE"),processEngineer:t.isAllowedTo("FN:process-engineer"),leader:t.isAllowedTo("FN:leader")}}var p=!1,c=!1,d=null,w=new u;return w.nlsDomain="kanban",w.broker=null,w.pubsub=null,w.url="/kanban/state",w.settings=new l,w.tableView=new a({_id:"mine"},{state:w}),w.supplyAreas=new r(null,{paginate:!1,rqlQuery:"sort(_id)"}),w.components=new o(null,{paginate:!1,rqlQuery:"exclude(changes)&sort(_id)"}),w.entries=new b(null,{tableView:w.tableView,supplyAreas:w.supplyAreas,components:w.components}),w.auth={},w.isLoading=function(){return p},w.parse=function(e){return["supplyAreas","components","entries"].forEach(function(n){if("string"==typeof e[n]){var s=JSON.parse(e[n]);w[n].reset(w[n].parse({totalCount:s.length,collection:s}))}}),{}},w.load=function(t){if(null!==d&&(clearTimeout(d),d=null),!c||t)return null===w.broker&&(w.broker=n.sandbox(),w.broker.subscribe("user.reloaded",i)),null===w.pubsub&&(w.pubsub=s.sandbox(),w.settings.setUpPubsub(w.pubsub),w.tableView.setUpPubsub(w.pubsub),w.supplyAreas.setUpPubsub(w.pubsub),w.components.setUpPubsub(w.pubsub),w.entries.setUpPubsub(w.pubsub)),i(),e.when(w.settings.fetch({reset:!0}),w.tableView.fetch(),w.fetch())},w.unload=function(){c&&(null!==d&&clearTimeout(d),d=setTimeout(function(){null!==w.broker&&(w.broker.destroy(),w.broker=null),null!==w.pubsub&&(w.pubsub.destroy(),w.pubsub=null),w.settings.reset([]),w.supplyAreas.reset([]),w.components.reset([]),w.entries.reset([]),d=null,c=!1},6e4))},w.on("request",function(){p=!0}),w.on("sync",function(){p=!1,c=!0}),w.on("error",function(){p=!1,c=!1,w.supplyAreas.reset([]),w.components.reset([]),w.entries.reset([])}),window.kanbanState=w});