// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../broker","../pubsub","../user","../core/Model","../core/Collection","app/kanbanSupplyAreas/KanbanSupplyAreaCollection","app/kanbanContainers/KanbanContainerCollection","app/kanbanComponents/KanbanComponentCollection","./KanbanSettingCollection","./KanbanTableView","./KanbanEntryCollection","./KanbanPrintQueueBuilder"],function(e,n,s,t,r,u,o,l,a,i,b,p,c){"use strict";function d(){m.auth={view:t.isAllowedTo("KANBAN:VIEW"),manage:t.isAllowedTo("KANBAN:MANAGE"),processEngineer:t.isAllowedTo("FN:process-engineer"),leader:t.isAllowedTo("FN:leader","FN:master")}}var w=!1,f=!1,A=null,m=new r;return m.nlsDomain="kanban",m.broker=null,m.pubsub=null,m.url="/kanban/state",m.settings=new i,m.tableView=new b({_id:"mine"},{state:m}),m.supplyAreas=new o(null,{paginate:!1,rqlQuery:"sort(_id)"}),m.containers=new l(null,{paginate:!1,rqlQuery:"sort(name)"}),m.components=new a(null,{paginate:!1,rqlQuery:"exclude(changes)&sort(_id)"}),m.entries=new p(null,{tableView:m.tableView,supplyAreas:m.supplyAreas,components:m.components}),m.builder=c.fromLocalStorage(),m.auth={},m.isLoading=function(){return w},m.parse=function(e){return["supplyAreas","containers","components","entries"].forEach(function(n){if("string"==typeof e[n]){var s=JSON.parse(e[n]);m[n].reset(m[n].parse({totalCount:s.length,collection:s}))}}),{}},m.load=function(t){if(null!==A&&(clearTimeout(A),A=null),!f||t)return null===m.broker&&(m.broker=n.sandbox(),m.broker.subscribe("user.reloaded",d)),null===m.pubsub&&(m.pubsub=s.sandbox(),m.settings.setUpPubsub(m.pubsub),m.tableView.setUpPubsub(m.pubsub),m.supplyAreas.setUpPubsub(m.pubsub),m.containers.setUpPubsub(m.pubsub),m.components.setUpPubsub(m.pubsub),m.entries.setUpPubsub(m.pubsub)),d(),e.when(m.settings.fetch({reset:!0}),m.tableView.fetch(),m.fetch())},m.unload=function(){f&&(null!==A&&clearTimeout(A),A=setTimeout(function(){null!==m.broker&&(m.broker.destroy(),m.broker=null),null!==m.pubsub&&(m.pubsub.destroy(),m.pubsub=null),m.settings.reset([]),m.supplyAreas.reset([]),m.containers.reset([]),m.components.reset([]),m.entries.reset([]),A=null,f=!1},6e4))},m.on("request",function(){w=!0}),m.on("sync",function(){w=!1,f=!0}),m.on("error",function(){w=!1,f=!1,m.supplyAreas.reset([]),m.containers.reset([]),m.components.reset([]),m.entries.reset([])}),window.kanbanState=m});