define(["jquery","../broker","../pubsub","../user","../core/Model","../core/Collection","app/kanbanSupplyAreas/KanbanSupplyAreaCollection","app/kanbanContainers/KanbanContainerCollection","app/kanbanComponents/KanbanComponentCollection","./KanbanSettingCollection","./KanbanTableView","./KanbanEntryCollection","./KanbanPrintQueueBuilder"],function(e,n,s,t,r,u,o,l,a,i,b,p,c){"use strict";var d=!1,w=!1,f=null,m=new r;function A(){m.auth={view:t.isAllowedTo("KANBAN:VIEW"),manage:t.isAllowedTo("KANBAN:MANAGE"),processEngineer:t.isAllowedTo("FN:process-engineer"),leader:t.isAllowedTo("FN:leader","FN:master"),whman:t.isAllowedTo("FN:whman","FN:wh")}}return m.nlsDomain="kanban",m.broker=null,m.pubsub=null,m.url="/kanban/state",m.settings=new i,m.tableView=new b({_id:"mine"},{state:m}),m.supplyAreas=new o(null,{paginate:!1,rqlQuery:"sort(_id)"}),m.containers=new l(null,{paginate:!1,rqlQuery:"sort(name)"}),m.components=new a(null,{paginate:!1,rqlQuery:"exclude(changes)&sort(_id)"}),m.entries=new p(null,m),m.builder=c.fromLocalStorage(),m.auth={},m.isLoading=function(){return d},m.parse=function(e){return["supplyAreas","containers","components","entries"].forEach(function(n){if("string"==typeof e[n]){var s=JSON.parse(e[n]);m[n].reset(m[n].parse({totalCount:s.length,collection:s}))}}),{}},m.load=function(t){if(null!==f&&(clearTimeout(f),f=null),!w||t)return null===m.broker&&(m.broker=n.sandbox(),m.broker.subscribe("user.reloaded",A)),null===m.pubsub&&(m.pubsub=s.sandbox(),m.settings.setUpPubsub(m.pubsub),m.tableView.setUpPubsub(m.pubsub),m.supplyAreas.setUpPubsub(m.pubsub),m.containers.setUpPubsub(m.pubsub),m.components.setUpPubsub(m.pubsub),m.entries.setUpPubsub(m.pubsub)),A(),e.when(m.settings.fetch({reset:!0}),m.tableView.fetch(),m.fetch())},m.unload=function(){w&&(null!==f&&clearTimeout(f),f=setTimeout(function(){null!==m.broker&&(m.broker.destroy(),m.broker=null),null!==m.pubsub&&(m.pubsub.destroy(),m.pubsub=null),m.settings.reset([]),m.supplyAreas.reset([]),m.containers.reset([]),m.components.reset([]),m.entries.reset([]),f=null,w=!1},6e4))},m.on("request",function(){d=!0}),m.on("sync",function(){d=!1,w=!0}),m.on("error",function(){d=!1,w=!1,m.supplyAreas.reset([]),m.containers.reset([]),m.components.reset([]),m.entries.reset([])}),window.kanbanState=m});