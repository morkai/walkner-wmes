// Part of <https://miracle.systems/p/walkner-wmes> licensed under <CC BY-NC-SA 4.0>

define(["jquery","../broker","../pubsub","../user","../core/Model","../core/Collection","app/kanbanSupplyAreas/KanbanSupplyAreaCollection","app/kanbanContainers/KanbanContainerCollection","app/kanbanComponents/KanbanComponentCollection","./KanbanSettingCollection","./KanbanTableView","./KanbanEntryCollection","./KanbanPrintQueueBuilder"],function(e,n,s,t,r,u,o,l,a,i,b,p,c){"use strict";function d(){A.auth={view:t.isAllowedTo("KANBAN:VIEW"),manage:t.isAllowedTo("KANBAN:MANAGE"),processEngineer:t.isAllowedTo("FN:process-engineer"),leader:t.isAllowedTo("FN:leader","FN:master"),whman:t.isAllowedTo("FN:whman","FN:prod_whman","FN:in_whman")}}var w=!1,f=!1,m=null,A=new r;return A.nlsDomain="kanban",A.broker=null,A.pubsub=null,A.url="/kanban/state",A.settings=new i,A.tableView=new b({_id:"mine"},{state:A}),A.supplyAreas=new o(null,{paginate:!1,rqlQuery:"sort(_id)"}),A.containers=new l(null,{paginate:!1,rqlQuery:"sort(name)"}),A.components=new a(null,{paginate:!1,rqlQuery:"exclude(changes)&sort(_id)"}),A.entries=new p(null,A),A.builder=c.fromLocalStorage(),A.auth={},A.isLoading=function(){return w},A.parse=function(e){return["supplyAreas","containers","components","entries"].forEach(function(n){if("string"==typeof e[n]){var s=JSON.parse(e[n]);A[n].reset(A[n].parse({totalCount:s.length,collection:s}))}}),{}},A.load=function(t){if(null!==m&&(clearTimeout(m),m=null),!f||t)return null===A.broker&&(A.broker=n.sandbox(),A.broker.subscribe("user.reloaded",d)),null===A.pubsub&&(A.pubsub=s.sandbox(),A.settings.setUpPubsub(A.pubsub),A.tableView.setUpPubsub(A.pubsub),A.supplyAreas.setUpPubsub(A.pubsub),A.containers.setUpPubsub(A.pubsub),A.components.setUpPubsub(A.pubsub),A.entries.setUpPubsub(A.pubsub)),d(),e.when(A.settings.fetch({reset:!0}),A.tableView.fetch(),A.fetch())},A.unload=function(){f&&(null!==m&&clearTimeout(m),m=setTimeout(function(){null!==A.broker&&(A.broker.destroy(),A.broker=null),null!==A.pubsub&&(A.pubsub.destroy(),A.pubsub=null),A.settings.reset([]),A.supplyAreas.reset([]),A.containers.reset([]),A.components.reset([]),A.entries.reset([]),m=null,f=!1},6e4))},A.on("request",function(){w=!0}),A.on("sync",function(){w=!1,f=!0}),A.on("error",function(){w=!1,f=!1,A.supplyAreas.reset([]),A.containers.reset([]),A.components.reset([]),A.entries.reset([])}),window.kanbanState=A});