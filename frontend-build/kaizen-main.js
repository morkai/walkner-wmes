// Copyright (c) 2014, ≈Åukasz Walukiewicz <lukasz@walukiewicz.eu>. Some Rights Reserved.
// Licensed under CC BY-NC-SA 4.0 <http://creativecommons.org/licenses/by-nc-sa/4.0/>.
// Part of the walkner-wmes project <http://lukasz.walukiewicz.eu/p/walkner-wmes>

!function(){"use strict";function e(){require(["domReady","jquery","backbone","backbone.layout","moment","app/monkeyPatch","app/broker","app/i18n","app/socket","app/router","app/viewport","app/updater/index","app/data/loadedModules","app/core/layouts/PageLayout","app/core/layouts/PrintLayout","app/core/layouts/BlankLayout","app/core/views/NavbarView","app/core/views/LogInFormView","app/kaizenOrders/templates/navbar","app/time","app/kaizen-routes","bootstrap","moment-lang/"+window.appLocale,"select2-lang/"+window.appLocale,"i18n!app/nls/core"],t)}function t(e,t,n,o,a,r,i,u,s,p,c,l,d,g,w,b,L,f,y){function m(){var e=p.getCurrentRequest(),n=new L({currentPath:null===e?"/":e.path,loadedModules:d.map,template:y});return n.on("logIn",function(){c.showDialog(new f,u("core","LOG_IN_FORM:DIALOG_TITLE"))}),n.on("logOut",function(){t.ajax({type:"GET",url:"/logout"}).fail(function(){c.msg.show({type:"error",text:u("core","MSG:LOG_OUT:FAILURE"),time:5e3})})}),n}function v(){null!==h&&(h.destroy(),h=null),i.subscribe("i18n.reloaded",function(e){localStorage.setItem("LOCALE",e.newLocale),c.render()}),i.subscribe("user.reloaded",function(){var e=p.getCurrentRequest();c.render(),/^\/production\//.test(e.path)||p.dispatch(e.url)}),i.subscribe("user.loggedIn",function(){var e=p.getCurrentRequest();if(e){var t=e.url;"/"===t&&"string"==typeof window.DASHBOARD_URL_AFTER_LOG_IN&&p.replace(window.DASHBOARD_URL_AFTER_LOG_IN)}}),i.subscribe("user.loggedOut",function(){c.msg.show({type:"success",text:u("core","MSG:LOG_OUT:SUCCESS"),time:2500}),i.publish("router.navigate",{url:"/",trigger:!0})}),e(function(){t("#app-loading").fadeOut(function(){t(this).remove()}),window.ENV&&document.body.classList.add("is-"+window.ENV+"-env"),n.history.start({root:"/",hashChange:!0,pushState:!1})})}var h=null;s.connect(),a.locale(window.appLocale),t.ajaxSetup({dataType:"json",accepts:{json:"application/json",text:"text/plain"},contentType:"application/json"}),o.configure({manage:!0,el:!1,keep:!0}),c.registerLayout("page",function(){return new g({views:{".navbar":m()},version:l.getCurrentVersionString()})}),c.registerLayout("print",function(){return new w}),c.registerLayout("blank",function(){return new b}),navigator.onLine?(h=i.sandbox(),h.subscribe("socket.connected",function(){h.subscribe("user.reloaded",v)}),h.subscribe("socket.connectFailed",v),i.subscribe("page.titleChanged",function(e){e.unshift(u("core","TITLE")),document.title=e.reverse().join(" < ")})):v()}window.requireApp=e}();